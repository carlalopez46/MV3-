
======================================================================
FILE PATH: content_scripts\bookmarks_handler.js
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/


window.addEventListener("iMacrosRunMacro", function (evt) {
    // console.log("iMacrosRunMacro event %O", evt);
    connector.postMessage("run-macro", evt.detail, null);
}, true);




// Ensure backwards compatibility for old iMacros bookmarklets
// embedded on web-pages

// creates bookmarklet of new type 
function makeBookmarklet(name, content) {
    var pattern = "(function() {"+
        "try{"+
        "var e_m64 = \"{{macro}}\", n64 = \"{{name}}\";"+
        "if(!/^(?:chrome|https?|file)/.test(location)){"+
        "alert('iMacros: Open webpage to run a macro.');"+
        "return;"+
        "}"+
        "var macro = {};"+
        "macro.source = decodeURIComponent(atob(e_m64));"+
        "macro.name = decodeURIComponent(atob(n64));"+
        "var evt = document.createEvent(\"CustomEvent\");"+
        "evt.initCustomEvent(\"iMacrosRunMacro\", true, true, macro);"+
        "window.dispatchEvent(evt);"+
        "}catch(e){alert('iMacros Bookmarklet error: '+e.toString());}"+
        "}) ();";
    
    var macro_name = name || "Unnamed Macro", source = content;
    macro_name = btoa(encodeURIComponent(name));
    macro_name = imns.escapeLine(macro_name);
    pattern = pattern.replace("{{name}}", macro_name);
    source = btoa(encodeURIComponent(source));
    source = imns.escapeLine(source);
    pattern = pattern.replace("{{macro}}", source);
    
    var url = "javascript:" + pattern;

    return url;
}

// this is a stripped version of imns.unwrap() from utils.js
function unwrap(line) {
    var handleSequence = function(s) {
        if (s == "\\\\") {
            return "\u005C";
        } else if (s == "\\0") {
            return "\u0000";
        } else if (s == "\\b") {
            return "\u0008";
        } else if (s == "\\t") {
            return "\u0009";
        } else if (s == "\\n") {
            return "\u000A";
        } else if (s == "\\v") {
            return "\u000B";
        } else if (s == "\\f") {
            return "\u000C";
        } else if (s == "\\r") {
            return "\u000D";
        } else if (s == "\\\"") {
            return "\u0022";
        } else if (s == "\\\'") {
            return "\u0027"
        } else {
            // function to replace \x|u sequence
            var replaceChar = function (match_str, char_code) {
                return String.fromCharCode(parseInt("0x"+char_code));
            };
            if (/^\\x/.test(s))// replace \xXX by its value
                return s.replace(/\\x([\da-fA-F]{2})/g, replaceChar);
            else if (/^\\u/.test(s)) // replace \uXXXX by its value
                return s.replace(/\\u([\da-fA-F]{4})/g, replaceChar);
        }
    };

    var esc_re = new RegExp("\\\\(?:[0btnvfr\"\'\\\\]|x[\da-fA-F]{2}|u[\da-fA-F]{4})", "g");
    
    // replace escape sequences by their value
    line = line.replace(esc_re, handleSequence);
    
    return line;
}


// translate old m=... or m64=... bookmarklets to e_m64 type
window.addEventListener("load", function() {
    try {                
        // evaluate XPath to find all anchor elements
        // with attribute href="javascript:..."
        var xpath = "//a[starts-with(@href, 'javascript:')]";
        var result = document.evaluate(xpath, document, null,
                                       XPathResult.ORDERED_NODE_ITERATOR_TYPE, null);
        var node = null, nodes = new Array();
        while (node = result.iterateNext()) {
            nodes.push(node);
        }
        
        var im_strre = "(?:[^\"\\\\]|\\\\[0btnvfr\"\'\\\\])+";
        var re = new RegExp('^javascript\\:\\(function\\(\\) '+
                            '\\{(?:try\\{)?var (m(?:64)?) = "('+im_strre+')"'+
                            ', n = "('+im_strre+')";');
        nodes.forEach(function(x) {
            var match = re.exec(x.href);
            if (match) {
                var source  = match[1] == "m" ?
                    decodeURIComponent(unwrap(match[2])) :
                    decodeURIComponent(atob(match[2]));
                var name = match[3];
                
                x.href = makeBookmarklet(name, source);
            }
        });
    } catch (e) {
        console.error(e);
    }
});



======================================================================
FILE PATH: content_scripts\connector.js
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/

function Connector() {
    this.handlers = new Object();
    this.message_handlers = new Map();
    chrome.extension.onRequest.addListener(
        function(msg, sender, callback) {
            connector.handleMessage(msg, callback);
        }
    );

    chrome.runtime.onMessage.addListener(function(msg, sender, sendResponse) {
        connector.onMessage(msg, sendResponse);
    });
}

Connector.prototype.findFrameNumber = function (win, f, obj) {
    if (win.top == f)         // it is a topmost window
        return 0;
    for (var i = 0; i < win.frames.length; i++) {
        obj.num++;
        if ( win.frames[i] == f) {
            return obj.num;
        }
        var n = this.findFrameNumber(win.frames[i], f, obj);
        if (n != -1)
            return n;
    }
    return -1;
};

Connector.prototype.getFrameData = function() {
    var obj = {
        number: this.findFrameNumber(window.top, window, {num:0}),
        name: ""
    };
    try {
        // query 'name' field
        obj.name = (window.frameElement && window.frameElement.name) ?
            window.frameElement.name: "";
    } catch (e) {
        // in case of domain/protocol mismatch SecurityException is thrown
        // console.error(e);
    }

    return obj;
};


Connector.prototype.thisFrame = function(f) {
    var tf = this.getFrameData();
    return tf.number == f.number || (tf.name.length && tf.name == f.name);
};


// handle incoming messages
Connector.prototype.handleMessage = function(msg, callback) {
    if (msg._frame && !this.thisFrame(msg._frame)) 
        return;
    if (msg.topic in this.handlers)
        this.handlers[msg.topic].forEach( function(handler) {
            handler(msg.data, callback);
        });
};

Connector.prototype.onMessage = function(msg, sendResponse) {
    if (msg._frame && !this.thisFrame(msg._frame))
        return;
    if (this.message_handlers.has(msg.topic))
        this.message_handlers.get(msg.topic)(msg.data, sendResponse);
}


// register handlers for specific messages
// callback's prototype is function(msg)
Connector.prototype.registerHandler = function(topic, handler) {
    if (!(topic in this.handlers))
        this.handlers[topic] = new Array();
    this.handlers[topic].push(handler);
};

Connector.prototype.addHandler = function(topic, handler) {
    console.assert(!this.message_handlers.has(topic), "addHandler, topic "+
                   topic+" already has handler");
    this.message_handlers.set(topic, handler);
}

// remove specified handler
Connector.prototype.unregisterHandler = function(topic, callback) {
    var i = this.handlers[topic].indexOf(handler);
    if ( i != -1 )
        this.handlers[topic].splice(i, 1);
};

Connector.prototype.removeHandler = function(topic) {
    if (!this.message_handlers.has(topic))
        return;
    this.message_handlers.delete(topic);
};


// post message to extension script
Connector.prototype.postMessage = function(topic, data, callback) {
    if (data) {
        data._frame = this.getFrameData();
    } else {
        data = {_frame: this.getFrameData()};
    }

    if (callback)
        chrome.extension.sendRequest({topic: topic, data: data}, callback);
    else
        chrome.extension.sendRequest({topic: topic, data: data});
};

Connector.prototype.sendMessage = function(topic, data) {
    if (data) {
        data._frame = this.getFrameData();
    } else {
        data = {_frame: this.getFrameData()};
    }
    
    return new Promise(function(resolve, reject) {
        chrome.runtime.sendMessage(
            {topic: topic, data: data},
            function(data) {
                if (chrome.runtime.lastError)
                    reject(chrome.runtime.lastError);
                else
                    resolve(data);
            });
    });
};

var connector = new Connector();



======================================================================
FILE PATH: content_scripts\player.js
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/


// a pattern to match a double quoted string or a non-whitespace char sequence
var im_strre = "(?:\"(?:[^\"\\\\]+|\\\\[0btnvfr\"\'\\\\])*\"|\\S*)";



var ClickHandler = {
    // check if the point is inside the element
    visibleElement: function(element) {
        return element.offsetWidth && element.offsetHeight;
    },


    withinElement: function(element, x, y) {
        var pos = this.getElementLUCorner(element);
        return (x >= pos.x && x <= pos.x+element.offsetWidth &&
                y >= pos.y && y <= pos.y+element.offsetHeight);

    },

    
    // find an innermost element which containts the point
    getInnermostElement: function(element, x, y) {
        var children = element.childNodes, tmp;

        for (var i = 0; i < children.length; i++) {
            if ( children[i].nodeType != Node.ELEMENT_NODE )
                continue;
            if ( this.visibleElement(children[i]) ) {
                if ( this.withinElement(children[i], x, y) ) {
                    return this.getInnermostElement(children[i], x, y);
                }
            } else {
                if ( children[i].childNodes.length ) {
                    tmp = this.getInnermostElement(children[i], x, y);
                    if ( tmp != children[i] )
                        return tmp;
                }
            }
        }

        return element;
    },


    // find an element specified by the coordinates
    getElementByXY: function (wnd, x, y) {
        throw new RuntimeError("getElementByXY is not supported in Chrome", 712);
    },


    // find element offset relative to its window
    calculateOffset: function(element) {
        var x = 0, y = 0;
        while (element) {
            x += element.offsetLeft;
            y += element.offsetTop;
            element = element.offsetParent;
        }
        return {x: x, y: y};
    },


    // find element position in the current content window
    getElementLUCorner: function (element) {
        var rect = element.getBoundingClientRect();
        // window in cr is already referring to element's frame
        // var win = element.ownerDocument.defaultView;
        var win = window;

        var doc = win.document;
        var doc_el = doc.documentElement;
        var body = doc.body;
        
        var clientTop = doc_el.clientTop ||
            (body && body.clientTop) || 0;

        var clientLeft = doc_el.clientLeft ||
            (body && body.clientLeft) || 0;

        var scrollX = win.scrollX || doc_el.scrollLeft ||
            (body && body.scrollLeft);

        var scrollY = win.scrollY || doc_el.scrollTop ||
            (body && body.scrollTop);

        var x = rect.left + scrollX - clientLeft;
        var y = rect.top  + scrollY - clientTop;

        return {x: Math.round(x), y: Math.round(y)};
    },

    // find center of an element
    findElementPosition: function(element) {
        var pos = this.getElementLUCorner(element);
        pos.x += Math.round(element.offsetWidth/2);
        pos.y += Math.round(element.offsetHeight/2);
        return pos;
    }

};


// shameful copy-paste from recorder.js
// TODO: move these to utils.js
const escapeIdForSelector = id => {
    // HTML5 lessen restrictions on possible id values,
    // Based on the article http://mathiasbynens.be/notes/css-escapes

    // The following characters have a special meaning in CSS:
    id = id.replace(/([!"#$%&'()*+\.\/:;<=>?@\[\\\]^`{|}~])/g, '\\$1');
    // Escape leading digit character by its unicode value
    id = id.replace(/^(\d)/, '\\3$1 ');
    // The hyphen-minus character (-) only needs to be escaped if
    // it’s at the start of the identifier, and if it’s followed by
    // another hyphen-minus character or a digit from 0 to 9
    id = id.replace(/^-([0-9-])/, '\\-$1');
    // 3. Any characters matching [\t\n\v\f\r] need to be escaped based
    // on their Unicode code points.
    id = id.replace(/[\t\n\v\f\r]/g, function(s) {
        // TODO: not quite sure what syntax to use.
        // Now just as for digits: \x-xxxxx followed by single space
        return "\\"+s.charCodeAt(0).toString()+' ';
    });

    return id;
}

const getSelectorForElement = el => {
    // just walk up the tree until we find element with id or reach
    // HTML element
    var selector = "", temp = el;
    while (temp.parentNode) {
        if (temp.id && this.favorIds) {
            selector = "#"+
                StrUtils.escapeLine(this.escapeIdForSelector(temp.id))+
                (selector.length ? ">"+selector : "");
            return selector;
        }

        var siblings = temp.parentNode.childNodes, count = 0;
        for (var i = 0; i < siblings.length; i++) {
            if (siblings[i].nodeType != window.Node.ELEMENT_NODE)
                continue;
            if (siblings[i] == temp)
                break;
            if (siblings[i].tagName == temp.tagName)
                count++;
        }

        if (count) {
            selector = temp.tagName+
                ":nth-of-type("+(count+1)+")"+
                (selector.length ? ">"+selector : "");
        } else {
            selector = temp.tagName+
                (selector.length ? ">"+selector : "");
        }

        temp = temp.parentNode;
    }

    return selector;
}

class FileInputElement {
    // TODO: we may encode several files into CONTENT=... param
    // for now assume that CONTENT (i.e. txt parameter) defines only single path
    constructor(element, txt) {
        this.selector = getSelectorForElement(element)
        this.files = [txt]
    }
}

class ShouldDecryptPassword {
    constructor() {
        
    }
}

// An object to find and process elements specified by TAG command
var TagHandler = {
    
    // checks if the given node matches the atts
    match: function(node, atts) {
        var match = true;

        for (var at in atts) {
            if (at == "txt") {
                var txt = imns.escapeTextContent(node.textContent);
                if (!atts[at].exec(txt)) {
                    match = false; break;
                }
            } else {
                var atval = "", propval = "";
                // first check if the element has the <at> property 
                if (at in node) {
                    propval = node[at];
                } else if (at == "href" && "src" in node) {
                    // special case for old macros
                    // treat 'href' as 'src' 
                    propval = node.src;
                }
                // then check if the element has the <at> attribute
                if (node.hasAttribute(at)) {
                    atval = node.getAttribute(at);
                }
                // applay regexp to the values
                if (!(!!atts[at].exec(propval) || !!atts[at].exec(atval))) {
                    match = false; break;
                }
            } 
        }
        return match;
    },
    
    // find element (relatively) starting from root/lastNode
    // with tagName and atts
    find: function(doc, root, pos, relative, tagName, atts, form_atts) {
        var xpath = "descendant-or-self", ctx = root, nodes = new Array();
        // construct xpath expression to get a set of nodes
        if (relative) {         // is positioning relative?
            xpath = pos > 0 ? "following" : "preceding";
            if (!(ctx = this.lastNode) || ctx.ownerDocument != doc)
                return (this.lastNode = null);
        }
        xpath += "::"+tagName;
        // evaluate XPath
        var result = doc.evaluate(xpath, ctx, null,
            XPathResult.ORDERED_NODE_ITERATOR_TYPE,
            null);
        var node = null;
        while (node = result.iterateNext()) {
            nodes.push(node);
        }
        
        // Set parameters for the search loop
        var count = 0, i, start, end, increment;
        if (pos > 0) {
            start = 0; end = nodes.length; increment = 1;
        } else if (pos < 0) {
            start = nodes.length-1; end = -1; increment = -1;
        } else {
            throw new BadParameter("POS=<number> or POS=R<number>"+
                                   " where <number> is a non-zero integer", 1);
        }

        // check for NoFormName
        if (form_atts && form_atts["name"] &&
            form_atts["name"].exec("NoFormName"))
            form_atts = null;

        // loop over nodes
        for (i = start; i != end; i += increment) {
            // First check that all atts matches
            // if !atts then match elements with any attributes
            var match = atts ? this.match(nodes[i], atts) : true;
            // then check that the element's form matches form_atts
            if (match && form_atts && nodes[i].form)
                match = this.match(nodes[i].form, form_atts);
            if (match && ++count == Math.abs(pos)) {
                // success! return the node found
                return (this.lastNode = nodes[i]);
            }
        }

        return (this.lastNode = null);
    },



    // find element by XPath starting from root
    findByXPath: function(doc, root, xpath) {
        var nodes = new Array();
        // evaluate XPath
        try {
            var result = doc.evaluate(xpath, root, null,
                                      XPathResult.ORDERED_NODE_ITERATOR_TYPE,
                                      null);
            var node = null;
            while (node = result.iterateNext()) {
                nodes.push(node);
            }
        } catch (e) {
            throw new RuntimeError("incorrect XPath expression: "+xpath, 781);
        }
        if (nodes.length > 1)
            throw new RuntimeError("ambiguous XPath expression: "+xpath, 782);
        if (nodes.length == 1)
            return nodes[0];

        return null;
    },

    // find element by CSS selector
    findByCSS: function(doc, selector) {
        try {
            var el = doc.querySelector(selector);

            if (el) {
                return el;
            }
        } catch (e) {
            throw new RuntimeError("incorrect CSS selector: " + selector, 783);
        }
        
        return null;
    },
    

    // Find element's position (for TAG recording)
    findPosition: function(element, atts, form_atts) {
        var xpath = "descendant-or-self::"+element.tagName;
        var doc = element.ownerDocument;
        var ctx = doc.documentElement;
        var nodes = new Array(), count = 0;
        // evaluate XPath
        try {
            var res = doc.evaluate(xpath, ctx, null,
                                   XPathResult.ORDERED_NODE_ITERATOR_TYPE,
                                   null);
            var node = null;
            while (node = res.iterateNext()) {
                nodes.push(node);
            }
        } catch (e) {
            console.error(e);
        }
    
        // check for NoFormName
        if (form_atts && form_atts["name"] &&
            form_atts["name"].exec("NoFormName"))
            form_atts = null;
        
        // loop over nodes
        for (var i = 0; i < nodes.length; i++) {
            // First check that all atts matches
            // if !atts then match elements with any attributes
            var match = atts ? this.match(nodes[i], atts) : true;
            // then check that the element's form matches form_atts
            if (match && form_atts && nodes[i].form)
                match = this.match(nodes[i].form, form_atts);
            if (match) 
                count++;
            if (nodes[i] == element)
                break;
        }

        return count;
    },


        
    // handles EXTRACT=TXT|TXTALL|HTM|ALT|HREF|TITLE|CHECKED
    onExtractParam: function(tagName, element, extract_type) {
        var tmp = "", i;
        if (/^(txt|txtall)$/i.test(extract_type)) {
            tmp = RegExp.$1.toLowerCase();
            switch (tagName) {
            case "input": case "textarea":
                return element.value;
            case "select":
                if (tmp == "txtall") {
                    var s = new Array(), options = element.options;
                    for (i = 0; i < options.length; i++) {
                        s.push(options[i].text);
                    }
                    return s.join("[OPTION]");
                } else {
                    // only first selected, this may be a bug
                    // there is no clear specs 
                    return element.value;
                }
            case "table":
                tmp = "";
                for ( i = 0; i < element.rows.length; i++) {
                    var row = element.rows[i], ar = new Array();
                    for (var j = 0; j < row.cells.length; j++)
                        ar.push(row.cells[j].textContent);
                    tmp += '"'+ar.join('","')+'"\n';
                }
                return tmp;
            default:
                return element.textContent;
            }
        } else if (/^htm$/i.test(extract_type)) {
            tmp = element.outerHTML;
            tmp = tmp.replace(/[\t\n\r]/g, " ");
            return tmp;
        } else if (/^href$/i.test(extract_type)) {
            if ("href" in element) 
                return element["href"];
            else if (element.hasAttribute("href"))
                return elem.getAttribute("href");
            else if ("src" in element)
                return element["src"];
            else if (element.hasAttribute("src"))
                return elem.getAttribute("src");
            else
                return "#EANF#";
        } else if (/^(title|alt)$/i.test(extract_type)) {
            tmp = RegExp.$1.toLowerCase();
            if (tmp in element)
                return element[tmp];
            else if (element.hasAttribute(tmp)) 
                return elem.getAttribute(tmp);
            else
                return "#EANF#";
        } else if (/^checked$/i.test(extract_type)) {
            if (!/^(?:checkbox|radio)$/i.test(element.type))
                throw new BadParameter("EXTRACT=CHECKED makes sense"+
                                       " only for check or radio boxes");
            return element.checked ? "YES" : "NO";
        } else {
            throw new BadParameter("EXTRACT=TXT|TXTALL|HTM|"+
                                   "TITLE|ALT|HREF|CHECKED", 5);
        }
    },


    // handles CONTENT=...
    onContentParam: function(tagName, element, args) {
        var tmp;
        // fire "focus" event
        this.htmlFocusEvent(element);
        
        switch (tagName) {
        case "select":
            // <select> element has special content semantic
            // so let the function handle it
            this.handleSelectElement(element, args);
            this.htmlChangeEvent(element);
            break;
        case "input":
            switch(element.type) {
            case "file":
                throw new FileInputElement(element, args.txt)
                break;
            case "text": case "hidden": 
                // HTML5 types
            case "color": case "date": case "datetime":
            case "datetime-local": case "email": case "month":
            case "number": case "range": case "search":
            case "tel": case "time": case "url": case "week":
                element.value = args.txt;
                this.htmlChangeEvent(element);
                break;
            case "password":
                if (!args.passwordDecrypted)
                    throw new ShouldDecryptPassword()
                this.handlePasswordElement(element, args.txt);
                this.htmlChangeEvent(element);
                break;
            case "checkbox":
                if (/^(?:true|yes|on)$/i.test(args.txt)) {
                    if (!element.checked) 
                        element.click();
                } else {
                    if (element.checked)
                        element.click();
                }
                break;
            default:
                // click on button-like elements
                this.simulateClick(element);
            }
            break;
        case "button":
            this.simulateClick(element);
            break;
        case "textarea":
            element.value = args.txt;
            this.htmlChangeEvent(element);
            break;
        default:
            // there is not much to do with other elements
            // let's try to click it
            this.simulateClick(element);
        }
        // fire "blur" event
        this.htmlBlurEvent(element);
    },


    // process <select> element
    handleSelectElement: function(element, args) {
        var options = element.options;

        // remove selection if any
        if (element.multiple)
            element.options.selectedIndex = -1;
        
        if (args.cdata.type != "select")
            throw new RuntimeError(
                "Unable to select entry(ies) specified by: "+
                    args.rawdata, 725);

        if (args.cdata.seltype =="all") {
            // select all tags
            for (var j = 0; j < options.length; j++)
                options[j].selected = true;
            return;
        } 
        
        if (args.cdata.seltype == "multiple") // multiple selection
            element.multiple = true;

        for (var i = 0; i < args.cdata.opts.length; i++) {
            switch (args.cdata.opts[i].typ) {
                case "$": case "%":
                var re = new RegExp(args.cdata.opts[i].re_str, "i");
        var found = false;
                for (var j = 0; j < options.length; j++) {
                    var o = options[j];
                    var s = (args.cdata.opts[i].typ == "$") ?
                        imns.escapeTextContent(o.text) : o.value;
                    if (re.exec(s)) {
                        found = true;
                        options[j].selected = true;
                        break;
                    }
                }
                if (!found) {
                    throw new RuntimeError(
                        "Entry ["+args.cdata.opts[i].str+"] not available"+
                            " [Box has "+options.length+" entries]", 725);
                }
                break;
            case "#": // index
                if (args.cdata.opts[i].idx > element.length)
                    throw new RuntimeError(
                        "Entry with index "+args.cdata.opts[i].idx+
                            " not available [Box has "+element.length+
                            " entries]", 724);
                options[args.cdata.opts[i].idx-1].selected = true;
                break;
            }
        }
    },

    // process <input type="password"/> element
    handlePasswordElement: function(element, content) {
        element.value = content;
    },

    // simulate mouse click on the element
    simulateClick: function(element) {
        if (typeof(element.click) == "function") {
            element.click();
        } else {
            var initEvent = function(e, d, typ) {
                e.initMouseEvent(typ, true, true, d.defaultView, 1, 0, 0, 0, 0,
                                 false, false, false, false, 0, null);
            };
            var stop = function (e) { e.stopPropagation(); };

            var doc = element.ownerDocument, x;
            var events = { "mouseover": null,
                "mousedown": null,
                "mouseup"  : null,
                "click"    : null };

            element.addEventListener("mouseover", stop, false);
            element.addEventListener("mouseout", stop, false);
            
            for (x in events) {
                events[x] = doc.createEvent("MouseEvent");
                initEvent(events[x], doc, x);
                element.dispatchEvent(events[x]);
            }
        }
    },

    // dispatch HTML "change" event to the element
    htmlChangeEvent: function(element) {
        if (!/^(?:input|select|textarea)$/i.test(element.tagName))
            return;
        var evt = element.ownerDocument.createEvent("Event");
        evt.initEvent("change", true, false);
        element.dispatchEvent(evt);
    },

    // dispatch HTML focus event
    htmlFocusEvent: function(element) {
        if (!/^(?:a|area|label|input|select|textarea|button)$/i.
            test(element.tagName))
            return;
        var evt = element.ownerDocument.createEvent("Event");
        evt.initEvent("focus", false, false);
        element.dispatchEvent(evt);
    },

    // dispatch HTML blur event
    htmlBlurEvent: function(element) {
        if (!/^(?:a|area|label|input|select|textarea|button)$/i.
            test(element.tagName))
            return;
        var evt = element.ownerDocument.createEvent("Event");
        evt.initEvent("blur", false, false);
        element.dispatchEvent(evt);
    }

};



function CSPlayer() {
    this.registerHandlers();
}


CSPlayer.prototype.registerHandlers = function() {
    connector.registerHandler("tag-command",
                              this.handleTagCommand.bind(this) );
    connector.registerHandler("refresh-command",
                              this.handleRefreshCommand.bind(this) );
    connector.registerHandler("back-command",
                              this.handleBackCommand.bind(this) );
    connector.registerHandler("prompt-command",
                              this.handlePromptCommand.bind(this) );
    connector.registerHandler("saveas-command",
                              this.handleSaveAsCommand.bind(this));
    connector.registerHandler("search-command",
                              this.handleSearchCommand.bind(this));
    connector.registerHandler("image-search-command",
                              this.handleImageSearchCommand.bind(this));
    connector.registerHandler("frame-command",
                              this.handleFrameCommand.bind(this));
    connector.registerHandler("tab-command",
                              this.handleTabCommand.bind(this));
    connector.registerHandler("stop-replaying",
                              this.onStopReplaying.bind(this));
    connector.registerHandler("query-page-dimensions",
                              this.onQueryPageDimensions.bind(this));
    connector.registerHandler("webpage-scroll-to",
                              this.onWebPageScrollTo.bind(this));
    connector.registerHandler("webpage-hide-scrollbars",
                              this.onHideScrollbars.bind(this));
    connector.addHandler("activate-element",
                         this.onActivateElement.bind(this));
    connector.addHandler("query-css-selector",
                         this.onQueryCssSelector.bind(this));
    window.addEventListener("error", function(err) {
        var obj = {
            name: "ScriptError",
            message: err.message+" on "+err.filename+":"+err.lineno
        }
        connector.postMessage("error-occurred", obj);
    });
};


CSPlayer.prototype.handleRefreshCommand = function(args, callback) {
    if (callback)
        callback();
    window.location.reload();
};

CSPlayer.prototype.handleBackCommand = function(args, callback) {
    if (callback)
        callback();
    history.back();
};


CSPlayer.prototype.handlePromptCommand = function(args, callback) {
    var retobj = {varnum: args.varnum, varname: args.varname};
    if (typeof(args.varnum) != "undefined" ||
        typeof(args.varname) != "undefined") {
        // TODO: check if input was cancelled
        retobj.value = prompt(args.text, args.defval);
    } else {
        alert(args.text);
    }
    callback(retobj);
};

CSPlayer.prototype.handleFrameCommand = function(args, callback) {
    // find frame by number
    var findFrame = function(win, obj) {
        var frames = win.frames, i, f;
        for (i = 0; i < frames.length; i++) {
            var dv = frames[i];
            if (--obj.num == 0) {
                return frames[i];
            } else if (f = findFrame(dv, obj))
                return f;
        }
        return null;
    };

    // find frame by name
    var findFrameByName = function(win, name) {
        var frames = win.frames, i;
        for (var i = 0; i < frames.length; i++) {
            var dv = frames[i];
            if (name.test(frames[i].name))
                return frames[i];
            else if (f = findFrameByName(dv, name))
                return f;
        }
        return null;
    };

    var f = null;
    if (typeof(args.number) == "number") {
        f = findFrame(window, {num: args.number});
    } else if (args.name) {
        var name_re = new RegExp("^"+args.name.replace(/\*/g, ".*")+"$");
        f = findFrameByName(window, name_re);
    }
    // console.log("handleFrame: args=%O, frame %s", args,
    //            (f? "found" : "not found"));
    callback( f? {frame: args} : {});
};

// currently the main purpouse of the handler is remove
// highlight div if present
CSPlayer.prototype.handleTabCommand = function(args, callback) {
    if (callback)
        callback();
    var hl_div = document.getElementById("imacros-highlight-div");
    if (hl_div) {
        (hl_div.parentNode || hl_div.ownerDocument).
            removeChild(hl_div);
    }
};

// currently the main purpouse of the handler is remove
// highlight div if present
CSPlayer.prototype.onStopReplaying = function(args, callback) {
    if (callback)
        callback();
    var hl_div = document.getElementById("imacros-highlight-div");
    if (hl_div) {
        (hl_div.parentNode || hl_div.ownerDocument).
            removeChild(hl_div);
    }
};


CSPlayer.prototype.highlightElement = function(element) {
    var doc = element.ownerDocument;
    var hl_div = doc.getElementById("imacros-highlight-div");
    var hl_img = null;
    if (!hl_div) {
        // TODO: maybe move that into CSS file and inject that file
        // onto page dynamically?
        hl_div = doc.createElement("div");
        hl_div.id = "imacros-highlight-div";
        hl_div.style.position = "absolute";
        hl_div.style.zIndex = 1000;
        hl_div.style.border = "1px solid blue";
        hl_div.style.borderRadius = "2px";
        hl_img = doc.createElement("div");
        hl_img.style.display="block";
        hl_img.style.width = "24px";
        hl_img.style.height = "24px";
        hl_img.style.backgroundImage =
            "url('"+chrome.extension.getURL("skin/logo24.png")+"')";
        hl_img.style.pointerEvents = "none"
        hl_div.appendChild(hl_img);
        doc.body.appendChild(hl_div);
    } else {
        hl_img = hl_div.firstChild;
    }
    var rect = element.getBoundingClientRect();
    var scrollX = doc.defaultView.scrollX;
    var scrollY = doc.defaultView.scrollY;
    hl_div.style.left = Math.round(rect.left-1+scrollX)+"px";
    hl_div.style.top = Math.round(rect.top-1+scrollY)+"px";
    hl_div.style.width = Math.round(rect.width)+"px";
    hl_div.style.height = Math.round(rect.height)+"px";
    // position image 
    if (rect.top > 26) {
        hl_img.style.marginLeft = "4px";
        hl_img.style.marginTop = "-26px";
    } else if (rect.bottom+26 < doc.body.clientHeight) {
        hl_img.style.marginLeft = "4px";
        hl_img.style.marginBottom = "-26px";
    } else if (rect.left > 26) {
        hl_img.style.marginLeft = "-26px";
        hl_img.style.marginTop = "4px";
    } else if (rect.right+26 < doc.body.clientWidth) {
        hl_img.style.marginRight = "-26px";
        hl_img.style.marginTop = "4px";
    } else {
        hl_img.style.marginLeft = "0px";
        hl_img.style.marginTop = "0px";
    }

    return hl_div;
};


CSPlayer.prototype.handleTagCommand = function(args, callback) {
    var doc = window.document;
    var root = doc.documentElement;
    var element;

    var retobj = {
        found: false,       // element found
        extract: "",        // extract string if any
        error: null         // error message or code
    };
    // console.info("playing tag comand args=%O on page=%s", args,
    //              window.location.toString());
    try {
        // compile regexps for atts and form
        if (args.atts)
            for (var x in args.atts) 
                args.atts[x] = new RegExp(args.atts[x], "i");
        if (args.form)
            for (var x in args.form) 
                args.form[x] = new RegExp(args.form[x], "i");

        if (args.xpath)
            element = TagHandler.findByXPath(doc, root, args.xpath);
        else if (args.selector)
            element = TagHandler.findByCSS(doc, args.selector);
        else
            element = TagHandler.find(doc, root, args.pos, args.relative,
                                      args.tagName, args.atts, args.form);
        let is_fail_if_found = (args.type == "content" && args.cdata.type == "event" && args.cdata.etype == "fail_if_found");
        if (!element) {
            if (!is_fail_if_found) {
                var descriptor;

                if (args.atts_str)
                    descriptor = args.atts_str;
                else if (args.xpath)
                    descriptor = args.xpath;
                else
                    descriptor = args.selector;

                var msg = "element "+args.tagName.toUpperCase()+
                    " specified by "+ descriptor +
                    " was not found";
                if (args.type == "extract") {
                    retobj.extract = "#EANF#";
                }
                else {
                    retobj.error = normalize_error(new RuntimeError(msg, 721));
                }
            } else {
                retobj.found = true;
            }
            callback(retobj);
            return;
        }
        retobj.found = true;
        // scroll to the element
        if (args.scroll) {
            var pos = ClickHandler.findElementPosition(element);
            window.scrollTo(pos.x-100, pos.y-100);
        }

        // make it blue
        if (args.highlight) {
            this.highlightElement(element);
        }

        if (args.tagName == "*" || args.tagName == "")
            args.tagName = element.tagName.toLowerCase();
        // extract
        if (args.type == "extract") {
            retobj.extract =
                TagHandler.onExtractParam(args.tagName, element, args.txt);
        } else if (args.type == "content") {
            if (args.cdata.type == "event") {
                switch(args.cdata.etype) {
                case "saveitem": case "savepictureas":
                case "savetargetas": case "savetarget":
                    var e = element;
                while(e && e.nodeType == e.ELEMENT_NODE &&
                  !(e.hasAttribute("href") || e.hasAttribute("src"))
                 )
                e = e.parentNode;
                if (!e || e.nodeType != e.ELEMENT_NODE) {
                retobj.error = normalize_error( new RuntimeError(
                    "Can not find link to save target", 723
                ));
                        break;
                    }
                retobj.targetURI =  e.href || e.src;
                    break;
                case "mouseover":
                    var evt = doc.createEvent("MouseEvent");
                    evt.initMouseEvent("mouseover", true, true,
                                       doc.defaultView, 0, 0, 0, 0, 0,
                                       false, false, false, false, 0, null);
                    element.dispatchEvent(evt);
                    break;
                case "fail_if_found":
                    retobj.error = normalize_error(
                        new RuntimeError("FAIL_IF_FOUND event", 790)
                    );
                    break;
                default:
                    retobj.error = normalize_error(
                        new Error("Unknown event type "+
                                  args.cdata.etype.toUpperCase())
                    );
                }
            } else {
                TagHandler.onContentParam(args.tagName, element, args);
            }
        } else {
            if (args.download_pdf &&
                element.tagName == "A" 
                && /\.pdf$/i.test(element.href)) {
                retobj.targetURI =  element.href;
            } else {
                TagHandler.onContentParam(args.tagName, element, args);
            }
        }
    } catch (e) {
        if (e instanceof FileInputElement) {
            retobj.found = true
            retobj.selector = e.selector
            retobj.files = e.files
        } else if (e instanceof ShouldDecryptPassword) {
            retobj.found = true
            retobj.decryptPassword = true
        } else {
            retobj.error = normalize_error(e);
            console.error(e);
        }
    } finally {
        // console.log("handleTagCommand, retobj=%O", retobj);
        callback(retobj);
    }
};



CSPlayer.prototype.handleSaveAsCommand = function(args, callback) {
    if (args.type == "htm") {
        callback(document.documentElement.outerHTML);
    } else if (args.type == "txt") {
        callback(document.documentElement.innerText);
    }
};



CSPlayer.prototype.handleSearchCommand = function(args, callback) {
    var search_re, retobj = {found: false}, query = args.query;
    try {
        switch (args.type) {
        case "txt":
            // escape all chars which are of special meaning in regexp
            query = imns.escapeREChars(query);
            // replace * by 'match everything' regexp
            query = query.replace(/\*/g, '(?:[\r\n]|.)*');
            // treat all <SP> as a one or more whitespaces
            query = query.replace(/ /g, "\\s+");
            search_re = new RegExp(query, args.ignore_case);
            break;
        case "regexp":
            try {
                search_re = new RegExp(query, args.ignore_case);
            } catch(e) {
                console.error(e);
                throw new RuntimeError("Can not compile regular expression: "
                                       +query, 711);
            }
            break;
        }
        
        var root = window.document.documentElement;
        var found = search_re.exec(root.innerHTML);
        if (!found) {
            throw new RuntimeError(
                "Source does not match to "+args.type.toUpperCase()+"='"+
                    args.query+"'", 726
            );
        }
        retobj.found = true;
        if (args.extract) {
            retobj.extract = args.extract.
                replace(/\$(\d{1,2})/g, function (match_str, x) {
                    return found[x];
                });
        }
    } catch(e) {
        retobj.error = normalize_error(e);
        console.error(e);
    } finally {
        callback(retobj);
    }
};



CSPlayer.prototype.handleImageSearchCommand = function(args, callback) {
    var div = document.createElement("div");
    div.style.width = args.width+"px";
    div.style.height = args.height+"px";
    div.style.border = "1px solid #9bff9b";
    div.style.zIndex = "100";
    div.style.position = "absolute";
    div.style.pointerEvents = "none"
    div.style.left = Math.floor(args.x-args.width/2)+"px";
    div.style.top = Math.floor(args.y-args.height/2)+"px";
    document.body.appendChild(div);
    window.scrollTo(args.x-100, args.y-100);
    callback();
};

var originalOverflowStyle = document.documentElement.style.overflow;

CSPlayer.prototype.onQueryPageDimensions = function(args, callback) {  
    var width = document.documentElement.scrollWidth;
    var height = document.documentElement.scrollHeight;
    
    if (document.body) {
        width = Math.max(width,document.body.scrollWidth);
        height = Math.max(height,document.body.scrollHeight);
    }

    var retobj = {doc_w: width,
                  doc_h: height,
                  win_w: window.innerWidth,
                  win_h: window.innerHeight};
    callback(retobj);
};

CSPlayer.prototype.onWebPageScrollTo = function(args, callback) {
    window.scrollTo(args.x, args.y);
    // console.log("scrollX=%d, scrollY=%d", window.scrollX, window.scrollY);
    // NOTE: it seems there is no deterministic way to do it,
    // so I put 500ms delay here;
    // onscroll is fired too early and not after scroll completion
    setTimeout(callback, 500);
};

CSPlayer.prototype.onHideScrollbars = function(args, callback) {   
    if(args.hide)  {        
        document.documentElement.style.overflow = 'hidden';
    } else {
        document.documentElement.style.overflow = originalOverflowStyle;
    }
    setTimeout(callback, 500);
}

// get offset of the current window relative to topmost frame
function getXYOffset(w) {
    if (w === window.top) {
        let style = w.getComputedStyle(w.document.body)
        return {x_offset: parseInt(style.marginLeft),
                y_offset: parseInt(style.marginTop)}
    }
        
    let {x_offset, y_offset} = getXYOffset(w.parent)
    let style = w.parent.getComputedStyle(w.frameElement)
    let rect = w.frameElement.getBoundingClientRect()
    return {
        x_offset: rect.left + x_offset + parseInt(style.borderLeftWidth),
        y_offset: rect.top + y_offset + parseInt(style.borderTopWidth)
    }
}

CSPlayer.prototype.onActivateElement = function(args, sendResponse) {
    var el, sel;
    if (args.selector) {
        sel = args.selector;
        el = document.querySelector(sel);
    } else if (args.xpath) {
        sel = args.xpath;
        el = TagHandler.findByXPath(window.document, window.document.documentElement, sel);
    }

    if (!el) {
        sendResponse({
            error: normalize_error(
                new RuntimeError(
                    "element specified by "+
                        sel+" not found", 721
                )
            )
        })
    } else {
        // hack for handling select boxes in event mode
        if (el.tagName.toLowerCase() == "option") {
            el.selected = true
        }
        if (args.scroll) {
            var pos = ClickHandler.findElementPosition(el);
            window.scrollTo(pos.x-100, pos.y-100);
        }
        var rect = el.getBoundingClientRect();
        let {x_offset, y_offset} = getXYOffset(window)
        sendResponse({
            targetRect:
            {
                left: rect.left,
                top: rect.top,
                bottom: rect.bottom,
                right: rect.right,
                width: rect.width,
                height: rect.height,
                xOffset: x_offset,
                yOffset: y_offset,
                pageXOffset: window.pageXOffset,
                pageYOffset: window.pageYOffset
            },
            isPasswordElement: el.type == "password"
        });
    }
};

CSPlayer.prototype.onQueryCssSelector = function(args, sendresponse) {
    // Stub to avoid error:
    // player.js:644 Uncaught TypeError: Cannot read property 'bind' of undefined
    // at connector.addHandler("query-css-selector", this.onQueryCssSelector.bind(this));
    // at CSPlayer.registerHandlers (player.js:644)
};


var player = new CSPlayer();





======================================================================
FILE PATH: content_scripts\recorder.js
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/

(function() {

    // NOTE:  A small step towards unifying code base; at some later time
    // we'll have updated utils.js with better ns separation but for now
    // just make a reference to imns
    var StrUtils = imns;


    function CSRecorder() {
        this.onChangeEvent = this.onChange.bind(this);
        this.onClickEvent = this.onClick.bind(this);
        this.onMouseDownEvent = this.onMouseDown.bind(this);
        this.onMouseUpEvent = this.onMouseUp.bind(this);
        this.onMouseMoveEvent = this.onMouseMove.bind(this);
        this.onMouseClickEvent = this.onMouseClick.bind(this);
        this.onDblClickEvent = this.onMouseDblClick.bind(this);
        this.onKeyPressEvent2 = this.onKeyPress2.bind(this);
        this.onKeyPressEvent = this.onKeyPress.bind(this);
        this.onKeyDownEvent = this.onKeyDown.bind(this);
        this.onKeyDownEvent2 = this.onKeyDown2.bind(this);
        this.onKeyUpEvent2 = this.onKeyUp2.bind(this);
        this.onFocusInEvent = this.onFocusIn.bind(this)
        this.onChangeEvent2 = this.onChange2.bind(this)
        connector.registerHandler("start-recording",
                                  this.onStartRecording.bind(this));
        connector.registerHandler("stop-recording",
                                  this.onStopRecording.bind(this));
        connector.registerHandler("on-rclick",
                                  this.onContextMenu.bind(this));
        connector.postMessage("query-state", {},
                              this.onQueryStateCompleted.bind(this));
    }

    CSRecorder.prototype.addDOMEventsListeners = function(win) {
        if (!win)
            return;
        if (this.recordMode == "event") {
            win.addEventListener("mousedown", this.onMouseDownEvent, true);
            win.addEventListener("mouseup", this.onMouseUpEvent, true);
            win.addEventListener("click", this.onMouseClickEvent, true);
            win.addEventListener("dblclick", this.onDblClickEvent, true);
            win.addEventListener("keypress", this.onKeyPressEvent2, true);
            win.addEventListener("keydown", this.onKeyDownEvent2, true);
            win.addEventListener("keyup", this.onKeyUpEvent2, true);
            win.addEventListener("focus", this.onFocusInEvent, true)
            win.addEventListener("change", this.onChangeEvent2, true)
        } else if (this.recordMode == "conventional") {
            win.addEventListener("click", this.onClickEvent, true);
            win.addEventListener("change", this.onChangeEvent, true);
            win.addEventListener("keydown", this.onKeyDownEvent, true);
            win.addEventListener("keypress", this.onKeyPressEvent, true);
            win.addEventListener("focus", this.onFocusInEvent, true)
        }
        var self = this;
        win.addEventListener("unload", function listener () {
            self.removeDOMEventsListeners(win);
            win.removeEventListener("unload", listener);
        });
    };

    CSRecorder.prototype.removeDOMEventsListeners = function(win) {
        if (!win)
            return;
        if (this.recordMode == "event") {
            win.removeEventListener("mousedown", this.onMouseDownEvent, true);
            win.removeEventListener("mouseup", this.onMouseUpEvent, true);
            win.removeEventListener("click", this.onMouseClickEvent, true);
            win.removeEventListener("dblclick", this.onDblClickEvent, true);
            win.removeEventListener("keypress", this.onKeyPressEvent2, true);
            win.removeEventListener("focus", this.onFocusInEvent, true);
            win.removeEventListener("change", this.onChangeEvent2, true)
        } else if (this.recordMode == "conventional") {
            win.removeEventListener("click", this.onClickEvent, true);
            win.removeEventListener("change", this.onChangeEvent, true);
            win.removeEventListener("keydown", this.onKeyDownEvent, true);
            win.removeEventListener("keypress", this.onKeyPressEvent, true);
            win.removeEventListener("focus", this.onFocusInEvent, true)
        }
    };

    CSRecorder.prototype.onStopRecording = function(data, callback) {
        if (callback)
            callback();
        if (this.recording)
            this.stop();
        var hl_div = document.getElementById("imacros-highlight-div");
        if (hl_div) {
            (hl_div.parentNode || hl_div.ownerDocument).
                removeChild(hl_div);
        }
    };

    CSRecorder.prototype.onStartRecording = function(data, callback) {
        if (callback)
            callback();
        this.start(data.args);
    };


    CSRecorder.prototype.onQueryStateCompleted = function(data) {
        if (data === null)
            return;

        // force recording after page load
        if (data.state == "recording" && !this.recording) {
            this.start(data.args);
        }
    };

    CSRecorder.prototype.start = function(args) {
        this.recording = true;
        this.submitter = null;
        this.favorIds = args.favorId;
        this.cssSelectors = args.cssSelectors;
        this.recordMode = args.recordMode;
        this.addDOMEventsListeners(window);
    };

    CSRecorder.prototype.stop = function() {
        this.recording = false;
        this.submitter = null;
        this.removeDOMEventsListeners(window);
    };


    CSRecorder.prototype.saveAction = function(str, extra) {
        connector.postMessage(
            "record-action", {action: str, extra: extra || null}
        );
    };


    const im_strre = "(?:\"(?:[^\"\\\\]|\\\\[0btnvfr\"\'\\\\])*\"|\\S*)";
    // helper function to parse ATTR=... string
    CSRecorder.prototype.parseAtts = function(str) {
        if (!str || str == "*")
            return null;
        var arr = str.split(new RegExp("&&(?=[-\\w]+:"+im_strre+")"));
        var parsed_atts = new Object(), at, val, m;
        const re = new RegExp("^([-\\w]+):("+im_strre+")$");
        for (var i = 0; i < arr.length; i++) {
            if (!(m = re.exec(arr[i])))
                throw new BadParameter("incorrect ATTR or FORM specifier: "
                                       +arr[i]);
            at = m[1].toLowerCase();
            if (at.length) {
                val = StrUtils.unwrap(m[2]);
                // While replaying:
                // 1. remove all leading/trailing whitespaces 
                // 2. remove all linebreaks in the target string
                val = StrUtils.escapeTextContent(val);
                val = StrUtils.escapeREChars(val);
                val = val.replace(/\*/g, '(?:\n|.)*');
                // 3. treat all <SP> as a one or more whitespaces
                val = val.replace(/ /g, "\\s+");
                parsed_atts[at] = "^\\s*"+val+"\\s*$";
            } else {
                parsed_atts[at] = "^$";
            }
        }
        for (var x in parsed_atts) 
            parsed_atts[x] = new RegExp(parsed_atts[x]);

        return parsed_atts;
    };


    CSRecorder.prototype.match = function(node, atts) {
        var match = true;

        for (var at in atts) {
            if (at == "txt") {
                var txt = StrUtils.escapeTextContent(node.textContent);
                if (!atts[at].exec(txt)) {
                    match = false; break;
                }
            } else {
                var atval = "", propval = "";
                // first check if the element has the <at> property 
                if (at in node) {
                    propval = node[at];
                    // TODO: HTML 5 cheat: make 'type' as if
                    // returning 'text' for all the new data-like
                    // input types; atval should provide a safe fallback
                    // for the cases when recorded type is
                    // properly specified
                    if (at == "type" && is_html5_input_type(propval))
                        propval = "text";
                } else if (at == "href" && "src" in node) {
                    // special case for old macros
                    // treat 'href' as 'src' 
                    propval = node.src;
                }
                // then check if the element has the <at> attribute
                if (node.hasAttribute(at)) {
                    atval = node.getAttribute(at);
                }
                // applay regexp to the values
                if (!(!!atts[at].exec(propval) || !!atts[at].exec(atval))) {
                    match = false; break;
                }
            } 
        }
        return match;
    };


    CSRecorder.prototype.findPosition =
        function(element,atts,form_atts)
    {
        // make case-insensitive xpath search
        // in XML documents case matters
        var xpath = "descendant-or-self::*[translate(local-name(),"+
            "'ABCDEFGHIJKLMNOPQRSTUVWXYZ',"+
            "'abcdefghijklmnopqrstuvwxyz')='"+
            element.tagName.toLowerCase()+"']";
        var doc = element.ownerDocument;
        var ctx = doc.documentElement;
        var nodes = new Array(), count = 0;
        // evaluate XPath
        try {
            var res = doc.evaluate(
                xpath, ctx, null,
	        window.XPathResult.ORDERED_NODE_ITERATOR_TYPE, null
            );
            var node = null;
            while (node = res.iterateNext()) {
                nodes.push(node);
            }
        } catch (e) {
            Components.utils.reportError(e);
        }
        
        // check for NoFormName
        if (form_atts && form_atts["name"] &&
            form_atts["name"].exec("NoFormName"))
            form_atts = null;
        
        // loop over nodes
        for (var i = 0; i < nodes.length; i++) {
            // First check that all atts matches
            // if !atts then match elements with any attributes
            var match = atts ? this.match(nodes[i], atts) : true;
            // then check that the element's form matches form_atts
            if (match && form_atts && nodes[i].form)
                match = this.match(nodes[i].form, form_atts);
            if (match) 
                count++;
            if (nodes[i] == element)
                break;
        }

        return count;
    };


    CSRecorder.prototype.makeFormRecord = function(elem) {
        var form = "";
        if (elem.form) {
            if (elem.form.id && this.favorIds) {
                form = "ID:"+StrUtils.wrap(elem.form.id);
            } else {
                // NOTE: workaround for Chrome bug: element.form.name
                // returns <input> element with id=name instead of form's name
                // attribute value 
                if (elem.form.hasAttribute('name')) {
                    form = "NAME:"+StrUtils.wrap(
                        elem.form.getAttribute('name')
                    );
                } else if (elem.form.action) {
                    var x;
                    if (!(x = elem.form.getAttribute("action")))
                        x = elem.form.action;
                    form = "ACTION:"+StrUtils.wrap(x);
                } else {
                    form = "NAME:NoFormName";
                }
            }
        }

        return form;
    };


    CSRecorder.prototype.makeAttrRecord = function (elem) {
        // trancate text more than 60 chars long, fx #647
        var truncate = function(s) {
            s = s.toString();
            if (s.length > 60) {
                s = s.substring(0, 60);
                s = s.replace(/(?:<|<\w{0,2}|<\w{2}>)+$/, "");
                s += "*";
            } 
            return s;
        };

        var attr = "";

        if ("input" == elem.tagName.toLowerCase()) {
            if (this.favorIds && elem.id) {
                attr = "ID:"+StrUtils.wrap(elem.id);
            } else {
                var arr = new Array();
                if (elem.name)
                    arr.push("NAME:"+StrUtils.wrap(elem.name));
                if (elem.src)
                    arr.push("SRC:"+StrUtils.wrap(elem.src));
                attr = arr.length ? arr.join("&&") : "*";
            }
        } else {
            var val = "";
            if (this.favorIds && elem.id) {
                val = "ID:"+StrUtils.wrap(elem.id);
            } else if (elem.href) {
                // record txt content first for anchor elements
                if (elem.textContent) {
                    val = "TXT:"+truncate(StrUtils.wrap(
                        StrUtils.escapeTextContent(elem.textContent)
                    ));
                } else {
                    val = "HREF:"+StrUtils.wrap(elem.href);
                }
            } else {
                if (elem.src) {
                    val = "SRC:"+StrUtils.wrap(elem.src);
                } else if (elem.name) {
                    val = "NAME:"+StrUtils.wrap(elem.name);
                } else if (elem.alt) {
                    val = "ALT:"+StrUtils.wrap(elem.alt);
                } else if (elem.textContent) {
                    val = "TXT:"+truncate(StrUtils.wrap(
                        StrUtils.escapeTextContent(elem.textContent)
                    ));
                }
            }

            if (!val) {  //form attr string
                var x = elem.attributes, arr = new Array();
                for (var i = 0; i < x.length; i++) {
                    if (/^style$/i.test(x[i].name))
                        continue;
                    arr.push(x[i].name.toUpperCase()+":"+
                             StrUtils.wrap(x[i].value));
                }

                if (elem.textContent) {
                    arr.push("TXT:" + truncate(StrUtils.wrap(StrUtils.escapeTextContent(elem.textContent))));
                }
                val = arr.length ? arr.join("&&") : "*";
            }
            attr = val;
        }
        
        return attr;
    };

    CSRecorder.prototype.formNewRecord = function (pos, type, form, attr, content, target) {
        var newRecord = "TAG"

        if (this.cssSelectors) {
            newRecord += " SELECTOR=\"" + this.getSelectorForElement(target) + "\"";
        }
        else {
            newRecord  += " POS=" + pos
            newRecord  += " TYPE=" + type;
            newRecord  += form ? " FORM="+form : "";
            newRecord  += " ATTR=" + attr;
        }

        newRecord  += content ? " CONTENT=" + content : "";

        return newRecord;
    }

    var html5_input_types = new Set(
        ["color", "date", "datetime", "datetime-local",
         "email", "month", "number", "range", "search",
         "tel", "time", "url", "week"]
    );
    function is_html5_input_type(type) {
        return html5_input_types.has(type.toLowerCase());
    }


    function is_html5_text_input_type(type) {
        var t = type.toLowerCase();
        return t == "email" ||
            t == "search" ||
            t == "tel" ||
            t == "file" ||
            t == "url";
    }


    CSRecorder.prototype.onChange = function(e) {
        if (!e.isTrusted)
            return;
        var elem = e.target;
        var tagName = elem.tagName;

        if (!/^(?:input|textarea|select)$/i.test(tagName) ||
            /^input$/i.test(tagName) &&
            !(is_html5_input_type(elem.type) ||
              /^(?:text|password|checkbox|file)$/i.test(elem.type))
           )
            return;

        var rec = "", pos = 0, tag_content = "", type = tagName;
        let extra = {}
        // CONTENT
        switch (tagName) {
        case "INPUT":
            type += ":"+elem.type.toUpperCase();
            if (is_html5_input_type(elem.type) ||
                /^(?:text|file)$/i.test(elem.type)) {
                tag_content = StrUtils.wrap(elem.value);
            } else if (elem.type == "password") {
                // password will be handled in chrome recorder
                // no special handling here
                extra.encrypt = true
                tag_content = StrUtils.wrap(elem.value);
            } else if (elem.type == "checkbox") {
                tag_content = elem.checked ? "YES" : "NO";
            } 
            break;
        case "SELECT":
            for(var i = 0; i < elem.length; i++) {
                var prefix, text;
                if(!elem[i].selected)
                    continue;
                
                if (elem[i].value) {
                    prefix = "%";
                    text = elem[i].value;
                } else {
                    prefix = "$";
                    text = escapeTextContent(elem[i].textContent);
                }
                if (!tag_content) 
                    tag_content = prefix + StrUtils.wrap(text);
                else
                    tag_content += ":" + prefix + StrUtils.wrap(text);
            }
            break;
        case "TEXTAREA":
            tag_content = StrUtils.wrap(elem.value);
            break;
        default:
            return;
        }


        var form = this.makeFormRecord(elem); // FORM
        var attr = this.makeAttrRecord(elem); // ATTR
        var atts = this.parseAtts(attr);      // POS

        // special handling of INPUT elements
        if (/input/i.test(tagName)) { 
            if (!atts) atts = new Object();
            atts["type"] = new RegExp("^"+elem.type+"$");
        }
        
        var form_atts = form ? this.parseAtts(form) : null;

        if (!(pos = this.findPosition(elem, atts, form_atts))) {
            // TODO: add appropriate error handling
            console.error("Can't find element position, atts="+
                          atts.toSource());
            return;
        }

        // if (highlight)
        this.highlightElement(elem);

        // form new record
        rec = this.formNewRecord(pos, type, form, attr, tag_content, elem);
        this.saveAction(rec, extra);

        // if submitter is not null that means we have form submitted 
        // through Enter key.
        // we should make record for sumbitter in that case
        if (this.submitter) {
            tagName = this.submitter.tagName.toUpperCase();
            type = tagName;
            if (tagName == "INPUT")
                type += ":"+this.submitter.type.toUpperCase();
            form = this.makeFormRecord(this.submitter);
            attr = this.makeAttrRecord(this.submitter);

            // find POS value
            atts = this.parseAtts(attr);
            if (!atts) atts = new Object();
            atts["type"] = new RegExp("^"+this.submitter.type+"$");
            form_atts = form ? this.parseAtts(form) : null;
            pos = this.findPosition(this.submitter, atts, form_atts);
            if (!pos) {
                // TODO: add appropriate error handling
                console.error("Can't find element position, atts="+
                              atts.toSource());
                return;
            }
            // if (highlight)
            this.highlightElement(this.submitter);
            // form new record
            rec = this.formNewRecord(pos, type, form, attr, null, elem);
            this.saveAction(rec);
            this.submitter = null;   
        }
    };



    CSRecorder.prototype.onKeyDown = function(e) {
        if (!e.isTrusted)
            return;
        // check form submission through Enter key
        var elem = e.target;
        var tagName = elem.tagName;

        if (tagName.toLowerCase() != "input" ||
            !(is_html5_text_input_type(elem.type) || 
              /^(?:text|password)$/i.test(elem.type)))
            return;

        if (e.keyCode != 13 && e.keyCode != 14)
            return;
        
        if (elem.form) {
            for (var i = 0; i < elem.form.elements.length; i++) {
                if (/submit/i.test(elem.form.elements[i].type)) {
                    // save the submitter element to record it
                    // on "change" event at later point
                    this.submitter = elem.form.elements[i];
                    break;
                }
            }
        }
    };


    CSRecorder.prototype.onKeyPress = function(e) {
        if (!e.isTrusted)
            return;
        var elem = e.target;
        var tagName = elem.tagName;

        // console.log("onKeyPress, element="+elem.tagName+
        // 	    ", url="+window.location.toString());

        if (!/^(?:input|textarea)$/i.test(tagName))
            return;
        
        if (/^input$/i.test(tagName) &&
            !(is_html5_text_input_type(elem.type) || 
              /^(?:text|password)$/i.test(elem.type)))
            return;

        var val = e.charCode ? String.fromCharCode(e.charCode) : "";
        var rec = "", type = tagName , pos = 0, tag_content = "";
        let extra = {}
        // CONTENT
        switch (tagName) {
        case "INPUT":
            type += ":"+elem.type.toUpperCase();
            if (is_html5_text_input_type(elem.type) ||
                elem.type.toLowerCase() == "text") {
                tag_content = StrUtils.wrap(elem.value+val);
            } else if (elem.type == "password") {
                // password will be handled in mrecorder
                // no special handling here
                extra.encrypt = true
                tag_content = StrUtils.wrap(elem.value+val);
            } 
            break;
            
        case "TEXTAREA":
            tag_content = StrUtils.wrap(elem.value+val);
            break;
        default:
            return;
        }

        var form = this.makeFormRecord(elem); // FORM
        var attr = this.makeAttrRecord(elem); // ATTR
        var atts = this.parseAtts(attr);      // POS

        // special handling of INPUT elements
        if (/input/i.test(tagName)) { 
            if (!atts) atts = new Object();
            atts["type"] = new RegExp("^"+elem.type+"$");
        }
        
        var form_atts = form ? this.parseAtts(form) : null;

        if (!(pos = this.findPosition(elem, atts, form_atts))) {
            // TODO: add appropriate error handling
            console.error("Can't find element position, atts="+
                          atts.toSource());
            return;
        }

        // if (highlight)
        this.highlightElement(elem);
        
        // form new record
        rec = this.formNewRecord(pos, type, form, attr, tag_content, elem);
        this.saveAction(rec, extra);

    };



    CSRecorder.prototype.onClick = function(e) {
        if (e.button != 0 || !e.isTrusted) // record only left mouse click
            return;
        
        var elem = e.target;
        var tagName = elem.tagName.toUpperCase();

        if (/^(?:select|option|textarea|form|html|body)$/i.test(tagName))
            return;
        else if (/^input$/i.test(tagName) &&
                 !/^(?:button|submit|radio|image)$/i.test(elem.type))
            return;

        var rec = "", pos = 0, tag_content = "", type = tagName;

        if (tagName.toLowerCase() == "input")
            type += ":"+elem.type.toUpperCase();
        
        var form = this.makeFormRecord(elem);
        var attr = this.makeAttrRecord(elem);

        // find POS value
        var atts = this.parseAtts(attr);
        // special handling of INPUT elements
        if (/input/i.test(tagName)) { 
            if (!atts) atts = new Object();
            atts["type"] = new RegExp("^"+elem.type+"$");
        }

        var form_atts = form ? this.parseAtts(form) : null;
        if (!(pos = this.findPosition(elem, atts, form_atts))) {
            // TODO: add appropriate error handling
            console.error("Can't find element position, atts="+atts.toSource());
            return;
        }

        // if (highlight)
        this.highlightElement(elem);
        
        // form new record
        rec = this.formNewRecord(pos, type, form, attr, tag_content, elem);
        this.saveAction(rec);
    };

    
    CSRecorder.prototype.findFrameByUrl = function(url) {
        var find_frame = function(url, win) {
            for (var i = 0; i < win.frames.length; i++) {
                if ( win.frames[i].frameElement.src == url) {
                    return win.frames[i];
                }
                var w = find_frame(url, win.frames[i]);
                if (w != null)
                    return w;
            }

            return null;
        };

        return find_frame(url, window.top);
    };

    CSRecorder.prototype.onContextMenu = function(args, callback) {
        // first check frame
        if (args.frameUrl) {
            var win = this.findFrameByUrl(args.frameUrl);
            if (win && win !== window) {
                win.recorder.onContextMenu(args, callback);
                return;
            }
        }
        var rv = {found: false, _frame: {
            number: connector.findFrameNumber(
                window.top, window, {num:0}
            ), 
            name: ""}};
        var it = document.createNodeIterator(
            document.body, NodeFilter.SHOW_ELEMENT, { 
                acceptNode: function(node) {
                    if ((node.src && node.src == args.linkUrl) || 
                        (node.href && node.href == args.linkUrl))
                        return NodeFilter.FILTER_ACCEPT;
                }
            }
        );

        // NOTE: There is no way to tell which of the matching elements was clicked
        // so we record the first one.
        var elem = it.nextNode();
        if (!elem) {
            callback(rv);
            return;
        } else {
            rv.found = true;
        }

        var tagName = elem.tagName.toUpperCase();

        var rec = "", type = tagName , pos = 0, content = "";
        
        var form = this.makeFormRecord(elem);
        var attr = this.makeAttrRecord(elem);

        // find POS value
        var atts = this.parseAtts(attr);
        var form_atts = form ? this.parseAtts(form) : null;
        if (!(pos = TagHandler.findPosition(elem, atts, form_atts))) {
            // TODO: add appropriate error handling
            console.error("Can't find element position, atts="+atts.toSource());
            rv.found = false;
            callback(rv);
            return;
        }

        // if (highlight)
        this.highlightElement(elem);
        
        // form new record
        rec = this.formNewRecord(pos, type, form, attr, "EVENT:SAVETARGETAS", elem);
        rv.action = rec;
        callback(rv);
    };


    CSRecorder.prototype.highlightElement = function(element) {
        var doc = element.ownerDocument;
        var hl_div = doc.createElement("div");
        hl_div.id = "imacros-highlight-div";
        hl_div.style.position = "absolute";
        hl_div.style.zIndex = 1000;
        hl_div.style.border = "1px solid #aaaaaa";
        hl_div.style.border = "1px solid blue";
        hl_div.style.borderRadius = "2px";
        var hl_img = doc.createElement("div");
        hl_img.style.display="block";
        hl_img.style.width = "24px";
        hl_img.style.height = "24px";
        hl_img.style.backgroundImage =
            "url('"+chrome.extension.getURL("skin/logo24.png")+"')";
        hl_div.appendChild(hl_img);
        doc.body.appendChild(hl_div);
        var rect = element.getBoundingClientRect();
        var scrollX = doc.defaultView.scrollX;
        var scrollY = doc.defaultView.scrollY;
        hl_div.style.left = Math.round(rect.left-1+scrollX)+"px";
        hl_div.style.top = Math.round(rect.top-1+scrollY)+"px";
        hl_div.style.width = Math.round(rect.width)+"px";
        hl_div.style.height = Math.round(rect.height)+"px";
        // position image 
        if (rect.top > 26) {
            hl_img.style.marginLeft = "4px";
            hl_img.style.marginTop = "-26px";
        } else if (rect.bottom+26 < doc.body.clientHeight) {
            hl_img.style.marginLeft = "4px";
            hl_img.style.marginBottom = "-26px";
        } else if (rect.left > 26) {
            hl_img.style.marginLeft = "-26px";
            hl_img.style.marginTop = "4px";
        } else if (rect.right+26 < doc.body.clientWidth) {
            hl_img.style.marginRight = "-26px";
            hl_img.style.marginTop = "4px";
        } else {
            hl_img.style.marginLeft = "0px";
            hl_img.style.marginTop = "0px";
        }

        doc.defaultView.setTimeout(function() {
            (hl_div.parentNode || hl_div.ownerDocument).
                removeChild(hl_div);
        }, 500);
    };



    // ------------------
    // EVENT mode methods
    // ------------------
    CSRecorder.prototype.escapeIdForSelector = function(id) {
        // HTML5 lessen restrictions on possible id values,
        // Based on the article http://mathiasbynens.be/notes/css-escapes

        // The following characters have a special meaning in CSS:
        id = id.replace(/([!"#$%&'()*+\.\/:;<=>?@\[\\\]^`{|}~])/g, '\\$1');
        // Escape leading digit character by its unicode value
        id = id.replace(/^(\d)/, '\\3$1 ');
        // The hyphen-minus character (-) only needs to be escaped if
        // it’s at the start of the identifier, and if it’s followed by
        // another hyphen-minus character or a digit from 0 to 9
        id = id.replace(/^-([0-9-])/, '\\-$1');
        // 3. Any characters matching [\t\n\v\f\r] need to be escaped based
        // on their Unicode code points.
        id = id.replace(/[\t\n\v\f\r]/g, function(s) {
            // TODO: not quite sure what syntax to use.
            // Now just as for digits: \x-xxxxx followed by single space
            return "\\"+s.charCodeAt(0).toString()+' ';
        });

        return id;
    };

    CSRecorder.prototype.getSelectorForElement = function(el) {
        // just walk up the tree until we find element with id or reach
        // HTML element
        var selector = "", temp = el;
        while (temp.parentNode) {
            if (temp.id && this.favorIds) {
                selector = "#"+
                    StrUtils.escapeLine(this.escapeIdForSelector(temp.id))+
                    (selector.length ? ">"+selector : "");
                return selector;
            }

            var siblings = temp.parentNode.childNodes, count = 0;
            for (var i = 0; i < siblings.length; i++) {
                if (siblings[i].nodeType != window.Node.ELEMENT_NODE)
                    continue;
                if (siblings[i] == temp)
                    break;
                if (siblings[i].tagName == temp.tagName)
                    count++;
            }

            if (count) {
                selector = temp.tagName+
                    ":nth-of-type("+(count+1)+")"+
                    (selector.length ? ">"+selector : "");
            } else {
                selector = temp.tagName+
                    (selector.length ? ">"+selector : "");
            }

            temp = temp.parentNode;
        }

        return selector;
    };

    CSRecorder.prototype.getModifiers = function(event) {
        var modifiers = [];
        if (event.ctrlKey)
            modifiers.push("ctrl");
        if (event.altKey)
            modifiers.push("alt");
        if (event.shiftKey)
            modifiers.push("shift");
        if (event.metaKey)
            modifiers.push("meta");

        return modifiers.join("|");
    };

    CSRecorder.prototype.onMouseDown = function(event) {
        if (!event.isTrusted)
            return;
        var selector = this.getSelectorForElement(event.target);
        if (event.button == 0) {
            // we may be interested now to listen to mousemove
            window.addEventListener("mousemove", this.onMouseMoveEvent, false);
        }
        var modifiers = this.getModifiers(event);
        this.saveAction(
            "EVENT TYPE=MOUSEDOWN SELECTOR=\""+selector+"\""+
                " BUTTON="+event.button+
                (modifiers.length ? " MODIFIERS=\""+modifiers+"\"" : "")
        );
    };


    CSRecorder.prototype.onMouseUp = function(event) {
        if (!event.isTrusted)
            return;
        if (event.button == 0) {
            window.removeEventListener("mousemove", this.onMouseMoveEvent, false);
        }
        var selector = this.getSelectorForElement(event.target);
        this.saveAction(
            "EVENT TYPE=MOUSEUP POINT=\"("+event.pageX+","+event.pageY+")\""
            // "EVENT TYPE=MOUSEUP SELECTOR=\""+selector+"\""
        );
    };

    CSRecorder.prototype.onMouseMove = function(event) {
        var selector = this.getSelectorForElement(event.target);
        var modifiers = this.getModifiers(event);
        this.saveAction(
            "EVENT TYPE=MOUSEMOVE SELECTOR=\""+selector+"\""+
                " POINT=\"("+event.pageX+","+event.pageY+")\""+
                (modifiers.length ? " MODIFIERS=\""+modifiers+"\"" : ""),
            {pack_type: "mousemove", selector: selector,
             point: {x: event.pageX, y: event.pageY},
             modifiers: modifiers}
        );
    };

    CSRecorder.prototype.onMouseClick = function(event) {
        if (!event.isTrusted)
            return;
        var selector = this.getSelectorForElement(event.target);
        var modifiers = this.getModifiers(event);
        this.saveAction(
            "EVENT TYPE=CLICK SELECTOR=\""+selector+"\""+
                " BUTTON="+event.button+
                (modifiers.length ? " MODIFIERS=\""+modifiers+"\"" : ""),
            {pack_type: "click", selector: selector}
        );
        //if (highlight)
        // this.highlightElement(event.target);
    };

    CSRecorder.prototype.onMouseDblClick = function(event) {
        if (!event.isTrusted)
            return;
        var selector = this.getSelectorForElement(event.target);
        var modifiers = this.getModifiers(event);
        this.saveAction(
            "EVENT TYPE=DBLCLICK SELECTOR=\""+selector+"\""+
                " BUTTON="+event.button+
                (modifiers.length ? " MODIFIERS=\""+modifiers+"\"" : ""),
            {pack_type: "dblclick", selector: selector}
        );
    };

    CSRecorder.prototype.onKeyDown2 = function(event) {
        if (!event.isTrusted)
            return;
        var selector = this.getSelectorForElement(event.target);
        var modifiers = this.getModifiers(event);
        var key = event.keyCode;
        
        this.saveAction(
            "EVENT TYPE=KEYDOWN SELECTOR=\""+selector+"\""+
                " KEY="+key+
                (modifiers.length ? " MODIFIERS=\""+modifiers+"\"" : "")
            ,
            {pack_type: "keydown", selector: selector,
             use_char: false, key: key,
             modifiers: modifiers}
        );
    };

    CSRecorder.prototype.onKeyUp2 = function(event) {
        if (!event.isTrusted)
            return;
        var selector = this.getSelectorForElement(event.target);
        var modifiers = this.getModifiers(event);
        var key = event.keyCode;
        
        this.saveAction(
            "EVENT TYPE=KEYUP SELECTOR=\""+selector+"\""+
                " KEY="+key+
                (modifiers.length ? " MODIFIERS=\""+modifiers+"\"" : "")
            ,
            {pack_type: "keyup", selector: selector,
             use_char: false, key: key,
             modifiers: modifiers}
        );
    };

    CSRecorder.prototype.onKeyPress2 = function(event) {
        if (!event.isTrusted)
            return;
        var selector = this.getSelectorForElement(event.target);
        var modifiers = this.getModifiers(event);
        var use_char = !!(event.which && event.charCode), char = "", key = 0;
        if (use_char)
            char = String.fromCharCode(event.which);
        else
            key = event.keyCode;
        
        var is_encryptable = event.target.type == "password" && use_char;
        this.saveAction(
            "EVENT TYPE=KEYPRESS SELECTOR=\""+selector+"\""+
                (use_char? " CHAR=\""+StrUtils.escapeLine(char)+"\"" :
                 (" KEY="+key+
                  (modifiers.length ? " MODIFIERS=\""+modifiers+"\"" : "")
                 )
                ),
            {pack_type: "keypress", selector: selector,
             encrypt: is_encryptable,
             use_char: use_char, char: char, key: key,
             modifiers: modifiers}
        );
        // if (highlight)
        // this.highlightElement(event.target);
    };

    CSRecorder.prototype.onFocusIn = function(event) {
        if (event.target.tagName &&
            event.target.tagName.toLowerCase() == "input" &&
            event.target.type.toLowerCase() == "password") {
            // special-case
            connector.postMessage("password-element-focused", {})
        }
    }

    CSRecorder.prototype.onChange2 = function(event) {
        // hack for selectbox recoding in event mode
        // While multiple selection select boxes pass through events just fine
        // the single-selection select boxes do not follow standard event flow
        if (event.target.tagName &&
            event.target.tagName.toLowerCase() == "select" &&
            !event.target.multiple) {
            let options = event.target.children
            for(let i = 0; i < options.length; i++) {
                if(options[i].selected) {
                    let selector = this.getSelectorForElement(options[i])
                    this.saveAction(
                        "EVENT TYPE=CLICK SELECTOR=\""+selector+"\"",
                        {pack_type: "select", selector: selector}
                    )
                    return
                }
            }
        }
    }

    var recorder = new CSRecorder();

})();



======================================================================
FILE PATH: content_scripts\si_listener.js
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/


var SIListener = {
    restartSIServer: function(pipe) {
        console.info("sending restart-server request, pipe="+pipe);
            
        this.restartTimeout =
            setTimeout(function() {SIListener.restartSIServer(pipe)}, 200);
        chrome.extension.sendRequest(
            {command: "restart-server", pipe: pipe},
            function(response) {
                // ensure that bg has received the request
                if(response.status == "OK") 
                    clearTimeout(SIListener.restartTimeout);

            }
        );
    }
};


window.addEventListener("load", function () {
    if (window.top != self)
        return;

    if (window.location.protocol == "file:") {
        if (/^\?pipe=(.+)$/.test(window.location.search)) { 
	    SIListener.restartSIServer(RegExp.$1);
        }
        // var meta = document.getElementById("pipe");
        // if (meta && meta.name == "pipe") {
        //     SIListener.restartSIServer(meta.content);
        // }
    }

}, true);





======================================================================
FILE PATH: editor\editarea\edit_area\langs\bg.js
======================================================================
/*
 *	Bulgarian translation
 *	Author:		Valentin Hristov
 *	Company:	SOFTKIT Bulgarian
 *	Site:		http://www.softkit-bg.com
 */
editAreaLoader.lang["bg"]={
new_document: "нов документ",
search_button: "търсене и замяна",
search_command: "търси следващия / отвори прозорец с търсачка",
search: "търсене",
replace: "замяна",
replace_command: "замяна / отвори прозорец с търсачка",
find_next: "намери следващия",
replace_all: "замени всички",
reg_exp: "реголярни изрази",
match_case: "чуствителен към регистъра",
not_found: "няма резултат.",
occurrence_replaced: "замяната е осъществена.",
search_field_empty: "Полето за търсене е празно",
restart_search_at_begin: "До края на документа. Почни с началото.",
move_popup: "премести прозореца с търсачката",
font_size: "--Размер на шрифта--",
go_to_line: "премени към реда",
go_to_line_prompt: "премени към номера на реда:",
undo: "отмени",
redo: "върни",
change_smooth_selection: "включи/изключи някой от функциите за преглед (по красиво, но повече натоварва)",
highlight: "превключване на оцветяване на синтаксиса включена/изключена",
reset_highlight: "въстанови оцветяване на синтаксиса (ако не е синхронизиран с текста)",
word_wrap: "режим на пренасяне на дълги редове",
help: "за програмата",
save: "съхрани",
load: "зареди",
line_abbr: "Стр",
char_abbr: "Стлб",
position: "Позиция",
total: "Всичко",
close_popup: "затвори прозореца",
shortcuts: "Бързи клавиши",
add_tab: "добави табулация в текста",
remove_tab: "премахни табулацията в текста",
about_notice: "Внимание: използвайте функцията оцветяване на синтаксиса само за малки текстове",
toggle: "Превключи редактор",
accesskey: "Бърз клавиш",
tab: "Tab",
shift: "Shift",
ctrl: "Ctrl",
esc: "Esc",
processing: "Зареждане...",
fullscreen: "на цял екран",
syntax_selection: "--Синтаксис--",
syntax_css: "CSS",
syntax_html: "HTML",
syntax_js: "Javascript",
syntax_php: "PHP",
syntax_python: "Python",
syntax_vb: "Visual Basic",
syntax_xml: "XML",
syntax_c: "C",
syntax_cpp: "C++",
syntax_basic: "Basic",
syntax_pas: "Pascal",
syntax_brainfuck: "Brainfuck",
syntax_sql: "SQL",
syntax_ruby: "Ruby",
syntax_robotstxt: "Robots txt",
syntax_tsql: "T-SQL",
syntax_perl: "Perl",
syntax_coldfusion: "Coldfusion",
syntax_java: "Java",
syntax_imacro: "iMacros",
close_tab: "Затвори файла"
};



======================================================================
FILE PATH: editor\editarea\edit_area\langs\cs.js
======================================================================
editAreaLoader.lang["cs"]={
new_document: "Nový dokument",
search_button: "Najdi a nahraď",
search_command: "Hledej další / otevři vyhledávací pole",
search: "Hledej",
replace: "Nahraď",
replace_command: "Nahraď / otevři vyhledávací pole",
find_next: "Najdi další",
replace_all: "Nahraď vše",
reg_exp: "platné výrazy",
match_case: "vyhodnocené výrazy",
not_found: "nenalezené.",
occurrence_replaced: "výskyty nahrazené.",
search_field_empty: "Pole vyhledávání je prázdné",
restart_search_at_begin: "Dosažen konec souboru, začínám od začátku.",
move_popup: "Přesuň vyhledávací okno",
font_size: "--Velikost textu--",
go_to_line: "Přejdi na řádek",
go_to_line_prompt: "Přejdi na řádek:",
undo: "krok zpět",
redo: "znovu",
change_smooth_selection: "Povolit nebo zakázat některé ze zobrazených funkcí (účelnější zobrazení požaduje větší zatížení procesoru)",
highlight: "Zvýrazňování syntaxe zap./vyp.",
reset_highlight: "Obnovit zvýraznění (v případě nesrovnalostí)",
word_wrap: "toggle word wrapping mode",
help: "O programu",
save: "Uložit",
load: "Otevřít",
line_abbr: "Ř.",
char_abbr: "S.",
position: "Pozice",
total: "Celkem",
close_popup: "Zavřít okno",
shortcuts: "Zkratky",
add_tab: "Přidat tabulování textu",
remove_tab: "Odtsranit tabulování textu",
about_notice: "Upozornění! Funkce zvýrazňování textu je k dispozici pouze pro malý text",
toggle: "Přepnout editor",
accesskey: "Přístupová klávesa",
tab: "Záložka",
shift: "Shift",
ctrl: "Ctrl",
esc: "Esc",
processing: "Zpracovávám ...",
fullscreen: "Celá obrazovka",
syntax_selection: "--vyber zvýrazňovač--",
syntax_css: "CSS",
syntax_html: "HTML",
syntax_js: "Javascript",
syntax_php: "Php",
syntax_python: "Python",
syntax_vb: "Visual Basic",
syntax_xml: "Xml",
syntax_c: "C",
syntax_cpp: "CPP",
syntax_basic: "Basic",
syntax_pas: "Pascal",
syntax_brainfuck: "Brainfuck",
syntax_sql: "SQL",
syntax_ruby: "Ruby",
syntax_robotstxt: "Robots txt",
syntax_tsql: "T-SQL",
syntax_perl: "Perl",
syntax_coldfusion: "Coldfusion",
syntax_java: "Java",
syntax_imacro: "iMacros",
close_tab: "Close file"
};



======================================================================
FILE PATH: editor\editarea\edit_area\langs\de.js
======================================================================
editAreaLoader.lang["de"]={
new_document: "Neues Dokument",
search_button: "Suchen und Ersetzen",
search_command: "Weitersuchen / &ouml;ffne Suchfeld",
search: "Suchen",
replace: "Ersetzen",
replace_command: "Ersetzen / &ouml;ffne Suchfeld",
find_next: "Weitersuchen",
replace_all: "Ersetze alle Treffer",
reg_exp: "regul&auml;re Ausdr&uuml;cke",
match_case: "passt auf den Begriff<br />",
not_found: "Nicht gefunden.",
occurrence_replaced: "Die Vorkommen wurden ersetzt.",
search_field_empty: "Leeres Suchfeld",
restart_search_at_begin: "Ende des zu durchsuchenden Bereiches erreicht. Es wird die Suche von Anfang an fortgesetzt.", //find a shorter translation
move_popup: "Suchfenster bewegen",
font_size: "--Schriftgr&ouml;&szlig;e--",
go_to_line: "Gehe zu Zeile",
go_to_line_prompt: "Gehe zu Zeilennummmer:",
undo: "R&uuml;ckg&auml;ngig",
redo: "Wiederherstellen",
change_smooth_selection: "Aktiviere/Deaktiviere einige Features (weniger Bildschirmnutzung aber mehr CPU-Belastung)",
highlight: "Syntax Highlighting an- und ausschalten",
reset_highlight: "Highlighting zur&uuml;cksetzen (falls mit Text nicht konform)",
word_wrap: "Toggle word wrapping mode",
help: "Info",
save: "Speichern",
load: "&Ouml;ffnen",
line_abbr: "Ln",
char_abbr: "Ch",
position: "Position",
total: "Gesamt",
close_popup: "Popup schlie&szlig;en",
shortcuts: "Shortcuts",
add_tab: "Tab zum Text hinzuf&uuml;gen",
remove_tab: "Tab aus Text entfernen",
about_notice: "Bemerkung: Syntax Highlighting ist nur f&uuml;r kurze Texte",
toggle: "Editor an- und ausschalten",
accesskey: "Accesskey",
tab: "Tab",
shift: "Shift",
ctrl: "Ctrl",
esc: "Esc",
processing: "In Bearbeitung...",
fullscreen: "Full-Screen",
syntax_selection: "--Syntax--",
syntax_css: "CSS",
syntax_html: "HTML",
syntax_js: "Javascript",
syntax_php: "Php",
syntax_python: "Python",
syntax_vb: "Visual Basic",
syntax_xml: "Xml",
syntax_c: "C",
syntax_cpp: "CPP",
syntax_basic: "Basic",
syntax_pas: "Pascal",
syntax_brainfuck: "Brainfuck",
syntax_sql: "SQL",
syntax_ruby: "Ruby",
syntax_robotstxt: "Robots txt",
syntax_tsql: "T-SQL",
syntax_perl: "Perl",
syntax_coldfusion: "Coldfusion",
syntax_java: "Java",
syntax_imacro: "iMacros",
close_tab: "Close file"
};



======================================================================
FILE PATH: editor\editarea\edit_area\langs\dk.js
======================================================================
editAreaLoader.lang["dk"]={
new_document: "nyt tomt dokument",
search_button: "s&oslash;g og erstat",
search_command: "find n&aelig;ste / &aring;ben s&oslash;gefelt",
search: "s&oslash;g",
replace: "erstat",
replace_command: "erstat / &aring;ben s&oslash;gefelt",
find_next: "find n&aelig;ste",
replace_all: "erstat alle",
reg_exp: "regular expressions",
match_case: "forskel på store/sm&aring; bogstaver<br />",
not_found: "not found.",
occurrence_replaced: "occurences replaced.",
search_field_empty: "Search field empty",
restart_search_at_begin: "End of area reached. Restart at begin.",
move_popup: "flyt søgepopup",
font_size: "--Skriftstørrelse--",
go_to_line: "g&aring; til linie",
go_to_line_prompt: "gå til linienummer:",
undo: "fortryd",
redo: "gentag",
change_smooth_selection: "sl&aring; display funktioner til/fra (smartere display men mere CPU kr&aelig;vende)",
highlight: "sl&aring; syntax highlight til/fra",
reset_highlight: "nulstil highlight (hvis den er desynkroniseret fra teksten)",
word_wrap: "toggle word wrapping mode",
help: "om",
save: "gem",
load: "hent",
line_abbr: "Ln",
char_abbr: "Ch",
position: "Position",
total: "Total",
close_popup: "luk popup",
shortcuts: "Genveje",
add_tab: "tilf&oslash;j tabulation til tekst",
remove_tab: "fjern tabulation fra tekst",
about_notice: "Husk: syntax highlight funktionen b&oslash;r kun bruge til sm&aring; tekster",
toggle: "Sl&aring; editor til / fra",
accesskey: "Accesskey",
tab: "Tab",
shift: "Skift",
ctrl: "Ctrl",
esc: "Esc",
processing: "Processing...",
fullscreen: "fullscreen",
syntax_selection: "--Syntax--",
syntax_css: "CSS",
syntax_html: "HTML",
syntax_js: "Javascript",
syntax_php: "Php",
syntax_python: "Python",
syntax_vb: "Visual Basic",
syntax_xml: "Xml",
syntax_c: "C",
syntax_cpp: "CPP",
syntax_basic: "Basic",
syntax_pas: "Pascal",
syntax_brainfuck: "Brainfuck",
syntax_sql: "SQL",
syntax_ruby: "Ruby",
syntax_robotstxt: "Robots txt",
syntax_tsql: "T-SQL",
syntax_perl: "Perl",
syntax_coldfusion: "Coldfusion",
syntax_java: "Java",
syntax_imacro: "iMacros",
close_tab: "Close file"
};



======================================================================
FILE PATH: editor\editarea\edit_area\langs\en.js
======================================================================
editAreaLoader.lang["en"]={
new_document: "new empty document",
search_button: "search and replace",
search_command: "search next / open search area",
search: "search",
replace: "replace",
replace_command: "replace / open search area",
find_next: "find next",
replace_all: "replace all",
reg_exp: "regular expressions",
match_case: "match case",
not_found: "not found.",
occurrence_replaced: "occurences replaced.",
search_field_empty: "Search field empty",
restart_search_at_begin: "End of area reached. Restart at begin.",
move_popup: "move search popup",
font_size: "--Font size--",
go_to_line: "go to line",
go_to_line_prompt: "go to line number:",
undo: "undo",
redo: "redo",
change_smooth_selection: "enable/disable some display features (smarter display but more CPU charge)",
highlight: "toggle syntax highlight on/off",
reset_highlight: "reset highlight (if desyncronized from text)",
word_wrap: "toggle word wrapping mode",
help: "about",
save: "save",
load: "load",
line_abbr: "Ln",
char_abbr: "Ch",
position: "Position",
total: "Total",
close_popup: "close popup",
shortcuts: "Shortcuts",
add_tab: "add tabulation to text",
remove_tab: "remove tabulation to text",
about_notice: "Notice: syntax highlight function is only for small text",
toggle: "Toggle editor",
accesskey: "Accesskey",
tab: "Tab",
shift: "Shift",
ctrl: "Ctrl",
esc: "Esc",
processing: "Processing...",
fullscreen: "fullscreen",
syntax_selection: "--Syntax--",
syntax_css: "CSS",
syntax_html: "HTML",
syntax_js: "Javascript",
syntax_php: "Php",
syntax_python: "Python",
syntax_vb: "Visual Basic",
syntax_xml: "Xml",
syntax_c: "C",
syntax_cpp: "CPP",
syntax_basic: "Basic",
syntax_pas: "Pascal",
syntax_brainfuck: "Brainfuck",
syntax_sql: "SQL",
syntax_ruby: "Ruby",
syntax_robotstxt: "Robots txt",
syntax_tsql: "T-SQL",
syntax_perl: "Perl",
syntax_coldfusion: "Coldfusion",
syntax_java: "Java",
syntax_imacro: "iMacros",
close_tab: "Close file"
};



======================================================================
FILE PATH: editor\editarea\edit_area\langs\eo.js
======================================================================
editAreaLoader.lang["eo"]={
new_document: "nova dokumento (vakigas la enhavon)",
search_button: "ser&#265;i / anstata&#365;igi",
search_command: "pluser&#265;i / malfermi la ser&#265;o-fenestron",
search: "ser&#265;i",
replace: "anstata&#365;igi",
replace_command: "anstata&#365;igi / malfermi la ser&#265;o-fenestron",
find_next: "ser&#265;i",
replace_all: "anstata&#365;igi &#265;ion",
reg_exp: "regula esprimo",
match_case: "respekti la usklecon",
not_found: "ne trovita.",
occurrence_replaced: "anstata&#365;igoj plenumitaj.",
search_field_empty: "La kampo estas malplena.",
restart_search_at_begin: "Fino de teksto &#285;isrirata, &#265;u da&#365;rigi el la komenco?",
move_popup: "movi la ser&#265;o-fenestron",
font_size: "--Tipara grando--",
go_to_line: "iri al la linio",
go_to_line_prompt: "iri al la linio numero:",
undo: "rezigni",
redo: "refari",
change_smooth_selection: "ebligi/malebligi la funkcioj de vidigo (pli bona vidigo, sed pli da &#349;ar&#285;o de la &#265;eforgano)",
highlight: "ebligi/malebligi la sintaksan kolorigon",
reset_highlight: "repravalorizi la sintaksan kolorigon (se malsinkronigon de la teksto)",
word_wrap: "toggle word wrapping mode",
help: "pri",
save: "registri",
load: "&#349;ar&#285;i",
line_abbr: "Ln",
char_abbr: "Sg",
position: "Pozicio",
total: "Sumo",
close_popup: "fermi la &#349;prucfenestron",
shortcuts: "Fulmoklavo",
add_tab: "aldoni tabon en la tekston",
remove_tab: "forigi tablon el la teksto",
about_notice: "Noto: la sintaksa kolorigo estas nur prikalkulita por mallongaj tekstoj.",
toggle: "baskuligi la redaktilon",
accesskey: "Fulmoklavo",
tab: "Tab",
shift: "Maj",
ctrl: "Ktrl",
esc: "Esk",
processing: "&#349;argante...",
fullscreen: "plenekrane",
syntax_selection: "--Sintakso--",
syntax_css: "CSS",
syntax_html: "HTML",
syntax_js: "Javascript",
syntax_php: "Php",
syntax_python: "Pitono",
syntax_vb: "Visual Basic",
syntax_xml: "Xml",
syntax_c: "C",
syntax_cpp: "CPP",
syntax_basic: "Basic",
syntax_pas: "Pascal",
syntax_brainfuck: "Brainfuck",
syntax_sql: "SQL",
syntax_ruby: "Ruby",
syntax_robotstxt: "Robots txt",
syntax_tsql: "T-SQL",
syntax_perl: "Perl",
syntax_coldfusion: "Coldfusion",
syntax_java: "Java",
syntax_imacro: "iMacros",
close_tab: "Fermi la dosieron"
};


======================================================================
FILE PATH: editor\editarea\edit_area\langs\es.js
======================================================================
editAreaLoader.lang["es"]={
new_document: "nuevo documento vacío",
search_button: "buscar y reemplazar",
search_command: "buscar siguiente / abrir área de búsqueda",
search: "buscar",
replace: "reemplazar",
replace_command: "reemplazar / abrir área de búsqueda",
find_next: "encontrar siguiente",
replace_all: "reemplazar todos",
reg_exp: "expresiones regulares",
match_case: "coincidir capitalización",
not_found: "no encontrado.",
occurrence_replaced: "ocurrencias reemplazadas.",
search_field_empty: "Campo de búsqueda vacío",
restart_search_at_begin: "Se ha llegado al final del área. Se va a seguir desde el principio.",
move_popup: "mover la ventana de búsqueda",
font_size: "--Tamaño de la fuente--",
go_to_line: "ir a la línea",
go_to_line_prompt: "ir a la línea número:",
undo: "deshacer",
redo: "rehacer",
change_smooth_selection: "activar/desactivar algunas características de visualización (visualización más inteligente pero más carga de CPU)",
highlight: "intercambiar resaltado de sintaxis",
reset_highlight: "reinicializar resaltado (si no esta sincronizado con el texto)",
word_wrap: "toggle word wrapping mode",
help: "acerca",
save: "guardar",
load: "cargar",
line_abbr: "Ln",
char_abbr: "Ch",
position: "Posición",
total: "Total",
close_popup: "recuadro de cierre",
shortcuts: "Atajos",
add_tab: "añadir tabulado al texto",
remove_tab: "borrar tabulado del texto",
about_notice: "Aviso: el resaltado de sintaxis sólo funciona para texto pequeño",
toggle: "Cambiar editor",
accesskey: "Tecla de acceso",
tab: "Tab",
shift: "Mayúsc",
ctrl: "Ctrl",
esc: "Esc",
processing: "Procesando...",
fullscreen: "pantalla completa",
syntax_selection: "--Syntax--",
syntax_css: "CSS",
syntax_html: "HTML",
syntax_js: "Javascript",
syntax_php: "Php",
syntax_python: "Python",
syntax_vb: "Visual Basic",
syntax_xml: "Xml",
syntax_c: "C",
syntax_cpp: "CPP",
syntax_basic: "Basic",
syntax_pas: "Pascal",
syntax_brainfuck: "Brainfuck",
syntax_sql: "SQL",
syntax_ruby: "Ruby",
syntax_coldfusion: "Coldfusion",
syntax_java: "Java",
syntax_imacro: "iMacros",
close_tab: "Close file"
};



======================================================================
FILE PATH: editor\editarea\edit_area\langs\fi.js
======================================================================
editAreaLoader.lang["fi"]={
new_document: "uusi tyhjä dokumentti",
search_button: "etsi ja korvaa",
search_command: "etsi seuraava / avaa etsintävalikko",
search: "etsi",
replace: "korvaa",
replace_command: "korvaa / avaa etsintävalikko",
find_next: "etsi seuraava",
replace_all: "korvaa kaikki",
reg_exp: "säännölliset lausekkeet",
match_case: "täsmää kirjainkokoon",
not_found: "ei löytynyt.",
occurrence_replaced: "esiintymää korvattu.",
search_field_empty: "Haettava merkkijono on tyhjä",
restart_search_at_begin: "Alueen loppu saavutettiin. Aloitetaan alusta.",
move_popup: "siirrä etsintävalikkoa",
font_size: "--Fontin koko--",
go_to_line: "siirry riville",
go_to_line_prompt: "mene riville:",
undo: "peruuta",
redo: "tee uudelleen",
change_smooth_selection: "kytke/sammuta joitakin näyttötoimintoja (Älykkäämpi toiminta, mutta suurempi CPU kuormitus)",
highlight: "kytke syntaksikorostus päälle/pois",
reset_highlight: "resetoi syntaksikorostus (jos teksti ei ole synkassa korostuksen kanssa)",
word_wrap: "toggle word wrapping mode",
help: "tietoja",
save: "tallenna",
load: "lataa",
line_abbr: "Rv",
char_abbr: "Pos",
position: "Paikka",
total: "Yhteensä",
close_popup: "sulje valikko",
shortcuts: "Pikatoiminnot",
add_tab: "lisää sisennys tekstiin",
remove_tab: "poista sisennys tekstistä",
about_notice: "Huomautus: syntaksinkorostus toimii vain pienelle tekstille",
toggle: "Kytke editori",
accesskey: "Pikanäppäin",
tab: "Tab",
shift: "Shift",
ctrl: "Ctrl",
esc: "Esc",
processing: "Odota...",
fullscreen: "koko ruutu",
syntax_selection: "--Syntaksi--",
syntax_css: "CSS",
syntax_html: "HTML",
syntax_js: "Javascript",
syntax_php: "Php",
syntax_python: "Python",
syntax_vb: "Visual Basic",
syntax_xml: "Xml",
syntax_c: "C",
syntax_cpp: "CPP",
syntax_basic: "Basic",
syntax_pas: "Pascal",
syntax_brainfuck: "Brainfuck",
syntax_sql: "SQL",
syntax_ruby: "Ruby",
syntax_robotstxt: "Robots txt",
syntax_tsql: "T-SQL",
syntax_perl: "Perl",
syntax_coldfusion: "Coldfusion",
syntax_java: "Java",
syntax_imacro: "iMacros",
close_tab: "Sulje tiedosto"
};


======================================================================
FILE PATH: editor\editarea\edit_area\langs\fr.js
======================================================================
editAreaLoader.lang["fr"]={
new_document: "nouveau document (efface le contenu)",
search_button: "rechercher / remplacer",
search_command: "rechercher suivant / ouvrir la fen&ecirc;tre de recherche",
search: "rechercher",
replace: "remplacer",
replace_command: "remplacer / ouvrir la fen&ecirc;tre de recherche",
find_next: "rechercher",
replace_all: "tout remplacer",
reg_exp: "expr. r&eacute;guli&egrave;re",
match_case: "respecter la casse",
not_found: "pas trouv&eacute;.",
occurrence_replaced: "remplacements &eacute;ffectu&eacute;s.",
search_field_empty: "Le champ de recherche est vide.",
restart_search_at_begin: "Fin du texte atteint, poursuite au d&eacute;but.",
move_popup: "d&eacute;placer la fen&ecirc;tre de recherche",
font_size: "--Taille police--",
go_to_line: "aller &agrave; la ligne",
go_to_line_prompt: "aller a la ligne numero:",
undo: "annuler",
redo: "refaire",
change_smooth_selection: "activer/d&eacute;sactiver des fonctions d'affichage (meilleur affichage mais plus de charge processeur)",
highlight: "activer/d&eacute;sactiver la coloration syntaxique",
reset_highlight: "r&eacute;initialiser la coloration syntaxique (si d&eacute;syncronis&eacute;e du texte)",
word_wrap: "activer/d&eacute;sactiver les retours &agrave; la ligne automatiques",
help: "&agrave; propos",
save: "sauvegarder",
load: "charger",
line_abbr: "Ln",
char_abbr: "Ch",
position: "Position",
total: "Total",
close_popup: "fermer le popup",
shortcuts: "Racourcis clavier",
add_tab: "ajouter une tabulation dans le texte",
remove_tab: "retirer une tabulation dans le texte",
about_notice: "Note: la coloration syntaxique n'est pr&eacute;vue que pour de courts textes.",
toggle: "basculer l'&eacute;diteur",
accesskey: "Accesskey",
tab: "Tab",
shift: "Maj",
ctrl: "Ctrl",
esc: "Esc",
processing: "chargement...",
fullscreen: "plein &eacute;cran",
syntax_selection: "--Syntaxe--",
syntax_css: "CSS",
syntax_html: "HTML",
syntax_js: "Javascript",
syntax_php: "Php",
syntax_python: "Python",
syntax_vb: "Visual Basic",
syntax_xml: "Xml",
syntax_c: "C",
syntax_cpp: "CPP",
syntax_basic: "Basic",
syntax_pas: "Pascal",
syntax_brainfuck: "Brainfuck",
syntax_sql: "SQL",
syntax_ruby: "Ruby",
syntax_robotstxt: "Robots txt",
syntax_tsql: "T-SQL",
syntax_perl: "Perl",
syntax_coldfusion: "Coldfusion",
syntax_java: "Java",
syntax_imacro: "iMacros",
close_tab: "Fermer le fichier"
};



======================================================================
FILE PATH: editor\editarea\edit_area\langs\hr.js
======================================================================
editAreaLoader.lang["hr"]={
new_document: "Novi dokument",
search_button: "Traži i izmijeni",
search_command: "Traži dalje / Otvori prozor za traženje",
search: "Traži",
replace: "Izmijeni",
replace_command: "Izmijeni / Otvori prozor za traženje",
find_next: "Traži dalje",
replace_all: "Izmjeni sve",
reg_exp: "Regularni izrazi",
match_case: "Bitna vel. slova",
not_found: "nije naðeno.",
occurrence_replaced: "izmjenjenih.",
search_field_empty: "Prazno polje za traženje!",
restart_search_at_begin: "Došao do kraja. Poèeo od poèetka.",
move_popup: "Pomakni prozor",
font_size: "--Velièina teksta--",
go_to_line: "Odi na redak",
go_to_line_prompt: "Odi na redak:",
undo: "Vrati natrag",
redo: "Napravi ponovo",
change_smooth_selection: "Ukljuèi/iskljuèi neke moguænosti prikaza (pametniji prikaz, ali zagušeniji CPU)",
highlight: "Ukljuèi/iskljuèi bojanje sintakse",
reset_highlight: "Ponovi kolorizaciju (ako je nesinkronizirana s tekstom)",
word_wrap: "toggle word wrapping mode",
help: "O edit_area",
save: "Spremi",
load: "Uèitaj",
line_abbr: "Ln",
char_abbr: "Zn",
position: "Pozicija",
total: "Ukupno",
close_popup: "Zatvori prozor",
shortcuts: "Kratice",
add_tab: "Dodaj tabulaciju",
remove_tab: "Makni tabulaciju",
about_notice: "Napomena: koloriziranje sintakse je samo za kratke kodove",
toggle: "Prebaci naèin ureðivanja",
accesskey: "Accesskey",
tab: "Tab",
shift: "Shift",
ctrl: "Ctrl",
esc: "Esc",
processing: "Procesiram...",
fullscreen: "Cijeli prozor",
syntax_selection: "--Syntax--",
syntax_css: "CSS",
syntax_html: "HTML",
syntax_js: "Javascript",
syntax_php: "Php",
syntax_python: "Python",
syntax_vb: "Visual Basic",
syntax_xml: "Xml",
syntax_c: "C",
syntax_cpp: "CPP",
syntax_basic: "Basic",
syntax_pas: "Pascal",
syntax_brainfuck: "Brainfuck",
syntax_sql: "SQL",
syntax_ruby: "Ruby",
syntax_robotstxt: "Robots txt",
syntax_tsql: "T-SQL",
syntax_perl: "Perl",
syntax_coldfusion: "Coldfusion",
syntax_java: "Java",
syntax_imacro: "iMacros",
close_tab: "Close file"
};



======================================================================
FILE PATH: editor\editarea\edit_area\langs\it.js
======================================================================
editAreaLoader.lang["it"]={
new_document: "nuovo documento vuoto",
search_button: "cerca e sostituisci",
search_command: "trova successivo / apri finestra di ricerca",
search: "cerca",
replace: "sostituisci",
replace_command: "sostituisci / apri finestra di ricerca",
find_next: "trova successivo",
replace_all: "sostituisci tutti",
reg_exp: "espressioni regolari",
match_case: "confronta maiuscole/minuscole<br />",
not_found: "non trovato.",
occurrence_replaced: "occorrenze sostituite.",
search_field_empty: "Campo ricerca vuoto",
restart_search_at_begin: "Fine del testo raggiunta. Ricomincio dall'inizio.",
move_popup: "sposta popup di ricerca",
font_size: "-- Dimensione --",
go_to_line: "vai alla linea",
go_to_line_prompt: "vai alla linea numero:",
undo: "annulla",
redo: "ripeti",
change_smooth_selection: "abilita/disabilita alcune caratteristiche della visualizzazione",
highlight: "abilita/disabilita colorazione della sintassi",
reset_highlight: "aggiorna colorazione (se non sincronizzata)",
word_wrap: "toggle word wrapping mode",
help: "informazioni su...",
save: "salva",
load: "carica",
line_abbr: "Ln",
char_abbr: "Ch",
position: "Posizione",
total: "Totale",
close_popup: "chiudi popup",
shortcuts: "Scorciatoie",
add_tab: "aggiungi tabulazione",
remove_tab: "rimuovi tabulazione",
about_notice: "Avviso: la colorazione della sintassi vale solo con testo piccolo",
toggle: "Abilita/disabilita editor",
accesskey: "Accesskey",
tab: "Tab",
shift: "Shift",
ctrl: "Ctrl",
esc: "Esc",
processing: "In corso...",
fullscreen: "fullscreen",
syntax_selection: "--Syntax--",
syntax_css: "CSS",
syntax_html: "HTML",
syntax_js: "Javascript",
syntax_php: "Php",
syntax_python: "Python",
syntax_vb: "Visual Basic",
syntax_xml: "Xml",
syntax_c: "C",
syntax_cpp: "CPP",
syntax_basic: "Basic",
syntax_pas: "Pascal",
syntax_brainfuck: "Brainfuck",
syntax_sql: "SQL",
syntax_ruby: "Ruby",
syntax_robotstxt: "Robots txt",
syntax_tsql: "T-SQL",
syntax_perl: "Perl",
syntax_coldfusion: "Coldfusion",
syntax_java: "Java",
syntax_imacro: "iMacros",
close_tab: "Close file"
};



======================================================================
FILE PATH: editor\editarea\edit_area\langs\ja.js
======================================================================
editAreaLoader.lang["ja"]={
new_document: "新規作成",
search_button: "検索・置換",
search_command: "次を検索 / 検索窓を表示",
search: "検索",
replace: "置換",
replace_command: "置換 / 置換窓を表示",
find_next: "次を検索",
replace_all: "全置換",
reg_exp: "正規表現",
match_case: "大文字小文字の区別",
not_found: "見つかりません。",
occurrence_replaced: "置換しました。",
search_field_empty: "検索対象文字列が空です。",
restart_search_at_begin: "終端に達しました、始めに戻ります",
move_popup: "検索窓を移動",
font_size: "--フォントサイズ--",
go_to_line: "指定行へ移動",
go_to_line_prompt: "指定行へ移動します:",
undo: "元に戻す",
redo: "やり直し",
change_smooth_selection: "スムース表示の切り替え（CPUを使います）",
highlight: "構文強調表示の切り替え",
reset_highlight: "構文強調表示のリセット",
word_wrap: "toggle word wrapping mode",
help: "ヘルプを表示",
save: "保存",
load: "読み込み",
line_abbr: "行",
char_abbr: "文字",
position: "位置",
total: "合計",
close_popup: "ポップアップを閉じる",
shortcuts: "ショートカット",
add_tab: "タブを挿入する",
remove_tab: "タブを削除する",
about_notice: "注意：構文強調表示は短いテキストでしか有効に機能しません。",
toggle: "テキストエリアとeditAreaの切り替え",
accesskey: "アクセスキー",
tab: "Tab",
shift: "Shift",
ctrl: "Ctrl",
esc: "Esc",
processing: "処理中です...",
fullscreen: "fullscreen",
syntax_selection: "--Syntax--",
syntax_css: "CSS",
syntax_html: "HTML",
syntax_js: "Javascript",
syntax_php: "Php",
syntax_python: "Python",
syntax_vb: "Visual Basic",
syntax_xml: "Xml",
syntax_c: "C",
syntax_cpp: "CPP",
syntax_basic: "Basic",
syntax_pas: "Pascal",
syntax_brainfuck: "Brainfuck",
syntax_sql: "SQL",
syntax_ruby: "Ruby",
syntax_robotstxt: "Robots txt",
syntax_tsql: "T-SQL",
syntax_perl: "Perl",
syntax_coldfusion: "Coldfusion",
syntax_java: "Java",
syntax_imacro: "iMacros",
close_tab: "Close file"
};



======================================================================
FILE PATH: editor\editarea\edit_area\langs\mk.js
======================================================================
editAreaLoader.lang["mk"]={
new_document: "Нов документ",
search_button: "Најди и замени",
search_command: "Барај следно / Отвори нов прозорец за пребарување",
search: "Барај",
replace: "Замени",
replace_command: "Замени / Отвори прозорец за пребарување",
find_next: "најди следно",
replace_all: "Замени ги сите",
reg_exp: "Регуларни изрази",
match_case: "Битна е големината на буквите",
not_found: "не е пронајдено.",
occurrence_replaced: "замени.",
search_field_empty: "Полето за пребарување е празно",
restart_search_at_begin: "Крај на областа. Стартувај од почеток.",
move_popup: "Помести го прозорецот",
font_size: "--Големина на текстот--",
go_to_line: "Оди на линија",
go_to_line_prompt: "Оди на линија со број:",
undo: "Врати",
redo: "Повтори",
change_smooth_selection: "Вклучи/исклучи некои карактеристики за приказ (попаметен приказ, но поголемо оптеретување за процесорот)",
highlight: "Вклучи/исклучи осветлување на синтакса",
reset_highlight: "Ресетирај го осветлувањето на синтакса (доколку е десинхронизиранo со текстот)",
word_wrap: "toggle word wrapping mode",
help: "За",
save: "Зачувај",
load: "Вчитај",
line_abbr: "Лн",
char_abbr: "Зн",
position: "Позиција",
total: "Вкупно",
close_popup: "Затвори го прозорецот",
shortcuts: "Кратенки",
add_tab: "Додај табулација на текстот",
remove_tab: "Отстрани ја табулацијата",
about_notice: "Напомена: Осветлувањето на синтанса е само за краток текст",
toggle: "Смени начин на уредување",
accesskey: "Accesskey",
tab: "Tab",
shift: "Shift",
ctrl: "Ctrl",
esc: "Esc",
processing: "Обработувам...",
fullscreen: "Цел прозорец",
syntax_selection: "--Синтакса--",
syntax_css: "CSS",
syntax_html: "HTML",
syntax_js: "Javascript",
syntax_php: "Php",
syntax_python: "Python",
syntax_vb: "Visual Basic",
syntax_xml: "Xml",
syntax_c: "C",
syntax_cpp: "CPP",
syntax_basic: "Basic",
syntax_pas: "Pascal",
syntax_brainfuck: "Brainfuck",
syntax_sql: "SQL",
syntax_ruby: "Ruby",
syntax_robotstxt: "Robots txt",
syntax_tsql: "T-SQL",
syntax_perl: "Perl",
syntax_coldfusion: "Coldfusion",
syntax_java: "Java",
syntax_imacro: "iMacros",
close_tab: "Избери датотека"
};



======================================================================
FILE PATH: editor\editarea\edit_area\langs\nl.js
======================================================================
editAreaLoader.lang["nl"]={
new_document: "nieuw leeg document",
search_button: "zoek en vervang",
search_command: "zoek volgende / zoekscherm openen",
search: "zoek",
replace: "vervang",
replace_command: "vervang / zoekscherm openen",
find_next: "volgende vinden",
replace_all: "alles vervangen",
reg_exp: "reguliere expressies",
match_case: "hoofdletter gevoelig",
not_found: "niet gevonden.",
occurrence_replaced: "object vervangen.",
search_field_empty: "Zoek veld leeg",
restart_search_at_begin: "Niet meer instanties gevonden, begin opnieuw",
move_popup: "versleep zoek scherm",
font_size: "--Letter grootte--",
go_to_line: "Ga naar regel",
go_to_line_prompt: "Ga naar regel nummer:",
undo: "Ongedaan maken",
redo: "Opnieuw doen",
change_smooth_selection: "zet wat schermopties aan/uit (kan langzamer zijn)",
highlight: "zet syntax highlight aan/uit",
reset_highlight: "reset highlight (indien gedesynchronizeerd)",
word_wrap: "toggle word wrapping mode",
help: "informatie",
save: "opslaan",
load: "laden",
line_abbr: "Ln",
char_abbr: "Ch",
position: "Positie",
total: "Totaal",
close_popup: "Popup sluiten",
shortcuts: "Snelkoppelingen",
add_tab: "voeg tabs toe in tekst",
remove_tab: "verwijder tabs uit tekst",
about_notice: "Notitie: syntax highlight functie is alleen voor kleine tekst",
toggle: "geavanceerde bewerkingsopties",
accesskey: "Accessknop",
tab: "Tab",
shift: "Shift",
ctrl: "Ctrl",
esc: "Esc",
processing: "Verwerken...",
fullscreen: "fullscreen",
syntax_selection: "--Syntax--",
syntax_css: "CSS",
syntax_html: "HTML",
syntax_js: "Javascript",
syntax_php: "Php",
syntax_python: "Python",
syntax_vb: "Visual Basic",
syntax_xml: "Xml",
syntax_c: "C",
syntax_cpp: "CPP",
syntax_basic: "Basic",
syntax_pas: "Pascal",
syntax_brainfuck: "Brainfuck",
syntax_sql: "SQL",
syntax_ruby: "Ruby",
syntax_robotstxt: "Robots txt",
syntax_tsql: "T-SQL",
syntax_perl: "Perl",
syntax_coldfusion: "Coldfusion",
syntax_java: "Java",
syntax_imacro: "iMacros",
close_tab: "Close file"
};



======================================================================
FILE PATH: editor\editarea\edit_area\langs\pl.js
======================================================================
editAreaLoader.lang["pl"]={
new_document: "nowy dokument",
search_button: "znajdź i zamień",
search_command: "znajdź następny",
search: "znajdź",
replace: "zamień",
replace_command: "zamień",
find_next: "następny",
replace_all: "zamień wszystko",
reg_exp: "wyrażenie regularne",
match_case: "uwzględnij wielkość liter<br />",
not_found: "nie znaleziono.",
occurrence_replaced: "wystąpień zamieniono.",
search_field_empty: "Nie wprowadzono tekstu",
restart_search_at_begin: "Koniec dokumentu. Wyszukiwanie od początku.",
move_popup: "przesuń okienko wyszukiwania",
font_size: "Rozmiar",
go_to_line: "idź do linii",
go_to_line_prompt: "numer linii:",
undo: "cofnij",
redo: "przywróć",
change_smooth_selection: "włącz/wyłącz niektóre opcje wyglądu (zaawansowane opcje wyglądu obciążają procesor)",
highlight: "włącz/wyłącz podświetlanie składni",
reset_highlight: "odśwież podświetlanie składni (jeśli rozsynchronizowało się z tekstem)",
word_wrap: "toggle word wrapping mode",
help: "o programie",
save: "zapisz",
load: "otwórz",
line_abbr: "Ln",
char_abbr: "Zn",
position: "Pozycja",
total: "W sumie",
close_popup: "zamknij okienko",
shortcuts: "Skróty klawiaturowe",
add_tab: "dodaj wcięcie do zaznaczonego tekstu",
remove_tab: "usuń wcięcie",
about_notice: "Uwaga: podświetlanie składni nie jest zalecane dla długich tekstów",
toggle: "Włącz/wyłącz edytor",
accesskey: "Alt+",
tab: "Tab",
shift: "Shift",
ctrl: "Ctrl",
esc: "Esc",
processing: "Przetwarzanie...",
fullscreen: "fullscreen",
syntax_selection: "--Syntax--",
syntax_css: "CSS",
syntax_html: "HTML",
syntax_js: "Javascript",
syntax_php: "Php",
syntax_python: "Python",
syntax_vb: "Visual Basic",
syntax_xml: "Xml",
syntax_c: "C",
syntax_cpp: "CPP",
syntax_basic: "Basic",
syntax_pas: "Pascal",
syntax_brainfuck: "Brainfuck",
syntax_sql: "SQL",
syntax_ruby: "Ruby",
syntax_robotstxt: "Robots txt",
syntax_tsql: "T-SQL",
syntax_perl: "Perl",
syntax_coldfusion: "Coldfusion",
syntax_java: "Java",
syntax_imacro: "iMacros",
close_tab: "Close file"
};



======================================================================
FILE PATH: editor\editarea\edit_area\langs\pt.js
======================================================================
editAreaLoader.lang["pt"]={
new_document: "Novo documento",
search_button: "Localizar e substituir",
search_command: "Localizar próximo",
search: "Localizar",
replace: "Substituir",
replace_command: "Substituir",
find_next: "Localizar",
replace_all: "Subst. tudo",
reg_exp: "Expressões regulares",
match_case: "Diferenciar maiúsculas e minúsculas",
not_found: "Não encontrado.",
occurrence_replaced: "Ocorrências substituidas",
search_field_empty: "Campo localizar vazio.",
restart_search_at_begin: "Fim das ocorrências. Recomeçar do inicio.",
move_popup: "Mover janela",
font_size: "--Tamanho da fonte--",
go_to_line: "Ir para linha",
go_to_line_prompt: "Ir para a linha:",
undo: "Desfazer",
redo: "Refazer",
change_smooth_selection: "Opções visuais",
highlight: "Cores de sintaxe",
reset_highlight: "Resetar cores (se não sincronizado)",
word_wrap: "toggle word wrapping mode",
help: "Sobre",
save: "Salvar",
load: "Carregar",
line_abbr: "Ln",
char_abbr: "Ch",
position: "Posição",
total: "Total",
close_popup: "Fechar",
shortcuts: "Shortcuts",
add_tab: "Adicionar tabulação",
remove_tab: "Remover tabulação",
about_notice: "Atenção: Cores de sintaxe são indicados somente para textos pequenos",
toggle: "Exibir editor",
accesskey: "Accesskey",
tab: "Tab",
shift: "Shift",
ctrl: "Ctrl",
esc: "Esc",
processing: "Processando...",
fullscreen: "fullscreen",
syntax_selection: "--Syntax--",
syntax_css: "CSS",
syntax_html: "HTML",
syntax_js: "Javascript",
syntax_php: "Php",
syntax_python: "Python",
syntax_vb: "Visual Basic",
syntax_xml: "Xml",
syntax_c: "C",
syntax_cpp: "CPP",
syntax_basic: "Basic",
syntax_pas: "Pascal",
syntax_brainfuck: "Brainfuck",
syntax_sql: "SQL",
syntax_ruby: "Ruby",
syntax_robotstxt: "Robots txt",
syntax_tsql: "T-SQL",
syntax_perl: "Perl",
syntax_coldfusion: "Coldfusion",
syntax_java: "Java",
syntax_imacro: "iMacros",
close_tab: "Close file"
};



======================================================================
FILE PATH: editor\editarea\edit_area\langs\ru.js
======================================================================
editAreaLoader.lang["ru"]={
new_document: "новый пустой документ",
search_button: "поиск и замена",
search_command: "искать следующий / открыть панель поиска",
search: "поиск",
replace: "замена",
replace_command: "заменить / открыть панель поиска",
find_next: "найти следующее",
replace_all: "заменить все",
reg_exp: "регулярное выражение",
match_case: "учитывать регистр",
not_found: "не найдено.",
occurrence_replaced: "вхождение заменено.",
search_field_empty: "Поле поиска пустое",
restart_search_at_begin: "Достигнут конец документа. Начинаю с начала.",
move_popup: "переместить окно поиска",
font_size: "--Размер шрифта--",
go_to_line: "перейти к строке",
go_to_line_prompt: "перейти к строке номер:",
undo: "отменить",
redo: "вернуть",
change_smooth_selection: "включить/отключить некоторые функции просмотра (более красиво, но больше использует процессор)",
highlight: "переключить подсветку синтаксиса включена/выключена",
reset_highlight: "восстановить подсветку (если разсинхронизирована от текста)",
word_wrap: "toggle word wrapping mode",
help: "о программе",
save: "сохранить",
load: "загрузить",
line_abbr: "Стр",
char_abbr: "Стлб",
position: "Позиция",
total: "Всего",
close_popup: "закрыть всплывающее окно",
shortcuts: "Горячие клавиши",
add_tab: "добавить табуляцию в текст",
remove_tab: "убрать табуляцию из текста",
about_notice: "Внимание: функция подсветки синтаксиса только для небольших текстов",
toggle: "Переключить редактор",
accesskey: "Горячая клавиша",
tab: "Tab",
shift: "Shift",
ctrl: "Ctrl",
esc: "Esc",
processing: "Обработка...",
fullscreen: "полный экран",
syntax_selection: "--Синтакс--",
syntax_css: "CSS",
syntax_html: "HTML",
syntax_js: "Javascript",
syntax_php: "Php",
syntax_python: "Python",
syntax_vb: "Visual Basic",
syntax_xml: "Xml",
syntax_c: "C",
syntax_cpp: "CPP",
syntax_basic: "Basic",
syntax_pas: "Pascal",
syntax_brainfuck: "Brainfuck",
syntax_sql: "SQL",
syntax_ruby: "Ruby",
syntax_robotstxt: "Robots txt",
syntax_tsql: "T-SQL",
syntax_perl: "Perl",
syntax_coldfusion: "Coldfusion",
syntax_java: "Java",
syntax_imacro: "iMacros",
close_tab: "Закрыть файл"
};



======================================================================
FILE PATH: editor\editarea\edit_area\langs\sk.js
======================================================================
editAreaLoader.lang["sk"]={
new_document: "nový prázdy dokument",
search_button: "vyhľadaj a nahraď",
search_command: "hľadaj ďalsšie / otvor vyhľadávacie pole",
search: "hľadaj",
replace: "nahraď",
replace_command: "nahraď / otvor vyhľadávacie pole",
find_next: "nájdi ďalšie",
replace_all: "nahraď všetko",
reg_exp: "platné výrazy",
match_case: "zhodujúce sa výrazy",
not_found: "nenájdené.",
occurrence_replaced: "výskyty nahradené.",
search_field_empty: "Pole vyhľadávanie je prádzne",
restart_search_at_begin: "End of area reached. Restart at begin.",
move_popup: "presuň vyhľadávacie okno",
font_size: "--Veľkosť textu--",
go_to_line: "prejdi na riadok",
go_to_line_prompt: "prejdi na riadok:",
undo: "krok späť",
redo: "prepracovať",
change_smooth_selection: "povoliť/zamietnúť niektoré zo zobrazených funkcií (účelnejšie zobrazenie vyžaduje  väčšie zaťaženie procesora CPU)",
highlight: "prepnúť zvýrazňovanie syntaxe zap/vyp",
reset_highlight: "zrušiť zvýrazňovanie (ak je nesynchronizované s textom)",
word_wrap: "toggle word wrapping mode",
help: "o programe",
save: "uložiť",
load: "načítať",
line_abbr: "Ln",
char_abbr: "Ch",
position: "Pozícia",
total: "Spolu",
close_popup: "zavrieť okno",
shortcuts: "Skratky",
add_tab: "pridať tabulovanie textu",
remove_tab: "odstrániť tabulovanie textu",
about_notice: "Upozornenie: funkcia zvýrazňovania syntaxe je dostupná iba pre malý text",
toggle: "Prepnúť editor",
accesskey: "Accesskey",
tab: "Záložka",
shift: "Shift",
ctrl: "Ctrl",
esc: "Esc",
processing: "Spracúvam...",
fullscreen: "cel=a obrazovka",
syntax_selection: "--Vyber Syntax--",
syntax_css: "CSS",
syntax_html: "HTML",
syntax_js: "Javascript",
syntax_php: "Php",
syntax_python: "Python",
syntax_vb: "Visual Basic",
syntax_xml: "Xml",
syntax_c: "C",
syntax_cpp: "CPP",
syntax_basic: "Basic",
syntax_pas: "Pascal",
syntax_brainfuck: "Brainfuck",
syntax_sql: "SQL",
syntax_ruby: "Ruby",
syntax_robotstxt: "Robots txt",
syntax_tsql: "T-SQL",
syntax_perl: "Perl",
syntax_coldfusion: "Coldfusion",
syntax_java: "Java",
syntax_imacro: "iMacros",
close_tab: "Close file"
};



======================================================================
FILE PATH: editor\editarea\edit_area\langs\zh.js
======================================================================
editAreaLoader.lang["zh"]={
new_document: "新建空白文档",
search_button: "查找与替换",
search_command: "查找下一个 / 打开查找框",
search: "查找",
replace: "替换",
replace_command: "替换 / 打开查找框",
find_next: "查找下一个",
replace_all: "全部替换",
reg_exp: "正则表达式",
match_case: "匹配大小写",
not_found: "未找到.",
occurrence_replaced: "处被替换.",
search_field_empty: "查找框没有内容",
restart_search_at_begin: "已到到文档末尾. 从头重新查找.",
move_popup: "移动查找对话框",
font_size: "--字体大小--",
go_to_line: "转到行",
go_to_line_prompt: "转到行:",
undo: "恢复",
redo: "重做",
change_smooth_selection: "启用/禁止一些显示特性(更好看但更耗费资源)",
highlight: "启用/禁止语法高亮",
reset_highlight: "重置语法高亮(当文本显示不同步时)",
word_wrap: "toggle word wrapping mode",
help: "关于",
save: "保存",
load: "加载",
line_abbr: "行",
char_abbr: "字符",
position: "位置",
total: "总计",
close_popup: "关闭对话框",
shortcuts: "快捷键",
add_tab: "添加制表符(Tab)",
remove_tab: "移除制表符(Tab)",
about_notice: "注意：语法高亮功能仅用于较少内容的文本(文件内容太大会导致浏览器反应慢)",
toggle: "切换编辑器",
accesskey: "快捷键",
tab: "Tab",
shift: "Shift",
ctrl: "Ctrl",
esc: "Esc",
processing: "正在处理中...",
fullscreen: "全屏编辑",
syntax_selection: "--语法--",
syntax_css: "CSS",
syntax_html: "HTML",
syntax_js: "Javascript",
syntax_php: "Php",
syntax_python: "Python",
syntax_vb: "Visual Basic",
syntax_xml: "Xml",
syntax_c: "C",
syntax_cpp: "CPP",
syntax_basic: "Basic",
syntax_pas: "Pascal",
syntax_brainfuck: "Brainfuck",
syntax_sql: "SQL",
syntax_ruby: "Ruby",
syntax_robotstxt: "Robots txt",
syntax_tsql: "T-SQL",
syntax_perl: "Perl",
syntax_coldfusion: "Coldfusion",
syntax_java: "Java",
syntax_imacro: "iMacros",
close_tab: "关闭文件"
};



======================================================================
FILE PATH: editor\editarea\edit_area\reg_syntax\imacro.js
======================================================================
editAreaLoader.load_syntax["imacro"] = {
    COMMENT_SINGLE: {"1": "'"},
    COMMENT_MULTI: {},
    QUOTEMARKS: {"1": '"'},
    KEYWORD_CASE_SENSITIVE: false,
    KEYWORDS: {},
    OPERATORS: ["=", "&&", ":", "%", "$", "*"],
    DELIMITERS: ["{{", "}}"],
    REGEXPS: {
        command: {
            search: "(^\\s*)((?:add|back|clear|click|cmdline|disconnect|ds|extract|filedelete|filter|frame|imageclick|imagesearch|oncertificatedialog|ondialog|ondownload|onerrordialog|onlogin|onprint|onsecuritydialog|onwebpagedialog|pause|print|prompt|proxy|redial|refresh|saveas|set|size|stopwatch|tab|tag|url|version|wait|winclick|saveitem|eval|screenshot))(\\s*)",
            "class": "command",
            modifiers: "igm",
            execute: "before"
        },
        parameters: {
            search: "(\\s+)(x|y|content|name|type|status|t|pos|button|folder|file|wait|continue|user|password|id|form|attr|extract|goto|build|recorder|seconds|xpath|selector)(\\s*=)",
            "class": "parameters",
            modifiers: "ig",
            execute: "before"
        },
        atts: {
            search: "((?:=\\s*|&&))([-\\w]+:)((?:\"(?:[^\"\\\\]+|\\\\[0btnvfr\"\'\\\\])*\"|\\S*))",
            "class": "atts",
            modifiers: "ig",
            execute: "before"
        },
        builtin_vars: {
            search: "(\\s*)(!(?:var[0-9]|encryption|imagefilter|downloadpdf|useragent|loop|extract|extractadd|extract_test_popup|errorignore|filestopwatch|datasource(?:_line|_columns|_delimiter)?|col\\d+|timeout(?:_macro|_page|_step|_download)?|replayspeed|slow|medium|fast|singlestep|clipboard|file_profiler|stopwatchtime|urlcurrent|downloaded(?:_file_name|_size)|now\\:\\S+))(\\b)",
            "class": "builtin_vars",
            modifiers: "ig",
            execute: "before"
        },
        escape_sequence: {
            search: "()(\\<(?:br|lf|sp)\\>)()",
            "class": "escape_sequence",
            modifiers: "ig",
            execute: "before"
        },
        constants: {
            search: "(=|\\s+)(yes|no|ok|cancel|storedkey|tmpkey|slow|medium|fast|images|cpl|mht|htm|txt|extract|png|jpeg|close|closeallothers|open|new)(\\b)",
            "class": "constants",
            modifiers: "ig",
            execute: "before"
        }
    },
    STYLES : {
        COMMENTS: 'color: #008000;',
        QUOTESMARKS: 'color: #6381F8;',
        KEYWORDS: {},
        OPERATORS: 'color: #FF00FF;',
        DELIMITERS: 'color: #0038E1;',
        REGEXPS: {
            builtin_vars: 'color: #8000FF;',
            command: 'color: #0000FF;',
            parameters: 'color: #800000;',
            escape_sequence: 'color: #2B60FF;',
            constants : 'color: #EE0000;'
        }	
    }
};



======================================================================
FILE PATH: editor\editarea\edit_area\reg_syntax\js.js
======================================================================
editAreaLoader.load_syntax["js"] = {
	'COMMENT_SINGLE' : {1 : '//'}
	,'COMMENT_MULTI' : {'/*' : '*/'}
	,'QUOTEMARKS' : {1: "'", 2: '"'}
	,'KEYWORD_CASE_SENSITIVE' : false
	,'KEYWORDS' : {
		'statements' : [
			'as', 'break', 'case', 'catch', 'continue', 'decodeURI', 'delete', 'do',
			'else', 'encodeURI', 'eval', 'finally', 'for', 'if', 'in', 'is', 'item',
			'instanceof', 'return', 'switch', 'this', 'throw', 'try', 'typeof', 'void',
			'while', 'write', 'with'
		]
 		,'keywords' : [
			'class', 'const', 'default', 'debugger', 'export', 'extends', 'false',
			'function', 'import', 'namespace', 'new', 'null', 'package', 'private',
			'protected', 'public', 'super', 'true', 'use', 'var', 'window', 'document',		
			// the list below must be sorted and checked (if it is a keywords or a function and if it is not present twice
			'Link ', 'outerHeight ', 'Anchor', 'FileUpload', 
			'location', 'outerWidth', 'Select', 'Area', 'find', 'Location', 'Packages', 'self', 
			'arguments', 'locationbar', 'pageXoffset', 'Form', 
			'Math', 'pageYoffset', 'setTimeout', 'assign', 'Frame', 'menubar', 'parent', 'status', 
			'blur', 'frames', 'MimeType', 'parseFloat', 'statusbar', 'Boolean', 'Function', 'moveBy', 
			'parseInt', 'stop', 'Button', 'getClass', 'moveTo', 'Password', 'String', 'callee', 'Hidden', 
			'name', 'personalbar', 'Submit', 'caller', 'history', 'NaN', 'Plugin', 'sun', 'captureEvents', 
			'History', 'navigate', 'print', 'taint', 'Checkbox', 'home', 'navigator', 'prompt', 'Text', 
			'Image', 'Navigator', 'prototype', 'Textarea', 'clearTimeout', 'Infinity', 
			'netscape', 'Radio', 'toolbar', 'close', 'innerHeight', 'Number', 'ref', 'top', 'closed', 
			'innerWidth', 'Object', 'RegExp', 'toString', 'confirm', 'isFinite', 'onBlur', 'releaseEvents', 
			'unescape', 'constructor', 'isNan', 'onError', 'Reset', 'untaint', 'Date', 'java', 'onFocus', 
			'resizeBy', 'unwatch', 'defaultStatus', 'JavaArray', 'onLoad', 'resizeTo', 'valueOf', 'document', 
			'JavaClass', 'onUnload', 'routeEvent', 'watch', 'Document', 'JavaObject', 'open', 'scroll', 'window', 
			'Element', 'JavaPackage', 'opener', 'scrollbars', 'Window', 'escape', 'length', 'Option', 'scrollBy'			
		]
    	,'functions' : [
			// common functions for Window object
			'alert', 'Array', 'back', 'blur', 'clearInterval', 'close', 'confirm', 'eval ', 'focus', 'forward', 'home',
			'name', 'navigate', 'onblur', 'onerror', 'onfocus', 'onload', 'onmove',
			'onresize', 'onunload', 'open', 'print', 'prompt', 'scroll', 'scrollTo', 'setInterval', 'status',
			'stop' 
		]
	}
	,'OPERATORS' :[
		'+', '-', '/', '*', '=', '<', '>', '%', '!'
	]
	,'DELIMITERS' :[
		'(', ')', '[', ']', '{', '}'
	]
	,'STYLES' : {
		'COMMENTS': 'color: #AAAAAA;'
		,'QUOTESMARKS': 'color: #6381F8;'
		,'KEYWORDS' : {
			'statements' : 'color: #60CA00;'
			,'keywords' : 'color: #48BDDF;'
			,'functions' : 'color: #2B60FF;'
		}
		,'OPERATORS' : 'color: #FF00FF;'
		,'DELIMITERS' : 'color: #0038E1;'
				
	}
	,'AUTO_COMPLETION' :  {
		"default": {	// the name of this definition group. It's posisble to have different rules inside the same definition file
			"REGEXP": { "before_word": "[^a-zA-Z0-9_]|^"	// \\s|\\.|
						,"possible_words_letters": "[a-zA-Z0-9_]+"
						,"letter_after_word_must_match": "[^a-zA-Z0-9_]|$"
						,"prefix_separator": "\\."
					}
			,"CASE_SENSITIVE": true
			,"MAX_TEXT_LENGTH": 100		// the maximum length of the text being analyzed before the cursor position
			,"KEYWORDS": {
				'': [	// the prefix of thoses items
						/**
						 * 0 : the keyword the user is typing
						 * 1 : (optionnal) the string inserted in code ("{@}" being the new position of the cursor, "§" beeing the equivalent to the value the typed string indicated if the previous )
						 * 		If empty the keyword will be displayed
						 * 2 : (optionnal) the text that appear in the suggestion box (if empty, the string to insert will be displayed)
						 */
						 ['Array', '§()', '']
			    		,['alert', '§({@})', 'alert(String message)']
			    		,['document']
			    		,['window']
			    	]
		    	,'window' : [
			    		 ['location']
			    		,['document']
			    		,['scrollTo', 'scrollTo({@})', 'scrollTo(Int x,Int y)']
					]
		    	,'location' : [
			    		 ['href']
					]
			}
		}
	}
};



======================================================================
FILE PATH: editor\editarea\edit_area\autocompletion.js
======================================================================
/**
 * Autocompletion class
 * 
 * An auto completion box appear while you're writing. It's possible to force it to appear with Ctrl+Space short cut
 * 
 * Loaded as a plugin inside editArea (everything made here could have been made in the plugin directory)
 * But is definitly linked to syntax selection (no need to do 2 different files for color and auto complete for each syntax language)
 * and add a too important feature that many people would miss if included as a plugin
 * 
 * - init param: autocompletion_start
 * - Button name: "autocompletion"
 */  

var EditArea_autocompletion= {
    
    /**
     * Get called once this file is loaded (editArea still not initialized)
     *
     * @return nothing	 
     */	 	 	
    init: function(){	
	//	alert("test init: "+ this._someInternalFunction(2, 3));
	
	if(editArea.settings["autocompletion"])
	    this.enabled= true;
	else
	    this.enabled= false;
	this.current_word = false;
	this.shown = false;
	this.selectIndex = -1;
	this.forceDisplay = false;
	this.isInMiddleWord = false;
	this.autoSelectIfOneResult = false;
	this.delayBeforeDisplay	= 100;
	this.checkDelayTimer = false;
	this.curr_syntax_str = '';
	this.file_syntax_datas	= {};
    }
    /**
     * Returns the HTML code for a specific control string or false if this plugin doesn't have that control.
     * A control can be a button, select list or any other HTML item to present in the EditArea user interface.
     * Language variables such as {$lang_somekey} will also be replaced with contents from
     * the language packs.
     * 
     * @param {string} ctrl_name: the name of the control to add	  
     * @return HTML code for a specific control or false.
     * @type string	or boolean
     */	
    /*,get_control_html: function(ctrl_name){
      switch( ctrl_name ){
      case 'autocompletion':
      // Control id, button img, command
      return parent.editAreaLoader.get_button_html('autocompletion_but', 'autocompletion.gif', 'toggle_autocompletion', false, this.baseURL);
      break;
      }
      return false;
      }*/
    /**
     * Get called once EditArea is fully loaded and initialised
     *	 
     * @return nothing
     */	 	 	
    ,onload: function(){ 
	if(this.enabled) {
	    var icon= document.getElementById("autocompletion");
	    if(icon)
		editArea.switchClassSticky(icon, 'editAreaButtonSelected', true);
	}
	
	this.container	= document.createElement('div');
	this.container.id = "auto_completion_area";
	editArea.container.insertBefore( this.container, editArea.container.firstChild );
	
	// add event detection for hiding suggestion box
	parent.editAreaLoader.add_event( document, "click", function(){ editArea.plugins['autocompletion']._hide();} );
	parent.editAreaLoader.add_event( editArea.textarea, "blur", function(){ editArea.plugins['autocompletion']._hide();} );
	
    }
    
    /**
     * Is called each time the user touch a keyboard key.
     *	 
     * @param (event) e: the keydown event
     * @return true - pass to next handler in chain, false - stop chain execution
     * @type boolean	 
     */
    ,onkeydown: function(e){
	if(!this.enabled)
	    return true;
	
	if (EA_keys[e.keyCode])
	    letter=EA_keys[e.keyCode];
	else
	    letter=String.fromCharCode(e.keyCode);	
	// shown
	if( this._isShown() ) {	
	    // if escape, hide the box
	    if(letter=="Esc") {
		this._hide();
		return false;
	    }
	    // Enter
	    else if( letter=="Entrer") {
		var as	= this.container.getElementsByTagName('A');
		// select a suggested entry
		if( this.selectIndex >= 0 && this.selectIndex < as.length ) {
		    as[ this.selectIndex ].onmousedown();
		    return false
		}
		// simply add an enter in the code
		else {
		    this._hide();
		    return true;
		}
	    } else if( letter=="Tab" || letter=="Down") {
		this._selectNext();
		return false;
	    } else if( letter=="Up") {
		this._selectBefore();
		return false;
	    }
	}
	
	// show current suggestion list and do autoSelect if possible (no matter it's shown or hidden)
	if( letter=="Space" && CtrlPressed(e) ) {
	    //parent.console.log('SHOW SUGGEST');
	    this.forceDisplay = true;
	    this.autoSelectIfOneResult	= true;
	    this._checkLetter();
	    return false;
	}
	
	// wait a short period for check that the cursor isn't moving
	setTimeout(function() {
            editArea.plugins['autocompletion']._checkDelayAndCursorBeforeDisplay();
        },  editArea.check_line_selection_timer +5 );
	this.checkDelayTimer = false;
	return true;
    }	
    /**
     * Executes a specific command, this function handles plugin commands.
     *
     * @param {string} cmd: the name of the command being executed
     * @param {unknown} param: the parameter of the command	 
     * @return true - pass to next handler in chain, false - stop chain execution
     * @type boolean	
     */
    ,execCommand: function(cmd, param){
	switch( cmd ){
	case 'toggle_autocompletion':
	    var icon= document.getElementById("autocompletion");
	    if(!this.enabled) {
		if(icon != null){
		    editArea.restoreClass(icon);
		    editArea.switchClassSticky(icon, 'editAreaButtonSelected', true);
		}
		this.enabled= true;
	    } else {
		this.enabled= false;
		if(icon != null)
		    editArea.switchClassSticky(icon, 'editAreaButtonNormal', false);
	    }
	    return true;
	}
	return true;
    }
    ,_checkDelayAndCursorBeforeDisplay: function() {
	this.checkDelayTimer = setTimeout(function () {
            if(editArea.textarea.selectionStart == editArea.textarea.selectionStart)
                EditArea_autocompletion._checkLetter();
        },  EditArea_autocompletion.delayBeforeDisplay - editArea.check_line_selection_timer - 5 );
    }
    // hide the suggested box
    ,_hide: function() {
	this.container.style.display="none";
	this.selectIndex = -1;
	this.shown = false;
	this.forceDisplay = false;
	this.autoSelectIfOneResult = false;
    }
    // display the suggested box
    ,_show: function() {
	if( !this._isShown() ) {
	    this.container.style.display = "block";
	    this.selectIndex = -1;
	    this.shown = true;
	}
    }
    // is the suggested box displayed?
    ,_isShown: function() {
	return this.shown;
    }
    // setter and getter
    ,_isInMiddleWord: function( new_value ) {
	if( typeof( new_value ) == "undefined" )
	    return this.isInMiddleWord;
	else
	    this.isInMiddleWord	= new_value;
    }
    // select the next element in the suggested box
    ,_selectNext: function() {
	var as	= this.container.getElementsByTagName('A');
	
	// clean existing elements
	for( var i=0; i<as.length; i++ ) {
	    if( as[i].className )
		as[i].className	= as[i].className.replace(/ focus/g, '');
	}
	
	this.selectIndex++;
	this.selectIndex = ( this.selectIndex >= as.length || this.selectIndex < 0 ) ? 0 : this.selectIndex;
	as[ this.selectIndex ].className	+= " focus";
    }
    // select the previous element in the suggested box
    ,_selectBefore: function() {
	var as	= this.container.getElementsByTagName('A');
	
	// clean existing elements
	for( var i=0; i<as.length; i++ ) {
	    if( as[i].className )
		as[i].className	= as[ i ].className.replace(/ focus/g, '');
	}
	
	this.selectIndex--;
	
	this.selectIndex = ( this.selectIndex >= as.length || this.selectIndex < 0 ) ? as.length-1 : this.selectIndex;
	as[ this.selectIndex ].className += " focus";
    }

    ,_select: function( content ) {
	cursor_forced_position	= content.indexOf( '{@}' );
	content	= content.replace(/{@}/g, '' );
	editArea.getIESelection();
	
	// retrive the number of matching characters
	var start_index	= Math.max( 0, editArea.textarea.selectionEnd - content.length );
	
	line_string = editArea.textarea.value.substring( start_index, editArea.textarea.selectionEnd + 1);
	limit = line_string.length -1;
	nbMatch	= 0;
	for( i =0; i<limit ; i++ ) {
	    if( line_string.substring( limit - i - 1, limit ) == content.substring( 0, i + 1 ) )
		nbMatch = i + 1;
	}
	// if characters match, we should include them in the selection that will be replaced
	if( nbMatch > 0 )
	    parent.editAreaLoader.setSelectionRange(editArea.id, editArea.textarea.selectionStart - nbMatch , editArea.textarea.selectionEnd);
	
	parent.editAreaLoader.setSelectedText(editArea.id, content );
	range = parent.editAreaLoader.getSelectionRange(editArea.id);
	
	if( cursor_forced_position != -1 )
	    new_pos = range["end"] - ( content.length-cursor_forced_position );
	else
	    new_pos = range["end"];	
	parent.editAreaLoader.setSelectionRange(editArea.id, new_pos, new_pos);
	this._hide();
    }
    
    
    /**
     * Parse the AUTO_COMPLETION part of syntax definition files
     */
    ,_parseSyntaxAutoCompletionDatas: function() {
	//foreach syntax loaded
	for(var lang in parent.editAreaLoader.load_syntax) {
	    if(!parent.editAreaLoader.syntax[lang]['autocompletion'])	// init the regexp if not already initialized
	    {
		parent.editAreaLoader.syntax[lang]['autocompletion']= {};
		// the file has auto completion datas
		if(parent.editAreaLoader.load_syntax[lang]['AUTO_COMPLETION']) {
		    // parse them
		    for(var i in parent.editAreaLoader.load_syntax[lang]['AUTO_COMPLETION']) {
			datas = parent.editAreaLoader.load_syntax[lang]['AUTO_COMPLETION'][i];
			tmp = {};
			if(datas["CASE_SENSITIVE"]!="undefined" && datas["CASE_SENSITIVE"]==false)
			    tmp["modifiers"]="i";
			else
			    tmp["modifiers"]="";
			tmp["prefix_separator"]= datas["REGEXP"]["prefix_separator"];
			tmp["match_prefix_separator"]= new RegExp( datas["REGEXP"]["prefix_separator"] +"$", tmp["modifiers"]);
			tmp["match_word"]= new RegExp("(?:"+ datas["REGEXP"]["before_word"] +")("+ datas["REGEXP"]["possible_words_letters"] +")$", tmp["modifiers"]);
			tmp["match_next_letter"]= new RegExp("^("+ datas["REGEXP"]["letter_after_word_must_match"] +")$", tmp["modifiers"]);
			tmp["keywords"]= {};
			//console.log( datas["KEYWORDS"] );
			for( var prefix in datas["KEYWORDS"] ) {
			    tmp["keywords"][prefix]= {
				prefix: prefix,
				prefix_name: prefix,
				prefix_reg: new RegExp("(?:"+ parent.editAreaLoader.get_escaped_regexp( prefix ) +")(?:"+ tmp["prefix_separator"] +")$", tmp["modifiers"] ),
				datas: []
			    };
			    for( var j=0; j<datas["KEYWORDS"][prefix].length; j++ )
			    {
				tmp["keywords"][prefix]['datas'][j]= {
				    is_typing: datas["KEYWORDS"][prefix][j][0],
				    // if replace with is empty, replace with the is_typing value
				    replace_with: datas["KEYWORDS"][prefix][j][1] ? datas["KEYWORDS"][prefix][j][1].replace('�', datas["KEYWORDS"][prefix][j][0] ) : '',
				    comment: datas["KEYWORDS"][prefix][j][2] ? datas["KEYWORDS"][prefix][j][2] : '' 
				};
				
				// the replace with shouldn't be empty
				if( tmp["keywords"][prefix]['datas'][j]['replace_with'].length == 0 )
				    tmp["keywords"][prefix]['datas'][j]['replace_with'] = tmp["keywords"][prefix]['datas'][j]['is_typing'];
				
				// if the comment is empty, display the replace_with value
				if( tmp["keywords"][prefix]['datas'][j]['comment'].length == 0 )
				    tmp["keywords"][prefix]['datas'][j]['comment'] = tmp["keywords"][prefix]['datas'][j]['replace_with'].replace(/{@}/g, '' );
			    }
			    
			}
			tmp["max_text_length"]= datas["MAX_TEXT_LENGTH"];
			parent.editAreaLoader.syntax[lang]['autocompletion'][i]	= tmp;
		    }
		}
	    }
	}
    }
    
    ,_checkLetter: function() {
	// check that syntax hasn't changed
	if( this.curr_syntax_str != editArea.settings['syntax'] ) {
	    if( !parent.editAreaLoader.syntax[editArea.settings['syntax']]['autocompletion'] )
		this._parseSyntaxAutoCompletionDatas();
	    this.curr_syntax= parent.editAreaLoader.syntax[editArea.settings['syntax']]['autocompletion'];
	    this.curr_syntax_str = editArea.settings['syntax'];
	    //console.log( this.curr_syntax );
	}
	
	if( editArea.is_editable ) {
	    time=new Date;
	    t1= time.getTime();
	    editArea.getIESelection();
	    this.selectIndex	= -1;
	    start=editArea.textarea.selectionStart;
	    var str	= editArea.textarea.value;
	    var results= [];
	    
	    
	    for(var i in this.curr_syntax) {
		var last_chars	= str.substring(Math.max(0, start-this.curr_syntax[i]["max_text_length"]), start);
		var matchNextletter	= str.substring(start, start+1).match( this.curr_syntax[i]["match_next_letter"]);
		// if not writting in the middle of a word or if forcing display
		if( matchNextletter || this.forceDisplay )
		{
		    // check if the last chars match a separator
		    var match_prefix_separator = last_chars.match(this.curr_syntax[i]["match_prefix_separator"]);
		    
		    // check if it match a possible word
		    var match_word= last_chars.match(this.curr_syntax[i]["match_word"]);
		    
		    //console.log( match_word );
		    if( match_word )
		    {
			var begin_word= match_word[1];
			var match_curr_word= new RegExp("^"+ parent.editAreaLoader.get_escaped_regexp( begin_word ), this.curr_syntax[i]["modifiers"]);
			//console.log( match_curr_word );
			for(var prefix in this.curr_syntax[i]["keywords"])
			{
			    //	parent.console.log( this.curr_syntax[i]["keywords"][prefix] );
			    for(var j=0; j<this.curr_syntax[i]["keywords"][prefix]['datas'].length; j++)
			    {
				//		parent.console.log( this.curr_syntax[i]["keywords"][prefix]['datas'][j]['is_typing'] );
				// the key word match or force display 
				if( this.curr_syntax[i]["keywords"][prefix]['datas'][j]['is_typing'].match(match_curr_word) )
				{
				    //		parent.console.log('match');
				    hasMatch = false;
				    var before = last_chars.substr( 0, last_chars.length - begin_word.length );
				    
				    // no prefix to match => it's valid
				    if( !match_prefix_separator && this.curr_syntax[i]["keywords"][prefix]['prefix'].length == 0 )
				    {
					if( ! before.match( this.curr_syntax[i]["keywords"][prefix]['prefix_reg'] ) )
					    hasMatch = true;
				    }
				    // we still need to check the prefix if there is one
				    else if( this.curr_syntax[i]["keywords"][prefix]['prefix'].length > 0 )
				    {
					if( before.match( this.curr_syntax[i]["keywords"][prefix]['prefix_reg'] ) )
					    hasMatch = true;
				    }
				    
				    if( hasMatch )
					results[results.length]= [ this.curr_syntax[i]["keywords"][prefix], this.curr_syntax[i]["keywords"][prefix]['datas'][j] ];
				}	
			    }
			}
		    }
		    // it doesn't match any possible word but we want to display something
		    // we'll display to list of all available words
		    else if( this.forceDisplay || match_prefix_separator )
		    {
			for(var prefix in this.curr_syntax[i]["keywords"])
			{
			    for(var j=0; j<this.curr_syntax[i]["keywords"][prefix]['datas'].length; j++)
			    {
				hasMatch = false;
				// no prefix to match => it's valid
				if( !match_prefix_separator && this.curr_syntax[i]["keywords"][prefix]['prefix'].length == 0 )
				{
				    hasMatch	= true;
				}
				// we still need to check the prefix if there is one
				else if( match_prefix_separator && this.curr_syntax[i]["keywords"][prefix]['prefix'].length > 0 )
				{
				    var before = last_chars; //.substr( 0, last_chars.length );
				    if( before.match( this.curr_syntax[i]["keywords"][prefix]['prefix_reg'] ) )
					hasMatch = true;
				}	
				
				if( hasMatch )
				    results[results.length]= [ this.curr_syntax[i]["keywords"][prefix], this.curr_syntax[i]["keywords"][prefix]['datas'][j] ];	
			    }
			}
		    }
		}
	    }
	    
	    // there is only one result, and we can select it automatically
	    if( results.length == 1 && this.autoSelectIfOneResult )
	    {
		//	console.log( results );
		this._select( results[0][1]['replace_with'] );
	    }
	    else if( results.length == 0 )
	    {
		this._hide();
	    }
	    else
	    {
		// build the suggestion box content
		var lines=[];
		for(var i=0; i<results.length; i++)
		{
		    var line= "<li><a href=\"#\" class=\"entry\" onmousedown=\"EditArea_autocompletion._select('"+ results[i][1]['replace_with'].replace(new RegExp('"', "g"), "&quot;") +"');return false;\">"+ results[i][1]['comment'];
		    if(results[i][0]['prefix_name'].length>0)
			line+='<span class="prefix">'+ results[i][0]['prefix_name'] +'</span>';
		    line+='</a></li>';
		    lines[lines.length]=line;
		}
		// sort results
		this.container.innerHTML		= '<ul>'+ lines.sort().join('') +'</ul>';
		
		var cursor	= _$("cursor_pos");
		this.container.style.top		= ( cursor.cursor_top + editArea.lineHeight ) +"px";
		this.container.style.left		= ( cursor.cursor_left + 8 ) +"px";
		this._show();
	    }
	    
	    this.autoSelectIfOneResult = false;
	    time=new Date;
	    t2= time.getTime();
	    
	    //parent.console.log( begin_word +"\n"+ (t2-t1) +"\n"+ html );
	}
    }
};

// Load as a plugin
editArea.settings['plugins'][ editArea.settings['plugins'].length ] = 'autocompletion';
editArea.add_plugin('autocompletion', EditArea_autocompletion);


======================================================================
FILE PATH: editor\editarea\edit_area\edit_area.css
======================================================================
body, html{
	margin: 0; 
	padding: 0;
	height: 100%;
	border: none;
	overflow: hidden;
	background-color: #FFF;
}

body, html, table, form, textarea{
	font: 12px monospace, sans-serif;
}

#editor{
	border: solid #888 1px;
	overflow: hidden;
}

#result{
	z-index: 4; 
	overflow-x: auto;
	overflow-y: scroll;
	border-top: solid #888 1px;
	border-bottom: solid #888 1px;
	position: relative;
	clear: both;
}

#result.empty{
	overflow: hidden;
}

#container{
	overflow: hidden;
	border: solid blue 0;
	position: relative; 
	z-index: 10;
	padding: 0 5px 0 45px;
	/*padding-right: 5px;*/ 
}

#textarea{
	position: relative; 
	top: 0; 
	left: 0;
	margin: 0;
	padding: 0;
	width: 100%;
	height: 100%; 
	overflow: hidden;  
	z-index: 7; 
	border-width: 0;
	background-color: transparent;
	resize: none;
}

#textarea, #textarea:hover{
	outline: none;	/* safari outline fix */
}

#content_highlight{
	white-space: pre;
	margin: 0;
	padding: 0;
	position : absolute; 
	z-index: 4; 
	overflow: visible;
}


#selection_field, #selection_field_text{
	margin: 0; 
	background-color: #E1F2F9; 
	/*height: 1px;*/  
	position: absolute;
	z-index: 5;
	top: -100px;
	padding: 0;
	white-space: pre;
	overflow: hidden;
}

#selection_field.show_colors {
	z-index: 3;
	background-color:#EDF9FC;
	
}

#selection_field strong{
	font-weight:normal;
}

#selection_field.show_colors *, #selection_field_text * {
	visibility: hidden;
}

#selection_field_text{
	background-color:transparent;
}

#selection_field_text strong{
	font-weight:normal;
	background-color:#3399FE;
	color: #FFF;
	visibility:visible;
}

#container.word_wrap #content_highlight,
#container.word_wrap #selection_field,
#container.word_wrap #selection_field_text,
#container.word_wrap #test_font_size{
	white-space: pre-wrap;       /* css-3 */
	white-space: -moz-pre-wrap !important;  /* Mozilla, since 1999 */
	white-space: -pre-wrap;      /* Opera 4-6 */
	white-space: -o-pre-wrap;    /* Opera 7 */
	word-wrap: break-word;       /* Internet Explorer 5.5+ */
	width: 99%;
}

#line_number{
	position: absolute;
	overflow: hidden;
	border-right: solid black 1px;
	z-index:8;
	width: 38px;
	padding: 0 5px 0 0;
	margin: 0 0 0 -45px;
	text-align: right;
	color: #AAAAAA;
}

#test_font_size{
	padding: 0; 
	margin: 0; 
	visibility: hidden;
	position: absolute;
	white-space: pre;
}

pre{
	margin: 0;
	padding: 0;
}

.hidden{
	opacity: 0.2; 
	filter:alpha(opacity=20);
}

#result .edit_area_cursor{
	position: absolute; 
	z-index:6; 
	background-color: #FF6633;
	top: -100px;
	margin: 0;
}

#result .edit_area_selection_field .overline{
	background-color: #996600;
}


/* area popup */
.editarea_popup{
	border: solid 1px #888888;
	background-color: #ECE9D8; 
	width: 250px; 
	padding: 4px; 
	position: absolute;
	visibility: hidden; 
	z-index: 15;
	top: -500px;
}

.editarea_popup, .editarea_popup table{
	font-family: sans-serif;
	font-size: 10pt;
}

.editarea_popup img{
	border: 0;
}

.editarea_popup .close_popup{
	float: right; 
	line-height: 16px; 
	border: 0; 
	padding: 0;
}

.editarea_popup h1,.editarea_popup h2,.editarea_popup h3,.editarea_popup h4,.editarea_popup h5,.editarea_popup h6{
	margin: 0;
	padding: 0;
}

.editarea_popup .copyright{
	text-align: right;
}	

/* Area_search */
div#area_search_replace{
	/*width: 250px;*/
}

div#area_search_replace img{
	border: 0;
}

div#area_search_replace div.button{
	text-align: center;
	line-height: 1.7em;
}

div#area_search_replace .button a{
	cursor: pointer;
	border: solid 1px #888888;
	background-color: #DEDEDE;
	text-decoration: none;
	padding: 0 2px;
	color: #000000;	
	white-space: nowrap;
}

div#area_search_replace a:hover{	
	/*border: solid 1px #888888;*/
	background-color: #EDEDED;
}

div#area_search_replace  #move_area_search_replace{
	cursor: move; 
	border: solid 1px #888;
}

div#area_search_replace  #close_area_search_replace{
	text-align: right; 
	vertical-align: top; 
	white-space: nowrap;
}

div#area_search_replace  #area_search_msg{
	height: 18px; 
	overflow: hidden; 
	border-top: solid 1px #888; 
	margin-top: 3px;
}

/* area help */
#edit_area_help{
	width: 350px;
}

#edit_area_help div.close_popup{
	float: right;
}

/* area_toolbar */
.area_toolbar {
    /*font: 11px sans-serif;*/
    width: 100%;
    /*height: 21px; */
    margin: 0;
    padding: 0;
    background-color: #414042;/*#ECE9D8;*/
    text-align: center;
    color: ghostwhite; /**/
}

.area_toolbar, .area_toolbar table{
	font: 11px sans-serif;
}

.area_toolbar img{
	border: 0;
	vertical-align: middle;
}

.area_toolbar input{
	margin: 0;
	padding: 0;
}

.area_toolbar select{
    font-family: 'MS Sans Serif',sans-serif,Verdana,Arial;
    font-size: 7pt;
    font-weight: normal;
    margin: 2px 0 0 0 ;
    padding: 0;
    vertical-align: top;
    background-color: #F0F0EE;
}

table.statusbar{
	width: 100%;
}

.area_toolbar td.infos{
	text-align: center;
	width: 130px;
	border-right: solid 1px #888;
	border-width: 0 1px 0 0;
	padding: 0;
}

.area_toolbar td.total{
	text-align: right;
	width: 50px;
	padding: 0;
}

.area_toolbar td.resize{
	text-align: right;
}
/*
.area_toolbar span{
	line-height: 1px;
	padding: 0;
	margin: 0;
}*/

.area_toolbar span#resize_area{
	cursor: nw-resize;
	visibility: hidden;
}

/* toolbar buttons */
.editAreaButtonNormal, .editAreaButtonOver, .editAreaButtonDown, .editAreaSeparator, .editAreaSeparatorLine, .editAreaButtonDisabled, .editAreaButtonSelected {
	border: 0; margin: 0; padding: 0; background: transparent;
	margin-top: 0;
	margin-left: 1px;
	padding: 0;
}

.editAreaButtonNormal {
	border: 1px solid #ECE9D8 !important;
	cursor: pointer;
}

.editAreaButtonOver {
	border: 1px solid #0A246A !important;
	cursor: pointer;
	background-color: #B6BDD2;
}

.editAreaButtonDown {
	cursor: pointer;
	border: 1px solid #0A246A !important;
	background-color: #8592B5;
}

.editAreaButtonSelected {
	border: 1px solid #C0C0BB !important;
	cursor: pointer;
	background-color: #F4F2E8;
}

.editAreaButtonDisabled {
	filter:progid:DXImageTransform.Microsoft.Alpha(opacity=30);
	-moz-opacity:0.3;
	opacity: 0.3;
	border: 1px solid #F0F0EE !important;
	cursor: pointer;
}

.editAreaSeparatorLine {
	margin: 1px 2px;
	background-color: #C0C0BB;
	width: 2px;
	height: 18px;
}

/* waiting screen */
#processing {
    display: none;
    background-color: #ECE9D8;
    border: solid #888 1px;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 100;
    text-align: center;
}

#processing_text{
	position:absolute;
	left: 50%;
	top: 50%;
	width: 200px;
	height: 20px; 
	margin-left: -100px;
	margin-top: -10px;
	text-align: center;
}
/* end */


/**** tab browsing area ****/
#tab_browsing_area{
	display: none;
	background-color: #CCC9A8;
	border-top: 1px solid #888;
	text-align: left;
	margin: 0;
}

#tab_browsing_list {
	padding: 0; 
	margin: 0; 
	list-style-type: none;
	white-space: nowrap;
}
#tab_browsing_list li {
	float: left;
	margin: -1px;
}
#tab_browsing_list a {
	position: relative;
	display: block; 
	text-decoration: none; 
	float: left; 
	cursor: pointer;
	line-height:14px;
}

#tab_browsing_list a span {
	display: block; 
	color: #000; 
	background: #ECE9D8; 
	border:	1px solid #888; 
	border-width: 1px 1px 0; 
	text-align: center; 
	padding: 2px 2px 1px 4px; 
	position: relative;	/*IE 6 hack */
}

#tab_browsing_list a b {
	display: block; 
	border-bottom: 2px solid #617994;
}

#tab_browsing_list a .edited {
	display: none;
}

#tab_browsing_list a.edited .edited {
	display: inline;
}

#tab_browsing_list a img{
	margin-left: 7px;
}

#tab_browsing_list a.edited img{
	margin-left: 3px;
}

#tab_browsing_list a:hover span {
	background: #F4F2E8;
	border-color: #0A246A;
}

#tab_browsing_list .selected a span{
	background: #046380;
	color: #FFF;
}


#no_file_selected{
	height: 100%;
	width: 150%; /* Opera need more than 100% */
	background: #CCC;
	display: none;
	z-index: 20;
	position: absolute;
}


/*** Non-editable mode ***/
.non_editable #editor
{
	border-width: 0 1px;
}

.non_editable .area_toolbar
{
	display: none;
}

/*** Auto completion ***/
#auto_completion_area
{
	background:	#FFF;
	border:		solid 1px #888;
	position:	absolute;
	z-index:	15;
	width:	280px;
	height:	180px;
	overflow: auto;
	display:none;
}

#auto_completion_area a, #auto_completion_area a:visited
{
	display:	block;
	padding:	0 2px 1px;
	color:		#000;
	text-decoration:none;
}

#auto_completion_area a:hover, #auto_completion_area a:focus, #auto_completion_area a.focus
{
	background:	#D6E1FE;
	text-decoration:none;
}

#auto_completion_area ul
{
	margin:	0;
	padding: 0;
	list-style: none inside;
}
#auto_completion_area li
{
	padding:	0;
}
#auto_completion_area .prefix
{
	font-style: italic;
	padding: 0 3px;
}


======================================================================
FILE PATH: editor\editarea\edit_area\edit_area.js
======================================================================
/******
 *
 *	EditArea 
 * 	Developped by Christophe Dolivet
 *	Released under LGPL, Apache and BSD licenses (use the one you want)
 *
 ******/

function EditArea(){
    var t=this;
    t.error= false;	// to know if load is interrrupt
    
    t.inlinePopup= [{popup_id: "area_search_replace", icon_id: "search"},
		    {popup_id: "edit_area_help", icon_id: "help"}];
    t.plugins= {};
    
    t.line_number=0;
    
    parent.editAreaLoader.set_browser_infos(t); 	// navigator identification
    // fix IE8 detection as we run in IE7 emulate mode through X-UA <meta> tag
    if( t.isIE >= 8 )
	t.isIE	= 7;
    
    t.last_selection={};		
    t.last_text_to_highlight="";
    t.last_hightlighted_text= "";
    t.syntax_list= [];
    t.allready_used_syntax= {};
    t.check_line_selection_timer= 50;	// the timer delay for modification and/or selection change detection
    
    t.textareaFocused= false;
    t.highlight_selection_line= null;
    t.previous= [];
    t.next= [];
    t.last_undo="";
    t.files= {};
    t.filesIdAssoc= {};
    t.curr_file= '';
    //t.loaded= false;
    t.assocBracket={};
    t.revertAssocBracket= {};		
    // bracket selection init 
    t.assocBracket["("]=")";
    t.assocBracket["{"]="}";
    t.assocBracket["["]="]";		
    for(var index in t.assocBracket){
	t.revertAssocBracket[t.assocBracket[index]]=index;
    }
    t.is_editable= true;
    
    
    /*t.textarea="";	
      
      t.state="declare";
      t.code = []; // store highlight syntax for languagues*/
    // font datas
    t.lineHeight= 16;
    /*t.default_font_family= "monospace";
      t.default_font_size= 10;*/
    t.tab_nb_char= 8;	//nb of white spaces corresponding to a tabulation
    if(t.isOpera)
	t.tab_nb_char= 6;

    t.is_tabbing= false;
    
    t.fullscreen= {'isFull': false};
    
    t.isResizing=false;	// resize var
    
    // init with settings and ID (area_id is a global var defined by editAreaLoader on iframe creation
    t.id= area_id;
    t.settings= editAreas[t.id]["settings"];
    
    if((""+t.settings['replace_tab_by_spaces']).match(/^[0-9]+$/))
    {
	t.tab_nb_char= t.settings['replace_tab_by_spaces'];
	t.tabulation="";
	for(var i=0; i<t.tab_nb_char; i++)
	    t.tabulation+=" ";
    }else{
	t.tabulation="\t";
    }
    
    // retrieve the init parameter for syntax
    if(t.settings["syntax_selection_allow"] && t.settings["syntax_selection_allow"].length>0)
	t.syntax_list= t.settings["syntax_selection_allow"].replace(/ /g,"").split(",");
    
    if(t.settings['syntax'])
	t.allready_used_syntax[t.settings['syntax']]=true;
    
    
};
EditArea.prototype.init= function(){
    var t=this, a, s=t.settings;
    t.textarea			= _$("textarea");
    t.container			= _$("container");
    t.result			= _$("result");
    t.content_highlight	= _$("content_highlight");
    t.selection_field	= _$("selection_field");
    t.selection_field_text= _$("selection_field_text");
    t.processing_screen	= _$("processing");
    t.editor_area		= _$("editor");
    t.tab_browsing_area	= _$("tab_browsing_area");
    t.test_font_size	= _$("test_font_size");
    a = t.textarea;
    
    if(!s['is_editable'])
	t.set_editable(false);
    
    t.set_show_line_colors( s['show_line_colors'] );
    
    if(syntax_selec= _$("syntax_selection"))
    {
	// set up syntax selection lsit in the toolbar
	for(var i=0; i<t.syntax_list.length; i++) {
	    var syntax= t.syntax_list[i];
	    var option= document.createElement("option");
	    option.value= syntax;
	    if(syntax==s['syntax'])
		option.selected= "selected";
	    option.innerHTML= t.get_translation("syntax_" + syntax, "word");
	    syntax_selec.appendChild(option);
	}
    }
    
    // add plugins buttons in the toolbar
    spans= parent.getChildren(_$("toolbar_1"), "span", "", "", "all", -1);
    
    for(var i=0; i<spans.length; i++){
	
	id=spans[i].id.replace(/tmp_tool_(.*)/, "$1");
	if(id!= spans[i].id){
	    for(var j in t.plugins){
		if(typeof(t.plugins[j].get_control_html)=="function" ){
		    html=t.plugins[j].get_control_html(id);
		    if(html!=false){
			html= t.get_translation(html, "template");
			var new_span= document.createElement("span");
			new_span.innerHTML= html;				
			var father= spans[i].parentNode;
			spans[i].parentNode.replaceChild(new_span, spans[i]);	
			break; // exit the for loop					
		    }
		}
	    }
	}
    }
    
    // init datas
    //a.value	= 'a';//editAreas[t.id]["textarea"].value;
    
    if(s["debug"])
    {
	t.debug=parent.document.getElementById("edit_area_debug_"+t.id);
    }
    // init size		
    //this.update_size();
    
    if(_$("redo") != null)
	t.switchClassSticky(_$("redo"), 'editAreaButtonDisabled', true);
    
    // insert css rules for highlight mode		
    if(typeof(parent.editAreaLoader.syntax[s["syntax"]])!="undefined"){
	for(var i in parent.editAreaLoader.syntax){
	    if (typeof(parent.editAreaLoader.syntax[i]["styles"]) != "undefined"){
		t.add_style(parent.editAreaLoader.syntax[i]["styles"]);
	    }
	}
    }
    
    // init key events
    if(t.isOpera)
	_$("editor").onkeypress	= keyDown;
    else
	_$("editor").onkeydown	= keyDown;

    for(var i=0; i<t.inlinePopup.length; i++){
	if(t.isOpera)
	    _$(t.inlinePopup[i]["popup_id"]).onkeypress	= keyDown;
	else
	    _$(t.inlinePopup[i]["popup_id"]).onkeydown	= keyDown;
    }
    
    if(s["allow_resize"]=="both" || s["allow_resize"]=="x" || s["allow_resize"]=="y")
	t.allow_resize(true);
    
    parent.editAreaLoader.toggle(t.id, "on");
    //a.focus();
    // line selection init
    t.change_smooth_selection_mode(editArea.smooth_selection);
    // highlight
    t.execCommand("change_highlight", s["start_highlight"]);
    
    // get font size datas		
    t.set_font(editArea.settings["font_family"], editArea.settings["font_size"]);
    
    // set unselectable text
    children= parent.getChildren(document.body, "", "selec", "none", "all", -1);
    for(var i=0; i<children.length; i++){
	if(t.isIE)
	    children[i].unselectable = true; // IE
	else
	    children[i].onmousedown= function(){return false};
	/*	children[i].style.MozUserSelect = "none"; // Moz
		children[i].style.KhtmlUserSelect = "none";  // Konqueror/Safari*/
    }
    
    a.spellcheck= s["gecko_spellcheck"];
    
    /** Browser specific style fixes **/
    
    // fix rendering bug for highlighted lines beginning with no tabs
    if( t.isFirefox >= '3' ) {
	t.content_highlight.style.paddingLeft= "1px";
	t.selection_field.style.paddingLeft= "1px";
	t.selection_field_text.style.paddingLeft= "1px";
    }
    
    if(t.isIE && t.isIE < 8 ){
	a.style.marginTop= "-1px";
    }
    /*
      if(t.isOpera){
      t.editor_area.style.position= "absolute";
      }*/
    
    if( t.isSafari ){
	t.editor_area.style.position	= "absolute";
	a.style.marginLeft		="-3px";
	if( t.isSafari < 3.2 ) // Safari 3.0 (3.1?)
	    a.style.marginTop	="1px";
    }
    
    // si le textarea n'est pas grand, un click sous le textarea doit provoquer un focus sur le textarea
    parent.editAreaLoader.add_event(t.result, "click", function(e){ if((e.target || e.srcElement)==editArea.result) { editArea.area_select(editArea.textarea.value.length, 0);}  });
    
    if(s['is_multi_files']!=false)
	t.open_file({'id': t.curr_file, 'text': ''});
    
    t.set_word_wrap( s['word_wrap'] );
    
    setTimeout(function() {
        editArea.focus();
        editArea.manage_size();
        editArea.execCommand('EA_load');
    }, 10);		
    //start checkup routine
    t.check_undo();
    t.check_line_selection(true);
    t.scroll_to_view();
    
    for(var i in t.plugins){
	if(typeof(t.plugins[i].onload)=="function")
	    t.plugins[i].onload();
    }
    if(s['fullscreen']==true)
	t.toggle_full_screen(true);
    
    parent.editAreaLoader.add_event(window, "resize", editArea.update_size);
    parent.editAreaLoader.add_event(parent.window, "resize", editArea.update_size);
    parent.editAreaLoader.add_event(top.window, "resize", editArea.update_size);
    parent.editAreaLoader.add_event(window, "unload", function(){
	// in case where editAreaLoader have been already cleaned
	if( parent.editAreaLoader )
	{
	    parent.editAreaLoader.remove_event(parent.window, "resize", editArea.update_size);
	    parent.editAreaLoader.remove_event(top.window, "resize", editArea.update_size);
	}
	if(editAreas[editArea.id] && editAreas[editArea.id]["displayed"]){
	    editArea.execCommand("EA_unload");
	}
    });
    
    
    /*date= new Date();
      alert(date.getTime()- parent.editAreaLoader.start_time);*/
};



//called by the toggle_on
EditArea.prototype.update_size= function(){
    var d=document,pd=parent.document,height,width,popup,maxLeft,maxTop;
    
    if( typeof editAreas != 'undefined' && editAreas[editArea.id] && editAreas[editArea.id]["displayed"]==true){
	if(editArea.fullscreen['isFull']){	
	    pd.getElementById("frame_"+editArea.id).style.width		= pd.getElementsByTagName("html")[0].clientWidth + "px";
	    pd.getElementById("frame_"+editArea.id).style.height	= pd.getElementsByTagName("html")[0].clientHeight + "px";
	}
	
	if(editArea.tab_browsing_area.style.display=='block' && ( !editArea.isIE || editArea.isIE >= 8 ) )
	{
	    editArea.tab_browsing_area.style.height	= "0px";
	    editArea.tab_browsing_area.style.height	= (editArea.result.offsetTop - editArea.tab_browsing_area.offsetTop -1)+"px";
	}
	
	height	= d.body.offsetHeight - editArea.get_all_toolbar_height() - 4;
	editArea.result.style.height	= height +"px";
	
	width	= d.body.offsetWidth -2;
	editArea.result.style.width		= width+"px";
	//alert("result h: "+ height+" w: "+width+"\ntoolbar h: "+this.get_all_toolbar_height()+"\nbody_h: "+document.body.offsetHeight);
	
	// check that the popups don't get out of the screen
	for( i=0; i < editArea.inlinePopup.length; i++ )
	{
	    popup	= _$(editArea.inlinePopup[i]["popup_id"]);
	    maxLeft	= d.body.offsetWidth - popup.offsetWidth;
	    maxTop	= d.body.offsetHeight - popup.offsetHeight;
	    if( popup.offsetTop > maxTop )
		popup.style.top		= maxTop+"px";
	    if( popup.offsetLeft > maxLeft )
		popup.style.left	= maxLeft+"px";
	}
	
	editArea.manage_size( true );
	editArea.fixLinesHeight( editArea.textarea.value, 0,-1);
    }		
};


EditArea.prototype.manage_size= function(onlyOneTime){
    if(!editAreas[this.id])
	return false;
    
    if(editAreas[this.id]["displayed"]==true && this.textareaFocused)
    {
	var area_height,resized= false;
	
	//1) Manage display width
	//1.1) Calc the new width to use for display
	if( !this.settings['word_wrap'] )
	{
	    var area_width= this.textarea.scrollWidth;
	    area_height= this.textarea.scrollHeight;
	    // bug on old opera versions
	    if(this.isOpera && this.isOpera < 9.6 ){
		area_width=10000; 								
	    }
	    //1.2) the width is not the same, we must resize elements
	    if(this.textarea.previous_scrollWidth!=area_width)
	    {	
		this.container.style.width= area_width+"px";
		this.textarea.style.width= area_width+"px";
		this.content_highlight.style.width= area_width+"px";	
		this.textarea.previous_scrollWidth=area_width;
		resized=true;
	    }
	}
	// manage wrap width
	if( this.settings['word_wrap'] )
	{
	    newW=this.textarea.offsetWidth;
	    if( this.isFirefox || this.isIE )
		newW-=2;
	    if( this.isSafari )
		newW-=6;
	    this.content_highlight.style.width=this.selection_field_text.style.width=this.selection_field.style.width=this.test_font_size.style.width=newW+"px";
	}
	
	//2) Manage display height
	//2.1) Calc the new height to use for display
	if( this.isOpera || this.isFirefox || this.isSafari ) { 
	    area_height= this.getLinePosTop( this.last_selection["nb_line"] + 1 );
	} else {
	    area_height = this.textarea.scrollHeight;
	}	
	//2.2) the width is not the same, we must resize elements 
	if(this.textarea.previous_scrollHeight!=area_height)	
	{	
	    this.container.style.height= (area_height+2)+"px";
	    this.textarea.style.height= area_height+"px";
	    this.content_highlight.style.height= area_height+"px";	
	    this.textarea.previous_scrollHeight= area_height;
	    resized=true;
	}
	
	//3) if there is new lines, we add new line numbers in the line numeration area
	if(this.last_selection["nb_line"] >= this.line_number)
	{
	    var newLines= '', destDiv=_$("line_number"), start=this.line_number, end=this.last_selection["nb_line"]+100;
	    for( i = start+1; i < end; i++ )
	    {
		newLines+='<div id="line_'+ i +'">'+i+"</div>";
		this.line_number++;
	    }
	    destDiv.innerHTML= destDiv.innerHTML + newLines;
	    
	    this.fixLinesHeight( this.textarea.value, start, -1 );
	}
	
	//4) be sure the text is well displayed
	this.textarea.scrollTop="0px";
	this.textarea.scrollLeft="0px";
	if(resized==true){
	    this.scroll_to_view();
	}
    }
    
    if(!onlyOneTime)
	setTimeout(function() {
            editArea.manage_size();
        }, 100);
};

EditArea.prototype.execCommand= function(cmd, param){
    
    for(var i in this.plugins){
	if(typeof(this.plugins[i].execCommand)=="function"){
	    if(!this.plugins[i].execCommand(cmd, param))
		return;
	}
    }
    switch(cmd){
    case "save":
	if(this.settings["save_callback"].length>0)
	    parent[this.settings["save_callback"]](this.id, editArea.textarea.value);
	break;
    case "load":
	if(this.settings["load_callback"].length>0)
	    parent[this.settings["load_callback"]](this.id);
	break;
    case "onchange":
	if(this.settings["change_callback"].length>0)
	    parent[this.settings["change_callback"]](this.id);
	break;		
    case "EA_load":
	if(this.settings["EA_load_callback"].length>0)
	    parent[this.settings["EA_load_callback"]](this.id);
	break;
    case "EA_unload":
	if(this.settings["EA_unload_callback"].length>0)
	    parent[this.settings["EA_unload_callback"]](this.id);
	break;
    case "toggle_on":
	if(this.settings["EA_toggle_on_callback"].length>0)
	    parent[this.settings["EA_toggle_on_callback"]](this.id);
	break;
    case "toggle_off":
	if(this.settings["EA_toggle_off_callback"].length>0)
	    parent[this.settings["EA_toggle_off_callback"]](this.id);
	break;
    case "re_sync":
	if(!this.do_highlight)
	    break;
    case "file_switch_on":
	if(this.settings["EA_file_switch_on_callback"].length>0)
	    parent[this.settings["EA_file_switch_on_callback"]](param);
	break;
    case "file_switch_off":
	if(this.settings["EA_file_switch_off_callback"].length>0)
	    parent[this.settings["EA_file_switch_off_callback"]](param);
	break;
    case "file_close":
	if(this.settings["EA_file_close_callback"].length>0)
	    return parent[this.settings["EA_file_close_callback"]](param);
	break;
	
    default:
	if (typeof(editArea[cmd]) == "function") {
	    if(this.settings["debug"])
		editArea[cmd](param);
	    else
		try {
                    editArea[cmd](param);
                } catch(e) {};
	}
    }
};

EditArea.prototype.get_translation= function(word, mode){
    if(mode=="template")
	return parent.editAreaLoader.translate(word, this.settings["language"], mode);
    else
	return parent.editAreaLoader.get_word_translation(word, this.settings["language"]);
};

EditArea.prototype.add_plugin= function(plug_name, plug_obj){
    for(var i=0; i<this.settings["plugins"].length; i++){
	if(this.settings["plugins"][i]==plug_name){
	    this.plugins[plug_name]=plug_obj;
	    plug_obj.baseURL=parent.editAreaLoader.baseURL + "plugins/" + plug_name + "/";
	    if( typeof(plug_obj.init)=="function" )
		plug_obj.init();
	}
    }
};

EditArea.prototype.load_css= function(url){
    try{
	link = document.createElement("link");
	link.type = "text/css";
	link.rel= "stylesheet";
	link.media="all";
	link.href = url;
	head = document.getElementsByTagName("head");
	head[0].appendChild(link);
    }catch(e){
	document.write("<link href='"+ url +"' rel='stylesheet' type='text/css' />");
    }
};

EditArea.prototype.load_script= function(url){
    try{
	script = document.createElement("script");
	script.type = "text/javascript";
	script.src  = url;
	script.charset= "UTF-8";
	head = document.getElementsByTagName("head");
	head[0].appendChild(script);
    }catch(e){
	document.write("<script type='text/javascript' src='" + url + "' charset=\"UTF-8\"><"+"/script>");
    }
};

// add plugin translation to language translation array
EditArea.prototype.add_lang= function(language, values){
    if(!parent.editAreaLoader.lang[language])
	parent.editAreaLoader.lang[language]={};
    for(var i in values)
	parent.editAreaLoader.lang[language][i]= values[i];
};

// short cut for document.getElementById()
function _$(id){return document.getElementById( id );};

var editArea = new EditArea();	
parent.editAreaLoader.add_event(window, "load", init);

function init(){		
    setTimeout(function() {editArea.init(); }, 10);
};



======================================================================
FILE PATH: editor\editarea\edit_area\edit_area_functions.js
======================================================================
//replace tabulation by the good number of white spaces
EditArea.prototype.replace_tab = function(text) {
    return text.replace(/((\n?)([^\t\n]*)\t)/gi, editArea.smartTab);		// slower than simple replace...	
};

// call by the replace_tab function
EditArea.prototype.smartTab = function() {
    val="                   ";
    return EditArea.prototype.smartTab.arguments[2] +
        EditArea.prototype.smartTab.arguments[3] +
        val.substr(0, editArea.tab_nb_char - (EditArea.prototype.smartTab.arguments[3].length) % editArea.tab_nb_char);
};

EditArea.prototype.show_waiting_screen = function() {
    width = this.editor_area.offsetWidth;
    height = this.editor_area.offsetHeight;
    if( !(this.isIE && this.isIE<6) ) {
	width -= 2;
	height -= 2;
    }
    this.processing_screen.style.display = "block";
    this.processing_screen.style.width = width+"px";
    this.processing_screen.style.height	= height+"px";
    this.waiting_screen_displayed = true;
};

EditArea.prototype.hide_waiting_screen= function() {
    this.processing_screen.style.display = "none";
    this.waiting_screen_displayed = false;
};

EditArea.prototype.add_style = function(styles) {
    if(styles.length>0){
	newcss = document.createElement("style");
	newcss.type="text/css";
	newcss.media="all";
	if(newcss.styleSheet){ // IE
	    newcss.styleSheet.cssText = styles;
	} else { // W3C
	    newcss.appendChild(document.createTextNode(styles));
	}
	document.getElementsByTagName("head")[0].appendChild(newcss);
    }
};

EditArea.prototype.set_font = function(family, size) {
    var t=this, a=this.textarea, s=this.settings, elem_font, i, elem;
    // list all elements concerned by font changes
    var elems= ["textarea", "content_highlight", "cursor_pos", "end_bracket", "selection_field", "selection_field_text", "line_number"];
    
    if(family && family!="")
	s["font_family"]= family;
    if(size && size>0)
	s["font_size"]	= size;
    if( t.isOpera && t.isOpera < 9.6 )	// opera<9.6 can't manage non monospace font
	s['font_family']="monospace";
    
    // update the select tag
    if( elem_font = _$("area_font_size") ) {	
	for( i = 0; i < elem_font.length; i++ ) {
	    if( elem_font.options[i].value && elem_font.options[i].value == s["font_size"] )
		elem_font.options[i].selected=true;
	}
    }
    
    /*
     * somethimes firefox has rendering mistake with non-monospace font for text width in textarea vs in div for changing font size (eg: verdana change between 11pt to 12pt)
     * => looks like a browser internal random bug as text width can change while content_highlight is updated
     * we'll check if the font-size produce the same text width inside textarea and div and if not, we'll increment the font-size
     * 
     * This is an ugly fix 
     */ 
    if( t.isFirefox ) {
	var nbTry = 3;
	do {
	    var div1 = document.createElement( 'div' ), text1 = document.createElement( 'textarea' );
	    var styles = {
		width:		'40px',
		overflow:	'scroll',
		zIndex: 	50,
		visibility:	'hidden',
		fontFamily:	s["font_family"],
		fontSize:	s["font_size"]+"pt",
		lineHeight:	t.lineHeight+"px",
		padding:	'0',
		margin:		'0',
		border:		'none',
		whiteSpace:	'nowrap'
	    };
	    var diff, changed = false;
	    for( i in styles )
	    {
		div1.style[ i ]		= styles[i];
		text1.style[ i ]	= styles[i];
	    }
	    // no wrap for this text
	    text1.wrap = 'off';
	    text1.setAttribute('wrap', 'off');
	    t.container.appendChild( div1 );
	    t.container.appendChild( text1 );
	    // try to make FF to bug
	    div1.innerHTML 		= text1.value	= 'azertyuiopqsdfghjklm';
	    div1.innerHTML 		= text1.value	= text1.value+'wxcvbn^p*ù$!:;,,';
	    diff	=  text1.scrollWidth - div1.scrollWidth;
	    
	    // firefox return here a diff of 1 px between equals scrollWidth (can't explain)
	    if( Math.abs( diff ) >= 2 ) {
		s["font_size"]++;
		changed	= true;
	    }
	    t.container.removeChild( div1 );
	    t.container.removeChild( text1 );
	    nbTry--;
	} while( changed && nbTry > 0 );
    }
    
    
    // calc line height
    elem = t.test_font_size;
    elem.style.fontFamily = ""+s["font_family"];
    elem.style.fontSize = s["font_size"]+"pt";				
    elem.innerHTML = "0";		
    t.lineHeight = elem.offsetHeight;

    // update font for all concerned elements
    for( i=0; i<elems.length; i++) {
	elem	= _$(elems[i]);	
	elem.style.fontFamily	= s["font_family"];
	elem.style.fontSize = s["font_size"]+"pt";
	elem.style.lineHeight = t.lineHeight+"px";
    }
    // define a css for <pre> tags
    t.add_style("pre{font-family:"+s["font_family"]+"}");
    
    // old opera and IE>=8 doesn't update font changes to the textarea
    if( ( t.isOpera && t.isOpera < 9.6 ) || t.isIE >= 8 )
    {
	var parNod = a.parentNode, nxtSib = a.nextSibling, start= a.selectionStart, end= a.selectionEnd;
	parNod.removeChild(a);
	parNod.insertBefore(a, nxtSib);
	t.area_select(start, end-start);
    }
    
    // force update of selection field
    this.focus();
    this.update_size();
    this.check_line_selection();
};

EditArea.prototype.change_font_size= function(){
    var size=_$("area_font_size").value;
    if(size>0)
	this.set_font("", size);			
};


EditArea.prototype.open_inline_popup= function(popup_id){
    this.close_all_inline_popup();
    var popup= _$(popup_id);		
    var editor= _$("editor");
    
    // search matching icon
    for(var i=0; i<this.inlinePopup.length; i++){
	if(this.inlinePopup[i]["popup_id"]==popup_id){
	    var icon= _$(this.inlinePopup[i]["icon_id"]);
	    if(icon){
		this.switchClassSticky(icon, 'editAreaButtonSelected', true);			
		break;
	    }
	}
    }
    // check size
    popup.style.height="auto";
    popup.style.overflow= "visible";
    
    if(document.body.offsetHeight< popup.offsetHeight){
	popup.style.height= (document.body.offsetHeight-10)+"px";
	popup.style.overflow= "auto";
    }
    
    if(!popup.positionned){
	var new_left= editor.offsetWidth /2 - popup.offsetWidth /2;
	var new_top= editor.offsetHeight /2 - popup.offsetHeight /2;
	//var new_top= area.offsetHeight /2 - popup.offsetHeight /2;
	//var new_left= area.offsetWidth /2 - popup.offsetWidth /2;
	//alert("new_top: ("+new_top+") = calculeOffsetTop(area) ("+calculeOffsetTop(area)+") + area.offsetHeight /2("+ area.offsetHeight /2+") - popup.offsetHeight /2("+popup.offsetHeight /2+") - scrollTop: "+document.body.scrollTop);
	popup.style.left= new_left+"px";
	popup.style.top= new_top+"px";
	popup.positionned=true;
    }
    popup.style.visibility="visible";
    
    //popup.style.display="block";
};

EditArea.prototype.close_inline_popup= function(popup_id){
    var popup= _$(popup_id);		
    // search matching icon
    for(var i=0; i<this.inlinePopup.length; i++){
	if(this.inlinePopup[i]["popup_id"]==popup_id){
	    var icon= _$(this.inlinePopup[i]["icon_id"]);
	    if(icon){
		this.switchClassSticky(icon, 'editAreaButtonNormal', false);			
		break;
	    }
	}
    }
    
    popup.style.visibility="hidden";	
};

EditArea.prototype.close_all_inline_popup= function(e){
    for(var i=0; i<this.inlinePopup.length; i++){
	this.close_inline_popup(this.inlinePopup[i]["popup_id"]);		
    }
    this.textarea.focus();
};

EditArea.prototype.show_help= function(){
    
    this.open_inline_popup("edit_area_help");
    
};

EditArea.prototype.new_document= function(){
    this.textarea.value="";
    this.area_select(0,0);
};

EditArea.prototype.get_all_toolbar_height= function(){
    var area= _$("editor");
    var results= parent.getChildren(area, "div", "class", "area_toolbar", "all", "0");	// search only direct children
    //results= results.concat(getChildren(area, "table", "class", "area_toolbar", "all", "0"));
    var height=0;
    for(var i=0; i<results.length; i++){			
	height+= results[i].offsetHeight;
    }
    //alert("toolbar height: "+height);
    return height;
};

EditArea.prototype.go_to_line= function(line){	
    if(!line)
    {	
	var icon= _$("go_to_line");
	if(icon != null){
	    this.restoreClass(icon);
	    this.switchClassSticky(icon, 'editAreaButtonSelected', true);
	}
	
	line= prompt(this.get_translation("go_to_line_prompt"));
	if(icon != null)
	    this.switchClassSticky(icon, 'editAreaButtonNormal', false);
    }
    if(line && line!=null && line.search(/^[0-9]+$/)!=-1){
	var start=0;
	var lines= this.textarea.value.split("\n");
	if(line > lines.length)
	    start= this.textarea.value.length;
	else{
	    for(var i=0; i<Math.min(line-1, lines.length); i++)
		start+= lines[i].length + 1;
	}
	this.area_select(start, 0);
    }
    
    
};


EditArea.prototype.change_smooth_selection_mode= function(setTo){
    //alert("setTo: "+setTo);
    if(this.do_highlight)
	return;
    
    if(setTo != null){
	if(setTo === false)
	    this.smooth_selection=true;
	else
	    this.smooth_selection=false;
    }
    var icon= _$("change_smooth_selection");
    this.textarea.focus();
    if(this.smooth_selection===true){
	//setAttribute(icon, "class", getAttribute(icon, "class").replace(/ selected/g, "") );
	/*setAttribute(icon, "oldClassName", "editAreaButtonNormal" );
	  setAttribute(icon, "className", "editAreaButtonNormal" );*/
	//this.restoreClass(icon);
	//this.restoreAndSwitchClass(icon,'editAreaButtonNormal');
	this.switchClassSticky(icon, 'editAreaButtonNormal', false);
	
	this.smooth_selection=false;
	this.selection_field.style.display= "none";
	_$("cursor_pos").style.display= "none";
	_$("end_bracket").style.display= "none";
    }else{
	//setAttribute(icon, "class", getAttribute(icon, "class") + " selected");
	//this.switchClass(icon,'editAreaButtonSelected');
	this.switchClassSticky(icon, 'editAreaButtonSelected', false);
	this.smooth_selection=true;
	this.selection_field.style.display= "block";
	_$("cursor_pos").style.display= "block";
	_$("end_bracket").style.display= "block";
    }	
};

// the auto scroll of the textarea has some lacks when it have to show cursor in the visible area when the textarea size change
// show specifiy whereas it is the "top" or "bottom" of the selection that is showned
EditArea.prototype.scroll_to_view= function(show){
    var zone, lineElem;
    if(!this.smooth_selection)
	return;
    zone= _$("result");
    
    // manage height scroll
    var cursor_pos_top= _$("cursor_pos").cursor_top;
    if(show=="bottom")
    {
	//cursor_pos_top+=  (this.last_selection["line_nb"]-1)* this.lineHeight;
	cursor_pos_top+= this.getLinePosTop( this.last_selection['line_start'] + this.last_selection['line_nb'] - 1 );
    }
    
    var max_height_visible= zone.clientHeight + zone.scrollTop;
    var miss_top	= cursor_pos_top + this.lineHeight - max_height_visible;
    if(miss_top>0){
	//alert(miss_top);
	zone.scrollTop=  zone.scrollTop + miss_top;
    }else if( zone.scrollTop > cursor_pos_top){
	// when erase all the content -> does'nt scroll back to the top
	//alert("else: "+cursor_pos_top);
	zone.scrollTop= cursor_pos_top;	 
    }
    
    // manage left scroll
    //var cursor_pos_left= parseInt(_$("cursor_pos").style.left.replace("px",""));
    var cursor_pos_left= _$("cursor_pos").cursor_left;
    var max_width_visible= zone.clientWidth + zone.scrollLeft;
    var miss_left= cursor_pos_left + 10 - max_width_visible;
    if(miss_left>0){			
	zone.scrollLeft= zone.scrollLeft + miss_left + 50;
    }else if( zone.scrollLeft > cursor_pos_left){
	zone.scrollLeft= cursor_pos_left ;
    }else if( zone.scrollLeft == 45){
	// show the line numbers if textarea align to it's left
	zone.scrollLeft=0;
    }
};

EditArea.prototype.check_undo= function(only_once){
    if(!editAreas[this.id])
	return false;
    if(this.textareaFocused && editAreas[this.id]["displayed"]==true){
	var text=this.textarea.value;
	if(this.previous.length<=1)
	    this.switchClassSticky(_$("undo"), 'editAreaButtonDisabled', true);
	
	if(!this.previous[this.previous.length-1] || this.previous[this.previous.length-1]["text"] != text){
	    this.previous.push({"text": text, "selStart": this.textarea.selectionStart, "selEnd": this.textarea.selectionEnd});
	    if(this.previous.length > this.settings["max_undo"]+1)
		this.previous.shift();
	    
	}
	if(this.previous.length >= 2)
	    this.switchClassSticky(_$("undo"), 'editAreaButtonNormal', false);		
    }

    if(!only_once)
	setTimeout(function() {editArea.check_undo()}, 3000);
};

EditArea.prototype.undo= function(){
    //alert("undo"+this.previous.length);
    if(this.previous.length > 0)
    {
	this.getIESelection();
	//	var pos_cursor=this.textarea.selectionStart;
	this.next.push( { "text": this.textarea.value, "selStart": this.textarea.selectionStart, "selEnd": this.textarea.selectionEnd } );
	var prev= this.previous.pop();
	if( prev["text"] == this.textarea.value && this.previous.length > 0 )
	    prev	=this.previous.pop();						
	this.textarea.value	= prev["text"];
	this.last_undo		= prev["text"];
	this.area_select(prev["selStart"], prev["selEnd"]-prev["selStart"]);
	this.switchClassSticky(_$("redo"), 'editAreaButtonNormal', false);
	this.resync_highlight(true);
	//alert("undo"+this.previous.length);
	this.check_file_changes();
    }
};

EditArea.prototype.redo= function(){
    if(this.next.length > 0)
    {
	/*this.getIESelection();*/
	//var pos_cursor=this.textarea.selectionStart;
	var next= this.next.pop();
	this.previous.push(next);
	this.textarea.value= next["text"];
	this.last_undo= next["text"];
	this.area_select(next["selStart"], next["selEnd"]-next["selStart"]);
	this.switchClassSticky(_$("undo"), 'editAreaButtonNormal', false);
	this.resync_highlight(true);
	this.check_file_changes();
    }
    if(	this.next.length == 0)
	this.switchClassSticky(_$("redo"), 'editAreaButtonDisabled', true);
};

EditArea.prototype.check_redo= function(){
    if(editArea.next.length == 0 || editArea.textarea.value!=editArea.last_undo){
	editArea.next= [];	// undo the ability to use "redo" button
	editArea.switchClassSticky(_$("redo"), 'editAreaButtonDisabled', true);
    }
    else
    {
	this.switchClassSticky(_$("redo"), 'editAreaButtonNormal', false);
    }
};


// functions that manage icons roll over, disabled, etc...
EditArea.prototype.switchClass = function(element, class_name, lock_state) {
    var lockChanged = false;
    
    if (typeof(lock_state) != "undefined" && element != null) {
	element.classLock = lock_state;
	lockChanged = true;
    }
    
    if (element != null && (lockChanged || !element.classLock)) {
	element.oldClassName = element.className;
	element.className = class_name;
    }
};

EditArea.prototype.restoreAndSwitchClass = function(element, class_name) {
    if (element != null && !element.classLock) {
	this.restoreClass(element);
	this.switchClass(element, class_name);
    }
};

EditArea.prototype.restoreClass = function(element) {
    if (element != null && element.oldClassName && !element.classLock) {
	element.className = element.oldClassName;
	element.oldClassName = null;
    }
};

EditArea.prototype.setClassLock = function(element, lock_state) {
    if (element != null)
	element.classLock = lock_state;
};

EditArea.prototype.switchClassSticky = function(element, class_name, lock_state) {
    var lockChanged = false;
    if (typeof(lock_state) != "undefined" && element != null) {
	element.classLock = lock_state;
	lockChanged = true;
    }
    
    if (element != null && (lockChanged || !element.classLock)) {
	element.className = class_name;
	element.oldClassName = class_name;
    }
};

//make the "page up" and "page down" buttons works correctly
EditArea.prototype.scroll_page= function(params){
    var dir= params["dir"], shift_pressed= params["shift"];
    var lines= this.textarea.value.split("\n");		
    var new_pos=0, length=0, char_left=0, line_nb=0, curLine=0;
    var toScrollAmount	= _$("result").clientHeight -30;
    var nbLineToScroll	= 0, diff= 0;
    
    if(dir=="up"){
	nbLineToScroll	= Math.ceil( toScrollAmount / this.lineHeight );
	
	// fix number of line to scroll
	for( i = this.last_selection["line_start"]; i - diff > this.last_selection["line_start"] - nbLineToScroll ; i-- )
	{
	    if( elem = _$('line_'+ i) )
	    {
		diff +=  Math.floor( ( elem.offsetHeight - 1 ) / this.lineHeight );
	    }
	}
	nbLineToScroll	-= diff;
	
	if(this.last_selection["selec_direction"]=="up"){
	    for(line_nb=0; line_nb< Math.min(this.last_selection["line_start"]-nbLineToScroll, lines.length); line_nb++){
		new_pos+= lines[line_nb].length + 1;
	    }
	    char_left=Math.min(lines[Math.min(lines.length-1, line_nb)].length, this.last_selection["curr_pos"]-1);
	    if(shift_pressed)
		length=this.last_selection["selectionEnd"]-new_pos-char_left;	
	    this.area_select(new_pos+char_left, length);
	    view="top";
	}else{			
	    view="bottom";
	    for(line_nb=0; line_nb< Math.min(this.last_selection["line_start"]+this.last_selection["line_nb"]-1-nbLineToScroll, lines.length); line_nb++){
		new_pos+= lines[line_nb].length + 1;
	    }
	    char_left=Math.min(lines[Math.min(lines.length-1, line_nb)].length, this.last_selection["curr_pos"]-1);
	    if(shift_pressed){
		//length=this.last_selection["selectionEnd"]-new_pos-char_left;	
		start= Math.min(this.last_selection["selectionStart"], new_pos+char_left);
		length= Math.max(new_pos+char_left, this.last_selection["selectionStart"] )- start ;
		if(new_pos+char_left < this.last_selection["selectionStart"])
		    view="top";
	    }else
		start=new_pos+char_left;
	    this.area_select(start, length);
	    
	}
    }
    else
    {
	var nbLineToScroll= Math.floor( toScrollAmount / this.lineHeight );
	// fix number of line to scroll
	for( i = this.last_selection["line_start"]; i + diff < this.last_selection["line_start"] + nbLineToScroll ; i++ )
	{
	    if( elem = _$('line_'+ i) )
	    {
		diff +=  Math.floor( ( elem.offsetHeight - 1 ) / this.lineHeight );
	    }
	}
	nbLineToScroll	-= diff;
	
	if(this.last_selection["selec_direction"]=="down"){
	    view="bottom";
	    for(line_nb=0; line_nb< Math.min(this.last_selection["line_start"]+this.last_selection["line_nb"]-2+nbLineToScroll, lines.length); line_nb++){
		if(line_nb==this.last_selection["line_start"]-1)
		    char_left= this.last_selection["selectionStart"] -new_pos;
		new_pos+= lines[line_nb].length + 1;
		
	    }
	    if(shift_pressed){
		length=Math.abs(this.last_selection["selectionStart"]-new_pos);	
		length+=Math.min(lines[Math.min(lines.length-1, line_nb)].length, this.last_selection["curr_pos"]);
		//length+=Math.min(lines[Math.min(lines.length-1, line_nb)].length, char_left);
		this.area_select(Math.min(this.last_selection["selectionStart"], new_pos), length);
	    }else{
		this.area_select(new_pos+char_left, 0);
	    }
	    
	}else{
	    view="top";
	    for(line_nb=0; line_nb< Math.min(this.last_selection["line_start"]+nbLineToScroll-1, lines.length, lines.length); line_nb++){
		if(line_nb==this.last_selection["line_start"]-1)
		    char_left= this.last_selection["selectionStart"] -new_pos;
		new_pos+= lines[line_nb].length + 1;									
	    }
	    if(shift_pressed){
		length=Math.abs(this.last_selection["selectionEnd"]-new_pos-char_left);	
		length+=Math.min(lines[Math.min(lines.length-1, line_nb)].length, this.last_selection["curr_pos"])- char_left-1;
		//length+=Math.min(lines[Math.min(lines.length-1, line_nb)].length, char_left);
		this.area_select(Math.min(this.last_selection["selectionEnd"], new_pos+char_left), length);
		if(new_pos+char_left > this.last_selection["selectionEnd"])
		    view="bottom";
	    }else{
		this.area_select(new_pos+char_left, 0);
	    }
	    
	}
    }
    //console.log( new_pos, char_left, length, nbLineToScroll, toScrollAmount, _$("result").clientHeigh );
    this.check_line_selection();
    this.scroll_to_view(view);
};

EditArea.prototype.start_resize= function(e){
    parent.editAreaLoader.resize["id"]		= editArea.id;		
    parent.editAreaLoader.resize["start_x"]	= (e)? e.pageX : event.x + document.body.scrollLeft;		
    parent.editAreaLoader.resize["start_y"]	= (e)? e.pageY : event.y + document.body.scrollTop;
    if(editArea.isIE)
    {
	editArea.textarea.focus();
	editArea.getIESelection();
    }
    parent.editAreaLoader.resize["selectionStart"]	= editArea.textarea.selectionStart;
    parent.editAreaLoader.resize["selectionEnd"]	= editArea.textarea.selectionEnd;
    parent.editAreaLoader.start_resize_area();
};

EditArea.prototype.toggle_full_screen= function(to){
    var t=this, p=parent, a=t.textarea, html, frame, selStart, selEnd, old, icon;
    if(typeof(to)=="undefined")
	to= !t.fullscreen['isFull'];
    old			= t.fullscreen['isFull'];
    t.fullscreen['isFull']= to;
    icon		= _$("fullscreen");
    selStart	= t.textarea.selectionStart;
    selEnd		= t.textarea.selectionEnd;
    html		= p.document.getElementsByTagName("html")[0];
    frame		= p.document.getElementById("frame_"+t.id);
    
    if(to && to!=old)
    {	// toogle on fullscreen		
	
	t.fullscreen['old_overflow']	= p.get_css_property(html, "overflow");
	t.fullscreen['old_height']		= p.get_css_property(html, "height");
	t.fullscreen['old_width']		= p.get_css_property(html, "width");
	t.fullscreen['old_scrollTop']	= html.scrollTop;
	t.fullscreen['old_scrollLeft']	= html.scrollLeft;
	t.fullscreen['old_zIndex']		= p.get_css_property(frame, "z-index");
	if(t.isOpera){
	    html.style.height	= "100%";
	    html.style.width	= "100%";	
	}
	html.style.overflow	= "hidden";
	html.scrollTop		= 0;
	html.scrollLeft		= 0;
	
	frame.style.position	= "absolute";
	frame.style.width		= html.clientWidth+"px";
	frame.style.height		= html.clientHeight+"px";
	frame.style.display		= "block";
	frame.style.zIndex		= "999999";
	frame.style.top			= "0px";
	frame.style.left		= "0px";
	
	// if the iframe was in a div with position absolute, the top and left are the one of the div, 
	// so I fix it by seeing at witch position the iframe start and correcting it
	frame.style.top			= "-"+p.calculeOffsetTop(frame)+"px";
	frame.style.left		= "-"+p.calculeOffsetLeft(frame)+"px";
	
	//	parent.editAreaLoader.execCommand(t.id, "update_size();");
	//	var body=parent.document.getElementsByTagName("body")[0];
	//	body.appendChild(frame);
	
	t.switchClassSticky(icon, 'editAreaButtonSelected', false);
	t.fullscreen['allow_resize']= t.resize_allowed;
	t.allow_resize(false);
	
	//t.area_select(selStart, selEnd-selStart);
	
	
	// opera can't manage to do a direct size update
	if (t.isFirefox) {
	    p.editAreaLoader.execCommand(t.id, "update_size");
	    t.area_select(selStart, selEnd-selStart);
	    t.scroll_to_view();
	    t.focus();
	} else{
	    setTimeout(function() {
                p.editAreaLoader.execCommand(t.id, 'update_size');
                editArea.focus();
            } , 10);
	}	
	
	
    } else if(to!=old) {	// toogle off fullscreen
	frame.style.position="static";
	frame.style.zIndex= t.fullscreen['old_zIndex'];
	
	if (t.isOpera) {
	    html.style.height	= "auto"; 
	    html.style.width	= "auto";
	    html.style.overflow	= "auto";
	} else if(t.isIE && p!=top) {	// IE doesn't manage html overflow in frames like in normal page... 
	    html.style.overflow	= "auto";
	} else {
	    html.style.overflow	= t.fullscreen['old_overflow'];
	}
	html.scrollTop	= t.fullscreen['old_scrollTop'];
	html.scrollLeft	= t.fullscreen['old_scrollLeft'];
	
	p.editAreaLoader.hide(t.id);
	p.editAreaLoader.show(t.id);
	
	t.switchClassSticky(icon, 'editAreaButtonNormal', false);
	if(t.fullscreen['allow_resize'])
	    t.allow_resize(t.fullscreen['allow_resize']);
	if(t.isFirefox) {
	    t.area_select(selStart, selEnd-selStart);
	    setTimeout(function() {
                editArea.scroll_to_view();
            }, 10);
	}			
	
	//p.editAreaLoader.remove_event(p.window, "resize", editArea.update_size);
    }
    
};

EditArea.prototype.allow_resize= function(allow){
    var resize= _$("resize_area");
    if(allow){
	
	resize.style.visibility="visible";
	parent.editAreaLoader.add_event(resize, "mouseup", editArea.start_resize);
    }else{
	resize.style.visibility="hidden";
	parent.editAreaLoader.remove_event(resize, "mouseup", editArea.start_resize);
    }
    this.resize_allowed= allow;
};


EditArea.prototype.change_syntax= function(new_syntax, is_waiting){
    //	alert("cahnge to "+new_syntax);
    // the syntax is the same
    if(new_syntax==this.settings['syntax'])
	return true;
    
    // check that the syntax is one allowed
    var founded= false;
    for(var i=0; i<this.syntax_list.length; i++)
    {
	if(this.syntax_list[i]==new_syntax)
	    founded= true;
    }
    
    if(founded==true)
    {
	// the reg syntax file is not loaded
	if(!parent.editAreaLoader.load_syntax[new_syntax])
	{
	    // load the syntax file and wait for file loading
	    if(!is_waiting)
		parent.editAreaLoader.load_script(parent.editAreaLoader.baseURL + "reg_syntax/" + new_syntax + ".js");
	    setTimeout(function() {
                editArea.change_syntax(new_syntax, true);
            }, 100);
	    this.show_waiting_screen();
	} else {
	    if(!this.allready_used_syntax[new_syntax])
	    {	// the syntax has still not been used
		// rebuild syntax definition for new languages
		parent.editAreaLoader.init_syntax_regexp();
		// add style to the new list
		this.add_style(parent.editAreaLoader.syntax[new_syntax]["styles"]);
		this.allready_used_syntax[new_syntax]=true;
	    }
	    // be sure that the select option is correctly updated
	    var sel= _$("syntax_selection");
	    if(sel && sel.value!=new_syntax)
	    {
		for(var i=0; i<sel.length; i++){
		    if(sel.options[i].value && sel.options[i].value == new_syntax)
			sel.options[i].selected=true;
		}
	    }
	    
	    /*	if(this.settings['syntax'].length==0)
		{
		this.switchClassSticky(_$("highlight"), 'editAreaButtonNormal', false);
		this.switchClassSticky(_$("reset_highlight"), 'editAreaButtonNormal', false);
		this.change_highlight(true);
		}
	    */
	    this.settings['syntax']= new_syntax;
	    this.resync_highlight(true);
	    this.hide_waiting_screen();
	    return true;
	}
    }
    return false;
};


// check if the file has changed
EditArea.prototype.set_editable= function(is_editable){
    if(is_editable)
    {
	document.body.className= "";
	this.textarea.readOnly= false;
	this.is_editable= true;
    }
    else
    {
	document.body.className= "non_editable";
	this.textarea.readOnly= true;
	this.is_editable= false;
    }
    
    if(editAreas[this.id]["displayed"]==true)
	this.update_size();
};

/***** Wrap mode *****/

// toggling function for set_wrap_mode
EditArea.prototype.toggle_word_wrap= function(){
    this.set_word_wrap( !this.settings['word_wrap'] );
};


// open a new tab for the given file
EditArea.prototype.set_word_wrap= function(to){
    var t=this, a= t.textarea;
    
    if( t.isOpera )
    {
	this.settings['word_wrap']= false;
	t.switchClassSticky( _$("word_wrap"), 'editAreaButtonDisabled', true );
	return false;
    }
    
    if( to )
    {
	wrap_mode = 'soft';
	this.container.className+= ' word_wrap';
	this.container.style.width="";
	this.content_highlight.style.width="";
	a.style.width="100%";
	if( t.isIE && t.isIE < 7 )	// IE 6 count 50 px too much
	{
	    a.style.width	= ( a.offsetWidth-5 )+"px";
	}
	
	t.switchClassSticky( _$("word_wrap"), 'editAreaButtonSelected', false );
    }
    else
    {
	wrap_mode = 'off';
	this.container.className	= this.container.className.replace(/word_wrap/g, '');
	t.switchClassSticky( _$("word_wrap"), 'editAreaButtonNormal', true );
    }
    this.textarea.previous_scrollWidth = '';
    this.textarea.previous_scrollHeight = '';
    
    a.wrap= wrap_mode;
    a.setAttribute('wrap', wrap_mode);
    // only IE can change wrap mode on the fly without element reloading
    if(!this.isIE)
    {
	var start=a.selectionStart, end= a.selectionEnd;
	var parNod = a.parentNode, nxtSib = a.nextSibling;
	parNod.removeChild(a);
	parNod.insertBefore(a, nxtSib);
	this.area_select(start, end-start);
    }
    // reset some optimisation
    this.settings['word_wrap']	= to;
    this.focus();
    this.update_size();
    this.check_line_selection();
};	
/***** tabbed files managing functions *****/

// open a new tab for the given file
EditArea.prototype.open_file= function(settings){
    
    if(settings['id']!="undefined")
    {
	var id= settings['id'];
	// create a new file object with defautl values
	var new_file= {};
	new_file['id']			= id;
	new_file['title']		= id;
	new_file['text']		= "";
	new_file['last_selection']	= "";		
	new_file['last_text_to_highlight']	= "";
	new_file['last_hightlighted_text']	= "";
	new_file['previous']	= [];
	new_file['next']		= [];
	new_file['last_undo']	= "";
	new_file['smooth_selection']	= this.settings['smooth_selection'];
	new_file['do_highlight']= this.settings['start_highlight'];
	new_file['syntax']		= this.settings['syntax'];
	new_file['scroll_top']	= 0;
	new_file['scroll_left']	= 0;
	new_file['selection_start']= 0;
	new_file['selection_end']= 0;
	new_file['edited']		= false;
	new_file['font_size']	= this.settings["font_size"];
	new_file['font_family']	= this.settings["font_family"];
	new_file['word_wrap']	= this.settings["word_wrap"];
	new_file['toolbar']		= {'links':{}, 'selects': {}};
	new_file['compare_edited_text']= new_file['text'];
	
	
	this.files[id]= new_file;
	this.update_file(id, settings);
	this.files[id]['compare_edited_text']= this.files[id]['text'];
	
	
	var html_id= 'tab_file_'+encodeURIComponent(id);
	this.filesIdAssoc[html_id]= id;
	this.files[id]['html_id']= html_id;
	
	if(!_$(this.files[id]['html_id']) && id!="")
	{
	    // be sure the tab browsing area is displayed
	    this.tab_browsing_area.style.display= "block";
	    var elem= document.createElement('li');
	    elem.id= this.files[id]['html_id'];
	    var close= "<img src=\""+ parent.editAreaLoader.baseURL +"images/close.gif\" title=\""+ this.get_translation('close_tab', 'word') +"\" onclick=\"editArea.execCommand('close_file', editArea.filesIdAssoc['"+ html_id +"']);return false;\" class=\"hidden\" onmouseover=\"this.className=''\" onmouseout=\"this.className='hidden'\" />";
	    elem.innerHTML= "<a onclick=\"javascript:editArea.execCommand('switch_to_file', editArea.filesIdAssoc['"+ html_id +"']);\" selec=\"none\"><b><span><strong class=\"edited\">*</strong>"+ this.files[id]['title'] + close +"</span></b></a>";
	    _$('tab_browsing_list').appendChild(elem);
	    var elem= document.createElement('text');
	    this.update_size();
	}
	
	// open file callback (for plugin)
	if(id!="")
	    this.execCommand('file_open', this.files[id]);
	
	this.switch_to_file(id, true);
	return true;
    }
    else
	return false;
};

// close the given file
EditArea.prototype.close_file= function(id){
    if(this.files[id])
    {
	this.save_file(id);
	
	// close file callback
	if(this.execCommand('file_close', this.files[id])!==false)
	{
	    // remove the tab in the toolbar
	    var li= _$(this.files[id]['html_id']);
	    li.parentNode.removeChild(li);
	    // select a new file
	    if(id== this.curr_file)
	    {
		var next_file= "";
		var is_next= false;
		for(var i in this.files)
		{
		    if( is_next )
		    {
			next_file	= i;
			break;
		    }
		    else if( i == id )
			is_next		= true;
		    else
			next_file	= i;
		}
		// display the next file
		this.switch_to_file(next_file);
	    }
	    // clear datas
	    delete (this.files[id]);
	    this.update_size();
	}	
    }
};

// backup current file datas
EditArea.prototype.save_file= function(id){
    var t= this, save, a_links, a_selects, save_butt, img, i;
    if(t.files[id])
    {
	var save= t.files[id];
	save['last_selection']			= t.last_selection;		
	save['last_text_to_highlight']	= t.last_text_to_highlight;
	save['last_hightlighted_text']	= t.last_hightlighted_text;
	save['previous']				= t.previous;
	save['next']					= t.next;
	save['last_undo']				= t.last_undo;
	save['smooth_selection']		= t.smooth_selection;
	save['do_highlight']			= t.do_highlight;
	save['syntax']					= t.settings['syntax'];
	save['text']					= t.textarea.value;
	save['scroll_top']				= t.result.scrollTop;
	save['scroll_left']				= t.result.scrollLeft;
	save['selection_start']			= t.last_selection["selectionStart"];
	save['selection_end']			= t.last_selection["selectionEnd"];
	save['font_size']				= t.settings["font_size"];
	save['font_family']				= t.settings["font_family"];
	save['word_wrap']				= t.settings["word_wrap"];
	save['toolbar']					= {'links':{}, 'selects': {}};
	
	// save toolbar buttons state for fileSpecific buttons
	a_links= _$("toolbar_1").getElementsByTagName("a");
	for( i=0; i<a_links.length; i++ )
	{
	    if( a_links[i].getAttribute('fileSpecific') == 'yes' )
	    {
		save_butt	= {};
		img			= a_links[i].getElementsByTagName('img')[0];
		save_butt['classLock']		= img.classLock;
		save_butt['className']		= img.className;
		save_butt['oldClassName']	= img.oldClassName;
		
		save['toolbar']['links'][a_links[i].id]= save_butt;
	    }
	}
	
	// save toolbar select state for fileSpecific buttons
	a_selects= _$("toolbar_1").getElementsByTagName("select");
	for( i=0; i<a_selects.length; i++)
	{
	    if(a_selects[i].getAttribute('fileSpecific')=='yes')
	    {
		save['toolbar']['selects'][a_selects[i].id]= a_selects[i].value;
	    }
	}
	
	t.files[id]= save;
	
	return save;
    }
    
    return false;
};

// update file_datas
EditArea.prototype.update_file= function(id, new_values){
    for(var i in new_values)
    {
	this.files[id][i]= new_values[i];
    }
};

// display file datas
EditArea.prototype.display_file= function(id){
    var t = this, a= t.textarea, new_file, a_lis, a_selects, a_links, a_options, i, j;
    
    // we're showing the empty file
    if(id=='')
    {
	a.readOnly= true;
	t.tab_browsing_area.style.display= "none";
	_$("no_file_selected").style.display= "block";
	t.result.className= "empty";
	// clear current datas
	if(!t.files[''])
	{
	    t.open_file({id: ''});
	}
    }
    // we try to show a non existent file, so we left
    else if( typeof( t.files[id] ) == 'undefined' )
    {
	return false;
    }
    // display a normal file
    else
    {
	t.result.className= "";
	a.readOnly= !t.is_editable;
	_$("no_file_selected").style.display= "none";
	t.tab_browsing_area.style.display= "block";
    }
    
    // ensure to have last state for undo/redo actions
    t.check_redo(true);
    t.check_undo(true);
    t.curr_file= id;
    
    // replace selected tab file
    a_lis= t.tab_browsing_area.getElementsByTagName('li');
    for( i=0; i<a_lis.length; i++)
    {
	if(a_lis[i].id == t.files[id]['html_id'])
	    a_lis[i].className='selected';
	else
	    a_lis[i].className='';
    }
    
    // replace next files datas
    new_file= t.files[id];
    
    // restore text content
    a.value= new_file['text'];
    
    // restore font-size
    t.set_font(new_file['font_family'], new_file['font_size']);
    
    // restore selection and scroll
    t.area_select(new_file['last_selection']['selection_start'], new_file['last_selection']['selection_end'] - new_file['last_selection']['selection_start']);
    t.manage_size(true);
    t.result.scrollTop= new_file['scroll_top'];
    t.result.scrollLeft= new_file['scroll_left'];
    
    // restore undo, redo
    t.previous=	new_file['previous'];
    t.next=	new_file['next'];
    t.last_undo=	new_file['last_undo'];
    t.check_redo(true);
    t.check_undo(true);
    
    // restore highlight
    t.execCommand("change_highlight", new_file['do_highlight']);
    t.execCommand("change_syntax", new_file['syntax']);
    
    // smooth mode
    t.execCommand("change_smooth_selection_mode", new_file['smooth_selection']);
    
    // word_wrap
    t.execCommand("set_word_wrap", new_file['word_wrap']);
    
    // restore links state in toolbar
    a_links= new_file['toolbar']['links'];
    for( i in a_links)
    {
	if( img =  _$(i).getElementsByTagName('img')[0] )
	{
	    img.classLock	= a_links[i]['classLock'];
	    img.className	= a_links[i]['className'];
	    img.oldClassName= a_links[i]['oldClassName'];
	}
    }
    
    // restore select state in toolbar
    a_selects = new_file['toolbar']['selects'];
    for( i in a_selects)
    {
	a_options	= _$(i).options;
	for( j=0; j<a_options.length; j++)
	{
	    if( a_options[j].value == a_selects[i] )
		_$(i).options[j].selected=true;
	}
    }
    
};

// change tab for displaying a new one
EditArea.prototype.switch_to_file= function(file_to_show, force_refresh){
    if(file_to_show!=this.curr_file || force_refresh)
    {
	this.save_file(this.curr_file);
	if(this.curr_file!='')
	    this.execCommand('file_switch_off', this.files[this.curr_file]);
	this.display_file(file_to_show);
	if(file_to_show!='')
	    this.execCommand('file_switch_on', this.files[file_to_show]);
    }
};

// get all infos for the given file
EditArea.prototype.get_file= function(id){
    if(id==this.curr_file)
	this.save_file(id);
    return this.files[id];
};

// get all available files infos
EditArea.prototype.get_all_files= function(){
    tmp_files= this.files;
    this.save_file(this.curr_file);
    if(tmp_files[''])
	delete(this.files['']);
    return tmp_files;
};


// check if the file has changed
EditArea.prototype.check_file_changes= function(){
    
    var id= this.curr_file;
    if(this.files[id] && this.files[id]['compare_edited_text']!=undefined)
    {
	if(this.files[id]['compare_edited_text'].length==this.textarea.value.length && this.files[id]['compare_edited_text']==this.textarea.value)
	{
	    if(this.files[id]['edited']!= false)
		this.set_file_edited_mode(id, false);
	}
	else
	{
	    if(this.files[id]['edited']!= true)
		this.set_file_edited_mode(id, true);
	}
    }
};

// set if the file is edited or not
EditArea.prototype.set_file_edited_mode= function(id, to){
    // change CSS for edited tab
    if(this.files[id] && _$(this.files[id]['html_id']))
    {
	var link= _$(this.files[id]['html_id']).getElementsByTagName('a')[0];
	if(to==true)
	{
	    link.className= 'edited';
	}
	else
	{
	    link.className= '';
	    if(id==this.curr_file)
		text= this.textarea.value;
	    else
		text= this.files[id]['text'];
	    this.files[id]['compare_edited_text']= text;
	}
	
	this.files[id]['edited']= to;
    }
};

EditArea.prototype.set_show_line_colors = function(new_value){
    this.show_line_colors = new_value;
    
    if( new_value )
	this.selection_field.className	+= ' show_colors';
    else
	this.selection_field.className	= this.selection_field.className.replace( / show_colors/g, '' );
};


======================================================================
FILE PATH: editor\editarea\edit_area\edit_area_loader.js
======================================================================
/******
 *
 *	EditArea 
 * 	Developped by Christophe Dolivet
 *	Released under LGPL, Apache and BSD licenses (use the one you want)
 *
 ******/

function EditAreaLoader() {
    var t=this;
    t.version= "0.8.1.1";
    t.start_time=(new Date()).getTime();
    t.win= "loading";	// window loading state
    t.error= false;	// to know if load is interrrupt
    t.baseURL="";
    //t.suffix="";
    t.template="";
    t.lang= {};	// array of loaded speech language
    t.load_syntax= {};	// array of loaded syntax language for highlight mode
    t.syntax= {};	// array of initilized syntax language for highlight mode
    t.loadedFiles= [];
    t.waiting_loading= {}; 	// files that must be loaded in order to allow the script to really start
    // scripts that must be loaded in the iframe
    t.scripts_to_load= ["elements_functions", "resize_area", "reg_syntax"];
    t.sub_scripts_to_load= ["edit_area", "manage_area" ,"edit_area_functions", "keyboard", "search_replace", "highlight", "regexp"];
    
    t.resize= []; // contain resizing datas
    t.hidden= {};	// store datas of the hidden textareas
    
    t.default_settings= {
	//id: "src"	// id of the textarea to transform
	debug: false
	,smooth_selection: true
	,font_size: "10"		// not for IE
	,font_family: "monospace"	// can be "verdana,monospace". Allow non monospace font but Firefox get smaller tabulation with non monospace fonts. IE doesn't change the tabulation width and Opera doesn't take this option into account... 
	,start_highlight: false	// if start with highlight
	,toolbar: "search, go_to_line, fullscreen, |, undo, redo, |, select_font,|, change_smooth_selection, highlight, reset_highlight, word_wrap, |, help"
	,begin_toolbar: ""		//  "new_document, save, load, |"
	,end_toolbar: ""		// or end_toolbar
	,is_multi_files: false		// enable the multi file mode (the textarea content is ignored)
	,allow_resize: "both"	// possible values: "no", "both", "x", "y"
	,show_line_colors: false	// if the highlight is disabled for the line currently beeing edited (if enabled => heavy CPU use)
	,min_width: 400
	,min_height: 125
	,replace_tab_by_spaces: false
	,allow_toggle: true		// true or false
	,language: "en"
	,syntax: ""
	,syntax_selection_allow: "basic,brainfuck,c,coldfusion,cpp,css,html,java,js,pas,perl,php,python,ruby,robotstxt,sql,tsql,vb,xml"
	,display: "onload" 		// onload or later
	,max_undo: 30
	,browsers: "known"	// all or known
	,plugins: "" // comma separated plugin list
	,gecko_spellcheck: false	// enable/disable by default the gecko_spellcheck
	,fullscreen: false
	,is_editable: true
	,cursor_position: "begin"
	,word_wrap: false		// define if the text is wrapped of not in the textarea
	,autocompletion: false	// NOT IMPLEMENTED			
	,load_callback: ""		// click on load button (function name)
	,save_callback: ""		// click on save button (function name)
	,change_callback: ""	// textarea onchange trigger (function name)
	,submit_callback: ""	// form submited (function name)
	,EA_init_callback: ""	// EditArea initiliazed (function name)
	,EA_delete_callback: ""	// EditArea deleted (function name)
	,EA_load_callback: ""	// EditArea fully loaded and displayed (function name)
	,EA_unload_callback: ""	// EditArea delete while being displayed (function name)
	,EA_toggle_on_callback: ""	// EditArea toggled on (function name)
	,EA_toggle_off_callback: ""	// EditArea toggled off (function name)
	,EA_file_switch_on_callback: ""	// a new tab is selected (called for the newly selected file)
	,EA_file_switch_off_callback: ""	// a new tab is selected (called for the previously selected file)
	,EA_file_close_callback: ""		// close a tab
    };
    
    t.advanced_buttons = [
	// id, button img, command (it will try to find the translation of "id"), is_file_specific
	['new_document', 'newdocument.gif', 'new_document', false],
	['search', 'search.gif', 'show_search', false],
	['go_to_line', 'go_to_line.gif', 'go_to_line', false],
	['undo', 'undo.gif', 'undo', true],
	['redo', 'redo.gif', 'redo', true],
	['change_smooth_selection', 'smooth_selection.gif', 'change_smooth_selection_mode', true],
	['reset_highlight', 'reset_highlight.gif', 'resync_highlight', true],
	['highlight', 'highlight.gif','change_highlight', true],
	['help', 'help.gif', 'show_help', false],
	['save', 'save.gif', 'save', false],
	['load', 'load.gif', 'load', false],
	['fullscreen', 'fullscreen.gif', 'toggle_full_screen', false],
	['word_wrap', 'word_wrap.gif', 'toggle_word_wrap', true],
	['autocompletion', 'autocompletion.gif', 'toggle_autocompletion', true]
    ];
    
    // navigator identification
    t.set_browser_infos(t);

    if(t.isIE>=6 || t.isGecko || ( t.isWebKit && !t.isSafari<3 ) || t.isOpera>=9  || t.isCamino )
	t.isValidBrowser=true;
    else
	t.isValidBrowser=false;

    t.set_base_url();		
    
    setTimeout(function() {
        for(var i = 0; i < t.scripts_to_load.length; i++) {
            editAreaLoader.load_script(t.baseURL + t.scripts_to_load[i]+ ".js");
            t.waiting_loading[t.scripts_to_load[i]+ ".js"]= false;
        }
    }, 1);	// let the time to Object editAreaLoader to be created before loading additionnal scripts

    t.add_event(window, "load", EditAreaLoader.prototype.window_loaded);
};

EditAreaLoader.prototype = {
    has_error : function(){
	this.error= true;
	// set to empty all EditAreaLoader functions
	for(var i in EditAreaLoader.prototype){
	    EditAreaLoader.prototype[i]=function(){};		
	}
    },
    
    // add browser informations to the object passed in parameter
    set_browser_infos : function(o){
	ua= navigator.userAgent;
	
	// general detection
	o.isWebKit	= /WebKit/.test(ua);
	o.isGecko	= !o.isWebKit && /Gecko/.test(ua);
	o.isMac		= /Mac/.test(ua);
	
	o.isIE	= (navigator.appName == "Microsoft Internet Explorer");
	if(o.isIE){
	    o.isIE = ua.replace(/^.*?MSIE\s+([0-9\.]+).*$/, "$1");
	    if(o.isIE<6)
		o.has_error();
	}

	if(o.isOpera = (ua.indexOf('Opera') != -1)){	
	    o.isOpera= ua.replace(/^.*?Opera.*?([0-9\.]+).*$/i, "$1");
	    if(o.isOpera<9)
		o.has_error();
	    o.isIE=false;			
	}

	if(o.isFirefox =(ua.indexOf('Firefox') != -1))
	    o.isFirefox = ua.replace(/^.*?Firefox.*?([0-9\.]+).*$/i, "$1");
	// Firefox clones 	
	if( ua.indexOf('Iceweasel') != -1 )
	    o.isFirefox	= ua.replace(/^.*?Iceweasel.*?([0-9\.]+).*$/i, "$1");
	if( ua.indexOf('GranParadiso') != -1 )
	    o.isFirefox	= ua.replace(/^.*?GranParadiso.*?([0-9\.]+).*$/i, "$1");
	if( ua.indexOf('BonEcho') != -1 )
	    o.isFirefox	= ua.replace(/^.*?BonEcho.*?([0-9\.]+).*$/i, "$1");
	if( ua.indexOf('SeaMonkey') != -1)
	    o.isFirefox = (ua.replace(/^.*?SeaMonkey.*?([0-9\.]+).*$/i, "$1") ) + 1;
	
	if(o.isCamino =(ua.indexOf('Camino') != -1))
	    o.isCamino = ua.replace(/^.*?Camino.*?([0-9\.]+).*$/i, "$1");
	
	if(o.isSafari =(ua.indexOf('Safari') != -1))
	    o.isSafari= ua.replace(/^.*?Version\/([0-9]+\.[0-9]+).*$/i, "$1");
	
	if(o.isChrome =(ua.indexOf('Chrome') != -1)) {
	    o.isChrome = ua.replace(/^.*?Chrome.*?([0-9\.]+).*$/i, "$1");
	    o.isSafari	= false;
	}
	
    },
    
    window_loaded : function(){
	editAreaLoader.win="loaded";
	
	// add events on forms
	if (document.forms) {
	    for (var i=0; i<document.forms.length; i++) {
		var form = document.forms[i];
		form.edit_area_replaced_submit=null;
		try {
		    
		    form.edit_area_replaced_submit = form.onsubmit;
		    form.onsubmit="";
		} catch (e) {// Do nothing
		}
		editAreaLoader.add_event(form, "submit", EditAreaLoader.prototype.submit);
		editAreaLoader.add_event(form, "reset", EditAreaLoader.prototype.reset);
	    }
	}
	editAreaLoader.add_event(window, "unload", function(){for(var i in editAreas){editAreaLoader.delete_instance(i);}});	// ini callback
    },
    
    // init the checkup of the selection of the IE textarea
    init_ie_textarea : function(id){
	var a=document.getElementById(id);
	try{
	    if(a && typeof(a.focused)=="undefined"){
		a.focus();
		a.focused=true;
		a.selectionStart= a.selectionEnd= 0;			
		get_IE_selection(a);
		editAreaLoader.add_event(a, "focus", IE_textarea_focus);
		editAreaLoader.add_event(a, "blur", IE_textarea_blur);
		
	    }
	}catch(ex){}
    },
    
    init : function(settings){
	var t=this,s=settings,i;
	
	if(!s["id"])
	    t.has_error();
	if(t.error)
	    return;
	// if an instance of the editor already exists for this textarea => delete the previous one
	if(editAreas[s["id"]])
	    t.delete_instance(s["id"]);
	
	// init settings
	for(i in t.default_settings){
	    if(typeof(s[i])=="undefined")
		s[i]=t.default_settings[i];
	}
	
	if(s["browsers"]=="known" && t.isValidBrowser==false){
	    return;
	}
	
	if(s["begin_toolbar"].length>0)
	    s["toolbar"]= s["begin_toolbar"] +","+ s["toolbar"];
	if(s["end_toolbar"].length>0)
	    s["toolbar"]= s["toolbar"] +","+ s["end_toolbar"];
	s["tab_toolbar"]= s["toolbar"].replace(/ /g,"").split(",");
	
	s["plugins"]= s["plugins"].replace(/ /g,"").split(",");
	for(i=0; i<s["plugins"].length; i++){
	    if(s["plugins"][i].length==0)
		s["plugins"].splice(i,1);
	}
	//	alert(settings["plugins"].length+": "+ settings["plugins"].join(","));
	t.get_template();
	t.load_script(t.baseURL + "langs/"+ s["language"] + ".js");
	
	if(s["syntax"].length>0){
	    s["syntax"]=s["syntax"].toLowerCase();
	    t.load_script(t.baseURL + "reg_syntax/"+ s["syntax"] + ".js");
	}
	//alert(this.template);
	
	editAreas[s["id"]]= {"settings": s};
	editAreas[s["id"]]["displayed"]=false;
	editAreas[s["id"]]["hidden"]=false;
	
	//if(settings["display"]=="onload")
	t.start(s["id"]);
    },
    
    // delete an instance of an EditArea
    delete_instance : function(id){
	var d=document,fs=window.frames,span,iframe;
	editAreaLoader.execCommand(id, "EA_delete");
	if(fs["frame_"+id] && fs["frame_"+id].editArea)
	{
	    if(editAreas[id]["displayed"])
		editAreaLoader.toggle(id, "off");
	    fs["frame_"+id].editArea.execCommand("EA_unload");
	}

	// remove toggle infos and debug textarea
	span= d.getElementById("EditAreaArroundInfos_"+id);
	if(span)
	    span.parentNode.removeChild(span);

	// remove the iframe
	iframe= d.getElementById("frame_"+id);
	if(iframe){
	    iframe.parentNode.removeChild(iframe);
	    //delete iframe;
	    try {
		delete fs["frame_"+id];
	    } catch (e) {// Do nothing
	    }
	}	

	delete editAreas[id];
    },

    
    start : function(id){
	var t=this,d=document,f,span,father,next,html='',html_toolbar_content='',template,content,i;
	
	// check that the window is loaded
	if(t.win!="loaded"){
	    setTimeout(function () {
                editAreaLoader.start(id);
            }, 50);
	    return;
	}
	
	// check that all needed scripts are loaded
	for( i in t.waiting_loading){
	    if(t.waiting_loading[i]!="loaded" && typeof(t.waiting_loading[i])!="function"){
		setTimeout(function() {
                    editAreaLoader.start(id);
                }, 50);
		return;
	    }
	}
	
	// wait until language and syntax files are loaded
	if(!t.lang[editAreas[id]["settings"]["language"]] || (editAreas[id]["settings"]["syntax"].length>0 && !t.load_syntax[editAreas[id]["settings"]["syntax"]]) ){
	    setTimeout(function() {
                editAreaLoader.start(id);
            }, 50);
	    return;
	}
	// init the regexp for syntax highlight
	if(editAreas[id]["settings"]["syntax"].length>0)
	    t.init_syntax_regexp();
	
	
	// display toggle option and debug area
	if(!d.getElementById("EditAreaArroundInfos_"+id) && (editAreas[id]["settings"]["debug"] || editAreas[id]["settings"]["allow_toggle"]))
	{
	    span= d.createElement("span");
	    span.id= "EditAreaArroundInfos_"+id;
	    if(editAreas[id]["settings"]["allow_toggle"]){
		checked=(editAreas[id]["settings"]["display"]=="onload")?"checked='checked'":"";
		html+="<div id='edit_area_toggle_"+i+"'>";
		html+="<input id='edit_area_toggle_checkbox_"+ id +"' class='toggle_"+ id +"' type='checkbox' onclick='editAreaLoader.toggle(\""+ id +"\");' accesskey='e' "+checked+" />";
		html+="<label for='edit_area_toggle_checkbox_"+ id +"'>{$toggle}</label></div>";	
	    }
	    if(editAreas[id]["settings"]["debug"])
		html+="<textarea id='edit_area_debug_"+ id +"' spellcheck='off' style='z-index: 20; width: 100%; height: 120px;overflow: auto; border: solid black 1px;'></textarea><br />";				
	    html= t.translate(html, editAreas[id]["settings"]["language"]);				
	    span.innerHTML= html;				
	    father= d.getElementById(id).parentNode;
	    next= d.getElementById(id).nextSibling;
	    if(next==null)
		father.appendChild(span);
	    else
		father.insertBefore(span, next);
	}
	
	if(!editAreas[id]["initialized"])
	{
	    t.execCommand(id, "EA_init");	// ini callback
	    if(editAreas[id]["settings"]["display"]=="later"){
		editAreas[id]["initialized"]= true;
		return;
	    }
	}
	
	if(t.isIE){	// launch IE selection checkup
	    t.init_ie_textarea(id);
	}
	
	// get toolbar content
	area=editAreas[id];
	
	for(i=0; i<area["settings"]["tab_toolbar"].length; i++){
	    //	alert(this.tab_toolbar[i]+"\n"+ this.get_control_html(this.tab_toolbar[i]));
	    html_toolbar_content+= t.get_control_html(area["settings"]["tab_toolbar"][i], area["settings"]["language"]);
	}
	// translate toolbar text here for chrome 2
	html_toolbar_content = t.translate(html_toolbar_content, area["settings"]["language"], "template"); 
	
	
	// create javascript import rules for the iframe if the javascript has not been already loaded by the compressor
	if(!t.iframe_script){
	    t.iframe_script="";
	    for(i=0; i<t.sub_scripts_to_load.length; i++)
		t.iframe_script+='<script language="javascript" type="text/javascript" src="'+ t.baseURL + t.sub_scripts_to_load[i] +'.js"></script>';
	}
	
	// add plugins scripts if not already loaded by the compressor (but need to load language in all the case)
	for(i=0; i<area["settings"]["plugins"].length; i++){
	    //if(typeof(area["settings"]["plugins"][i])=="function") continue;
	    if(!t.all_plugins_loaded)
		t.iframe_script+='<script language="javascript" type="text/javascript" src="'+ t.baseURL + 'plugins/' + area["settings"]["plugins"][i] + '/' + area["settings"]["plugins"][i] +'.js"></script>';
	    t.iframe_script+='<script language="javascript" type="text/javascript" src="'+ t.baseURL + 'plugins/' + area["settings"]["plugins"][i] + '/langs/' + area["settings"]["language"] +'.js"></script>';
	}
	
	
	// create css link for the iframe if the whole css text has not been already loaded by the compressor
	if(!t.iframe_css){
	    t.iframe_css="<link href='"+ t.baseURL +"edit_area.css' rel='stylesheet' type='text/css' />";
	}
	
	
	// create template
	template= t.template.replace(/\[__BASEURL__\]/g, t.baseURL);
	template= template.replace("[__TOOLBAR__]",html_toolbar_content);
	
	
	// fill template with good language sentences
	template= t.translate(template, area["settings"]["language"], "template");
	
	// add css_code
	template= template.replace("[__CSSRULES__]", t.iframe_css);				
	// add js_code
	template= template.replace("[__JSCODE__]", t.iframe_script);
	
	// add version_code
	template= template.replace("[__EA_VERSION__]", t.version);
	//template=template.replace(/\{\$([^\}]+)\}/gm, this.traduc_template);
	
	//editAreas[area["settings"]["id"]]["template"]= template;
	
	area.textarea=d.getElementById(area["settings"]["id"]);
	editAreas[area["settings"]["id"]]["textarea"]=area.textarea;
	
	// if removing previous instances from DOM before (fix from Marcin)
	if(typeof(window.frames["frame_"+area["settings"]["id"]])!='undefined') 
	    delete window.frames["frame_"+area["settings"]["id"]];
	
	// insert template in the document after the textarea
	father= area.textarea.parentNode;
	/*	var container= document.createElement("div");
		container.id= "EditArea_frame_container_"+area["settings"]["id"];
	*/	
	content= d.createElement("iframe");
	content.name= "frame_"+area["settings"]["id"];
	content.id= "frame_"+area["settings"]["id"];
	content.style.borderWidth= "0px";
	setAttribute(content, "frameBorder", "0"); // IE
	content.style.overflow="hidden";
	content.style.display="none";

	
	next= area.textarea.nextSibling;
	if(next==null)
	    father.appendChild(content);
	else
	    father.insertBefore(content, next) ;		
	f=window.frames["frame_"+area["settings"]["id"]];
	f.document.open();
	f.editAreas=editAreas;
	f.area_id= area["settings"]["id"];	
	f.document.area_id= area["settings"]["id"];	
	f.document.write(template);
	f.document.close();

	//	frame.editAreaLoader=this;
	//editAreas[area["settings"]["id"]]["displayed"]=true;
	
    },
    
    toggle : function(id, toggle_to){

	/*	if((editAreas[id]["displayed"]==true  && toggle_to!="on") || toggle_to=="off"){
		this.toggle_off(id);
		}else if((editAreas[id]["displayed"]==false  && toggle_to!="off") || toggle_to=="on"){
		this.toggle_on(id);
		}*/
	if(!toggle_to)
	    toggle_to= (editAreas[id]["displayed"]==true)?"off":"on";
	if(editAreas[id]["displayed"]==true  && toggle_to=="off"){
	    this.toggle_off(id);
	}else if(editAreas[id]["displayed"]==false  && toggle_to=="on"){
	    this.toggle_on(id);
	}
	
	return false;
    },
    
    // static function
    toggle_off : function(id){
	var fs=window.frames,f,t,parNod,nxtSib,selStart,selEnd,scrollTop,scrollLeft;
	if(fs["frame_"+id])
	{	
	    f	= fs["frame_"+id];
	    t	= editAreas[id]["textarea"];
	    if(f.editArea.fullscreen['isFull'])
		f.editArea.toggle_full_screen(false);
	    editAreas[id]["displayed"]=false;
	    
	    // set wrap to off to keep same display mode (some browser get problem with this, so it need more complex operation		
	    t.wrap = "off";	// for IE
	    setAttribute(t, "wrap", "off");	// for Firefox	
	    parNod = t.parentNode;
	    nxtSib = t.nextSibling;
	    parNod.removeChild(t); 
	    parNod.insertBefore(t, nxtSib);
	    
	    // restore values
	    t.value= f.editArea.textarea.value;
	    selStart	= f.editArea.last_selection["selectionStart"];
	    selEnd		= f.editArea.last_selection["selectionEnd"];
	    scrollTop	= f.document.getElementById("result").scrollTop;
	    scrollLeft	= f.document.getElementById("result").scrollLeft;
	    
	    
	    document.getElementById("frame_"+id).style.display='none';
	    
	    t.style.display="inline";

	    try{	// IE will give an error when trying to focus an invisible or disabled textarea
		t.focus();
	    } catch(e){};
	    if(this.isIE){
		t.selectionStart= selStart;
		t.selectionEnd	= selEnd;
		t.focused		= true;
		set_IE_selection(t);
	    }else{
		if(this.isOpera && this.isOpera < 9.6 ){	// Opera bug when moving selection start and selection end
		    t.setSelectionRange(0, 0);
		}
		try{
		    t.setSelectionRange(selStart, selEnd);
		} catch(e) {};
	    }
	    t.scrollTop= scrollTop;
	    t.scrollLeft= scrollLeft;
	    f.editArea.execCommand("toggle_off");

	}
    },	
    
    // static function
    toggle_on : function(id){
	var fs=window.frames,f,t,selStart=0,selEnd=0,scrollTop=0,scrollLeft=0,curPos,elem;
	
	if(fs["frame_"+id])
	{
	    f	= fs["frame_"+id];
	    t	= editAreas[id]["textarea"];
	    area= f.editArea;
	    area.textarea.value= t.value;
	    
	    // store display values;
	    curPos	= editAreas[id]["settings"]["cursor_position"];

	    if(t.use_last==true)
	    {
		selStart	= t.last_selectionStart;
		selEnd		= t.last_selectionEnd;
		scrollTop	= t.last_scrollTop;
		scrollLeft	= t.last_scrollLeft;
		t.use_last=false;
	    }
	    else if( curPos == "auto" )
	    {
		try{
		    selStart	= t.selectionStart;
		    selEnd		= t.selectionEnd;
		    scrollTop	= t.scrollTop;
		    scrollLeft	= t.scrollLeft;
		    //alert(scrollTop);
		}catch(ex){}
	    }
	    
	    // set to good size
	    this.set_editarea_size_from_textarea(id, document.getElementById("frame_"+id));
	    t.style.display="none";			
	    document.getElementById("frame_"+id).style.display="inline";
	    area.execCommand("focus"); // without this focus opera doesn't manage well the iframe body height
	    
	    
	    // restore display values
	    editAreas[id]["displayed"]=true;
	    area.execCommand("update_size");
	    
	    f.document.getElementById("result").scrollTop= scrollTop;
	    f.document.getElementById("result").scrollLeft= scrollLeft;
	    area.area_select(selStart, selEnd-selStart);
	    area.execCommand("toggle_on");

	    
	}
	else
	{
	    /*	if(this.isIE)
		get_IE_selection(document.getElementById(id));	*/	
	    elem= document.getElementById(id);	
	    elem.last_selectionStart= elem.selectionStart;
	    elem.last_selectionEnd= elem.selectionEnd;
	    elem.last_scrollTop= elem.scrollTop;
	    elem.last_scrollLeft= elem.scrollLeft;
	    elem.use_last=true;
	    editAreaLoader.start(id);
	}
    },	
    
    set_editarea_size_from_textarea : function(id, frame){	
	var elem,width,height;
	elem	= document.getElementById(id);
	
	width	= Math.max(editAreas[id]["settings"]["min_width"], elem.offsetWidth)+"px";
	height	= Math.max(editAreas[id]["settings"]["min_height"], elem.offsetHeight)+"px";
	if(elem.style.width.indexOf("%")!=-1)
	    width	= elem.style.width;
	if(elem.style.height.indexOf("%")!=-1)
	    height	= elem.style.height;
	//alert("h: "+height+" w: "+width);
	
	frame.style.width= width;
	frame.style.height= height;
    },
    
    set_base_url : function(){
	var t=this,elems,i,docBasePath;

	if( !this.baseURL ){
	    elems = document.getElementsByTagName('script');
	    
	    for( i=0; i<elems.length; i++ ){
		if (elems[i].src && elems[i].src.match(/edit_area_[^\\\/]*$/i) ) {
		    var src = elems[i].src;
		    src = src.substring(0, src.lastIndexOf('/'));
		    this.baseURL = src;
		    this.file_name= elems[i].src.substr(elems[i].src.lastIndexOf("/")+1);
		    break;
		}
	    }
	}
	
	docBasePath	= document.location.href;
	if (docBasePath.indexOf('?') != -1)
	    docBasePath	= docBasePath.substring(0, docBasePath.indexOf('?'));
	docBasePath	= docBasePath.substring(0, docBasePath.lastIndexOf('/'));
	
	// If not HTTP absolute
	if (t.baseURL.indexOf('://') == -1 && t.baseURL.charAt(0) != '/') {
	    // If site absolute
	    t.baseURL = docBasePath + "/" + t.baseURL;
	}
	t.baseURL	+="/";	
    },
    
    get_button_html : function(id, img, exec, isFileSpecific, baseURL) {
	var cmd,html;
	if(!baseURL)
	    baseURL= this.baseURL;
	cmd	= 'editArea.execCommand(\'' + exec + '\')';
	html	= '<a id="a_'+ id +'" href="javascript:' + cmd + '" onclick="' + cmd + ';return false;" onmousedown="return false;" target="_self" fileSpecific="'+ (isFileSpecific?'yes':'no') +'">';
	html	+= '<img id="' + id + '" src="'+ baseURL +'images/' + img + '" title="{$' + id + '}" width="20" height="20" class="editAreaButtonNormal" onmouseover="editArea.switchClass(this,\'editAreaButtonOver\');" onmouseout="editArea.restoreClass(this);" onmousedown="editArea.restoreAndSwitchClass(this,\'editAreaButtonDown\');" /></a>';
	return html;
    },

    get_control_html : function(button_name, lang) {		
	var t=this,i,but,html,si;
	for (i=0; i<t.advanced_buttons.length; i++)
	{
	    but = t.advanced_buttons[i];			
	    if (but[0] == button_name)
	    {
		return t.get_button_html(but[0], but[1], but[2], but[3]);
	    }	
	}		
	
	switch (button_name){
	case "*":
	case "return":
	    return "<br />";
	case "|":
	case "separator":
	    return '<img src="'+ t.baseURL +'images/spacer.gif" width="1" height="15" class="editAreaSeparatorLine">';
	case "select_font":
	    html= "<select id='area_font_size' onchange='javascript:editArea.execCommand(\"change_font_size\")' fileSpecific='yes'>";
	    html+="<option value='-1'>{$font_size}</option>";
	    si=[8,9,10,11,12,14];
	    for( i=0;i<si.length;i++){
		html+="<option value='"+si[i]+"'>"+si[i]+" pt</option>";
	    }
	    html+="</select>";
	    return html;
	case "syntax_selection":
	    html= "<select id='syntax_selection' onchange='javascript:editArea.execCommand(\"change_syntax\", this.value)' fileSpecific='yes'>";
	    html+="<option value='-1'>{$syntax_selection}</option>";
	    html+="</select>";
	    return html;
	}
	
	return "<span id='tmp_tool_"+button_name+"'>["+button_name+"]</span>";		
    },
    
    
    get_template : function(){
	if(this.template=="")
	{
	    var xhr_object = null; 
	    if(window.XMLHttpRequest) // Firefox 
		xhr_object = new XMLHttpRequest(); 
	    else if(window.ActiveXObject) // Internet Explorer 
		xhr_object = new ActiveXObject("Microsoft.XMLHTTP"); 
	    else { // XMLHttpRequest not supported
		alert("XMLHTTPRequest not supported. EditArea not loaded"); 
		return; 
	    } 
	    
	    xhr_object.open("GET", this.baseURL+"template.html", false); 
	    xhr_object.send(null); 
	    if(xhr_object.readyState == 4) 
		this.template=xhr_object.responseText;
	    else
		this.has_error();
	}
    },
    
    // translate text
    translate : function(text, lang, mode){
	if(mode=="word")
	    text=editAreaLoader.get_word_translation(text, lang);
	else if(mode="template"){
	    editAreaLoader.current_language= lang;
	    text=text.replace(/\{\$([^\}]+)\}/gm, editAreaLoader.translate_template);
	}
	return text;
    },
    
    translate_template : function(){
	return editAreaLoader.get_word_translation(EditAreaLoader.prototype.translate_template.arguments[1], editAreaLoader.current_language);
    },
    
    get_word_translation : function(val, lang){
	var i;
	
	for( i in editAreaLoader.lang[lang]){
	    if(i == val)
		return editAreaLoader.lang[lang][i];
	}
	return "_"+val;
    },
    
    load_script : function(url){
	var t=this, d=document, script, head;
	
	if( t.loadedFiles[url] )
	    return;

	//alert("load: "+url);
	try{
	    script= d.createElement("script");
	    script.type= "text/javascript";
	    script.src= url;
	    script.charset= "UTF-8";
	    d.getElementsByTagName("head")[0].appendChild(script);
	}catch(e){
	    d.write('<sc'+'ript language="javascript" type="text/javascript" src="' + url + '" charset="UTF-8"></sc'+'ript>');
	}
	
	t.loadedFiles[url] = true;
    },
    
    add_event : function(obj, name, handler) {
	try{
	    if (obj.attachEvent) {
		obj.attachEvent("on" + name, handler);
	    } else{
		obj.addEventListener(name, handler, false);
	    }
	}catch(e){}
    },
    
    remove_event : function(obj, name, handler){
	try{
	    if (obj.detachEvent)
		obj.detachEvent("on" + name, handler);
	    else
		obj.removeEventListener(name, handler, false);
	}catch(e){}
    },


    // reset all the editareas in the form that have been reseted
    reset : function(e){
	var formObj,is_child,i,x;
	
	formObj = editAreaLoader.isIE ? window.event.srcElement : e.target;
	if(formObj.tagName!='FORM')
	    formObj= formObj.form;
	
	for( i in editAreas ){			
	    is_child= false;
	    for( x=0;x<formObj.elements.length;x++ ) {
		if(formObj.elements[x].id == i)
		    is_child=true;
	    }
	    
	    if(window.frames["frame_"+i] && is_child && editAreas[i]["displayed"]==true){
		
		window.setTimeout(function() {
                    window.frames['frame_'+ i].editArea.textarea.value = document.getElementById(i).value;
		    window.frames['frame_'+i].editArea.execCommand("focus");
		    window.frames['frame_'+i].editArea.check_line_selection();
		    window.frames['frame_'+i].editArea.execCommand("reset");
                }, 10);
	    }
	}		
	return;
    },
    
    
    // prepare all the textarea replaced by an editarea to be submited
    submit : function(e){		
	var formObj,is_child,fs=window.frames,i,x;
	formObj = editAreaLoader.isIE ? window.event.srcElement : e.target;
	if(formObj.tagName!='FORM')
	    formObj= formObj.form;
	
	for( i in editAreas){
	    is_child= false;
	    for( x=0;x<formObj.elements.length;x++ ) {
		if(formObj.elements[x].id == i)
		    is_child=true;
	    }
	    
	    if(is_child)
	    {
		if(fs["frame_"+i] && editAreas[i]["displayed"]==true)
		    document.getElementById(i).value= fs["frame_"+ i].editArea.textarea.value;
		editAreaLoader.execCommand(i,"EA_submit");
	    }
	}				
	if( typeof(formObj.edit_area_replaced_submit) == "function" ){
	    res= formObj.edit_area_replaced_submit();
	    if(res==false){
		if(editAreaLoader.isIE)
		    return false;
		else
		    e.preventDefault();
	    }
	}
	return;
    },
    
    // allow to get the value of the editarea
    getValue : function(id){
        if(window.frames["frame_"+id] && editAreas[id]["displayed"]==true){
            return window.frames["frame_"+ id].editArea.textarea.value;       
        }else if(elem=document.getElementById(id)){
            return elem.value;
        }
        return false;
    },
    
    // allow to set the value of the editarea
    setValue : function(id, new_val){
    	var fs=window.frames;
    	
        if( ( f=fs["frame_"+id] ) && editAreas[id]["displayed"]==true){
	    f.editArea.textarea.value= new_val;     
	    f.editArea.execCommand("focus"); 
	    f.editArea.check_line_selection(false);  
	    f.editArea.execCommand("onchange");
        }else if(elem=document.getElementById(id)){
            elem.value= new_val;
        }
    },
    
    // allow to get infos on the selection: array(start, end)
    getSelectionRange : function(id){
    	var sel,eA,fs=window.frames;
    	
    	sel= {"start": 0, "end": 0};
        if(fs["frame_"+id] && editAreas[id]["displayed"]==true){
            eA= fs["frame_"+ id].editArea;

	    sel["start"]	= eA.textarea.selectionStart;
	    sel["end"]		= eA.textarea.selectionEnd;
	    
        }else if( elem=document.getElementById(id) ){
            sel= getSelectionRange(elem);
        }
        return sel;
    },
    
    // allow to set the selection with the given start and end positions
    setSelectionRange : function(id, new_start, new_end){
    	var fs=window.frames;
    	
        if(fs["frame_"+id] && editAreas[id]["displayed"]==true){
            fs["frame_"+ id].editArea.area_select(new_start, new_end-new_start);  
	    // make an auto-scroll to the selection
	    if(!this.isIE){
		fs["frame_"+ id].editArea.check_line_selection(false); 
		fs["frame_"+ id].editArea.scroll_to_view();
	    }   
        }else if(elem=document.getElementById(id)){
            setSelectionRange(elem, new_start, new_end);
        }
    },
    
    getSelectedText : function(id){
    	var sel= this.getSelectionRange(id);
    	
        return this.getValue(id).substring(sel["start"], sel["end"]);
    },
    
    setSelectedText : function(id, new_val){
	var fs=window.frames,d=document,sel,text,scrollTop,scrollLeft,new_sel_end;
	
	new_val	= new_val.replace(/\r/g, ""); 
	sel		= this.getSelectionRange(id);
	text	= this.getValue(id);
	if(fs["frame_"+id] && editAreas[id]["displayed"]==true){
	    scrollTop	= fs["frame_"+ id].document.getElementById("result").scrollTop;
	    scrollLeft	= fs["frame_"+ id].document.getElementById("result").scrollLeft;
	}else{
	    scrollTop	= d.getElementById(id).scrollTop;
	    scrollLeft	= d.getElementById(id).scrollLeft;
	}
	
	text	= text.substring(0, sel["start"])+ new_val +text.substring(sel["end"]);
	this.setValue(id, text);
	new_sel_end	= sel["start"]+ new_val.length;
	this.setSelectionRange(id, sel["start"], new_sel_end);
	
	
	// fix \r problem for selection length count on IE & Opera
	if(new_val != this.getSelectedText(id).replace(/\r/g, "")){
	    this.setSelectionRange(id, sel["start"], new_sel_end+ new_val.split("\n").length -1);
	}
	// restore scrolling position
	if(fs["frame_"+id] && editAreas[id]["displayed"]==true){
	    fs["frame_"+ id].document.getElementById("result").scrollTop= scrollTop;
	    fs["frame_"+ id].document.getElementById("result").scrollLeft= scrollLeft;
	    fs["frame_"+ id].editArea.execCommand("onchange");
	}else{
	    d.getElementById(id).scrollTop= scrollTop;
	    d.getElementById(id).scrollLeft= scrollLeft;
	}
    },
    
    insertTags : function(id, open_tag, close_tag){
    	var old_sel,new_sel;
    	
    	old_sel	= this.getSelectionRange(id);
    	text	= open_tag + this.getSelectedText(id) + close_tag;
    	
	editAreaLoader.setSelectedText(id, text);
	
    	new_sel	= this.getSelectionRange(id);
    	if(old_sel["end"] > old_sel["start"])	// if text was selected, cursor at the end
    	    this.setSelectionRange(id, new_sel["end"], new_sel["end"]);
    	else // cursor in the middle
    	    this.setSelectionRange(id, old_sel["start"]+open_tag.length, old_sel["start"]+open_tag.length);
    },
    
    // hide both EditArea and normal textarea
    hide : function(id){
	var fs= window.frames,d=document,t=this,scrollTop,scrollLeft,span;
	if(d.getElementById(id) && !t.hidden[id])
	{
	    t.hidden[id]= {};
	    t.hidden[id]["selectionRange"]= t.getSelectionRange(id);
	    if(d.getElementById(id).style.display!="none")
	    {
		t.hidden[id]["scrollTop"]= d.getElementById(id).scrollTop;
		t.hidden[id]["scrollLeft"]= d.getElementById(id).scrollLeft;
	    }
	    
	    if(fs["frame_"+id])
	    {
		t.hidden[id]["toggle"]= editAreas[id]["displayed"];
		
		if(fs["frame_"+id] && editAreas[id]["displayed"]==true){
		    scrollTop	= fs["frame_"+ id].document.getElementById("result").scrollTop;
		    scrollLeft	= fs["frame_"+ id].document.getElementById("result").scrollLeft;
		}else{
		    scrollTop	= d.getElementById(id).scrollTop;
		    scrollLeft	= d.getElementById(id).scrollLeft;
		}
		t.hidden[id]["scrollTop"]= scrollTop;
		t.hidden[id]["scrollLeft"]= scrollLeft;
		
		if(editAreas[id]["displayed"]==true)
		    editAreaLoader.toggle_off(id);
	    }
	    
	    // hide toggle button and debug box
	    span= d.getElementById("EditAreaArroundInfos_"+id);
	    if(span){
		span.style.display='none';
	    }
	    
	    // hide textarea
	    d.getElementById(id).style.display= "none";
	}
    },
    
    // restore hidden EditArea and normal textarea
    show : function(id){
	var fs= window.frames,d=document,t=this,span;
	if((elem=d.getElementById(id)) && t.hidden[id])
	{
	    elem.style.display= "inline";
	    elem.scrollTop= t.hidden[id]["scrollTop"];
	    elem.scrollLeft= t.hidden[id]["scrollLeft"];
	    span= d.getElementById("EditAreaArroundInfos_"+id);
	    if(span){
		span.style.display='inline';
	    }
	    
	    if(fs["frame_"+id])
	    {
		
		// restore toggle button and debug box
		
		
		// restore textarea
		elem.style.display= "inline";
		
		// restore EditArea
		if(t.hidden[id]["toggle"]==true)
		    editAreaLoader.toggle_on(id);
		
		scrollTop	= t.hidden[id]["scrollTop"];
		scrollLeft	= t.hidden[id]["scrollLeft"];
		
		if(fs["frame_"+id] && editAreas[id]["displayed"]==true){
		    fs["frame_"+ id].document.getElementById("result").scrollTop	= scrollTop;
		    fs["frame_"+ id].document.getElementById("result").scrollLeft	= scrollLeft;
		}else{
		    elem.scrollTop	= scrollTop;
		    elem.scrollLeft	= scrollLeft;
		}
		
	    }
	    // restore selection
	    sel	= t.hidden[id]["selectionRange"];
	    t.setSelectionRange(id, sel["start"], sel["end"]);
	    delete t.hidden[id];	
	}
    },
    
    // get the current file datas (for multi file editing mode)
    getCurrentFile : function(id){
	return this.execCommand(id, 'get_file', this.execCommand(id, 'curr_file'));
    },
    
    // get the given file datas (for multi file editing mode)
    getFile : function(id, file_id){
	return this.execCommand(id, 'get_file', file_id);
    },
    
    // get all the openned files datas (for multi file editing mode)
    getAllFiles : function(id){
	return this.execCommand(id, 'get_all_files()');
    },
    
    // open a file (for multi file editing mode)
    openFile : function(id, file_infos){
	return this.execCommand(id, 'open_file', file_infos);
    },
    
    // close the given file (for multi file editing mode)
    closeFile : function(id, file_id){
	return this.execCommand(id, 'close_file', file_id);
    },
    
    // close the given file (for multi file editing mode)
    setFileEditedMode : function(id, file_id, to){
	var reg1,reg2;
	reg1	= new RegExp('\\\\', 'g');
	reg2	= new RegExp('"', 'g');
	return this.execCommand(id, 'set_file_edited_mode("'+ file_id.replace(reg1, '\\\\').replace(reg2, '\\"') +'", '+ to +')');
    },
    
    
    // allow to access to editarea functions and datas (for advanced users only)
    execCommand : function(id, cmd, fct_param){
	switch(cmd){
	case "EA_init":
	    if(editAreas[id]['settings']["EA_init_callback"].length>0)
		window[editAreas[id]['settings']["EA_init_callback"]](id);
	    break;
	case "EA_delete":
	    if(editAreas[id]['settings']["EA_delete_callback"].length>0)
		window[editAreas[id]['settings']["EA_delete_callback"]](id);
	    break;
	case "EA_submit":
	    if(editAreas[id]['settings']["submit_callback"].length>0)
		window[editAreas[id]['settings']["submit_callback"]](id);
	    break;
	}
        
        if(window.frames["frame_"+id] && window.frames["frame_"+ id].editArea){
	    if(fct_param!=undefined)
		return window.frames["frame_'+ id +'"].editArea[cmd](fct_param);
	    else
		return window.frames["frame_'+ id +'"].editArea[cmd];
        }
        return false;
    }
};

var editAreaLoader = new EditAreaLoader();
var editAreas = {};




======================================================================
FILE PATH: editor\editarea\edit_area\elements_functions.js
======================================================================
/****
 * This page contains some general usefull functions for javascript
 *
 ****/  
	
	
	// need to redefine this functiondue to IE problem
	function getAttribute( elm, aName ) {
		var aValue,taName,i;
		try{
			aValue = elm.getAttribute( aName );
		}catch(exept){}
		
		if( ! aValue ){
			for( i = 0; i < elm.attributes.length; i ++ ) {
				taName = elm.attributes[i] .name.toLowerCase();
				if( taName == aName ) {
					aValue = elm.attributes[i] .value;
					return aValue;
				}
			}
		}
		return aValue;
	};
	
	// need to redefine this function due to IE problem
	function setAttribute( elm, attr, val ) {
		if(attr=="class"){
			elm.setAttribute("className", val);
			elm.setAttribute("class", val);
		}else{
			elm.setAttribute(attr, val);
		}
	};
	
	/* return a child element
		elem: element we are searching in
		elem_type: type of the eleemnt we are searching (DIV, A, etc...)
		elem_attribute: attribute of the searched element that must match
		elem_attribute_match: value that elem_attribute must match
		option: "all" if must return an array of all children, otherwise return the first match element
		depth: depth of search (-1 or no set => unlimited)
	*/
	function getChildren(elem, elem_type, elem_attribute, elem_attribute_match, option, depth)
	{           
		if(!option)
			var option="single";
		if(!depth)
			var depth=-1;
		if(elem){
			var children= elem.childNodes;
			var result=null;
			var results= [];
			for (var x=0;x<children.length;x++) {
				strTagName = new String(children[x].tagName);
				children_class="?";
				if(strTagName!= "undefined"){
					child_attribute= getAttribute(children[x],elem_attribute);
					if((strTagName.toLowerCase()==elem_type.toLowerCase() || elem_type=="") && (elem_attribute=="" || child_attribute==elem_attribute_match)){
						if(option=="all"){
							results.push(children[x]);
						}else{
							return children[x];
						}
					}
					if(depth!=0){
						result=getChildren(children[x], elem_type, elem_attribute, elem_attribute_match, option, depth-1);
						if(option=="all"){
							if(result.length>0){
								results= results.concat(result);
							}
						}else if(result!=null){                                                                          
							return result;
						}
					}
				}
			}
			if(option=="all")
			   return results;
		}
		return null;
	};       
	
	function isChildOf(elem, parent){
		if(elem){
			if(elem==parent)
				return true;
			while(elem.parentNode != 'undefined'){
				return isChildOf(elem.parentNode, parent);
			}
		}
		return false;
	};
	
	function getMouseX(e){

		if(e!=null && typeof(e.pageX)!="undefined"){
			return e.pageX;
		}else{
			return (e!=null?e.x:event.x)+ document.documentElement.scrollLeft;
		}
	};
	
	function getMouseY(e){
		if(e!=null && typeof(e.pageY)!="undefined"){
			return e.pageY;
		}else{
			return (e!=null?e.y:event.y)+ document.documentElement.scrollTop;
		}
	};
	
	function calculeOffsetLeft(r){
		return calculeOffset(r,"offsetLeft")
	};
	
	function calculeOffsetTop(r){
		return calculeOffset(r,"offsetTop")
	};
	
	function calculeOffset(element,attr){
		var offset=0;
		while(element){
			offset+=element[attr];
			element=element.offsetParent
		}
		return offset;
	};
	
	/** return the computed style
	 *	@param: elem: the reference to the element
	 *	@param: prop: the name of the css property	 
	 */
	function get_css_property(elem, prop)
	{
		if(document.defaultView)
		{
			return document.defaultView.getComputedStyle(elem, null).getPropertyValue(prop);
		}
		else if(elem.currentStyle)
		{
			var prop = prop.replace(/-\D/gi, function(sMatch)
			{
				return sMatch.charAt(sMatch.length - 1).toUpperCase();
			});
			return elem.currentStyle[prop];
		}
		else return null;
	}
	
/****
 * Moving an element 
 ***/  
	
	var _mCE;	// currently moving element
	
	/* allow to move an element in a window
		e: the event
		id: the id of the element
		frame: the frame of the element 
		ex of use:
			in html:	<img id='move_area_search_replace' onmousedown='return parent.start_move_element(event,"area_search_replace", parent.frames["this_frame_id"]);' .../>  
		or
			in javascript: document.getElementById("my_div").onmousedown= start_move_element
	*/
	function start_move_element(e, id, frame){
		var elem_id=(e.target || e.srcElement).id;
		if(id)
			elem_id=id;		
		if(!frame)
			frame=window;
		if(frame.event)
			e=frame.event;
			
		_mCE= frame.document.getElementById(elem_id);
		_mCE.frame=frame;
		frame.document.onmousemove= move_element;
		frame.document.onmouseup= end_move_element;
		/*_mCE.onmousemove= move_element;
		_mCE.onmouseup= end_move_element;*/
		
		//alert(_mCE.frame.document.body.offsetHeight);
		
		mouse_x= getMouseX(e);
		mouse_y= getMouseY(e);
		//window.status=frame+ " elem: "+elem_id+" elem: "+ _mCE + " mouse_x: "+mouse_x;
		_mCE.start_pos_x = mouse_x - (_mCE.style.left.replace("px","") || calculeOffsetLeft(_mCE));
		_mCE.start_pos_y = mouse_y - (_mCE.style.top.replace("px","") || calculeOffsetTop(_mCE));
		return false;
	};
	
	function end_move_element(e){
		_mCE.frame.document.onmousemove= "";
		_mCE.frame.document.onmouseup= "";		
		_mCE=null;
	};
	
	function move_element(e){
		var newTop,newLeft,maxLeft;

		if( _mCE.frame && _mCE.frame.event )
			e=_mCE.frame.event;
		newTop	= getMouseY(e) - _mCE.start_pos_y;
		newLeft	= getMouseX(e) - _mCE.start_pos_x;
		
		maxLeft	= _mCE.frame.document.body.offsetWidth- _mCE.offsetWidth;
		max_top	= _mCE.frame.document.body.offsetHeight- _mCE.offsetHeight;
		newTop	= Math.min(Math.max(0, newTop), max_top);
		newLeft	= Math.min(Math.max(0, newLeft), maxLeft);
		
		_mCE.style.top	= newTop+"px";
		_mCE.style.left	= newLeft+"px";		
		return false;
	};
	
/***
 * Managing a textarea (this part need the navigator infos from editAreaLoader
 ***/ 
	
	var nav= editAreaLoader.nav;
	
	// allow to get infos on the selection: array(start, end)
	function getSelectionRange(textarea){
		return {"start": textarea.selectionStart, "end": textarea.selectionEnd};
	};
	
	// allow to set the selection
	function setSelectionRange(t, start, end){
		t.focus();
		
		start	= Math.max(0, Math.min(t.value.length, start));
		end		= Math.max(start, Math.min(t.value.length, end));
	
		if( this.isOpera && this.isOpera < 9.6 ){	// Opera bug when moving selection start and selection end
			t.selectionEnd = 1;	
			t.selectionStart = 0;			
			t.selectionEnd = 1;	
			t.selectionStart = 0;		
		}
		t.selectionStart	= start;
		t.selectionEnd		= end;		
		//textarea.setSelectionRange(start, end);
		
		if(isIE)
			set_IE_selection(t);
	};

	
	// set IE position in Firefox mode (textarea.selectionStart and textarea.selectionEnd). should work as a repeated task
	function get_IE_selection(t){
		var d=document,div,range,stored_range,elem,scrollTop,relative_top,line_start,line_nb,range_start,range_end,tab;
		if(t && t.focused)
		{	
			if(!t.ea_line_height)
			{	// calculate the lineHeight
				div= d.createElement("div");
				div.style.fontFamily= get_css_property(t, "font-family");
				div.style.fontSize= get_css_property(t, "font-size");
				div.style.visibility= "hidden";			
				div.innerHTML="0";
				d.body.appendChild(div);
				t.ea_line_height= div.offsetHeight;
				d.body.removeChild(div);
			}
			//t.focus();
			range = d.selection.createRange();
			try
			{
				stored_range = range.duplicate();
				stored_range.moveToElementText( t );
				stored_range.setEndPoint( 'EndToEnd', range );
				if(stored_range.parentElement() == t){
					// the range don't take care of empty lines in the end of the selection
					elem		= t;
					scrollTop	= 0;
					while(elem.parentNode){
						scrollTop+= elem.scrollTop;
						elem	= elem.parentNode;
					}
				
				//	var scrollTop= t.scrollTop + document.body.scrollTop;
					
				//	var relative_top= range.offsetTop - calculeOffsetTop(t) + scrollTop;
					relative_top= range.offsetTop - calculeOffsetTop(t)+ scrollTop;
				//	alert("rangeoffset: "+ range.offsetTop +"\ncalcoffsetTop: "+ calculeOffsetTop(t) +"\nrelativeTop: "+ relative_top);
					line_start	= Math.round((relative_top / t.ea_line_height) +1);
					
					line_nb		= Math.round(range.boundingHeight / t.ea_line_height);
					
					range_start	= stored_range.text.length - range.text.length;
					tab	= t.value.substr(0, range_start).split("\n");			
					range_start	+= (line_start - tab.length)*2;		// add missing empty lines to the selection
					t.selectionStart = range_start;
					
					range_end	= t.selectionStart + range.text.length;
					tab	= t.value.substr(0, range_start + range.text.length).split("\n");			
					range_end	+= (line_start + line_nb - 1 - tab.length)*2;
					t.selectionEnd = range_end;
				}
			}
			catch(e){}
		}
	    setTimeout(function() {
                get_IE_selection(document.getElementById(t.id));
            }, 50);
	};
	
	function IE_textarea_focus(){
		event.srcElement.focused= true;
	}
	
	function IE_textarea_blur(){
		event.srcElement.focused= false;
	}
	
	// select the text for IE (take into account the \r difference)
	function set_IE_selection( t ){
		var nbLineStart,nbLineStart,nbLineEnd,range;
		if(!window.closed){ 
			nbLineStart=t.value.substr(0, t.selectionStart).split("\n").length - 1;
			nbLineEnd=t.value.substr(0, t.selectionEnd).split("\n").length - 1;
			try
			{
				range = document.selection.createRange();
				range.moveToElementText( t );
				range.setEndPoint( 'EndToStart', range );
				range.moveStart('character', t.selectionStart - nbLineStart);
				range.moveEnd('character', t.selectionEnd - nbLineEnd - (t.selectionStart - nbLineStart)  );
				range.select();
			}
			catch(e){}
		}
	};
	
	
	editAreaLoader.waiting_loading["elements_functions.js"]= "loaded";



======================================================================
FILE PATH: editor\editarea\edit_area\highlight.js
======================================================================
	// change_to: "on" or "off"
	EditArea.prototype.change_highlight= function(change_to){
		if(this.settings["syntax"].length==0 && change_to==false){
			this.switchClassSticky(_$("highlight"), 'editAreaButtonDisabled', true);
			this.switchClassSticky(_$("reset_highlight"), 'editAreaButtonDisabled', true);
			return false;
		}
		
		if(this.do_highlight==change_to)
			return false;
	
			
		this.getIESelection();
		var pos_start= this.textarea.selectionStart;
		var pos_end= this.textarea.selectionEnd;
		
		if(this.do_highlight===true || change_to==false)
			this.disable_highlight();
		else
			this.enable_highlight();
		this.textarea.focus();
		this.textarea.selectionStart = pos_start;
		this.textarea.selectionEnd = pos_end;
		this.setIESelection();
				
	};
	
	EditArea.prototype.disable_highlight= function(displayOnly){
		var t= this, a=t.textarea, new_Obj, old_class, new_class;
			
		t.selection_field.innerHTML="";
		t.selection_field_text.innerHTML="";
		t.content_highlight.style.visibility="hidden";
		// replacing the node is far more faster than deleting it's content in firefox
		new_Obj= t.content_highlight.cloneNode(false);
		new_Obj.innerHTML= "";			
		t.content_highlight.parentNode.insertBefore(new_Obj, t.content_highlight);
		t.content_highlight.parentNode.removeChild(t.content_highlight);	
		t.content_highlight= new_Obj;
		old_class= parent.getAttribute( a,"class" );
		if(old_class){
			new_class= old_class.replace( "hidden","" );
			parent.setAttribute( a, "class", new_class );
		}
	
		a.style.backgroundColor="transparent";	// needed in order to see the bracket finders
		
		//var icon= document.getElementById("highlight");
		//setAttribute(icon, "class", getAttribute(icon, "class").replace(/ selected/g, "") );
		//t.restoreClass(icon);
		//t.switchClass(icon,'editAreaButtonNormal');
		t.switchClassSticky(_$("highlight"), 'editAreaButtonNormal', true);
		t.switchClassSticky(_$("reset_highlight"), 'editAreaButtonDisabled', true);
	
		t.do_highlight=false;
	
		t.switchClassSticky(_$("change_smooth_selection"), 'editAreaButtonSelected', true);
		if(typeof(t.smooth_selection_before_highlight)!="undefined" && t.smooth_selection_before_highlight===false){
			t.change_smooth_selection_mode(false);
		}
		
	//	this.textarea.style.backgroundColor="#FFFFFF";
	};

	EditArea.prototype.enable_highlight= function(){
		var t=this, a=t.textarea, new_class;
		t.show_waiting_screen();
			
		t.content_highlight.style.visibility="visible";
		new_class	=parent.getAttribute(a,"class")+" hidden";
		parent.setAttribute( a, "class", new_class );
		
		// IE can't manage mouse click outside text range without this
		if( t.isIE )
			a.style.backgroundColor="#FFFFFF";	

		t.switchClassSticky(_$("highlight"), 'editAreaButtonSelected', false);
		t.switchClassSticky(_$("reset_highlight"), 'editAreaButtonNormal', false);
		
		t.smooth_selection_before_highlight=t.smooth_selection;
		if(!t.smooth_selection)
			t.change_smooth_selection_mode(true);
		t.switchClassSticky(_$("change_smooth_selection"), 'editAreaButtonDisabled', true);
		
		
		t.do_highlight=true;
		t.resync_highlight();
					
		t.hide_waiting_screen();	
	};
	
	/**
	 * Ask to update highlighted text
	 * @param Array infos - Array of datas returned by EditArea.get_selection_infos()
	 */
	EditArea.prototype.maj_highlight= function(infos){
		// for speed mesure
		var debug_opti="",tps_start= new Date().getTime(), tps_middle_opti=new Date().getTime();
		var t=this, hightlighted_text, updated_highlight;	
		var textToHighlight=infos["full_text"], doSyntaxOpti = false, doHtmlOpti = false, stay_begin="", stay_end="", trace_new , trace_last;
		
		if(t.last_text_to_highlight==infos["full_text"] && t.resync_highlight!==true)
			return;
					
		//  OPTIMISATION: will search to update only changed lines
		if(t.reload_highlight===true){
			t.reload_highlight=false;
		}else if(textToHighlight.length==0){
			textToHighlight="\n ";
		}else{
			// get text change datas
			changes = t.checkTextEvolution(t.last_text_to_highlight,textToHighlight);
			
			// check if it can only reparse the changed text
			trace_new		= t.get_syntax_trace(changes.newTextLine).replace(/\r/g, '');
			trace_last		= t.get_syntax_trace(changes.lastTextLine).replace(/\r/g, '');
			doSyntaxOpti	= ( trace_new == trace_last );
			
			// check if the difference comes only from a new line created 
			// => we have to remember that the editor can automaticaly add tabulation or space after the new line) 
			if( !doSyntaxOpti && trace_new == "\n"+trace_last && /^[ \t\s]*\n[ \t\s]*$/.test( changes.newText.replace(/\r/g, '') ) && changes.lastText =="" )
			{
				doSyntaxOpti	= true;
			}
			
			// we do the syntax optimisation
			if( doSyntaxOpti ){
						
				tps_middle_opti=new Date().getTime();	
			
				stay_begin= t.last_hightlighted_text.split("\n").slice(0, changes.lineStart).join("\n");
				if(changes.lineStart>0)
					stay_begin+= "\n";
				stay_end= t.last_hightlighted_text.split("\n").slice(changes.lineLastEnd+1).join("\n");
				if(stay_end.length>0)
					stay_end= "\n"+stay_end;
					
				// Final check to see that we're not in the middle of span tags
				if( stay_begin.split('<span').length != stay_begin.split('</span').length 
					|| stay_end.split('<span').length != stay_end.split('</span').length )
				{
					doSyntaxOpti	= false;
					stay_end		= '';
					stay_begin		= '';
				}
				else
				{
					if(stay_begin.length==0 && changes.posLastEnd==-1)
						changes.newTextLine+="\n";
					textToHighlight=changes.newTextLine;
				}
			}
			if(t.settings["debug"]){
				var ch =changes;
				debug_opti= ( doSyntaxOpti?"Optimisation": "No optimisation" )
					+" start: "+ch.posStart +"("+ch.lineStart+")"
					+" end_new: "+ ch.posNewEnd+"("+ch.lineNewEnd+")"
					+" end_last: "+ ch.posLastEnd+"("+ch.lineLastEnd+")"
					+"\nchanged_text: "+ch.newText+" => trace: "+trace_new
					+"\nchanged_last_text: "+ch.lastText+" => trace: "+trace_last
					//debug_opti+= "\nchanged: "+ infos["full_text"].substring(ch.posStart, ch.posNewEnd);
					+ "\nchanged_line: "+ch.newTextLine
					+ "\nlast_changed_line: "+ch.lastTextLine
					+"\nstay_begin: "+ stay_begin.slice(-100)
					+"\nstay_end: "+ stay_end.substr( 0, 100 );
					//debug_opti="start: "+stay_begin_len+ "("+nb_line_start_unchanged+") end: "+ (stay_end_len)+ "("+(splited.length-nb_line_end_unchanged)+") ";
					//debug_opti+="changed: "+ textToHighlight.substring(stay_begin_len, textToHighlight.length-stay_end_len)+" \n";
					
					//debug_opti+="changed: "+ stay_begin.substr(stay_begin.length-200)+ "----------"+ textToHighlight+"------------------"+ stay_end.substr(0,200) +"\n";
					+"\n";
			}
	
			
			// END OPTIMISATION
		}

		tps_end_opti	= new Date().getTime();	
				
		// apply highlight
		updated_highlight	= t.colorize_text(textToHighlight);
		tpsAfterReg			= new Date().getTime();
		
		/***
		 * see if we can optimize for updating only the required part of the HTML code
		 * 
		 * The goal here will be to find the text node concerned by the modification and to update it
		 */
		//-------------------------------------------
		// 
		if( doSyntaxOpti )
		{
			try
			{
				var replacedBloc, i, nbStart = '', nbEnd = '', newHtml, lengthOld, lengthNew;
				replacedBloc		= t.last_hightlighted_text.substring( stay_begin.length, t.last_hightlighted_text.length - stay_end.length );
				
				lengthOld	= replacedBloc.length;
				lengthNew	= updated_highlight.length;
				
				// find the identical caracters at the beginning
				for( i=0; i < lengthOld && i < lengthNew && replacedBloc.charAt(i) == updated_highlight.charAt(i) ; i++ )
				{
				}
				nbStart = i;
				// find the identical caracters at the end
				for( i=0; i + nbStart < lengthOld && i + nbStart < lengthNew && replacedBloc.charAt(lengthOld-i-1) == updated_highlight.charAt(lengthNew-i-1) ; i++ )
				{
				}
				nbEnd	= i;
				
				// get the changes
				lastHtml	= replacedBloc.substring( nbStart, lengthOld - nbEnd );
				newHtml		= updated_highlight.substring( nbStart, lengthNew - nbEnd );
				
				
				// We can do the optimisation only if we havn't touch to span elements
				if( newHtml.indexOf('<span') == -1 && newHtml.indexOf('</span') == -1 
					&& lastHtml.indexOf('<span') == -1 && lastHtml.indexOf('</span') == -1 )
				{
					var beginStr, nbOpendedSpan, nbClosedSpan, nbUnchangedChars, span, textNode;
					doHtmlOpti		= true;
					beginStr		= t.last_hightlighted_text.substr( 0, stay_begin.length + nbStart );
			
					nbOpendedSpan	= beginStr.split('<span').length - 1;
					nbClosedSpan	= beginStr.split('</span').length - 1;
					// retrieve the previously opened span (Add 1 for the first level span?)
					span 			= t.content_highlight.getElementsByTagName('span')[ nbOpendedSpan ];
					
					//--------[
					// get the textNode to update
					
					// if we're inside a span, we'll take the one that is opened (can be a parent of the current span)
					parentSpan		= span;
					maxStartOffset	= maxEndOffset = 0;
					
					// it will be in the child of the root node 
					if( nbOpendedSpan == nbClosedSpan )
					{
						while( parentSpan.parentNode != t.content_highlight && parentSpan.parentNode.tagName != 'PRE' )
						{
							parentSpan	= parentSpan.parentNode;
						}
					}
					// get the last opened span
					else
					{
						maxStartOffset	= maxEndOffset = beginStr.length + 1;
						// move to parent node for each closed span found after the lastest open span
						nbClosed = beginStr.substr( Math.max( 0, beginStr.lastIndexOf( '<span', maxStartOffset - 1 ) ) ).split('</span').length - 1;
						while( nbClosed > 0 )
						{
							nbClosed--;
							parentSpan = parentSpan.parentNode;
						}
						
						// find the position of the last opended tag
						while( parentSpan.parentNode != t.content_highlight && parentSpan.parentNode.tagName != 'PRE' && ( tmpMaxStartOffset = Math.max( 0, beginStr.lastIndexOf( '<span', maxStartOffset - 1 ) ) ) < ( tmpMaxEndOffset = Math.max( 0, beginStr.lastIndexOf( '</span', maxEndOffset - 1 ) ) ) )
						{
							maxStartOffset	= tmpMaxStartOffset;
							maxEndOffset	= tmpMaxEndOffset;
						}
					}
					// Note: maxEndOffset is no more used but maxStartOffset will be used
					
					if( parentSpan.parentNode == t.content_highlight || parentSpan.parentNode.tagName == 'PRE' )
					{
						maxStartOffset	= Math.max( 0, beginStr.indexOf( '<span' ) );
					}
					
					// find the matching text node (this will be one that will be at the end of the beginStr
					if( maxStartOffset == beginStr.length )
					{
						nbSubSpanBefore	= 0;
					}
					else
					{
						lastEndPos 				= Math.max( 0, beginStr.lastIndexOf( '>', maxStartOffset ) );
		
						// count the number of sub spans
						nbSubSpanBefore			= beginStr.substr( lastEndPos ).split('<span').length-1;
					}
					
					// there is no sub-span before
					if( nbSubSpanBefore == 0 )
					{
						textNode	= parentSpan.firstChild;
					}
					// we need to find where is the text node modified
					else
					{
						// take the last direct child (no sub-child)
						lastSubSpan	= parentSpan.getElementsByTagName('span')[ nbSubSpanBefore - 1 ];
						while( lastSubSpan.parentNode != parentSpan )
						{
							lastSubSpan	= lastSubSpan.parentNode;
						}

						// associate to next text node following the last sub span
						if( lastSubSpan.nextSibling == null || lastSubSpan.nextSibling.nodeType != 3 )
						{
							textNode	= document.createTextNode('');
							lastSubSpan.parentNode.insertBefore( textNode, lastSubSpan.nextSibling );
						}
						else
						{
							textNode	= lastSubSpan.nextSibling;
						}
					}
					//--------]
					
					
					//--------[
					// update the textNode content
					
					// number of caracters after the last opened of closed span
					nbUnchangedChars = beginStr.length - Math.max( 0, beginStr.lastIndexOf( '>' ) + 1 );
					
					//	console.log( span, textNode, nbOpendedSpan,nbClosedSpan,  span.nextSibling, textNode.length, nbUnchangedChars, lastHtml, lastHtml.length, newHtml, newHtml.length );
					//	alert( textNode.parentNode.className +'-'+ textNode.parentNode.tagName+"\n"+ textNode.data +"\n"+ nbUnchangedChars +"\n"+ lastHtml.length +"\n"+ newHtml +"\n"+ newHtml.length  );
					
					// IE only manage \r for cariage return in textNode and not \n or \r\n
					if( t.isIE )
					{
						nbUnchangedChars	-= ( beginStr.substr( beginStr.length - nbUnchangedChars ).split("\n").length - 1 );
						//alert( textNode.data.replace(/\r/g, '_r').replace(/\n/g, '_n')); 
						textNode.replaceData( nbUnchangedChars, lastHtml.replace(/\n/g, '').length, newHtml.replace(/\n/g, '') );
					}
					else
					{
						textNode.replaceData( nbUnchangedChars, lastHtml.length, newHtml );
					}
					//--------]
				}
			}
			// an exception shouldn't occured but if replaceData failed at least it won't break everything
			catch( e )
			{
		//		throw e;
		//		console.log( e );
				doHtmlOpti	= false;
			}
			
		}
		/*** END HTML update's optimisation ***/
		// end test
		
	//			console.log(  (TPS6-TPS5), (TPS5-TPS4), (TPS4-TPS3), (TPS3-TPS2), (TPS2-TPS1), _CPT );
		// get the new highlight content
		tpsAfterOpti2		= new Date().getTime();
		hightlighted_text	= stay_begin + updated_highlight + stay_end;
		if( !doHtmlOpti )
		{
			// update the content of the highlight div by first updating a clone node (as there is no display in the same time for t node it's quite faster (5*))
			var new_Obj= t.content_highlight.cloneNode(false);
			if( ( t.isIE && t.isIE < 8 ) || ( t.isOpera && t.isOpera < 9.6 ) )
				new_Obj.innerHTML= "<pre><span class='"+ t.settings["syntax"] +"'>" + hightlighted_text + "</span></pre>";	
			else
				new_Obj.innerHTML= "<span class='"+ t.settings["syntax"] +"'>"+ hightlighted_text +"</span>";
	
			t.content_highlight.parentNode.replaceChild(new_Obj, t.content_highlight);
		
			t.content_highlight= new_Obj;
		}
		
		t.last_text_to_highlight= infos["full_text"];
		t.last_hightlighted_text= hightlighted_text;
		
		tps3=new Date().getTime();
	
		if(t.settings["debug"]){
			//lineNumber=tab_text.length;
			//t.debug.value+=" \nNB char: "+_$("src").value.length+" Nb line: "+ lineNumber;
		
			t.debug.value= "Tps optimisation "+(tps_end_opti-tps_start)
				+" | tps reg exp: "+ (tpsAfterReg-tps_end_opti)
				+" | tps opti HTML : "+ (tpsAfterOpti2-tpsAfterReg) + ' '+ ( doHtmlOpti ? 'yes' : 'no' )
				+" | tps update highlight content: "+ (tps3-tpsAfterOpti2)
				+" | tpsTotal: "+ (tps3-tps_start)
				+ "("+tps3+")\n"+ debug_opti;
		//	t.debug.value+= "highlight\n"+hightlighted_text;*/
		}
		
	};
	
	EditArea.prototype.resync_highlight= function(reload_now){
		this.reload_highlight=true;
		this.last_text_to_highlight="";
		this.focus();		
		if(reload_now)
			this.check_line_selection(false); 
	};	



======================================================================
FILE PATH: editor\editarea\edit_area\keyboard.js
======================================================================
var EA_keys = {8:"Retour arriere",9:"Tabulation",12:"Milieu (pave numerique)",13:"Entrer",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",20:"Verr Maj",27:"Esc",32:"Space",33:"Page up",34:"Page down",35:"End",36:"Begin",37:"Left",38:"Up",39:"Right",40:"Down",44:"Impr ecran",45:"Inser",46:"Suppr",91:"Menu Demarrer Windows / touche pomme Mac",92:"Menu Demarrer Windows",93:"Menu contextuel Windows",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"Verr Num",145:"Arret defil"};



function keyDown(e){
    if(!e){	// if IE
	e=event;
    }
    
    // send the event to the plugins
    for(var i in editArea.plugins){
	if(typeof(editArea.plugins[i].onkeydown)=="function"){
	    if(editArea.plugins[i].onkeydown(e)===false){ // stop propaging
		if(editArea.isIE)
		    e.keyCode=0;
		return false;
	    }
	}
    }

    var target_id=(e.target || e.srcElement).id;
    var use=false;
    if (EA_keys[e.keyCode])
	letter=EA_keys[e.keyCode];
    else
	letter=String.fromCharCode(e.keyCode);
    
    var low_letter= letter.toLowerCase();
    
    if(letter=="Page up" && !editArea.isOpera){
	editArea.execCommand("scroll_page", {"dir": "up", "shift": ShiftPressed(e)});
	use=true;
    }else if(letter=="Page down" && !editArea.isOpera){
	editArea.execCommand("scroll_page", {"dir": "down", "shift": ShiftPressed(e)});
	use=true;
    }else if(editArea.is_editable==false){
	// do nothing but also do nothing else (allow to navigate with page up and page down)
	return true;
    }else if(letter=="Tabulation" && target_id=="textarea" && !CtrlPressed(e) && !AltPressed(e)){	
	if(ShiftPressed(e))
	    editArea.execCommand("invert_tab_selection");
	else
	    editArea.execCommand("tab_selection");
	
	use=true;
	if(editArea.isOpera || (editArea.isFirefox && editArea.isMac) )	// opera && firefox mac can't cancel tabulation events...
	    setTimeout(function() {
                editArea.execCommand('focus');
            }, 1);
    }else if(letter=="Entrer" && target_id=="textarea"){
	if(editArea.press_enter())
	    use=true;
    }else if(letter=="Entrer" && target_id=="area_search"){
	editArea.execCommand("area_search");
	use=true;
    }else  if(letter=="Esc"){
	editArea.execCommand("close_all_inline_popup", e);
	use=true;
    }else if(CtrlPressed(e) && !AltPressed(e) && !ShiftPressed(e)){
	switch(low_letter){
	case "f":				
	    editArea.execCommand("area_search");
	    use=true;
	    break;
	case "r":
	    editArea.execCommand("area_replace");
	    use=true;
	    break;
	case "q":
	    editArea.execCommand("close_all_inline_popup", e);
	    use=true;
	    break;
	case "h":
	    editArea.execCommand("change_highlight");			
	    use=true;
	    break;
	case "g":
	    setTimeout(function() {
                editArea.execCommand('go_to_line');
            }, 5);	// the prompt stop the return false otherwise
	    use=true;
	    break;
	case "e":
	    editArea.execCommand("show_help");
	    use=true;
	    break;
	case "z":
	    use=true;
	    editArea.execCommand("undo");
	    break;
	case "y":
	    use=true;
	    editArea.execCommand("redo");
	    break;
	default:
	    break;			
	}		
    }		
    
    // check to disable the redo possibility if the textarea content change
    if(editArea.next.length > 0){
	setTimeout(function() {
            editArea.check_redo();
        }, 10);
    }
    
    setTimeout(function() {
        editArea.check_file_changes();
    }, 10);
    
    
    if(use){
	// in case of a control that sould'nt be used by IE but that is used => THROW a javascript error that will stop key action
	if(editArea.isIE)
	    e.keyCode=0;
	return false;
    }
    //alert("Test: "+ letter + " ("+e.keyCode+") ALT: "+ AltPressed(e) + " CTRL "+ CtrlPressed(e) + " SHIFT "+ ShiftPressed(e));
    
    return true;
    
};


// return true if Alt key is pressed
function AltPressed(e) {
    if (window.event) {
	return (window.event.altKey);
    } else {
	if(e.modifiers)
	    return (e.altKey || (e.modifiers % 2));
	else
	    return e.altKey;
    }
};

// return true if Ctrl key is pressed
function CtrlPressed(e) {
    if (window.event) {
	return (window.event.ctrlKey);
    } else {
	return (e.ctrlKey || (e.modifiers==2) || (e.modifiers==3) || (e.modifiers>5));
    }
};

// return true if Shift key is pressed
function ShiftPressed(e) {
    if (window.event) {
	return (window.event.shiftKey);
    } else {
	return (e.shiftKey || (e.modifiers>3));
    }
};



======================================================================
FILE PATH: editor\editarea\edit_area\manage_area.js
======================================================================
EditArea.prototype.focus = function() {
    this.textarea.focus();
    this.textareaFocused=true;
};


EditArea.prototype.check_line_selection= function(timer_checkup){
    var changes, infos, new_top, new_width,i;
    
    var t1=t2=t2_1=t3=tLines=tend= new Date().getTime();
    // l'editeur n'existe plus => on quitte
    if(!editAreas[this.id])
	return false;
    
    if(!this.smooth_selection && !this.do_highlight)
    {
	//do nothing
    }
    else if(this.textareaFocused && editAreas[this.id]["displayed"]==true && this.isResizing==false)
    {
	infos	= this.get_selection_infos();
	changes	= this.checkTextEvolution( typeof( this.last_selection['full_text'] ) == 'undefined' ? '' : this.last_selection['full_text'], infos['full_text'] );
	
	t2= new Date().getTime();
	
	// if selection change
	if(this.last_selection["line_start"] != infos["line_start"] || this.last_selection["line_nb"] != infos["line_nb"] || infos["full_text"] != this.last_selection["full_text"] || this.reload_highlight || this.last_selection["selectionStart"] != infos["selectionStart"] || this.last_selection["selectionEnd"] != infos["selectionEnd"] || !timer_checkup )
	{
	    // move and adjust text selection elements
	    new_top		= this.getLinePosTop( infos["line_start"] );
	    new_width	= Math.max(this.textarea.scrollWidth, this.container.clientWidth -50);
	    this.selection_field.style.top=this.selection_field_text.style.top=new_top+"px";
	    if(!this.settings['word_wrap']){	
		this.selection_field.style.width=this.selection_field_text.style.width=this.test_font_size.style.width=new_width+"px";
	    }
	    
	    // usefull? => _$("cursor_pos").style.top=new_top+"px";	
	    
	    if(this.do_highlight==true)
	    {
		// fill selection elements
		var curr_text	= infos["full_text"].split("\n");
		var content		= "";
		//alert("length: "+curr_text.length+ " i: "+ Math.max(0,infos["line_start"]-1)+ " end: "+Math.min(curr_text.length, infos["line_start"]+infos["line_nb"]-1)+ " line: "+infos["line_start"]+" [0]: "+curr_text[0]+" [1]: "+curr_text[1]);
		var start		= Math.max(0,infos["line_start"]-1);
		var end			= Math.min(curr_text.length, infos["line_start"]+infos["line_nb"]-1);
		
		//curr_text[start]= curr_text[start].substr(0,infos["curr_pos"]-1) +"¤_overline_¤"+ curr_text[start].substr(infos["curr_pos"]-1);
		for(i=start; i< end; i++){
		    content+= curr_text[i]+"\n";	
		}
		
		// add special chars arround selected characters
		selLength	= infos['selectionEnd'] - infos['selectionStart'];
		content		= content.substr( 0, infos["curr_pos"] - 1 ) + "\r\r" + content.substr( infos["curr_pos"] - 1, selLength ) + "\r\r" + content.substr( infos["curr_pos"] - 1 + selLength );
		content		= '<span>'+ content.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace("\r\r", '</span><strong>').replace("\r\r", '</strong><span>') +'</span>';
		
		if( this.isIE || ( this.isOpera && this.isOpera < 9.6 ) ) {
		    this.selection_field.innerHTML= "<pre>" + content.replace(/^\r?\n/, "<br>") + "</pre>";
		} else {
		    this.selection_field.innerHTML= content;
		}
		this.selection_field_text.innerHTML = this.selection_field.innerHTML;
		t2_1 = new Date().getTime();
		// check if we need to update the highlighted background 
		if(this.reload_highlight || (infos["full_text"] != this.last_text_to_highlight && (this.last_selection["line_start"]!=infos["line_start"] || this.show_line_colors || this.settings['word_wrap'] || this.last_selection["line_nb"]!=infos["line_nb"] || this.last_selection["nb_line"]!=infos["nb_line"]) ) )
		{
		    this.maj_highlight(infos);
		}
	    }		
	}
	t3= new Date().getTime();
	
	// manage line heights
	if( this.settings['word_wrap'] && infos["full_text"] != this.last_selection["full_text"])
	{
	    // refresh only 1 line if text change concern only one line and that the total line number has not changed
	    if( changes.newText.split("\n").length == 1 && this.last_selection['nb_line'] && infos['nb_line'] == this.last_selection['nb_line'] )
	    {
		this.fixLinesHeight( infos['full_text'], changes.lineStart, changes.lineStart );
	    }
	    else
	    {
		this.fixLinesHeight( infos['full_text'], changes.lineStart, -1 );
	    }
	}
	
	tLines= new Date().getTime();
	// manage bracket finding
	if( infos["line_start"] != this.last_selection["line_start"] || infos["curr_pos"] != this.last_selection["curr_pos"] || infos["full_text"].length!=this.last_selection["full_text"].length || this.reload_highlight || !timer_checkup )
	{
	    // move _cursor_pos
	    var selec_char= infos["curr_line"].charAt(infos["curr_pos"]-1);
	    var no_real_move=true;
	    if(infos["line_nb"]==1 && (this.assocBracket[selec_char] || this.revertAssocBracket[selec_char]) ){
		
		no_real_move=false;					
		//findEndBracket(infos["line_start"], infos["curr_pos"], selec_char);
		if(this.findEndBracket(infos, selec_char) === true){
		    _$("end_bracket").style.visibility	="visible";
		    _$("cursor_pos").style.visibility	="visible";
		    _$("cursor_pos").innerHTML			= selec_char;
		    _$("end_bracket").innerHTML			= (this.assocBracket[selec_char] || this.revertAssocBracket[selec_char]);
		}else{
		    _$("end_bracket").style.visibility	="hidden";
		    _$("cursor_pos").style.visibility	="hidden";
		}
	    }else{
		_$("cursor_pos").style.visibility	="hidden";
		_$("end_bracket").style.visibility	="hidden";
	    }
	    //alert("move cursor");
	    this.displayToCursorPosition("cursor_pos", infos["line_start"], infos["curr_pos"]-1, infos["curr_line"], no_real_move);
	    if(infos["line_nb"]==1 && infos["line_start"]!=this.last_selection["line_start"])
		this.scroll_to_view();
	}
	this.last_selection=infos;
    }
    
    tend= new Date().getTime();
    //if( (tend-t1) > 7 )
    //	console.log( "tps total: "+ (tend-t1) + " tps get_infos: "+ (t2-t1)+ " tps selec: "+ (t2_1-t2)+ " tps highlight: "+ (t3-t2_1) +" tps lines: "+ (tLines-t3) +" tps cursor+lines: "+ (tend-tLines)+" \n" );
    
    
    if(timer_checkup){
	setTimeout(function() {
            editArea.check_line_selection(true);
        }, this.check_line_selection_timer);
    }
};


EditArea.prototype.get_selection_infos= function(){
    var sel={}, start, end, len, str;
    
    this.getIESelection();
    start	= this.textarea.selectionStart;
    end		= this.textarea.selectionEnd;		
    
    if( this.last_selection["selectionStart"] == start && this.last_selection["selectionEnd"] == end && this.last_selection["full_text"] == this.textarea.value )
    {	
	return this.last_selection;
    }
    
    if(this.tabulation!="\t" && this.textarea.value.indexOf("\t")!=-1) 
    {	// can append only after copy/paste 
	len		= this.textarea.value.length;
	this.textarea.value	= this.replace_tab(this.textarea.value);
	start	= end	= start+(this.textarea.value.length-len);
	this.area_select( start, 0 );
    }
    
    sel["selectionStart"]	= start;
    sel["selectionEnd"]		= end;		
    sel["full_text"]		= this.textarea.value;
    sel["line_start"]		= 1;
    sel["line_nb"]			= 1;
    sel["curr_pos"]			= 0;
    sel["curr_line"]		= "";
    sel["indexOfCursor"]	= 0;
    sel["selec_direction"]	= this.last_selection["selec_direction"];

    //return sel;	
    var splitTab= sel["full_text"].split("\n");
    var nbLine	= Math.max(0, splitTab.length);		
    var nbChar	= Math.max(0, sel["full_text"].length - (nbLine - 1));	// (remove \n caracters from the count)
    if( sel["full_text"].indexOf("\r") != -1 )
	nbChar	= nbChar - ( nbLine - 1 );		// (remove \r caracters from the count)
    sel["nb_line"]	= nbLine;		
    sel["nb_char"]	= nbChar;
    
    if(start>0){
	str					= sel["full_text"].substr(0,start);
	sel["curr_pos"]		= start - str.lastIndexOf("\n");
	sel["line_start"]	= Math.max(1, str.split("\n").length);
    }else{
	sel["curr_pos"]=1;
    }
    if(end>start){
	sel["line_nb"]=sel["full_text"].substring(start,end).split("\n").length;
    }
    sel["indexOfCursor"]=start;		
    sel["curr_line"]=splitTab[Math.max(0,sel["line_start"]-1)];
    
    // determine in which direction the selection grow
    if(sel["selectionStart"] == this.last_selection["selectionStart"]){
	if(sel["selectionEnd"]>this.last_selection["selectionEnd"])
	    sel["selec_direction"]= "down";
	else if(sel["selectionEnd"] == this.last_selection["selectionStart"])
	    sel["selec_direction"]= this.last_selection["selec_direction"];
    }else if(sel["selectionStart"] == this.last_selection["selectionEnd"] && sel["selectionEnd"]>this.last_selection["selectionEnd"]){
	sel["selec_direction"]= "down";
    }else{
	sel["selec_direction"]= "up";
    }
    
    _$("nbLine").innerHTML	= nbLine;		
    _$("nbChar").innerHTML	= nbChar;		
    _$("linePos").innerHTML	= sel["line_start"];
    _$("currPos").innerHTML	= sel["curr_pos"];

    return sel;		
};

// set IE position in Firefox mode (textarea.selectionStart and textarea.selectionEnd)
EditArea.prototype.getIESelection= function(){
    var selectionStart, selectionEnd, range, stored_range;
    
    if( !this.isIE )
	return false;
    
    // make it work as nowrap mode (easier for range manipulation with lineHeight)
    if( this.settings['word_wrap'] )
	this.textarea.wrap='off';
    
    try{
	range			= document.selection.createRange();
	stored_range	= range.duplicate();
	stored_range.moveToElementText( this.textarea );
	stored_range.setEndPoint( 'EndToEnd', range );
	if( stored_range.parentElement() != this.textarea )
	    throw "invalid focus";
	
	// the range don't take care of empty lines in the end of the selection
	var scrollTop	= this.result.scrollTop + document.body.scrollTop;
	var relative_top= range.offsetTop - parent.calculeOffsetTop(this.textarea) + scrollTop;
	var line_start	= Math.round((relative_top / this.lineHeight) +1);
	var line_nb		= Math.round( range.boundingHeight / this.lineHeight );
	
	selectionStart	= stored_range.text.length - range.text.length;		
	selectionStart	+= ( line_start - this.textarea.value.substr(0, selectionStart).split("\n").length)*2;		// count missing empty \r to the selection
	selectionStart	-= ( line_start - this.textarea.value.substr(0, selectionStart).split("\n").length ) * 2;
	
	selectionEnd	= selectionStart + range.text.length;		
	selectionEnd	+= (line_start + line_nb - 1 - this.textarea.value.substr(0, selectionEnd ).split("\n").length)*2;			
	
	this.textarea.selectionStart	= selectionStart;
	this.textarea.selectionEnd		= selectionEnd;
    }
    catch(e){}
    
    // restore wrap mode
    if( this.settings['word_wrap'] )
	this.textarea.wrap='soft';
};

// select the text for IE (and take care of \r caracters)
EditArea.prototype.setIESelection= function(){
    var a = this.textarea, nbLineStart, nbLineEnd, range;
    
    if( !this.isIE )
	return false;
    
    nbLineStart	= a.value.substr(0, a.selectionStart).split("\n").length - 1;
    nbLineEnd 	= a.value.substr(0, a.selectionEnd).split("\n").length - 1;
    range		= document.selection.createRange();
    range.moveToElementText( a );
    range.setEndPoint( 'EndToStart', range );
    
    range.moveStart('character', a.selectionStart - nbLineStart);
    range.moveEnd('character', a.selectionEnd - nbLineEnd - (a.selectionStart - nbLineStart)  );
    range.select();
};



EditArea.prototype.checkTextEvolution=function(lastText,newText){
    // ch will contain changes datas
    var ch={},baseStep=200, cpt=0, end, step,tStart=new Date().getTime();
    
    end		= Math.min(newText.length, lastText.length);
    step	= baseStep;
    // find how many chars are similar at the begin of the text						
    while( cpt<end && step>=1 ){
        if(lastText.substr(cpt, step) == newText.substr(cpt, step)){
            cpt+= step;
        }else{
            step= Math.floor(step/2);
        }
    }
    
    ch.posStart	= cpt;
    ch.lineStart= newText.substr(0, ch.posStart).split("\n").length -1;						
    
    cpt_last	= lastText.length;
    cpt			= newText.length;
    step		= baseStep;			
    // find how many chars are similar at the end of the text						
    while( cpt>=0 && cpt_last>=0 && step>=1 ){
        if(lastText.substr(cpt_last-step, step) == newText.substr(cpt-step, step)){
            cpt-= step;
            cpt_last-= step;
        }else{
            step= Math.floor(step/2);
        }
    }
    
    ch.posNewEnd	= cpt;
    ch.posLastEnd	= cpt_last;
    if(ch.posNewEnd<=ch.posStart){
	if(lastText.length < newText.length){
	    ch.posNewEnd= ch.posStart + newText.length - lastText.length;
	    ch.posLastEnd= ch.posStart;
	}else{
	    ch.posLastEnd= ch.posStart + lastText.length - newText.length;
	    ch.posNewEnd= ch.posStart;
	}
    } 
    ch.newText		= newText.substring(ch.posStart, ch.posNewEnd);
    ch.lastText		= lastText.substring(ch.posStart, ch.posLastEnd);			            
    
    ch.lineNewEnd	= newText.substr(0, ch.posNewEnd).split("\n").length -1;
    ch.lineLastEnd	= lastText.substr(0, ch.posLastEnd).split("\n").length -1;
    
    ch.newTextLine	= newText.split("\n").slice(ch.lineStart, ch.lineNewEnd+1).join("\n");
    ch.lastTextLine	= lastText.split("\n").slice(ch.lineStart, ch.lineLastEnd+1).join("\n");
    //console.log( ch );
    return ch;	
};

EditArea.prototype.tab_selection= function(){
    if(this.is_tabbing)
	return;
    this.is_tabbing=true;
    //infos=getSelectionInfos();
    //if( document.selection ){
    this.getIESelection();
    /* Insertion du code de formatage */
    var start = this.textarea.selectionStart;
    var end = this.textarea.selectionEnd;
    var insText = this.textarea.value.substring(start, end);
    
    /* Insert tabulation and ajust cursor position */
    var pos_start=start;
    var pos_end=end;
    if (insText.length == 0) {
	// if only one line selected
	this.textarea.value = this.textarea.value.substr(0, start) + this.tabulation + this.textarea.value.substr(end);
	pos_start = start + this.tabulation.length;
	pos_end=pos_start;
    } else {
	start= Math.max(0, this.textarea.value.substr(0, start).lastIndexOf("\n")+1);
	endText=this.textarea.value.substr(end);
	startText=this.textarea.value.substr(0, start);
	tmp= this.textarea.value.substring(start, end).split("\n");
	insText= this.tabulation+tmp.join("\n"+this.tabulation);
	this.textarea.value = startText + insText + endText;
	pos_start = start;
	pos_end= this.textarea.value.indexOf("\n", startText.length + insText.length);
	if(pos_end==-1)
	    pos_end=this.textarea.value.length;
	//pos = start + repdeb.length + insText.length + ;
    }
    this.textarea.selectionStart = pos_start;
    this.textarea.selectionEnd = pos_end;
    
    //if( document.selection ){
    if(this.isIE)
    {
	this.setIESelection();
	setTimeout(function() {
            editArea.is_tabbing=false;
        }, 100);	// IE can't accept to make 2 tabulation without a little break between both
    }
    else
    { 
	this.is_tabbing=false;
    }	
    
};

EditArea.prototype.invert_tab_selection= function(){
    var t=this, a=this.textarea;
    if(t.is_tabbing)
	return;
    t.is_tabbing=true;
    //infos=getSelectionInfos();
    //if( document.selection ){
    t.getIESelection();
    
    var start	= a.selectionStart;
    var end		= a.selectionEnd;
    var insText	= a.value.substring(start, end);
    
    /* Tab remove and cursor seleciton adjust */
    var pos_start=start;
    var pos_end=end;
    if (insText.length == 0) {
	if(a.value.substring(start-t.tabulation.length, start)==t.tabulation)
	{
	    a.value		= a.value.substr(0, start-t.tabulation.length) + a.value.substr(end);
	    pos_start	= Math.max(0, start-t.tabulation.length);
	    pos_end		= pos_start;
	}	
	/*
	  a.value = a.value.substr(0, start) + t.tabulation + insText + a.value.substr(end);
	  pos_start = start + t.tabulation.length;
	  pos_end=pos_start;*/
    } else {
	start		= a.value.substr(0, start).lastIndexOf("\n")+1;
	endText		= a.value.substr(end);
	startText	= a.value.substr(0, start);
	tmp			= a.value.substring(start, end).split("\n");
	insText		= "";
	for(i=0; i<tmp.length; i++){				
	    for(j=0; j<t.tab_nb_char; j++){
		if(tmp[i].charAt(0)=="\t"){
		    tmp[i]=tmp[i].substr(1);
		    j=t.tab_nb_char;
		}else if(tmp[i].charAt(0)==" ")
		    tmp[i]=tmp[i].substr(1);
	    }		
	    insText+=tmp[i];
	    if(i<tmp.length-1)
		insText+="\n";
	}
	//insText+="_";
	a.value		= startText + insText + endText;
	pos_start	= start;
	pos_end		= a.value.indexOf("\n", startText.length + insText.length);
	if(pos_end==-1)
	    pos_end=a.value.length;
	//pos = start + repdeb.length + insText.length + ;
    }
    a.selectionStart = pos_start;
    a.selectionEnd = pos_end;
    
    //if( document.selection ){
    if(t.isIE){
	// select the text for IE
	t.setIESelection();
	setTimeout(function() {
            editArea.is_tabbing=false;
        }, 100);	// IE can accept to make 2 tabulation without a little break between both
    }else
	t.is_tabbing=false;
};

EditArea.prototype.press_enter= function(){		
    if(!this.smooth_selection)
	return false;
    this.getIESelection();
    var scrollTop= this.result.scrollTop;
    var scrollLeft= this.result.scrollLeft;
    var start=this.textarea.selectionStart;
    var end= this.textarea.selectionEnd;
    var start_last_line= Math.max(0 , this.textarea.value.substring(0, start).lastIndexOf("\n") + 1 );
    var begin_line= this.textarea.value.substring(start_last_line, start).replace(/^([ \t]*).*/gm, "$1");
    var lineStart = this.textarea.value.substring(0, start).split("\n").length;
    if(begin_line=="\n" || begin_line=="\r" || begin_line.length==0)
    {
	return false;
    }
    
    if(this.isIE || ( this.isOpera && this.isOpera < 9.6 ) ){
	begin_line="\r\n"+ begin_line;
    }else{
	begin_line="\n"+ begin_line;
    }	
    //alert(start_last_line+" strat: "+start +"\n"+this.textarea.value.substring(start_last_line, start)+"\n_"+begin_line+"_")
    this.textarea.value= this.textarea.value.substring(0, start) + begin_line + this.textarea.value.substring(end);
    
    this.area_select(start+ begin_line.length ,0);
    // during this process IE scroll back to the top of the textarea
    if(this.isIE){
	this.result.scrollTop	= scrollTop;
	this.result.scrollLeft	= scrollLeft;
    }
    return true;
    
};

EditArea.prototype.findEndBracket= function(infos, bracket){
    
    var start=infos["indexOfCursor"];
    var normal_order=true;
    //curr_text=infos["full_text"].split("\n");
    if(this.assocBracket[bracket])
	endBracket=this.assocBracket[bracket];
    else if(this.revertAssocBracket[bracket]){
	endBracket=this.revertAssocBracket[bracket];
	normal_order=false;
    }	
    var end=-1;
    var nbBracketOpen=0;
    
    for(var i=start; i<infos["full_text"].length && i>=0; ){
	if(infos["full_text"].charAt(i)==endBracket){				
	    nbBracketOpen--;
	    if(nbBracketOpen<=0){
		//i=infos["full_text"].length;
		end=i;
		break;
	    }
	}else if(infos["full_text"].charAt(i)==bracket)
	    nbBracketOpen++;
	if(normal_order)
	    i++;
	else
	    i--;
    }
    
    //end=infos["full_text"].indexOf("}", start);
    if(end==-1)
	return false;	
    var endLastLine=infos["full_text"].substr(0, end).lastIndexOf("\n");			
    if(endLastLine==-1)
	line=1;
    else
	line= infos["full_text"].substr(0, endLastLine).split("\n").length + 1;
    
    var curPos= end - endLastLine - 1;
    var endLineLength	= infos["full_text"].substring(end).split("\n")[0].length;
    this.displayToCursorPosition("end_bracket", line, curPos, infos["full_text"].substring(endLastLine +1, end + endLineLength));
    return true;
};

EditArea.prototype.displayToCursorPosition= function(id, start_line, cur_pos, lineContent, no_real_move){
    var elem,dest,content,posLeft=0,posTop,fixPadding,topOffset,endElem;	

    elem		= this.test_font_size;
    dest		= _$(id);
    content		= "<span id='test_font_size_inner'>"+lineContent.substr(0, cur_pos).replace(/&/g,"&amp;").replace(/</g,"&lt;")+"</span><span id='endTestFont'>"+lineContent.substr(cur_pos).replace(/&/g,"&amp;").replace(/</g,"&lt;")+"</span>";
    if( this.isIE || ( this.isOpera && this.isOpera < 9.6 ) ) {
	elem.innerHTML= "<pre>" + content.replace(/^\r?\n/, "<br>") + "</pre>";
    } else {
	elem.innerHTML= content;
    }
    

    endElem		= _$('endTestFont');
    topOffset	= endElem.offsetTop;
    fixPadding	= parseInt( this.content_highlight.style.paddingLeft.replace("px", "") );
    posLeft 	= 45 + endElem.offsetLeft + ( !isNaN( fixPadding ) && topOffset > 0 ? fixPadding : 0 );
    posTop		= this.getLinePosTop( start_line ) + topOffset;// + Math.floor( ( endElem.offsetHeight - 1 ) / this.lineHeight ) * this.lineHeight;
    
    // detect the case where the span start on a line but has no display on it
    if( this.isIE && cur_pos > 0 && endElem.offsetLeft == 0 )
    {
	posTop	+=	this.lineHeight;
    }
    if(no_real_move!=true){	// when the cursor is hidden no need to move him
	dest.style.top=posTop+"px";
	dest.style.left=posLeft+"px";	
    }
    // usefull for smarter scroll
    dest.cursor_top=posTop;
    dest.cursor_left=posLeft;	
    //	_$(id).style.marginLeft=posLeft+"px";
};

EditArea.prototype.getLinePosTop= function(start_line){
    var elem= _$('line_'+ start_line), posTop=0;
    if( elem )
	posTop	= elem.offsetTop;
    else
	posTop	= this.lineHeight * (start_line-1);
    return posTop;
};


// return the dislpayed height of a text (take word-wrap into account)
EditArea.prototype.getTextHeight= function(text){
    var t=this,elem,height;
    elem		= t.test_font_size;
    content		= text.replace(/&/g,"&amp;").replace(/</g,"&lt;");
    if( t.isIE || ( this.isOpera && this.isOpera < 9.6 ) ) {
	elem.innerHTML= "<pre>" + content.replace(/^\r?\n/, "<br>") + "</pre>";
    } else {
	elem.innerHTML= content;
    }
    height	= elem.offsetHeight;
    height	= Math.max( 1, Math.floor( elem.offsetHeight / this.lineHeight ) ) * this.lineHeight;
    return height;
};

/**
 * Fix line height for the given lines
 * @param Integer linestart
 * @param Integer lineEnd End line or -1 to cover all lines
 */
EditArea.prototype.fixLinesHeight= function( textValue, lineStart,lineEnd ){
    var aText = textValue.split("\n");
    if( lineEnd == -1 )
	lineEnd	= aText.length-1;
    for( var i = Math.max(0, lineStart); i <= lineEnd; i++ )
    {
	if( elem = _$('line_'+ ( i+1 ) ) )
	{
	    elem.style.height= typeof( aText[i] ) != "undefined" ? this.getTextHeight( aText[i] )+"px" : this.lineHeight;
	}
    }
};

EditArea.prototype.area_select= function(start, length){
    this.textarea.focus();
    
    start	= Math.max(0, Math.min(this.textarea.value.length, start));
    end		= Math.max(start, Math.min(this.textarea.value.length, start+length));

    if(this.isIE)
    {
	this.textarea.selectionStart	= start;
	this.textarea.selectionEnd		= end;		
	this.setIESelection();
    }
    else
    {
	// Opera bug when moving selection start and selection end
	if(this.isOpera && this.isOpera < 9.6 )
	{	
	    this.textarea.setSelectionRange(0, 0);
	}
	this.textarea.setSelectionRange(start, end);
    }
    this.check_line_selection();
};


EditArea.prototype.area_get_selection= function(){
    var text="";
    if( document.selection ){
	var range = document.selection.createRange();
	text=range.text;
    }else{
	text= this.textarea.value.substring(this.textarea.selectionStart, this.textarea.selectionEnd);
    }
    return text;			
};


======================================================================
FILE PATH: editor\editarea\edit_area\regexp.js
======================================================================
// determine if the selected text if a comment or a quoted text
EditArea.prototype.comment_or_quote= function(){
    var new_class="", close_tag="", sy, arg, i;
    sy 		= parent.editAreaLoader.syntax[editArea.current_code_lang];
    arg		= EditArea.prototype.comment_or_quote.arguments[0];
    
    for( i in sy["quotes"] ){
	if(arg.indexOf(i)==0){
	    new_class="quotesmarks";
	    close_tag=sy["quotes"][i];
	}
    }
    if(new_class.length==0)
    {
	for(var i in sy["comments"]){
	    if( arg.indexOf(i)==0 ){
		new_class="comments";
		close_tag=sy["comments"][i];
	    }
	}
    }
    // for single line comment the \n must not be included in the span tags
    if(close_tag=="\n"){
	return "µ__"+ new_class +"__µ"+ arg.replace(/(\r?\n)?$/m, "µ_END_µ$1");
    }else{
	// the closing tag must be set only if the comment or quotes is closed 
	reg= new RegExp(parent.editAreaLoader.get_escaped_regexp(close_tag)+"$", "m");
	if( arg.search(reg)!=-1 )
	    return "µ__"+ new_class +"__µ"+ arg +"µ_END_µ";
	else
	    return "µ__"+ new_class +"__µ"+ arg;
    }
};


// return identication that allow to know if revalidating only the text line won't make the syntax go mad
EditArea.prototype.get_syntax_trace= function(text){
    if(this.settings["syntax"].length>0 && parent.editAreaLoader.syntax[this.settings["syntax"]]["syntax_trace_regexp"])
	return text.replace(parent.editAreaLoader.syntax[this.settings["syntax"]]["syntax_trace_regexp"], "$3");
};


EditArea.prototype.colorize_text= function(text){
    text= " "+text; // for easier regExp
    if(this.settings["syntax"].length>0)
	text= this.apply_syntax(text, this.settings["syntax"]);

    // remove the first space added
    return text.substr(1).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/µ_END_µ/g,"</span>").replace(/µ__([-\w+]+)__µ/g,"<span class='$1'>");
};

EditArea.prototype.apply_syntax= function(text, lang){
    var sy;
    this.current_code_lang=lang;
    
    if(!parent.editAreaLoader.syntax[lang])
	return text;
    
    sy = parent.editAreaLoader.syntax[lang];
    if(sy["custom_regexp"]['before']){
	for( var i in sy["custom_regexp"]['before']){
	    var convert="$1µ__"+ sy["custom_regexp"]['before'][i]['class'] +"__µ$2µ_END_µ$3";
	    text= text.replace(sy["custom_regexp"]['before'][i]['regexp'], convert);
	}
    }
    
    if(sy["comment_or_quote_reg_exp"]){
	text= text.replace(sy["comment_or_quote_reg_exp"], this.comment_or_quote);
    }
    
    if(sy["keywords_reg_exp"]){
	for(var i in sy["keywords_reg_exp"]){	
	    text= text.replace(sy["keywords_reg_exp"][i], 'µ__'+i+'__µ$2µ_END_µ');
	}			
    }
    
    if(sy["delimiters_reg_exp"]){
	text= text.replace(sy["delimiters_reg_exp"], 'µ__delimiters__µ$1µ_END_µ');
    }		
    
    if(sy["operators_reg_exp"]){
	text= text.replace(sy["operators_reg_exp"], 'µ__operators__µ$1µ_END_µ');
    }
    
    if(sy["custom_regexp"]['after']){
	for( var i in sy["custom_regexp"]['after']){
	    var convert="$1µ__"+ sy["custom_regexp"]['after'][i]['class'] +"__µ$2µ_END_µ$3";
	    text= text.replace(sy["custom_regexp"]['after'][i]['regexp'], convert);			
	}
    }
    
    return text;
};



======================================================================
FILE PATH: editor\editarea\edit_area\reg_syntax.js
======================================================================
	EditAreaLoader.prototype.get_regexp= function(text_array){
		//res="( |=|\\n|\\r|\\[|\\(|µ|)(";
		res="(\\b)(";
		for(i=0; i<text_array.length; i++){
			if(i>0)
				res+="|";
			//res+="("+ tab_text[i] +")";
			//res+=tab_text[i].replace(/(\.|\?|\*|\+|\\|\(|\)|\[|\]|\{|\})/g, "\\$1");
			res+=this.get_escaped_regexp(text_array[i]);
		}
		//res+=")( |\\.|:|\\{|\\(|\\)|\\[|\\]|\'|\"|\\r|\\n|\\t|$)";
		res+=")(\\b)";
		reg= new RegExp(res);
		
		return res;
	};
	
	
	EditAreaLoader.prototype.get_escaped_regexp= function(str){
		return str.toString().replace(/(\.|\?|\*|\+|\\|\(|\)|\[|\]|\}|\{|\$|\^|\|)/g, "\\$1");
	};
	
	EditAreaLoader.prototype.init_syntax_regexp= function(){
		var lang_style= {};	
		for(var lang in this.load_syntax){
			if(!this.syntax[lang])	// init the regexp if not already initialized
			{
				this.syntax[lang]= {};
				this.syntax[lang]["keywords_reg_exp"]= {};
				this.keywords_reg_exp_nb=0;
			
				if(this.load_syntax[lang]['KEYWORDS']){
					param="g";
					if(this.load_syntax[lang]['KEYWORD_CASE_SENSITIVE']===false)
						param+="i";
					for(var i in this.load_syntax[lang]['KEYWORDS']){
						if(typeof(this.load_syntax[lang]['KEYWORDS'][i])=="function") continue;
						this.syntax[lang]["keywords_reg_exp"][i]= new RegExp(this.get_regexp( this.load_syntax[lang]['KEYWORDS'][i] ), param);
						this.keywords_reg_exp_nb++;
					}
				}
				
				if(this.load_syntax[lang]['OPERATORS']){
					var str="";
					var nb=0;
					for(var i in this.load_syntax[lang]['OPERATORS']){
						if(typeof(this.load_syntax[lang]['OPERATORS'][i])=="function") continue;
						if(nb>0)
							str+="|";				
						str+=this.get_escaped_regexp(this.load_syntax[lang]['OPERATORS'][i]);
						nb++;
					}
					if(str.length>0)
						this.syntax[lang]["operators_reg_exp"]= new RegExp("("+str+")","g");
				}
				
				if(this.load_syntax[lang]['DELIMITERS']){
					var str="";
					var nb=0;
					for(var i in this.load_syntax[lang]['DELIMITERS']){
						if(typeof(this.load_syntax[lang]['DELIMITERS'][i])=="function") continue;
						if(nb>0)
							str+="|";
						str+=this.get_escaped_regexp(this.load_syntax[lang]['DELIMITERS'][i]);
						nb++;
					}
					if(str.length>0)
						this.syntax[lang]["delimiters_reg_exp"]= new RegExp("("+str+")","g");
				}
				
				
		//		/(("(\\"|[^"])*"?)|('(\\'|[^'])*'?)|(//(.|\r|\t)*\n)|(/\*(.|\n|\r|\t)*\*/)|(<!--(.|\n|\r|\t)*-->))/gi
				var syntax_trace=[];
				
		//		/("(?:[^"\\]*(\\\\)*(\\"?)?)*("|$))/g
				
				this.syntax[lang]["quotes"]={};
				var quote_tab= [];
				if(this.load_syntax[lang]['QUOTEMARKS']){
					for(var i in this.load_syntax[lang]['QUOTEMARKS']){	
						if(typeof(this.load_syntax[lang]['QUOTEMARKS'][i])=="function") continue;			
						var x=this.get_escaped_regexp(this.load_syntax[lang]['QUOTEMARKS'][i]);
						this.syntax[lang]["quotes"][x]=x;
						//quote_tab[quote_tab.length]="("+x+"(?:\\\\"+x+"|[^"+x+"])*("+x+"|$))";
						//previous working : quote_tab[quote_tab.length]="("+x+"(?:[^"+x+"\\\\]*(\\\\\\\\)*(\\\\"+x+"?)?)*("+x+"|$))";
						quote_tab[quote_tab.length]="("+ x +"(\\\\.|[^"+ x +"])*(?:"+ x +"|$))";
						
						syntax_trace.push(x);			
					}			
				}
						
				this.syntax[lang]["comments"]={};
				if(this.load_syntax[lang]['COMMENT_SINGLE']){
					for(var i in this.load_syntax[lang]['COMMENT_SINGLE']){	
						if(typeof(this.load_syntax[lang]['COMMENT_SINGLE'][i])=="function") continue;						
						var x=this.get_escaped_regexp(this.load_syntax[lang]['COMMENT_SINGLE'][i]);
						quote_tab[quote_tab.length]="("+x+"(.|\\r|\\t)*(\\n|$))";
						syntax_trace.push(x);
						this.syntax[lang]["comments"][x]="\n";
					}			
				}		
				// (/\*(.|[\r\n])*?\*/)
				if(this.load_syntax[lang]['COMMENT_MULTI']){
					for(var i in this.load_syntax[lang]['COMMENT_MULTI']){
						if(typeof(this.load_syntax[lang]['COMMENT_MULTI'][i])=="function") continue;							
						var start=this.get_escaped_regexp(i);
						var end=this.get_escaped_regexp(this.load_syntax[lang]['COMMENT_MULTI'][i]);
						quote_tab[quote_tab.length]="("+start+"(.|\\n|\\r)*?("+end+"|$))";
						syntax_trace.push(start);
						syntax_trace.push(end);
						this.syntax[lang]["comments"][i]=this.load_syntax[lang]['COMMENT_MULTI'][i];
					}			
				}		
				if(quote_tab.length>0)
					this.syntax[lang]["comment_or_quote_reg_exp"]= new RegExp("("+quote_tab.join("|")+")","gi");
				
				if(syntax_trace.length>0) //   /((.|\n)*?)(\\*("|'|\/\*|\*\/|\/\/|$))/g
					this.syntax[lang]["syntax_trace_regexp"]= new RegExp("((.|\n)*?)(\\\\*("+ syntax_trace.join("|") +"|$))", "gmi");
				
				if(this.load_syntax[lang]['SCRIPT_DELIMITERS']){
					this.syntax[lang]["script_delimiters"]= {};
					for(var i in this.load_syntax[lang]['SCRIPT_DELIMITERS']){
						if(typeof(this.load_syntax[lang]['SCRIPT_DELIMITERS'][i])=="function") continue;							
						this.syntax[lang]["script_delimiters"][i]= this.load_syntax[lang]['SCRIPT_DELIMITERS'];
					}			
				}
				
				this.syntax[lang]["custom_regexp"]= {};
				if(this.load_syntax[lang]['REGEXPS']){
					for(var i in this.load_syntax[lang]['REGEXPS']){
						if(typeof(this.load_syntax[lang]['REGEXPS'][i])=="function") continue;
						var val= this.load_syntax[lang]['REGEXPS'][i];
						if(!this.syntax[lang]["custom_regexp"][val['execute']])
							this.syntax[lang]["custom_regexp"][val['execute']]= {};
						this.syntax[lang]["custom_regexp"][val['execute']][i]={'regexp' : new RegExp(val['search'], val['modifiers'])
																			, 'class' : val['class']};
					}
				}
				
				if(this.load_syntax[lang]['STYLES']){							
					lang_style[lang]= {};
					for(var i in this.load_syntax[lang]['STYLES']){
						if(typeof(this.load_syntax[lang]['STYLES'][i])=="function") continue;
						if(typeof(this.load_syntax[lang]['STYLES'][i]) != "string"){
							for(var j in this.load_syntax[lang]['STYLES'][i]){							
								lang_style[lang][j]= this.load_syntax[lang]['STYLES'][i][j];
							}
						}else{
							lang_style[lang][i]= this.load_syntax[lang]['STYLES'][i];
						}
					}
				}
				// build style string
				var style="";		
				for(var i in lang_style[lang]){
					if(lang_style[lang][i].length>0){
						style+= "."+ lang +" ."+ i.toLowerCase() +" span{"+lang_style[lang][i]+"}\n";
						style+= "."+ lang +" ."+ i.toLowerCase() +"{"+lang_style[lang][i]+"}\n";				
					}
				}
				this.syntax[lang]["styles"]=style;
			}
		}				
	};
	
	editAreaLoader.waiting_loading["reg_syntax.js"]= "loaded";



======================================================================
FILE PATH: editor\editarea\edit_area\resize_area.js
======================================================================
	
	EditAreaLoader.prototype.start_resize_area= function(){
		var d=document,a,div,width,height,father;
		
		d.onmouseup= editAreaLoader.end_resize_area;
		d.onmousemove= editAreaLoader.resize_area;
		editAreaLoader.toggle(editAreaLoader.resize["id"]);		
		
		a	= editAreas[editAreaLoader.resize["id"]]["textarea"];
		div	= d.getElementById("edit_area_resize");
		if(!div){
			div= d.createElement("div");
			div.id="edit_area_resize";
			div.style.border="dashed #888888 1px";
		}
		width	= a.offsetWidth -2;
		height	= a.offsetHeight -2;
		
		div.style.display	= "block";
		div.style.width		= width+"px";
		div.style.height	= height+"px";
		father= a.parentNode;
		father.insertBefore(div, a);
		
		a.style.display="none";
				
		editAreaLoader.resize["start_top"]= calculeOffsetTop(div);
		editAreaLoader.resize["start_left"]= calculeOffsetLeft(div);		
	};
	
	EditAreaLoader.prototype.end_resize_area= function(e){
		var d=document,div,a,width,height;
		
		d.onmouseup="";
		d.onmousemove="";		
		
		div		= d.getElementById("edit_area_resize");		
		a= editAreas[editAreaLoader.resize["id"]]["textarea"];
		width	= Math.max(editAreas[editAreaLoader.resize["id"]]["settings"]["min_width"], div.offsetWidth-4);
		height	= Math.max(editAreas[editAreaLoader.resize["id"]]["settings"]["min_height"], div.offsetHeight-4);
		if(editAreaLoader.isIE==6){
			width-=2;
			height-=2;	
		}
		a.style.width		= width+"px";
		a.style.height		= height+"px";
		div.style.display	= "none";
		a.style.display		= "inline";
		a.selectionStart	= editAreaLoader.resize["selectionStart"];
		a.selectionEnd		= editAreaLoader.resize["selectionEnd"];
		editAreaLoader.toggle(editAreaLoader.resize["id"]);
		
		return false;
	};
	
	EditAreaLoader.prototype.resize_area= function(e){		
		var allow,newHeight,newWidth;
		allow	= editAreas[editAreaLoader.resize["id"]]["settings"]["allow_resize"];
		if(allow=="both" || allow=="y")
		{
			newHeight	= Math.max(20, getMouseY(e)- editAreaLoader.resize["start_top"]);
			document.getElementById("edit_area_resize").style.height= newHeight+"px";
		}
		if(allow=="both" || allow=="x")
		{
			newWidth= Math.max(20, getMouseX(e)- editAreaLoader.resize["start_left"]);
			document.getElementById("edit_area_resize").style.width= newWidth+"px";
		}
		
		return false;
	};
	
	editAreaLoader.waiting_loading["resize_area.js"]= "loaded";



======================================================================
FILE PATH: editor\editarea\edit_area\search_replace.js
======================================================================
	EditArea.prototype.show_search = function(){
		if(_$("area_search_replace").style.visibility=="visible"){
			this.hidden_search();
		}else{
			this.open_inline_popup("area_search_replace");
			var text= this.area_get_selection();
			var search= text.split("\n")[0];
			_$("area_search").value= search;
			_$("area_search").focus();
		}
	};
	
	EditArea.prototype.hidden_search= function(){
		/*_$("area_search_replace").style.visibility="hidden";
		this.textarea.focus();
		var icon= _$("search");
		setAttribute(icon, "class", getAttribute(icon, "class").replace(/ selected/g, "") );*/
		this.close_inline_popup("area_search_replace");
	};
	
	EditArea.prototype.area_search= function(mode){
		
		if(!mode)
			mode="search";
		_$("area_search_msg").innerHTML="";		
		var search=_$("area_search").value;		
		
		this.textarea.focus();		
		this.textarea.textareaFocused=true;
		
		var infos= this.get_selection_infos();	
		var start= infos["selectionStart"];
		var pos=-1;
		var pos_begin=-1;
		var length=search.length;
		
		if(_$("area_search_replace").style.visibility!="visible"){
			this.show_search();
			return;
		}
		if(search.length==0){
			_$("area_search_msg").innerHTML=this.get_translation("search_field_empty");
			return;
		}
		// advance to the next occurence if no text selected
		if(mode!="replace" ){
			if(_$("area_search_reg_exp").checked)
				start++;
			else
				start+= search.length;
		}
		
		//search
		if(_$("area_search_reg_exp").checked){
			// regexp search
			var opt="m";
			if(!_$("area_search_match_case").checked)
				opt+="i";
			var reg= new RegExp(search, opt);
			pos= infos["full_text"].substr(start).search(reg);
			pos_begin= infos["full_text"].search(reg);
			if(pos!=-1){
				pos+=start;
				length=infos["full_text"].substr(start).match(reg)[0].length;
			}else if(pos_begin!=-1){
				length=infos["full_text"].match(reg)[0].length;
			}
		}else{
			if(_$("area_search_match_case").checked){
				pos= infos["full_text"].indexOf(search, start); 
				pos_begin= infos["full_text"].indexOf(search); 
			}else{
				pos= infos["full_text"].toLowerCase().indexOf(search.toLowerCase(), start); 
				pos_begin= infos["full_text"].toLowerCase().indexOf(search.toLowerCase()); 
			}		
		}
		
		// interpret result
		if(pos==-1 && pos_begin==-1){
			_$("area_search_msg").innerHTML="<strong>"+search+"</strong> "+this.get_translation("not_found");
			return;
		}else if(pos==-1 && pos_begin != -1){
			begin= pos_begin;
			_$("area_search_msg").innerHTML=this.get_translation("restart_search_at_begin");
		}else
			begin= pos;
		
		//_$("area_search_msg").innerHTML+="<strong>"+search+"</strong> found at "+begin+" strat at "+start+" pos "+pos+" curs"+ infos["indexOfCursor"]+".";
		if(mode=="replace" && pos==infos["indexOfCursor"]){
			var replace= _$("area_replace").value;
			var new_text="";			
			if(_$("area_search_reg_exp").checked){
				var opt="m";
				if(!_$("area_search_match_case").checked)
					opt+="i";
				var reg= new RegExp(search, opt);
				new_text= infos["full_text"].substr(0, begin) + infos["full_text"].substr(start).replace(reg, replace);
			}else{
				new_text= infos["full_text"].substr(0, begin) + replace + infos["full_text"].substr(begin + length);
			}
			this.textarea.value=new_text;
			this.area_select(begin, length);
			this.area_search();
		}else
			this.area_select(begin, length);
	};
	
	
	
	
	EditArea.prototype.area_replace= function(){		
		this.area_search("replace");
	};
	
	EditArea.prototype.area_replace_all= function(){
	/*	this.area_select(0, 0);
		_$("area_search_msg").innerHTML="";
		while(_$("area_search_msg").innerHTML==""){
			this.area_replace();
		}*/
	
		var base_text= this.textarea.value;
		var search= _$("area_search").value;		
		var replace= _$("area_replace").value;
		if(search.length==0){
			_$("area_search_msg").innerHTML=this.get_translation("search_field_empty");
			return ;
		}
		
		var new_text="";
		var nb_change=0;
		if(_$("area_search_reg_exp").checked){
			// regExp
			var opt="mg";
			if(!_$("area_search_match_case").checked)
				opt+="i";
			var reg= new RegExp(search, opt);
			nb_change= infos["full_text"].match(reg).length;
			new_text= infos["full_text"].replace(reg, replace);
			
		}else{
			
			if(_$("area_search_match_case").checked){
				var tmp_tab=base_text.split(search);
				nb_change= tmp_tab.length -1 ;
				new_text= tmp_tab.join(replace);
			}else{
				// case insensitive
				var lower_value=base_text.toLowerCase();
				var lower_search=search.toLowerCase();
				
				var start=0;
				var pos= lower_value.indexOf(lower_search);				
				while(pos!=-1){
					nb_change++;
					new_text+= this.textarea.value.substring(start , pos)+replace;
					start=pos+ search.length;
					pos= lower_value.indexOf(lower_search, pos+1);
				}
				new_text+= this.textarea.value.substring(start);				
			}
		}			
		if(new_text==base_text){
			_$("area_search_msg").innerHTML="<strong>"+search+"</strong> "+this.get_translation("not_found");
		}else{
			this.textarea.value= new_text;
			_$("area_search_msg").innerHTML="<strong>"+nb_change+"</strong> "+this.get_translation("occurrence_replaced");
			// firefox and opera doesn't manage with the focus if it's done directly
			//editArea.textarea.focus();editArea.textarea.textareaFocused=true;
		    setTimeout(function() {
                        editArea.textarea.focus();
                        editArea.textarea.textareaFocused=true;
                    }, 100);
		}
		
		
	};



======================================================================
FILE PATH: editor\editarea\edit_area\template.html
======================================================================
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" >
<head>
	<title>EditArea</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7"/>
	[__CSSRULES__]
	[__JSCODE__]
</head>
<body>
	<div id='editor'>
		<div class='area_toolbar' id='toolbar_1'>[__TOOLBAR__]</div>
		<div class='area_toolbar' id='tab_browsing_area'><ul id='tab_browsing_list' class='menu'> <li> </li> </ul></div>
		<div id='result'>
			<div id='no_file_selected'></div>
			<div id='container'>
				<div id='cursor_pos' class='edit_area_cursor'>&nbsp;</div>
				<div id='end_bracket' class='edit_area_cursor'>&nbsp;</div>
				<div id='selection_field'></div>
				<div id='line_number' selec='none'></div>
				<div id='content_highlight'></div>
				<div id='test_font_size'></div>
				<div id='selection_field_text'></div>
				<textarea id='textarea' wrap='off' onchange='editArea.execCommand("onchange");' onfocus='javascript:editArea.textareaFocused=true;' onblur='javascript:editArea.textareaFocused=false;'>
				</textarea>
				
			</div>
		</div>
		<div class='area_toolbar' id='toolbar_2'>
			<table class='statusbar' cellspacing='0' cellpadding='0'>
				<tr>
					<td class='total' selec='none'>{$position}:</td>
					<td class='infos' selec='none'>
						{$line_abbr} <span  id='linePos'>0</span>, {$char_abbr} <span id='currPos'>0</span>
					</td>
					<td class='total' selec='none'>{$total}:</td>
					<td class='infos' selec='none'>
						{$line_abbr} <span id='nbLine'>0</span>, {$char_abbr} <span id='nbChar'>0</span>
					</td>
					<td class='resize'>
						<span id='resize_area'><img src='[__BASEURL__]images/statusbar_resize.gif' alt='resize' selec='none'></span>
					</td>
				</tr>
			</table>
		</div>
	</div>
	<div id='processing'>
		<div id='processing_text'>
			{$processing}
		</div>
	</div>

	<div id='area_search_replace' class='editarea_popup'>
		<table cellspacing='2' cellpadding='0' style='width: 100%'>
			<tr>
				<td selec='none'>{$search}</td>
				<td><input type='text' id='area_search' /></td>
				<td id='close_area_search_replace'>
					<a onclick='Javascript:editArea.execCommand("hidden_search")'><img selec='none' src='[__BASEURL__]images/close.gif' alt='{$close_popup}' title='{$close_popup}' /></a><br />
			</tr><tr>
				<td selec='none'>{$replace}</td>
				<td><input type='text' id='area_replace' /></td>
				<td><img id='move_area_search_replace' onmousedown='return parent.start_move_element(event,"area_search_replace", parent.frames["frame_"+editArea.id]);'  src='[__BASEURL__]images/move.gif' alt='{$move_popup}' title='{$move_popup}' /></td>
			</tr>
		</table>
		<div class='button'>
			<input type='checkbox' id='area_search_match_case' /><label for='area_search_match_case' selec='none'>{$match_case}</label>
			<input type='checkbox' id='area_search_reg_exp' /><label for='area_search_reg_exp' selec='none'>{$reg_exp}</label>
			<br />
			<a onclick='Javascript:editArea.execCommand("area_search")' selec='none'>{$find_next}</a>
			<a onclick='Javascript:editArea.execCommand("area_replace")' selec='none'>{$replace}</a>
			<a onclick='Javascript:editArea.execCommand("area_replace_all")' selec='none'>{$replace_all}</a><br />
		</div>
		<div id='area_search_msg' selec='none'></div>
	</div>
	<div id='edit_area_help' class='editarea_popup'>
		<div class='close_popup'>
			<a onclick='Javascript:editArea.execCommand("close_all_inline_popup")'><img src='[__BASEURL__]images/close.gif' alt='{$close_popup}' title='{$close_popup}' /></a>
		</div>
		<div><h2>Editarea [__EA_VERSION__]</h2><br />
			<h3>{$shortcuts}:</h3>
				{$tab}: {$add_tab}<br />
				{$shift}+{$tab}: {$remove_tab}<br />
				{$ctrl}+f: {$search_command}<br />
				{$ctrl}+r: {$replace_command}<br />
				{$ctrl}+h: {$highlight}<br />
				{$ctrl}+g: {$go_to_line}<br />
				{$ctrl}+z: {$undo}<br />
				{$ctrl}+y: {$redo}<br />
				{$ctrl}+e: {$help}<br />
				{$ctrl}+q, {$esc}: {$close_popup}<br />
				{$accesskey} E: {$toggle}<br />
			<br />
			<em>{$about_notice}</em>
			<br /><div class='copyright'>&copy; Christophe Dolivet 2007-2009</div>
		</div>
	</div>
</body>
</html>



======================================================================
FILE PATH: editor\editarea\imacro.css
======================================================================
/*
(c) Copyright Ipswitch, Inc. - https://www.ipswitch.com
*/

/* styles for editor */

body {
    margin: 0px !important;
    padding: 0px !important;
}

/* #textarea { */
/*     margin: 0px !important; */
/*     width: 100% !important; */
/*     height: 95% !important; */
/*     border: 1px solid red !important; */
/* } */



======================================================================
FILE PATH: editor\editarea\imacro.html
======================================================================
<html>
  <head>
    <title>iMacros Editor</title>
    <link rel="stylesheet" type="text/css"
          href="imacro.css" />
    <script language="javascript" type="text/javascript"
            src="edit_area/edit_area_loader.js"></script>
    <script language="javascript" type="text/javascript"
            src="imacro.js"></script>

  </head>
  <body>
    <form method="post">
    <textarea id="textarea" style="width:100%;height:95%" name="content" ></textarea>
    </form>
    <div id="bypass" style="display:none"></div>
  </body>
</html>



======================================================================
FILE PATH: editor\editarea\imacro.js
======================================================================

window.addEventListener("load", function() {
    var bypass = document.getElementById("bypass");
    bypass.addEventListener("iMacrosEditorInitEvent",
                             initEditArea, true);
    bypass.addEventListener("iMacrosEditorLoadCompleteEvent",
                             onLoadComplete, true);
    bypass.addEventListener("iMacrosEditorGetContentEvent",
                             onGetContent, true);
    bypass.addEventListener("iMacrosEditorGetSelection",
                             onGetSelection, true);
    bypass.addEventListener("iMacrosEditorSetSelection",
                             onSetSelection, true);
    bypass.setAttribute("inited", "true");    
});


function initEditArea() {
    var bypass = document.getElementById("bypass");

    if (!bypass.hasAttribute("lang") || !bypass.hasAttribute("syntax")) {
        alert("Can not initiate iMacros Editor");
        return;
    }
    
    var config = {
        id: "textarea",
        syntax: bypass.getAttribute("syntax"),
        start_highlight: true,
        allow_toggle: false,
        toolbar: "return",
        syntax_selection_allow: "imacro",
        language: bypass.getAttribute("lang"),
        allow_resize: "no",
        // load_callback: "onLoadFile",
        save_callback: "onSaveFile"
    };
    editAreaLoader.init(config);
}
    

function onSaveFile(id, content) {
    var bypass = document.getElementById("bypass");
    var evt = document.createEvent("Events");
    evt.initEvent("iMacrosEditorSaveEvent", true, false);
    bypass.setAttribute("content", content);
    bypass.dispatchEvent(evt);
}


function onLoadFile(id) {
    var bypass = document.getElementById("bypass");
    var evt = document.createEvent("Events");
    evt.initEvent("iMacrosEditorLoadEvent", true, false);
    bypass.dispatchEvent(evt);
}


function onLoadComplete() {
    var bypass = document.getElementById("bypass");
    var content = bypass.getAttribute("content");
    editAreaLoader.setValue("textarea", content);
    editAreaLoader.execCommand("textarea",
              "change_syntax", bypass.getAttribute("syntax"));
}

function onGetContent() {
    var bypass = document.getElementById("bypass");
    bypass.setAttribute("content",
          editAreaLoader.getValue("textarea"));
}

function onGetSelection() {
    var bypass = document.getElementById("bypass");
    bypass.setAttribute("selection",
                        editAreaLoader.getSelectedText("textarea"));
}

function onSetSelection() {
    var bypass = document.getElementById("bypass");
    var selection = bypass.getAttribute("selection");
    editAreaLoader.setSelectedText("textarea", selection);
}



======================================================================
FILE PATH: editor\editarea\license_apache.txt
======================================================================
Copyright 2008 Christophe Dolivet

Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with the License. You may obtain a copy of the License at

	http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.


======================================================================
FILE PATH: editor\editarea\license_bsd.txt
======================================================================
Copyright (c) 2008, Christophe Dolivet
All rights reserved.

Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:

    * Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
    * Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.
    * Neither the name of EditArea nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.


======================================================================
FILE PATH: editor\editarea\license_lgpl.txt
======================================================================
		  GNU LESSER GENERAL PUBLIC LICENSE
		       Version 2.1, February 1999

 Copyright (C) 1991, 1999 Free Software Foundation, Inc.
 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA
 Everyone is permitted to copy and distribute verbatim copies
 of this license document, but changing it is not allowed.

[This is the first released version of the Lesser GPL.  It also counts
 as the successor of the GNU Library Public License, version 2, hence
 the version number 2.1.]

			    Preamble

  The licenses for most software are designed to take away your
freedom to share and change it.  By contrast, the GNU General Public
Licenses are intended to guarantee your freedom to share and change
free software--to make sure the software is free for all its users.

  This license, the Lesser General Public License, applies to some
specially designated software packages--typically libraries--of the
Free Software Foundation and other authors who decide to use it.  You
can use it too, but we suggest you first think carefully about whether
this license or the ordinary General Public License is the better
strategy to use in any particular case, based on the explanations below.

  When we speak of free software, we are referring to freedom of use,
not price.  Our General Public Licenses are designed to make sure that
you have the freedom to distribute copies of free software (and charge
for this service if you wish); that you receive source code or can get
it if you want it; that you can change the software and use pieces of
it in new free programs; and that you are informed that you can do
these things.

  To protect your rights, we need to make restrictions that forbid
distributors to deny you these rights or to ask you to surrender these
rights.  These restrictions translate to certain responsibilities for
you if you distribute copies of the library or if you modify it.

  For example, if you distribute copies of the library, whether gratis
or for a fee, you must give the recipients all the rights that we gave
you.  You must make sure that they, too, receive or can get the source
code.  If you link other code with the library, you must provide
complete object files to the recipients, so that they can relink them
with the library after making changes to the library and recompiling
it.  And you must show them these terms so they know their rights.

  We protect your rights with a two-step method: (1) we copyright the
library, and (2) we offer you this license, which gives you legal
permission to copy, distribute and/or modify the library.

  To protect each distributor, we want to make it very clear that
there is no warranty for the free library.  Also, if the library is
modified by someone else and passed on, the recipients should know
that what they have is not the original version, so that the original
author's reputation will not be affected by problems that might be
introduced by others.

  Finally, software patents pose a constant threat to the existence of
any free program.  We wish to make sure that a company cannot
effectively restrict the users of a free program by obtaining a
restrictive license from a patent holder.  Therefore, we insist that
any patent license obtained for a version of the library must be
consistent with the full freedom of use specified in this license.

  Most GNU software, including some libraries, is covered by the
ordinary GNU General Public License.  This license, the GNU Lesser
General Public License, applies to certain designated libraries, and
is quite different from the ordinary General Public License.  We use
this license for certain libraries in order to permit linking those
libraries into non-free programs.

  When a program is linked with a library, whether statically or using
a shared library, the combination of the two is legally speaking a
combined work, a derivative of the original library.  The ordinary
General Public License therefore permits such linking only if the
entire combination fits its criteria of freedom.  The Lesser General
Public License permits more lax criteria for linking other code with
the library.

  We call this license the "Lesser" General Public License because it
does Less to protect the user's freedom than the ordinary General
Public License.  It also provides other free software developers Less
of an advantage over competing non-free programs.  These disadvantages
are the reason we use the ordinary General Public License for many
libraries.  However, the Lesser license provides advantages in certain
special circumstances.

  For example, on rare occasions, there may be a special need to
encourage the widest possible use of a certain library, so that it becomes
a de-facto standard.  To achieve this, non-free programs must be
allowed to use the library.  A more frequent case is that a free
library does the same job as widely used non-free libraries.  In this
case, there is little to gain by limiting the free library to free
software only, so we use the Lesser General Public License.

  In other cases, permission to use a particular library in non-free
programs enables a greater number of people to use a large body of
free software.  For example, permission to use the GNU C Library in
non-free programs enables many more people to use the whole GNU
operating system, as well as its variant, the GNU/Linux operating
system.

  Although the Lesser General Public License is Less protective of the
users' freedom, it does ensure that the user of a program that is
linked with the Library has the freedom and the wherewithal to run
that program using a modified version of the Library.

  The precise terms and conditions for copying, distribution and
modification follow.  Pay close attention to the difference between a
"work based on the library" and a "work that uses the library".  The
former contains code derived from the library, whereas the latter must
be combined with the library in order to run.

		  GNU LESSER GENERAL PUBLIC LICENSE
   TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION

  0. This License Agreement applies to any software library or other
program which contains a notice placed by the copyright holder or
other authorized party saying it may be distributed under the terms of
this Lesser General Public License (also called "this License").
Each licensee is addressed as "you".

  A "library" means a collection of software functions and/or data
prepared so as to be conveniently linked with application programs
(which use some of those functions and data) to form executables.

  The "Library", below, refers to any such software library or work
which has been distributed under these terms.  A "work based on the
Library" means either the Library or any derivative work under
copyright law: that is to say, a work containing the Library or a
portion of it, either verbatim or with modifications and/or translated
straightforwardly into another language.  (Hereinafter, translation is
included without limitation in the term "modification".)

  "Source code" for a work means the preferred form of the work for
making modifications to it.  For a library, complete source code means
all the source code for all modules it contains, plus any associated
interface definition files, plus the scripts used to control compilation
and installation of the library.

  Activities other than copying, distribution and modification are not
covered by this License; they are outside its scope.  The act of
running a program using the Library is not restricted, and output from
such a program is covered only if its contents constitute a work based
on the Library (independent of the use of the Library in a tool for
writing it).  Whether that is true depends on what the Library does
and what the program that uses the Library does.
  
  1. You may copy and distribute verbatim copies of the Library's
complete source code as you receive it, in any medium, provided that
you conspicuously and appropriately publish on each copy an
appropriate copyright notice and disclaimer of warranty; keep intact
all the notices that refer to this License and to the absence of any
warranty; and distribute a copy of this License along with the
Library.

  You may charge a fee for the physical act of transferring a copy,
and you may at your option offer warranty protection in exchange for a
fee.

  2. You may modify your copy or copies of the Library or any portion
of it, thus forming a work based on the Library, and copy and
distribute such modifications or work under the terms of Section 1
above, provided that you also meet all of these conditions:

    a) The modified work must itself be a software library.

    b) You must cause the files modified to carry prominent notices
    stating that you changed the files and the date of any change.

    c) You must cause the whole of the work to be licensed at no
    charge to all third parties under the terms of this License.

    d) If a facility in the modified Library refers to a function or a
    table of data to be supplied by an application program that uses
    the facility, other than as an argument passed when the facility
    is invoked, then you must make a good faith effort to ensure that,
    in the event an application does not supply such function or
    table, the facility still operates, and performs whatever part of
    its purpose remains meaningful.

    (For example, a function in a library to compute square roots has
    a purpose that is entirely well-defined independent of the
    application.  Therefore, Subsection 2d requires that any
    application-supplied function or table used by this function must
    be optional: if the application does not supply it, the square
    root function must still compute square roots.)

These requirements apply to the modified work as a whole.  If
identifiable sections of that work are not derived from the Library,
and can be reasonably considered independent and separate works in
themselves, then this License, and its terms, do not apply to those
sections when you distribute them as separate works.  But when you
distribute the same sections as part of a whole which is a work based
on the Library, the distribution of the whole must be on the terms of
this License, whose permissions for other licensees extend to the
entire whole, and thus to each and every part regardless of who wrote
it.

Thus, it is not the intent of this section to claim rights or contest
your rights to work written entirely by you; rather, the intent is to
exercise the right to control the distribution of derivative or
collective works based on the Library.

In addition, mere aggregation of another work not based on the Library
with the Library (or with a work based on the Library) on a volume of
a storage or distribution medium does not bring the other work under
the scope of this License.

  3. You may opt to apply the terms of the ordinary GNU General Public
License instead of this License to a given copy of the Library.  To do
this, you must alter all the notices that refer to this License, so
that they refer to the ordinary GNU General Public License, version 2,
instead of to this License.  (If a newer version than version 2 of the
ordinary GNU General Public License has appeared, then you can specify
that version instead if you wish.)  Do not make any other change in
these notices.

  Once this change is made in a given copy, it is irreversible for
that copy, so the ordinary GNU General Public License applies to all
subsequent copies and derivative works made from that copy.

  This option is useful when you wish to copy part of the code of
the Library into a program that is not a library.

  4. You may copy and distribute the Library (or a portion or
derivative of it, under Section 2) in object code or executable form
under the terms of Sections 1 and 2 above provided that you accompany
it with the complete corresponding machine-readable source code, which
must be distributed under the terms of Sections 1 and 2 above on a
medium customarily used for software interchange.

  If distribution of object code is made by offering access to copy
from a designated place, then offering equivalent access to copy the
source code from the same place satisfies the requirement to
distribute the source code, even though third parties are not
compelled to copy the source along with the object code.

  5. A program that contains no derivative of any portion of the
Library, but is designed to work with the Library by being compiled or
linked with it, is called a "work that uses the Library".  Such a
work, in isolation, is not a derivative work of the Library, and
therefore falls outside the scope of this License.

  However, linking a "work that uses the Library" with the Library
creates an executable that is a derivative of the Library (because it
contains portions of the Library), rather than a "work that uses the
library".  The executable is therefore covered by this License.
Section 6 states terms for distribution of such executables.

  When a "work that uses the Library" uses material from a header file
that is part of the Library, the object code for the work may be a
derivative work of the Library even though the source code is not.
Whether this is true is especially significant if the work can be
linked without the Library, or if the work is itself a library.  The
threshold for this to be true is not precisely defined by law.

  If such an object file uses only numerical parameters, data
structure layouts and accessors, and small macros and small inline
functions (ten lines or less in length), then the use of the object
file is unrestricted, regardless of whether it is legally a derivative
work.  (Executables containing this object code plus portions of the
Library will still fall under Section 6.)

  Otherwise, if the work is a derivative of the Library, you may
distribute the object code for the work under the terms of Section 6.
Any executables containing that work also fall under Section 6,
whether or not they are linked directly with the Library itself.

  6. As an exception to the Sections above, you may also combine or
link a "work that uses the Library" with the Library to produce a
work containing portions of the Library, and distribute that work
under terms of your choice, provided that the terms permit
modification of the work for the customer's own use and reverse
engineering for debugging such modifications.

  You must give prominent notice with each copy of the work that the
Library is used in it and that the Library and its use are covered by
this License.  You must supply a copy of this License.  If the work
during execution displays copyright notices, you must include the
copyright notice for the Library among them, as well as a reference
directing the user to the copy of this License.  Also, you must do one
of these things:

    a) Accompany the work with the complete corresponding
    machine-readable source code for the Library including whatever
    changes were used in the work (which must be distributed under
    Sections 1 and 2 above); and, if the work is an executable linked
    with the Library, with the complete machine-readable "work that
    uses the Library", as object code and/or source code, so that the
    user can modify the Library and then relink to produce a modified
    executable containing the modified Library.  (It is understood
    that the user who changes the contents of definitions files in the
    Library will not necessarily be able to recompile the application
    to use the modified definitions.)

    b) Use a suitable shared library mechanism for linking with the
    Library.  A suitable mechanism is one that (1) uses at run time a
    copy of the library already present on the user's computer system,
    rather than copying library functions into the executable, and (2)
    will operate properly with a modified version of the library, if
    the user installs one, as long as the modified version is
    interface-compatible with the version that the work was made with.

    c) Accompany the work with a written offer, valid for at
    least three years, to give the same user the materials
    specified in Subsection 6a, above, for a charge no more
    than the cost of performing this distribution.

    d) If distribution of the work is made by offering access to copy
    from a designated place, offer equivalent access to copy the above
    specified materials from the same place.

    e) Verify that the user has already received a copy of these
    materials or that you have already sent this user a copy.

  For an executable, the required form of the "work that uses the
Library" must include any data and utility programs needed for
reproducing the executable from it.  However, as a special exception,
the materials to be distributed need not include anything that is
normally distributed (in either source or binary form) with the major
components (compiler, kernel, and so on) of the operating system on
which the executable runs, unless that component itself accompanies
the executable.

  It may happen that this requirement contradicts the license
restrictions of other proprietary libraries that do not normally
accompany the operating system.  Such a contradiction means you cannot
use both them and the Library together in an executable that you
distribute.

  7. You may place library facilities that are a work based on the
Library side-by-side in a single library together with other library
facilities not covered by this License, and distribute such a combined
library, provided that the separate distribution of the work based on
the Library and of the other library facilities is otherwise
permitted, and provided that you do these two things:

    a) Accompany the combined library with a copy of the same work
    based on the Library, uncombined with any other library
    facilities.  This must be distributed under the terms of the
    Sections above.

    b) Give prominent notice with the combined library of the fact
    that part of it is a work based on the Library, and explaining
    where to find the accompanying uncombined form of the same work.

  8. You may not copy, modify, sublicense, link with, or distribute
the Library except as expressly provided under this License.  Any
attempt otherwise to copy, modify, sublicense, link with, or
distribute the Library is void, and will automatically terminate your
rights under this License.  However, parties who have received copies,
or rights, from you under this License will not have their licenses
terminated so long as such parties remain in full compliance.

  9. You are not required to accept this License, since you have not
signed it.  However, nothing else grants you permission to modify or
distribute the Library or its derivative works.  These actions are
prohibited by law if you do not accept this License.  Therefore, by
modifying or distributing the Library (or any work based on the
Library), you indicate your acceptance of this License to do so, and
all its terms and conditions for copying, distributing or modifying
the Library or works based on it.

  10. Each time you redistribute the Library (or any work based on the
Library), the recipient automatically receives a license from the
original licensor to copy, distribute, link with or modify the Library
subject to these terms and conditions.  You may not impose any further
restrictions on the recipients' exercise of the rights granted herein.
You are not responsible for enforcing compliance by third parties with
this License.

  11. If, as a consequence of a court judgment or allegation of patent
infringement or for any other reason (not limited to patent issues),
conditions are imposed on you (whether by court order, agreement or
otherwise) that contradict the conditions of this License, they do not
excuse you from the conditions of this License.  If you cannot
distribute so as to satisfy simultaneously your obligations under this
License and any other pertinent obligations, then as a consequence you
may not distribute the Library at all.  For example, if a patent
license would not permit royalty-free redistribution of the Library by
all those who receive copies directly or indirectly through you, then
the only way you could satisfy both it and this License would be to
refrain entirely from distribution of the Library.

If any portion of this section is held invalid or unenforceable under any
particular circumstance, the balance of the section is intended to apply,
and the section as a whole is intended to apply in other circumstances.

It is not the purpose of this section to induce you to infringe any
patents or other property right claims or to contest validity of any
such claims; this section has the sole purpose of protecting the
integrity of the free software distribution system which is
implemented by public license practices.  Many people have made
generous contributions to the wide range of software distributed
through that system in reliance on consistent application of that
system; it is up to the author/donor to decide if he or she is willing
to distribute software through any other system and a licensee cannot
impose that choice.

This section is intended to make thoroughly clear what is believed to
be a consequence of the rest of this License.

  12. If the distribution and/or use of the Library is restricted in
certain countries either by patents or by copyrighted interfaces, the
original copyright holder who places the Library under this License may add
an explicit geographical distribution limitation excluding those countries,
so that distribution is permitted only in or among countries not thus
excluded.  In such case, this License incorporates the limitation as if
written in the body of this License.

  13. The Free Software Foundation may publish revised and/or new
versions of the Lesser General Public License from time to time.
Such new versions will be similar in spirit to the present version,
but may differ in detail to address new problems or concerns.

Each version is given a distinguishing version number.  If the Library
specifies a version number of this License which applies to it and
"any later version", you have the option of following the terms and
conditions either of that version or of any later version published by
the Free Software Foundation.  If the Library does not specify a
license version number, you may choose any version ever published by
the Free Software Foundation.

  14. If you wish to incorporate parts of the Library into other free
programs whose distribution conditions are incompatible with these,
write to the author to ask for permission.  For software which is
copyrighted by the Free Software Foundation, write to the Free
Software Foundation; we sometimes make exceptions for this.  Our
decision will be guided by the two goals of preserving the free status
of all derivatives of our free software and of promoting the sharing
and reuse of software generally.

			    NO WARRANTY

  15. BECAUSE THE LIBRARY IS LICENSED FREE OF CHARGE, THERE IS NO
WARRANTY FOR THE LIBRARY, TO THE EXTENT PERMITTED BY APPLICABLE LAW.
EXCEPT WHEN OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR
OTHER PARTIES PROVIDE THE LIBRARY "AS IS" WITHOUT WARRANTY OF ANY
KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE
IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
PURPOSE.  THE ENTIRE RISK AS TO THE QUALITY AND PERFORMANCE OF THE
LIBRARY IS WITH YOU.  SHOULD THE LIBRARY PROVE DEFECTIVE, YOU ASSUME
THE COST OF ALL NECESSARY SERVICING, REPAIR OR CORRECTION.

  16. IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN
WRITING WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY
AND/OR REDISTRIBUTE THE LIBRARY AS PERMITTED ABOVE, BE LIABLE TO YOU
FOR DAMAGES, INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR
CONSEQUENTIAL DAMAGES ARISING OUT OF THE USE OR INABILITY TO USE THE
LIBRARY (INCLUDING BUT NOT LIMITED TO LOSS OF DATA OR DATA BEING
RENDERED INACCURATE OR LOSSES SUSTAINED BY YOU OR THIRD PARTIES OR A
FAILURE OF THE LIBRARY TO OPERATE WITH ANY OTHER SOFTWARE), EVEN IF
SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH
DAMAGES.

		     END OF TERMS AND CONDITIONS



======================================================================
FILE PATH: editor\editor.html
======================================================================
<html>
  <head>
    <title>iMacros Editor</title>
    <link rel="stylesheet" type="text/css"
          href="../skin/common.css" />
    <link rel="stylesheet" type="text/css"
          href="../skin/editor.css" />
    <script src="../utils.js"></script>
    <script src="editor.js"></script>
  </head>
  <body>
    <iframe id="editbox" src="editarea/imacro.html"></iframe>
    <div id="buttonpack">
      <div id="save-button" class="button icon-button">
        <span>Save & Close</span>
      </div>
      <div id="saveas-button" class="button icon-button">
        <span>Save As & Close</span>
      </div>
      <div id="cancel-button" class="button icon-button">
        <span>Cancel</span>
      </div>
    </div>
  </body>
</html>



======================================================================
FILE PATH: editor\editor.js
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/



//script for Integrated editor


var Editor = {
    init: function (file) {
        var doc = window.frames["editbox"].contentDocument;
        var bypass = doc.getElementById("bypass");
        if (!bypass || !bypass.hasAttribute("inited")) {
            setTimeout(function () { Editor.init(file); }, 100);
            return;
        }
        bypass.setAttribute("lang", "en");
        bypass.setAttribute("syntax", file.type || "imacro");
        var evt = doc.createEvent("Events");
        evt.initEvent("iMacrosEditorInitEvent", true, false);
        bypass.dispatchEvent(evt);

        if (file) {
            this.completeLoad(file);
        } 

        this.attachListeners();
    },

    completeLoad: function (file) {
        var doc = window.frames["editbox"].contentDocument;
        // send notification to EditArea
        var bypass = doc.getElementById("bypass");
        bypass.setAttribute("filename", file.name || "");
        bypass.setAttribute("bookmark_id", file.bookmark_id || "");
        bypass.setAttribute("file_id", file.file_id || "");
        bypass.setAttribute("content", file.source);
        bypass.setAttribute("syntax", file.type || "imacro");
        var evt = doc.createEvent("Events");
        evt.initEvent("iMacrosEditorLoadCompleteEvent", true, false);
        bypass.dispatchEvent(evt);
        // set title
        document.title = file.name+" - iMacros Editor";
        // save original source
        this.originalSource = file.source;
        this.win_id = file.win_id;
    },

    attachListeners: function () {
        document.addEventListener("iMacrosEditorSaveEvent",
                                  function(e) { Editor.listen(e); },
                                  false);
        document.addEventListener("iMacrosEditorLoadEvent",
                                  function(e) { Editor.listen(e); },
                                  false);
    },


    saveFile: function () {
        var bg = chrome.extension.getBackgroundPage();
        var r = this.getEditAreaData();
        if (!r.name) {
            r.name = prompt("Enter macro name:", "Unnamed Macro");
        }

        if (!r.name)
            return false;
        var save_data = {
            name: r.name,
            source: r.source,
            bookmark_id: r.bookmark_id,
            file_id: r.file_id,
            type: r.syntax,
            win_id: this.win_id
        };

        bg.save(save_data, /* overwrite = */ true); 
        this.originalSource = r.source;

        return true;
    },

    saveFileAs: function () {
        var bg = chrome.extension.getBackgroundPage();
        var features = "titlebar=no,menubar=no,location=no,"+
            "resizable=yes,scrollbars=no,status=no";

        var r = this.getEditAreaData();
        
        var save_data = {
            name: r.name,
            source: r.source,
            bookmark_id: "",
            file_id: r.file_id,
            type: r.syntax,
            win_id: this.win_id
        };

        var win = window.open("saveAsDialog.html",
                              null, features);
        
       bg.dialogUtils.setArgs(win, {save_data: save_data});
        
        return true;
    },


    getEditAreaData: function () {
        var doc = window.frames["editbox"].contentDocument;
        // send notification to EditArea
        var bypass = doc.getElementById("bypass");
        var evt = doc.createEvent("Events");
        evt.initEvent("iMacrosEditorGetContentEvent", true, false);
        bypass.dispatchEvent(evt);
        var source = bypass.getAttribute("content");
        var name = bypass.getAttribute("filename");
        var bookmark_id = bypass.getAttribute("bookmark_id");
        var file_id = bypass.getAttribute("file_id");
        var syntax = bypass.getAttribute("syntax");

        return {source: source,
                name: name,
                bookmark_id: bookmark_id,
                file_id: file_id,
                syntax: syntax};
    },
    
    checkFileChanged: function () {
        var r = this.getEditAreaData();
        return this.originalSource != r.source;
    },


    checkPermissions: function(file) {
        // TODO: check if this is required
        return true;
    },


    loadFile: function () {
        console.log("loadFile, TODO: add real code here");
    },
    
    getSelection: function () {
        var doc = window.frames["editbox"].contentDocument;
        // send notification to EditArea
        var bypass = doc.getElementById("bypass");
        var evt = doc.createEvent("Events");
        evt.initEvent("iMacrosEditorGetSelection", true, false);
        bypass.dispatchEvent(evt);
        var selection = bypass.getAttribute("selection");
        return selection;
    },


    setSelection: function (text) {
        var doc = window.frames["editbox"].contentDocument;
        // send notification to EditArea
        var bypass = doc.getElementById("bypass");
        var evt = doc.createEvent("Events");
        evt.initEvent("iMacrosEditorSetSelection", true, false);
        bypass.setAttribute("selection", text);
        bypass.dispatchEvent(evt);
    },

    // context menu handler

    onContextShowing: function() {
        // TODO: add right-click menu
    },

    listen: function(evt) {
        if (evt.type == "iMacrosEditorSaveEvent") {
            var content = evt.target.getAttribute("content");
            this.saveFileAs(evt);
        } else if (evt.type == "iMacrosEditorLoadEvent") {
            this.loadFile(evt);
        }
    }
};


function cancel() {
    window.close();
}

function saveAndQuit() {
    if (Editor.saveFile())
        window.close();         
}


function timedClose() {
    setTimeout(function() { window.close(); }, 100);
}

function saveAsAndQuit() {
    Editor.saveFileAs();
}


window.addEventListener("load", function() {
    if (!args.overwrite)
        document.getElementById("save-button").style.display = "none";
    Editor.init(args.macro);
    document.getElementById("save-button").addEventListener("click", saveAndQuit);
    document.getElementById("saveas-button").addEventListener("click", saveAsAndQuit);
    document.getElementById("cancel-button").addEventListener("click", cancel);
});


window.addEventListener("beforeunload", function() {
    if (Editor.checkFileChanged()) {
        var msg = "File content was changed. Would you like to save changes?";
        if (window.confirm(msg))
            Editor.saveFile();
    }
    return null;
});



======================================================================
FILE PATH: editor\saveAsDialog.html
======================================================================
<html>
  <head>
    <title>Save Macro as:</title>
    <link rel="stylesheet" type="text/css"
          href="../skin/common.css" />
    <link rel="stylesheet" type="text/css"
          href="../skin/saveAsDialog.css" />
    <script src="../utils.js"></script>
    <script src="../AsyncFileIO.js"></script>
    <script src="saveAsDialog.js"></script>
  </head>
  <body>
    <div id="main-container" class="vbox">
      <div class="box centered">
        <span>Enter new macro name:</span>
      </div>
      <div class="box centered">
        <input type="text" id="macro-name"></input>
      </div>
      <div id="tree-switcher-box" class="vbox">
        <div class="box centered">
          <span>Macro Storage:</span>
        </div>
        <div class="hbox centered">
          <input id="radio-files-tree"
                 class="tree-switcher"
                 type="radio" name="tree-view"></input>
          <label for="radio-files-tree">Files</label>
          <input id="radio-bookmarks-tree"
                 class="tree-switcher"
                 type="radio" name="tree-view"></input>
          <label for="radio-bookmarks-tree">Bookmarks</label>
        </div>
      </div>
      <div id="buttonpack" class="hbox centered">
        <div id="ok-button" class="button icon-button">
          <span>OK</span>
        </div>
        <div id="cancel-button" class="button icon-button">
          <span>Cancel</span>
        </div>
      </div>
    </div>
  </body>
</html>



======================================================================
FILE PATH: editor\saveAsDialog.js
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/

var args;

window.addEventListener("load", function() {
	let bg = chrome.extension.getBackgroundPage();
	args = bg.dialogUtils.getArgs(window);
	
    var mc = document.getElementById("main-container");
    var rc = mc.getBoundingClientRect();
    window.resizeTo(rc.width+30, rc.height+30);
    window.moveTo(window.opener.screenX+window.opener.outerWidth/2-100,
                  window.opener.screenY+window.opener.outerHeight/2-100);
    var macro_name = document.getElementById("macro-name");
    macro_name.value = args.save_data.name || "Unnamed Macro";
    macro_name.select();
    macro_name.focus();
    macro_name.addEventListener("keypress", function(e) {
        if (e.which == 13) ok();
    });
    
    var file_type = !!args.save_data.file_id;
    if (file_type) {
        document.getElementById("radio-files-tree").checked="yes";
    } else {
        document.getElementById("radio-bookmarks-tree").checked="yes";
    }

    // add event listeners for buttons
    document.getElementById("ok-button").addEventListener("click", ok);
    document.getElementById("cancel-button").addEventListener("click", cancel);
    
    // TODO: add directory option
});


function ok() {
    var macro_name = document.getElementById("macro-name");
    args.save_data.name = macro_name.value;

    var overwrite = false;

    if (!/\.iim$/.test(args.save_data.name)) // append .iim extension
        args.save_data.name += ".iim";

    var bg = chrome.extension.getBackgroundPage();
    if (!document.getElementById("radio-files-tree").checked) {
        // save macro as bookmark
        if (args.save_data.file_id)
            args.save_data.file_id = "";
        bg.save(args.save_data, overwrite);
        // window.opener.Editor.originalSource = args.save_data.source;
        // window.opener.timedClose();
        window.close();
        return;
    }

    // otherwise save macro as a file
    args.save_data.bookmark_id = "";
    afio.isInstalled().then(function(installed) {
        if (!installed) {
            alert("Please install file support for iMacros "+
                  "to save macro as a file");
            return;
        }
        afio.getDefaultDir("savepath").then(function(node) {
            if (!args.save_data.file_id) {
                node.append(args.save_data.name);
                args.save_data.file_id = node.path;
            } else {
                node = afio.openNode(args.save_data.file_id);
                node = node.parent;
                node.append(args.save_data.name);
                args.save_data.file_id = node.path;
            }

            node.exists().then(function(exists) {
                if (exists) {
                    overwrite = confirm("Macro "+node.leafName+
                                        " already exists.\n"+
                                        "Do you want to overwrite it?");
                    if (!overwrite)
                        return;
                }
                bg.save(args.save_data, overwrite, function() {
                    // window.opener.Editor.originalSource = args.save_data.source;
                    // window.opener.timedClose();
                    window.close();
                });
            }).catch(console.error.bind(console));
        });
    });
}


function cancel() {
    window.close();
}



======================================================================
FILE PATH: old_file\manifest.json
======================================================================
{
"update_url": "https://clients2.google.com/service/update2/crx",

    "manifest_version": 2,

    "content_scripts": [
        {
            "js": [
                "content_scripts/bookmarks_handler.js",
                "content_scripts/si_listener.js"
            ],
            "matches": ["http://*/*", "https://*/*", "file://*"],
            "run_at": "document_start",
            "all_frames": false
        },
        {
            "js": [
                "utils.js",
                "content_scripts/connector.js",
                "content_scripts/recorder.js",
                "content_scripts/player.js"
            ],
            "matches": ["http://*/*", "https://*/*", "file://*"],
            "run_at": "document_idle",
            "all_frames": true
        }
    ],

    "description": "Automate your web browser. Record and replay repetitious work",
    "name": "iMacros for Chrome",
    "version": "10.1.1",
    "minimum_chrome_version": "51",
    "homepage_url": "https://imacros.net",

    "browser_action": {
        "default_title": "iMacros for Chrome",
        "default_icon": {"19": "skin/logo19.png", "38": "skin/logo38.png"}
    },

    "background": {"page": "bg.html"},

    "options_page": "options.html",

    "permissions": [
        "tabs",
        "bookmarks",
        "proxy",
        "cookies",
        "pageCapture",
        "webNavigation",
        "notifications",
        "webRequest",
        "webRequestBlocking",
        "nativeMessaging",
        "downloads",
        "contextMenus",
        "debugger",
        "<all_urls>"
    ],

    "icons": { "16": "skin/logo16.png",
               "48": "skin/logo48.png",
               "128": "skin/logo128.png" },

    "web_accessible_resources": [
        "skin/logo24.png"
    ],

    "sandbox": {
        "pages": ["sandbox.html"]
    },
    
    "commands": {
        "_execute_browser_action": {
          "suggested_key": {
            "default": "Ctrl+8",
            "mac": "Command+8"
            }
        }
    }
}



======================================================================
FILE PATH: skin\imicons\icons-reference.html
======================================================================
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Font Reference - iMIcons</title>
    <link href="http://fonts.googleapis.com/css?family=Dosis:400,500,700" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="styles.css">
    <style type="text/css">html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-weight:inherit;font-style:inherit;font-family:inherit;font-size:100%;vertical-align:baseline}body{line-height:1;color:#000;background:#fff}ol,ul{list-style:none}table{border-collapse:separate;border-spacing:0;vertical-align:middle}caption,th,td{text-align:left;font-weight:normal;vertical-align:middle}a img{border:none}*{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}body{font-family:'Dosis','Tahoma',sans-serif}.container{margin:15px auto;width:80%}h1{margin:40px 0 20px;font-weight:700;font-size:38px;line-height:32px;color:#fb565e}h2{font-size:18px;padding:0 0 21px 5px;margin:45px 0 0 0;text-transform:uppercase;font-weight:500}.small{font-size:14px;color:#a5adb4;}.small a{color:#a5adb4;}.small a:hover{color:#fb565e}.glyphs.character-mapping{margin:0 0 20px 0;padding:20px 0 20px 30px;color:rgba(0,0,0,0.5);border:1px solid #d8e0e5;-webkit-border-radius:3px;border-radius:3px;}.glyphs.character-mapping li{margin:0 30px 20px 0;display:inline-block;width:90px}.glyphs.character-mapping .icon{margin:10px 0 10px 15px;padding:15px;position:relative;width:55px;height:55px;color:#162a36 !important;overflow:hidden;-webkit-border-radius:3px;border-radius:3px;font-size:32px;}.glyphs.character-mapping .icon svg{fill:#000}.glyphs.character-mapping input{margin:0;padding:5px 0;line-height:12px;font-size:12px;display:block;width:100%;border:1px solid #d8e0e5;-webkit-border-radius:5px;border-radius:5px;text-align:center;outline:0;}.glyphs.character-mapping input:focus{border:1px solid #fbde4a;-webkit-box-shadow:inset 0 0 3px #fbde4a;box-shadow:inset 0 0 3px #fbde4a}.glyphs.character-mapping input:hover{-webkit-box-shadow:inset 0 0 3px #fbde4a;box-shadow:inset 0 0 3px #fbde4a}.glyphs.css-mapping{margin:0 0 60px 0;padding:30px 0 20px 30px;color:rgba(0,0,0,0.5);border:1px solid #d8e0e5;-webkit-border-radius:3px;border-radius:3px;}.glyphs.css-mapping li{margin:0 30px 20px 0;padding:0;display:inline-block;overflow:hidden}.glyphs.css-mapping .icon{margin:0;margin-right:10px;padding:13px;height:50px;width:50px;color:#162a36 !important;overflow:hidden;float:left;font-size:24px}.glyphs.css-mapping input{margin:0;margin-top:5px;padding:8px;line-height:16px;font-size:16px;display:block;width:150px;height:40px;border:1px solid #d8e0e5;-webkit-border-radius:5px;border-radius:5px;background:#fff;outline:0;float:right;}.glyphs.css-mapping input:focus{border:1px solid #fbde4a;-webkit-box-shadow:inset 0 0 3px #fbde4a;box-shadow:inset 0 0 3px #fbde4a}.glyphs.css-mapping input:hover{-webkit-box-shadow:inset 0 0 3px #fbde4a;box-shadow:inset 0 0 3px #fbde4a}</style>
  </head>
  <body>
    <div class="container">
      <h1>iMIcons</h1>
      <p class="small">This font was created with<a href="http://fontastic.me/">Fontastic</a></p>
      <h2>CSS mapping</h2>
      <ul class="glyphs css-mapping">
        <li>
          <div class="icon icon-check"></div>
          <input type="text" readonly="readonly" value="check">
        </li>
        <li>
          <div class="icon icon-question"></div>
          <input type="text" readonly="readonly" value="question">
        </li>
        <li>
          <div class="icon icon-play"></div>
          <input type="text" readonly="readonly" value="play">
        </li>
        <li>
          <div class="icon icon-times-circle-o"></div>
          <input type="text" readonly="readonly" value="times-circle-o">
        </li>
        <li>
          <div class="icon icon-times"></div>
          <input type="text" readonly="readonly" value="times">
        </li>
        <li>
          <div class="icon icon-times-circle"></div>
          <input type="text" readonly="readonly" value="times-circle">
        </li>
        <li>
          <div class="icon icon-play-circle-o"></div>
          <input type="text" readonly="readonly" value="play-circle-o">
        </li>
        <li>
          <div class="icon icon-pencil"></div>
          <input type="text" readonly="readonly" value="pencil">
        </li>
        <li>
          <div class="icon icon-pause"></div>
          <input type="text" readonly="readonly" value="pause">
        </li>
        <li>
          <div class="icon icon-floppy-o"></div>
          <input type="text" readonly="readonly" value="floppy-o">
        </li>
        <li>
          <div class="icon icon-folder-open"></div>
          <input type="text" readonly="readonly" value="folder-open">
        </li>
        <li>
          <div class="icon icon-folder-open-o"></div>
          <input type="text" readonly="readonly" value="folder-open-o">
        </li>
        <li>
          <div class="icon icon-folder"></div>
          <input type="text" readonly="readonly" value="folder">
        </li>
        <li>
          <div class="icon icon-folder-o"></div>
          <input type="text" readonly="readonly" value="folder-o">
        </li>
        <li>
          <div class="icon icon-file-code-o"></div>
          <input type="text" readonly="readonly" value="file-code-o">
        </li>
        <li>
          <div class="icon icon-exclamation"></div>
          <input type="text" readonly="readonly" value="exclamation">
        </li>
        <li>
          <div class="icon icon-caret-right"></div>
          <input type="text" readonly="readonly" value="caret-right">
        </li>
        <li>
          <div class="icon icon-caret-down"></div>
          <input type="text" readonly="readonly" value="caret-down">
        </li>
        <li>
          <div class="icon icon-refresh"></div>
          <input type="text" readonly="readonly" value="refresh">
        </li>
        <li>
          <div class="icon icon-question-circle"></div>
          <input type="text" readonly="readonly" value="question-circle">
        </li>
        <li>
          <div class="icon icon-search-plus"></div>
          <input type="text" readonly="readonly" value="search-plus">
        </li>
        <li>
          <div class="icon icon-search-minus"></div>
          <input type="text" readonly="readonly" value="search-minus">
        </li>
        <li>
          <div class="icon icon-search"></div>
          <input type="text" readonly="readonly" value="search">
        </li>
        <li>
          <div class="icon icon-server"></div>
          <input type="text" readonly="readonly" value="server">
        </li>
        <li>
          <div class="icon icon-stop"></div>
          <input type="text" readonly="readonly" value="stop">
        </li>
        <li>
          <div class="icon icon-check-circle-o"></div>
          <input type="text" readonly="readonly" value="check-circle-o">
        </li>
        <li>
          <div class="icon icon-check-circle"></div>
          <input type="text" readonly="readonly" value="check-circle">
        </li>
        <li>
          <div class="icon icon-check-square-o"></div>
          <input type="text" readonly="readonly" value="check-square-o">
        </li>
        <li>
          <div class="icon icon-check-square"></div>
          <input type="text" readonly="readonly" value="check-square">
        </li>
        <li>
          <div class="icon icon-clipboard"></div>
          <input type="text" readonly="readonly" value="clipboard">
        </li>
        <li>
          <div class="icon icon-clone"></div>
          <input type="text" readonly="readonly" value="clone">
        </li>
        <li>
          <div class="icon icon-cog"></div>
          <input type="text" readonly="readonly" value="cog">
        </li>
        <li>
          <div class="icon icon-cogs"></div>
          <input type="text" readonly="readonly" value="cogs">
        </li>
        <li>
          <div class="icon icon-exclamation-circle"></div>
          <input type="text" readonly="readonly" value="exclamation-circle">
        </li>
        <li>
          <div class="icon icon-eraser"></div>
          <input type="text" readonly="readonly" value="eraser">
        </li>
        <li>
          <div class="icon icon-file-o"></div>
          <input type="text" readonly="readonly" value="file-o">
        </li>
        <li>
          <div class="icon icon-file-text-o"></div>
          <input type="text" readonly="readonly" value="file-text-o">
        </li>
        <li>
          <div class="icon icon-files-o"></div>
          <input type="text" readonly="readonly" value="files-o">
        </li>
        <li>
          <div class="icon icon-info"></div>
          <input type="text" readonly="readonly" value="info">
        </li>
        <li>
          <div class="icon icon-info-circle"></div>
          <input type="text" readonly="readonly" value="info-circle">
        </li>
        <li>
          <div class="icon icon-list"></div>
          <input type="text" readonly="readonly" value="list">
        </li>
        <li>
          <div class="icon icon-list-alt"></div>
          <input type="text" readonly="readonly" value="list-alt">
        </li>
        <li>
          <div class="icon icon-play-circle"></div>
          <input type="text" readonly="readonly" value="play-circle">
        </li>
        <li>
          <div class="icon icon-pencil-square"></div>
          <input type="text" readonly="readonly" value="pencil-square">
        </li>
        <li>
          <div class="icon icon-pencil-square-o"></div>
          <input type="text" readonly="readonly" value="pencil-square-o">
        </li>
        <li>
          <div class="icon icon-square"></div>
          <input type="text" readonly="readonly" value="square">
        </li>
        <li>
          <div class="icon icon-bullseye"></div>
          <input type="text" readonly="readonly" value="bullseye">
        </li>
        <li>
          <div class="icon icon-circle"></div>
          <input type="text" readonly="readonly" value="circle">
        </li>
        <li>
          <div class="icon icon-circle-o"></div>
          <input type="text" readonly="readonly" value="circle-o">
        </li>
        <li>
          <div class="icon icon-code"></div>
          <input type="text" readonly="readonly" value="code">
        </li>
        <li>
          <div class="icon icon-ellipsis-v"></div>
          <input type="text" readonly="readonly" value="ellipsis-v">
        </li>
        <li>
          <div class="icon icon-file-image-o"></div>
          <input type="text" readonly="readonly" value="file-image-o">
        </li>
        <li>
          <div class="icon icon-file-text"></div>
          <input type="text" readonly="readonly" value="file-text">
        </li>
        <li>
          <div class="icon icon-picture-o"></div>
          <input type="text" readonly="readonly" value="picture-o">
        </li>
        <li>
          <div class="icon icon-paragraph"></div>
          <input type="text" readonly="readonly" value="paragraph">
        </li>
        <li>
          <div class="icon icon-sliders"></div>
          <input type="text" readonly="readonly" value="sliders">
        </li>
        <li>
          <div class="icon icon-trash"></div>
          <input type="text" readonly="readonly" value="trash">
        </li>
        <li>
          <div class="icon icon-trash-o"></div>
          <input type="text" readonly="readonly" value="trash-o">
        </li>
        <li>
          <div class="icon icon-undo"></div>
          <input type="text" readonly="readonly" value="undo">
        </li>
        <li>
          <div class="icon icon-wrench"></div>
          <input type="text" readonly="readonly" value="wrench">
        </li>
        <li>
          <div class="icon icon-unlock-alt"></div>
          <input type="text" readonly="readonly" value="unlock-alt">
        </li>
        <li>
          <div class="icon icon-unlock"></div>
          <input type="text" readonly="readonly" value="unlock">
        </li>
        <li>
          <div class="icon icon-spinner"></div>
          <input type="text" readonly="readonly" value="spinner">
        </li>
        <li>
          <div class="icon icon-expeditedssl"></div>
          <input type="text" readonly="readonly" value="expeditedssl">
        </li>
        <li>
          <div class="icon icon-caret-up"></div>
          <input type="text" readonly="readonly" value="caret-up">
        </li>
        <li>
          <div class="icon icon-caret-left"></div>
          <input type="text" readonly="readonly" value="caret-left">
        </li>
      </ul>
      <h2>Character mapping</h2>
      <ul class="glyphs character-mapping">
        <li>
          <div data-icon="a" class="icon"></div>
          <input type="text" readonly="readonly" value="a">
        </li>
        <li>
          <div data-icon="b" class="icon"></div>
          <input type="text" readonly="readonly" value="b">
        </li>
        <li>
          <div data-icon="c" class="icon"></div>
          <input type="text" readonly="readonly" value="c">
        </li>
        <li>
          <div data-icon="d" class="icon"></div>
          <input type="text" readonly="readonly" value="d">
        </li>
        <li>
          <div data-icon="e" class="icon"></div>
          <input type="text" readonly="readonly" value="e">
        </li>
        <li>
          <div data-icon="f" class="icon"></div>
          <input type="text" readonly="readonly" value="f">
        </li>
        <li>
          <div data-icon="g" class="icon"></div>
          <input type="text" readonly="readonly" value="g">
        </li>
        <li>
          <div data-icon="h" class="icon"></div>
          <input type="text" readonly="readonly" value="h">
        </li>
        <li>
          <div data-icon="i" class="icon"></div>
          <input type="text" readonly="readonly" value="i">
        </li>
        <li>
          <div data-icon="j" class="icon"></div>
          <input type="text" readonly="readonly" value="j">
        </li>
        <li>
          <div data-icon="k" class="icon"></div>
          <input type="text" readonly="readonly" value="k">
        </li>
        <li>
          <div data-icon="l" class="icon"></div>
          <input type="text" readonly="readonly" value="l">
        </li>
        <li>
          <div data-icon="m" class="icon"></div>
          <input type="text" readonly="readonly" value="m">
        </li>
        <li>
          <div data-icon="n" class="icon"></div>
          <input type="text" readonly="readonly" value="n">
        </li>
        <li>
          <div data-icon="o" class="icon"></div>
          <input type="text" readonly="readonly" value="o">
        </li>
        <li>
          <div data-icon="p" class="icon"></div>
          <input type="text" readonly="readonly" value="p">
        </li>
        <li>
          <div data-icon="q" class="icon"></div>
          <input type="text" readonly="readonly" value="q">
        </li>
        <li>
          <div data-icon="r" class="icon"></div>
          <input type="text" readonly="readonly" value="r">
        </li>
        <li>
          <div data-icon="s" class="icon"></div>
          <input type="text" readonly="readonly" value="s">
        </li>
        <li>
          <div data-icon="t" class="icon"></div>
          <input type="text" readonly="readonly" value="t">
        </li>
        <li>
          <div data-icon="u" class="icon"></div>
          <input type="text" readonly="readonly" value="u">
        </li>
        <li>
          <div data-icon="v" class="icon"></div>
          <input type="text" readonly="readonly" value="v">
        </li>
        <li>
          <div data-icon="w" class="icon"></div>
          <input type="text" readonly="readonly" value="w">
        </li>
        <li>
          <div data-icon="x" class="icon"></div>
          <input type="text" readonly="readonly" value="x">
        </li>
        <li>
          <div data-icon="y" class="icon"></div>
          <input type="text" readonly="readonly" value="y">
        </li>
        <li>
          <div data-icon="z" class="icon"></div>
          <input type="text" readonly="readonly" value="z">
        </li>
        <li>
          <div data-icon="A" class="icon"></div>
          <input type="text" readonly="readonly" value="A">
        </li>
        <li>
          <div data-icon="B" class="icon"></div>
          <input type="text" readonly="readonly" value="B">
        </li>
        <li>
          <div data-icon="C" class="icon"></div>
          <input type="text" readonly="readonly" value="C">
        </li>
        <li>
          <div data-icon="D" class="icon"></div>
          <input type="text" readonly="readonly" value="D">
        </li>
        <li>
          <div data-icon="E" class="icon"></div>
          <input type="text" readonly="readonly" value="E">
        </li>
        <li>
          <div data-icon="F" class="icon"></div>
          <input type="text" readonly="readonly" value="F">
        </li>
        <li>
          <div data-icon="G" class="icon"></div>
          <input type="text" readonly="readonly" value="G">
        </li>
        <li>
          <div data-icon="H" class="icon"></div>
          <input type="text" readonly="readonly" value="H">
        </li>
        <li>
          <div data-icon="I" class="icon"></div>
          <input type="text" readonly="readonly" value="I">
        </li>
        <li>
          <div data-icon="J" class="icon"></div>
          <input type="text" readonly="readonly" value="J">
        </li>
        <li>
          <div data-icon="K" class="icon"></div>
          <input type="text" readonly="readonly" value="K">
        </li>
        <li>
          <div data-icon="L" class="icon"></div>
          <input type="text" readonly="readonly" value="L">
        </li>
        <li>
          <div data-icon="M" class="icon"></div>
          <input type="text" readonly="readonly" value="M">
        </li>
        <li>
          <div data-icon="N" class="icon"></div>
          <input type="text" readonly="readonly" value="N">
        </li>
        <li>
          <div data-icon="O" class="icon"></div>
          <input type="text" readonly="readonly" value="O">
        </li>
        <li>
          <div data-icon="P" class="icon"></div>
          <input type="text" readonly="readonly" value="P">
        </li>
        <li>
          <div data-icon="Q" class="icon"></div>
          <input type="text" readonly="readonly" value="Q">
        </li>
        <li>
          <div data-icon="R" class="icon"></div>
          <input type="text" readonly="readonly" value="R">
        </li>
        <li>
          <div data-icon="S" class="icon"></div>
          <input type="text" readonly="readonly" value="S">
        </li>
        <li>
          <div data-icon="T" class="icon"></div>
          <input type="text" readonly="readonly" value="T">
        </li>
        <li>
          <div data-icon="U" class="icon"></div>
          <input type="text" readonly="readonly" value="U">
        </li>
        <li>
          <div data-icon="V" class="icon"></div>
          <input type="text" readonly="readonly" value="V">
        </li>
        <li>
          <div data-icon="W" class="icon"></div>
          <input type="text" readonly="readonly" value="W">
        </li>
        <li>
          <div data-icon="X" class="icon"></div>
          <input type="text" readonly="readonly" value="X">
        </li>
        <li>
          <div data-icon="Y" class="icon"></div>
          <input type="text" readonly="readonly" value="Y">
        </li>
        <li>
          <div data-icon="Z" class="icon"></div>
          <input type="text" readonly="readonly" value="Z">
        </li>
        <li>
          <div data-icon="0" class="icon"></div>
          <input type="text" readonly="readonly" value="0">
        </li>
        <li>
          <div data-icon="1" class="icon"></div>
          <input type="text" readonly="readonly" value="1">
        </li>
        <li>
          <div data-icon="2" class="icon"></div>
          <input type="text" readonly="readonly" value="2">
        </li>
        <li>
          <div data-icon="3" class="icon"></div>
          <input type="text" readonly="readonly" value="3">
        </li>
        <li>
          <div data-icon="4" class="icon"></div>
          <input type="text" readonly="readonly" value="4">
        </li>
        <li>
          <div data-icon="5" class="icon"></div>
          <input type="text" readonly="readonly" value="5">
        </li>
        <li>
          <div data-icon="6" class="icon"></div>
          <input type="text" readonly="readonly" value="6">
        </li>
        <li>
          <div data-icon="7" class="icon"></div>
          <input type="text" readonly="readonly" value="7">
        </li>
        <li>
          <div data-icon="8" class="icon"></div>
          <input type="text" readonly="readonly" value="8">
        </li>
        <li>
          <div data-icon="9" class="icon"></div>
          <input type="text" readonly="readonly" value="9">
        </li>
        <li>
          <div data-icon="!" class="icon"></div>
          <input type="text" readonly="readonly" value="!">
        </li>
        <li>
          <div data-icon="&#34;" class="icon"></div>
          <input type="text" readonly="readonly" value="&quot;">
        </li>
        <li>
          <div data-icon="#" class="icon"></div>
          <input type="text" readonly="readonly" value="#">
        </li>
        <li>
          <div data-icon="$" class="icon"></div>
          <input type="text" readonly="readonly" value="$">
        </li>
      </ul>
    </div>
    <script>(function() {
  var glyphs, i, len, ref;

  ref = document.getElementsByClassName('glyphs');
  for (i = 0, len = ref.length; i < len; i++) {
    glyphs = ref[i];
    glyphs.addEventListener('click', function(event) {
      if (event.target.tagName === 'INPUT') {
        return event.target.select();
      }
    });
  }

}).call(this);

    </script>
  </body>
</html>


======================================================================
FILE PATH: skin\imicons\styles.css
======================================================================
@charset "UTF-8";

@font-face {
  font-family: "imicons";
  src:url("fonts/imicons.eot");
  src:url("fonts/imicons.eot?#iefix") format("embedded-opentype"),
    url("fonts/imicons.woff") format("woff"),
    url("fonts/imicons.ttf") format("truetype"),
    url("fonts/imicons.svg#imicons") format("svg");
  font-weight: normal;
  font-style: normal;

}

[data-icon]:before {
  font-family: "imicons" !important;
  content: attr(data-icon);
  font-style: normal !important;
  font-weight: normal !important;
  font-variant: normal !important;
  text-transform: none !important;
  speak: none;
  line-height: 1;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

[class^="icon-"]:before,
[class*=" icon-"]:before {
  font-family: "imicons" !important;
  font-style: normal !important;
  font-weight: normal !important;
  font-variant: normal !important;
  text-transform: none !important;
  speak: none;
  line-height: 1;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.icon-check:before {
  content: "\61";
}
.icon-question:before {
  content: "\62";
}
.icon-play:before {
  content: "\63";
}
.icon-times-circle-o:before {
  content: "\64";
}
.icon-times:before {
  content: "\65";
}
.icon-times-circle:before {
  content: "\66";
}
.icon-play-circle-o:before {
  content: "\67";
}
.icon-pencil:before {
  content: "\68";
}
.icon-pause:before {
  content: "\69";
}
.icon-floppy-o:before {
  content: "\6a";
}
.icon-folder-open:before {
  content: "\6b";
}
.icon-folder-open-o:before {
  content: "\6c";
}
.icon-folder:before {
  content: "\6d";
}
.icon-folder-o:before {
  content: "\6e";
}
.icon-file-code-o:before {
  content: "\6f";
}
.icon-exclamation:before {
  content: "\70";
}
.icon-caret-right:before {
  content: "\71";
}
.icon-caret-down:before {
  content: "\72";
}
.icon-refresh:before {
  content: "\73";
}
.icon-question-circle:before {
  content: "\74";
}
.icon-search-plus:before {
  content: "\75";
}
.icon-search-minus:before {
  content: "\76";
}
.icon-search:before {
  content: "\77";
}
.icon-server:before {
  content: "\78";
}
.icon-stop:before {
  content: "\79";
}
.icon-check-circle-o:before {
  content: "\7a";
}
.icon-check-circle:before {
  content: "\41";
}
.icon-check-square-o:before {
  content: "\42";
}
.icon-check-square:before {
  content: "\43";
}
.icon-clipboard:before {
  content: "\44";
}
.icon-clone:before {
  content: "\45";
}
.icon-cog:before {
  content: "\46";
}
.icon-cogs:before {
  content: "\47";
}
.icon-exclamation-circle:before {
  content: "\48";
}
.icon-eraser:before {
  content: "\49";
}
.icon-file-o:before {
  content: "\4a";
}
.icon-file-text-o:before {
  content: "\4b";
}
.icon-files-o:before {
  content: "\4c";
}
.icon-info:before {
  content: "\4d";
}
.icon-info-circle:before {
  content: "\4e";
}
.icon-list:before {
  content: "\4f";
}
.icon-list-alt:before {
  content: "\50";
}
.icon-play-circle:before {
  content: "\51";
}
.icon-pencil-square:before {
  content: "\52";
}
.icon-pencil-square-o:before {
  content: "\53";
}
.icon-square:before {
  content: "\54";
}
.icon-bullseye:before {
  content: "\55";
}
.icon-circle:before {
  content: "\56";
}
.icon-circle-o:before {
  content: "\57";
}
.icon-code:before {
  content: "\58";
}
.icon-ellipsis-v:before {
  content: "\59";
}
.icon-file-image-o:before {
  content: "\5a";
}
.icon-file-text:before {
  content: "\30";
}
.icon-picture-o:before {
  content: "\31";
}
.icon-paragraph:before {
  content: "\32";
}
.icon-sliders:before {
  content: "\33";
}
.icon-trash:before {
  content: "\34";
}
.icon-trash-o:before {
  content: "\35";
}
.icon-undo:before {
  content: "\36";
}
.icon-wrench:before {
  content: "\37";
}
.icon-unlock-alt:before {
  content: "\38";
}
.icon-unlock:before {
  content: "\39";
}
.icon-spinner:before {
  content: "\21";
}
.icon-expeditedssl:before {
  content: "\22";
}
.icon-caret-up:before {
  content: "\23";
}
.icon-caret-left:before {
  content: "\24";
}



======================================================================
FILE PATH: skin\ads.json
======================================================================
[
	{"ad_text": "ちいかわ", "ad_img": "imacros.png", "ad_link": "https://www.anime-chiikawa.jp/"},
	{"ad_text": "ちいかわ", "ad_img": "imacros-pro.png", "ad_link": "https://www.anime-chiikawa.jp/"},
	{"ad_text": "ちいかわ", "ad_img": "imacros-server.png", "ad_link": "https://www.anime-chiikawa.jp/"},
	{"ad_text": "ちいかわ", "ad_img": "imacros-wug.png", "ad_link": "https://www.anime-chiikawa.jp/"}
]



======================================================================
FILE PATH: skin\beforePlay.css
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/

/* styles for beforePlay dialog */

@font-face {
    font-family: "imicons";
    src: url("imicons/fonts/imicons.eot");
    src: url("imicons/fonts/imicons.eot?#iefix") format("embedded-opentype"), 
        url("imicons/fonts/imicons.woff") format("woff"), 
        url("imicons/fonts/imicons.ttf") format("truetype"), 
        url("imicons/fonts/imicons.svg#imicons") format("svg");
    font-weight: normal;
    font-style: normal;
}

#container {
    display: -webkit-box;
    -webkit-box-orient: vertical;
}

#buttons {
    display: -webkit-box;
    -webkit-box-pack: center;
    -webkit-box-orient: horizontal;
}

#message-div {
    border: 1px solid #aaaaaa;
    -webkit-border-radius: 3px;
    padding: 7px;
}

#message {
    padding: 0px;
    margin: 0px;
}

#checkbox-div {
    margin-top: 20px;
    margin-bottom: 10px;
    margin-left: 30px;
    padding: 5px;
    font-size: small !important;
    font-family: Arial, sans-serif;
    vertical-align: middle;
}


#play-button {
    /*background-image: url("play.png");*/
}

#play-button:before {
    font-family: imicons;
    display: inline-block;
    content: "c";
    font-size: 16px;
    color: ghostwhite;
    margin-right: 10px;
    margin-bottom: inherit;
    vertical-align: middle;
}

#edit-button {
    /*background-image: url("edit.png");*/
}

#edit-button:before {
    font-family: imicons;
    display: inline-block;
    content: "h";
    font-size: 16px;
    color: ghostwhite;
    margin-right: 10px;
    margin-bottom: inherit;
    vertical-align: middle;
}

#cancel-button {
    /*background-image: url("cancel.png");*/
}

#cancel-button:before {
    font-family: imicons;
    display: inline-block;
    content: "e";
    font-size: 16px;
    color: ghostwhite;
    margin-right: 10px;
    margin-bottom: inherit;
    vertical-align: middle;
}



======================================================================
FILE PATH: skin\browse.css
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/

#container {
    min-width: 230px;
    min-height: 300px;
}

#tree-view {
    margin: 0px;
    padding: 0px;
    -webkit-box-flex: 1;
    box-flex: 1;
}

#tree-iframe {
    display: block;
    margin: 0px;
    padding: 0px;
    border: thin solid black;
    min-height: 150px;
    width: 100%;
    -webkit-border-radius: 4px;
    border-radius: 4px;
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
}

#button-container {
    height: 40px;
}

#button-ok {
    -webkit-box-flex: 1;
    box-flex: 1;
}

#button-cancel {
    -webkit-box-flex: 1;
    box-flex: 1;
}



======================================================================
FILE PATH: skin\common.css
======================================================================
/*</JasobNoObfs>*/
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/
/*</JasobNoObfs>*/

/* common styles for all dialogs */

.button {
    display: -webkit-box;
    -webkit-box-pack: center;
    -webkit-box-align: center;
    height: 16px;
    width: auto; 
    margin-top: 3px;
    margin-bottom: 3px;
    margin-left: 7px;
    margin-right: 7px;  /* padding-left: 22px; */
    padding-left: 4px;
    padding-right: 4px;
    padding-top: 3px;
    padding-bottom: 3px;
    /* font-family: sans-serif; */
    font-size: 1em;
    color: ghostwhite;
    background-color: #217CCE; /*#eeeeee;*/
    border: 1px solid #217CCE; /*aaaaaa;*/
    -webkit-border-radius: 0px;
    border-radius: 0px; /*3;*/
}
#tabs-content .button {
    margin: 3 auto;
}


.icon-button {
    background-repeat: no-repeat;
    /* background-position: left; */
    background-position: 3px;
    padding-left: 4px; /*22px;*/
}


.button[collapsed="true"] {
    display: none;
}

.button:hover {
    background-color: #1A62A4;/*#efefef;*/
    /* border: 1px solid #aaaaaa; */
    /* -webkit-border-radius: 3px; */
    text-decoration: none;
    cursor: hand;
}

.button[disabled="true"] {
    color: #bbbbbb;
    cursor: default;
}

.button[disabled="true"]:hover {
    background-color: #217CCE;/*#eeeeee;*/
    cursor: default;
}

.box {
    display: -webkit-box;
}

.vbox {
    display: -webkit-box;
    -webkit-box-orient: vertical;
   
}

.vbox[hidden="true"] {
    display: none;
}


.hbox {
    display: -webkit-box;
    -webkit-box-orient: horizontal;
}

.hbox[hidden="true"] {
    display: none;
}

.centered {
    -webkit-box-pack: center;
}

.box[hidden="true"] {
    display: none;
}

.a-link {
    color: #217CCE;/* blue;*/
    font-weight: bold;
}

.a-link:hover {
    text-decoration: underline;
    color: #1A62A4;
    cursor: hand;
}

.dialogs-global-settings {
    max-width: 500px;
}

.disabled {
    color: darkgrey;
}



======================================================================
FILE PATH: skin\editor.css
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/

/* styles for editor dialog */
@font-face {
    font-family: "imicons";
    src: url("imicons/fonts/imicons.eot");
    src: url("imicons/fonts/imicons.eot?#iefix") format("embedded-opentype"), 
        url("imicons/fonts/imicons.woff") format("woff"), 
        url("imicons/fonts/imicons.ttf") format("truetype"), 
        url("imicons/fonts/imicons.svg#imicons") format("svg");
    font-weight: normal;
    font-style: normal;
}

body {
    margin: 0px !important;
}

#editbox {
    width: 100%;
    height: 95%;
    padding: 0px !important;
    margin: 0px !important;
    border: 0px;
}

#buttonpack {
    position: absolute;
    bottom: 5px;
    display: -webkit-box;
    -webkit-box-pack: center;
    width: 99%;
}

#save-button {
    /*background-image: url("save.png");*/

}

#save-button::before {
    font-family: imicons;
    display: inline-block;
    content: "j";
    font-size: 16px;
    color: ghostwhite;
    margin-right: 10px;
    margin-bottom: inherit;
    vertical-align: middle;
} 

#saveas-button {
        /*background-image: url("saveas.png");*/
}

#saveas-button::before {
    font-family: imicons;
    display: inline-block;
    content: "j";
    font-size: 16px;
    color: ghostwhite;
    margin-right: 10px;
    margin-bottom: inherit;
    vertical-align: middle;
}


#cancel-button {
    /*background-image: url("cancel.png");*/
}

#cancel-button::before {
    font-family: imicons;
    display: inline-block;
    content: "e";
    font-size: 16px;
    color: ghostwhite;
    margin-right: 10px;
    margin-bottom: inherit;
    vertical-align: middle;
}



======================================================================
FILE PATH: skin\extractDialog.css
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/

/* styles for extract dialog */

@font-face {
    font-family: "imicons";
    src: url("imicons/fonts/imicons.eot");
    src: url("imicons/fonts/imicons.eot?#iefix") format("embedded-opentype"), 
        url("imicons/fonts/imicons.woff") format("woff"), 
        url("imicons/fonts/imicons.ttf") format("truetype"), 
        url("imicons/fonts/imicons.svg#imicons") format("svg");
    font-weight: normal;
    font-style: normal;
}

#caption {
    font-size: 12px;
    font-weight: bold;
    margin-left: 30px;
    color: #414042;
}

#data-field {
    width: 100%;
    height: 60%;
    margin-top: 5px;
    margin-bottom: 0px;
    margin-left: 0px;
    margin-right: 0px;
}

#note {
    font-size: 11px;
    margin-left: 20px;
    margin-right: 20px;
    margin-top: 10px;
}


#buttons {
    position: absolute;
    bottom: 15px;
    left: 45%;
}

#ok-button {
    /*width: 30px;*/
    /*background-image: url("ok.png");*/
}

#ok-button:before {
    font-family: imicons;
    display: inline-block;
    content: "a";
    font-size: 16px;
    color: ghostwhite;
    margin-right: 10px;
    margin-bottom: inherit;
    vertical-align: middle;
}




======================================================================
FILE PATH: skin\icons-reference.html
======================================================================
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Font Reference - iMIcons</title>
    <link href="http://fonts.googleapis.com/css?family=Dosis:400,500,700" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="styles.css">
    <style type="text/css">html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-weight:inherit;font-style:inherit;font-family:inherit;font-size:100%;vertical-align:baseline}body{line-height:1;color:#000;background:#fff}ol,ul{list-style:none}table{border-collapse:separate;border-spacing:0;vertical-align:middle}caption,th,td{text-align:left;font-weight:normal;vertical-align:middle}a img{border:none}*{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}body{font-family:'Dosis','Tahoma',sans-serif}.container{margin:15px auto;width:80%}h1{margin:40px 0 20px;font-weight:700;font-size:38px;line-height:32px;color:#fb565e}h2{font-size:18px;padding:0 0 21px 5px;margin:45px 0 0 0;text-transform:uppercase;font-weight:500}.small{font-size:14px;color:#a5adb4;}.small a{color:#a5adb4;}.small a:hover{color:#fb565e}.glyphs.character-mapping{margin:0 0 20px 0;padding:20px 0 20px 30px;color:rgba(0,0,0,0.5);border:1px solid #d8e0e5;-webkit-border-radius:3px;border-radius:3px;}.glyphs.character-mapping li{margin:0 30px 20px 0;display:inline-block;width:90px}.glyphs.character-mapping .icon{margin:10px 0 10px 15px;padding:15px;position:relative;width:55px;height:55px;color:#162a36 !important;overflow:hidden;-webkit-border-radius:3px;border-radius:3px;font-size:32px;}.glyphs.character-mapping .icon svg{fill:#000}.glyphs.character-mapping input{margin:0;padding:5px 0;line-height:12px;font-size:12px;display:block;width:100%;border:1px solid #d8e0e5;-webkit-border-radius:5px;border-radius:5px;text-align:center;outline:0;}.glyphs.character-mapping input:focus{border:1px solid #fbde4a;-webkit-box-shadow:inset 0 0 3px #fbde4a;box-shadow:inset 0 0 3px #fbde4a}.glyphs.character-mapping input:hover{-webkit-box-shadow:inset 0 0 3px #fbde4a;box-shadow:inset 0 0 3px #fbde4a}.glyphs.css-mapping{margin:0 0 60px 0;padding:30px 0 20px 30px;color:rgba(0,0,0,0.5);border:1px solid #d8e0e5;-webkit-border-radius:3px;border-radius:3px;}.glyphs.css-mapping li{margin:0 30px 20px 0;padding:0;display:inline-block;overflow:hidden}.glyphs.css-mapping .icon{margin:0;margin-right:10px;padding:13px;height:50px;width:50px;color:#162a36 !important;overflow:hidden;float:left;font-size:24px}.glyphs.css-mapping input{margin:0;margin-top:5px;padding:8px;line-height:16px;font-size:16px;display:block;width:150px;height:40px;border:1px solid #d8e0e5;-webkit-border-radius:5px;border-radius:5px;background:#fff;outline:0;float:right;}.glyphs.css-mapping input:focus{border:1px solid #fbde4a;-webkit-box-shadow:inset 0 0 3px #fbde4a;box-shadow:inset 0 0 3px #fbde4a}.glyphs.css-mapping input:hover{-webkit-box-shadow:inset 0 0 3px #fbde4a;box-shadow:inset 0 0 3px #fbde4a}</style>
  </head>
  <body>
    <div class="container">
      <h1>iMIcons</h1>
      <p class="small">This font was created with<a href="http://fontastic.me/">Fontastic</a></p>
      <h2>CSS mapping</h2>
      <ul class="glyphs css-mapping">
        <li>
          <div class="icon icon-check"></div>
          <input type="text" readonly="readonly" value="check">
        </li>
        <li>
          <div class="icon icon-question"></div>
          <input type="text" readonly="readonly" value="question">
        </li>
        <li>
          <div class="icon icon-play"></div>
          <input type="text" readonly="readonly" value="play">
        </li>
        <li>
          <div class="icon icon-times-circle-o"></div>
          <input type="text" readonly="readonly" value="times-circle-o">
        </li>
        <li>
          <div class="icon icon-times"></div>
          <input type="text" readonly="readonly" value="times">
        </li>
        <li>
          <div class="icon icon-times-circle"></div>
          <input type="text" readonly="readonly" value="times-circle">
        </li>
        <li>
          <div class="icon icon-play-circle-o"></div>
          <input type="text" readonly="readonly" value="play-circle-o">
        </li>
        <li>
          <div class="icon icon-pencil"></div>
          <input type="text" readonly="readonly" value="pencil">
        </li>
        <li>
          <div class="icon icon-pause"></div>
          <input type="text" readonly="readonly" value="pause">
        </li>
        <li>
          <div class="icon icon-floppy-o"></div>
          <input type="text" readonly="readonly" value="floppy-o">
        </li>
        <li>
          <div class="icon icon-folder-open"></div>
          <input type="text" readonly="readonly" value="folder-open">
        </li>
        <li>
          <div class="icon icon-folder-open-o"></div>
          <input type="text" readonly="readonly" value="folder-open-o">
        </li>
        <li>
          <div class="icon icon-folder"></div>
          <input type="text" readonly="readonly" value="folder">
        </li>
        <li>
          <div class="icon icon-folder-o"></div>
          <input type="text" readonly="readonly" value="folder-o">
        </li>
        <li>
          <div class="icon icon-file-code-o"></div>
          <input type="text" readonly="readonly" value="file-code-o">
        </li>
        <li>
          <div class="icon icon-exclamation"></div>
          <input type="text" readonly="readonly" value="exclamation">
        </li>
        <li>
          <div class="icon icon-caret-right"></div>
          <input type="text" readonly="readonly" value="caret-right">
        </li>
        <li>
          <div class="icon icon-caret-down"></div>
          <input type="text" readonly="readonly" value="caret-down">
        </li>
        <li>
          <div class="icon icon-refresh"></div>
          <input type="text" readonly="readonly" value="refresh">
        </li>
        <li>
          <div class="icon icon-question-circle"></div>
          <input type="text" readonly="readonly" value="question-circle">
        </li>
        <li>
          <div class="icon icon-search-plus"></div>
          <input type="text" readonly="readonly" value="search-plus">
        </li>
        <li>
          <div class="icon icon-search-minus"></div>
          <input type="text" readonly="readonly" value="search-minus">
        </li>
        <li>
          <div class="icon icon-search"></div>
          <input type="text" readonly="readonly" value="search">
        </li>
        <li>
          <div class="icon icon-server"></div>
          <input type="text" readonly="readonly" value="server">
        </li>
        <li>
          <div class="icon icon-stop"></div>
          <input type="text" readonly="readonly" value="stop">
        </li>
        <li>
          <div class="icon icon-check-circle-o"></div>
          <input type="text" readonly="readonly" value="check-circle-o">
        </li>
        <li>
          <div class="icon icon-check-circle"></div>
          <input type="text" readonly="readonly" value="check-circle">
        </li>
        <li>
          <div class="icon icon-check-square-o"></div>
          <input type="text" readonly="readonly" value="check-square-o">
        </li>
        <li>
          <div class="icon icon-check-square"></div>
          <input type="text" readonly="readonly" value="check-square">
        </li>
        <li>
          <div class="icon icon-clipboard"></div>
          <input type="text" readonly="readonly" value="clipboard">
        </li>
        <li>
          <div class="icon icon-clone"></div>
          <input type="text" readonly="readonly" value="clone">
        </li>
        <li>
          <div class="icon icon-cog"></div>
          <input type="text" readonly="readonly" value="cog">
        </li>
        <li>
          <div class="icon icon-cogs"></div>
          <input type="text" readonly="readonly" value="cogs">
        </li>
        <li>
          <div class="icon icon-exclamation-circle"></div>
          <input type="text" readonly="readonly" value="exclamation-circle">
        </li>
        <li>
          <div class="icon icon-eraser"></div>
          <input type="text" readonly="readonly" value="eraser">
        </li>
        <li>
          <div class="icon icon-file-o"></div>
          <input type="text" readonly="readonly" value="file-o">
        </li>
        <li>
          <div class="icon icon-file-text-o"></div>
          <input type="text" readonly="readonly" value="file-text-o">
        </li>
        <li>
          <div class="icon icon-files-o"></div>
          <input type="text" readonly="readonly" value="files-o">
        </li>
        <li>
          <div class="icon icon-info"></div>
          <input type="text" readonly="readonly" value="info">
        </li>
        <li>
          <div class="icon icon-info-circle"></div>
          <input type="text" readonly="readonly" value="info-circle">
        </li>
        <li>
          <div class="icon icon-list"></div>
          <input type="text" readonly="readonly" value="list">
        </li>
        <li>
          <div class="icon icon-list-alt"></div>
          <input type="text" readonly="readonly" value="list-alt">
        </li>
        <li>
          <div class="icon icon-play-circle"></div>
          <input type="text" readonly="readonly" value="play-circle">
        </li>
        <li>
          <div class="icon icon-pencil-square"></div>
          <input type="text" readonly="readonly" value="pencil-square">
        </li>
        <li>
          <div class="icon icon-pencil-square-o"></div>
          <input type="text" readonly="readonly" value="pencil-square-o">
        </li>
        <li>
          <div class="icon icon-square"></div>
          <input type="text" readonly="readonly" value="square">
        </li>
        <li>
          <div class="icon icon-bullseye"></div>
          <input type="text" readonly="readonly" value="bullseye">
        </li>
        <li>
          <div class="icon icon-circle"></div>
          <input type="text" readonly="readonly" value="circle">
        </li>
        <li>
          <div class="icon icon-circle-o"></div>
          <input type="text" readonly="readonly" value="circle-o">
        </li>
        <li>
          <div class="icon icon-code"></div>
          <input type="text" readonly="readonly" value="code">
        </li>
        <li>
          <div class="icon icon-ellipsis-v"></div>
          <input type="text" readonly="readonly" value="ellipsis-v">
        </li>
        <li>
          <div class="icon icon-file-image-o"></div>
          <input type="text" readonly="readonly" value="file-image-o">
        </li>
        <li>
          <div class="icon icon-file-text"></div>
          <input type="text" readonly="readonly" value="file-text">
        </li>
        <li>
          <div class="icon icon-picture-o"></div>
          <input type="text" readonly="readonly" value="picture-o">
        </li>
        <li>
          <div class="icon icon-paragraph"></div>
          <input type="text" readonly="readonly" value="paragraph">
        </li>
        <li>
          <div class="icon icon-sliders"></div>
          <input type="text" readonly="readonly" value="sliders">
        </li>
        <li>
          <div class="icon icon-trash"></div>
          <input type="text" readonly="readonly" value="trash">
        </li>
        <li>
          <div class="icon icon-trash-o"></div>
          <input type="text" readonly="readonly" value="trash-o">
        </li>
        <li>
          <div class="icon icon-undo"></div>
          <input type="text" readonly="readonly" value="undo">
        </li>
        <li>
          <div class="icon icon-wrench"></div>
          <input type="text" readonly="readonly" value="wrench">
        </li>
        <li>
          <div class="icon icon-unlock-alt"></div>
          <input type="text" readonly="readonly" value="unlock-alt">
        </li>
        <li>
          <div class="icon icon-unlock"></div>
          <input type="text" readonly="readonly" value="unlock">
        </li>
        <li>
          <div class="icon icon-spinner"></div>
          <input type="text" readonly="readonly" value="spinner">
        </li>
        <li>
          <div class="icon icon-expeditedssl"></div>
          <input type="text" readonly="readonly" value="expeditedssl">
        </li>
        <li>
          <div class="icon icon-caret-up"></div>
          <input type="text" readonly="readonly" value="caret-up">
        </li>
        <li>
          <div class="icon icon-caret-left"></div>
          <input type="text" readonly="readonly" value="caret-left">
        </li>
      </ul>
      <h2>Character mapping</h2>
      <ul class="glyphs character-mapping">
        <li>
          <div data-icon="a" class="icon"></div>
          <input type="text" readonly="readonly" value="a">
        </li>
        <li>
          <div data-icon="b" class="icon"></div>
          <input type="text" readonly="readonly" value="b">
        </li>
        <li>
          <div data-icon="c" class="icon"></div>
          <input type="text" readonly="readonly" value="c">
        </li>
        <li>
          <div data-icon="d" class="icon"></div>
          <input type="text" readonly="readonly" value="d">
        </li>
        <li>
          <div data-icon="e" class="icon"></div>
          <input type="text" readonly="readonly" value="e">
        </li>
        <li>
          <div data-icon="f" class="icon"></div>
          <input type="text" readonly="readonly" value="f">
        </li>
        <li>
          <div data-icon="g" class="icon"></div>
          <input type="text" readonly="readonly" value="g">
        </li>
        <li>
          <div data-icon="h" class="icon"></div>
          <input type="text" readonly="readonly" value="h">
        </li>
        <li>
          <div data-icon="i" class="icon"></div>
          <input type="text" readonly="readonly" value="i">
        </li>
        <li>
          <div data-icon="j" class="icon"></div>
          <input type="text" readonly="readonly" value="j">
        </li>
        <li>
          <div data-icon="k" class="icon"></div>
          <input type="text" readonly="readonly" value="k">
        </li>
        <li>
          <div data-icon="l" class="icon"></div>
          <input type="text" readonly="readonly" value="l">
        </li>
        <li>
          <div data-icon="m" class="icon"></div>
          <input type="text" readonly="readonly" value="m">
        </li>
        <li>
          <div data-icon="n" class="icon"></div>
          <input type="text" readonly="readonly" value="n">
        </li>
        <li>
          <div data-icon="o" class="icon"></div>
          <input type="text" readonly="readonly" value="o">
        </li>
        <li>
          <div data-icon="p" class="icon"></div>
          <input type="text" readonly="readonly" value="p">
        </li>
        <li>
          <div data-icon="q" class="icon"></div>
          <input type="text" readonly="readonly" value="q">
        </li>
        <li>
          <div data-icon="r" class="icon"></div>
          <input type="text" readonly="readonly" value="r">
        </li>
        <li>
          <div data-icon="s" class="icon"></div>
          <input type="text" readonly="readonly" value="s">
        </li>
        <li>
          <div data-icon="t" class="icon"></div>
          <input type="text" readonly="readonly" value="t">
        </li>
        <li>
          <div data-icon="u" class="icon"></div>
          <input type="text" readonly="readonly" value="u">
        </li>
        <li>
          <div data-icon="v" class="icon"></div>
          <input type="text" readonly="readonly" value="v">
        </li>
        <li>
          <div data-icon="w" class="icon"></div>
          <input type="text" readonly="readonly" value="w">
        </li>
        <li>
          <div data-icon="x" class="icon"></div>
          <input type="text" readonly="readonly" value="x">
        </li>
        <li>
          <div data-icon="y" class="icon"></div>
          <input type="text" readonly="readonly" value="y">
        </li>
        <li>
          <div data-icon="z" class="icon"></div>
          <input type="text" readonly="readonly" value="z">
        </li>
        <li>
          <div data-icon="A" class="icon"></div>
          <input type="text" readonly="readonly" value="A">
        </li>
        <li>
          <div data-icon="B" class="icon"></div>
          <input type="text" readonly="readonly" value="B">
        </li>
        <li>
          <div data-icon="C" class="icon"></div>
          <input type="text" readonly="readonly" value="C">
        </li>
        <li>
          <div data-icon="D" class="icon"></div>
          <input type="text" readonly="readonly" value="D">
        </li>
        <li>
          <div data-icon="E" class="icon"></div>
          <input type="text" readonly="readonly" value="E">
        </li>
        <li>
          <div data-icon="F" class="icon"></div>
          <input type="text" readonly="readonly" value="F">
        </li>
        <li>
          <div data-icon="G" class="icon"></div>
          <input type="text" readonly="readonly" value="G">
        </li>
        <li>
          <div data-icon="H" class="icon"></div>
          <input type="text" readonly="readonly" value="H">
        </li>
        <li>
          <div data-icon="I" class="icon"></div>
          <input type="text" readonly="readonly" value="I">
        </li>
        <li>
          <div data-icon="J" class="icon"></div>
          <input type="text" readonly="readonly" value="J">
        </li>
        <li>
          <div data-icon="K" class="icon"></div>
          <input type="text" readonly="readonly" value="K">
        </li>
        <li>
          <div data-icon="L" class="icon"></div>
          <input type="text" readonly="readonly" value="L">
        </li>
        <li>
          <div data-icon="M" class="icon"></div>
          <input type="text" readonly="readonly" value="M">
        </li>
        <li>
          <div data-icon="N" class="icon"></div>
          <input type="text" readonly="readonly" value="N">
        </li>
        <li>
          <div data-icon="O" class="icon"></div>
          <input type="text" readonly="readonly" value="O">
        </li>
        <li>
          <div data-icon="P" class="icon"></div>
          <input type="text" readonly="readonly" value="P">
        </li>
        <li>
          <div data-icon="Q" class="icon"></div>
          <input type="text" readonly="readonly" value="Q">
        </li>
        <li>
          <div data-icon="R" class="icon"></div>
          <input type="text" readonly="readonly" value="R">
        </li>
        <li>
          <div data-icon="S" class="icon"></div>
          <input type="text" readonly="readonly" value="S">
        </li>
        <li>
          <div data-icon="T" class="icon"></div>
          <input type="text" readonly="readonly" value="T">
        </li>
        <li>
          <div data-icon="U" class="icon"></div>
          <input type="text" readonly="readonly" value="U">
        </li>
        <li>
          <div data-icon="V" class="icon"></div>
          <input type="text" readonly="readonly" value="V">
        </li>
        <li>
          <div data-icon="W" class="icon"></div>
          <input type="text" readonly="readonly" value="W">
        </li>
        <li>
          <div data-icon="X" class="icon"></div>
          <input type="text" readonly="readonly" value="X">
        </li>
        <li>
          <div data-icon="Y" class="icon"></div>
          <input type="text" readonly="readonly" value="Y">
        </li>
        <li>
          <div data-icon="Z" class="icon"></div>
          <input type="text" readonly="readonly" value="Z">
        </li>
        <li>
          <div data-icon="0" class="icon"></div>
          <input type="text" readonly="readonly" value="0">
        </li>
        <li>
          <div data-icon="1" class="icon"></div>
          <input type="text" readonly="readonly" value="1">
        </li>
        <li>
          <div data-icon="2" class="icon"></div>
          <input type="text" readonly="readonly" value="2">
        </li>
        <li>
          <div data-icon="3" class="icon"></div>
          <input type="text" readonly="readonly" value="3">
        </li>
        <li>
          <div data-icon="4" class="icon"></div>
          <input type="text" readonly="readonly" value="4">
        </li>
        <li>
          <div data-icon="5" class="icon"></div>
          <input type="text" readonly="readonly" value="5">
        </li>
        <li>
          <div data-icon="6" class="icon"></div>
          <input type="text" readonly="readonly" value="6">
        </li>
        <li>
          <div data-icon="7" class="icon"></div>
          <input type="text" readonly="readonly" value="7">
        </li>
        <li>
          <div data-icon="8" class="icon"></div>
          <input type="text" readonly="readonly" value="8">
        </li>
        <li>
          <div data-icon="9" class="icon"></div>
          <input type="text" readonly="readonly" value="9">
        </li>
        <li>
          <div data-icon="!" class="icon"></div>
          <input type="text" readonly="readonly" value="!">
        </li>
        <li>
          <div data-icon="&#34;" class="icon"></div>
          <input type="text" readonly="readonly" value="&quot;">
        </li>
        <li>
          <div data-icon="#" class="icon"></div>
          <input type="text" readonly="readonly" value="#">
        </li>
        <li>
          <div data-icon="$" class="icon"></div>
          <input type="text" readonly="readonly" value="$">
        </li>
      </ul>
    </div>
    <script>(function() {
  var glyphs, i, len, ref;

  ref = document.getElementsByClassName('glyphs');
  for (i = 0, len = ref.length; i < len; i++) {
    glyphs = ref[i];
    glyphs.addEventListener('click', function(event) {
      if (event.target.tagName === 'INPUT') {
        return event.target.select();
      }
    });
  }

}).call(this);

    </script>
  </body>
</html>


======================================================================
FILE PATH: skin\loginDialog.css
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/

/* styles for login dialog */

@font-face {
    font-family: "imicons";
    src: url("imicons/fonts/imicons.eot");
    src: url("imicons/fonts/imicons.eot?#iefix") format("embedded-opentype"), 
        url("imicons/fonts/imicons.woff") format("woff"), 
        url("imicons/fonts/imicons.ttf") format("truetype"), 
        url("imicons/fonts/imicons.svg#imicons") format("svg");
    font-weight: normal;
    font-style: normal;
}

body {
    font-family: Verdana, Geneva, Arial, sans-serif;
}

  
#message {
    /* margin-left: 20px; */
    /* margin-right: 20px; */
    font-size: 12px;
}

#username-and-password {
    font-size: 12px;
}

#username {
    margin-top: 7px;
    margin-bottom: 7px;
}

#password {
    margin-top: 7px;
    margin-bottom: 7px;
}

#buttons {
    margin-top: 10px;
}

#ok-button {
    /*background-image: url("ok.png");*/
}

#ok-button:before {
    font-family: imicons;
    display: inline-block;
    content: "a";
    font-size: 16px;
    color: ghostwhite;
    margin-right: 10px;
    margin-bottom: inherit;
    vertical-align: middle;
}

#cancel-button {
    /*background-image: url("cancel.png");*/
}

#cancel-button:before {
    font-family: imicons;
    display: inline-block;
    content: "e";
    font-size: 16px;
    color: ghostwhite;
    margin-right: 10px;
    margin-bottom: inherit;
    vertical-align: middle;
}



======================================================================
FILE PATH: skin\macroView.css
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/

/* Turn off list bullets */

body {
    margin: 0px;
}
  
#lines {
    margin: 0px;
    margin-top: 18px;
    padding: 0px;
    /* font-size: 0.9em; */
    border-collapse: collapse;
}

#status {
    white-space: nowrap;
    margin: 0px;
    margin-bottom: 2px;
    padding: 2px;
    padding-left: 7px;
    font-size: 11px;
    font-family: monospace;
}

#status-div {
    width: 100%;
    position: fixed;
    top: 0px;
    left: 0px;
    border-bottom: 1px solid #666666;
}

#status-div[type="info"] {
    background-color: #afffaf;
}

#status-div[type="warning"] {
    background-color: #ffabab;
}


td, tr {
    margin: 0px;
    padding:0px;
    border: 0px;
}

tr[selected="true"] {
    background-color: #eaf1fb;
}

.macro-line {
    white-space: nowrap;
    font-family: monospace;
    padding-left: 2px;
}

.macro-line[commented="true"] {
    color: #77f34b;
}


.line-number {
    font-family: monospace;
    color: #cccccc;
    border-right: 1px solid #cccccc;
    padding-right: 2px;
    text-align: right;
}



======================================================================
FILE PATH: skin\options.css
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/

/* styles for options dialog */

@font-face {
    font-family: "imicons";
    src: url("imicons/fonts/imicons.eot");
    src: url("imicons/fonts/imicons.eot?#iefix") format("embedded-opentype"), 
        url("imicons/fonts/imicons.woff") format("woff"), 
        url("imicons/fonts/imicons.ttf") format("truetype"), 
        url("imicons/fonts/imicons.svg#imicons") format("svg");
    font-weight: normal;
    font-style: normal;
}

body {
    padding: 10px;
    /* font-family: sans-serif; */
    /* font-size: 0.9em; */
}

#title {
    display: -webkit-box;
    font-size: 1.1em;
    margin: 20px;
    height: 48px !important;
    padding-left: 60px;
    -webkit-box-align: center;
    font-weight: bold;
    background-image: url("logo48.png");
    background-repeat: no-repeat;
    background-position: left;
    color: #414042;
}

.settings-container {
    border: thin solid #217CCE;/*black;*/
    -webkit-border-radius: 5px;
    border-radius: 5px;
    margin: 25px;
    padding: 7px;
    width: 60%;
    min-width: 400px;
}

.settings-container > .header {
    display: -webkit-box;
    font-weight: bold;
    margin-left: 5px;
    margin-bottom: 5px;
    margin-top: -25px;
    color: #414042;
}

.radio-container {
    margin-bottom: 10px;
    margin-top: 10px;
}

.radio-container:hover {
    background-color: #fafafa;
}

.radio-description {
    margin-left: 30px;
    font-size: 0.9em;
    margin-top: 5px;
}

.path-field {
    width: 350px;
    margin-left: 20px;
    margin-top: 5px;
    margin-bottom: 5px;
    margin-right: 0px;
}

/* overwrite 'display' of the .button from common.css */
.button {
    display: inline-block;
    padding-left: 5px;
    padding-right: 25px;
}

.browse-button {
    background-color: #ffffff;
    /* background-image: url("browse24.png");*/
    background-size: 21px 21px;
    background-repeat: no-repeat;
    background-position: center;
    padding-left: 7px;
    margin-left: 5px;
    border: 1px solid white;
}

.browse-button:before {
    font-family: imicons;
    content: "k";
    color: #fabb18;
    font-size: 19px;
    position: absolute;  
}

.browse-button:after {
    font-family: imicons;
    content: 'w';
    color: #aaaaaa;
    font-size: 12px;
    position: absolute;
    padding-left: 8px;
    padding-top: 5.5px;
}

.browse-button:hover:before {
    color: ghostwhite;
}

.browse-button:hover:after {
    color: transparent;
}

.browse-button:hover {
    border: 1px solid #aaaaaa;
}

.wide {
    border: 1px solid #217CCE; /*black;*/
    /* width: 100% !important; */
}

input[type=password] {
    margin-left: 0.5em;
}

#license-link {
    margin-left: 25px;
    font-size: 1em;
}

#file-access-note.settings-container {
    border: thin solid #FABB18 !important;
}

#file-access-note > .header {
    display: -webkit-box;
    font-weight: bold;
    margin-left: 5px;
    margin-bottom: 5px;
    margin-top: -25px;
    color: #FABB18; /*#414042;*/
}

#note-list > li {
    border: none;
    text-decoration: none;
}





======================================================================
FILE PATH: skin\panel.css
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/

/* styles for toolstrip area */

@font-face {
    font-family: "imicons";
    src: url("imicons/fonts/imicons.eot");
    src: url("imicons/fonts/imicons.eot?#iefix") format("embedded-opentype"), 
        url("imicons/fonts/imicons.woff") format("woff"), 
        url("imicons/fonts/imicons.ttf") format("truetype"), 
        url("imicons/fonts/imicons.svg#imicons") format("svg");
    font-weight: normal;
    font-style: normal;
}

body {
    margin: 0px;
    padding: 0px;
}

#mole {
    margin: 0px;
    padding: 3px;
    height: 100%;
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
}

#tree-switcher-box {
    margin-top: 2px;
    margin-bottom: 0px;
    /* font-family: sans-serif; */
    font-size: 1em;
    width: 70%;
    margin-left: 5px;
    margin-bottom: -1px;
}

#tree-switcher-box > .tab {
    display: none;
}

#tree-switcher-box .tab-label {
    color: ghostwhite; /*#555555;*/
    background: #414042; /*#eeeeee;*/
    cursor: pointer;
    display: block;
    width: 72%; /*50%*/
    height: 16px;
    line-height: 16px;
    position: relative;
    bottom: 0px;
    text-align: center;
    text-transform: uppercase;
    font-size: 0.8em;
    border: 1px solid #217CCE; /*black;*/
    margin-left: -5px; /*-1px*/
    border-radius: 0px 0px 0px 0px; /*5px 5px 0px 0px;*/
}


#tree-switcher-box #radio-bookmarks-tree-label {
    color: #ffffdc; /*#555555;*/
}

#radio-bookmarks-tree:hover ~ #radio-bookmarks-tree-label {
    background-color: #696666;
}

#radio-files-tree:hover ~ #radio-files-tree-label {
    background-color: #696666;
}
    
#radio-bookmarks-tree:checked ~ #radio-bookmarks-tree-label {
    background-color: #217CCE; /*#ffffdc*/
    color: #ffffdc; /*black;*/
}

#radio-files-tree:checked ~ #radio-files-tree-label {
    background-color: #217CCE; /*#ffffff;*/
    color: ghostwhite; /*black;*/
}



#view {
    /* margin: 3px; */
    -webkit-box-flex: 1;
    box-flex: 1;
}

#tree-view {
    margin: 0px;
    padding: 0px;
    -webkit-box-flex: 1;
    box-flex: 1;
}

#tree-iframe {
    display: block;
    margin: 0px;
    padding: 0px;
    border: thin solid #217CCE;/*black;*/
    width: 100%;
    -webkit-border-radius: 4px;
    border-radius: 1px;/*4px;*/
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
}

#macro-view {
    margin: 0px;
    padding: 0px;
    -webkit-box-flex: 1;
    box-flex: 1;
}

#macro-iframe {
    display: block;
    margin: 0px;
    padding: 0px;
    border: thin solid black;
    width: 100%;
    -webkit-border-radius: 4px;
    border-radius: 4px;
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
}



.loop-value {
    width: 33px;
    font-size: 1em;
    padding: 2px;
    border: 1px solid #217CCE; /*black*/
}


#loop-box {
    padding-top: 10px;
    padding-bottom: 0px;
    /* font-family: sans-serif; */
    font-size: 1em;
}


#play-button {
    /* background-image: url("play.png"); */
}

#play-button[disabled="true"] {
}

#stop-replaying-button {
    /* background-image: url("stop.png"); */
}

#edit-button {
}

#edit-button[disabled="true"] {
}


#pause-button {
    /* background-image: url("pause.png"); */
}

#unpause-button {
    /* background-image: url("play.png"); */
}



#settings-button {
}

#loop-button {
}

#loop-button[disabled="true"] {
}



#logo-or-info {
    min-width: 100px;
}

#logo-and-links {
    padding-bottom: 5px;
}

/* logo image's div */
#logo-image {
}

/*.panel-link-div {
    margin: 2px;
}*/

.panel-link {
    margin-left: 10px;
    padding: 3px;
}

#links {
    font-family: Arial, sans-serif;
    font-size: 1em;
    padding-bottom: 3px;
    color: #217CCE;
    -webkit-text-fill-color: #217CCE;
    font-weight:bold;
}
#links:hover {
    -webkit-text-fill-color: #1A62A4;
}

#info-div {
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
    -webkit-box-flex: 1;
    box-flex: 1;
    margin: 5px;
}

#info-area {
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
    width: 100%;
    min-height: 100px;
    -webkit-box-flex: 1;
    box-flex: 1;
    background-color: #a8ffab;
    border: 1px solid black;
    -webkit-border-radius: 3px;
    border-radius: 3px;
    /* font-family: sans-serif; */
    /* font-size: small; */
    padding: 2px;
    margin-top: 5px;
    margin-bottom: 5px;
}

#info-area[type="error"] {
    background-color: #ffffe1;
}

#info-buttons-container {
    border-right: 1px solid #cccccc;
    border-left: 1px solid #cccccc;
    border-bottom: 1px solid #cccccc;
    -webkit-border-bottom-left-radius: 5px;
    border-bottom-left-radius: 5px;
    -webkit-border-bottom-right-radius: 5px;
    border-bottom-right-radius: 5px;
}

.info-buttons {
   width: 22px;
   height: 22px;
   border: 0px;
   margin-left: 5px;
   margin-right: 5px;
   margin-top: 0px;
   padding-top: 0px;
   background-color: #ffffff;
   background-position: center;
   border: 1px solid #ffffff;
   -webkit-border-radius: 3px;
   border-radius: 3px;
   background-repeat: no-repeat;
}

#info-edit-button {
    /*background-image: url("edit.png");*/
}

#info-edit-button:before {
    font-family: imicons;
    display: inline-block;
    content: "h";
    font-size: 22px;
    color: #217CCE;
    vertical-align: middle;
}



#info-help-button {
    /*background-image: url("help.png");*/
}

#info-help-button:before {
    font-family: imicons;
    display: inline-block;
    content: "b";
    font-size: 22px;
    color: #217CCE;
    vertical-align: middle;
}

#info-close-button {
    /*background-image: url("close.png");*/
}

#info-close-button:before {
    font-family: imicons;
    display: inline-block;
    content: "f";
    font-size: 22px;
    color: #217CCE;
    vertical-align: middle;
}

#info-edit-button:hover:before,
#info-help-button:hover:before,
#info-close-button:hover:before {
    color: ghostwhite;
}

#tabs-content .button {
    width: 100px;
}

#saveas-box {
}

#record-button {
}

#stop-recording-button {
    /* background-image: url("stop.png"); */
}


#saveas-button {
    /* background-image: url("saveas.png"); */
}

#capture-button {
}

#tabs-container {
    margin-top: 10px;
    margin-bottom: 10px;
    width: 100%;
}

#tabs-container .tab-label {
    color: ghostwhite; /*#555555;*/
    background-color: #414042; /*#eeeeee;*/
    cursor: pointer;
    display: block;
    width: 33.3%; /*30%;*/
    height: 28px; /*20px;*/
    line-height: 28px;
    text-align: center;
    text-transform: uppercase;
    vertical-align: bottom;
    border: 0px solid #217CCE; /*1px; #aaaaaa;*/
    border-bottom: 0px;
    border-radius: 0px 0px 0 0;
    margin-right: 0px; /*2px;*/
    font-family: sans-serif;
    font-size: 0.8em ;
}

    #tabs-container .tab-label:hover{
        background-color: #696666;
    }
    
    #tabs-container .tab {
        display: none;
    }

#play-tab:checked  ~ div #play-tab-label,
#record-tab:checked  ~ div #record-tab-label,
#manage-tab:checked  ~ div #manage-tab-label {
    background-color: #217CCE;/*#ffffff;*/
    color: white;/*black;*/
}

#tabs-content {
    background-color: #ffffff;
    border: 1px solid #217CCE;/*#aaaaaa;*/
    padding: 7px;
    /* fixed height for tab content */
    height: 160px;
}

#tabs-content > div {
    display:none;
}

#play-tab:checked ~ #tabs-content #play-tab-content,
#record-tab:checked ~ #tabs-content #record-tab-content,
#manage-tab:checked ~ #tabs-content #manage-tab-content {
    position: static;
    left: 0;
    display: block;
}




======================================================================
FILE PATH: skin\passwordDialog.css
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/

/* styles for password dialog */

@font-face {
    font-family: "imicons";
    src: url("imicons/fonts/imicons.eot");
    src: url("imicons/fonts/imicons.eot?#iefix") format("embedded-opentype"), 
        url("imicons/fonts/imicons.woff") format("woff"), 
        url("imicons/fonts/imicons.ttf") format("truetype"), 
        url("imicons/fonts/imicons.svg#imicons") format("svg");
    font-weight: normal;
    font-style: normal;
}

div#container.vbox {
    display: inline-block;
    position: fixed;
    /*background: #414042;*/
    border-radius: 1px;
    min-height: 100px;
    z-index: 10;
    margin: -8px;
    margin-bottom: 0px;
    /*height:auto;*/
}

body {
    font-family: Verdana, Geneva, Arial, sans-serif;
}

  
#note {
    font-size: 11px;
    margin-left: 20px;
    margin-right: 20px;
}

#message-and-password-box {
    background-repeat: no-repeat;
    background-position: center;
    /*background-image: url("lock.png");*/
    /*padding: 10px;
    padding-left: 40px;
    margin-left: 20px;*/
    margin: 7px;
    padding: 7px;
    padding-right: 7px;
    padding-left: 4px;
    width: -webkit-fill-available;
    height: auto;
}


#message {
    font-size: 12px;
    font-weight: bold;
}

#message:before {
    font-family: imicons;
    display: inline-block;
    content: '"';
    text-align: left;
    font-size: 33px;
    color: #FABB18;
    font-style: normal;
}

#more-info-encryption {
    font-size: 12px;
}

#password {
    margin-top: 7px;
    margin-bottom: 7px;
    width: 100%;
}

#buttons {
    margin-top: 10px;
}

#ok-button {
    /*background-image: url("ok.png");*/
}

#ok-button:before {
    font-family: imicons;
    display: inline-block;
    content: "a";
    font-size: 16px;
    color: ghostwhite;
    margin-right: 10px;
    margin-bottom: inherit;
    vertical-align: middle;
}

#cancel-button {
    /*background-image: url("cancel.png");*/
}

#cancel-button:before {
    font-family: imicons;
    display: inline-block;
    content: "e";
    font-size: 16px;
    color: ghostwhite;
    margin-right: 10px;
    margin-bottom: inherit;
    vertical-align: middle;
}



======================================================================
FILE PATH: skin\promptDialog.css
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/

/* styles for password dialog */

@font-face {
    font-family: "imicons";
    src: url("imicons/fonts/imicons.eot");
    src: url("imicons/fonts/imicons.eot?#iefix") format("embedded-opentype"), 
         url("imicons/fonts/imicons.woff") format("woff"), 
         url("imicons/fonts/imicons.ttf") format("truetype"), 
         url("imicons/fonts/imicons.svg#imicons") format("svg");
    font-weight: normal;
    font-style: normal;
}

body {
    font-family: verdana, geneva, arial, sans-serif;
}

/*#prompt-container {
    display: block;
    height: 200px;
}

#prompt-box {
    background-repeat: no-repeat;
    background-position: center;
    padding: 10px;
    padding-left: 40px;
    margin-left: 20px;
}*/

div#container.vbox {
    display: inline-block;
    position: fixed;
    /*background: #414042;*/
    border-radius: 1px;
    width: 100%;
    min-height: 100px;
    z-index: 10;
    margin: -8px;
    margin-bottom: 0px;
    /*height:auto;*/
}

#container > div {
    background: #FFF;
}

#dialogboxhead {
    color: ghostwhite;
    align-content: center;
    vertical-align: middle;
    position: relative;
    resize: both;
}

#data-field {
    background-color: #217CCE;
    color: ghostwhite;
    width: 99%;
    height: 100%;
    min-height: 50px;
    margin-top: 0px;
    margin-bottom: 0px;
    margin-left: 0px;
    margin-right: 0px;
    padding-top: 8px;
    align-content: center;
    text-align: center;
    font-family: sans-serif;
    font-size: 13px;
    resize: both;
}

#dialogboxhead .area {
    resize: none;
    outline: none;
    display: block;
    width: 100%;
    padding: 0;
    position: absolute;
    top: 0;
    text-align: center;
    text-align: center;
  }
  
#dialogboxhead textarea.area {
    left: 0;
    height: 100%;
    background: transparent;
  }
  
#dialogboxhead .textlines {
    left: 100%;
    background: transparent;
    display: none;
  }

#dialogboxbody {
    margin-top: 15px;
    /*margin-bottom: 5px;*/
}

#prompt-message {
    font-size: 12px;
    font-weight: bold;
    background: #217CCE;
    text-align: center;
}

#prompt-input-text {
    display: inline-block;
    margin: 7px;
    padding: 7px;
    padding-right: 0px;
    padding-left: 4px;
    width: -webkit-fill-available;
    height: auto;
}

#buttons {
    margin-top: 10px;
    cursor: pointer;
}

#ok-button {
}

#ok-button:before {
    font-family: imicons;
    display: inline-block;
    content: "a";
    font-size: 16px;
    color: ghostwhite;
    margin-right: 10px;
    margin-bottom: inherit;
    vertical-align: middle;
}

#cancel-button {
}

#cancel-button:before {
    font-family: imicons;
    display: inline-block;
    content: "e";
    font-size: 16px;
    color: ghostwhite;
    margin-right: 10px;
    margin-bottom: inherit;
    vertical-align: middle;
}



======================================================================
FILE PATH: skin\saveAsDialog.css
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/

/* styles for saveAs dialog */

@font-face {
    font-family: "imicons";
    src: url("imicons/fonts/imicons.eot");
    src: url("imicons/fonts/imicons.eot?#iefix") format("embedded-opentype"), 
        url("imicons/fonts/imicons.woff") format("woff"), 
        url("imicons/fonts/imicons.ttf") format("truetype"), 
        url("imicons/fonts/imicons.svg#imicons") format("svg");
    font-weight: normal;
    font-style: normal;
}

body {
    margin: 0px;
    padding: 0px;
    /* font-family: sans-serif; */
    font-size: small;
    min-width: 400px;
    max-width: 500px;
}


#main-container {
    margin: 0px;
    padding: 15px;
    -webkit-box-sizing: border-box;
    -webkit-border-radius: 5px;
    min-height: 200px;
}

#macro-name {
    margin: 10px;
    min-width: 80%;
    display: -webkit-box;
}

#buttonpack {
    -webkit-box-sizing: border-box;
}

#ok-button {
    /*background-image: url("ok.png");*/
    text-align: center;
    padding-bottom: 3px;
}

#ok-button:before {
    font-family: imicons;
    display: inline-block;
    content: "a";
    font-size: 16px;
    color: ghostwhite;
    margin-right: 10px;
    margin-bottom: inherit;
    vertical-align: middle;
}

#cancel-button {
    /*background-image: url("cancel.png");*/
    text-align: center;
    padding-bottom: 3px;
}

#cancel-button:before {
    font-family: imicons;
    display: inline-block;
    content: "e";
    font-size: 16px;
    color: ghostwhite;
    margin-right: 10px;
    margin-bottom: inherit;
    vertical-align: middle;
}

#tree-switcher-box {
    margin-top: 15px;
    margin-bottom: 15px;
}


.tree-switcher {
    font-size: small;
}



======================================================================
FILE PATH: skin\styles.css
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/

@charset "UTF-8";

@font-face {
  font-family: "imicons";
  src:url("fonts/imicons.eot");
  src:url("fonts/imicons.eot?#iefix") format("embedded-opentype"),
    url("fonts/imicons.woff") format("woff"),
    url("fonts/imicons.ttf") format("truetype"),
    url("fonts/imicons.svg#imicons") format("svg");
  font-weight: normal;
  font-style: normal;

}

[data-icon]:before {
  font-family: "imicons" !important;
  content: attr(data-icon);
  font-style: normal !important;
  font-weight: normal !important;
  font-variant: normal !important;
  text-transform: none !important;
  speak: none;
  line-height: 1;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

[class^="icon-"]:before,
[class*=" icon-"]:before {
  font-family: "imicons" !important;
  font-style: normal !important;
  font-weight: normal !important;
  font-variant: normal !important;
  text-transform: none !important;
  speak: none;
  line-height: 1;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.icon-check:before {
  content: "\61";
}
.icon-question:before {
  content: "\62";
}
.icon-play:before {
  content: "\63";
}
.icon-times-circle-o:before {
  content: "\64";
}
.icon-times:before {
  content: "\65";
}
.icon-times-circle:before {
  content: "\66";
}
.icon-play-circle-o:before {
  content: "\67";
}
.icon-pencil:before {
  content: "\68";
}
.icon-pause:before {
  content: "\69";
}
.icon-floppy-o:before {
  content: "\6a";
}
.icon-folder-open:before {
  content: "\6b";
}
.icon-folder-open-o:before {
  content: "\6c";
}
.icon-folder:before {
  content: "\6d";
}
.icon-folder-o:before {
  content: "\6e";
}
.icon-file-code-o:before {
  content: "\6f";
}
.icon-exclamation:before {
  content: "\70";
}
.icon-caret-right:before {
  content: "\71";
}
.icon-caret-down:before {
  content: "\72";
}
.icon-refresh:before {
  content: "\73";
}
.icon-question-circle:before {
  content: "\74";
}
.icon-search-plus:before {
  content: "\75";
}
.icon-search-minus:before {
  content: "\76";
}
.icon-search:before {
  content: "\77";
}
.icon-server:before {
  content: "\78";
}
.icon-stop:before {
  content: "\79";
}
.icon-check-circle-o:before {
  content: "\7a";
}
.icon-check-circle:before {
  content: "\41";
}
.icon-check-square-o:before {
  content: "\42";
}
.icon-check-square:before {
  content: "\43";
}
.icon-clipboard:before {
  content: "\44";
}
.icon-clone:before {
  content: "\45";
}
.icon-cog:before {
  content: "\46";
}
.icon-cogs:before {
  content: "\47";
}
.icon-exclamation-circle:before {
  content: "\48";
}
.icon-eraser:before {
  content: "\49";
}
.icon-file-o:before {
  content: "\4a";
}
.icon-file-text-o:before {
  content: "\4b";
}
.icon-files-o:before {
  content: "\4c";
}
.icon-info:before {
  content: "\4d";
}
.icon-info-circle:before {
  content: "\4e";
}
.icon-list:before {
  content: "\4f";
}
.icon-list-alt:before {
  content: "\50";
}
.icon-play-circle:before {
  content: "\51";
}
.icon-pencil-square:before {
  content: "\52";
}
.icon-pencil-square-o:before {
  content: "\53";
}
.icon-square:before {
  content: "\54";
}
.icon-bullseye:before {
  content: "\55";
}
.icon-circle:before {
  content: "\56";
}
.icon-circle-o:before {
  content: "\57";
}
.icon-code:before {
  content: "\58";
}
.icon-ellipsis-v:before {
  content: "\59";
}
.icon-file-image-o:before {
  content: "\5a";
}
.icon-file-text:before {
  content: "\30";
}
.icon-picture-o:before {
  content: "\31";
}
.icon-paragraph:before {
  content: "\32";
}
.icon-sliders:before {
  content: "\33";
}
.icon-trash:before {
  content: "\34";
}
.icon-trash-o:before {
  content: "\35";
}
.icon-undo:before {
  content: "\36";
}
.icon-wrench:before {
  content: "\37";
}
.icon-unlock-alt:before {
  content: "\38";
}
.icon-unlock:before {
  content: "\39";
}
.icon-spinner:before {
  content: "\21";
}
.icon-expeditedssl:before {
  content: "\22";
}
.icon-caret-up:before {
  content: "\23";
}
.icon-caret-left:before {
  content: "\24";
}






======================================================================
FILE PATH: skin\treeView.css
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/

@font-face {
    font-family: "imicons";
    src: url("imicons/fonts/imicons.eot");
    src: url("imicons/fonts/imicons.eot?#iefix") format("embedded-opentype"), 
        url("imicons/fonts/imicons.woff") format("woff"), 
        url("imicons/fonts/imicons.ttf") format("truetype"), 
        url("imicons/fonts/imicons.svg#imicons") format("svg");
    font-weight: normal;
    font-style: normal;
}

#loading_message {
    margin: 10px;
    font-family: Verdana, Arial, sans-serif;
}
  
body[treetype="bookmarks"] {
    padding: 2px;
    margin: 0px;
    background-color: #ffffdc;
}

body[treetype="files"] {
    padding: 2px;
    margin: 0px;
    background-color: #ffffff;
}

#no-file-io-message {
    padding-top: 50%;
	padding-left: 5px;
	padding-right: 5px;
}
#no-file-io-paragraph {
    padding: 10px;
    background-color: #d1d2d4;
    border-color: #1a62a4;
    border-style: solid;
    font-family: Arial;
    font-size: 1.1em;
    text-align: left;
}

.no-bold-link {
    font-weight: normal;
}

#no-file-icon {
	font-family: imicons;
    display: inline-block;
    font-size: 3em;
    color: #f0554c;
	text-align: center;
    margin-bottom: inherit;
    vertical-align: middle;
}

.tree-menu {
    -webkit-padding-start: 0px !important;
}

.jstree-anchor {
    margin-left: -16px !important; /*-10px*/
}


.jstree-default > .jstree-no-dots .jstree-open > .jstree-ocl {
    background-position: -44px -4px !important; /*-36px -4px;*/
}

.jstree-default > .jstree-no-dots .jstree-closed > .jstree-ocl {
    background-position: -10px -4px !important; /*-4px -4px;*/
}

ul[class="vakata-context jstree-contextmenu jstree-default-contextmenu"] {
    background: #217CCE !important;
    border: 1px solid #217CCE !important;
    box-shadow: 2px 2px 2px #808080 !important;
    color: ghostwhite !important;
    text-decoration-color: ghostwhite !important;
    position: absolute;
    display:flex;
}

.vakata-contextmenu-sep {
    background: ghostwhite !important;
    color: #217CCE !important;
}

.vakata-context li > a {
    display: block;
    padding: 0 2em 0 2em;
    text-decoration: none;
    width: auto;
    color: ghostwhite !important;
    white-space: nowrap;
    line-height: 2.4em;
    text-shadow: 0px 0px 0 ghostwhite !important;
    border-radius: 1px;

}

.vakata-context li > a:hover {
    background: #1A62A4 !important;
}

.vakata-context .vakata-context-hover >a{
    background-color: #1A62A4 !important;
    box-shadow: 0 0 2px #217CCE !important;
}

.jstree-default .jstree-node{
    margin-left: 8px !important;
}

.jstree-icon.jstree-themeicon.jstree-themeicon-custom:before {
    font-family: imicons;
    display: inline-block;
    content: "X";
    text-align: center;
    vertical-align: middle;
    font-size: 15px;
    color: #4CC4D1;
    font-style: normal;
}



======================================================================
FILE PATH: vendor\jQuery\jquery-2.2.1.min.js
======================================================================
/*! jQuery v2.2.1 | (c) jQuery Foundation | jquery.org/license */
!function(a,b){"object"==typeof module&&"object"==typeof module.exports?module.exports=a.document?b(a,!0):function(a){if(!a.document)throw new Error("jQuery requires a window with a document");return b(a)}:b(a)}("undefined"!=typeof window?window:this,function(a,b){var c=[],d=a.document,e=c.slice,f=c.concat,g=c.push,h=c.indexOf,i={},j=i.toString,k=i.hasOwnProperty,l={},m="2.2.1",n=function(a,b){return new n.fn.init(a,b)},o=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,p=/^-ms-/,q=/-([\da-z])/gi,r=function(a,b){return b.toUpperCase()};n.fn=n.prototype={jquery:m,constructor:n,selector:"",length:0,toArray:function(){return e.call(this)},get:function(a){return null!=a?0>a?this[a+this.length]:this[a]:e.call(this)},pushStack:function(a){var b=n.merge(this.constructor(),a);return b.prevObject=this,b.context=this.context,b},each:function(a){return n.each(this,a)},map:function(a){return this.pushStack(n.map(this,function(b,c){return a.call(b,c,b)}))},slice:function(){return this.pushStack(e.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(a){var b=this.length,c=+a+(0>a?b:0);return this.pushStack(c>=0&&b>c?[this[c]]:[])},end:function(){return this.prevObject||this.constructor()},push:g,sort:c.sort,splice:c.splice},n.extend=n.fn.extend=function(){var a,b,c,d,e,f,g=arguments[0]||{},h=1,i=arguments.length,j=!1;for("boolean"==typeof g&&(j=g,g=arguments[h]||{},h++),"object"==typeof g||n.isFunction(g)||(g={}),h===i&&(g=this,h--);i>h;h++)if(null!=(a=arguments[h]))for(b in a)c=g[b],d=a[b],g!==d&&(j&&d&&(n.isPlainObject(d)||(e=n.isArray(d)))?(e?(e=!1,f=c&&n.isArray(c)?c:[]):f=c&&n.isPlainObject(c)?c:{},g[b]=n.extend(j,f,d)):void 0!==d&&(g[b]=d));return g},n.extend({expando:"jQuery"+(m+Math.random()).replace(/\D/g,""),isReady:!0,error:function(a){throw new Error(a)},noop:function(){},isFunction:function(a){return"function"===n.type(a)},isArray:Array.isArray,isWindow:function(a){return null!=a&&a===a.window},isNumeric:function(a){var b=a&&a.toString();return!n.isArray(a)&&b-parseFloat(b)+1>=0},isPlainObject:function(a){return"object"!==n.type(a)||a.nodeType||n.isWindow(a)?!1:a.constructor&&!k.call(a.constructor.prototype,"isPrototypeOf")?!1:!0},isEmptyObject:function(a){var b;for(b in a)return!1;return!0},type:function(a){return null==a?a+"":"object"==typeof a||"function"==typeof a?i[j.call(a)]||"object":typeof a},globalEval:function(a){var b,c=eval;a=n.trim(a),a&&(1===a.indexOf("use strict")?(b=d.createElement("script"),b.text=a,d.head.appendChild(b).parentNode.removeChild(b)):c(a))},camelCase:function(a){return a.replace(p,"ms-").replace(q,r)},nodeName:function(a,b){return a.nodeName&&a.nodeName.toLowerCase()===b.toLowerCase()},each:function(a,b){var c,d=0;if(s(a)){for(c=a.length;c>d;d++)if(b.call(a[d],d,a[d])===!1)break}else for(d in a)if(b.call(a[d],d,a[d])===!1)break;return a},trim:function(a){return null==a?"":(a+"").replace(o,"")},makeArray:function(a,b){var c=b||[];return null!=a&&(s(Object(a))?n.merge(c,"string"==typeof a?[a]:a):g.call(c,a)),c},inArray:function(a,b,c){return null==b?-1:h.call(b,a,c)},merge:function(a,b){for(var c=+b.length,d=0,e=a.length;c>d;d++)a[e++]=b[d];return a.length=e,a},grep:function(a,b,c){for(var d,e=[],f=0,g=a.length,h=!c;g>f;f++)d=!b(a[f],f),d!==h&&e.push(a[f]);return e},map:function(a,b,c){var d,e,g=0,h=[];if(s(a))for(d=a.length;d>g;g++)e=b(a[g],g,c),null!=e&&h.push(e);else for(g in a)e=b(a[g],g,c),null!=e&&h.push(e);return f.apply([],h)},guid:1,proxy:function(a,b){var c,d,f;return"string"==typeof b&&(c=a[b],b=a,a=c),n.isFunction(a)?(d=e.call(arguments,2),f=function(){return a.apply(b||this,d.concat(e.call(arguments)))},f.guid=a.guid=a.guid||n.guid++,f):void 0},now:Date.now,support:l}),"function"==typeof Symbol&&(n.fn[Symbol.iterator]=c[Symbol.iterator]),n.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "),function(a,b){i["[object "+b+"]"]=b.toLowerCase()});function s(a){var b=!!a&&"length"in a&&a.length,c=n.type(a);return"function"===c||n.isWindow(a)?!1:"array"===c||0===b||"number"==typeof b&&b>0&&b-1 in a}var t=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u="sizzle"+1*new Date,v=a.document,w=0,x=0,y=ga(),z=ga(),A=ga(),B=function(a,b){return a===b&&(l=!0),0},C=1<<31,D={}.hasOwnProperty,E=[],F=E.pop,G=E.push,H=E.push,I=E.slice,J=function(a,b){for(var c=0,d=a.length;d>c;c++)if(a[c]===b)return c;return-1},K="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",L="[\\x20\\t\\r\\n\\f]",M="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",N="\\["+L+"*("+M+")(?:"+L+"*([*^$|!~]?=)"+L+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+M+"))|)"+L+"*\\]",O=":("+M+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+N+")*)|.*)\\)|)",P=new RegExp(L+"+","g"),Q=new RegExp("^"+L+"+|((?:^|[^\\\\])(?:\\\\.)*)"+L+"+$","g"),R=new RegExp("^"+L+"*,"+L+"*"),S=new RegExp("^"+L+"*([>+~]|"+L+")"+L+"*"),T=new RegExp("="+L+"*([^\\]'\"]*?)"+L+"*\\]","g"),U=new RegExp(O),V=new RegExp("^"+M+"$"),W={ID:new RegExp("^#("+M+")"),CLASS:new RegExp("^\\.("+M+")"),TAG:new RegExp("^("+M+"|[*])"),ATTR:new RegExp("^"+N),PSEUDO:new RegExp("^"+O),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+L+"*(even|odd|(([+-]|)(\\d*)n|)"+L+"*(?:([+-]|)"+L+"*(\\d+)|))"+L+"*\\)|)","i"),bool:new RegExp("^(?:"+K+")$","i"),needsContext:new RegExp("^"+L+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+L+"*((?:-\\d)?\\d*)"+L+"*\\)|)(?=[^-]|$)","i")},X=/^(?:input|select|textarea|button)$/i,Y=/^h\d$/i,Z=/^[^{]+\{\s*\[native \w/,$=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,_=/[+~]/,aa=/'|\\/g,ba=new RegExp("\\\\([\\da-f]{1,6}"+L+"?|("+L+")|.)","ig"),ca=function(a,b,c){var d="0x"+b-65536;return d!==d||c?b:0>d?String.fromCharCode(d+65536):String.fromCharCode(d>>10|55296,1023&d|56320)},da=function(){m()};try{H.apply(E=I.call(v.childNodes),v.childNodes),E[v.childNodes.length].nodeType}catch(ea){H={apply:E.length?function(a,b){G.apply(a,I.call(b))}:function(a,b){var c=a.length,d=0;while(a[c++]=b[d++]);a.length=c-1}}}function fa(a,b,d,e){var f,h,j,k,l,o,r,s,w=b&&b.ownerDocument,x=b?b.nodeType:9;if(d=d||[],"string"!=typeof a||!a||1!==x&&9!==x&&11!==x)return d;if(!e&&((b?b.ownerDocument||b:v)!==n&&m(b),b=b||n,p)){if(11!==x&&(o=$.exec(a)))if(f=o[1]){if(9===x){if(!(j=b.getElementById(f)))return d;if(j.id===f)return d.push(j),d}else if(w&&(j=w.getElementById(f))&&t(b,j)&&j.id===f)return d.push(j),d}else{if(o[2])return H.apply(d,b.getElementsByTagName(a)),d;if((f=o[3])&&c.getElementsByClassName&&b.getElementsByClassName)return H.apply(d,b.getElementsByClassName(f)),d}if(c.qsa&&!A[a+" "]&&(!q||!q.test(a))){if(1!==x)w=b,s=a;else if("object"!==b.nodeName.toLowerCase()){(k=b.getAttribute("id"))?k=k.replace(aa,"\\$&"):b.setAttribute("id",k=u),r=g(a),h=r.length,l=V.test(k)?"#"+k:"[id='"+k+"']";while(h--)r[h]=l+" "+qa(r[h]);s=r.join(","),w=_.test(a)&&oa(b.parentNode)||b}if(s)try{return H.apply(d,w.querySelectorAll(s)),d}catch(y){}finally{k===u&&b.removeAttribute("id")}}}return i(a.replace(Q,"$1"),b,d,e)}function ga(){var a=[];function b(c,e){return a.push(c+" ")>d.cacheLength&&delete b[a.shift()],b[c+" "]=e}return b}function ha(a){return a[u]=!0,a}function ia(a){var b=n.createElement("div");try{return!!a(b)}catch(c){return!1}finally{b.parentNode&&b.parentNode.removeChild(b),b=null}}function ja(a,b){var c=a.split("|"),e=c.length;while(e--)d.attrHandle[c[e]]=b}function ka(a,b){var c=b&&a,d=c&&1===a.nodeType&&1===b.nodeType&&(~b.sourceIndex||C)-(~a.sourceIndex||C);if(d)return d;if(c)while(c=c.nextSibling)if(c===b)return-1;return a?1:-1}function la(a){return function(b){var c=b.nodeName.toLowerCase();return"input"===c&&b.type===a}}function ma(a){return function(b){var c=b.nodeName.toLowerCase();return("input"===c||"button"===c)&&b.type===a}}function na(a){return ha(function(b){return b=+b,ha(function(c,d){var e,f=a([],c.length,b),g=f.length;while(g--)c[e=f[g]]&&(c[e]=!(d[e]=c[e]))})})}function oa(a){return a&&"undefined"!=typeof a.getElementsByTagName&&a}c=fa.support={},f=fa.isXML=function(a){var b=a&&(a.ownerDocument||a).documentElement;return b?"HTML"!==b.nodeName:!1},m=fa.setDocument=function(a){var b,e,g=a?a.ownerDocument||a:v;return g!==n&&9===g.nodeType&&g.documentElement?(n=g,o=n.documentElement,p=!f(n),(e=n.defaultView)&&e.top!==e&&(e.addEventListener?e.addEventListener("unload",da,!1):e.attachEvent&&e.attachEvent("onunload",da)),c.attributes=ia(function(a){return a.className="i",!a.getAttribute("className")}),c.getElementsByTagName=ia(function(a){return a.appendChild(n.createComment("")),!a.getElementsByTagName("*").length}),c.getElementsByClassName=Z.test(n.getElementsByClassName),c.getById=ia(function(a){return o.appendChild(a).id=u,!n.getElementsByName||!n.getElementsByName(u).length}),c.getById?(d.find.ID=function(a,b){if("undefined"!=typeof b.getElementById&&p){var c=b.getElementById(a);return c?[c]:[]}},d.filter.ID=function(a){var b=a.replace(ba,ca);return function(a){return a.getAttribute("id")===b}}):(delete d.find.ID,d.filter.ID=function(a){var b=a.replace(ba,ca);return function(a){var c="undefined"!=typeof a.getAttributeNode&&a.getAttributeNode("id");return c&&c.value===b}}),d.find.TAG=c.getElementsByTagName?function(a,b){return"undefined"!=typeof b.getElementsByTagName?b.getElementsByTagName(a):c.qsa?b.querySelectorAll(a):void 0}:function(a,b){var c,d=[],e=0,f=b.getElementsByTagName(a);if("*"===a){while(c=f[e++])1===c.nodeType&&d.push(c);return d}return f},d.find.CLASS=c.getElementsByClassName&&function(a,b){return"undefined"!=typeof b.getElementsByClassName&&p?b.getElementsByClassName(a):void 0},r=[],q=[],(c.qsa=Z.test(n.querySelectorAll))&&(ia(function(a){o.appendChild(a).innerHTML="<a id='"+u+"'></a><select id='"+u+"-\r\\' msallowcapture=''><option selected=''></option></select>",a.querySelectorAll("[msallowcapture^='']").length&&q.push("[*^$]="+L+"*(?:''|\"\")"),a.querySelectorAll("[selected]").length||q.push("\\["+L+"*(?:value|"+K+")"),a.querySelectorAll("[id~="+u+"-]").length||q.push("~="),a.querySelectorAll(":checked").length||q.push(":checked"),a.querySelectorAll("a#"+u+"+*").length||q.push(".#.+[+~]")}),ia(function(a){var b=n.createElement("input");b.setAttribute("type","hidden"),a.appendChild(b).setAttribute("name","D"),a.querySelectorAll("[name=d]").length&&q.push("name"+L+"*[*^$|!~]?="),a.querySelectorAll(":enabled").length||q.push(":enabled",":disabled"),a.querySelectorAll("*,:x"),q.push(",.*:")})),(c.matchesSelector=Z.test(s=o.matches||o.webkitMatchesSelector||o.mozMatchesSelector||o.oMatchesSelector||o.msMatchesSelector))&&ia(function(a){c.disconnectedMatch=s.call(a,"div"),s.call(a,"[s!='']:x"),r.push("!=",O)}),q=q.length&&new RegExp(q.join("|")),r=r.length&&new RegExp(r.join("|")),b=Z.test(o.compareDocumentPosition),t=b||Z.test(o.contains)?function(a,b){var c=9===a.nodeType?a.documentElement:a,d=b&&b.parentNode;return a===d||!(!d||1!==d.nodeType||!(c.contains?c.contains(d):a.compareDocumentPosition&&16&a.compareDocumentPosition(d)))}:function(a,b){if(b)while(b=b.parentNode)if(b===a)return!0;return!1},B=b?function(a,b){if(a===b)return l=!0,0;var d=!a.compareDocumentPosition-!b.compareDocumentPosition;return d?d:(d=(a.ownerDocument||a)===(b.ownerDocument||b)?a.compareDocumentPosition(b):1,1&d||!c.sortDetached&&b.compareDocumentPosition(a)===d?a===n||a.ownerDocument===v&&t(v,a)?-1:b===n||b.ownerDocument===v&&t(v,b)?1:k?J(k,a)-J(k,b):0:4&d?-1:1)}:function(a,b){if(a===b)return l=!0,0;var c,d=0,e=a.parentNode,f=b.parentNode,g=[a],h=[b];if(!e||!f)return a===n?-1:b===n?1:e?-1:f?1:k?J(k,a)-J(k,b):0;if(e===f)return ka(a,b);c=a;while(c=c.parentNode)g.unshift(c);c=b;while(c=c.parentNode)h.unshift(c);while(g[d]===h[d])d++;return d?ka(g[d],h[d]):g[d]===v?-1:h[d]===v?1:0},n):n},fa.matches=function(a,b){return fa(a,null,null,b)},fa.matchesSelector=function(a,b){if((a.ownerDocument||a)!==n&&m(a),b=b.replace(T,"='$1']"),c.matchesSelector&&p&&!A[b+" "]&&(!r||!r.test(b))&&(!q||!q.test(b)))try{var d=s.call(a,b);if(d||c.disconnectedMatch||a.document&&11!==a.document.nodeType)return d}catch(e){}return fa(b,n,null,[a]).length>0},fa.contains=function(a,b){return(a.ownerDocument||a)!==n&&m(a),t(a,b)},fa.attr=function(a,b){(a.ownerDocument||a)!==n&&m(a);var e=d.attrHandle[b.toLowerCase()],f=e&&D.call(d.attrHandle,b.toLowerCase())?e(a,b,!p):void 0;return void 0!==f?f:c.attributes||!p?a.getAttribute(b):(f=a.getAttributeNode(b))&&f.specified?f.value:null},fa.error=function(a){throw new Error("Syntax error, unrecognized expression: "+a)},fa.uniqueSort=function(a){var b,d=[],e=0,f=0;if(l=!c.detectDuplicates,k=!c.sortStable&&a.slice(0),a.sort(B),l){while(b=a[f++])b===a[f]&&(e=d.push(f));while(e--)a.splice(d[e],1)}return k=null,a},e=fa.getText=function(a){var b,c="",d=0,f=a.nodeType;if(f){if(1===f||9===f||11===f){if("string"==typeof a.textContent)return a.textContent;for(a=a.firstChild;a;a=a.nextSibling)c+=e(a)}else if(3===f||4===f)return a.nodeValue}else while(b=a[d++])c+=e(b);return c},d=fa.selectors={cacheLength:50,createPseudo:ha,match:W,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(a){return a[1]=a[1].replace(ba,ca),a[3]=(a[3]||a[4]||a[5]||"").replace(ba,ca),"~="===a[2]&&(a[3]=" "+a[3]+" "),a.slice(0,4)},CHILD:function(a){return a[1]=a[1].toLowerCase(),"nth"===a[1].slice(0,3)?(a[3]||fa.error(a[0]),a[4]=+(a[4]?a[5]+(a[6]||1):2*("even"===a[3]||"odd"===a[3])),a[5]=+(a[7]+a[8]||"odd"===a[3])):a[3]&&fa.error(a[0]),a},PSEUDO:function(a){var b,c=!a[6]&&a[2];return W.CHILD.test(a[0])?null:(a[3]?a[2]=a[4]||a[5]||"":c&&U.test(c)&&(b=g(c,!0))&&(b=c.indexOf(")",c.length-b)-c.length)&&(a[0]=a[0].slice(0,b),a[2]=c.slice(0,b)),a.slice(0,3))}},filter:{TAG:function(a){var b=a.replace(ba,ca).toLowerCase();return"*"===a?function(){return!0}:function(a){return a.nodeName&&a.nodeName.toLowerCase()===b}},CLASS:function(a){var b=y[a+" "];return b||(b=new RegExp("(^|"+L+")"+a+"("+L+"|$)"))&&y(a,function(a){return b.test("string"==typeof a.className&&a.className||"undefined"!=typeof a.getAttribute&&a.getAttribute("class")||"")})},ATTR:function(a,b,c){return function(d){var e=fa.attr(d,a);return null==e?"!="===b:b?(e+="","="===b?e===c:"!="===b?e!==c:"^="===b?c&&0===e.indexOf(c):"*="===b?c&&e.indexOf(c)>-1:"$="===b?c&&e.slice(-c.length)===c:"~="===b?(" "+e.replace(P," ")+" ").indexOf(c)>-1:"|="===b?e===c||e.slice(0,c.length+1)===c+"-":!1):!0}},CHILD:function(a,b,c,d,e){var f="nth"!==a.slice(0,3),g="last"!==a.slice(-4),h="of-type"===b;return 1===d&&0===e?function(a){return!!a.parentNode}:function(b,c,i){var j,k,l,m,n,o,p=f!==g?"nextSibling":"previousSibling",q=b.parentNode,r=h&&b.nodeName.toLowerCase(),s=!i&&!h,t=!1;if(q){if(f){while(p){m=b;while(m=m[p])if(h?m.nodeName.toLowerCase()===r:1===m.nodeType)return!1;o=p="only"===a&&!o&&"nextSibling"}return!0}if(o=[g?q.firstChild:q.lastChild],g&&s){m=q,l=m[u]||(m[u]={}),k=l[m.uniqueID]||(l[m.uniqueID]={}),j=k[a]||[],n=j[0]===w&&j[1],t=n&&j[2],m=n&&q.childNodes[n];while(m=++n&&m&&m[p]||(t=n=0)||o.pop())if(1===m.nodeType&&++t&&m===b){k[a]=[w,n,t];break}}else if(s&&(m=b,l=m[u]||(m[u]={}),k=l[m.uniqueID]||(l[m.uniqueID]={}),j=k[a]||[],n=j[0]===w&&j[1],t=n),t===!1)while(m=++n&&m&&m[p]||(t=n=0)||o.pop())if((h?m.nodeName.toLowerCase()===r:1===m.nodeType)&&++t&&(s&&(l=m[u]||(m[u]={}),k=l[m.uniqueID]||(l[m.uniqueID]={}),k[a]=[w,t]),m===b))break;return t-=e,t===d||t%d===0&&t/d>=0}}},PSEUDO:function(a,b){var c,e=d.pseudos[a]||d.setFilters[a.toLowerCase()]||fa.error("unsupported pseudo: "+a);return e[u]?e(b):e.length>1?(c=[a,a,"",b],d.setFilters.hasOwnProperty(a.toLowerCase())?ha(function(a,c){var d,f=e(a,b),g=f.length;while(g--)d=J(a,f[g]),a[d]=!(c[d]=f[g])}):function(a){return e(a,0,c)}):e}},pseudos:{not:ha(function(a){var b=[],c=[],d=h(a.replace(Q,"$1"));return d[u]?ha(function(a,b,c,e){var f,g=d(a,null,e,[]),h=a.length;while(h--)(f=g[h])&&(a[h]=!(b[h]=f))}):function(a,e,f){return b[0]=a,d(b,null,f,c),b[0]=null,!c.pop()}}),has:ha(function(a){return function(b){return fa(a,b).length>0}}),contains:ha(function(a){return a=a.replace(ba,ca),function(b){return(b.textContent||b.innerText||e(b)).indexOf(a)>-1}}),lang:ha(function(a){return V.test(a||"")||fa.error("unsupported lang: "+a),a=a.replace(ba,ca).toLowerCase(),function(b){var c;do if(c=p?b.lang:b.getAttribute("xml:lang")||b.getAttribute("lang"))return c=c.toLowerCase(),c===a||0===c.indexOf(a+"-");while((b=b.parentNode)&&1===b.nodeType);return!1}}),target:function(b){var c=a.location&&a.location.hash;return c&&c.slice(1)===b.id},root:function(a){return a===o},focus:function(a){return a===n.activeElement&&(!n.hasFocus||n.hasFocus())&&!!(a.type||a.href||~a.tabIndex)},enabled:function(a){return a.disabled===!1},disabled:function(a){return a.disabled===!0},checked:function(a){var b=a.nodeName.toLowerCase();return"input"===b&&!!a.checked||"option"===b&&!!a.selected},selected:function(a){return a.parentNode&&a.parentNode.selectedIndex,a.selected===!0},empty:function(a){for(a=a.firstChild;a;a=a.nextSibling)if(a.nodeType<6)return!1;return!0},parent:function(a){return!d.pseudos.empty(a)},header:function(a){return Y.test(a.nodeName)},input:function(a){return X.test(a.nodeName)},button:function(a){var b=a.nodeName.toLowerCase();return"input"===b&&"button"===a.type||"button"===b},text:function(a){var b;return"input"===a.nodeName.toLowerCase()&&"text"===a.type&&(null==(b=a.getAttribute("type"))||"text"===b.toLowerCase())},first:na(function(){return[0]}),last:na(function(a,b){return[b-1]}),eq:na(function(a,b,c){return[0>c?c+b:c]}),even:na(function(a,b){for(var c=0;b>c;c+=2)a.push(c);return a}),odd:na(function(a,b){for(var c=1;b>c;c+=2)a.push(c);return a}),lt:na(function(a,b,c){for(var d=0>c?c+b:c;--d>=0;)a.push(d);return a}),gt:na(function(a,b,c){for(var d=0>c?c+b:c;++d<b;)a.push(d);return a})}},d.pseudos.nth=d.pseudos.eq;for(b in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})d.pseudos[b]=la(b);for(b in{submit:!0,reset:!0})d.pseudos[b]=ma(b);function pa(){}pa.prototype=d.filters=d.pseudos,d.setFilters=new pa,g=fa.tokenize=function(a,b){var c,e,f,g,h,i,j,k=z[a+" "];if(k)return b?0:k.slice(0);h=a,i=[],j=d.preFilter;while(h){(!c||(e=R.exec(h)))&&(e&&(h=h.slice(e[0].length)||h),i.push(f=[])),c=!1,(e=S.exec(h))&&(c=e.shift(),f.push({value:c,type:e[0].replace(Q," ")}),h=h.slice(c.length));for(g in d.filter)!(e=W[g].exec(h))||j[g]&&!(e=j[g](e))||(c=e.shift(),f.push({value:c,type:g,matches:e}),h=h.slice(c.length));if(!c)break}return b?h.length:h?fa.error(a):z(a,i).slice(0)};function qa(a){for(var b=0,c=a.length,d="";c>b;b++)d+=a[b].value;return d}function ra(a,b,c){var d=b.dir,e=c&&"parentNode"===d,f=x++;return b.first?function(b,c,f){while(b=b[d])if(1===b.nodeType||e)return a(b,c,f)}:function(b,c,g){var h,i,j,k=[w,f];if(g){while(b=b[d])if((1===b.nodeType||e)&&a(b,c,g))return!0}else while(b=b[d])if(1===b.nodeType||e){if(j=b[u]||(b[u]={}),i=j[b.uniqueID]||(j[b.uniqueID]={}),(h=i[d])&&h[0]===w&&h[1]===f)return k[2]=h[2];if(i[d]=k,k[2]=a(b,c,g))return!0}}}function sa(a){return a.length>1?function(b,c,d){var e=a.length;while(e--)if(!a[e](b,c,d))return!1;return!0}:a[0]}function ta(a,b,c){for(var d=0,e=b.length;e>d;d++)fa(a,b[d],c);return c}function ua(a,b,c,d,e){for(var f,g=[],h=0,i=a.length,j=null!=b;i>h;h++)(f=a[h])&&(!c||c(f,d,e))&&(g.push(f),j&&b.push(h));return g}function va(a,b,c,d,e,f){return d&&!d[u]&&(d=va(d)),e&&!e[u]&&(e=va(e,f)),ha(function(f,g,h,i){var j,k,l,m=[],n=[],o=g.length,p=f||ta(b||"*",h.nodeType?[h]:h,[]),q=!a||!f&&b?p:ua(p,m,a,h,i),r=c?e||(f?a:o||d)?[]:g:q;if(c&&c(q,r,h,i),d){j=ua(r,n),d(j,[],h,i),k=j.length;while(k--)(l=j[k])&&(r[n[k]]=!(q[n[k]]=l))}if(f){if(e||a){if(e){j=[],k=r.length;while(k--)(l=r[k])&&j.push(q[k]=l);e(null,r=[],j,i)}k=r.length;while(k--)(l=r[k])&&(j=e?J(f,l):m[k])>-1&&(f[j]=!(g[j]=l))}}else r=ua(r===g?r.splice(o,r.length):r),e?e(null,g,r,i):H.apply(g,r)})}function wa(a){for(var b,c,e,f=a.length,g=d.relative[a[0].type],h=g||d.relative[" "],i=g?1:0,k=ra(function(a){return a===b},h,!0),l=ra(function(a){return J(b,a)>-1},h,!0),m=[function(a,c,d){var e=!g&&(d||c!==j)||((b=c).nodeType?k(a,c,d):l(a,c,d));return b=null,e}];f>i;i++)if(c=d.relative[a[i].type])m=[ra(sa(m),c)];else{if(c=d.filter[a[i].type].apply(null,a[i].matches),c[u]){for(e=++i;f>e;e++)if(d.relative[a[e].type])break;return va(i>1&&sa(m),i>1&&qa(a.slice(0,i-1).concat({value:" "===a[i-2].type?"*":""})).replace(Q,"$1"),c,e>i&&wa(a.slice(i,e)),f>e&&wa(a=a.slice(e)),f>e&&qa(a))}m.push(c)}return sa(m)}function xa(a,b){var c=b.length>0,e=a.length>0,f=function(f,g,h,i,k){var l,o,q,r=0,s="0",t=f&&[],u=[],v=j,x=f||e&&d.find.TAG("*",k),y=w+=null==v?1:Math.random()||.1,z=x.length;for(k&&(j=g===n||g||k);s!==z&&null!=(l=x[s]);s++){if(e&&l){o=0,g||l.ownerDocument===n||(m(l),h=!p);while(q=a[o++])if(q(l,g||n,h)){i.push(l);break}k&&(w=y)}c&&((l=!q&&l)&&r--,f&&t.push(l))}if(r+=s,c&&s!==r){o=0;while(q=b[o++])q(t,u,g,h);if(f){if(r>0)while(s--)t[s]||u[s]||(u[s]=F.call(i));u=ua(u)}H.apply(i,u),k&&!f&&u.length>0&&r+b.length>1&&fa.uniqueSort(i)}return k&&(w=y,j=v),t};return c?ha(f):f}return h=fa.compile=function(a,b){var c,d=[],e=[],f=A[a+" "];if(!f){b||(b=g(a)),c=b.length;while(c--)f=wa(b[c]),f[u]?d.push(f):e.push(f);f=A(a,xa(e,d)),f.selector=a}return f},i=fa.select=function(a,b,e,f){var i,j,k,l,m,n="function"==typeof a&&a,o=!f&&g(a=n.selector||a);if(e=e||[],1===o.length){if(j=o[0]=o[0].slice(0),j.length>2&&"ID"===(k=j[0]).type&&c.getById&&9===b.nodeType&&p&&d.relative[j[1].type]){if(b=(d.find.ID(k.matches[0].replace(ba,ca),b)||[])[0],!b)return e;n&&(b=b.parentNode),a=a.slice(j.shift().value.length)}i=W.needsContext.test(a)?0:j.length;while(i--){if(k=j[i],d.relative[l=k.type])break;if((m=d.find[l])&&(f=m(k.matches[0].replace(ba,ca),_.test(j[0].type)&&oa(b.parentNode)||b))){if(j.splice(i,1),a=f.length&&qa(j),!a)return H.apply(e,f),e;break}}}return(n||h(a,o))(f,b,!p,e,!b||_.test(a)&&oa(b.parentNode)||b),e},c.sortStable=u.split("").sort(B).join("")===u,c.detectDuplicates=!!l,m(),c.sortDetached=ia(function(a){return 1&a.compareDocumentPosition(n.createElement("div"))}),ia(function(a){return a.innerHTML="<a href='#'></a>","#"===a.firstChild.getAttribute("href")})||ja("type|href|height|width",function(a,b,c){return c?void 0:a.getAttribute(b,"type"===b.toLowerCase()?1:2)}),c.attributes&&ia(function(a){return a.innerHTML="<input/>",a.firstChild.setAttribute("value",""),""===a.firstChild.getAttribute("value")})||ja("value",function(a,b,c){return c||"input"!==a.nodeName.toLowerCase()?void 0:a.defaultValue}),ia(function(a){return null==a.getAttribute("disabled")})||ja(K,function(a,b,c){var d;return c?void 0:a[b]===!0?b.toLowerCase():(d=a.getAttributeNode(b))&&d.specified?d.value:null}),fa}(a);n.find=t,n.expr=t.selectors,n.expr[":"]=n.expr.pseudos,n.uniqueSort=n.unique=t.uniqueSort,n.text=t.getText,n.isXMLDoc=t.isXML,n.contains=t.contains;var u=function(a,b,c){var d=[],e=void 0!==c;while((a=a[b])&&9!==a.nodeType)if(1===a.nodeType){if(e&&n(a).is(c))break;d.push(a)}return d},v=function(a,b){for(var c=[];a;a=a.nextSibling)1===a.nodeType&&a!==b&&c.push(a);return c},w=n.expr.match.needsContext,x=/^<([\w-]+)\s*\/?>(?:<\/\1>|)$/,y=/^.[^:#\[\.,]*$/;function z(a,b,c){if(n.isFunction(b))return n.grep(a,function(a,d){return!!b.call(a,d,a)!==c});if(b.nodeType)return n.grep(a,function(a){return a===b!==c});if("string"==typeof b){if(y.test(b))return n.filter(b,a,c);b=n.filter(b,a)}return n.grep(a,function(a){return h.call(b,a)>-1!==c})}n.filter=function(a,b,c){var d=b[0];return c&&(a=":not("+a+")"),1===b.length&&1===d.nodeType?n.find.matchesSelector(d,a)?[d]:[]:n.find.matches(a,n.grep(b,function(a){return 1===a.nodeType}))},n.fn.extend({find:function(a){var b,c=this.length,d=[],e=this;if("string"!=typeof a)return this.pushStack(n(a).filter(function(){for(b=0;c>b;b++)if(n.contains(e[b],this))return!0}));for(b=0;c>b;b++)n.find(a,e[b],d);return d=this.pushStack(c>1?n.unique(d):d),d.selector=this.selector?this.selector+" "+a:a,d},filter:function(a){return this.pushStack(z(this,a||[],!1))},not:function(a){return this.pushStack(z(this,a||[],!0))},is:function(a){return!!z(this,"string"==typeof a&&w.test(a)?n(a):a||[],!1).length}});var A,B=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/,C=n.fn.init=function(a,b,c){var e,f;if(!a)return this;if(c=c||A,"string"==typeof a){if(e="<"===a[0]&&">"===a[a.length-1]&&a.length>=3?[null,a,null]:B.exec(a),!e||!e[1]&&b)return!b||b.jquery?(b||c).find(a):this.constructor(b).find(a);if(e[1]){if(b=b instanceof n?b[0]:b,n.merge(this,n.parseHTML(e[1],b&&b.nodeType?b.ownerDocument||b:d,!0)),x.test(e[1])&&n.isPlainObject(b))for(e in b)n.isFunction(this[e])?this[e](b[e]):this.attr(e,b[e]);return this}return f=d.getElementById(e[2]),f&&f.parentNode&&(this.length=1,this[0]=f),this.context=d,this.selector=a,this}return a.nodeType?(this.context=this[0]=a,this.length=1,this):n.isFunction(a)?void 0!==c.ready?c.ready(a):a(n):(void 0!==a.selector&&(this.selector=a.selector,this.context=a.context),n.makeArray(a,this))};C.prototype=n.fn,A=n(d);var D=/^(?:parents|prev(?:Until|All))/,E={children:!0,contents:!0,next:!0,prev:!0};n.fn.extend({has:function(a){var b=n(a,this),c=b.length;return this.filter(function(){for(var a=0;c>a;a++)if(n.contains(this,b[a]))return!0})},closest:function(a,b){for(var c,d=0,e=this.length,f=[],g=w.test(a)||"string"!=typeof a?n(a,b||this.context):0;e>d;d++)for(c=this[d];c&&c!==b;c=c.parentNode)if(c.nodeType<11&&(g?g.index(c)>-1:1===c.nodeType&&n.find.matchesSelector(c,a))){f.push(c);break}return this.pushStack(f.length>1?n.uniqueSort(f):f)},index:function(a){return a?"string"==typeof a?h.call(n(a),this[0]):h.call(this,a.jquery?a[0]:a):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(a,b){return this.pushStack(n.uniqueSort(n.merge(this.get(),n(a,b))))},addBack:function(a){return this.add(null==a?this.prevObject:this.prevObject.filter(a))}});function F(a,b){while((a=a[b])&&1!==a.nodeType);return a}n.each({parent:function(a){var b=a.parentNode;return b&&11!==b.nodeType?b:null},parents:function(a){return u(a,"parentNode")},parentsUntil:function(a,b,c){return u(a,"parentNode",c)},next:function(a){return F(a,"nextSibling")},prev:function(a){return F(a,"previousSibling")},nextAll:function(a){return u(a,"nextSibling")},prevAll:function(a){return u(a,"previousSibling")},nextUntil:function(a,b,c){return u(a,"nextSibling",c)},prevUntil:function(a,b,c){return u(a,"previousSibling",c)},siblings:function(a){return v((a.parentNode||{}).firstChild,a)},children:function(a){return v(a.firstChild)},contents:function(a){return a.contentDocument||n.merge([],a.childNodes)}},function(a,b){n.fn[a]=function(c,d){var e=n.map(this,b,c);return"Until"!==a.slice(-5)&&(d=c),d&&"string"==typeof d&&(e=n.filter(d,e)),this.length>1&&(E[a]||n.uniqueSort(e),D.test(a)&&e.reverse()),this.pushStack(e)}});var G=/\S+/g;function H(a){var b={};return n.each(a.match(G)||[],function(a,c){b[c]=!0}),b}n.Callbacks=function(a){a="string"==typeof a?H(a):n.extend({},a);var b,c,d,e,f=[],g=[],h=-1,i=function(){for(e=a.once,d=b=!0;g.length;h=-1){c=g.shift();while(++h<f.length)f[h].apply(c[0],c[1])===!1&&a.stopOnFalse&&(h=f.length,c=!1)}a.memory||(c=!1),b=!1,e&&(f=c?[]:"")},j={add:function(){return f&&(c&&!b&&(h=f.length-1,g.push(c)),function d(b){n.each(b,function(b,c){n.isFunction(c)?a.unique&&j.has(c)||f.push(c):c&&c.length&&"string"!==n.type(c)&&d(c)})}(arguments),c&&!b&&i()),this},remove:function(){return n.each(arguments,function(a,b){var c;while((c=n.inArray(b,f,c))>-1)f.splice(c,1),h>=c&&h--}),this},has:function(a){return a?n.inArray(a,f)>-1:f.length>0},empty:function(){return f&&(f=[]),this},disable:function(){return e=g=[],f=c="",this},disabled:function(){return!f},lock:function(){return e=g=[],c||(f=c=""),this},locked:function(){return!!e},fireWith:function(a,c){return e||(c=c||[],c=[a,c.slice?c.slice():c],g.push(c),b||i()),this},fire:function(){return j.fireWith(this,arguments),this},fired:function(){return!!d}};return j},n.extend({Deferred:function(a){var b=[["resolve","done",n.Callbacks("once memory"),"resolved"],["reject","fail",n.Callbacks("once memory"),"rejected"],["notify","progress",n.Callbacks("memory")]],c="pending",d={state:function(){return c},always:function(){return e.done(arguments).fail(arguments),this},then:function(){var a=arguments;return n.Deferred(function(c){n.each(b,function(b,f){var g=n.isFunction(a[b])&&a[b];e[f[1]](function(){var a=g&&g.apply(this,arguments);a&&n.isFunction(a.promise)?a.promise().progress(c.notify).done(c.resolve).fail(c.reject):c[f[0]+"With"](this===d?c.promise():this,g?[a]:arguments)})}),a=null}).promise()},promise:function(a){return null!=a?n.extend(a,d):d}},e={};return d.pipe=d.then,n.each(b,function(a,f){var g=f[2],h=f[3];d[f[1]]=g.add,h&&g.add(function(){c=h},b[1^a][2].disable,b[2][2].lock),e[f[0]]=function(){return e[f[0]+"With"](this===e?d:this,arguments),this},e[f[0]+"With"]=g.fireWith}),d.promise(e),a&&a.call(e,e),e},when:function(a){var b=0,c=e.call(arguments),d=c.length,f=1!==d||a&&n.isFunction(a.promise)?d:0,g=1===f?a:n.Deferred(),h=function(a,b,c){return function(d){b[a]=this,c[a]=arguments.length>1?e.call(arguments):d,c===i?g.notifyWith(b,c):--f||g.resolveWith(b,c)}},i,j,k;if(d>1)for(i=new Array(d),j=new Array(d),k=new Array(d);d>b;b++)c[b]&&n.isFunction(c[b].promise)?c[b].promise().progress(h(b,j,i)).done(h(b,k,c)).fail(g.reject):--f;return f||g.resolveWith(k,c),g.promise()}});var I;n.fn.ready=function(a){return n.ready.promise().done(a),this},n.extend({isReady:!1,readyWait:1,holdReady:function(a){a?n.readyWait++:n.ready(!0)},ready:function(a){(a===!0?--n.readyWait:n.isReady)||(n.isReady=!0,a!==!0&&--n.readyWait>0||(I.resolveWith(d,[n]),n.fn.triggerHandler&&(n(d).triggerHandler("ready"),n(d).off("ready"))))}});function J(){d.removeEventListener("DOMContentLoaded",J),a.removeEventListener("load",J),n.ready()}n.ready.promise=function(b){return I||(I=n.Deferred(),"complete"===d.readyState||"loading"!==d.readyState&&!d.documentElement.doScroll?a.setTimeout(n.ready):(d.addEventListener("DOMContentLoaded",J),a.addEventListener("load",J))),I.promise(b)},n.ready.promise();var K=function(a,b,c,d,e,f,g){var h=0,i=a.length,j=null==c;if("object"===n.type(c)){e=!0;for(h in c)K(a,b,h,c[h],!0,f,g)}else if(void 0!==d&&(e=!0,n.isFunction(d)||(g=!0),j&&(g?(b.call(a,d),b=null):(j=b,b=function(a,b,c){return j.call(n(a),c)})),b))for(;i>h;h++)b(a[h],c,g?d:d.call(a[h],h,b(a[h],c)));return e?a:j?b.call(a):i?b(a[0],c):f},L=function(a){return 1===a.nodeType||9===a.nodeType||!+a.nodeType};function M(){this.expando=n.expando+M.uid++}M.uid=1,M.prototype={register:function(a,b){var c=b||{};return a.nodeType?a[this.expando]=c:Object.defineProperty(a,this.expando,{value:c,writable:!0,configurable:!0}),a[this.expando]},cache:function(a){if(!L(a))return{};var b=a[this.expando];return b||(b={},L(a)&&(a.nodeType?a[this.expando]=b:Object.defineProperty(a,this.expando,{value:b,configurable:!0}))),b},set:function(a,b,c){var d,e=this.cache(a);if("string"==typeof b)e[b]=c;else for(d in b)e[d]=b[d];return e},get:function(a,b){return void 0===b?this.cache(a):a[this.expando]&&a[this.expando][b]},access:function(a,b,c){var d;return void 0===b||b&&"string"==typeof b&&void 0===c?(d=this.get(a,b),void 0!==d?d:this.get(a,n.camelCase(b))):(this.set(a,b,c),void 0!==c?c:b)},remove:function(a,b){var c,d,e,f=a[this.expando];if(void 0!==f){if(void 0===b)this.register(a);else{n.isArray(b)?d=b.concat(b.map(n.camelCase)):(e=n.camelCase(b),b in f?d=[b,e]:(d=e,d=d in f?[d]:d.match(G)||[])),c=d.length;while(c--)delete f[d[c]]}(void 0===b||n.isEmptyObject(f))&&(a.nodeType?a[this.expando]=void 0:delete a[this.expando])}},hasData:function(a){var b=a[this.expando];return void 0!==b&&!n.isEmptyObject(b)}};var N=new M,O=new M,P=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,Q=/[A-Z]/g;function R(a,b,c){var d;if(void 0===c&&1===a.nodeType)if(d="data-"+b.replace(Q,"-$&").toLowerCase(),c=a.getAttribute(d),"string"==typeof c){try{c="true"===c?!0:"false"===c?!1:"null"===c?null:+c+""===c?+c:P.test(c)?n.parseJSON(c):c}catch(e){}O.set(a,b,c);
}else c=void 0;return c}n.extend({hasData:function(a){return O.hasData(a)||N.hasData(a)},data:function(a,b,c){return O.access(a,b,c)},removeData:function(a,b){O.remove(a,b)},_data:function(a,b,c){return N.access(a,b,c)},_removeData:function(a,b){N.remove(a,b)}}),n.fn.extend({data:function(a,b){var c,d,e,f=this[0],g=f&&f.attributes;if(void 0===a){if(this.length&&(e=O.get(f),1===f.nodeType&&!N.get(f,"hasDataAttrs"))){c=g.length;while(c--)g[c]&&(d=g[c].name,0===d.indexOf("data-")&&(d=n.camelCase(d.slice(5)),R(f,d,e[d])));N.set(f,"hasDataAttrs",!0)}return e}return"object"==typeof a?this.each(function(){O.set(this,a)}):K(this,function(b){var c,d;if(f&&void 0===b){if(c=O.get(f,a)||O.get(f,a.replace(Q,"-$&").toLowerCase()),void 0!==c)return c;if(d=n.camelCase(a),c=O.get(f,d),void 0!==c)return c;if(c=R(f,d,void 0),void 0!==c)return c}else d=n.camelCase(a),this.each(function(){var c=O.get(this,d);O.set(this,d,b),a.indexOf("-")>-1&&void 0!==c&&O.set(this,a,b)})},null,b,arguments.length>1,null,!0)},removeData:function(a){return this.each(function(){O.remove(this,a)})}}),n.extend({queue:function(a,b,c){var d;return a?(b=(b||"fx")+"queue",d=N.get(a,b),c&&(!d||n.isArray(c)?d=N.access(a,b,n.makeArray(c)):d.push(c)),d||[]):void 0},dequeue:function(a,b){b=b||"fx";var c=n.queue(a,b),d=c.length,e=c.shift(),f=n._queueHooks(a,b),g=function(){n.dequeue(a,b)};"inprogress"===e&&(e=c.shift(),d--),e&&("fx"===b&&c.unshift("inprogress"),delete f.stop,e.call(a,g,f)),!d&&f&&f.empty.fire()},_queueHooks:function(a,b){var c=b+"queueHooks";return N.get(a,c)||N.access(a,c,{empty:n.Callbacks("once memory").add(function(){N.remove(a,[b+"queue",c])})})}}),n.fn.extend({queue:function(a,b){var c=2;return"string"!=typeof a&&(b=a,a="fx",c--),arguments.length<c?n.queue(this[0],a):void 0===b?this:this.each(function(){var c=n.queue(this,a,b);n._queueHooks(this,a),"fx"===a&&"inprogress"!==c[0]&&n.dequeue(this,a)})},dequeue:function(a){return this.each(function(){n.dequeue(this,a)})},clearQueue:function(a){return this.queue(a||"fx",[])},promise:function(a,b){var c,d=1,e=n.Deferred(),f=this,g=this.length,h=function(){--d||e.resolveWith(f,[f])};"string"!=typeof a&&(b=a,a=void 0),a=a||"fx";while(g--)c=N.get(f[g],a+"queueHooks"),c&&c.empty&&(d++,c.empty.add(h));return h(),e.promise(b)}});var S=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,T=new RegExp("^(?:([+-])=|)("+S+")([a-z%]*)$","i"),U=["Top","Right","Bottom","Left"],V=function(a,b){return a=b||a,"none"===n.css(a,"display")||!n.contains(a.ownerDocument,a)};function W(a,b,c,d){var e,f=1,g=20,h=d?function(){return d.cur()}:function(){return n.css(a,b,"")},i=h(),j=c&&c[3]||(n.cssNumber[b]?"":"px"),k=(n.cssNumber[b]||"px"!==j&&+i)&&T.exec(n.css(a,b));if(k&&k[3]!==j){j=j||k[3],c=c||[],k=+i||1;do f=f||".5",k/=f,n.style(a,b,k+j);while(f!==(f=h()/i)&&1!==f&&--g)}return c&&(k=+k||+i||0,e=c[1]?k+(c[1]+1)*c[2]:+c[2],d&&(d.unit=j,d.start=k,d.end=e)),e}var X=/^(?:checkbox|radio)$/i,Y=/<([\w:-]+)/,Z=/^$|\/(?:java|ecma)script/i,$={option:[1,"<select multiple='multiple'>","</select>"],thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};$.optgroup=$.option,$.tbody=$.tfoot=$.colgroup=$.caption=$.thead,$.th=$.td;function _(a,b){var c="undefined"!=typeof a.getElementsByTagName?a.getElementsByTagName(b||"*"):"undefined"!=typeof a.querySelectorAll?a.querySelectorAll(b||"*"):[];return void 0===b||b&&n.nodeName(a,b)?n.merge([a],c):c}function aa(a,b){for(var c=0,d=a.length;d>c;c++)N.set(a[c],"globalEval",!b||N.get(b[c],"globalEval"))}var ba=/<|&#?\w+;/;function ca(a,b,c,d,e){for(var f,g,h,i,j,k,l=b.createDocumentFragment(),m=[],o=0,p=a.length;p>o;o++)if(f=a[o],f||0===f)if("object"===n.type(f))n.merge(m,f.nodeType?[f]:f);else if(ba.test(f)){g=g||l.appendChild(b.createElement("div")),h=(Y.exec(f)||["",""])[1].toLowerCase(),i=$[h]||$._default,g.innerHTML=i[1]+n.htmlPrefilter(f)+i[2],k=i[0];while(k--)g=g.lastChild;n.merge(m,g.childNodes),g=l.firstChild,g.textContent=""}else m.push(b.createTextNode(f));l.textContent="",o=0;while(f=m[o++])if(d&&n.inArray(f,d)>-1)e&&e.push(f);else if(j=n.contains(f.ownerDocument,f),g=_(l.appendChild(f),"script"),j&&aa(g),c){k=0;while(f=g[k++])Z.test(f.type||"")&&c.push(f)}return l}!function(){var a=d.createDocumentFragment(),b=a.appendChild(d.createElement("div")),c=d.createElement("input");c.setAttribute("type","radio"),c.setAttribute("checked","checked"),c.setAttribute("name","t"),b.appendChild(c),l.checkClone=b.cloneNode(!0).cloneNode(!0).lastChild.checked,b.innerHTML="<textarea>x</textarea>",l.noCloneChecked=!!b.cloneNode(!0).lastChild.defaultValue}();var da=/^key/,ea=/^(?:mouse|pointer|contextmenu|drag|drop)|click/,fa=/^([^.]*)(?:\.(.+)|)/;function ga(){return!0}function ha(){return!1}function ia(){try{return d.activeElement}catch(a){}}function ja(a,b,c,d,e,f){var g,h;if("object"==typeof b){"string"!=typeof c&&(d=d||c,c=void 0);for(h in b)ja(a,h,c,d,b[h],f);return a}if(null==d&&null==e?(e=c,d=c=void 0):null==e&&("string"==typeof c?(e=d,d=void 0):(e=d,d=c,c=void 0)),e===!1)e=ha;else if(!e)return a;return 1===f&&(g=e,e=function(a){return n().off(a),g.apply(this,arguments)},e.guid=g.guid||(g.guid=n.guid++)),a.each(function(){n.event.add(this,b,e,d,c)})}n.event={global:{},add:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,o,p,q,r=N.get(a);if(r){c.handler&&(f=c,c=f.handler,e=f.selector),c.guid||(c.guid=n.guid++),(i=r.events)||(i=r.events={}),(g=r.handle)||(g=r.handle=function(b){return"undefined"!=typeof n&&n.event.triggered!==b.type?n.event.dispatch.apply(a,arguments):void 0}),b=(b||"").match(G)||[""],j=b.length;while(j--)h=fa.exec(b[j])||[],o=q=h[1],p=(h[2]||"").split(".").sort(),o&&(l=n.event.special[o]||{},o=(e?l.delegateType:l.bindType)||o,l=n.event.special[o]||{},k=n.extend({type:o,origType:q,data:d,handler:c,guid:c.guid,selector:e,needsContext:e&&n.expr.match.needsContext.test(e),namespace:p.join(".")},f),(m=i[o])||(m=i[o]=[],m.delegateCount=0,l.setup&&l.setup.call(a,d,p,g)!==!1||a.addEventListener&&a.addEventListener(o,g)),l.add&&(l.add.call(a,k),k.handler.guid||(k.handler.guid=c.guid)),e?m.splice(m.delegateCount++,0,k):m.push(k),n.event.global[o]=!0)}},remove:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,o,p,q,r=N.hasData(a)&&N.get(a);if(r&&(i=r.events)){b=(b||"").match(G)||[""],j=b.length;while(j--)if(h=fa.exec(b[j])||[],o=q=h[1],p=(h[2]||"").split(".").sort(),o){l=n.event.special[o]||{},o=(d?l.delegateType:l.bindType)||o,m=i[o]||[],h=h[2]&&new RegExp("(^|\\.)"+p.join("\\.(?:.*\\.|)")+"(\\.|$)"),g=f=m.length;while(f--)k=m[f],!e&&q!==k.origType||c&&c.guid!==k.guid||h&&!h.test(k.namespace)||d&&d!==k.selector&&("**"!==d||!k.selector)||(m.splice(f,1),k.selector&&m.delegateCount--,l.remove&&l.remove.call(a,k));g&&!m.length&&(l.teardown&&l.teardown.call(a,p,r.handle)!==!1||n.removeEvent(a,o,r.handle),delete i[o])}else for(o in i)n.event.remove(a,o+b[j],c,d,!0);n.isEmptyObject(i)&&N.remove(a,"handle events")}},dispatch:function(a){a=n.event.fix(a);var b,c,d,f,g,h=[],i=e.call(arguments),j=(N.get(this,"events")||{})[a.type]||[],k=n.event.special[a.type]||{};if(i[0]=a,a.delegateTarget=this,!k.preDispatch||k.preDispatch.call(this,a)!==!1){h=n.event.handlers.call(this,a,j),b=0;while((f=h[b++])&&!a.isPropagationStopped()){a.currentTarget=f.elem,c=0;while((g=f.handlers[c++])&&!a.isImmediatePropagationStopped())(!a.rnamespace||a.rnamespace.test(g.namespace))&&(a.handleObj=g,a.data=g.data,d=((n.event.special[g.origType]||{}).handle||g.handler).apply(f.elem,i),void 0!==d&&(a.result=d)===!1&&(a.preventDefault(),a.stopPropagation()))}return k.postDispatch&&k.postDispatch.call(this,a),a.result}},handlers:function(a,b){var c,d,e,f,g=[],h=b.delegateCount,i=a.target;if(h&&i.nodeType&&("click"!==a.type||isNaN(a.button)||a.button<1))for(;i!==this;i=i.parentNode||this)if(1===i.nodeType&&(i.disabled!==!0||"click"!==a.type)){for(d=[],c=0;h>c;c++)f=b[c],e=f.selector+" ",void 0===d[e]&&(d[e]=f.needsContext?n(e,this).index(i)>-1:n.find(e,this,null,[i]).length),d[e]&&d.push(f);d.length&&g.push({elem:i,handlers:d})}return h<b.length&&g.push({elem:this,handlers:b.slice(h)}),g},props:"altKey bubbles cancelable ctrlKey currentTarget detail eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(a,b){return null==a.which&&(a.which=null!=b.charCode?b.charCode:b.keyCode),a}},mouseHooks:{props:"button buttons clientX clientY offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(a,b){var c,e,f,g=b.button;return null==a.pageX&&null!=b.clientX&&(c=a.target.ownerDocument||d,e=c.documentElement,f=c.body,a.pageX=b.clientX+(e&&e.scrollLeft||f&&f.scrollLeft||0)-(e&&e.clientLeft||f&&f.clientLeft||0),a.pageY=b.clientY+(e&&e.scrollTop||f&&f.scrollTop||0)-(e&&e.clientTop||f&&f.clientTop||0)),a.which||void 0===g||(a.which=1&g?1:2&g?3:4&g?2:0),a}},fix:function(a){if(a[n.expando])return a;var b,c,e,f=a.type,g=a,h=this.fixHooks[f];h||(this.fixHooks[f]=h=ea.test(f)?this.mouseHooks:da.test(f)?this.keyHooks:{}),e=h.props?this.props.concat(h.props):this.props,a=new n.Event(g),b=e.length;while(b--)c=e[b],a[c]=g[c];return a.target||(a.target=d),3===a.target.nodeType&&(a.target=a.target.parentNode),h.filter?h.filter(a,g):a},special:{load:{noBubble:!0},focus:{trigger:function(){return this!==ia()&&this.focus?(this.focus(),!1):void 0},delegateType:"focusin"},blur:{trigger:function(){return this===ia()&&this.blur?(this.blur(),!1):void 0},delegateType:"focusout"},click:{trigger:function(){return"checkbox"===this.type&&this.click&&n.nodeName(this,"input")?(this.click(),!1):void 0},_default:function(a){return n.nodeName(a.target,"a")}},beforeunload:{postDispatch:function(a){void 0!==a.result&&a.originalEvent&&(a.originalEvent.returnValue=a.result)}}}},n.removeEvent=function(a,b,c){a.removeEventListener&&a.removeEventListener(b,c)},n.Event=function(a,b){return this instanceof n.Event?(a&&a.type?(this.originalEvent=a,this.type=a.type,this.isDefaultPrevented=a.defaultPrevented||void 0===a.defaultPrevented&&a.returnValue===!1?ga:ha):this.type=a,b&&n.extend(this,b),this.timeStamp=a&&a.timeStamp||n.now(),void(this[n.expando]=!0)):new n.Event(a,b)},n.Event.prototype={constructor:n.Event,isDefaultPrevented:ha,isPropagationStopped:ha,isImmediatePropagationStopped:ha,preventDefault:function(){var a=this.originalEvent;this.isDefaultPrevented=ga,a&&a.preventDefault()},stopPropagation:function(){var a=this.originalEvent;this.isPropagationStopped=ga,a&&a.stopPropagation()},stopImmediatePropagation:function(){var a=this.originalEvent;this.isImmediatePropagationStopped=ga,a&&a.stopImmediatePropagation(),this.stopPropagation()}},n.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(a,b){n.event.special[a]={delegateType:b,bindType:b,handle:function(a){var c,d=this,e=a.relatedTarget,f=a.handleObj;return(!e||e!==d&&!n.contains(d,e))&&(a.type=f.origType,c=f.handler.apply(this,arguments),a.type=b),c}}}),n.fn.extend({on:function(a,b,c,d){return ja(this,a,b,c,d)},one:function(a,b,c,d){return ja(this,a,b,c,d,1)},off:function(a,b,c){var d,e;if(a&&a.preventDefault&&a.handleObj)return d=a.handleObj,n(a.delegateTarget).off(d.namespace?d.origType+"."+d.namespace:d.origType,d.selector,d.handler),this;if("object"==typeof a){for(e in a)this.off(e,b,a[e]);return this}return(b===!1||"function"==typeof b)&&(c=b,b=void 0),c===!1&&(c=ha),this.each(function(){n.event.remove(this,a,c,b)})}});var ka=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:-]+)[^>]*)\/>/gi,la=/<script|<style|<link/i,ma=/checked\s*(?:[^=]|=\s*.checked.)/i,na=/^true\/(.*)/,oa=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g;function pa(a,b){return n.nodeName(a,"table")&&n.nodeName(11!==b.nodeType?b:b.firstChild,"tr")?a.getElementsByTagName("tbody")[0]||a.appendChild(a.ownerDocument.createElement("tbody")):a}function qa(a){return a.type=(null!==a.getAttribute("type"))+"/"+a.type,a}function ra(a){var b=na.exec(a.type);return b?a.type=b[1]:a.removeAttribute("type"),a}function sa(a,b){var c,d,e,f,g,h,i,j;if(1===b.nodeType){if(N.hasData(a)&&(f=N.access(a),g=N.set(b,f),j=f.events)){delete g.handle,g.events={};for(e in j)for(c=0,d=j[e].length;d>c;c++)n.event.add(b,e,j[e][c])}O.hasData(a)&&(h=O.access(a),i=n.extend({},h),O.set(b,i))}}function ta(a,b){var c=b.nodeName.toLowerCase();"input"===c&&X.test(a.type)?b.checked=a.checked:("input"===c||"textarea"===c)&&(b.defaultValue=a.defaultValue)}function ua(a,b,c,d){b=f.apply([],b);var e,g,h,i,j,k,m=0,o=a.length,p=o-1,q=b[0],r=n.isFunction(q);if(r||o>1&&"string"==typeof q&&!l.checkClone&&ma.test(q))return a.each(function(e){var f=a.eq(e);r&&(b[0]=q.call(this,e,f.html())),ua(f,b,c,d)});if(o&&(e=ca(b,a[0].ownerDocument,!1,a,d),g=e.firstChild,1===e.childNodes.length&&(e=g),g||d)){for(h=n.map(_(e,"script"),qa),i=h.length;o>m;m++)j=e,m!==p&&(j=n.clone(j,!0,!0),i&&n.merge(h,_(j,"script"))),c.call(a[m],j,m);if(i)for(k=h[h.length-1].ownerDocument,n.map(h,ra),m=0;i>m;m++)j=h[m],Z.test(j.type||"")&&!N.access(j,"globalEval")&&n.contains(k,j)&&(j.src?n._evalUrl&&n._evalUrl(j.src):n.globalEval(j.textContent.replace(oa,"")))}return a}function va(a,b,c){for(var d,e=b?n.filter(b,a):a,f=0;null!=(d=e[f]);f++)c||1!==d.nodeType||n.cleanData(_(d)),d.parentNode&&(c&&n.contains(d.ownerDocument,d)&&aa(_(d,"script")),d.parentNode.removeChild(d));return a}n.extend({htmlPrefilter:function(a){return a.replace(ka,"<$1></$2>")},clone:function(a,b,c){var d,e,f,g,h=a.cloneNode(!0),i=n.contains(a.ownerDocument,a);if(!(l.noCloneChecked||1!==a.nodeType&&11!==a.nodeType||n.isXMLDoc(a)))for(g=_(h),f=_(a),d=0,e=f.length;e>d;d++)ta(f[d],g[d]);if(b)if(c)for(f=f||_(a),g=g||_(h),d=0,e=f.length;e>d;d++)sa(f[d],g[d]);else sa(a,h);return g=_(h,"script"),g.length>0&&aa(g,!i&&_(a,"script")),h},cleanData:function(a){for(var b,c,d,e=n.event.special,f=0;void 0!==(c=a[f]);f++)if(L(c)){if(b=c[N.expando]){if(b.events)for(d in b.events)e[d]?n.event.remove(c,d):n.removeEvent(c,d,b.handle);c[N.expando]=void 0}c[O.expando]&&(c[O.expando]=void 0)}}}),n.fn.extend({domManip:ua,detach:function(a){return va(this,a,!0)},remove:function(a){return va(this,a)},text:function(a){return K(this,function(a){return void 0===a?n.text(this):this.empty().each(function(){(1===this.nodeType||11===this.nodeType||9===this.nodeType)&&(this.textContent=a)})},null,a,arguments.length)},append:function(){return ua(this,arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=pa(this,a);b.appendChild(a)}})},prepend:function(){return ua(this,arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=pa(this,a);b.insertBefore(a,b.firstChild)}})},before:function(){return ua(this,arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this)})},after:function(){return ua(this,arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this.nextSibling)})},empty:function(){for(var a,b=0;null!=(a=this[b]);b++)1===a.nodeType&&(n.cleanData(_(a,!1)),a.textContent="");return this},clone:function(a,b){return a=null==a?!1:a,b=null==b?a:b,this.map(function(){return n.clone(this,a,b)})},html:function(a){return K(this,function(a){var b=this[0]||{},c=0,d=this.length;if(void 0===a&&1===b.nodeType)return b.innerHTML;if("string"==typeof a&&!la.test(a)&&!$[(Y.exec(a)||["",""])[1].toLowerCase()]){a=n.htmlPrefilter(a);try{for(;d>c;c++)b=this[c]||{},1===b.nodeType&&(n.cleanData(_(b,!1)),b.innerHTML=a);b=0}catch(e){}}b&&this.empty().append(a)},null,a,arguments.length)},replaceWith:function(){var a=[];return ua(this,arguments,function(b){var c=this.parentNode;n.inArray(this,a)<0&&(n.cleanData(_(this)),c&&c.replaceChild(b,this))},a)}}),n.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(a,b){n.fn[a]=function(a){for(var c,d=[],e=n(a),f=e.length-1,h=0;f>=h;h++)c=h===f?this:this.clone(!0),n(e[h])[b](c),g.apply(d,c.get());return this.pushStack(d)}});var wa,xa={HTML:"block",BODY:"block"};function ya(a,b){var c=n(b.createElement(a)).appendTo(b.body),d=n.css(c[0],"display");return c.detach(),d}function za(a){var b=d,c=xa[a];return c||(c=ya(a,b),"none"!==c&&c||(wa=(wa||n("<iframe frameborder='0' width='0' height='0'/>")).appendTo(b.documentElement),b=wa[0].contentDocument,b.write(),b.close(),c=ya(a,b),wa.detach()),xa[a]=c),c}var Aa=/^margin/,Ba=new RegExp("^("+S+")(?!px)[a-z%]+$","i"),Ca=function(b){var c=b.ownerDocument.defaultView;return c&&c.opener||(c=a),c.getComputedStyle(b)},Da=function(a,b,c,d){var e,f,g={};for(f in b)g[f]=a.style[f],a.style[f]=b[f];e=c.apply(a,d||[]);for(f in b)a.style[f]=g[f];return e},Ea=d.documentElement;!function(){var b,c,e,f,g=d.createElement("div"),h=d.createElement("div");if(h.style){h.style.backgroundClip="content-box",h.cloneNode(!0).style.backgroundClip="",l.clearCloneStyle="content-box"===h.style.backgroundClip,g.style.cssText="border:0;width:8px;height:0;top:0;left:-9999px;padding:0;margin-top:1px;position:absolute",g.appendChild(h);function i(){h.style.cssText="-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;position:relative;display:block;margin:auto;border:1px;padding:1px;top:1%;width:50%",h.innerHTML="",Ea.appendChild(g);var d=a.getComputedStyle(h);b="1%"!==d.top,f="2px"===d.marginLeft,c="4px"===d.width,h.style.marginRight="50%",e="4px"===d.marginRight,Ea.removeChild(g)}n.extend(l,{pixelPosition:function(){return i(),b},boxSizingReliable:function(){return null==c&&i(),c},pixelMarginRight:function(){return null==c&&i(),e},reliableMarginLeft:function(){return null==c&&i(),f},reliableMarginRight:function(){var b,c=h.appendChild(d.createElement("div"));return c.style.cssText=h.style.cssText="-webkit-box-sizing:content-box;box-sizing:content-box;display:block;margin:0;border:0;padding:0",c.style.marginRight=c.style.width="0",h.style.width="1px",Ea.appendChild(g),b=!parseFloat(a.getComputedStyle(c).marginRight),Ea.removeChild(g),h.removeChild(c),b}})}}();function Fa(a,b,c){var d,e,f,g,h=a.style;return c=c||Ca(a),g=c?c.getPropertyValue(b)||c[b]:void 0,""!==g&&void 0!==g||n.contains(a.ownerDocument,a)||(g=n.style(a,b)),c&&!l.pixelMarginRight()&&Ba.test(g)&&Aa.test(b)&&(d=h.width,e=h.minWidth,f=h.maxWidth,h.minWidth=h.maxWidth=h.width=g,g=c.width,h.width=d,h.minWidth=e,h.maxWidth=f),void 0!==g?g+"":g}function Ga(a,b){return{get:function(){return a()?void delete this.get:(this.get=b).apply(this,arguments)}}}var Ha=/^(none|table(?!-c[ea]).+)/,Ia={position:"absolute",visibility:"hidden",display:"block"},Ja={letterSpacing:"0",fontWeight:"400"},Ka=["Webkit","O","Moz","ms"],La=d.createElement("div").style;function Ma(a){if(a in La)return a;var b=a[0].toUpperCase()+a.slice(1),c=Ka.length;while(c--)if(a=Ka[c]+b,a in La)return a}function Na(a,b,c){var d=T.exec(b);return d?Math.max(0,d[2]-(c||0))+(d[3]||"px"):b}function Oa(a,b,c,d,e){for(var f=c===(d?"border":"content")?4:"width"===b?1:0,g=0;4>f;f+=2)"margin"===c&&(g+=n.css(a,c+U[f],!0,e)),d?("content"===c&&(g-=n.css(a,"padding"+U[f],!0,e)),"margin"!==c&&(g-=n.css(a,"border"+U[f]+"Width",!0,e))):(g+=n.css(a,"padding"+U[f],!0,e),"padding"!==c&&(g+=n.css(a,"border"+U[f]+"Width",!0,e)));return g}function Pa(b,c,e){var f=!0,g="width"===c?b.offsetWidth:b.offsetHeight,h=Ca(b),i="border-box"===n.css(b,"boxSizing",!1,h);if(d.msFullscreenElement&&a.top!==a&&b.getClientRects().length&&(g=Math.round(100*b.getBoundingClientRect()[c])),0>=g||null==g){if(g=Fa(b,c,h),(0>g||null==g)&&(g=b.style[c]),Ba.test(g))return g;f=i&&(l.boxSizingReliable()||g===b.style[c]),g=parseFloat(g)||0}return g+Oa(b,c,e||(i?"border":"content"),f,h)+"px"}function Qa(a,b){for(var c,d,e,f=[],g=0,h=a.length;h>g;g++)d=a[g],d.style&&(f[g]=N.get(d,"olddisplay"),c=d.style.display,b?(f[g]||"none"!==c||(d.style.display=""),""===d.style.display&&V(d)&&(f[g]=N.access(d,"olddisplay",za(d.nodeName)))):(e=V(d),"none"===c&&e||N.set(d,"olddisplay",e?c:n.css(d,"display"))));for(g=0;h>g;g++)d=a[g],d.style&&(b&&"none"!==d.style.display&&""!==d.style.display||(d.style.display=b?f[g]||"":"none"));return a}n.extend({cssHooks:{opacity:{get:function(a,b){if(b){var c=Fa(a,"opacity");return""===c?"1":c}}}},cssNumber:{animationIterationCount:!0,columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":"cssFloat"},style:function(a,b,c,d){if(a&&3!==a.nodeType&&8!==a.nodeType&&a.style){var e,f,g,h=n.camelCase(b),i=a.style;return b=n.cssProps[h]||(n.cssProps[h]=Ma(h)||h),g=n.cssHooks[b]||n.cssHooks[h],void 0===c?g&&"get"in g&&void 0!==(e=g.get(a,!1,d))?e:i[b]:(f=typeof c,"string"===f&&(e=T.exec(c))&&e[1]&&(c=W(a,b,e),f="number"),null!=c&&c===c&&("number"===f&&(c+=e&&e[3]||(n.cssNumber[h]?"":"px")),l.clearCloneStyle||""!==c||0!==b.indexOf("background")||(i[b]="inherit"),g&&"set"in g&&void 0===(c=g.set(a,c,d))||(i[b]=c)),void 0)}},css:function(a,b,c,d){var e,f,g,h=n.camelCase(b);return b=n.cssProps[h]||(n.cssProps[h]=Ma(h)||h),g=n.cssHooks[b]||n.cssHooks[h],g&&"get"in g&&(e=g.get(a,!0,c)),void 0===e&&(e=Fa(a,b,d)),"normal"===e&&b in Ja&&(e=Ja[b]),""===c||c?(f=parseFloat(e),c===!0||isFinite(f)?f||0:e):e}}),n.each(["height","width"],function(a,b){n.cssHooks[b]={get:function(a,c,d){return c?Ha.test(n.css(a,"display"))&&0===a.offsetWidth?Da(a,Ia,function(){return Pa(a,b,d)}):Pa(a,b,d):void 0},set:function(a,c,d){var e,f=d&&Ca(a),g=d&&Oa(a,b,d,"border-box"===n.css(a,"boxSizing",!1,f),f);return g&&(e=T.exec(c))&&"px"!==(e[3]||"px")&&(a.style[b]=c,c=n.css(a,b)),Na(a,c,g)}}}),n.cssHooks.marginLeft=Ga(l.reliableMarginLeft,function(a,b){return b?(parseFloat(Fa(a,"marginLeft"))||a.getBoundingClientRect().left-Da(a,{marginLeft:0},function(){return a.getBoundingClientRect().left}))+"px":void 0}),n.cssHooks.marginRight=Ga(l.reliableMarginRight,function(a,b){return b?Da(a,{display:"inline-block"},Fa,[a,"marginRight"]):void 0}),n.each({margin:"",padding:"",border:"Width"},function(a,b){n.cssHooks[a+b]={expand:function(c){for(var d=0,e={},f="string"==typeof c?c.split(" "):[c];4>d;d++)e[a+U[d]+b]=f[d]||f[d-2]||f[0];return e}},Aa.test(a)||(n.cssHooks[a+b].set=Na)}),n.fn.extend({css:function(a,b){return K(this,function(a,b,c){var d,e,f={},g=0;if(n.isArray(b)){for(d=Ca(a),e=b.length;e>g;g++)f[b[g]]=n.css(a,b[g],!1,d);return f}return void 0!==c?n.style(a,b,c):n.css(a,b)},a,b,arguments.length>1)},show:function(){return Qa(this,!0)},hide:function(){return Qa(this)},toggle:function(a){return"boolean"==typeof a?a?this.show():this.hide():this.each(function(){V(this)?n(this).show():n(this).hide()})}});function Ra(a,b,c,d,e){return new Ra.prototype.init(a,b,c,d,e)}n.Tween=Ra,Ra.prototype={constructor:Ra,init:function(a,b,c,d,e,f){this.elem=a,this.prop=c,this.easing=e||n.easing._default,this.options=b,this.start=this.now=this.cur(),this.end=d,this.unit=f||(n.cssNumber[c]?"":"px")},cur:function(){var a=Ra.propHooks[this.prop];return a&&a.get?a.get(this):Ra.propHooks._default.get(this)},run:function(a){var b,c=Ra.propHooks[this.prop];return this.options.duration?this.pos=b=n.easing[this.easing](a,this.options.duration*a,0,1,this.options.duration):this.pos=b=a,this.now=(this.end-this.start)*b+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),c&&c.set?c.set(this):Ra.propHooks._default.set(this),this}},Ra.prototype.init.prototype=Ra.prototype,Ra.propHooks={_default:{get:function(a){var b;return 1!==a.elem.nodeType||null!=a.elem[a.prop]&&null==a.elem.style[a.prop]?a.elem[a.prop]:(b=n.css(a.elem,a.prop,""),b&&"auto"!==b?b:0)},set:function(a){n.fx.step[a.prop]?n.fx.step[a.prop](a):1!==a.elem.nodeType||null==a.elem.style[n.cssProps[a.prop]]&&!n.cssHooks[a.prop]?a.elem[a.prop]=a.now:n.style(a.elem,a.prop,a.now+a.unit)}}},Ra.propHooks.scrollTop=Ra.propHooks.scrollLeft={set:function(a){a.elem.nodeType&&a.elem.parentNode&&(a.elem[a.prop]=a.now)}},n.easing={linear:function(a){return a},swing:function(a){return.5-Math.cos(a*Math.PI)/2},_default:"swing"},n.fx=Ra.prototype.init,n.fx.step={};var Sa,Ta,Ua=/^(?:toggle|show|hide)$/,Va=/queueHooks$/;function Wa(){return a.setTimeout(function(){Sa=void 0}),Sa=n.now()}function Xa(a,b){var c,d=0,e={height:a};for(b=b?1:0;4>d;d+=2-b)c=U[d],e["margin"+c]=e["padding"+c]=a;return b&&(e.opacity=e.width=a),e}function Ya(a,b,c){for(var d,e=(_a.tweeners[b]||[]).concat(_a.tweeners["*"]),f=0,g=e.length;g>f;f++)if(d=e[f].call(c,b,a))return d}function Za(a,b,c){var d,e,f,g,h,i,j,k,l=this,m={},o=a.style,p=a.nodeType&&V(a),q=N.get(a,"fxshow");c.queue||(h=n._queueHooks(a,"fx"),null==h.unqueued&&(h.unqueued=0,i=h.empty.fire,h.empty.fire=function(){h.unqueued||i()}),h.unqueued++,l.always(function(){l.always(function(){h.unqueued--,n.queue(a,"fx").length||h.empty.fire()})})),1===a.nodeType&&("height"in b||"width"in b)&&(c.overflow=[o.overflow,o.overflowX,o.overflowY],j=n.css(a,"display"),k="none"===j?N.get(a,"olddisplay")||za(a.nodeName):j,"inline"===k&&"none"===n.css(a,"float")&&(o.display="inline-block")),c.overflow&&(o.overflow="hidden",l.always(function(){o.overflow=c.overflow[0],o.overflowX=c.overflow[1],o.overflowY=c.overflow[2]}));for(d in b)if(e=b[d],Ua.exec(e)){if(delete b[d],f=f||"toggle"===e,e===(p?"hide":"show")){if("show"!==e||!q||void 0===q[d])continue;p=!0}m[d]=q&&q[d]||n.style(a,d)}else j=void 0;if(n.isEmptyObject(m))"inline"===("none"===j?za(a.nodeName):j)&&(o.display=j);else{q?"hidden"in q&&(p=q.hidden):q=N.access(a,"fxshow",{}),f&&(q.hidden=!p),p?n(a).show():l.done(function(){n(a).hide()}),l.done(function(){var b;N.remove(a,"fxshow");for(b in m)n.style(a,b,m[b])});for(d in m)g=Ya(p?q[d]:0,d,l),d in q||(q[d]=g.start,p&&(g.end=g.start,g.start="width"===d||"height"===d?1:0))}}function $a(a,b){var c,d,e,f,g;for(c in a)if(d=n.camelCase(c),e=b[d],f=a[c],n.isArray(f)&&(e=f[1],f=a[c]=f[0]),c!==d&&(a[d]=f,delete a[c]),g=n.cssHooks[d],g&&"expand"in g){f=g.expand(f),delete a[d];for(c in f)c in a||(a[c]=f[c],b[c]=e)}else b[d]=e}function _a(a,b,c){var d,e,f=0,g=_a.prefilters.length,h=n.Deferred().always(function(){delete i.elem}),i=function(){if(e)return!1;for(var b=Sa||Wa(),c=Math.max(0,j.startTime+j.duration-b),d=c/j.duration||0,f=1-d,g=0,i=j.tweens.length;i>g;g++)j.tweens[g].run(f);return h.notifyWith(a,[j,f,c]),1>f&&i?c:(h.resolveWith(a,[j]),!1)},j=h.promise({elem:a,props:n.extend({},b),opts:n.extend(!0,{specialEasing:{},easing:n.easing._default},c),originalProperties:b,originalOptions:c,startTime:Sa||Wa(),duration:c.duration,tweens:[],createTween:function(b,c){var d=n.Tween(a,j.opts,b,c,j.opts.specialEasing[b]||j.opts.easing);return j.tweens.push(d),d},stop:function(b){var c=0,d=b?j.tweens.length:0;if(e)return this;for(e=!0;d>c;c++)j.tweens[c].run(1);return b?(h.notifyWith(a,[j,1,0]),h.resolveWith(a,[j,b])):h.rejectWith(a,[j,b]),this}}),k=j.props;for($a(k,j.opts.specialEasing);g>f;f++)if(d=_a.prefilters[f].call(j,a,k,j.opts))return n.isFunction(d.stop)&&(n._queueHooks(j.elem,j.opts.queue).stop=n.proxy(d.stop,d)),d;return n.map(k,Ya,j),n.isFunction(j.opts.start)&&j.opts.start.call(a,j),n.fx.timer(n.extend(i,{elem:a,anim:j,queue:j.opts.queue})),j.progress(j.opts.progress).done(j.opts.done,j.opts.complete).fail(j.opts.fail).always(j.opts.always)}n.Animation=n.extend(_a,{tweeners:{"*":[function(a,b){var c=this.createTween(a,b);return W(c.elem,a,T.exec(b),c),c}]},tweener:function(a,b){n.isFunction(a)?(b=a,a=["*"]):a=a.match(G);for(var c,d=0,e=a.length;e>d;d++)c=a[d],_a.tweeners[c]=_a.tweeners[c]||[],_a.tweeners[c].unshift(b)},prefilters:[Za],prefilter:function(a,b){b?_a.prefilters.unshift(a):_a.prefilters.push(a)}}),n.speed=function(a,b,c){var d=a&&"object"==typeof a?n.extend({},a):{complete:c||!c&&b||n.isFunction(a)&&a,duration:a,easing:c&&b||b&&!n.isFunction(b)&&b};return d.duration=n.fx.off?0:"number"==typeof d.duration?d.duration:d.duration in n.fx.speeds?n.fx.speeds[d.duration]:n.fx.speeds._default,(null==d.queue||d.queue===!0)&&(d.queue="fx"),d.old=d.complete,d.complete=function(){n.isFunction(d.old)&&d.old.call(this),d.queue&&n.dequeue(this,d.queue)},d},n.fn.extend({fadeTo:function(a,b,c,d){return this.filter(V).css("opacity",0).show().end().animate({opacity:b},a,c,d)},animate:function(a,b,c,d){var e=n.isEmptyObject(a),f=n.speed(b,c,d),g=function(){var b=_a(this,n.extend({},a),f);(e||N.get(this,"finish"))&&b.stop(!0)};return g.finish=g,e||f.queue===!1?this.each(g):this.queue(f.queue,g)},stop:function(a,b,c){var d=function(a){var b=a.stop;delete a.stop,b(c)};return"string"!=typeof a&&(c=b,b=a,a=void 0),b&&a!==!1&&this.queue(a||"fx",[]),this.each(function(){var b=!0,e=null!=a&&a+"queueHooks",f=n.timers,g=N.get(this);if(e)g[e]&&g[e].stop&&d(g[e]);else for(e in g)g[e]&&g[e].stop&&Va.test(e)&&d(g[e]);for(e=f.length;e--;)f[e].elem!==this||null!=a&&f[e].queue!==a||(f[e].anim.stop(c),b=!1,f.splice(e,1));(b||!c)&&n.dequeue(this,a)})},finish:function(a){return a!==!1&&(a=a||"fx"),this.each(function(){var b,c=N.get(this),d=c[a+"queue"],e=c[a+"queueHooks"],f=n.timers,g=d?d.length:0;for(c.finish=!0,n.queue(this,a,[]),e&&e.stop&&e.stop.call(this,!0),b=f.length;b--;)f[b].elem===this&&f[b].queue===a&&(f[b].anim.stop(!0),f.splice(b,1));for(b=0;g>b;b++)d[b]&&d[b].finish&&d[b].finish.call(this);delete c.finish})}}),n.each(["toggle","show","hide"],function(a,b){var c=n.fn[b];n.fn[b]=function(a,d,e){return null==a||"boolean"==typeof a?c.apply(this,arguments):this.animate(Xa(b,!0),a,d,e)}}),n.each({slideDown:Xa("show"),slideUp:Xa("hide"),slideToggle:Xa("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(a,b){n.fn[a]=function(a,c,d){return this.animate(b,a,c,d)}}),n.timers=[],n.fx.tick=function(){var a,b=0,c=n.timers;for(Sa=n.now();b<c.length;b++)a=c[b],a()||c[b]!==a||c.splice(b--,1);c.length||n.fx.stop(),Sa=void 0},n.fx.timer=function(a){n.timers.push(a),a()?n.fx.start():n.timers.pop()},n.fx.interval=13,n.fx.start=function(){Ta||(Ta=a.setInterval(n.fx.tick,n.fx.interval))},n.fx.stop=function(){a.clearInterval(Ta),Ta=null},n.fx.speeds={slow:600,fast:200,_default:400},n.fn.delay=function(b,c){return b=n.fx?n.fx.speeds[b]||b:b,c=c||"fx",this.queue(c,function(c,d){var e=a.setTimeout(c,b);d.stop=function(){a.clearTimeout(e)}})},function(){var a=d.createElement("input"),b=d.createElement("select"),c=b.appendChild(d.createElement("option"));a.type="checkbox",l.checkOn=""!==a.value,l.optSelected=c.selected,b.disabled=!0,l.optDisabled=!c.disabled,a=d.createElement("input"),a.value="t",a.type="radio",l.radioValue="t"===a.value}();var ab,bb=n.expr.attrHandle;n.fn.extend({attr:function(a,b){return K(this,n.attr,a,b,arguments.length>1)},removeAttr:function(a){return this.each(function(){n.removeAttr(this,a)})}}),n.extend({attr:function(a,b,c){var d,e,f=a.nodeType;if(3!==f&&8!==f&&2!==f)return"undefined"==typeof a.getAttribute?n.prop(a,b,c):(1===f&&n.isXMLDoc(a)||(b=b.toLowerCase(),e=n.attrHooks[b]||(n.expr.match.bool.test(b)?ab:void 0)),void 0!==c?null===c?void n.removeAttr(a,b):e&&"set"in e&&void 0!==(d=e.set(a,c,b))?d:(a.setAttribute(b,c+""),c):e&&"get"in e&&null!==(d=e.get(a,b))?d:(d=n.find.attr(a,b),null==d?void 0:d))},attrHooks:{type:{set:function(a,b){if(!l.radioValue&&"radio"===b&&n.nodeName(a,"input")){var c=a.value;return a.setAttribute("type",b),c&&(a.value=c),b}}}},removeAttr:function(a,b){var c,d,e=0,f=b&&b.match(G);if(f&&1===a.nodeType)while(c=f[e++])d=n.propFix[c]||c,n.expr.match.bool.test(c)&&(a[d]=!1),a.removeAttribute(c)}}),ab={set:function(a,b,c){return b===!1?n.removeAttr(a,c):a.setAttribute(c,c),c}},n.each(n.expr.match.bool.source.match(/\w+/g),function(a,b){var c=bb[b]||n.find.attr;bb[b]=function(a,b,d){var e,f;return d||(f=bb[b],bb[b]=e,e=null!=c(a,b,d)?b.toLowerCase():null,bb[b]=f),e}});var cb=/^(?:input|select|textarea|button)$/i,db=/^(?:a|area)$/i;n.fn.extend({prop:function(a,b){return K(this,n.prop,a,b,arguments.length>1)},removeProp:function(a){return this.each(function(){delete this[n.propFix[a]||a]})}}),n.extend({prop:function(a,b,c){var d,e,f=a.nodeType;if(3!==f&&8!==f&&2!==f)return 1===f&&n.isXMLDoc(a)||(b=n.propFix[b]||b,
e=n.propHooks[b]),void 0!==c?e&&"set"in e&&void 0!==(d=e.set(a,c,b))?d:a[b]=c:e&&"get"in e&&null!==(d=e.get(a,b))?d:a[b]},propHooks:{tabIndex:{get:function(a){var b=n.find.attr(a,"tabindex");return b?parseInt(b,10):cb.test(a.nodeName)||db.test(a.nodeName)&&a.href?0:-1}}},propFix:{"for":"htmlFor","class":"className"}}),l.optSelected||(n.propHooks.selected={get:function(a){var b=a.parentNode;return b&&b.parentNode&&b.parentNode.selectedIndex,null}}),n.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){n.propFix[this.toLowerCase()]=this});var eb=/[\t\r\n\f]/g;function fb(a){return a.getAttribute&&a.getAttribute("class")||""}n.fn.extend({addClass:function(a){var b,c,d,e,f,g,h,i=0;if(n.isFunction(a))return this.each(function(b){n(this).addClass(a.call(this,b,fb(this)))});if("string"==typeof a&&a){b=a.match(G)||[];while(c=this[i++])if(e=fb(c),d=1===c.nodeType&&(" "+e+" ").replace(eb," ")){g=0;while(f=b[g++])d.indexOf(" "+f+" ")<0&&(d+=f+" ");h=n.trim(d),e!==h&&c.setAttribute("class",h)}}return this},removeClass:function(a){var b,c,d,e,f,g,h,i=0;if(n.isFunction(a))return this.each(function(b){n(this).removeClass(a.call(this,b,fb(this)))});if(!arguments.length)return this.attr("class","");if("string"==typeof a&&a){b=a.match(G)||[];while(c=this[i++])if(e=fb(c),d=1===c.nodeType&&(" "+e+" ").replace(eb," ")){g=0;while(f=b[g++])while(d.indexOf(" "+f+" ")>-1)d=d.replace(" "+f+" "," ");h=n.trim(d),e!==h&&c.setAttribute("class",h)}}return this},toggleClass:function(a,b){var c=typeof a;return"boolean"==typeof b&&"string"===c?b?this.addClass(a):this.removeClass(a):n.isFunction(a)?this.each(function(c){n(this).toggleClass(a.call(this,c,fb(this),b),b)}):this.each(function(){var b,d,e,f;if("string"===c){d=0,e=n(this),f=a.match(G)||[];while(b=f[d++])e.hasClass(b)?e.removeClass(b):e.addClass(b)}else(void 0===a||"boolean"===c)&&(b=fb(this),b&&N.set(this,"__className__",b),this.setAttribute&&this.setAttribute("class",b||a===!1?"":N.get(this,"__className__")||""))})},hasClass:function(a){var b,c,d=0;b=" "+a+" ";while(c=this[d++])if(1===c.nodeType&&(" "+fb(c)+" ").replace(eb," ").indexOf(b)>-1)return!0;return!1}});var gb=/\r/g;n.fn.extend({val:function(a){var b,c,d,e=this[0];{if(arguments.length)return d=n.isFunction(a),this.each(function(c){var e;1===this.nodeType&&(e=d?a.call(this,c,n(this).val()):a,null==e?e="":"number"==typeof e?e+="":n.isArray(e)&&(e=n.map(e,function(a){return null==a?"":a+""})),b=n.valHooks[this.type]||n.valHooks[this.nodeName.toLowerCase()],b&&"set"in b&&void 0!==b.set(this,e,"value")||(this.value=e))});if(e)return b=n.valHooks[e.type]||n.valHooks[e.nodeName.toLowerCase()],b&&"get"in b&&void 0!==(c=b.get(e,"value"))?c:(c=e.value,"string"==typeof c?c.replace(gb,""):null==c?"":c)}}}),n.extend({valHooks:{option:{get:function(a){return n.trim(a.value)}},select:{get:function(a){for(var b,c,d=a.options,e=a.selectedIndex,f="select-one"===a.type||0>e,g=f?null:[],h=f?e+1:d.length,i=0>e?h:f?e:0;h>i;i++)if(c=d[i],(c.selected||i===e)&&(l.optDisabled?!c.disabled:null===c.getAttribute("disabled"))&&(!c.parentNode.disabled||!n.nodeName(c.parentNode,"optgroup"))){if(b=n(c).val(),f)return b;g.push(b)}return g},set:function(a,b){var c,d,e=a.options,f=n.makeArray(b),g=e.length;while(g--)d=e[g],(d.selected=n.inArray(n.valHooks.option.get(d),f)>-1)&&(c=!0);return c||(a.selectedIndex=-1),f}}}}),n.each(["radio","checkbox"],function(){n.valHooks[this]={set:function(a,b){return n.isArray(b)?a.checked=n.inArray(n(a).val(),b)>-1:void 0}},l.checkOn||(n.valHooks[this].get=function(a){return null===a.getAttribute("value")?"on":a.value})});var hb=/^(?:focusinfocus|focusoutblur)$/;n.extend(n.event,{trigger:function(b,c,e,f){var g,h,i,j,l,m,o,p=[e||d],q=k.call(b,"type")?b.type:b,r=k.call(b,"namespace")?b.namespace.split("."):[];if(h=i=e=e||d,3!==e.nodeType&&8!==e.nodeType&&!hb.test(q+n.event.triggered)&&(q.indexOf(".")>-1&&(r=q.split("."),q=r.shift(),r.sort()),l=q.indexOf(":")<0&&"on"+q,b=b[n.expando]?b:new n.Event(q,"object"==typeof b&&b),b.isTrigger=f?2:3,b.namespace=r.join("."),b.rnamespace=b.namespace?new RegExp("(^|\\.)"+r.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,b.result=void 0,b.target||(b.target=e),c=null==c?[b]:n.makeArray(c,[b]),o=n.event.special[q]||{},f||!o.trigger||o.trigger.apply(e,c)!==!1)){if(!f&&!o.noBubble&&!n.isWindow(e)){for(j=o.delegateType||q,hb.test(j+q)||(h=h.parentNode);h;h=h.parentNode)p.push(h),i=h;i===(e.ownerDocument||d)&&p.push(i.defaultView||i.parentWindow||a)}g=0;while((h=p[g++])&&!b.isPropagationStopped())b.type=g>1?j:o.bindType||q,m=(N.get(h,"events")||{})[b.type]&&N.get(h,"handle"),m&&m.apply(h,c),m=l&&h[l],m&&m.apply&&L(h)&&(b.result=m.apply(h,c),b.result===!1&&b.preventDefault());return b.type=q,f||b.isDefaultPrevented()||o._default&&o._default.apply(p.pop(),c)!==!1||!L(e)||l&&n.isFunction(e[q])&&!n.isWindow(e)&&(i=e[l],i&&(e[l]=null),n.event.triggered=q,e[q](),n.event.triggered=void 0,i&&(e[l]=i)),b.result}},simulate:function(a,b,c){var d=n.extend(new n.Event,c,{type:a,isSimulated:!0});n.event.trigger(d,null,b),d.isDefaultPrevented()&&c.preventDefault()}}),n.fn.extend({trigger:function(a,b){return this.each(function(){n.event.trigger(a,b,this)})},triggerHandler:function(a,b){var c=this[0];return c?n.event.trigger(a,b,c,!0):void 0}}),n.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(a,b){n.fn[b]=function(a,c){return arguments.length>0?this.on(b,null,a,c):this.trigger(b)}}),n.fn.extend({hover:function(a,b){return this.mouseenter(a).mouseleave(b||a)}}),l.focusin="onfocusin"in a,l.focusin||n.each({focus:"focusin",blur:"focusout"},function(a,b){var c=function(a){n.event.simulate(b,a.target,n.event.fix(a))};n.event.special[b]={setup:function(){var d=this.ownerDocument||this,e=N.access(d,b);e||d.addEventListener(a,c,!0),N.access(d,b,(e||0)+1)},teardown:function(){var d=this.ownerDocument||this,e=N.access(d,b)-1;e?N.access(d,b,e):(d.removeEventListener(a,c,!0),N.remove(d,b))}}});var ib=a.location,jb=n.now(),kb=/\?/;n.parseJSON=function(a){return JSON.parse(a+"")},n.parseXML=function(b){var c;if(!b||"string"!=typeof b)return null;try{c=(new a.DOMParser).parseFromString(b,"text/xml")}catch(d){c=void 0}return(!c||c.getElementsByTagName("parsererror").length)&&n.error("Invalid XML: "+b),c};var lb=/#.*$/,mb=/([?&])_=[^&]*/,nb=/^(.*?):[ \t]*([^\r\n]*)$/gm,ob=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,pb=/^(?:GET|HEAD)$/,qb=/^\/\//,rb={},sb={},tb="*/".concat("*"),ub=d.createElement("a");ub.href=ib.href;function vb(a){return function(b,c){"string"!=typeof b&&(c=b,b="*");var d,e=0,f=b.toLowerCase().match(G)||[];if(n.isFunction(c))while(d=f[e++])"+"===d[0]?(d=d.slice(1)||"*",(a[d]=a[d]||[]).unshift(c)):(a[d]=a[d]||[]).push(c)}}function wb(a,b,c,d){var e={},f=a===sb;function g(h){var i;return e[h]=!0,n.each(a[h]||[],function(a,h){var j=h(b,c,d);return"string"!=typeof j||f||e[j]?f?!(i=j):void 0:(b.dataTypes.unshift(j),g(j),!1)}),i}return g(b.dataTypes[0])||!e["*"]&&g("*")}function xb(a,b){var c,d,e=n.ajaxSettings.flatOptions||{};for(c in b)void 0!==b[c]&&((e[c]?a:d||(d={}))[c]=b[c]);return d&&n.extend(!0,a,d),a}function yb(a,b,c){var d,e,f,g,h=a.contents,i=a.dataTypes;while("*"===i[0])i.shift(),void 0===d&&(d=a.mimeType||b.getResponseHeader("Content-Type"));if(d)for(e in h)if(h[e]&&h[e].test(d)){i.unshift(e);break}if(i[0]in c)f=i[0];else{for(e in c){if(!i[0]||a.converters[e+" "+i[0]]){f=e;break}g||(g=e)}f=f||g}return f?(f!==i[0]&&i.unshift(f),c[f]):void 0}function zb(a,b,c,d){var e,f,g,h,i,j={},k=a.dataTypes.slice();if(k[1])for(g in a.converters)j[g.toLowerCase()]=a.converters[g];f=k.shift();while(f)if(a.responseFields[f]&&(c[a.responseFields[f]]=b),!i&&d&&a.dataFilter&&(b=a.dataFilter(b,a.dataType)),i=f,f=k.shift())if("*"===f)f=i;else if("*"!==i&&i!==f){if(g=j[i+" "+f]||j["* "+f],!g)for(e in j)if(h=e.split(" "),h[1]===f&&(g=j[i+" "+h[0]]||j["* "+h[0]])){g===!0?g=j[e]:j[e]!==!0&&(f=h[0],k.unshift(h[1]));break}if(g!==!0)if(g&&a["throws"])b=g(b);else try{b=g(b)}catch(l){return{state:"parsererror",error:g?l:"No conversion from "+i+" to "+f}}}return{state:"success",data:b}}n.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:ib.href,type:"GET",isLocal:ob.test(ib.protocol),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":tb,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/\bxml\b/,html:/\bhtml/,json:/\bjson\b/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":n.parseJSON,"text xml":n.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(a,b){return b?xb(xb(a,n.ajaxSettings),b):xb(n.ajaxSettings,a)},ajaxPrefilter:vb(rb),ajaxTransport:vb(sb),ajax:function(b,c){"object"==typeof b&&(c=b,b=void 0),c=c||{};var e,f,g,h,i,j,k,l,m=n.ajaxSetup({},c),o=m.context||m,p=m.context&&(o.nodeType||o.jquery)?n(o):n.event,q=n.Deferred(),r=n.Callbacks("once memory"),s=m.statusCode||{},t={},u={},v=0,w="canceled",x={readyState:0,getResponseHeader:function(a){var b;if(2===v){if(!h){h={};while(b=nb.exec(g))h[b[1].toLowerCase()]=b[2]}b=h[a.toLowerCase()]}return null==b?null:b},getAllResponseHeaders:function(){return 2===v?g:null},setRequestHeader:function(a,b){var c=a.toLowerCase();return v||(a=u[c]=u[c]||a,t[a]=b),this},overrideMimeType:function(a){return v||(m.mimeType=a),this},statusCode:function(a){var b;if(a)if(2>v)for(b in a)s[b]=[s[b],a[b]];else x.always(a[x.status]);return this},abort:function(a){var b=a||w;return e&&e.abort(b),z(0,b),this}};if(q.promise(x).complete=r.add,x.success=x.done,x.error=x.fail,m.url=((b||m.url||ib.href)+"").replace(lb,"").replace(qb,ib.protocol+"//"),m.type=c.method||c.type||m.method||m.type,m.dataTypes=n.trim(m.dataType||"*").toLowerCase().match(G)||[""],null==m.crossDomain){j=d.createElement("a");try{j.href=m.url,j.href=j.href,m.crossDomain=ub.protocol+"//"+ub.host!=j.protocol+"//"+j.host}catch(y){m.crossDomain=!0}}if(m.data&&m.processData&&"string"!=typeof m.data&&(m.data=n.param(m.data,m.traditional)),wb(rb,m,c,x),2===v)return x;k=n.event&&m.global,k&&0===n.active++&&n.event.trigger("ajaxStart"),m.type=m.type.toUpperCase(),m.hasContent=!pb.test(m.type),f=m.url,m.hasContent||(m.data&&(f=m.url+=(kb.test(f)?"&":"?")+m.data,delete m.data),m.cache===!1&&(m.url=mb.test(f)?f.replace(mb,"$1_="+jb++):f+(kb.test(f)?"&":"?")+"_="+jb++)),m.ifModified&&(n.lastModified[f]&&x.setRequestHeader("If-Modified-Since",n.lastModified[f]),n.etag[f]&&x.setRequestHeader("If-None-Match",n.etag[f])),(m.data&&m.hasContent&&m.contentType!==!1||c.contentType)&&x.setRequestHeader("Content-Type",m.contentType),x.setRequestHeader("Accept",m.dataTypes[0]&&m.accepts[m.dataTypes[0]]?m.accepts[m.dataTypes[0]]+("*"!==m.dataTypes[0]?", "+tb+"; q=0.01":""):m.accepts["*"]);for(l in m.headers)x.setRequestHeader(l,m.headers[l]);if(m.beforeSend&&(m.beforeSend.call(o,x,m)===!1||2===v))return x.abort();w="abort";for(l in{success:1,error:1,complete:1})x[l](m[l]);if(e=wb(sb,m,c,x)){if(x.readyState=1,k&&p.trigger("ajaxSend",[x,m]),2===v)return x;m.async&&m.timeout>0&&(i=a.setTimeout(function(){x.abort("timeout")},m.timeout));try{v=1,e.send(t,z)}catch(y){if(!(2>v))throw y;z(-1,y)}}else z(-1,"No Transport");function z(b,c,d,h){var j,l,t,u,w,y=c;2!==v&&(v=2,i&&a.clearTimeout(i),e=void 0,g=h||"",x.readyState=b>0?4:0,j=b>=200&&300>b||304===b,d&&(u=yb(m,x,d)),u=zb(m,u,x,j),j?(m.ifModified&&(w=x.getResponseHeader("Last-Modified"),w&&(n.lastModified[f]=w),w=x.getResponseHeader("etag"),w&&(n.etag[f]=w)),204===b||"HEAD"===m.type?y="nocontent":304===b?y="notmodified":(y=u.state,l=u.data,t=u.error,j=!t)):(t=y,(b||!y)&&(y="error",0>b&&(b=0))),x.status=b,x.statusText=(c||y)+"",j?q.resolveWith(o,[l,y,x]):q.rejectWith(o,[x,y,t]),x.statusCode(s),s=void 0,k&&p.trigger(j?"ajaxSuccess":"ajaxError",[x,m,j?l:t]),r.fireWith(o,[x,y]),k&&(p.trigger("ajaxComplete",[x,m]),--n.active||n.event.trigger("ajaxStop")))}return x},getJSON:function(a,b,c){return n.get(a,b,c,"json")},getScript:function(a,b){return n.get(a,void 0,b,"script")}}),n.each(["get","post"],function(a,b){n[b]=function(a,c,d,e){return n.isFunction(c)&&(e=e||d,d=c,c=void 0),n.ajax(n.extend({url:a,type:b,dataType:e,data:c,success:d},n.isPlainObject(a)&&a))}}),n._evalUrl=function(a){return n.ajax({url:a,type:"GET",dataType:"script",async:!1,global:!1,"throws":!0})},n.fn.extend({wrapAll:function(a){var b;return n.isFunction(a)?this.each(function(b){n(this).wrapAll(a.call(this,b))}):(this[0]&&(b=n(a,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&b.insertBefore(this[0]),b.map(function(){var a=this;while(a.firstElementChild)a=a.firstElementChild;return a}).append(this)),this)},wrapInner:function(a){return n.isFunction(a)?this.each(function(b){n(this).wrapInner(a.call(this,b))}):this.each(function(){var b=n(this),c=b.contents();c.length?c.wrapAll(a):b.append(a)})},wrap:function(a){var b=n.isFunction(a);return this.each(function(c){n(this).wrapAll(b?a.call(this,c):a)})},unwrap:function(){return this.parent().each(function(){n.nodeName(this,"body")||n(this).replaceWith(this.childNodes)}).end()}}),n.expr.filters.hidden=function(a){return!n.expr.filters.visible(a)},n.expr.filters.visible=function(a){return a.offsetWidth>0||a.offsetHeight>0||a.getClientRects().length>0};var Ab=/%20/g,Bb=/\[\]$/,Cb=/\r?\n/g,Db=/^(?:submit|button|image|reset|file)$/i,Eb=/^(?:input|select|textarea|keygen)/i;function Fb(a,b,c,d){var e;if(n.isArray(b))n.each(b,function(b,e){c||Bb.test(a)?d(a,e):Fb(a+"["+("object"==typeof e&&null!=e?b:"")+"]",e,c,d)});else if(c||"object"!==n.type(b))d(a,b);else for(e in b)Fb(a+"["+e+"]",b[e],c,d)}n.param=function(a,b){var c,d=[],e=function(a,b){b=n.isFunction(b)?b():null==b?"":b,d[d.length]=encodeURIComponent(a)+"="+encodeURIComponent(b)};if(void 0===b&&(b=n.ajaxSettings&&n.ajaxSettings.traditional),n.isArray(a)||a.jquery&&!n.isPlainObject(a))n.each(a,function(){e(this.name,this.value)});else for(c in a)Fb(c,a[c],b,e);return d.join("&").replace(Ab,"+")},n.fn.extend({serialize:function(){return n.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var a=n.prop(this,"elements");return a?n.makeArray(a):this}).filter(function(){var a=this.type;return this.name&&!n(this).is(":disabled")&&Eb.test(this.nodeName)&&!Db.test(a)&&(this.checked||!X.test(a))}).map(function(a,b){var c=n(this).val();return null==c?null:n.isArray(c)?n.map(c,function(a){return{name:b.name,value:a.replace(Cb,"\r\n")}}):{name:b.name,value:c.replace(Cb,"\r\n")}}).get()}}),n.ajaxSettings.xhr=function(){try{return new a.XMLHttpRequest}catch(b){}};var Gb={0:200,1223:204},Hb=n.ajaxSettings.xhr();l.cors=!!Hb&&"withCredentials"in Hb,l.ajax=Hb=!!Hb,n.ajaxTransport(function(b){var c,d;return l.cors||Hb&&!b.crossDomain?{send:function(e,f){var g,h=b.xhr();if(h.open(b.type,b.url,b.async,b.username,b.password),b.xhrFields)for(g in b.xhrFields)h[g]=b.xhrFields[g];b.mimeType&&h.overrideMimeType&&h.overrideMimeType(b.mimeType),b.crossDomain||e["X-Requested-With"]||(e["X-Requested-With"]="XMLHttpRequest");for(g in e)h.setRequestHeader(g,e[g]);c=function(a){return function(){c&&(c=d=h.onload=h.onerror=h.onabort=h.onreadystatechange=null,"abort"===a?h.abort():"error"===a?"number"!=typeof h.status?f(0,"error"):f(h.status,h.statusText):f(Gb[h.status]||h.status,h.statusText,"text"!==(h.responseType||"text")||"string"!=typeof h.responseText?{binary:h.response}:{text:h.responseText},h.getAllResponseHeaders()))}},h.onload=c(),d=h.onerror=c("error"),void 0!==h.onabort?h.onabort=d:h.onreadystatechange=function(){4===h.readyState&&a.setTimeout(function(){c&&d()})},c=c("abort");try{h.send(b.hasContent&&b.data||null)}catch(i){if(c)throw i}},abort:function(){c&&c()}}:void 0}),n.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/\b(?:java|ecma)script\b/},converters:{"text script":function(a){return n.globalEval(a),a}}}),n.ajaxPrefilter("script",function(a){void 0===a.cache&&(a.cache=!1),a.crossDomain&&(a.type="GET")}),n.ajaxTransport("script",function(a){if(a.crossDomain){var b,c;return{send:function(e,f){b=n("<script>").prop({charset:a.scriptCharset,src:a.url}).on("load error",c=function(a){b.remove(),c=null,a&&f("error"===a.type?404:200,a.type)}),d.head.appendChild(b[0])},abort:function(){c&&c()}}}});var Ib=[],Jb=/(=)\?(?=&|$)|\?\?/;n.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var a=Ib.pop()||n.expando+"_"+jb++;return this[a]=!0,a}}),n.ajaxPrefilter("json jsonp",function(b,c,d){var e,f,g,h=b.jsonp!==!1&&(Jb.test(b.url)?"url":"string"==typeof b.data&&0===(b.contentType||"").indexOf("application/x-www-form-urlencoded")&&Jb.test(b.data)&&"data");return h||"jsonp"===b.dataTypes[0]?(e=b.jsonpCallback=n.isFunction(b.jsonpCallback)?b.jsonpCallback():b.jsonpCallback,h?b[h]=b[h].replace(Jb,"$1"+e):b.jsonp!==!1&&(b.url+=(kb.test(b.url)?"&":"?")+b.jsonp+"="+e),b.converters["script json"]=function(){return g||n.error(e+" was not called"),g[0]},b.dataTypes[0]="json",f=a[e],a[e]=function(){g=arguments},d.always(function(){void 0===f?n(a).removeProp(e):a[e]=f,b[e]&&(b.jsonpCallback=c.jsonpCallback,Ib.push(e)),g&&n.isFunction(f)&&f(g[0]),g=f=void 0}),"script"):void 0}),l.createHTMLDocument=function(){var a=d.implementation.createHTMLDocument("").body;return a.innerHTML="<form></form><form></form>",2===a.childNodes.length}(),n.parseHTML=function(a,b,c){if(!a||"string"!=typeof a)return null;"boolean"==typeof b&&(c=b,b=!1),b=b||(l.createHTMLDocument?d.implementation.createHTMLDocument(""):d);var e=x.exec(a),f=!c&&[];return e?[b.createElement(e[1])]:(e=ca([a],b,f),f&&f.length&&n(f).remove(),n.merge([],e.childNodes))};var Kb=n.fn.load;n.fn.load=function(a,b,c){if("string"!=typeof a&&Kb)return Kb.apply(this,arguments);var d,e,f,g=this,h=a.indexOf(" ");return h>-1&&(d=n.trim(a.slice(h)),a=a.slice(0,h)),n.isFunction(b)?(c=b,b=void 0):b&&"object"==typeof b&&(e="POST"),g.length>0&&n.ajax({url:a,type:e||"GET",dataType:"html",data:b}).done(function(a){f=arguments,g.html(d?n("<div>").append(n.parseHTML(a)).find(d):a)}).always(c&&function(a,b){g.each(function(){c.apply(g,f||[a.responseText,b,a])})}),this},n.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(a,b){n.fn[b]=function(a){return this.on(b,a)}}),n.expr.filters.animated=function(a){return n.grep(n.timers,function(b){return a===b.elem}).length};function Lb(a){return n.isWindow(a)?a:9===a.nodeType&&a.defaultView}n.offset={setOffset:function(a,b,c){var d,e,f,g,h,i,j,k=n.css(a,"position"),l=n(a),m={};"static"===k&&(a.style.position="relative"),h=l.offset(),f=n.css(a,"top"),i=n.css(a,"left"),j=("absolute"===k||"fixed"===k)&&(f+i).indexOf("auto")>-1,j?(d=l.position(),g=d.top,e=d.left):(g=parseFloat(f)||0,e=parseFloat(i)||0),n.isFunction(b)&&(b=b.call(a,c,n.extend({},h))),null!=b.top&&(m.top=b.top-h.top+g),null!=b.left&&(m.left=b.left-h.left+e),"using"in b?b.using.call(a,m):l.css(m)}},n.fn.extend({offset:function(a){if(arguments.length)return void 0===a?this:this.each(function(b){n.offset.setOffset(this,a,b)});var b,c,d=this[0],e={top:0,left:0},f=d&&d.ownerDocument;if(f)return b=f.documentElement,n.contains(b,d)?(e=d.getBoundingClientRect(),c=Lb(f),{top:e.top+c.pageYOffset-b.clientTop,left:e.left+c.pageXOffset-b.clientLeft}):e},position:function(){if(this[0]){var a,b,c=this[0],d={top:0,left:0};return"fixed"===n.css(c,"position")?b=c.getBoundingClientRect():(a=this.offsetParent(),b=this.offset(),n.nodeName(a[0],"html")||(d=a.offset()),d.top+=n.css(a[0],"borderTopWidth",!0),d.left+=n.css(a[0],"borderLeftWidth",!0)),{top:b.top-d.top-n.css(c,"marginTop",!0),left:b.left-d.left-n.css(c,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){var a=this.offsetParent;while(a&&"static"===n.css(a,"position"))a=a.offsetParent;return a||Ea})}}),n.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(a,b){var c="pageYOffset"===b;n.fn[a]=function(d){return K(this,function(a,d,e){var f=Lb(a);return void 0===e?f?f[b]:a[d]:void(f?f.scrollTo(c?f.pageXOffset:e,c?e:f.pageYOffset):a[d]=e)},a,d,arguments.length)}}),n.each(["top","left"],function(a,b){n.cssHooks[b]=Ga(l.pixelPosition,function(a,c){return c?(c=Fa(a,b),Ba.test(c)?n(a).position()[b]+"px":c):void 0})}),n.each({Height:"height",Width:"width"},function(a,b){n.each({padding:"inner"+a,content:b,"":"outer"+a},function(c,d){n.fn[d]=function(d,e){var f=arguments.length&&(c||"boolean"!=typeof d),g=c||(d===!0||e===!0?"margin":"border");return K(this,function(b,c,d){var e;return n.isWindow(b)?b.document.documentElement["client"+a]:9===b.nodeType?(e=b.documentElement,Math.max(b.body["scroll"+a],e["scroll"+a],b.body["offset"+a],e["offset"+a],e["client"+a])):void 0===d?n.css(b,c,g):n.style(b,c,d,g)},b,f?d:void 0,f,null)}})}),n.fn.extend({bind:function(a,b,c){return this.on(a,null,b,c)},unbind:function(a,b){return this.off(a,null,b)},delegate:function(a,b,c,d){return this.on(b,a,c,d)},undelegate:function(a,b,c){return 1===arguments.length?this.off(a,"**"):this.off(b,a||"**",c)},size:function(){return this.length}}),n.fn.andSelf=n.fn.addBack,"function"==typeof define&&define.amd&&define("jquery",[],function(){return n});var Mb=a.jQuery,Nb=a.$;return n.noConflict=function(b){return a.$===n&&(a.$=Nb),b&&a.jQuery===n&&(a.jQuery=Mb),n},b||(a.jQuery=a.$=n),n});



======================================================================
FILE PATH: vendor\jQueryUI\jquery-ui.min.css
======================================================================
/*! jQuery UI - v1.11.4 - 2016-05-13
* http://jqueryui.com
* Includes: core.css, draggable.css, resizable.css, selectable.css, sortable.css, button.css, dialog.css, theme.css
* To view and modify this theme, visit http://jqueryui.com/themeroller/?ffDefault=Arial%2CHelvetica%2Csans-serif&fsDefault=1em&fwDefault=normal&cornerRadius=3px&bgColorHeader=e9e9e9&bgTextureHeader=flat&borderColorHeader=dddddd&fcHeader=333333&iconColorHeader=444444&bgColorContent=ffffff&bgTextureContent=flat&borderColorContent=dddddd&fcContent=333333&iconColorContent=444444&bgColorDefault=f6f6f6&bgTextureDefault=flat&borderColorDefault=c5c5c5&fcDefault=454545&iconColorDefault=777777&bgColorHover=ededed&bgTextureHover=flat&borderColorHover=cccccc&fcHover=2b2b2b&iconColorHover=555555&bgColorActive=007fff&bgTextureActive=flat&borderColorActive=003eff&fcActive=ffffff&iconColorActive=ffffff&bgColorHighlight=fffa90&bgTextureHighlight=flat&borderColorHighlight=dad55e&fcHighlight=777620&iconColorHighlight=777620&bgColorError=fddfdf&bgTextureError=flat&borderColorError=f1a899&fcError=5f3f3f&iconColorError=cc0000&bgColorOverlay=aaaaaa&bgTextureOverlay=flat&bgImgOpacityOverlay=0&opacityOverlay=30&bgColorShadow=666666&bgTextureShadow=flat&bgImgOpacityShadow=0&opacityShadow=30&thicknessShadow=5px&offsetTopShadow=0px&offsetLeftShadow=0px&cornerRadiusShadow=8px
* Copyright jQuery Foundation and other contributors; Licensed MIT */

.ui-helper-hidden{display:none}.ui-helper-hidden-accessible{border:0;clip:rect(0 0 0 0);height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px}.ui-helper-reset{margin:0;padding:0;border:0;outline:0;line-height:1.3;text-decoration:none;font-size:100%;list-style:none}.ui-helper-clearfix:before,.ui-helper-clearfix:after{content:"";display:table;border-collapse:collapse}.ui-helper-clearfix:after{clear:both}.ui-helper-clearfix{min-height:0}.ui-helper-zfix{width:100%;height:100%;top:0;left:0;position:absolute;opacity:0;filter:Alpha(Opacity=0)}.ui-front{z-index:100}.ui-state-disabled{cursor:default!important}.ui-icon{display:block;text-indent:-99999px;overflow:hidden;background-repeat:no-repeat}.ui-widget-overlay{position:fixed;top:0;left:0;width:100%;height:100%}.ui-draggable-handle{-ms-touch-action:none;touch-action:none}.ui-resizable{position:relative}.ui-resizable-handle{position:absolute;font-size:0.1px;display:block;-ms-touch-action:none;touch-action:none}.ui-resizable-disabled .ui-resizable-handle,.ui-resizable-autohide .ui-resizable-handle{display:none}.ui-resizable-n{cursor:n-resize;height:7px;width:100%;top:-5px;left:0}.ui-resizable-s{cursor:s-resize;height:7px;width:100%;bottom:-5px;left:0}.ui-resizable-e{cursor:e-resize;width:7px;right:-5px;top:0;height:100%}.ui-resizable-w{cursor:w-resize;width:7px;left:-5px;top:0;height:100%}.ui-resizable-se{cursor:se-resize;width:12px;height:12px;right:1px;bottom:1px}.ui-resizable-sw{cursor:sw-resize;width:9px;height:9px;left:-5px;bottom:-5px}.ui-resizable-nw{cursor:nw-resize;width:9px;height:9px;left:-5px;top:-5px}.ui-resizable-ne{cursor:ne-resize;width:9px;height:9px;right:-5px;top:-5px}.ui-selectable{-ms-touch-action:none;touch-action:none}.ui-selectable-helper{position:absolute;z-index:100;border:1px dotted black}.ui-sortable-handle{-ms-touch-action:none;touch-action:none}.ui-button{display:inline-block;position:relative;padding:0;line-height:normal;margin-right:.1em;cursor:pointer;vertical-align:middle;text-align:center;overflow:visible}.ui-button,.ui-button:link,.ui-button:visited,.ui-button:hover,.ui-button:active{text-decoration:none}.ui-button-icon-only{width:2.2em}button.ui-button-icon-only{width:2.4em}.ui-button-icons-only{width:3.4em}button.ui-button-icons-only{width:3.7em}.ui-button .ui-button-text{display:block;line-height:normal}.ui-button-text-only .ui-button-text{padding:.4em 1em}.ui-button-icon-only .ui-button-text,.ui-button-icons-only .ui-button-text{padding:.4em;text-indent:-9999999px}.ui-button-text-icon-primary .ui-button-text,.ui-button-text-icons .ui-button-text{padding:.4em 1em .4em 2.1em}.ui-button-text-icon-secondary .ui-button-text,.ui-button-text-icons .ui-button-text{padding:.4em 2.1em .4em 1em}.ui-button-text-icons .ui-button-text{padding-left:2.1em;padding-right:2.1em}input.ui-button{padding:.4em 1em}.ui-button-icon-only .ui-icon,.ui-button-text-icon-primary .ui-icon,.ui-button-text-icon-secondary .ui-icon,.ui-button-text-icons .ui-icon,.ui-button-icons-only .ui-icon{position:absolute;top:50%;margin-top:-8px}.ui-button-icon-only .ui-icon{left:50%;margin-left:-8px}.ui-button-text-icon-primary .ui-button-icon-primary,.ui-button-text-icons .ui-button-icon-primary,.ui-button-icons-only .ui-button-icon-primary{left:.5em}.ui-button-text-icon-secondary .ui-button-icon-secondary,.ui-button-text-icons .ui-button-icon-secondary,.ui-button-icons-only .ui-button-icon-secondary{right:.5em}.ui-buttonset{margin-right:7px}.ui-buttonset .ui-button{margin-left:0;margin-right:-.3em}input.ui-button::-moz-focus-inner,button.ui-button::-moz-focus-inner{border:0;padding:0}.ui-dialog{overflow:hidden;position:absolute;top:0;left:0;padding:.2em;outline:0}.ui-dialog .ui-dialog-titlebar{padding:.4em 1em;position:relative}.ui-dialog .ui-dialog-title{float:left;margin:.1em 0;white-space:nowrap;width:90%;overflow:hidden;text-overflow:ellipsis}.ui-dialog .ui-dialog-titlebar-close{position:absolute;right:.3em;top:50%;width:20px;margin:-10px 0 0 0;padding:1px;height:20px}.ui-dialog .ui-dialog-content{position:relative;border:0;padding:.5em 1em;background:none;overflow:auto}.ui-dialog .ui-dialog-buttonpane{text-align:left;border-width:1px 0 0 0;background-image:none;margin-top:.5em;padding:.3em 1em .5em .4em}.ui-dialog .ui-dialog-buttonpane .ui-dialog-buttonset{float:right}.ui-dialog .ui-dialog-buttonpane button{margin:.5em .4em .5em 0;cursor:pointer}.ui-dialog .ui-resizable-se{width:12px;height:12px;right:-5px;bottom:-5px;background-position:16px 16px}.ui-draggable .ui-dialog-titlebar{cursor:move}.ui-widget{font-family:Arial,Helvetica,sans-serif;font-size:1em}.ui-widget .ui-widget{font-size:1em}.ui-widget input,.ui-widget select,.ui-widget textarea,.ui-widget button{font-family:Arial,Helvetica,sans-serif;font-size:1em}.ui-widget-content{border:1px solid #ddd;background:#fff;color:#333}.ui-widget-content a{color:#333}.ui-widget-header{border:1px solid #ddd;background:#e9e9e9;color:#333;font-weight:bold}.ui-widget-header a{color:#333}.ui-state-default,.ui-widget-content .ui-state-default,.ui-widget-header .ui-state-default{border:1px solid #c5c5c5;background:#f6f6f6;font-weight:normal;color:#454545}.ui-state-default a,.ui-state-default a:link,.ui-state-default a:visited{color:#454545;text-decoration:none}.ui-state-hover,.ui-widget-content .ui-state-hover,.ui-widget-header .ui-state-hover,.ui-state-focus,.ui-widget-content .ui-state-focus,.ui-widget-header .ui-state-focus{border:1px solid #ccc;background:#ededed;font-weight:normal;color:#2b2b2b}.ui-state-hover a,.ui-state-hover a:hover,.ui-state-hover a:link,.ui-state-hover a:visited,.ui-state-focus a,.ui-state-focus a:hover,.ui-state-focus a:link,.ui-state-focus a:visited{color:#2b2b2b;text-decoration:none}.ui-state-active,.ui-widget-content .ui-state-active,.ui-widget-header .ui-state-active{border:1px solid #003eff;background:#007fff;font-weight:normal;color:#fff}.ui-state-active a,.ui-state-active a:link,.ui-state-active a:visited{color:#fff;text-decoration:none}.ui-state-highlight,.ui-widget-content .ui-state-highlight,.ui-widget-header .ui-state-highlight{border:1px solid #dad55e;background:#fffa90;color:#777620}.ui-state-highlight a,.ui-widget-content .ui-state-highlight a,.ui-widget-header .ui-state-highlight a{color:#777620}.ui-state-error,.ui-widget-content .ui-state-error,.ui-widget-header .ui-state-error{border:1px solid #f1a899;background:#fddfdf;color:#5f3f3f}.ui-state-error a,.ui-widget-content .ui-state-error a,.ui-widget-header .ui-state-error a{color:#5f3f3f}.ui-state-error-text,.ui-widget-content .ui-state-error-text,.ui-widget-header .ui-state-error-text{color:#5f3f3f}.ui-priority-primary,.ui-widget-content .ui-priority-primary,.ui-widget-header .ui-priority-primary{font-weight:bold}.ui-priority-secondary,.ui-widget-content .ui-priority-secondary,.ui-widget-header .ui-priority-secondary{opacity:.7;filter:Alpha(Opacity=70);font-weight:normal}.ui-state-disabled,.ui-widget-content .ui-state-disabled,.ui-widget-header .ui-state-disabled{opacity:.35;filter:Alpha(Opacity=35);background-image:none}.ui-state-disabled .ui-icon{filter:Alpha(Opacity=35)}.ui-icon{width:16px;height:16px}.ui-icon,.ui-widget-content .ui-icon{background-image:url("images/ui-icons_444444_256x240.png")}.ui-widget-header .ui-icon{background-image:url("images/ui-icons_444444_256x240.png")}.ui-state-default .ui-icon{background-image:url("images/ui-icons_777777_256x240.png")}.ui-state-hover .ui-icon,.ui-state-focus .ui-icon{background-image:url("images/ui-icons_555555_256x240.png")}.ui-state-active .ui-icon{background-image:url("images/ui-icons_ffffff_256x240.png")}.ui-state-highlight .ui-icon{background-image:url("images/ui-icons_777620_256x240.png")}.ui-state-error .ui-icon,.ui-state-error-text .ui-icon{background-image:url("images/ui-icons_cc0000_256x240.png")}.ui-icon-blank{background-position:16px 16px}.ui-icon-carat-1-n{background-position:0 0}.ui-icon-carat-1-ne{background-position:-16px 0}.ui-icon-carat-1-e{background-position:-32px 0}.ui-icon-carat-1-se{background-position:-48px 0}.ui-icon-carat-1-s{background-position:-64px 0}.ui-icon-carat-1-sw{background-position:-80px 0}.ui-icon-carat-1-w{background-position:-96px 0}.ui-icon-carat-1-nw{background-position:-112px 0}.ui-icon-carat-2-n-s{background-position:-128px 0}.ui-icon-carat-2-e-w{background-position:-144px 0}.ui-icon-triangle-1-n{background-position:0 -16px}.ui-icon-triangle-1-ne{background-position:-16px -16px}.ui-icon-triangle-1-e{background-position:-32px -16px}.ui-icon-triangle-1-se{background-position:-48px -16px}.ui-icon-triangle-1-s{background-position:-64px -16px}.ui-icon-triangle-1-sw{background-position:-80px -16px}.ui-icon-triangle-1-w{background-position:-96px -16px}.ui-icon-triangle-1-nw{background-position:-112px -16px}.ui-icon-triangle-2-n-s{background-position:-128px -16px}.ui-icon-triangle-2-e-w{background-position:-144px -16px}.ui-icon-arrow-1-n{background-position:0 -32px}.ui-icon-arrow-1-ne{background-position:-16px -32px}.ui-icon-arrow-1-e{background-position:-32px -32px}.ui-icon-arrow-1-se{background-position:-48px -32px}.ui-icon-arrow-1-s{background-position:-64px -32px}.ui-icon-arrow-1-sw{background-position:-80px -32px}.ui-icon-arrow-1-w{background-position:-96px -32px}.ui-icon-arrow-1-nw{background-position:-112px -32px}.ui-icon-arrow-2-n-s{background-position:-128px -32px}.ui-icon-arrow-2-ne-sw{background-position:-144px -32px}.ui-icon-arrow-2-e-w{background-position:-160px -32px}.ui-icon-arrow-2-se-nw{background-position:-176px -32px}.ui-icon-arrowstop-1-n{background-position:-192px -32px}.ui-icon-arrowstop-1-e{background-position:-208px -32px}.ui-icon-arrowstop-1-s{background-position:-224px -32px}.ui-icon-arrowstop-1-w{background-position:-240px -32px}.ui-icon-arrowthick-1-n{background-position:0 -48px}.ui-icon-arrowthick-1-ne{background-position:-16px -48px}.ui-icon-arrowthick-1-e{background-position:-32px -48px}.ui-icon-arrowthick-1-se{background-position:-48px -48px}.ui-icon-arrowthick-1-s{background-position:-64px -48px}.ui-icon-arrowthick-1-sw{background-position:-80px -48px}.ui-icon-arrowthick-1-w{background-position:-96px -48px}.ui-icon-arrowthick-1-nw{background-position:-112px -48px}.ui-icon-arrowthick-2-n-s{background-position:-128px -48px}.ui-icon-arrowthick-2-ne-sw{background-position:-144px -48px}.ui-icon-arrowthick-2-e-w{background-position:-160px -48px}.ui-icon-arrowthick-2-se-nw{background-position:-176px -48px}.ui-icon-arrowthickstop-1-n{background-position:-192px -48px}.ui-icon-arrowthickstop-1-e{background-position:-208px -48px}.ui-icon-arrowthickstop-1-s{background-position:-224px -48px}.ui-icon-arrowthickstop-1-w{background-position:-240px -48px}.ui-icon-arrowreturnthick-1-w{background-position:0 -64px}.ui-icon-arrowreturnthick-1-n{background-position:-16px -64px}.ui-icon-arrowreturnthick-1-e{background-position:-32px -64px}.ui-icon-arrowreturnthick-1-s{background-position:-48px -64px}.ui-icon-arrowreturn-1-w{background-position:-64px -64px}.ui-icon-arrowreturn-1-n{background-position:-80px -64px}.ui-icon-arrowreturn-1-e{background-position:-96px -64px}.ui-icon-arrowreturn-1-s{background-position:-112px -64px}.ui-icon-arrowrefresh-1-w{background-position:-128px -64px}.ui-icon-arrowrefresh-1-n{background-position:-144px -64px}.ui-icon-arrowrefresh-1-e{background-position:-160px -64px}.ui-icon-arrowrefresh-1-s{background-position:-176px -64px}.ui-icon-arrow-4{background-position:0 -80px}.ui-icon-arrow-4-diag{background-position:-16px -80px}.ui-icon-extlink{background-position:-32px -80px}.ui-icon-newwin{background-position:-48px -80px}.ui-icon-refresh{background-position:-64px -80px}.ui-icon-shuffle{background-position:-80px -80px}.ui-icon-transfer-e-w{background-position:-96px -80px}.ui-icon-transferthick-e-w{background-position:-112px -80px}.ui-icon-folder-collapsed{background-position:0 -96px}.ui-icon-folder-open{background-position:-16px -96px}.ui-icon-document{background-position:-32px -96px}.ui-icon-document-b{background-position:-48px -96px}.ui-icon-note{background-position:-64px -96px}.ui-icon-mail-closed{background-position:-80px -96px}.ui-icon-mail-open{background-position:-96px -96px}.ui-icon-suitcase{background-position:-112px -96px}.ui-icon-comment{background-position:-128px -96px}.ui-icon-person{background-position:-144px -96px}.ui-icon-print{background-position:-160px -96px}.ui-icon-trash{background-position:-176px -96px}.ui-icon-locked{background-position:-192px -96px}.ui-icon-unlocked{background-position:-208px -96px}.ui-icon-bookmark{background-position:-224px -96px}.ui-icon-tag{background-position:-240px -96px}.ui-icon-home{background-position:0 -112px}.ui-icon-flag{background-position:-16px -112px}.ui-icon-calendar{background-position:-32px -112px}.ui-icon-cart{background-position:-48px -112px}.ui-icon-pencil{background-position:-64px -112px}.ui-icon-clock{background-position:-80px -112px}.ui-icon-disk{background-position:-96px -112px}.ui-icon-calculator{background-position:-112px -112px}.ui-icon-zoomin{background-position:-128px -112px}.ui-icon-zoomout{background-position:-144px -112px}.ui-icon-search{background-position:-160px -112px}.ui-icon-wrench{background-position:-176px -112px}.ui-icon-gear{background-position:-192px -112px}.ui-icon-heart{background-position:-208px -112px}.ui-icon-star{background-position:-224px -112px}.ui-icon-link{background-position:-240px -112px}.ui-icon-cancel{background-position:0 -128px}.ui-icon-plus{background-position:-16px -128px}.ui-icon-plusthick{background-position:-32px -128px}.ui-icon-minus{background-position:-48px -128px}.ui-icon-minusthick{background-position:-64px -128px}.ui-icon-close{background-position:-80px -128px}.ui-icon-closethick{background-position:-96px -128px}.ui-icon-key{background-position:-112px -128px}.ui-icon-lightbulb{background-position:-128px -128px}.ui-icon-scissors{background-position:-144px -128px}.ui-icon-clipboard{background-position:-160px -128px}.ui-icon-copy{background-position:-176px -128px}.ui-icon-contact{background-position:-192px -128px}.ui-icon-image{background-position:-208px -128px}.ui-icon-video{background-position:-224px -128px}.ui-icon-script{background-position:-240px -128px}.ui-icon-alert{background-position:0 -144px}.ui-icon-info{background-position:-16px -144px}.ui-icon-notice{background-position:-32px -144px}.ui-icon-help{background-position:-48px -144px}.ui-icon-check{background-position:-64px -144px}.ui-icon-bullet{background-position:-80px -144px}.ui-icon-radio-on{background-position:-96px -144px}.ui-icon-radio-off{background-position:-112px -144px}.ui-icon-pin-w{background-position:-128px -144px}.ui-icon-pin-s{background-position:-144px -144px}.ui-icon-play{background-position:0 -160px}.ui-icon-pause{background-position:-16px -160px}.ui-icon-seek-next{background-position:-32px -160px}.ui-icon-seek-prev{background-position:-48px -160px}.ui-icon-seek-end{background-position:-64px -160px}.ui-icon-seek-start{background-position:-80px -160px}.ui-icon-seek-first{background-position:-80px -160px}.ui-icon-stop{background-position:-96px -160px}.ui-icon-eject{background-position:-112px -160px}.ui-icon-volume-off{background-position:-128px -160px}.ui-icon-volume-on{background-position:-144px -160px}.ui-icon-power{background-position:0 -176px}.ui-icon-signal-diag{background-position:-16px -176px}.ui-icon-signal{background-position:-32px -176px}.ui-icon-battery-0{background-position:-48px -176px}.ui-icon-battery-1{background-position:-64px -176px}.ui-icon-battery-2{background-position:-80px -176px}.ui-icon-battery-3{background-position:-96px -176px}.ui-icon-circle-plus{background-position:0 -192px}.ui-icon-circle-minus{background-position:-16px -192px}.ui-icon-circle-close{background-position:-32px -192px}.ui-icon-circle-triangle-e{background-position:-48px -192px}.ui-icon-circle-triangle-s{background-position:-64px -192px}.ui-icon-circle-triangle-w{background-position:-80px -192px}.ui-icon-circle-triangle-n{background-position:-96px -192px}.ui-icon-circle-arrow-e{background-position:-112px -192px}.ui-icon-circle-arrow-s{background-position:-128px -192px}.ui-icon-circle-arrow-w{background-position:-144px -192px}.ui-icon-circle-arrow-n{background-position:-160px -192px}.ui-icon-circle-zoomin{background-position:-176px -192px}.ui-icon-circle-zoomout{background-position:-192px -192px}.ui-icon-circle-check{background-position:-208px -192px}.ui-icon-circlesmall-plus{background-position:0 -208px}.ui-icon-circlesmall-minus{background-position:-16px -208px}.ui-icon-circlesmall-close{background-position:-32px -208px}.ui-icon-squaresmall-plus{background-position:-48px -208px}.ui-icon-squaresmall-minus{background-position:-64px -208px}.ui-icon-squaresmall-close{background-position:-80px -208px}.ui-icon-grip-dotted-vertical{background-position:0 -224px}.ui-icon-grip-dotted-horizontal{background-position:-16px -224px}.ui-icon-grip-solid-vertical{background-position:-32px -224px}.ui-icon-grip-solid-horizontal{background-position:-48px -224px}.ui-icon-gripsmall-diagonal-se{background-position:-64px -224px}.ui-icon-grip-diagonal-se{background-position:-80px -224px}.ui-corner-all,.ui-corner-top,.ui-corner-left,.ui-corner-tl{border-top-left-radius:3px}.ui-corner-all,.ui-corner-top,.ui-corner-right,.ui-corner-tr{border-top-right-radius:3px}.ui-corner-all,.ui-corner-bottom,.ui-corner-left,.ui-corner-bl{border-bottom-left-radius:3px}.ui-corner-all,.ui-corner-bottom,.ui-corner-right,.ui-corner-br{border-bottom-right-radius:3px}.ui-widget-overlay{background:#aaa;opacity:.3;filter:Alpha(Opacity=30)}.ui-widget-shadow{margin:0 0 0 0;padding:5px;background:#666;opacity:.3;filter:Alpha(Opacity=30);border-radius:8px}


======================================================================
FILE PATH: vendor\jQueryUI\jquery-ui.min.js
======================================================================
/*! jQuery UI - v1.11.4 - 2016-05-13
* http://jqueryui.com
* Includes: core.js, widget.js, mouse.js, position.js, draggable.js, droppable.js, resizable.js, selectable.js, sortable.js, button.js, dialog.js
* Copyright jQuery Foundation and other contributors; Licensed MIT */

(function(t){"function"==typeof define&&define.amd?define(["jquery"],t):t(jQuery)})(function(t){function e(e,s){var n,a,o,r=e.nodeName.toLowerCase();return"area"===r?(n=e.parentNode,a=n.name,e.href&&a&&"map"===n.nodeName.toLowerCase()?(o=t("img[usemap='#"+a+"']")[0],!!o&&i(o)):!1):(/^(input|select|textarea|button|object)$/.test(r)?!e.disabled:"a"===r?e.href||s:s)&&i(e)}function i(e){return t.expr.filters.visible(e)&&!t(e).parents().addBack().filter(function(){return"hidden"===t.css(this,"visibility")}).length}t.ui=t.ui||{},t.extend(t.ui,{version:"1.11.4",keyCode:{BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38}}),t.fn.extend({scrollParent:function(e){var i=this.css("position"),s="absolute"===i,n=e?/(auto|scroll|hidden)/:/(auto|scroll)/,a=this.parents().filter(function(){var e=t(this);return s&&"static"===e.css("position")?!1:n.test(e.css("overflow")+e.css("overflow-y")+e.css("overflow-x"))}).eq(0);return"fixed"!==i&&a.length?a:t(this[0].ownerDocument||document)},uniqueId:function(){var t=0;return function(){return this.each(function(){this.id||(this.id="ui-id-"+ ++t)})}}(),removeUniqueId:function(){return this.each(function(){/^ui-id-\d+$/.test(this.id)&&t(this).removeAttr("id")})}}),t.extend(t.expr[":"],{data:t.expr.createPseudo?t.expr.createPseudo(function(e){return function(i){return!!t.data(i,e)}}):function(e,i,s){return!!t.data(e,s[3])},focusable:function(i){return e(i,!isNaN(t.attr(i,"tabindex")))},tabbable:function(i){var s=t.attr(i,"tabindex"),n=isNaN(s);return(n||s>=0)&&e(i,!n)}}),t("<a>").outerWidth(1).jquery||t.each(["Width","Height"],function(e,i){function s(e,i,s,a){return t.each(n,function(){i-=parseFloat(t.css(e,"padding"+this))||0,s&&(i-=parseFloat(t.css(e,"border"+this+"Width"))||0),a&&(i-=parseFloat(t.css(e,"margin"+this))||0)}),i}var n="Width"===i?["Left","Right"]:["Top","Bottom"],a=i.toLowerCase(),o={innerWidth:t.fn.innerWidth,innerHeight:t.fn.innerHeight,outerWidth:t.fn.outerWidth,outerHeight:t.fn.outerHeight};t.fn["inner"+i]=function(e){return void 0===e?o["inner"+i].call(this):this.each(function(){t(this).css(a,s(this,e)+"px")})},t.fn["outer"+i]=function(e,n){return"number"!=typeof e?o["outer"+i].call(this,e):this.each(function(){t(this).css(a,s(this,e,!0,n)+"px")})}}),t.fn.addBack||(t.fn.addBack=function(t){return this.add(null==t?this.prevObject:this.prevObject.filter(t))}),t("<a>").data("a-b","a").removeData("a-b").data("a-b")&&(t.fn.removeData=function(e){return function(i){return arguments.length?e.call(this,t.camelCase(i)):e.call(this)}}(t.fn.removeData)),t.ui.ie=!!/msie [\w.]+/.exec(navigator.userAgent.toLowerCase()),t.fn.extend({focus:function(e){return function(i,s){return"number"==typeof i?this.each(function(){var e=this;setTimeout(function(){t(e).focus(),s&&s.call(e)},i)}):e.apply(this,arguments)}}(t.fn.focus),disableSelection:function(){var t="onselectstart"in document.createElement("div")?"selectstart":"mousedown";return function(){return this.bind(t+".ui-disableSelection",function(t){t.preventDefault()})}}(),enableSelection:function(){return this.unbind(".ui-disableSelection")},zIndex:function(e){if(void 0!==e)return this.css("zIndex",e);if(this.length)for(var i,s,n=t(this[0]);n.length&&n[0]!==document;){if(i=n.css("position"),("absolute"===i||"relative"===i||"fixed"===i)&&(s=parseInt(n.css("zIndex"),10),!isNaN(s)&&0!==s))return s;n=n.parent()}return 0}}),t.ui.plugin={add:function(e,i,s){var n,a=t.ui[e].prototype;for(n in s)a.plugins[n]=a.plugins[n]||[],a.plugins[n].push([i,s[n]])},call:function(t,e,i,s){var n,a=t.plugins[e];if(a&&(s||t.element[0].parentNode&&11!==t.element[0].parentNode.nodeType))for(n=0;a.length>n;n++)t.options[a[n][0]]&&a[n][1].apply(t.element,i)}};var s=0,n=Array.prototype.slice;t.cleanData=function(e){return function(i){var s,n,a;for(a=0;null!=(n=i[a]);a++)try{s=t._data(n,"events"),s&&s.remove&&t(n).triggerHandler("remove")}catch(o){}e(i)}}(t.cleanData),t.widget=function(e,i,s){var n,a,o,r,h={},l=e.split(".")[0];return e=e.split(".")[1],n=l+"-"+e,s||(s=i,i=t.Widget),t.expr[":"][n.toLowerCase()]=function(e){return!!t.data(e,n)},t[l]=t[l]||{},a=t[l][e],o=t[l][e]=function(t,e){return this._createWidget?(arguments.length&&this._createWidget(t,e),void 0):new o(t,e)},t.extend(o,a,{version:s.version,_proto:t.extend({},s),_childConstructors:[]}),r=new i,r.options=t.widget.extend({},r.options),t.each(s,function(e,s){return t.isFunction(s)?(h[e]=function(){var t=function(){return i.prototype[e].apply(this,arguments)},n=function(t){return i.prototype[e].apply(this,t)};return function(){var e,i=this._super,a=this._superApply;return this._super=t,this._superApply=n,e=s.apply(this,arguments),this._super=i,this._superApply=a,e}}(),void 0):(h[e]=s,void 0)}),o.prototype=t.widget.extend(r,{widgetEventPrefix:a?r.widgetEventPrefix||e:e},h,{constructor:o,namespace:l,widgetName:e,widgetFullName:n}),a?(t.each(a._childConstructors,function(e,i){var s=i.prototype;t.widget(s.namespace+"."+s.widgetName,o,i._proto)}),delete a._childConstructors):i._childConstructors.push(o),t.widget.bridge(e,o),o},t.widget.extend=function(e){for(var i,s,a=n.call(arguments,1),o=0,r=a.length;r>o;o++)for(i in a[o])s=a[o][i],a[o].hasOwnProperty(i)&&void 0!==s&&(e[i]=t.isPlainObject(s)?t.isPlainObject(e[i])?t.widget.extend({},e[i],s):t.widget.extend({},s):s);return e},t.widget.bridge=function(e,i){var s=i.prototype.widgetFullName||e;t.fn[e]=function(a){var o="string"==typeof a,r=n.call(arguments,1),h=this;return o?this.each(function(){var i,n=t.data(this,s);return"instance"===a?(h=n,!1):n?t.isFunction(n[a])&&"_"!==a.charAt(0)?(i=n[a].apply(n,r),i!==n&&void 0!==i?(h=i&&i.jquery?h.pushStack(i.get()):i,!1):void 0):t.error("no such method '"+a+"' for "+e+" widget instance"):t.error("cannot call methods on "+e+" prior to initialization; "+"attempted to call method '"+a+"'")}):(r.length&&(a=t.widget.extend.apply(null,[a].concat(r))),this.each(function(){var e=t.data(this,s);e?(e.option(a||{}),e._init&&e._init()):t.data(this,s,new i(a,this))})),h}},t.Widget=function(){},t.Widget._childConstructors=[],t.Widget.prototype={widgetName:"widget",widgetEventPrefix:"",defaultElement:"<div>",options:{disabled:!1,create:null},_createWidget:function(e,i){i=t(i||this.defaultElement||this)[0],this.element=t(i),this.uuid=s++,this.eventNamespace="."+this.widgetName+this.uuid,this.bindings=t(),this.hoverable=t(),this.focusable=t(),i!==this&&(t.data(i,this.widgetFullName,this),this._on(!0,this.element,{remove:function(t){t.target===i&&this.destroy()}}),this.document=t(i.style?i.ownerDocument:i.document||i),this.window=t(this.document[0].defaultView||this.document[0].parentWindow)),this.options=t.widget.extend({},this.options,this._getCreateOptions(),e),this._create(),this._trigger("create",null,this._getCreateEventData()),this._init()},_getCreateOptions:t.noop,_getCreateEventData:t.noop,_create:t.noop,_init:t.noop,destroy:function(){this._destroy(),this.element.unbind(this.eventNamespace).removeData(this.widgetFullName).removeData(t.camelCase(this.widgetFullName)),this.widget().unbind(this.eventNamespace).removeAttr("aria-disabled").removeClass(this.widgetFullName+"-disabled "+"ui-state-disabled"),this.bindings.unbind(this.eventNamespace),this.hoverable.removeClass("ui-state-hover"),this.focusable.removeClass("ui-state-focus")},_destroy:t.noop,widget:function(){return this.element},option:function(e,i){var s,n,a,o=e;if(0===arguments.length)return t.widget.extend({},this.options);if("string"==typeof e)if(o={},s=e.split("."),e=s.shift(),s.length){for(n=o[e]=t.widget.extend({},this.options[e]),a=0;s.length-1>a;a++)n[s[a]]=n[s[a]]||{},n=n[s[a]];if(e=s.pop(),1===arguments.length)return void 0===n[e]?null:n[e];n[e]=i}else{if(1===arguments.length)return void 0===this.options[e]?null:this.options[e];o[e]=i}return this._setOptions(o),this},_setOptions:function(t){var e;for(e in t)this._setOption(e,t[e]);return this},_setOption:function(t,e){return this.options[t]=e,"disabled"===t&&(this.widget().toggleClass(this.widgetFullName+"-disabled",!!e),e&&(this.hoverable.removeClass("ui-state-hover"),this.focusable.removeClass("ui-state-focus"))),this},enable:function(){return this._setOptions({disabled:!1})},disable:function(){return this._setOptions({disabled:!0})},_on:function(e,i,s){var n,a=this;"boolean"!=typeof e&&(s=i,i=e,e=!1),s?(i=n=t(i),this.bindings=this.bindings.add(i)):(s=i,i=this.element,n=this.widget()),t.each(s,function(s,o){function r(){return e||a.options.disabled!==!0&&!t(this).hasClass("ui-state-disabled")?("string"==typeof o?a[o]:o).apply(a,arguments):void 0}"string"!=typeof o&&(r.guid=o.guid=o.guid||r.guid||t.guid++);var h=s.match(/^([\w:-]*)\s*(.*)$/),l=h[1]+a.eventNamespace,u=h[2];u?n.delegate(u,l,r):i.bind(l,r)})},_off:function(e,i){i=(i||"").split(" ").join(this.eventNamespace+" ")+this.eventNamespace,e.unbind(i).undelegate(i),this.bindings=t(this.bindings.not(e).get()),this.focusable=t(this.focusable.not(e).get()),this.hoverable=t(this.hoverable.not(e).get())},_delay:function(t,e){function i(){return("string"==typeof t?s[t]:t).apply(s,arguments)}var s=this;return setTimeout(i,e||0)},_hoverable:function(e){this.hoverable=this.hoverable.add(e),this._on(e,{mouseenter:function(e){t(e.currentTarget).addClass("ui-state-hover")},mouseleave:function(e){t(e.currentTarget).removeClass("ui-state-hover")}})},_focusable:function(e){this.focusable=this.focusable.add(e),this._on(e,{focusin:function(e){t(e.currentTarget).addClass("ui-state-focus")},focusout:function(e){t(e.currentTarget).removeClass("ui-state-focus")}})},_trigger:function(e,i,s){var n,a,o=this.options[e];if(s=s||{},i=t.Event(i),i.type=(e===this.widgetEventPrefix?e:this.widgetEventPrefix+e).toLowerCase(),i.target=this.element[0],a=i.originalEvent)for(n in a)n in i||(i[n]=a[n]);return this.element.trigger(i,s),!(t.isFunction(o)&&o.apply(this.element[0],[i].concat(s))===!1||i.isDefaultPrevented())}},t.each({show:"fadeIn",hide:"fadeOut"},function(e,i){t.Widget.prototype["_"+e]=function(s,n,a){"string"==typeof n&&(n={effect:n});var o,r=n?n===!0||"number"==typeof n?i:n.effect||i:e;n=n||{},"number"==typeof n&&(n={duration:n}),o=!t.isEmptyObject(n),n.complete=a,n.delay&&s.delay(n.delay),o&&t.effects&&t.effects.effect[r]?s[e](n):r!==e&&s[r]?s[r](n.duration,n.easing,a):s.queue(function(i){t(this)[e](),a&&a.call(s[0]),i()})}}),t.widget;var a=!1;t(document).mouseup(function(){a=!1}),t.widget("ui.mouse",{version:"1.11.4",options:{cancel:"input,textarea,button,select,option",distance:1,delay:0},_mouseInit:function(){var e=this;this.element.bind("mousedown."+this.widgetName,function(t){return e._mouseDown(t)}).bind("click."+this.widgetName,function(i){return!0===t.data(i.target,e.widgetName+".preventClickEvent")?(t.removeData(i.target,e.widgetName+".preventClickEvent"),i.stopImmediatePropagation(),!1):void 0}),this.started=!1},_mouseDestroy:function(){this.element.unbind("."+this.widgetName),this._mouseMoveDelegate&&this.document.unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate)},_mouseDown:function(e){if(!a){this._mouseMoved=!1,this._mouseStarted&&this._mouseUp(e),this._mouseDownEvent=e;var i=this,s=1===e.which,n="string"==typeof this.options.cancel&&e.target.nodeName?t(e.target).closest(this.options.cancel).length:!1;return s&&!n&&this._mouseCapture(e)?(this.mouseDelayMet=!this.options.delay,this.mouseDelayMet||(this._mouseDelayTimer=setTimeout(function(){i.mouseDelayMet=!0},this.options.delay)),this._mouseDistanceMet(e)&&this._mouseDelayMet(e)&&(this._mouseStarted=this._mouseStart(e)!==!1,!this._mouseStarted)?(e.preventDefault(),!0):(!0===t.data(e.target,this.widgetName+".preventClickEvent")&&t.removeData(e.target,this.widgetName+".preventClickEvent"),this._mouseMoveDelegate=function(t){return i._mouseMove(t)},this._mouseUpDelegate=function(t){return i._mouseUp(t)},this.document.bind("mousemove."+this.widgetName,this._mouseMoveDelegate).bind("mouseup."+this.widgetName,this._mouseUpDelegate),e.preventDefault(),a=!0,!0)):!0}},_mouseMove:function(e){if(this._mouseMoved){if(t.ui.ie&&(!document.documentMode||9>document.documentMode)&&!e.button)return this._mouseUp(e);if(!e.which)return this._mouseUp(e)}return(e.which||e.button)&&(this._mouseMoved=!0),this._mouseStarted?(this._mouseDrag(e),e.preventDefault()):(this._mouseDistanceMet(e)&&this._mouseDelayMet(e)&&(this._mouseStarted=this._mouseStart(this._mouseDownEvent,e)!==!1,this._mouseStarted?this._mouseDrag(e):this._mouseUp(e)),!this._mouseStarted)},_mouseUp:function(e){return this.document.unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate),this._mouseStarted&&(this._mouseStarted=!1,e.target===this._mouseDownEvent.target&&t.data(e.target,this.widgetName+".preventClickEvent",!0),this._mouseStop(e)),a=!1,!1},_mouseDistanceMet:function(t){return Math.max(Math.abs(this._mouseDownEvent.pageX-t.pageX),Math.abs(this._mouseDownEvent.pageY-t.pageY))>=this.options.distance},_mouseDelayMet:function(){return this.mouseDelayMet},_mouseStart:function(){},_mouseDrag:function(){},_mouseStop:function(){},_mouseCapture:function(){return!0}}),function(){function e(t,e,i){return[parseFloat(t[0])*(p.test(t[0])?e/100:1),parseFloat(t[1])*(p.test(t[1])?i/100:1)]}function i(e,i){return parseInt(t.css(e,i),10)||0}function s(e){var i=e[0];return 9===i.nodeType?{width:e.width(),height:e.height(),offset:{top:0,left:0}}:t.isWindow(i)?{width:e.width(),height:e.height(),offset:{top:e.scrollTop(),left:e.scrollLeft()}}:i.preventDefault?{width:0,height:0,offset:{top:i.pageY,left:i.pageX}}:{width:e.outerWidth(),height:e.outerHeight(),offset:e.offset()}}t.ui=t.ui||{};var n,a,o=Math.max,r=Math.abs,h=Math.round,l=/left|center|right/,u=/top|center|bottom/,c=/[\+\-]\d+(\.[\d]+)?%?/,d=/^\w+/,p=/%$/,f=t.fn.position;t.position={scrollbarWidth:function(){if(void 0!==n)return n;var e,i,s=t("<div style='display:block;position:absolute;width:50px;height:50px;overflow:hidden;'><div style='height:100px;width:auto;'></div></div>"),a=s.children()[0];return t("body").append(s),e=a.offsetWidth,s.css("overflow","scroll"),i=a.offsetWidth,e===i&&(i=s[0].clientWidth),s.remove(),n=e-i},getScrollInfo:function(e){var i=e.isWindow||e.isDocument?"":e.element.css("overflow-x"),s=e.isWindow||e.isDocument?"":e.element.css("overflow-y"),n="scroll"===i||"auto"===i&&e.width<e.element[0].scrollWidth,a="scroll"===s||"auto"===s&&e.height<e.element[0].scrollHeight;return{width:a?t.position.scrollbarWidth():0,height:n?t.position.scrollbarWidth():0}},getWithinInfo:function(e){var i=t(e||window),s=t.isWindow(i[0]),n=!!i[0]&&9===i[0].nodeType;return{element:i,isWindow:s,isDocument:n,offset:i.offset()||{left:0,top:0},scrollLeft:i.scrollLeft(),scrollTop:i.scrollTop(),width:s||n?i.width():i.outerWidth(),height:s||n?i.height():i.outerHeight()}}},t.fn.position=function(n){if(!n||!n.of)return f.apply(this,arguments);n=t.extend({},n);var p,m,g,v,_,b,y=t(n.of),x=t.position.getWithinInfo(n.within),w=t.position.getScrollInfo(x),k=(n.collision||"flip").split(" "),D={};return b=s(y),y[0].preventDefault&&(n.at="left top"),m=b.width,g=b.height,v=b.offset,_=t.extend({},v),t.each(["my","at"],function(){var t,e,i=(n[this]||"").split(" ");1===i.length&&(i=l.test(i[0])?i.concat(["center"]):u.test(i[0])?["center"].concat(i):["center","center"]),i[0]=l.test(i[0])?i[0]:"center",i[1]=u.test(i[1])?i[1]:"center",t=c.exec(i[0]),e=c.exec(i[1]),D[this]=[t?t[0]:0,e?e[0]:0],n[this]=[d.exec(i[0])[0],d.exec(i[1])[0]]}),1===k.length&&(k[1]=k[0]),"right"===n.at[0]?_.left+=m:"center"===n.at[0]&&(_.left+=m/2),"bottom"===n.at[1]?_.top+=g:"center"===n.at[1]&&(_.top+=g/2),p=e(D.at,m,g),_.left+=p[0],_.top+=p[1],this.each(function(){var s,l,u=t(this),c=u.outerWidth(),d=u.outerHeight(),f=i(this,"marginLeft"),b=i(this,"marginTop"),T=c+f+i(this,"marginRight")+w.width,S=d+b+i(this,"marginBottom")+w.height,M=t.extend({},_),C=e(D.my,u.outerWidth(),u.outerHeight());"right"===n.my[0]?M.left-=c:"center"===n.my[0]&&(M.left-=c/2),"bottom"===n.my[1]?M.top-=d:"center"===n.my[1]&&(M.top-=d/2),M.left+=C[0],M.top+=C[1],a||(M.left=h(M.left),M.top=h(M.top)),s={marginLeft:f,marginTop:b},t.each(["left","top"],function(e,i){t.ui.position[k[e]]&&t.ui.position[k[e]][i](M,{targetWidth:m,targetHeight:g,elemWidth:c,elemHeight:d,collisionPosition:s,collisionWidth:T,collisionHeight:S,offset:[p[0]+C[0],p[1]+C[1]],my:n.my,at:n.at,within:x,elem:u})}),n.using&&(l=function(t){var e=v.left-M.left,i=e+m-c,s=v.top-M.top,a=s+g-d,h={target:{element:y,left:v.left,top:v.top,width:m,height:g},element:{element:u,left:M.left,top:M.top,width:c,height:d},horizontal:0>i?"left":e>0?"right":"center",vertical:0>a?"top":s>0?"bottom":"middle"};c>m&&m>r(e+i)&&(h.horizontal="center"),d>g&&g>r(s+a)&&(h.vertical="middle"),h.important=o(r(e),r(i))>o(r(s),r(a))?"horizontal":"vertical",n.using.call(this,t,h)}),u.offset(t.extend(M,{using:l}))})},t.ui.position={fit:{left:function(t,e){var i,s=e.within,n=s.isWindow?s.scrollLeft:s.offset.left,a=s.width,r=t.left-e.collisionPosition.marginLeft,h=n-r,l=r+e.collisionWidth-a-n;e.collisionWidth>a?h>0&&0>=l?(i=t.left+h+e.collisionWidth-a-n,t.left+=h-i):t.left=l>0&&0>=h?n:h>l?n+a-e.collisionWidth:n:h>0?t.left+=h:l>0?t.left-=l:t.left=o(t.left-r,t.left)},top:function(t,e){var i,s=e.within,n=s.isWindow?s.scrollTop:s.offset.top,a=e.within.height,r=t.top-e.collisionPosition.marginTop,h=n-r,l=r+e.collisionHeight-a-n;e.collisionHeight>a?h>0&&0>=l?(i=t.top+h+e.collisionHeight-a-n,t.top+=h-i):t.top=l>0&&0>=h?n:h>l?n+a-e.collisionHeight:n:h>0?t.top+=h:l>0?t.top-=l:t.top=o(t.top-r,t.top)}},flip:{left:function(t,e){var i,s,n=e.within,a=n.offset.left+n.scrollLeft,o=n.width,h=n.isWindow?n.scrollLeft:n.offset.left,l=t.left-e.collisionPosition.marginLeft,u=l-h,c=l+e.collisionWidth-o-h,d="left"===e.my[0]?-e.elemWidth:"right"===e.my[0]?e.elemWidth:0,p="left"===e.at[0]?e.targetWidth:"right"===e.at[0]?-e.targetWidth:0,f=-2*e.offset[0];0>u?(i=t.left+d+p+f+e.collisionWidth-o-a,(0>i||r(u)>i)&&(t.left+=d+p+f)):c>0&&(s=t.left-e.collisionPosition.marginLeft+d+p+f-h,(s>0||c>r(s))&&(t.left+=d+p+f))},top:function(t,e){var i,s,n=e.within,a=n.offset.top+n.scrollTop,o=n.height,h=n.isWindow?n.scrollTop:n.offset.top,l=t.top-e.collisionPosition.marginTop,u=l-h,c=l+e.collisionHeight-o-h,d="top"===e.my[1],p=d?-e.elemHeight:"bottom"===e.my[1]?e.elemHeight:0,f="top"===e.at[1]?e.targetHeight:"bottom"===e.at[1]?-e.targetHeight:0,m=-2*e.offset[1];0>u?(s=t.top+p+f+m+e.collisionHeight-o-a,(0>s||r(u)>s)&&(t.top+=p+f+m)):c>0&&(i=t.top-e.collisionPosition.marginTop+p+f+m-h,(i>0||c>r(i))&&(t.top+=p+f+m))}},flipfit:{left:function(){t.ui.position.flip.left.apply(this,arguments),t.ui.position.fit.left.apply(this,arguments)},top:function(){t.ui.position.flip.top.apply(this,arguments),t.ui.position.fit.top.apply(this,arguments)}}},function(){var e,i,s,n,o,r=document.getElementsByTagName("body")[0],h=document.createElement("div");e=document.createElement(r?"div":"body"),s={visibility:"hidden",width:0,height:0,border:0,margin:0,background:"none"},r&&t.extend(s,{position:"absolute",left:"-1000px",top:"-1000px"});for(o in s)e.style[o]=s[o];e.appendChild(h),i=r||document.documentElement,i.insertBefore(e,i.firstChild),h.style.cssText="position: absolute; left: 10.7432222px;",n=t(h).offset().left,a=n>10&&11>n,e.innerHTML="",i.removeChild(e)}()}(),t.ui.position,t.widget("ui.draggable",t.ui.mouse,{version:"1.11.4",widgetEventPrefix:"drag",options:{addClasses:!0,appendTo:"parent",axis:!1,connectToSortable:!1,containment:!1,cursor:"auto",cursorAt:!1,grid:!1,handle:!1,helper:"original",iframeFix:!1,opacity:!1,refreshPositions:!1,revert:!1,revertDuration:500,scope:"default",scroll:!0,scrollSensitivity:20,scrollSpeed:20,snap:!1,snapMode:"both",snapTolerance:20,stack:!1,zIndex:!1,drag:null,start:null,stop:null},_create:function(){"original"===this.options.helper&&this._setPositionRelative(),this.options.addClasses&&this.element.addClass("ui-draggable"),this.options.disabled&&this.element.addClass("ui-draggable-disabled"),this._setHandleClassName(),this._mouseInit()},_setOption:function(t,e){this._super(t,e),"handle"===t&&(this._removeHandleClassName(),this._setHandleClassName())},_destroy:function(){return(this.helper||this.element).is(".ui-draggable-dragging")?(this.destroyOnClear=!0,void 0):(this.element.removeClass("ui-draggable ui-draggable-dragging ui-draggable-disabled"),this._removeHandleClassName(),this._mouseDestroy(),void 0)},_mouseCapture:function(e){var i=this.options;return this._blurActiveElement(e),this.helper||i.disabled||t(e.target).closest(".ui-resizable-handle").length>0?!1:(this.handle=this._getHandle(e),this.handle?(this._blockFrames(i.iframeFix===!0?"iframe":i.iframeFix),!0):!1)},_blockFrames:function(e){this.iframeBlocks=this.document.find(e).map(function(){var e=t(this);return t("<div>").css("position","absolute").appendTo(e.parent()).outerWidth(e.outerWidth()).outerHeight(e.outerHeight()).offset(e.offset())[0]})},_unblockFrames:function(){this.iframeBlocks&&(this.iframeBlocks.remove(),delete this.iframeBlocks)},_blurActiveElement:function(e){var i=this.document[0];if(this.handleElement.is(e.target))try{i.activeElement&&"body"!==i.activeElement.nodeName.toLowerCase()&&t(i.activeElement).blur()}catch(s){}},_mouseStart:function(e){var i=this.options;return this.helper=this._createHelper(e),this.helper.addClass("ui-draggable-dragging"),this._cacheHelperProportions(),t.ui.ddmanager&&(t.ui.ddmanager.current=this),this._cacheMargins(),this.cssPosition=this.helper.css("position"),this.scrollParent=this.helper.scrollParent(!0),this.offsetParent=this.helper.offsetParent(),this.hasFixedAncestor=this.helper.parents().filter(function(){return"fixed"===t(this).css("position")}).length>0,this.positionAbs=this.element.offset(),this._refreshOffsets(e),this.originalPosition=this.position=this._generatePosition(e,!1),this.originalPageX=e.pageX,this.originalPageY=e.pageY,i.cursorAt&&this._adjustOffsetFromHelper(i.cursorAt),this._setContainment(),this._trigger("start",e)===!1?(this._clear(),!1):(this._cacheHelperProportions(),t.ui.ddmanager&&!i.dropBehaviour&&t.ui.ddmanager.prepareOffsets(this,e),this._normalizeRightBottom(),this._mouseDrag(e,!0),t.ui.ddmanager&&t.ui.ddmanager.dragStart(this,e),!0)},_refreshOffsets:function(t){this.offset={top:this.positionAbs.top-this.margins.top,left:this.positionAbs.left-this.margins.left,scroll:!1,parent:this._getParentOffset(),relative:this._getRelativeOffset()},this.offset.click={left:t.pageX-this.offset.left,top:t.pageY-this.offset.top}},_mouseDrag:function(e,i){if(this.hasFixedAncestor&&(this.offset.parent=this._getParentOffset()),this.position=this._generatePosition(e,!0),this.positionAbs=this._convertPositionTo("absolute"),!i){var s=this._uiHash();if(this._trigger("drag",e,s)===!1)return this._mouseUp({}),!1;this.position=s.position}return this.helper[0].style.left=this.position.left+"px",this.helper[0].style.top=this.position.top+"px",t.ui.ddmanager&&t.ui.ddmanager.drag(this,e),!1},_mouseStop:function(e){var i=this,s=!1;return t.ui.ddmanager&&!this.options.dropBehaviour&&(s=t.ui.ddmanager.drop(this,e)),this.dropped&&(s=this.dropped,this.dropped=!1),"invalid"===this.options.revert&&!s||"valid"===this.options.revert&&s||this.options.revert===!0||t.isFunction(this.options.revert)&&this.options.revert.call(this.element,s)?t(this.helper).animate(this.originalPosition,parseInt(this.options.revertDuration,10),function(){i._trigger("stop",e)!==!1&&i._clear()}):this._trigger("stop",e)!==!1&&this._clear(),!1},_mouseUp:function(e){return this._unblockFrames(),t.ui.ddmanager&&t.ui.ddmanager.dragStop(this,e),this.handleElement.is(e.target)&&this.element.focus(),t.ui.mouse.prototype._mouseUp.call(this,e)},cancel:function(){return this.helper.is(".ui-draggable-dragging")?this._mouseUp({}):this._clear(),this},_getHandle:function(e){return this.options.handle?!!t(e.target).closest(this.element.find(this.options.handle)).length:!0},_setHandleClassName:function(){this.handleElement=this.options.handle?this.element.find(this.options.handle):this.element,this.handleElement.addClass("ui-draggable-handle")},_removeHandleClassName:function(){this.handleElement.removeClass("ui-draggable-handle")},_createHelper:function(e){var i=this.options,s=t.isFunction(i.helper),n=s?t(i.helper.apply(this.element[0],[e])):"clone"===i.helper?this.element.clone().removeAttr("id"):this.element;return n.parents("body").length||n.appendTo("parent"===i.appendTo?this.element[0].parentNode:i.appendTo),s&&n[0]===this.element[0]&&this._setPositionRelative(),n[0]===this.element[0]||/(fixed|absolute)/.test(n.css("position"))||n.css("position","absolute"),n},_setPositionRelative:function(){/^(?:r|a|f)/.test(this.element.css("position"))||(this.element[0].style.position="relative")},_adjustOffsetFromHelper:function(e){"string"==typeof e&&(e=e.split(" ")),t.isArray(e)&&(e={left:+e[0],top:+e[1]||0}),"left"in e&&(this.offset.click.left=e.left+this.margins.left),"right"in e&&(this.offset.click.left=this.helperProportions.width-e.right+this.margins.left),"top"in e&&(this.offset.click.top=e.top+this.margins.top),"bottom"in e&&(this.offset.click.top=this.helperProportions.height-e.bottom+this.margins.top)},_isRootNode:function(t){return/(html|body)/i.test(t.tagName)||t===this.document[0]},_getParentOffset:function(){var e=this.offsetParent.offset(),i=this.document[0];return"absolute"===this.cssPosition&&this.scrollParent[0]!==i&&t.contains(this.scrollParent[0],this.offsetParent[0])&&(e.left+=this.scrollParent.scrollLeft(),e.top+=this.scrollParent.scrollTop()),this._isRootNode(this.offsetParent[0])&&(e={top:0,left:0}),{top:e.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:e.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if("relative"!==this.cssPosition)return{top:0,left:0};var t=this.element.position(),e=this._isRootNode(this.scrollParent[0]);return{top:t.top-(parseInt(this.helper.css("top"),10)||0)+(e?0:this.scrollParent.scrollTop()),left:t.left-(parseInt(this.helper.css("left"),10)||0)+(e?0:this.scrollParent.scrollLeft())}},_cacheMargins:function(){this.margins={left:parseInt(this.element.css("marginLeft"),10)||0,top:parseInt(this.element.css("marginTop"),10)||0,right:parseInt(this.element.css("marginRight"),10)||0,bottom:parseInt(this.element.css("marginBottom"),10)||0}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var e,i,s,n=this.options,a=this.document[0];return this.relativeContainer=null,n.containment?"window"===n.containment?(this.containment=[t(window).scrollLeft()-this.offset.relative.left-this.offset.parent.left,t(window).scrollTop()-this.offset.relative.top-this.offset.parent.top,t(window).scrollLeft()+t(window).width()-this.helperProportions.width-this.margins.left,t(window).scrollTop()+(t(window).height()||a.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top],void 0):"document"===n.containment?(this.containment=[0,0,t(a).width()-this.helperProportions.width-this.margins.left,(t(a).height()||a.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top],void 0):n.containment.constructor===Array?(this.containment=n.containment,void 0):("parent"===n.containment&&(n.containment=this.helper[0].parentNode),i=t(n.containment),s=i[0],s&&(e=/(scroll|auto)/.test(i.css("overflow")),this.containment=[(parseInt(i.css("borderLeftWidth"),10)||0)+(parseInt(i.css("paddingLeft"),10)||0),(parseInt(i.css("borderTopWidth"),10)||0)+(parseInt(i.css("paddingTop"),10)||0),(e?Math.max(s.scrollWidth,s.offsetWidth):s.offsetWidth)-(parseInt(i.css("borderRightWidth"),10)||0)-(parseInt(i.css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left-this.margins.right,(e?Math.max(s.scrollHeight,s.offsetHeight):s.offsetHeight)-(parseInt(i.css("borderBottomWidth"),10)||0)-(parseInt(i.css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top-this.margins.bottom],this.relativeContainer=i),void 0):(this.containment=null,void 0)},_convertPositionTo:function(t,e){e||(e=this.position);var i="absolute"===t?1:-1,s=this._isRootNode(this.scrollParent[0]);return{top:e.top+this.offset.relative.top*i+this.offset.parent.top*i-("fixed"===this.cssPosition?-this.offset.scroll.top:s?0:this.offset.scroll.top)*i,left:e.left+this.offset.relative.left*i+this.offset.parent.left*i-("fixed"===this.cssPosition?-this.offset.scroll.left:s?0:this.offset.scroll.left)*i}},_generatePosition:function(t,e){var i,s,n,a,o=this.options,r=this._isRootNode(this.scrollParent[0]),h=t.pageX,l=t.pageY;return r&&this.offset.scroll||(this.offset.scroll={top:this.scrollParent.scrollTop(),left:this.scrollParent.scrollLeft()}),e&&(this.containment&&(this.relativeContainer?(s=this.relativeContainer.offset(),i=[this.containment[0]+s.left,this.containment[1]+s.top,this.containment[2]+s.left,this.containment[3]+s.top]):i=this.containment,t.pageX-this.offset.click.left<i[0]&&(h=i[0]+this.offset.click.left),t.pageY-this.offset.click.top<i[1]&&(l=i[1]+this.offset.click.top),t.pageX-this.offset.click.left>i[2]&&(h=i[2]+this.offset.click.left),t.pageY-this.offset.click.top>i[3]&&(l=i[3]+this.offset.click.top)),o.grid&&(n=o.grid[1]?this.originalPageY+Math.round((l-this.originalPageY)/o.grid[1])*o.grid[1]:this.originalPageY,l=i?n-this.offset.click.top>=i[1]||n-this.offset.click.top>i[3]?n:n-this.offset.click.top>=i[1]?n-o.grid[1]:n+o.grid[1]:n,a=o.grid[0]?this.originalPageX+Math.round((h-this.originalPageX)/o.grid[0])*o.grid[0]:this.originalPageX,h=i?a-this.offset.click.left>=i[0]||a-this.offset.click.left>i[2]?a:a-this.offset.click.left>=i[0]?a-o.grid[0]:a+o.grid[0]:a),"y"===o.axis&&(h=this.originalPageX),"x"===o.axis&&(l=this.originalPageY)),{top:l-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+("fixed"===this.cssPosition?-this.offset.scroll.top:r?0:this.offset.scroll.top),left:h-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+("fixed"===this.cssPosition?-this.offset.scroll.left:r?0:this.offset.scroll.left)}},_clear:function(){this.helper.removeClass("ui-draggable-dragging"),this.helper[0]===this.element[0]||this.cancelHelperRemoval||this.helper.remove(),this.helper=null,this.cancelHelperRemoval=!1,this.destroyOnClear&&this.destroy()},_normalizeRightBottom:function(){"y"!==this.options.axis&&"auto"!==this.helper.css("right")&&(this.helper.width(this.helper.width()),this.helper.css("right","auto")),"x"!==this.options.axis&&"auto"!==this.helper.css("bottom")&&(this.helper.height(this.helper.height()),this.helper.css("bottom","auto"))},_trigger:function(e,i,s){return s=s||this._uiHash(),t.ui.plugin.call(this,e,[i,s,this],!0),/^(drag|start|stop)/.test(e)&&(this.positionAbs=this._convertPositionTo("absolute"),s.offset=this.positionAbs),t.Widget.prototype._trigger.call(this,e,i,s)},plugins:{},_uiHash:function(){return{helper:this.helper,position:this.position,originalPosition:this.originalPosition,offset:this.positionAbs}}}),t.ui.plugin.add("draggable","connectToSortable",{start:function(e,i,s){var n=t.extend({},i,{item:s.element});s.sortables=[],t(s.options.connectToSortable).each(function(){var i=t(this).sortable("instance");i&&!i.options.disabled&&(s.sortables.push(i),i.refreshPositions(),i._trigger("activate",e,n))})},stop:function(e,i,s){var n=t.extend({},i,{item:s.element});s.cancelHelperRemoval=!1,t.each(s.sortables,function(){var t=this;t.isOver?(t.isOver=0,s.cancelHelperRemoval=!0,t.cancelHelperRemoval=!1,t._storedCSS={position:t.placeholder.css("position"),top:t.placeholder.css("top"),left:t.placeholder.css("left")},t._mouseStop(e),t.options.helper=t.options._helper):(t.cancelHelperRemoval=!0,t._trigger("deactivate",e,n))})},drag:function(e,i,s){t.each(s.sortables,function(){var n=!1,a=this;a.positionAbs=s.positionAbs,a.helperProportions=s.helperProportions,a.offset.click=s.offset.click,a._intersectsWith(a.containerCache)&&(n=!0,t.each(s.sortables,function(){return this.positionAbs=s.positionAbs,this.helperProportions=s.helperProportions,this.offset.click=s.offset.click,this!==a&&this._intersectsWith(this.containerCache)&&t.contains(a.element[0],this.element[0])&&(n=!1),n
})),n?(a.isOver||(a.isOver=1,s._parent=i.helper.parent(),a.currentItem=i.helper.appendTo(a.element).data("ui-sortable-item",!0),a.options._helper=a.options.helper,a.options.helper=function(){return i.helper[0]},e.target=a.currentItem[0],a._mouseCapture(e,!0),a._mouseStart(e,!0,!0),a.offset.click.top=s.offset.click.top,a.offset.click.left=s.offset.click.left,a.offset.parent.left-=s.offset.parent.left-a.offset.parent.left,a.offset.parent.top-=s.offset.parent.top-a.offset.parent.top,s._trigger("toSortable",e),s.dropped=a.element,t.each(s.sortables,function(){this.refreshPositions()}),s.currentItem=s.element,a.fromOutside=s),a.currentItem&&(a._mouseDrag(e),i.position=a.position)):a.isOver&&(a.isOver=0,a.cancelHelperRemoval=!0,a.options._revert=a.options.revert,a.options.revert=!1,a._trigger("out",e,a._uiHash(a)),a._mouseStop(e,!0),a.options.revert=a.options._revert,a.options.helper=a.options._helper,a.placeholder&&a.placeholder.remove(),i.helper.appendTo(s._parent),s._refreshOffsets(e),i.position=s._generatePosition(e,!0),s._trigger("fromSortable",e),s.dropped=!1,t.each(s.sortables,function(){this.refreshPositions()}))})}}),t.ui.plugin.add("draggable","cursor",{start:function(e,i,s){var n=t("body"),a=s.options;n.css("cursor")&&(a._cursor=n.css("cursor")),n.css("cursor",a.cursor)},stop:function(e,i,s){var n=s.options;n._cursor&&t("body").css("cursor",n._cursor)}}),t.ui.plugin.add("draggable","opacity",{start:function(e,i,s){var n=t(i.helper),a=s.options;n.css("opacity")&&(a._opacity=n.css("opacity")),n.css("opacity",a.opacity)},stop:function(e,i,s){var n=s.options;n._opacity&&t(i.helper).css("opacity",n._opacity)}}),t.ui.plugin.add("draggable","scroll",{start:function(t,e,i){i.scrollParentNotHidden||(i.scrollParentNotHidden=i.helper.scrollParent(!1)),i.scrollParentNotHidden[0]!==i.document[0]&&"HTML"!==i.scrollParentNotHidden[0].tagName&&(i.overflowOffset=i.scrollParentNotHidden.offset())},drag:function(e,i,s){var n=s.options,a=!1,o=s.scrollParentNotHidden[0],r=s.document[0];o!==r&&"HTML"!==o.tagName?(n.axis&&"x"===n.axis||(s.overflowOffset.top+o.offsetHeight-e.pageY<n.scrollSensitivity?o.scrollTop=a=o.scrollTop+n.scrollSpeed:e.pageY-s.overflowOffset.top<n.scrollSensitivity&&(o.scrollTop=a=o.scrollTop-n.scrollSpeed)),n.axis&&"y"===n.axis||(s.overflowOffset.left+o.offsetWidth-e.pageX<n.scrollSensitivity?o.scrollLeft=a=o.scrollLeft+n.scrollSpeed:e.pageX-s.overflowOffset.left<n.scrollSensitivity&&(o.scrollLeft=a=o.scrollLeft-n.scrollSpeed))):(n.axis&&"x"===n.axis||(e.pageY-t(r).scrollTop()<n.scrollSensitivity?a=t(r).scrollTop(t(r).scrollTop()-n.scrollSpeed):t(window).height()-(e.pageY-t(r).scrollTop())<n.scrollSensitivity&&(a=t(r).scrollTop(t(r).scrollTop()+n.scrollSpeed))),n.axis&&"y"===n.axis||(e.pageX-t(r).scrollLeft()<n.scrollSensitivity?a=t(r).scrollLeft(t(r).scrollLeft()-n.scrollSpeed):t(window).width()-(e.pageX-t(r).scrollLeft())<n.scrollSensitivity&&(a=t(r).scrollLeft(t(r).scrollLeft()+n.scrollSpeed)))),a!==!1&&t.ui.ddmanager&&!n.dropBehaviour&&t.ui.ddmanager.prepareOffsets(s,e)}}),t.ui.plugin.add("draggable","snap",{start:function(e,i,s){var n=s.options;s.snapElements=[],t(n.snap.constructor!==String?n.snap.items||":data(ui-draggable)":n.snap).each(function(){var e=t(this),i=e.offset();this!==s.element[0]&&s.snapElements.push({item:this,width:e.outerWidth(),height:e.outerHeight(),top:i.top,left:i.left})})},drag:function(e,i,s){var n,a,o,r,h,l,u,c,d,p,f=s.options,m=f.snapTolerance,g=i.offset.left,v=g+s.helperProportions.width,_=i.offset.top,b=_+s.helperProportions.height;for(d=s.snapElements.length-1;d>=0;d--)h=s.snapElements[d].left-s.margins.left,l=h+s.snapElements[d].width,u=s.snapElements[d].top-s.margins.top,c=u+s.snapElements[d].height,h-m>v||g>l+m||u-m>b||_>c+m||!t.contains(s.snapElements[d].item.ownerDocument,s.snapElements[d].item)?(s.snapElements[d].snapping&&s.options.snap.release&&s.options.snap.release.call(s.element,e,t.extend(s._uiHash(),{snapItem:s.snapElements[d].item})),s.snapElements[d].snapping=!1):("inner"!==f.snapMode&&(n=m>=Math.abs(u-b),a=m>=Math.abs(c-_),o=m>=Math.abs(h-v),r=m>=Math.abs(l-g),n&&(i.position.top=s._convertPositionTo("relative",{top:u-s.helperProportions.height,left:0}).top),a&&(i.position.top=s._convertPositionTo("relative",{top:c,left:0}).top),o&&(i.position.left=s._convertPositionTo("relative",{top:0,left:h-s.helperProportions.width}).left),r&&(i.position.left=s._convertPositionTo("relative",{top:0,left:l}).left)),p=n||a||o||r,"outer"!==f.snapMode&&(n=m>=Math.abs(u-_),a=m>=Math.abs(c-b),o=m>=Math.abs(h-g),r=m>=Math.abs(l-v),n&&(i.position.top=s._convertPositionTo("relative",{top:u,left:0}).top),a&&(i.position.top=s._convertPositionTo("relative",{top:c-s.helperProportions.height,left:0}).top),o&&(i.position.left=s._convertPositionTo("relative",{top:0,left:h}).left),r&&(i.position.left=s._convertPositionTo("relative",{top:0,left:l-s.helperProportions.width}).left)),!s.snapElements[d].snapping&&(n||a||o||r||p)&&s.options.snap.snap&&s.options.snap.snap.call(s.element,e,t.extend(s._uiHash(),{snapItem:s.snapElements[d].item})),s.snapElements[d].snapping=n||a||o||r||p)}}),t.ui.plugin.add("draggable","stack",{start:function(e,i,s){var n,a=s.options,o=t.makeArray(t(a.stack)).sort(function(e,i){return(parseInt(t(e).css("zIndex"),10)||0)-(parseInt(t(i).css("zIndex"),10)||0)});o.length&&(n=parseInt(t(o[0]).css("zIndex"),10)||0,t(o).each(function(e){t(this).css("zIndex",n+e)}),this.css("zIndex",n+o.length))}}),t.ui.plugin.add("draggable","zIndex",{start:function(e,i,s){var n=t(i.helper),a=s.options;n.css("zIndex")&&(a._zIndex=n.css("zIndex")),n.css("zIndex",a.zIndex)},stop:function(e,i,s){var n=s.options;n._zIndex&&t(i.helper).css("zIndex",n._zIndex)}}),t.ui.draggable,t.widget("ui.droppable",{version:"1.11.4",widgetEventPrefix:"drop",options:{accept:"*",activeClass:!1,addClasses:!0,greedy:!1,hoverClass:!1,scope:"default",tolerance:"intersect",activate:null,deactivate:null,drop:null,out:null,over:null},_create:function(){var e,i=this.options,s=i.accept;this.isover=!1,this.isout=!0,this.accept=t.isFunction(s)?s:function(t){return t.is(s)},this.proportions=function(){return arguments.length?(e=arguments[0],void 0):e?e:e={width:this.element[0].offsetWidth,height:this.element[0].offsetHeight}},this._addToManager(i.scope),i.addClasses&&this.element.addClass("ui-droppable")},_addToManager:function(e){t.ui.ddmanager.droppables[e]=t.ui.ddmanager.droppables[e]||[],t.ui.ddmanager.droppables[e].push(this)},_splice:function(t){for(var e=0;t.length>e;e++)t[e]===this&&t.splice(e,1)},_destroy:function(){var e=t.ui.ddmanager.droppables[this.options.scope];this._splice(e),this.element.removeClass("ui-droppable ui-droppable-disabled")},_setOption:function(e,i){if("accept"===e)this.accept=t.isFunction(i)?i:function(t){return t.is(i)};else if("scope"===e){var s=t.ui.ddmanager.droppables[this.options.scope];this._splice(s),this._addToManager(i)}this._super(e,i)},_activate:function(e){var i=t.ui.ddmanager.current;this.options.activeClass&&this.element.addClass(this.options.activeClass),i&&this._trigger("activate",e,this.ui(i))},_deactivate:function(e){var i=t.ui.ddmanager.current;this.options.activeClass&&this.element.removeClass(this.options.activeClass),i&&this._trigger("deactivate",e,this.ui(i))},_over:function(e){var i=t.ui.ddmanager.current;i&&(i.currentItem||i.element)[0]!==this.element[0]&&this.accept.call(this.element[0],i.currentItem||i.element)&&(this.options.hoverClass&&this.element.addClass(this.options.hoverClass),this._trigger("over",e,this.ui(i)))},_out:function(e){var i=t.ui.ddmanager.current;i&&(i.currentItem||i.element)[0]!==this.element[0]&&this.accept.call(this.element[0],i.currentItem||i.element)&&(this.options.hoverClass&&this.element.removeClass(this.options.hoverClass),this._trigger("out",e,this.ui(i)))},_drop:function(e,i){var s=i||t.ui.ddmanager.current,n=!1;return s&&(s.currentItem||s.element)[0]!==this.element[0]?(this.element.find(":data(ui-droppable)").not(".ui-draggable-dragging").each(function(){var i=t(this).droppable("instance");return i.options.greedy&&!i.options.disabled&&i.options.scope===s.options.scope&&i.accept.call(i.element[0],s.currentItem||s.element)&&t.ui.intersect(s,t.extend(i,{offset:i.element.offset()}),i.options.tolerance,e)?(n=!0,!1):void 0}),n?!1:this.accept.call(this.element[0],s.currentItem||s.element)?(this.options.activeClass&&this.element.removeClass(this.options.activeClass),this.options.hoverClass&&this.element.removeClass(this.options.hoverClass),this._trigger("drop",e,this.ui(s)),this.element):!1):!1},ui:function(t){return{draggable:t.currentItem||t.element,helper:t.helper,position:t.position,offset:t.positionAbs}}}),t.ui.intersect=function(){function t(t,e,i){return t>=e&&e+i>t}return function(e,i,s,n){if(!i.offset)return!1;var a=(e.positionAbs||e.position.absolute).left+e.margins.left,o=(e.positionAbs||e.position.absolute).top+e.margins.top,r=a+e.helperProportions.width,h=o+e.helperProportions.height,l=i.offset.left,u=i.offset.top,c=l+i.proportions().width,d=u+i.proportions().height;switch(s){case"fit":return a>=l&&c>=r&&o>=u&&d>=h;case"intersect":return a+e.helperProportions.width/2>l&&c>r-e.helperProportions.width/2&&o+e.helperProportions.height/2>u&&d>h-e.helperProportions.height/2;case"pointer":return t(n.pageY,u,i.proportions().height)&&t(n.pageX,l,i.proportions().width);case"touch":return(o>=u&&d>=o||h>=u&&d>=h||u>o&&h>d)&&(a>=l&&c>=a||r>=l&&c>=r||l>a&&r>c);default:return!1}}}(),t.ui.ddmanager={current:null,droppables:{"default":[]},prepareOffsets:function(e,i){var s,n,a=t.ui.ddmanager.droppables[e.options.scope]||[],o=i?i.type:null,r=(e.currentItem||e.element).find(":data(ui-droppable)").addBack();t:for(s=0;a.length>s;s++)if(!(a[s].options.disabled||e&&!a[s].accept.call(a[s].element[0],e.currentItem||e.element))){for(n=0;r.length>n;n++)if(r[n]===a[s].element[0]){a[s].proportions().height=0;continue t}a[s].visible="none"!==a[s].element.css("display"),a[s].visible&&("mousedown"===o&&a[s]._activate.call(a[s],i),a[s].offset=a[s].element.offset(),a[s].proportions({width:a[s].element[0].offsetWidth,height:a[s].element[0].offsetHeight}))}},drop:function(e,i){var s=!1;return t.each((t.ui.ddmanager.droppables[e.options.scope]||[]).slice(),function(){this.options&&(!this.options.disabled&&this.visible&&t.ui.intersect(e,this,this.options.tolerance,i)&&(s=this._drop.call(this,i)||s),!this.options.disabled&&this.visible&&this.accept.call(this.element[0],e.currentItem||e.element)&&(this.isout=!0,this.isover=!1,this._deactivate.call(this,i)))}),s},dragStart:function(e,i){e.element.parentsUntil("body").bind("scroll.droppable",function(){e.options.refreshPositions||t.ui.ddmanager.prepareOffsets(e,i)})},drag:function(e,i){e.options.refreshPositions&&t.ui.ddmanager.prepareOffsets(e,i),t.each(t.ui.ddmanager.droppables[e.options.scope]||[],function(){if(!this.options.disabled&&!this.greedyChild&&this.visible){var s,n,a,o=t.ui.intersect(e,this,this.options.tolerance,i),r=!o&&this.isover?"isout":o&&!this.isover?"isover":null;r&&(this.options.greedy&&(n=this.options.scope,a=this.element.parents(":data(ui-droppable)").filter(function(){return t(this).droppable("instance").options.scope===n}),a.length&&(s=t(a[0]).droppable("instance"),s.greedyChild="isover"===r)),s&&"isover"===r&&(s.isover=!1,s.isout=!0,s._out.call(s,i)),this[r]=!0,this["isout"===r?"isover":"isout"]=!1,this["isover"===r?"_over":"_out"].call(this,i),s&&"isout"===r&&(s.isout=!1,s.isover=!0,s._over.call(s,i)))}})},dragStop:function(e,i){e.element.parentsUntil("body").unbind("scroll.droppable"),e.options.refreshPositions||t.ui.ddmanager.prepareOffsets(e,i)}},t.ui.droppable,t.widget("ui.resizable",t.ui.mouse,{version:"1.11.4",widgetEventPrefix:"resize",options:{alsoResize:!1,animate:!1,animateDuration:"slow",animateEasing:"swing",aspectRatio:!1,autoHide:!1,containment:!1,ghost:!1,grid:!1,handles:"e,s,se",helper:!1,maxHeight:null,maxWidth:null,minHeight:10,minWidth:10,zIndex:90,resize:null,start:null,stop:null},_num:function(t){return parseInt(t,10)||0},_isNumber:function(t){return!isNaN(parseInt(t,10))},_hasScroll:function(e,i){if("hidden"===t(e).css("overflow"))return!1;var s=i&&"left"===i?"scrollLeft":"scrollTop",n=!1;return e[s]>0?!0:(e[s]=1,n=e[s]>0,e[s]=0,n)},_create:function(){var e,i,s,n,a,o=this,r=this.options;if(this.element.addClass("ui-resizable"),t.extend(this,{_aspectRatio:!!r.aspectRatio,aspectRatio:r.aspectRatio,originalElement:this.element,_proportionallyResizeElements:[],_helper:r.helper||r.ghost||r.animate?r.helper||"ui-resizable-helper":null}),this.element[0].nodeName.match(/^(canvas|textarea|input|select|button|img)$/i)&&(this.element.wrap(t("<div class='ui-wrapper' style='overflow: hidden;'></div>").css({position:this.element.css("position"),width:this.element.outerWidth(),height:this.element.outerHeight(),top:this.element.css("top"),left:this.element.css("left")})),this.element=this.element.parent().data("ui-resizable",this.element.resizable("instance")),this.elementIsWrapper=!0,this.element.css({marginLeft:this.originalElement.css("marginLeft"),marginTop:this.originalElement.css("marginTop"),marginRight:this.originalElement.css("marginRight"),marginBottom:this.originalElement.css("marginBottom")}),this.originalElement.css({marginLeft:0,marginTop:0,marginRight:0,marginBottom:0}),this.originalResizeStyle=this.originalElement.css("resize"),this.originalElement.css("resize","none"),this._proportionallyResizeElements.push(this.originalElement.css({position:"static",zoom:1,display:"block"})),this.originalElement.css({margin:this.originalElement.css("margin")}),this._proportionallyResize()),this.handles=r.handles||(t(".ui-resizable-handle",this.element).length?{n:".ui-resizable-n",e:".ui-resizable-e",s:".ui-resizable-s",w:".ui-resizable-w",se:".ui-resizable-se",sw:".ui-resizable-sw",ne:".ui-resizable-ne",nw:".ui-resizable-nw"}:"e,s,se"),this._handles=t(),this.handles.constructor===String)for("all"===this.handles&&(this.handles="n,e,s,w,se,sw,ne,nw"),e=this.handles.split(","),this.handles={},i=0;e.length>i;i++)s=t.trim(e[i]),a="ui-resizable-"+s,n=t("<div class='ui-resizable-handle "+a+"'></div>"),n.css({zIndex:r.zIndex}),"se"===s&&n.addClass("ui-icon ui-icon-gripsmall-diagonal-se"),this.handles[s]=".ui-resizable-"+s,this.element.append(n);this._renderAxis=function(e){var i,s,n,a;e=e||this.element;for(i in this.handles)this.handles[i].constructor===String?this.handles[i]=this.element.children(this.handles[i]).first().show():(this.handles[i].jquery||this.handles[i].nodeType)&&(this.handles[i]=t(this.handles[i]),this._on(this.handles[i],{mousedown:o._mouseDown})),this.elementIsWrapper&&this.originalElement[0].nodeName.match(/^(textarea|input|select|button)$/i)&&(s=t(this.handles[i],this.element),a=/sw|ne|nw|se|n|s/.test(i)?s.outerHeight():s.outerWidth(),n=["padding",/ne|nw|n/.test(i)?"Top":/se|sw|s/.test(i)?"Bottom":/^e$/.test(i)?"Right":"Left"].join(""),e.css(n,a),this._proportionallyResize()),this._handles=this._handles.add(this.handles[i])},this._renderAxis(this.element),this._handles=this._handles.add(this.element.find(".ui-resizable-handle")),this._handles.disableSelection(),this._handles.mouseover(function(){o.resizing||(this.className&&(n=this.className.match(/ui-resizable-(se|sw|ne|nw|n|e|s|w)/i)),o.axis=n&&n[1]?n[1]:"se")}),r.autoHide&&(this._handles.hide(),t(this.element).addClass("ui-resizable-autohide").mouseenter(function(){r.disabled||(t(this).removeClass("ui-resizable-autohide"),o._handles.show())}).mouseleave(function(){r.disabled||o.resizing||(t(this).addClass("ui-resizable-autohide"),o._handles.hide())})),this._mouseInit()},_destroy:function(){this._mouseDestroy();var e,i=function(e){t(e).removeClass("ui-resizable ui-resizable-disabled ui-resizable-resizing").removeData("resizable").removeData("ui-resizable").unbind(".resizable").find(".ui-resizable-handle").remove()};return this.elementIsWrapper&&(i(this.element),e=this.element,this.originalElement.css({position:e.css("position"),width:e.outerWidth(),height:e.outerHeight(),top:e.css("top"),left:e.css("left")}).insertAfter(e),e.remove()),this.originalElement.css("resize",this.originalResizeStyle),i(this.originalElement),this},_mouseCapture:function(e){var i,s,n=!1;for(i in this.handles)s=t(this.handles[i])[0],(s===e.target||t.contains(s,e.target))&&(n=!0);return!this.options.disabled&&n},_mouseStart:function(e){var i,s,n,a=this.options,o=this.element;return this.resizing=!0,this._renderProxy(),i=this._num(this.helper.css("left")),s=this._num(this.helper.css("top")),a.containment&&(i+=t(a.containment).scrollLeft()||0,s+=t(a.containment).scrollTop()||0),this.offset=this.helper.offset(),this.position={left:i,top:s},this.size=this._helper?{width:this.helper.width(),height:this.helper.height()}:{width:o.width(),height:o.height()},this.originalSize=this._helper?{width:o.outerWidth(),height:o.outerHeight()}:{width:o.width(),height:o.height()},this.sizeDiff={width:o.outerWidth()-o.width(),height:o.outerHeight()-o.height()},this.originalPosition={left:i,top:s},this.originalMousePosition={left:e.pageX,top:e.pageY},this.aspectRatio="number"==typeof a.aspectRatio?a.aspectRatio:this.originalSize.width/this.originalSize.height||1,n=t(".ui-resizable-"+this.axis).css("cursor"),t("body").css("cursor","auto"===n?this.axis+"-resize":n),o.addClass("ui-resizable-resizing"),this._propagate("start",e),!0},_mouseDrag:function(e){var i,s,n=this.originalMousePosition,a=this.axis,o=e.pageX-n.left||0,r=e.pageY-n.top||0,h=this._change[a];return this._updatePrevProperties(),h?(i=h.apply(this,[e,o,r]),this._updateVirtualBoundaries(e.shiftKey),(this._aspectRatio||e.shiftKey)&&(i=this._updateRatio(i,e)),i=this._respectSize(i,e),this._updateCache(i),this._propagate("resize",e),s=this._applyChanges(),!this._helper&&this._proportionallyResizeElements.length&&this._proportionallyResize(),t.isEmptyObject(s)||(this._updatePrevProperties(),this._trigger("resize",e,this.ui()),this._applyChanges()),!1):!1},_mouseStop:function(e){this.resizing=!1;var i,s,n,a,o,r,h,l=this.options,u=this;return this._helper&&(i=this._proportionallyResizeElements,s=i.length&&/textarea/i.test(i[0].nodeName),n=s&&this._hasScroll(i[0],"left")?0:u.sizeDiff.height,a=s?0:u.sizeDiff.width,o={width:u.helper.width()-a,height:u.helper.height()-n},r=parseInt(u.element.css("left"),10)+(u.position.left-u.originalPosition.left)||null,h=parseInt(u.element.css("top"),10)+(u.position.top-u.originalPosition.top)||null,l.animate||this.element.css(t.extend(o,{top:h,left:r})),u.helper.height(u.size.height),u.helper.width(u.size.width),this._helper&&!l.animate&&this._proportionallyResize()),t("body").css("cursor","auto"),this.element.removeClass("ui-resizable-resizing"),this._propagate("stop",e),this._helper&&this.helper.remove(),!1},_updatePrevProperties:function(){this.prevPosition={top:this.position.top,left:this.position.left},this.prevSize={width:this.size.width,height:this.size.height}},_applyChanges:function(){var t={};return this.position.top!==this.prevPosition.top&&(t.top=this.position.top+"px"),this.position.left!==this.prevPosition.left&&(t.left=this.position.left+"px"),this.size.width!==this.prevSize.width&&(t.width=this.size.width+"px"),this.size.height!==this.prevSize.height&&(t.height=this.size.height+"px"),this.helper.css(t),t},_updateVirtualBoundaries:function(t){var e,i,s,n,a,o=this.options;a={minWidth:this._isNumber(o.minWidth)?o.minWidth:0,maxWidth:this._isNumber(o.maxWidth)?o.maxWidth:1/0,minHeight:this._isNumber(o.minHeight)?o.minHeight:0,maxHeight:this._isNumber(o.maxHeight)?o.maxHeight:1/0},(this._aspectRatio||t)&&(e=a.minHeight*this.aspectRatio,s=a.minWidth/this.aspectRatio,i=a.maxHeight*this.aspectRatio,n=a.maxWidth/this.aspectRatio,e>a.minWidth&&(a.minWidth=e),s>a.minHeight&&(a.minHeight=s),a.maxWidth>i&&(a.maxWidth=i),a.maxHeight>n&&(a.maxHeight=n)),this._vBoundaries=a},_updateCache:function(t){this.offset=this.helper.offset(),this._isNumber(t.left)&&(this.position.left=t.left),this._isNumber(t.top)&&(this.position.top=t.top),this._isNumber(t.height)&&(this.size.height=t.height),this._isNumber(t.width)&&(this.size.width=t.width)},_updateRatio:function(t){var e=this.position,i=this.size,s=this.axis;return this._isNumber(t.height)?t.width=t.height*this.aspectRatio:this._isNumber(t.width)&&(t.height=t.width/this.aspectRatio),"sw"===s&&(t.left=e.left+(i.width-t.width),t.top=null),"nw"===s&&(t.top=e.top+(i.height-t.height),t.left=e.left+(i.width-t.width)),t},_respectSize:function(t){var e=this._vBoundaries,i=this.axis,s=this._isNumber(t.width)&&e.maxWidth&&e.maxWidth<t.width,n=this._isNumber(t.height)&&e.maxHeight&&e.maxHeight<t.height,a=this._isNumber(t.width)&&e.minWidth&&e.minWidth>t.width,o=this._isNumber(t.height)&&e.minHeight&&e.minHeight>t.height,r=this.originalPosition.left+this.originalSize.width,h=this.position.top+this.size.height,l=/sw|nw|w/.test(i),u=/nw|ne|n/.test(i);return a&&(t.width=e.minWidth),o&&(t.height=e.minHeight),s&&(t.width=e.maxWidth),n&&(t.height=e.maxHeight),a&&l&&(t.left=r-e.minWidth),s&&l&&(t.left=r-e.maxWidth),o&&u&&(t.top=h-e.minHeight),n&&u&&(t.top=h-e.maxHeight),t.width||t.height||t.left||!t.top?t.width||t.height||t.top||!t.left||(t.left=null):t.top=null,t},_getPaddingPlusBorderDimensions:function(t){for(var e=0,i=[],s=[t.css("borderTopWidth"),t.css("borderRightWidth"),t.css("borderBottomWidth"),t.css("borderLeftWidth")],n=[t.css("paddingTop"),t.css("paddingRight"),t.css("paddingBottom"),t.css("paddingLeft")];4>e;e++)i[e]=parseInt(s[e],10)||0,i[e]+=parseInt(n[e],10)||0;return{height:i[0]+i[2],width:i[1]+i[3]}},_proportionallyResize:function(){if(this._proportionallyResizeElements.length)for(var t,e=0,i=this.helper||this.element;this._proportionallyResizeElements.length>e;e++)t=this._proportionallyResizeElements[e],this.outerDimensions||(this.outerDimensions=this._getPaddingPlusBorderDimensions(t)),t.css({height:i.height()-this.outerDimensions.height||0,width:i.width()-this.outerDimensions.width||0})},_renderProxy:function(){var e=this.element,i=this.options;this.elementOffset=e.offset(),this._helper?(this.helper=this.helper||t("<div style='overflow:hidden;'></div>"),this.helper.addClass(this._helper).css({width:this.element.outerWidth()-1,height:this.element.outerHeight()-1,position:"absolute",left:this.elementOffset.left+"px",top:this.elementOffset.top+"px",zIndex:++i.zIndex}),this.helper.appendTo("body").disableSelection()):this.helper=this.element},_change:{e:function(t,e){return{width:this.originalSize.width+e}},w:function(t,e){var i=this.originalSize,s=this.originalPosition;return{left:s.left+e,width:i.width-e}},n:function(t,e,i){var s=this.originalSize,n=this.originalPosition;return{top:n.top+i,height:s.height-i}},s:function(t,e,i){return{height:this.originalSize.height+i}},se:function(e,i,s){return t.extend(this._change.s.apply(this,arguments),this._change.e.apply(this,[e,i,s]))},sw:function(e,i,s){return t.extend(this._change.s.apply(this,arguments),this._change.w.apply(this,[e,i,s]))},ne:function(e,i,s){return t.extend(this._change.n.apply(this,arguments),this._change.e.apply(this,[e,i,s]))},nw:function(e,i,s){return t.extend(this._change.n.apply(this,arguments),this._change.w.apply(this,[e,i,s]))}},_propagate:function(e,i){t.ui.plugin.call(this,e,[i,this.ui()]),"resize"!==e&&this._trigger(e,i,this.ui())},plugins:{},ui:function(){return{originalElement:this.originalElement,element:this.element,helper:this.helper,position:this.position,size:this.size,originalSize:this.originalSize,originalPosition:this.originalPosition}}}),t.ui.plugin.add("resizable","animate",{stop:function(e){var i=t(this).resizable("instance"),s=i.options,n=i._proportionallyResizeElements,a=n.length&&/textarea/i.test(n[0].nodeName),o=a&&i._hasScroll(n[0],"left")?0:i.sizeDiff.height,r=a?0:i.sizeDiff.width,h={width:i.size.width-r,height:i.size.height-o},l=parseInt(i.element.css("left"),10)+(i.position.left-i.originalPosition.left)||null,u=parseInt(i.element.css("top"),10)+(i.position.top-i.originalPosition.top)||null;i.element.animate(t.extend(h,u&&l?{top:u,left:l}:{}),{duration:s.animateDuration,easing:s.animateEasing,step:function(){var s={width:parseInt(i.element.css("width"),10),height:parseInt(i.element.css("height"),10),top:parseInt(i.element.css("top"),10),left:parseInt(i.element.css("left"),10)};n&&n.length&&t(n[0]).css({width:s.width,height:s.height}),i._updateCache(s),i._propagate("resize",e)}})}}),t.ui.plugin.add("resizable","containment",{start:function(){var e,i,s,n,a,o,r,h=t(this).resizable("instance"),l=h.options,u=h.element,c=l.containment,d=c instanceof t?c.get(0):/parent/.test(c)?u.parent().get(0):c;d&&(h.containerElement=t(d),/document/.test(c)||c===document?(h.containerOffset={left:0,top:0},h.containerPosition={left:0,top:0},h.parentData={element:t(document),left:0,top:0,width:t(document).width(),height:t(document).height()||document.body.parentNode.scrollHeight}):(e=t(d),i=[],t(["Top","Right","Left","Bottom"]).each(function(t,s){i[t]=h._num(e.css("padding"+s))}),h.containerOffset=e.offset(),h.containerPosition=e.position(),h.containerSize={height:e.innerHeight()-i[3],width:e.innerWidth()-i[1]},s=h.containerOffset,n=h.containerSize.height,a=h.containerSize.width,o=h._hasScroll(d,"left")?d.scrollWidth:a,r=h._hasScroll(d)?d.scrollHeight:n,h.parentData={element:d,left:s.left,top:s.top,width:o,height:r}))},resize:function(e){var i,s,n,a,o=t(this).resizable("instance"),r=o.options,h=o.containerOffset,l=o.position,u=o._aspectRatio||e.shiftKey,c={top:0,left:0},d=o.containerElement,p=!0;d[0]!==document&&/static/.test(d.css("position"))&&(c=h),l.left<(o._helper?h.left:0)&&(o.size.width=o.size.width+(o._helper?o.position.left-h.left:o.position.left-c.left),u&&(o.size.height=o.size.width/o.aspectRatio,p=!1),o.position.left=r.helper?h.left:0),l.top<(o._helper?h.top:0)&&(o.size.height=o.size.height+(o._helper?o.position.top-h.top:o.position.top),u&&(o.size.width=o.size.height*o.aspectRatio,p=!1),o.position.top=o._helper?h.top:0),n=o.containerElement.get(0)===o.element.parent().get(0),a=/relative|absolute/.test(o.containerElement.css("position")),n&&a?(o.offset.left=o.parentData.left+o.position.left,o.offset.top=o.parentData.top+o.position.top):(o.offset.left=o.element.offset().left,o.offset.top=o.element.offset().top),i=Math.abs(o.sizeDiff.width+(o._helper?o.offset.left-c.left:o.offset.left-h.left)),s=Math.abs(o.sizeDiff.height+(o._helper?o.offset.top-c.top:o.offset.top-h.top)),i+o.size.width>=o.parentData.width&&(o.size.width=o.parentData.width-i,u&&(o.size.height=o.size.width/o.aspectRatio,p=!1)),s+o.size.height>=o.parentData.height&&(o.size.height=o.parentData.height-s,u&&(o.size.width=o.size.height*o.aspectRatio,p=!1)),p||(o.position.left=o.prevPosition.left,o.position.top=o.prevPosition.top,o.size.width=o.prevSize.width,o.size.height=o.prevSize.height)},stop:function(){var e=t(this).resizable("instance"),i=e.options,s=e.containerOffset,n=e.containerPosition,a=e.containerElement,o=t(e.helper),r=o.offset(),h=o.outerWidth()-e.sizeDiff.width,l=o.outerHeight()-e.sizeDiff.height;e._helper&&!i.animate&&/relative/.test(a.css("position"))&&t(this).css({left:r.left-n.left-s.left,width:h,height:l}),e._helper&&!i.animate&&/static/.test(a.css("position"))&&t(this).css({left:r.left-n.left-s.left,width:h,height:l})}}),t.ui.plugin.add("resizable","alsoResize",{start:function(){var e=t(this).resizable("instance"),i=e.options;t(i.alsoResize).each(function(){var e=t(this);e.data("ui-resizable-alsoresize",{width:parseInt(e.width(),10),height:parseInt(e.height(),10),left:parseInt(e.css("left"),10),top:parseInt(e.css("top"),10)})})},resize:function(e,i){var s=t(this).resizable("instance"),n=s.options,a=s.originalSize,o=s.originalPosition,r={height:s.size.height-a.height||0,width:s.size.width-a.width||0,top:s.position.top-o.top||0,left:s.position.left-o.left||0};t(n.alsoResize).each(function(){var e=t(this),s=t(this).data("ui-resizable-alsoresize"),n={},a=e.parents(i.originalElement[0]).length?["width","height"]:["width","height","top","left"];t.each(a,function(t,e){var i=(s[e]||0)+(r[e]||0);i&&i>=0&&(n[e]=i||null)}),e.css(n)})},stop:function(){t(this).removeData("resizable-alsoresize")}}),t.ui.plugin.add("resizable","ghost",{start:function(){var e=t(this).resizable("instance"),i=e.options,s=e.size;e.ghost=e.originalElement.clone(),e.ghost.css({opacity:.25,display:"block",position:"relative",height:s.height,width:s.width,margin:0,left:0,top:0}).addClass("ui-resizable-ghost").addClass("string"==typeof i.ghost?i.ghost:""),e.ghost.appendTo(e.helper)},resize:function(){var e=t(this).resizable("instance");e.ghost&&e.ghost.css({position:"relative",height:e.size.height,width:e.size.width})},stop:function(){var e=t(this).resizable("instance");e.ghost&&e.helper&&e.helper.get(0).removeChild(e.ghost.get(0))}}),t.ui.plugin.add("resizable","grid",{resize:function(){var e,i=t(this).resizable("instance"),s=i.options,n=i.size,a=i.originalSize,o=i.originalPosition,r=i.axis,h="number"==typeof s.grid?[s.grid,s.grid]:s.grid,l=h[0]||1,u=h[1]||1,c=Math.round((n.width-a.width)/l)*l,d=Math.round((n.height-a.height)/u)*u,p=a.width+c,f=a.height+d,m=s.maxWidth&&p>s.maxWidth,g=s.maxHeight&&f>s.maxHeight,v=s.minWidth&&s.minWidth>p,_=s.minHeight&&s.minHeight>f;s.grid=h,v&&(p+=l),_&&(f+=u),m&&(p-=l),g&&(f-=u),/^(se|s|e)$/.test(r)?(i.size.width=p,i.size.height=f):/^(ne)$/.test(r)?(i.size.width=p,i.size.height=f,i.position.top=o.top-d):/^(sw)$/.test(r)?(i.size.width=p,i.size.height=f,i.position.left=o.left-c):((0>=f-u||0>=p-l)&&(e=i._getPaddingPlusBorderDimensions(this)),f-u>0?(i.size.height=f,i.position.top=o.top-d):(f=u-e.height,i.size.height=f,i.position.top=o.top+a.height-f),p-l>0?(i.size.width=p,i.position.left=o.left-c):(p=l-e.width,i.size.width=p,i.position.left=o.left+a.width-p))}}),t.ui.resizable,t.widget("ui.selectable",t.ui.mouse,{version:"1.11.4",options:{appendTo:"body",autoRefresh:!0,distance:0,filter:"*",tolerance:"touch",selected:null,selecting:null,start:null,stop:null,unselected:null,unselecting:null},_create:function(){var e,i=this;this.element.addClass("ui-selectable"),this.dragged=!1,this.refresh=function(){e=t(i.options.filter,i.element[0]),e.addClass("ui-selectee"),e.each(function(){var e=t(this),i=e.offset();t.data(this,"selectable-item",{element:this,$element:e,left:i.left,top:i.top,right:i.left+e.outerWidth(),bottom:i.top+e.outerHeight(),startselected:!1,selected:e.hasClass("ui-selected"),selecting:e.hasClass("ui-selecting"),unselecting:e.hasClass("ui-unselecting")})})},this.refresh(),this.selectees=e.addClass("ui-selectee"),this._mouseInit(),this.helper=t("<div class='ui-selectable-helper'></div>")},_destroy:function(){this.selectees.removeClass("ui-selectee").removeData("selectable-item"),this.element.removeClass("ui-selectable ui-selectable-disabled"),this._mouseDestroy()},_mouseStart:function(e){var i=this,s=this.options;this.opos=[e.pageX,e.pageY],this.options.disabled||(this.selectees=t(s.filter,this.element[0]),this._trigger("start",e),t(s.appendTo).append(this.helper),this.helper.css({left:e.pageX,top:e.pageY,width:0,height:0}),s.autoRefresh&&this.refresh(),this.selectees.filter(".ui-selected").each(function(){var s=t.data(this,"selectable-item");s.startselected=!0,e.metaKey||e.ctrlKey||(s.$element.removeClass("ui-selected"),s.selected=!1,s.$element.addClass("ui-unselecting"),s.unselecting=!0,i._trigger("unselecting",e,{unselecting:s.element}))}),t(e.target).parents().addBack().each(function(){var s,n=t.data(this,"selectable-item");return n?(s=!e.metaKey&&!e.ctrlKey||!n.$element.hasClass("ui-selected"),n.$element.removeClass(s?"ui-unselecting":"ui-selected").addClass(s?"ui-selecting":"ui-unselecting"),n.unselecting=!s,n.selecting=s,n.selected=s,s?i._trigger("selecting",e,{selecting:n.element}):i._trigger("unselecting",e,{unselecting:n.element}),!1):void 0}))},_mouseDrag:function(e){if(this.dragged=!0,!this.options.disabled){var i,s=this,n=this.options,a=this.opos[0],o=this.opos[1],r=e.pageX,h=e.pageY;return a>r&&(i=r,r=a,a=i),o>h&&(i=h,h=o,o=i),this.helper.css({left:a,top:o,width:r-a,height:h-o}),this.selectees.each(function(){var i=t.data(this,"selectable-item"),l=!1;
i&&i.element!==s.element[0]&&("touch"===n.tolerance?l=!(i.left>r||a>i.right||i.top>h||o>i.bottom):"fit"===n.tolerance&&(l=i.left>a&&r>i.right&&i.top>o&&h>i.bottom),l?(i.selected&&(i.$element.removeClass("ui-selected"),i.selected=!1),i.unselecting&&(i.$element.removeClass("ui-unselecting"),i.unselecting=!1),i.selecting||(i.$element.addClass("ui-selecting"),i.selecting=!0,s._trigger("selecting",e,{selecting:i.element}))):(i.selecting&&((e.metaKey||e.ctrlKey)&&i.startselected?(i.$element.removeClass("ui-selecting"),i.selecting=!1,i.$element.addClass("ui-selected"),i.selected=!0):(i.$element.removeClass("ui-selecting"),i.selecting=!1,i.startselected&&(i.$element.addClass("ui-unselecting"),i.unselecting=!0),s._trigger("unselecting",e,{unselecting:i.element}))),i.selected&&(e.metaKey||e.ctrlKey||i.startselected||(i.$element.removeClass("ui-selected"),i.selected=!1,i.$element.addClass("ui-unselecting"),i.unselecting=!0,s._trigger("unselecting",e,{unselecting:i.element})))))}),!1}},_mouseStop:function(e){var i=this;return this.dragged=!1,t(".ui-unselecting",this.element[0]).each(function(){var s=t.data(this,"selectable-item");s.$element.removeClass("ui-unselecting"),s.unselecting=!1,s.startselected=!1,i._trigger("unselected",e,{unselected:s.element})}),t(".ui-selecting",this.element[0]).each(function(){var s=t.data(this,"selectable-item");s.$element.removeClass("ui-selecting").addClass("ui-selected"),s.selecting=!1,s.selected=!0,s.startselected=!0,i._trigger("selected",e,{selected:s.element})}),this._trigger("stop",e),this.helper.remove(),!1}}),t.widget("ui.sortable",t.ui.mouse,{version:"1.11.4",widgetEventPrefix:"sort",ready:!1,options:{appendTo:"parent",axis:!1,connectWith:!1,containment:!1,cursor:"auto",cursorAt:!1,dropOnEmpty:!0,forcePlaceholderSize:!1,forceHelperSize:!1,grid:!1,handle:!1,helper:"original",items:"> *",opacity:!1,placeholder:!1,revert:!1,scroll:!0,scrollSensitivity:20,scrollSpeed:20,scope:"default",tolerance:"intersect",zIndex:1e3,activate:null,beforeStop:null,change:null,deactivate:null,out:null,over:null,receive:null,remove:null,sort:null,start:null,stop:null,update:null},_isOverAxis:function(t,e,i){return t>=e&&e+i>t},_isFloating:function(t){return/left|right/.test(t.css("float"))||/inline|table-cell/.test(t.css("display"))},_create:function(){this.containerCache={},this.element.addClass("ui-sortable"),this.refresh(),this.offset=this.element.offset(),this._mouseInit(),this._setHandleClassName(),this.ready=!0},_setOption:function(t,e){this._super(t,e),"handle"===t&&this._setHandleClassName()},_setHandleClassName:function(){this.element.find(".ui-sortable-handle").removeClass("ui-sortable-handle"),t.each(this.items,function(){(this.instance.options.handle?this.item.find(this.instance.options.handle):this.item).addClass("ui-sortable-handle")})},_destroy:function(){this.element.removeClass("ui-sortable ui-sortable-disabled").find(".ui-sortable-handle").removeClass("ui-sortable-handle"),this._mouseDestroy();for(var t=this.items.length-1;t>=0;t--)this.items[t].item.removeData(this.widgetName+"-item");return this},_mouseCapture:function(e,i){var s=null,n=!1,a=this;return this.reverting?!1:this.options.disabled||"static"===this.options.type?!1:(this._refreshItems(e),t(e.target).parents().each(function(){return t.data(this,a.widgetName+"-item")===a?(s=t(this),!1):void 0}),t.data(e.target,a.widgetName+"-item")===a&&(s=t(e.target)),s?!this.options.handle||i||(t(this.options.handle,s).find("*").addBack().each(function(){this===e.target&&(n=!0)}),n)?(this.currentItem=s,this._removeCurrentsFromItems(),!0):!1:!1)},_mouseStart:function(e,i,s){var n,a,o=this.options;if(this.currentContainer=this,this.refreshPositions(),this.helper=this._createHelper(e),this._cacheHelperProportions(),this._cacheMargins(),this.scrollParent=this.helper.scrollParent(),this.offset=this.currentItem.offset(),this.offset={top:this.offset.top-this.margins.top,left:this.offset.left-this.margins.left},t.extend(this.offset,{click:{left:e.pageX-this.offset.left,top:e.pageY-this.offset.top},parent:this._getParentOffset(),relative:this._getRelativeOffset()}),this.helper.css("position","absolute"),this.cssPosition=this.helper.css("position"),this.originalPosition=this._generatePosition(e),this.originalPageX=e.pageX,this.originalPageY=e.pageY,o.cursorAt&&this._adjustOffsetFromHelper(o.cursorAt),this.domPosition={prev:this.currentItem.prev()[0],parent:this.currentItem.parent()[0]},this.helper[0]!==this.currentItem[0]&&this.currentItem.hide(),this._createPlaceholder(),o.containment&&this._setContainment(),o.cursor&&"auto"!==o.cursor&&(a=this.document.find("body"),this.storedCursor=a.css("cursor"),a.css("cursor",o.cursor),this.storedStylesheet=t("<style>*{ cursor: "+o.cursor+" !important; }</style>").appendTo(a)),o.opacity&&(this.helper.css("opacity")&&(this._storedOpacity=this.helper.css("opacity")),this.helper.css("opacity",o.opacity)),o.zIndex&&(this.helper.css("zIndex")&&(this._storedZIndex=this.helper.css("zIndex")),this.helper.css("zIndex",o.zIndex)),this.scrollParent[0]!==this.document[0]&&"HTML"!==this.scrollParent[0].tagName&&(this.overflowOffset=this.scrollParent.offset()),this._trigger("start",e,this._uiHash()),this._preserveHelperProportions||this._cacheHelperProportions(),!s)for(n=this.containers.length-1;n>=0;n--)this.containers[n]._trigger("activate",e,this._uiHash(this));return t.ui.ddmanager&&(t.ui.ddmanager.current=this),t.ui.ddmanager&&!o.dropBehaviour&&t.ui.ddmanager.prepareOffsets(this,e),this.dragging=!0,this.helper.addClass("ui-sortable-helper"),this._mouseDrag(e),!0},_mouseDrag:function(e){var i,s,n,a,o=this.options,r=!1;for(this.position=this._generatePosition(e),this.positionAbs=this._convertPositionTo("absolute"),this.lastPositionAbs||(this.lastPositionAbs=this.positionAbs),this.options.scroll&&(this.scrollParent[0]!==this.document[0]&&"HTML"!==this.scrollParent[0].tagName?(this.overflowOffset.top+this.scrollParent[0].offsetHeight-e.pageY<o.scrollSensitivity?this.scrollParent[0].scrollTop=r=this.scrollParent[0].scrollTop+o.scrollSpeed:e.pageY-this.overflowOffset.top<o.scrollSensitivity&&(this.scrollParent[0].scrollTop=r=this.scrollParent[0].scrollTop-o.scrollSpeed),this.overflowOffset.left+this.scrollParent[0].offsetWidth-e.pageX<o.scrollSensitivity?this.scrollParent[0].scrollLeft=r=this.scrollParent[0].scrollLeft+o.scrollSpeed:e.pageX-this.overflowOffset.left<o.scrollSensitivity&&(this.scrollParent[0].scrollLeft=r=this.scrollParent[0].scrollLeft-o.scrollSpeed)):(e.pageY-this.document.scrollTop()<o.scrollSensitivity?r=this.document.scrollTop(this.document.scrollTop()-o.scrollSpeed):this.window.height()-(e.pageY-this.document.scrollTop())<o.scrollSensitivity&&(r=this.document.scrollTop(this.document.scrollTop()+o.scrollSpeed)),e.pageX-this.document.scrollLeft()<o.scrollSensitivity?r=this.document.scrollLeft(this.document.scrollLeft()-o.scrollSpeed):this.window.width()-(e.pageX-this.document.scrollLeft())<o.scrollSensitivity&&(r=this.document.scrollLeft(this.document.scrollLeft()+o.scrollSpeed))),r!==!1&&t.ui.ddmanager&&!o.dropBehaviour&&t.ui.ddmanager.prepareOffsets(this,e)),this.positionAbs=this._convertPositionTo("absolute"),this.options.axis&&"y"===this.options.axis||(this.helper[0].style.left=this.position.left+"px"),this.options.axis&&"x"===this.options.axis||(this.helper[0].style.top=this.position.top+"px"),i=this.items.length-1;i>=0;i--)if(s=this.items[i],n=s.item[0],a=this._intersectsWithPointer(s),a&&s.instance===this.currentContainer&&n!==this.currentItem[0]&&this.placeholder[1===a?"next":"prev"]()[0]!==n&&!t.contains(this.placeholder[0],n)&&("semi-dynamic"===this.options.type?!t.contains(this.element[0],n):!0)){if(this.direction=1===a?"down":"up","pointer"!==this.options.tolerance&&!this._intersectsWithSides(s))break;this._rearrange(e,s),this._trigger("change",e,this._uiHash());break}return this._contactContainers(e),t.ui.ddmanager&&t.ui.ddmanager.drag(this,e),this._trigger("sort",e,this._uiHash()),this.lastPositionAbs=this.positionAbs,!1},_mouseStop:function(e,i){if(e){if(t.ui.ddmanager&&!this.options.dropBehaviour&&t.ui.ddmanager.drop(this,e),this.options.revert){var s=this,n=this.placeholder.offset(),a=this.options.axis,o={};a&&"x"!==a||(o.left=n.left-this.offset.parent.left-this.margins.left+(this.offsetParent[0]===this.document[0].body?0:this.offsetParent[0].scrollLeft)),a&&"y"!==a||(o.top=n.top-this.offset.parent.top-this.margins.top+(this.offsetParent[0]===this.document[0].body?0:this.offsetParent[0].scrollTop)),this.reverting=!0,t(this.helper).animate(o,parseInt(this.options.revert,10)||500,function(){s._clear(e)})}else this._clear(e,i);return!1}},cancel:function(){if(this.dragging){this._mouseUp({target:null}),"original"===this.options.helper?this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper"):this.currentItem.show();for(var e=this.containers.length-1;e>=0;e--)this.containers[e]._trigger("deactivate",null,this._uiHash(this)),this.containers[e].containerCache.over&&(this.containers[e]._trigger("out",null,this._uiHash(this)),this.containers[e].containerCache.over=0)}return this.placeholder&&(this.placeholder[0].parentNode&&this.placeholder[0].parentNode.removeChild(this.placeholder[0]),"original"!==this.options.helper&&this.helper&&this.helper[0].parentNode&&this.helper.remove(),t.extend(this,{helper:null,dragging:!1,reverting:!1,_noFinalSort:null}),this.domPosition.prev?t(this.domPosition.prev).after(this.currentItem):t(this.domPosition.parent).prepend(this.currentItem)),this},serialize:function(e){var i=this._getItemsAsjQuery(e&&e.connected),s=[];return e=e||{},t(i).each(function(){var i=(t(e.item||this).attr(e.attribute||"id")||"").match(e.expression||/(.+)[\-=_](.+)/);i&&s.push((e.key||i[1]+"[]")+"="+(e.key&&e.expression?i[1]:i[2]))}),!s.length&&e.key&&s.push(e.key+"="),s.join("&")},toArray:function(e){var i=this._getItemsAsjQuery(e&&e.connected),s=[];return e=e||{},i.each(function(){s.push(t(e.item||this).attr(e.attribute||"id")||"")}),s},_intersectsWith:function(t){var e=this.positionAbs.left,i=e+this.helperProportions.width,s=this.positionAbs.top,n=s+this.helperProportions.height,a=t.left,o=a+t.width,r=t.top,h=r+t.height,l=this.offset.click.top,u=this.offset.click.left,c="x"===this.options.axis||s+l>r&&h>s+l,d="y"===this.options.axis||e+u>a&&o>e+u,p=c&&d;return"pointer"===this.options.tolerance||this.options.forcePointerForContainers||"pointer"!==this.options.tolerance&&this.helperProportions[this.floating?"width":"height"]>t[this.floating?"width":"height"]?p:e+this.helperProportions.width/2>a&&o>i-this.helperProportions.width/2&&s+this.helperProportions.height/2>r&&h>n-this.helperProportions.height/2},_intersectsWithPointer:function(t){var e="x"===this.options.axis||this._isOverAxis(this.positionAbs.top+this.offset.click.top,t.top,t.height),i="y"===this.options.axis||this._isOverAxis(this.positionAbs.left+this.offset.click.left,t.left,t.width),s=e&&i,n=this._getDragVerticalDirection(),a=this._getDragHorizontalDirection();return s?this.floating?a&&"right"===a||"down"===n?2:1:n&&("down"===n?2:1):!1},_intersectsWithSides:function(t){var e=this._isOverAxis(this.positionAbs.top+this.offset.click.top,t.top+t.height/2,t.height),i=this._isOverAxis(this.positionAbs.left+this.offset.click.left,t.left+t.width/2,t.width),s=this._getDragVerticalDirection(),n=this._getDragHorizontalDirection();return this.floating&&n?"right"===n&&i||"left"===n&&!i:s&&("down"===s&&e||"up"===s&&!e)},_getDragVerticalDirection:function(){var t=this.positionAbs.top-this.lastPositionAbs.top;return 0!==t&&(t>0?"down":"up")},_getDragHorizontalDirection:function(){var t=this.positionAbs.left-this.lastPositionAbs.left;return 0!==t&&(t>0?"right":"left")},refresh:function(t){return this._refreshItems(t),this._setHandleClassName(),this.refreshPositions(),this},_connectWith:function(){var t=this.options;return t.connectWith.constructor===String?[t.connectWith]:t.connectWith},_getItemsAsjQuery:function(e){function i(){r.push(this)}var s,n,a,o,r=[],h=[],l=this._connectWith();if(l&&e)for(s=l.length-1;s>=0;s--)for(a=t(l[s],this.document[0]),n=a.length-1;n>=0;n--)o=t.data(a[n],this.widgetFullName),o&&o!==this&&!o.options.disabled&&h.push([t.isFunction(o.options.items)?o.options.items.call(o.element):t(o.options.items,o.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),o]);for(h.push([t.isFunction(this.options.items)?this.options.items.call(this.element,null,{options:this.options,item:this.currentItem}):t(this.options.items,this.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),this]),s=h.length-1;s>=0;s--)h[s][0].each(i);return t(r)},_removeCurrentsFromItems:function(){var e=this.currentItem.find(":data("+this.widgetName+"-item)");this.items=t.grep(this.items,function(t){for(var i=0;e.length>i;i++)if(e[i]===t.item[0])return!1;return!0})},_refreshItems:function(e){this.items=[],this.containers=[this];var i,s,n,a,o,r,h,l,u=this.items,c=[[t.isFunction(this.options.items)?this.options.items.call(this.element[0],e,{item:this.currentItem}):t(this.options.items,this.element),this]],d=this._connectWith();if(d&&this.ready)for(i=d.length-1;i>=0;i--)for(n=t(d[i],this.document[0]),s=n.length-1;s>=0;s--)a=t.data(n[s],this.widgetFullName),a&&a!==this&&!a.options.disabled&&(c.push([t.isFunction(a.options.items)?a.options.items.call(a.element[0],e,{item:this.currentItem}):t(a.options.items,a.element),a]),this.containers.push(a));for(i=c.length-1;i>=0;i--)for(o=c[i][1],r=c[i][0],s=0,l=r.length;l>s;s++)h=t(r[s]),h.data(this.widgetName+"-item",o),u.push({item:h,instance:o,width:0,height:0,left:0,top:0})},refreshPositions:function(e){this.floating=this.items.length?"x"===this.options.axis||this._isFloating(this.items[0].item):!1,this.offsetParent&&this.helper&&(this.offset.parent=this._getParentOffset());var i,s,n,a;for(i=this.items.length-1;i>=0;i--)s=this.items[i],s.instance!==this.currentContainer&&this.currentContainer&&s.item[0]!==this.currentItem[0]||(n=this.options.toleranceElement?t(this.options.toleranceElement,s.item):s.item,e||(s.width=n.outerWidth(),s.height=n.outerHeight()),a=n.offset(),s.left=a.left,s.top=a.top);if(this.options.custom&&this.options.custom.refreshContainers)this.options.custom.refreshContainers.call(this);else for(i=this.containers.length-1;i>=0;i--)a=this.containers[i].element.offset(),this.containers[i].containerCache.left=a.left,this.containers[i].containerCache.top=a.top,this.containers[i].containerCache.width=this.containers[i].element.outerWidth(),this.containers[i].containerCache.height=this.containers[i].element.outerHeight();return this},_createPlaceholder:function(e){e=e||this;var i,s=e.options;s.placeholder&&s.placeholder.constructor!==String||(i=s.placeholder,s.placeholder={element:function(){var s=e.currentItem[0].nodeName.toLowerCase(),n=t("<"+s+">",e.document[0]).addClass(i||e.currentItem[0].className+" ui-sortable-placeholder").removeClass("ui-sortable-helper");return"tbody"===s?e._createTrPlaceholder(e.currentItem.find("tr").eq(0),t("<tr>",e.document[0]).appendTo(n)):"tr"===s?e._createTrPlaceholder(e.currentItem,n):"img"===s&&n.attr("src",e.currentItem.attr("src")),i||n.css("visibility","hidden"),n},update:function(t,n){(!i||s.forcePlaceholderSize)&&(n.height()||n.height(e.currentItem.innerHeight()-parseInt(e.currentItem.css("paddingTop")||0,10)-parseInt(e.currentItem.css("paddingBottom")||0,10)),n.width()||n.width(e.currentItem.innerWidth()-parseInt(e.currentItem.css("paddingLeft")||0,10)-parseInt(e.currentItem.css("paddingRight")||0,10)))}}),e.placeholder=t(s.placeholder.element.call(e.element,e.currentItem)),e.currentItem.after(e.placeholder),s.placeholder.update(e,e.placeholder)},_createTrPlaceholder:function(e,i){var s=this;e.children().each(function(){t("<td>&#160;</td>",s.document[0]).attr("colspan",t(this).attr("colspan")||1).appendTo(i)})},_contactContainers:function(e){var i,s,n,a,o,r,h,l,u,c,d=null,p=null;for(i=this.containers.length-1;i>=0;i--)if(!t.contains(this.currentItem[0],this.containers[i].element[0]))if(this._intersectsWith(this.containers[i].containerCache)){if(d&&t.contains(this.containers[i].element[0],d.element[0]))continue;d=this.containers[i],p=i}else this.containers[i].containerCache.over&&(this.containers[i]._trigger("out",e,this._uiHash(this)),this.containers[i].containerCache.over=0);if(d)if(1===this.containers.length)this.containers[p].containerCache.over||(this.containers[p]._trigger("over",e,this._uiHash(this)),this.containers[p].containerCache.over=1);else{for(n=1e4,a=null,u=d.floating||this._isFloating(this.currentItem),o=u?"left":"top",r=u?"width":"height",c=u?"clientX":"clientY",s=this.items.length-1;s>=0;s--)t.contains(this.containers[p].element[0],this.items[s].item[0])&&this.items[s].item[0]!==this.currentItem[0]&&(h=this.items[s].item.offset()[o],l=!1,e[c]-h>this.items[s][r]/2&&(l=!0),n>Math.abs(e[c]-h)&&(n=Math.abs(e[c]-h),a=this.items[s],this.direction=l?"up":"down"));if(!a&&!this.options.dropOnEmpty)return;if(this.currentContainer===this.containers[p])return this.currentContainer.containerCache.over||(this.containers[p]._trigger("over",e,this._uiHash()),this.currentContainer.containerCache.over=1),void 0;a?this._rearrange(e,a,null,!0):this._rearrange(e,null,this.containers[p].element,!0),this._trigger("change",e,this._uiHash()),this.containers[p]._trigger("change",e,this._uiHash(this)),this.currentContainer=this.containers[p],this.options.placeholder.update(this.currentContainer,this.placeholder),this.containers[p]._trigger("over",e,this._uiHash(this)),this.containers[p].containerCache.over=1}},_createHelper:function(e){var i=this.options,s=t.isFunction(i.helper)?t(i.helper.apply(this.element[0],[e,this.currentItem])):"clone"===i.helper?this.currentItem.clone():this.currentItem;return s.parents("body").length||t("parent"!==i.appendTo?i.appendTo:this.currentItem[0].parentNode)[0].appendChild(s[0]),s[0]===this.currentItem[0]&&(this._storedCSS={width:this.currentItem[0].style.width,height:this.currentItem[0].style.height,position:this.currentItem.css("position"),top:this.currentItem.css("top"),left:this.currentItem.css("left")}),(!s[0].style.width||i.forceHelperSize)&&s.width(this.currentItem.width()),(!s[0].style.height||i.forceHelperSize)&&s.height(this.currentItem.height()),s},_adjustOffsetFromHelper:function(e){"string"==typeof e&&(e=e.split(" ")),t.isArray(e)&&(e={left:+e[0],top:+e[1]||0}),"left"in e&&(this.offset.click.left=e.left+this.margins.left),"right"in e&&(this.offset.click.left=this.helperProportions.width-e.right+this.margins.left),"top"in e&&(this.offset.click.top=e.top+this.margins.top),"bottom"in e&&(this.offset.click.top=this.helperProportions.height-e.bottom+this.margins.top)},_getParentOffset:function(){this.offsetParent=this.helper.offsetParent();var e=this.offsetParent.offset();return"absolute"===this.cssPosition&&this.scrollParent[0]!==this.document[0]&&t.contains(this.scrollParent[0],this.offsetParent[0])&&(e.left+=this.scrollParent.scrollLeft(),e.top+=this.scrollParent.scrollTop()),(this.offsetParent[0]===this.document[0].body||this.offsetParent[0].tagName&&"html"===this.offsetParent[0].tagName.toLowerCase()&&t.ui.ie)&&(e={top:0,left:0}),{top:e.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:e.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if("relative"===this.cssPosition){var t=this.currentItem.position();return{top:t.top-(parseInt(this.helper.css("top"),10)||0)+this.scrollParent.scrollTop(),left:t.left-(parseInt(this.helper.css("left"),10)||0)+this.scrollParent.scrollLeft()}}return{top:0,left:0}},_cacheMargins:function(){this.margins={left:parseInt(this.currentItem.css("marginLeft"),10)||0,top:parseInt(this.currentItem.css("marginTop"),10)||0}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var e,i,s,n=this.options;"parent"===n.containment&&(n.containment=this.helper[0].parentNode),("document"===n.containment||"window"===n.containment)&&(this.containment=[0-this.offset.relative.left-this.offset.parent.left,0-this.offset.relative.top-this.offset.parent.top,"document"===n.containment?this.document.width():this.window.width()-this.helperProportions.width-this.margins.left,("document"===n.containment?this.document.width():this.window.height()||this.document[0].body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]),/^(document|window|parent)$/.test(n.containment)||(e=t(n.containment)[0],i=t(n.containment).offset(),s="hidden"!==t(e).css("overflow"),this.containment=[i.left+(parseInt(t(e).css("borderLeftWidth"),10)||0)+(parseInt(t(e).css("paddingLeft"),10)||0)-this.margins.left,i.top+(parseInt(t(e).css("borderTopWidth"),10)||0)+(parseInt(t(e).css("paddingTop"),10)||0)-this.margins.top,i.left+(s?Math.max(e.scrollWidth,e.offsetWidth):e.offsetWidth)-(parseInt(t(e).css("borderLeftWidth"),10)||0)-(parseInt(t(e).css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left,i.top+(s?Math.max(e.scrollHeight,e.offsetHeight):e.offsetHeight)-(parseInt(t(e).css("borderTopWidth"),10)||0)-(parseInt(t(e).css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top])},_convertPositionTo:function(e,i){i||(i=this.position);var s="absolute"===e?1:-1,n="absolute"!==this.cssPosition||this.scrollParent[0]!==this.document[0]&&t.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,a=/(html|body)/i.test(n[0].tagName);return{top:i.top+this.offset.relative.top*s+this.offset.parent.top*s-("fixed"===this.cssPosition?-this.scrollParent.scrollTop():a?0:n.scrollTop())*s,left:i.left+this.offset.relative.left*s+this.offset.parent.left*s-("fixed"===this.cssPosition?-this.scrollParent.scrollLeft():a?0:n.scrollLeft())*s}},_generatePosition:function(e){var i,s,n=this.options,a=e.pageX,o=e.pageY,r="absolute"!==this.cssPosition||this.scrollParent[0]!==this.document[0]&&t.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,h=/(html|body)/i.test(r[0].tagName);return"relative"!==this.cssPosition||this.scrollParent[0]!==this.document[0]&&this.scrollParent[0]!==this.offsetParent[0]||(this.offset.relative=this._getRelativeOffset()),this.originalPosition&&(this.containment&&(e.pageX-this.offset.click.left<this.containment[0]&&(a=this.containment[0]+this.offset.click.left),e.pageY-this.offset.click.top<this.containment[1]&&(o=this.containment[1]+this.offset.click.top),e.pageX-this.offset.click.left>this.containment[2]&&(a=this.containment[2]+this.offset.click.left),e.pageY-this.offset.click.top>this.containment[3]&&(o=this.containment[3]+this.offset.click.top)),n.grid&&(i=this.originalPageY+Math.round((o-this.originalPageY)/n.grid[1])*n.grid[1],o=this.containment?i-this.offset.click.top>=this.containment[1]&&i-this.offset.click.top<=this.containment[3]?i:i-this.offset.click.top>=this.containment[1]?i-n.grid[1]:i+n.grid[1]:i,s=this.originalPageX+Math.round((a-this.originalPageX)/n.grid[0])*n.grid[0],a=this.containment?s-this.offset.click.left>=this.containment[0]&&s-this.offset.click.left<=this.containment[2]?s:s-this.offset.click.left>=this.containment[0]?s-n.grid[0]:s+n.grid[0]:s)),{top:o-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+("fixed"===this.cssPosition?-this.scrollParent.scrollTop():h?0:r.scrollTop()),left:a-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+("fixed"===this.cssPosition?-this.scrollParent.scrollLeft():h?0:r.scrollLeft())}},_rearrange:function(t,e,i,s){i?i[0].appendChild(this.placeholder[0]):e.item[0].parentNode.insertBefore(this.placeholder[0],"down"===this.direction?e.item[0]:e.item[0].nextSibling),this.counter=this.counter?++this.counter:1;var n=this.counter;this._delay(function(){n===this.counter&&this.refreshPositions(!s)})},_clear:function(t,e){function i(t,e,i){return function(s){i._trigger(t,s,e._uiHash(e))}}this.reverting=!1;var s,n=[];if(!this._noFinalSort&&this.currentItem.parent().length&&this.placeholder.before(this.currentItem),this._noFinalSort=null,this.helper[0]===this.currentItem[0]){for(s in this._storedCSS)("auto"===this._storedCSS[s]||"static"===this._storedCSS[s])&&(this._storedCSS[s]="");this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper")}else this.currentItem.show();for(this.fromOutside&&!e&&n.push(function(t){this._trigger("receive",t,this._uiHash(this.fromOutside))}),!this.fromOutside&&this.domPosition.prev===this.currentItem.prev().not(".ui-sortable-helper")[0]&&this.domPosition.parent===this.currentItem.parent()[0]||e||n.push(function(t){this._trigger("update",t,this._uiHash())}),this!==this.currentContainer&&(e||(n.push(function(t){this._trigger("remove",t,this._uiHash())}),n.push(function(t){return function(e){t._trigger("receive",e,this._uiHash(this))}}.call(this,this.currentContainer)),n.push(function(t){return function(e){t._trigger("update",e,this._uiHash(this))}}.call(this,this.currentContainer)))),s=this.containers.length-1;s>=0;s--)e||n.push(i("deactivate",this,this.containers[s])),this.containers[s].containerCache.over&&(n.push(i("out",this,this.containers[s])),this.containers[s].containerCache.over=0);if(this.storedCursor&&(this.document.find("body").css("cursor",this.storedCursor),this.storedStylesheet.remove()),this._storedOpacity&&this.helper.css("opacity",this._storedOpacity),this._storedZIndex&&this.helper.css("zIndex","auto"===this._storedZIndex?"":this._storedZIndex),this.dragging=!1,e||this._trigger("beforeStop",t,this._uiHash()),this.placeholder[0].parentNode.removeChild(this.placeholder[0]),this.cancelHelperRemoval||(this.helper[0]!==this.currentItem[0]&&this.helper.remove(),this.helper=null),!e){for(s=0;n.length>s;s++)n[s].call(this,t);this._trigger("stop",t,this._uiHash())}return this.fromOutside=!1,!this.cancelHelperRemoval},_trigger:function(){t.Widget.prototype._trigger.apply(this,arguments)===!1&&this.cancel()},_uiHash:function(e){var i=e||this;return{helper:i.helper,placeholder:i.placeholder||t([]),position:i.position,originalPosition:i.originalPosition,offset:i.positionAbs,item:i.currentItem,sender:e?e.element:null}}});var o,r="ui-button ui-widget ui-state-default ui-corner-all",h="ui-button-icons-only ui-button-icon-only ui-button-text-icons ui-button-text-icon-primary ui-button-text-icon-secondary ui-button-text-only",l=function(){var e=t(this);setTimeout(function(){e.find(":ui-button").button("refresh")},1)},u=function(e){var i=e.name,s=e.form,n=t([]);return i&&(i=i.replace(/'/g,"\\'"),n=s?t(s).find("[name='"+i+"'][type=radio]"):t("[name='"+i+"'][type=radio]",e.ownerDocument).filter(function(){return!this.form})),n};t.widget("ui.button",{version:"1.11.4",defaultElement:"<button>",options:{disabled:null,text:!0,label:null,icons:{primary:null,secondary:null}},_create:function(){this.element.closest("form").unbind("reset"+this.eventNamespace).bind("reset"+this.eventNamespace,l),"boolean"!=typeof this.options.disabled?this.options.disabled=!!this.element.prop("disabled"):this.element.prop("disabled",this.options.disabled),this._determineButtonType(),this.hasTitle=!!this.buttonElement.attr("title");var e=this,i=this.options,s="checkbox"===this.type||"radio"===this.type,n=s?"":"ui-state-active";null===i.label&&(i.label="input"===this.type?this.buttonElement.val():this.buttonElement.html()),this._hoverable(this.buttonElement),this.buttonElement.addClass(r).attr("role","button").bind("mouseenter"+this.eventNamespace,function(){i.disabled||this===o&&t(this).addClass("ui-state-active")}).bind("mouseleave"+this.eventNamespace,function(){i.disabled||t(this).removeClass(n)}).bind("click"+this.eventNamespace,function(t){i.disabled&&(t.preventDefault(),t.stopImmediatePropagation())}),this._on({focus:function(){this.buttonElement.addClass("ui-state-focus")},blur:function(){this.buttonElement.removeClass("ui-state-focus")}}),s&&this.element.bind("change"+this.eventNamespace,function(){e.refresh()}),"checkbox"===this.type?this.buttonElement.bind("click"+this.eventNamespace,function(){return i.disabled?!1:void 0}):"radio"===this.type?this.buttonElement.bind("click"+this.eventNamespace,function(){if(i.disabled)return!1;t(this).addClass("ui-state-active"),e.buttonElement.attr("aria-pressed","true");var s=e.element[0];u(s).not(s).map(function(){return t(this).button("widget")[0]}).removeClass("ui-state-active").attr("aria-pressed","false")}):(this.buttonElement.bind("mousedown"+this.eventNamespace,function(){return i.disabled?!1:(t(this).addClass("ui-state-active"),o=this,e.document.one("mouseup",function(){o=null}),void 0)}).bind("mouseup"+this.eventNamespace,function(){return i.disabled?!1:(t(this).removeClass("ui-state-active"),void 0)}).bind("keydown"+this.eventNamespace,function(e){return i.disabled?!1:((e.keyCode===t.ui.keyCode.SPACE||e.keyCode===t.ui.keyCode.ENTER)&&t(this).addClass("ui-state-active"),void 0)}).bind("keyup"+this.eventNamespace+" blur"+this.eventNamespace,function(){t(this).removeClass("ui-state-active")}),this.buttonElement.is("a")&&this.buttonElement.keyup(function(e){e.keyCode===t.ui.keyCode.SPACE&&t(this).click()})),this._setOption("disabled",i.disabled),this._resetButton()},_determineButtonType:function(){var t,e,i;this.type=this.element.is("[type=checkbox]")?"checkbox":this.element.is("[type=radio]")?"radio":this.element.is("input")?"input":"button","checkbox"===this.type||"radio"===this.type?(t=this.element.parents().last(),e="label[for='"+this.element.attr("id")+"']",this.buttonElement=t.find(e),this.buttonElement.length||(t=t.length?t.siblings():this.element.siblings(),this.buttonElement=t.filter(e),this.buttonElement.length||(this.buttonElement=t.find(e))),this.element.addClass("ui-helper-hidden-accessible"),i=this.element.is(":checked"),i&&this.buttonElement.addClass("ui-state-active"),this.buttonElement.prop("aria-pressed",i)):this.buttonElement=this.element},widget:function(){return this.buttonElement},_destroy:function(){this.element.removeClass("ui-helper-hidden-accessible"),this.buttonElement.removeClass(r+" ui-state-active "+h).removeAttr("role").removeAttr("aria-pressed").html(this.buttonElement.find(".ui-button-text").html()),this.hasTitle||this.buttonElement.removeAttr("title")},_setOption:function(t,e){return this._super(t,e),"disabled"===t?(this.widget().toggleClass("ui-state-disabled",!!e),this.element.prop("disabled",!!e),e&&("checkbox"===this.type||"radio"===this.type?this.buttonElement.removeClass("ui-state-focus"):this.buttonElement.removeClass("ui-state-focus ui-state-active")),void 0):(this._resetButton(),void 0)},refresh:function(){var e=this.element.is("input, button")?this.element.is(":disabled"):this.element.hasClass("ui-button-disabled");e!==this.options.disabled&&this._setOption("disabled",e),"radio"===this.type?u(this.element[0]).each(function(){t(this).is(":checked")?t(this).button("widget").addClass("ui-state-active").attr("aria-pressed","true"):t(this).button("widget").removeClass("ui-state-active").attr("aria-pressed","false")}):"checkbox"===this.type&&(this.element.is(":checked")?this.buttonElement.addClass("ui-state-active").attr("aria-pressed","true"):this.buttonElement.removeClass("ui-state-active").attr("aria-pressed","false"))},_resetButton:function(){if("input"===this.type)return this.options.label&&this.element.val(this.options.label),void 0;var e=this.buttonElement.removeClass(h),i=t("<span></span>",this.document[0]).addClass("ui-button-text").html(this.options.label).appendTo(e.empty()).text(),s=this.options.icons,n=s.primary&&s.secondary,a=[];s.primary||s.secondary?(this.options.text&&a.push("ui-button-text-icon"+(n?"s":s.primary?"-primary":"-secondary")),s.primary&&e.prepend("<span class='ui-button-icon-primary ui-icon "+s.primary+"'></span>"),s.secondary&&e.append("<span class='ui-button-icon-secondary ui-icon "+s.secondary+"'></span>"),this.options.text||(a.push(n?"ui-button-icons-only":"ui-button-icon-only"),this.hasTitle||e.attr("title",t.trim(i)))):a.push("ui-button-text-only"),e.addClass(a.join(" "))}}),t.widget("ui.buttonset",{version:"1.11.4",options:{items:"button, input[type=button], input[type=submit], input[type=reset], input[type=checkbox], input[type=radio], a, :data(ui-button)"},_create:function(){this.element.addClass("ui-buttonset")
},_init:function(){this.refresh()},_setOption:function(t,e){"disabled"===t&&this.buttons.button("option",t,e),this._super(t,e)},refresh:function(){var e="rtl"===this.element.css("direction"),i=this.element.find(this.options.items),s=i.filter(":ui-button");i.not(":ui-button").button(),s.button("refresh"),this.buttons=i.map(function(){return t(this).button("widget")[0]}).removeClass("ui-corner-all ui-corner-left ui-corner-right").filter(":first").addClass(e?"ui-corner-right":"ui-corner-left").end().filter(":last").addClass(e?"ui-corner-left":"ui-corner-right").end().end()},_destroy:function(){this.element.removeClass("ui-buttonset"),this.buttons.map(function(){return t(this).button("widget")[0]}).removeClass("ui-corner-left ui-corner-right").end().button("destroy")}}),t.ui.button,t.widget("ui.dialog",{version:"1.11.4",options:{appendTo:"body",autoOpen:!0,buttons:[],closeOnEscape:!0,closeText:"Close",dialogClass:"",draggable:!0,hide:null,height:"auto",maxHeight:null,maxWidth:null,minHeight:150,minWidth:150,modal:!1,position:{my:"center",at:"center",of:window,collision:"fit",using:function(e){var i=t(this).css(e).offset().top;0>i&&t(this).css("top",e.top-i)}},resizable:!0,show:null,title:null,width:300,beforeClose:null,close:null,drag:null,dragStart:null,dragStop:null,focus:null,open:null,resize:null,resizeStart:null,resizeStop:null},sizeRelatedOptions:{buttons:!0,height:!0,maxHeight:!0,maxWidth:!0,minHeight:!0,minWidth:!0,width:!0},resizableRelatedOptions:{maxHeight:!0,maxWidth:!0,minHeight:!0,minWidth:!0},_create:function(){this.originalCss={display:this.element[0].style.display,width:this.element[0].style.width,minHeight:this.element[0].style.minHeight,maxHeight:this.element[0].style.maxHeight,height:this.element[0].style.height},this.originalPosition={parent:this.element.parent(),index:this.element.parent().children().index(this.element)},this.originalTitle=this.element.attr("title"),this.options.title=this.options.title||this.originalTitle,this._createWrapper(),this.element.show().removeAttr("title").addClass("ui-dialog-content ui-widget-content").appendTo(this.uiDialog),this._createTitlebar(),this._createButtonPane(),this.options.draggable&&t.fn.draggable&&this._makeDraggable(),this.options.resizable&&t.fn.resizable&&this._makeResizable(),this._isOpen=!1,this._trackFocus()},_init:function(){this.options.autoOpen&&this.open()},_appendTo:function(){var e=this.options.appendTo;return e&&(e.jquery||e.nodeType)?t(e):this.document.find(e||"body").eq(0)},_destroy:function(){var t,e=this.originalPosition;this._untrackInstance(),this._destroyOverlay(),this.element.removeUniqueId().removeClass("ui-dialog-content ui-widget-content").css(this.originalCss).detach(),this.uiDialog.stop(!0,!0).remove(),this.originalTitle&&this.element.attr("title",this.originalTitle),t=e.parent.children().eq(e.index),t.length&&t[0]!==this.element[0]?t.before(this.element):e.parent.append(this.element)},widget:function(){return this.uiDialog},disable:t.noop,enable:t.noop,close:function(e){var i,s=this;if(this._isOpen&&this._trigger("beforeClose",e)!==!1){if(this._isOpen=!1,this._focusedElement=null,this._destroyOverlay(),this._untrackInstance(),!this.opener.filter(":focusable").focus().length)try{i=this.document[0].activeElement,i&&"body"!==i.nodeName.toLowerCase()&&t(i).blur()}catch(n){}this._hide(this.uiDialog,this.options.hide,function(){s._trigger("close",e)})}},isOpen:function(){return this._isOpen},moveToTop:function(){this._moveToTop()},_moveToTop:function(e,i){var s=!1,n=this.uiDialog.siblings(".ui-front:visible").map(function(){return+t(this).css("z-index")}).get(),a=Math.max.apply(null,n);return a>=+this.uiDialog.css("z-index")&&(this.uiDialog.css("z-index",a+1),s=!0),s&&!i&&this._trigger("focus",e),s},open:function(){var e=this;return this._isOpen?(this._moveToTop()&&this._focusTabbable(),void 0):(this._isOpen=!0,this.opener=t(this.document[0].activeElement),this._size(),this._position(),this._createOverlay(),this._moveToTop(null,!0),this.overlay&&this.overlay.css("z-index",this.uiDialog.css("z-index")-1),this._show(this.uiDialog,this.options.show,function(){e._focusTabbable(),e._trigger("focus")}),this._makeFocusTarget(),this._trigger("open"),void 0)},_focusTabbable:function(){var t=this._focusedElement;t||(t=this.element.find("[autofocus]")),t.length||(t=this.element.find(":tabbable")),t.length||(t=this.uiDialogButtonPane.find(":tabbable")),t.length||(t=this.uiDialogTitlebarClose.filter(":tabbable")),t.length||(t=this.uiDialog),t.eq(0).focus()},_keepFocus:function(e){function i(){var e=this.document[0].activeElement,i=this.uiDialog[0]===e||t.contains(this.uiDialog[0],e);i||this._focusTabbable()}e.preventDefault(),i.call(this),this._delay(i)},_createWrapper:function(){this.uiDialog=t("<div>").addClass("ui-dialog ui-widget ui-widget-content ui-corner-all ui-front "+this.options.dialogClass).hide().attr({tabIndex:-1,role:"dialog"}).appendTo(this._appendTo()),this._on(this.uiDialog,{keydown:function(e){if(this.options.closeOnEscape&&!e.isDefaultPrevented()&&e.keyCode&&e.keyCode===t.ui.keyCode.ESCAPE)return e.preventDefault(),this.close(e),void 0;if(e.keyCode===t.ui.keyCode.TAB&&!e.isDefaultPrevented()){var i=this.uiDialog.find(":tabbable"),s=i.filter(":first"),n=i.filter(":last");e.target!==n[0]&&e.target!==this.uiDialog[0]||e.shiftKey?e.target!==s[0]&&e.target!==this.uiDialog[0]||!e.shiftKey||(this._delay(function(){n.focus()}),e.preventDefault()):(this._delay(function(){s.focus()}),e.preventDefault())}},mousedown:function(t){this._moveToTop(t)&&this._focusTabbable()}}),this.element.find("[aria-describedby]").length||this.uiDialog.attr({"aria-describedby":this.element.uniqueId().attr("id")})},_createTitlebar:function(){var e;this.uiDialogTitlebar=t("<div>").addClass("ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix").prependTo(this.uiDialog),this._on(this.uiDialogTitlebar,{mousedown:function(e){t(e.target).closest(".ui-dialog-titlebar-close")||this.uiDialog.focus()}}),this.uiDialogTitlebarClose=t("<button type='button'></button>").button({label:this.options.closeText,icons:{primary:"ui-icon-closethick"},text:!1}).addClass("ui-dialog-titlebar-close").appendTo(this.uiDialogTitlebar),this._on(this.uiDialogTitlebarClose,{click:function(t){t.preventDefault(),this.close(t)}}),e=t("<span>").uniqueId().addClass("ui-dialog-title").prependTo(this.uiDialogTitlebar),this._title(e),this.uiDialog.attr({"aria-labelledby":e.attr("id")})},_title:function(t){this.options.title||t.html("&#160;"),t.text(this.options.title)},_createButtonPane:function(){this.uiDialogButtonPane=t("<div>").addClass("ui-dialog-buttonpane ui-widget-content ui-helper-clearfix"),this.uiButtonSet=t("<div>").addClass("ui-dialog-buttonset").appendTo(this.uiDialogButtonPane),this._createButtons()},_createButtons:function(){var e=this,i=this.options.buttons;return this.uiDialogButtonPane.remove(),this.uiButtonSet.empty(),t.isEmptyObject(i)||t.isArray(i)&&!i.length?(this.uiDialog.removeClass("ui-dialog-buttons"),void 0):(t.each(i,function(i,s){var n,a;s=t.isFunction(s)?{click:s,text:i}:s,s=t.extend({type:"button"},s),n=s.click,s.click=function(){n.apply(e.element[0],arguments)},a={icons:s.icons,text:s.showText},delete s.icons,delete s.showText,t("<button></button>",s).button(a).appendTo(e.uiButtonSet)}),this.uiDialog.addClass("ui-dialog-buttons"),this.uiDialogButtonPane.appendTo(this.uiDialog),void 0)},_makeDraggable:function(){function e(t){return{position:t.position,offset:t.offset}}var i=this,s=this.options;this.uiDialog.draggable({cancel:".ui-dialog-content, .ui-dialog-titlebar-close",handle:".ui-dialog-titlebar",containment:"document",start:function(s,n){t(this).addClass("ui-dialog-dragging"),i._blockFrames(),i._trigger("dragStart",s,e(n))},drag:function(t,s){i._trigger("drag",t,e(s))},stop:function(n,a){var o=a.offset.left-i.document.scrollLeft(),r=a.offset.top-i.document.scrollTop();s.position={my:"left top",at:"left"+(o>=0?"+":"")+o+" "+"top"+(r>=0?"+":"")+r,of:i.window},t(this).removeClass("ui-dialog-dragging"),i._unblockFrames(),i._trigger("dragStop",n,e(a))}})},_makeResizable:function(){function e(t){return{originalPosition:t.originalPosition,originalSize:t.originalSize,position:t.position,size:t.size}}var i=this,s=this.options,n=s.resizable,a=this.uiDialog.css("position"),o="string"==typeof n?n:"n,e,s,w,se,sw,ne,nw";this.uiDialog.resizable({cancel:".ui-dialog-content",containment:"document",alsoResize:this.element,maxWidth:s.maxWidth,maxHeight:s.maxHeight,minWidth:s.minWidth,minHeight:this._minHeight(),handles:o,start:function(s,n){t(this).addClass("ui-dialog-resizing"),i._blockFrames(),i._trigger("resizeStart",s,e(n))},resize:function(t,s){i._trigger("resize",t,e(s))},stop:function(n,a){var o=i.uiDialog.offset(),r=o.left-i.document.scrollLeft(),h=o.top-i.document.scrollTop();s.height=i.uiDialog.height(),s.width=i.uiDialog.width(),s.position={my:"left top",at:"left"+(r>=0?"+":"")+r+" "+"top"+(h>=0?"+":"")+h,of:i.window},t(this).removeClass("ui-dialog-resizing"),i._unblockFrames(),i._trigger("resizeStop",n,e(a))}}).css("position",a)},_trackFocus:function(){this._on(this.widget(),{focusin:function(e){this._makeFocusTarget(),this._focusedElement=t(e.target)}})},_makeFocusTarget:function(){this._untrackInstance(),this._trackingInstances().unshift(this)},_untrackInstance:function(){var e=this._trackingInstances(),i=t.inArray(this,e);-1!==i&&e.splice(i,1)},_trackingInstances:function(){var t=this.document.data("ui-dialog-instances");return t||(t=[],this.document.data("ui-dialog-instances",t)),t},_minHeight:function(){var t=this.options;return"auto"===t.height?t.minHeight:Math.min(t.minHeight,t.height)},_position:function(){var t=this.uiDialog.is(":visible");t||this.uiDialog.show(),this.uiDialog.position(this.options.position),t||this.uiDialog.hide()},_setOptions:function(e){var i=this,s=!1,n={};t.each(e,function(t,e){i._setOption(t,e),t in i.sizeRelatedOptions&&(s=!0),t in i.resizableRelatedOptions&&(n[t]=e)}),s&&(this._size(),this._position()),this.uiDialog.is(":data(ui-resizable)")&&this.uiDialog.resizable("option",n)},_setOption:function(t,e){var i,s,n=this.uiDialog;"dialogClass"===t&&n.removeClass(this.options.dialogClass).addClass(e),"disabled"!==t&&(this._super(t,e),"appendTo"===t&&this.uiDialog.appendTo(this._appendTo()),"buttons"===t&&this._createButtons(),"closeText"===t&&this.uiDialogTitlebarClose.button({label:""+e}),"draggable"===t&&(i=n.is(":data(ui-draggable)"),i&&!e&&n.draggable("destroy"),!i&&e&&this._makeDraggable()),"position"===t&&this._position(),"resizable"===t&&(s=n.is(":data(ui-resizable)"),s&&!e&&n.resizable("destroy"),s&&"string"==typeof e&&n.resizable("option","handles",e),s||e===!1||this._makeResizable()),"title"===t&&this._title(this.uiDialogTitlebar.find(".ui-dialog-title")))},_size:function(){var t,e,i,s=this.options;this.element.show().css({width:"auto",minHeight:0,maxHeight:"none",height:0}),s.minWidth>s.width&&(s.width=s.minWidth),t=this.uiDialog.css({height:"auto",width:s.width}).outerHeight(),e=Math.max(0,s.minHeight-t),i="number"==typeof s.maxHeight?Math.max(0,s.maxHeight-t):"none","auto"===s.height?this.element.css({minHeight:e,maxHeight:i,height:"auto"}):this.element.height(Math.max(0,s.height-t)),this.uiDialog.is(":data(ui-resizable)")&&this.uiDialog.resizable("option","minHeight",this._minHeight())},_blockFrames:function(){this.iframeBlocks=this.document.find("iframe").map(function(){var e=t(this);return t("<div>").css({position:"absolute",width:e.outerWidth(),height:e.outerHeight()}).appendTo(e.parent()).offset(e.offset())[0]})},_unblockFrames:function(){this.iframeBlocks&&(this.iframeBlocks.remove(),delete this.iframeBlocks)},_allowInteraction:function(e){return t(e.target).closest(".ui-dialog").length?!0:!!t(e.target).closest(".ui-datepicker").length},_createOverlay:function(){if(this.options.modal){var e=!0;this._delay(function(){e=!1}),this.document.data("ui-dialog-overlays")||this._on(this.document,{focusin:function(t){e||this._allowInteraction(t)||(t.preventDefault(),this._trackingInstances()[0]._focusTabbable())}}),this.overlay=t("<div>").addClass("ui-widget-overlay ui-front").appendTo(this._appendTo()),this._on(this.overlay,{mousedown:"_keepFocus"}),this.document.data("ui-dialog-overlays",(this.document.data("ui-dialog-overlays")||0)+1)}},_destroyOverlay:function(){if(this.options.modal&&this.overlay){var t=this.document.data("ui-dialog-overlays")-1;t?this.document.data("ui-dialog-overlays",t):this.document.unbind("focusin").removeData("ui-dialog-overlays"),this.overlay.remove(),this.overlay=null}}})});


======================================================================
FILE PATH: vendor\jstree\themes\default\style.css
======================================================================
/* jsTree default theme */
.jstree-node,
.jstree-children,
.jstree-container-ul {
  display: block;
  margin: 0;
  padding: 0;
  list-style-type: none;
  list-style-image: none;
}
.jstree-node {
  white-space: nowrap;
}
.jstree-anchor {
  display: inline-block;
  color: black;
  white-space: nowrap;
  padding: 0 4px 0 1px;
  margin: 0;
  vertical-align: top;
}
.jstree-anchor:focus {
  outline: 0;
}
.jstree-anchor,
.jstree-anchor:link,
.jstree-anchor:visited,
.jstree-anchor:hover,
.jstree-anchor:active {
  text-decoration: none;
  color: inherit;
}
.jstree-icon {
  display: inline-block;
  text-decoration: none;
  margin: 0;
  padding: 0;
  vertical-align: top;
  text-align: center;
}
.jstree-icon:empty {
  display: inline-block;
  text-decoration: none;
  margin: 0;
  padding: 0;
  vertical-align: top;
  text-align: center;
}
.jstree-ocl {
  cursor: pointer;
}
.jstree-leaf > .jstree-ocl {
  cursor: default;
}
.jstree .jstree-open > .jstree-children {
  display: block;
}
.jstree .jstree-closed > .jstree-children,
.jstree .jstree-leaf > .jstree-children {
  display: none;
}
.jstree-anchor > .jstree-themeicon {
  margin-right: 2px;
}
.jstree-no-icons .jstree-themeicon,
.jstree-anchor > .jstree-themeicon-hidden {
  display: none;
}
.jstree-hidden,
.jstree-node.jstree-hidden {
  display: none;
}
.jstree-rtl .jstree-anchor {
  padding: 0 1px 0 4px;
}
.jstree-rtl .jstree-anchor > .jstree-themeicon {
  margin-left: 2px;
  margin-right: 0;
}
.jstree-rtl .jstree-node {
  margin-left: 0;
}
.jstree-rtl .jstree-container-ul > .jstree-node {
  margin-right: 0;
}
.jstree-wholerow-ul {
  position: relative;
  display: inline-block;
  min-width: 100%;
}
.jstree-wholerow-ul .jstree-leaf > .jstree-ocl {
  cursor: pointer;
}
.jstree-wholerow-ul .jstree-anchor,
.jstree-wholerow-ul .jstree-icon {
  position: relative;
}
.jstree-wholerow-ul .jstree-wholerow {
  width: 100%;
  cursor: pointer;
  position: absolute;
  left: 0;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}
.jstree-contextmenu .jstree-anchor {
  -webkit-user-select: none;
  /* disable selection/Copy of UIWebView */
  -webkit-touch-callout: none;
  /* disable the IOS popup when long-press on a link */
}
.vakata-context {
  display: none;
}
.vakata-context,
.vakata-context ul {
  margin: 0;
  padding: 2px;
  position: absolute;
  background: #f5f5f5;
  border: 1px solid #979797;
  box-shadow: 2px 2px 2px #999999;
}
.vakata-context ul {
  list-style: none;
  left: 100%;
  margin-top: -2.7em;
  margin-left: -4px;
}
.vakata-context .vakata-context-right ul {
  left: auto;
  right: 100%;
  margin-left: auto;
  margin-right: -4px;
}
.vakata-context li {
  list-style: none;
}
.vakata-context li > a {
  display: block;
  padding: 0 2em 0 2em;
  text-decoration: none;
  width: auto;
  color: black;
  white-space: nowrap;
  line-height: 2.4em;
  text-shadow: 1px 1px 0 white;
  border-radius: 1px;
}
.vakata-context li > a:hover {
  position: relative;
  background-color: #e8eff7;
  box-shadow: 0 0 2px #0a6aa1;
}
.vakata-context li > a.vakata-context-parent {
  background-image: url("data:image/gif;base64,R0lGODlhCwAHAIAAACgoKP///yH5BAEAAAEALAAAAAALAAcAAAIORI4JlrqN1oMSnmmZDQUAOw==");
  background-position: right center;
  background-repeat: no-repeat;
}
.vakata-context li > a:focus {
  outline: 0;
}
.vakata-context .vakata-context-hover > a {
  position: relative;
  background-color: #e8eff7;
  box-shadow: 0 0 2px #0a6aa1;
}
.vakata-context .vakata-context-separator > a,
.vakata-context .vakata-context-separator > a:hover {
  background: white;
  border: 0;
  border-top: 1px solid #e2e3e3;
  height: 1px;
  min-height: 1px;
  max-height: 1px;
  padding: 0;
  margin: 0 0 0 2.4em;
  border-left: 1px solid #e0e0e0;
  text-shadow: 0 0 0 transparent;
  box-shadow: 0 0 0 transparent;
  border-radius: 0;
}
.vakata-context .vakata-contextmenu-disabled a,
.vakata-context .vakata-contextmenu-disabled a:hover {
  color: silver;
  background-color: transparent;
  border: 0;
  box-shadow: 0 0 0;
}
.vakata-context .vakata-contextmenu-disabled > a > i {
  filter: grayscale(100%);
}
.vakata-context li > a > i {
  text-decoration: none;
  display: inline-block;
  width: 2.4em;
  height: 2.4em;
  background: transparent;
  margin: 0 0 0 -2em;
  vertical-align: top;
  text-align: center;
  line-height: 2.4em;
}
.vakata-context li > a > i:empty {
  width: 2.4em;
  line-height: 2.4em;
}
.vakata-context li > a .vakata-contextmenu-sep {
  display: inline-block;
  width: 1px;
  height: 2.4em;
  background: white;
  margin: 0 0.5em 0 0;
  border-left: 1px solid #e2e3e3;
}
.vakata-context .vakata-contextmenu-shortcut {
  font-size: 0.8em;
  color: silver;
  opacity: 0.5;
  display: none;
}
.vakata-context-rtl ul {
  left: auto;
  right: 100%;
  margin-left: auto;
  margin-right: -4px;
}
.vakata-context-rtl li > a.vakata-context-parent {
  background-image: url("data:image/gif;base64,R0lGODlhCwAHAIAAACgoKP///yH5BAEAAAEALAAAAAALAAcAAAINjI+AC7rWHIsPtmoxLAA7");
  background-position: left center;
  background-repeat: no-repeat;
}
.vakata-context-rtl .vakata-context-separator > a {
  margin: 0 2.4em 0 0;
  border-left: 0;
  border-right: 1px solid #e2e3e3;
}
.vakata-context-rtl .vakata-context-left ul {
  right: auto;
  left: 100%;
  margin-left: -4px;
  margin-right: auto;
}
.vakata-context-rtl li > a > i {
  margin: 0 -2em 0 0;
}
.vakata-context-rtl li > a .vakata-contextmenu-sep {
  margin: 0 0 0 0.5em;
  border-left-color: white;
  background: #e2e3e3;
}
#jstree-marker {
  position: absolute;
  top: 0;
  left: 0;
  margin: -5px 0 0 0;
  padding: 0;
  border-right: 0;
  border-top: 5px solid transparent;
  border-bottom: 5px solid transparent;
  border-left: 5px solid;
  width: 0;
  height: 0;
  font-size: 0;
  line-height: 0;
}
#jstree-dnd {
  line-height: 16px;
  margin: 0;
  padding: 4px;
}
#jstree-dnd .jstree-icon,
#jstree-dnd .jstree-copy {
  display: inline-block;
  text-decoration: none;
  margin: 0 2px 0 0;
  padding: 0;
  width: 16px;
  height: 16px;
}
#jstree-dnd .jstree-ok {
  background: green;
}
#jstree-dnd .jstree-er {
  background: red;
}
#jstree-dnd .jstree-copy {
  margin: 0 2px 0 2px;
}
.jstree-default .jstree-node,
.jstree-default .jstree-icon {
  background-repeat: no-repeat;
  background-color: transparent;
}
.jstree-default .jstree-anchor,
.jstree-default .jstree-animated,
.jstree-default .jstree-wholerow {
  transition: background-color 0.15s, box-shadow 0.15s;
}
.jstree-default .jstree-hovered {
  background: #e7f4f9;
  border-radius: 2px;
  box-shadow: inset 0 0 1px #cccccc;
}
.jstree-default .jstree-context {
  background: #e7f4f9;
  border-radius: 2px;
  box-shadow: inset 0 0 1px #cccccc;
}
.jstree-default .jstree-clicked {
  background: #beebff;
  border-radius: 2px;
  box-shadow: inset 0 0 1px #999999;
}
.jstree-default .jstree-no-icons .jstree-anchor > .jstree-themeicon {
  display: none;
}
.jstree-default .jstree-disabled {
  background: transparent;
  color: #666666;
}
.jstree-default .jstree-disabled.jstree-hovered {
  background: transparent;
  box-shadow: none;
}
.jstree-default .jstree-disabled.jstree-clicked {
  background: #efefef;
}
.jstree-default .jstree-disabled > .jstree-icon {
  opacity: 0.8;
  filter: url("data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\'><filter id=\'jstree-grayscale\'><feColorMatrix type=\'matrix\' values=\'0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0 0 0 1 0\'/></filter></svg>#jstree-grayscale");
  /* Firefox 10+ */
  filter: gray;
  /* IE6-9 */
  -webkit-filter: grayscale(100%);
  /* Chrome 19+ & Safari 6+ */
}
.jstree-default .jstree-search {
  font-style: italic;
  color: #8b0000;
  font-weight: bold;
}
.jstree-default .jstree-no-checkboxes .jstree-checkbox {
  display: none !important;
}
.jstree-default.jstree-checkbox-no-clicked .jstree-clicked {
  background: transparent;
  box-shadow: none;
}
.jstree-default.jstree-checkbox-no-clicked .jstree-clicked.jstree-hovered {
  background: #e7f4f9;
}
.jstree-default.jstree-checkbox-no-clicked > .jstree-wholerow-ul .jstree-wholerow-clicked {
  background: transparent;
}
.jstree-default.jstree-checkbox-no-clicked > .jstree-wholerow-ul .jstree-wholerow-clicked.jstree-wholerow-hovered {
  background: #e7f4f9;
}
.jstree-default > .jstree-striped {
  min-width: 100%;
  display: inline-block;
  background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAAkCAMAAAB/qqA+AAAABlBMVEUAAAAAAAClZ7nPAAAAAnRSTlMNAMM9s3UAAAAXSURBVHjajcEBAQAAAIKg/H/aCQZ70AUBjAATb6YPDgAAAABJRU5ErkJggg==") left top repeat;
}
.jstree-default > .jstree-wholerow-ul .jstree-hovered,
.jstree-default > .jstree-wholerow-ul .jstree-clicked {
  background: transparent;
  box-shadow: none;
  border-radius: 0;
}
.jstree-default .jstree-wholerow {
  -moz-box-sizing: border-box;
  -webkit-box-sizing: border-box;
  box-sizing: border-box;
}
.jstree-default .jstree-wholerow-hovered {
  background: #e7f4f9;
}
.jstree-default .jstree-wholerow-clicked {
  background: #beebff;
  background: -webkit-linear-gradient(top, #beebff 0%, #a8e4ff 100%);
  background: linear-gradient(to bottom, #beebff 0%, #a8e4ff 100%);
}
.jstree-default .jstree-node {
  min-height: 24px;
  line-height: 24px;
  margin-left: 24px;
  min-width: 24px;
}
.jstree-default .jstree-anchor {
  line-height: 24px;
  height: 24px;
}
.jstree-default .jstree-icon {
  width: 24px;
  height: 24px;
  line-height: 24px;
}
.jstree-default .jstree-icon:empty {
  width: 24px;
  height: 24px;
  line-height: 24px;
}
.jstree-default.jstree-rtl .jstree-node {
  margin-right: 24px;
}
.jstree-default .jstree-wholerow {
  height: 24px;
}
.jstree-default .jstree-node,
.jstree-default .jstree-icon {
  background-image: url("32px.png");
}
.jstree-default .jstree-node {
  background-position: -292px -4px;
  background-repeat: repeat-y;
}
.jstree-default .jstree-last {
  background: transparent;
}
.jstree-default .jstree-open > .jstree-ocl {
  background-position: -132px -4px;
}
.jstree-default .jstree-closed > .jstree-ocl {
  background-position: -100px -4px;
}
.jstree-default .jstree-leaf > .jstree-ocl {
  background-position: -68px -4px;
}
.jstree-default .jstree-themeicon {
  background-position: -260px -4px;
}
.jstree-default > .jstree-no-dots .jstree-node,
.jstree-default > .jstree-no-dots .jstree-leaf > .jstree-ocl {
  background: transparent;
}
.jstree-default > .jstree-no-dots .jstree-open > .jstree-ocl {
  background-position: -36px -4px;
}
.jstree-default > .jstree-no-dots .jstree-closed > .jstree-ocl {
  background-position: -4px -4px;
}
.jstree-default .jstree-disabled {
  background: transparent;
}
.jstree-default .jstree-disabled.jstree-hovered {
  background: transparent;
}
.jstree-default .jstree-disabled.jstree-clicked {
  background: #efefef;
}
.jstree-default .jstree-checkbox {
  background-position: -164px -4px;
}
.jstree-default .jstree-checkbox:hover {
  background-position: -164px -36px;
}
.jstree-default.jstree-checkbox-selection .jstree-clicked > .jstree-checkbox,
.jstree-default .jstree-checked > .jstree-checkbox {
  background-position: -228px -4px;
}
.jstree-default.jstree-checkbox-selection .jstree-clicked > .jstree-checkbox:hover,
.jstree-default .jstree-checked > .jstree-checkbox:hover {
  background-position: -228px -36px;
}
.jstree-default .jstree-anchor > .jstree-undetermined {
  background-position: -196px -4px;
}
.jstree-default .jstree-anchor > .jstree-undetermined:hover {
  background-position: -196px -36px;
}
.jstree-default .jstree-checkbox-disabled {
  opacity: 0.8;
  filter: url("data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\'><filter id=\'jstree-grayscale\'><feColorMatrix type=\'matrix\' values=\'0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0 0 0 1 0\'/></filter></svg>#jstree-grayscale");
  /* Firefox 10+ */
  filter: gray;
  /* IE6-9 */
  -webkit-filter: grayscale(100%);
  /* Chrome 19+ & Safari 6+ */
}
.jstree-default > .jstree-striped {
  background-size: auto 48px;
}
.jstree-default.jstree-rtl .jstree-node {
  background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAACAQMAAAB49I5GAAAABlBMVEUAAAAdHRvEkCwcAAAAAXRSTlMAQObYZgAAAAxJREFUCNdjAAMOBgAAGAAJMwQHdQAAAABJRU5ErkJggg==");
  background-position: 100% 1px;
  background-repeat: repeat-y;
}
.jstree-default.jstree-rtl .jstree-last {
  background: transparent;
}
.jstree-default.jstree-rtl .jstree-open > .jstree-ocl {
  background-position: -132px -36px;
}
.jstree-default.jstree-rtl .jstree-closed > .jstree-ocl {
  background-position: -100px -36px;
}
.jstree-default.jstree-rtl .jstree-leaf > .jstree-ocl {
  background-position: -68px -36px;
}
.jstree-default.jstree-rtl > .jstree-no-dots .jstree-node,
.jstree-default.jstree-rtl > .jstree-no-dots .jstree-leaf > .jstree-ocl {
  background: transparent;
}
.jstree-default.jstree-rtl > .jstree-no-dots .jstree-open > .jstree-ocl {
  background-position: -36px -36px;
}
.jstree-default.jstree-rtl > .jstree-no-dots .jstree-closed > .jstree-ocl {
  background-position: -4px -36px;
}
.jstree-default .jstree-themeicon-custom {
  background-color: transparent;
  background-image: none;
  background-position: 0 0;
}
.jstree-default > .jstree-container-ul .jstree-loading > .jstree-ocl {
  background: url("throbber.gif") center center no-repeat;
}
.jstree-default .jstree-file {
  background: url("32px.png") -100px -68px no-repeat;
}
.jstree-default .jstree-folder {
  background: url("32px.png") -260px -4px no-repeat;
}
.jstree-default > .jstree-container-ul > .jstree-node {
  margin-left: 0;
  margin-right: 0;
}
#jstree-dnd.jstree-default {
  line-height: 24px;
  padding: 0 4px;
}
#jstree-dnd.jstree-default .jstree-ok,
#jstree-dnd.jstree-default .jstree-er {
  background-image: url("32px.png");
  background-repeat: no-repeat;
  background-color: transparent;
}
#jstree-dnd.jstree-default i {
  background: transparent;
  width: 24px;
  height: 24px;
  line-height: 24px;
}
#jstree-dnd.jstree-default .jstree-ok {
  background-position: -4px -68px;
}
#jstree-dnd.jstree-default .jstree-er {
  background-position: -36px -68px;
}
.jstree-default .jstree-ellipsis {
  overflow: hidden;
}
.jstree-default .jstree-ellipsis .jstree-anchor {
  width: calc(100% - 29px);
  text-overflow: ellipsis;
  overflow: hidden;
}
.jstree-default.jstree-rtl .jstree-node {
  background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAACAQMAAAB49I5GAAAABlBMVEUAAAAdHRvEkCwcAAAAAXRSTlMAQObYZgAAAAxJREFUCNdjAAMOBgAAGAAJMwQHdQAAAABJRU5ErkJggg==");
}
.jstree-default.jstree-rtl .jstree-last {
  background: transparent;
}
.jstree-default-small .jstree-node {
  min-height: 18px;
  line-height: 18px;
  margin-left: 18px;
  min-width: 18px;
}
.jstree-default-small .jstree-anchor {
  line-height: 18px;
  height: 18px;
}
.jstree-default-small .jstree-icon {
  width: 18px;
  height: 18px;
  line-height: 18px;
}
.jstree-default-small .jstree-icon:empty {
  width: 18px;
  height: 18px;
  line-height: 18px;
}
.jstree-default-small.jstree-rtl .jstree-node {
  margin-right: 18px;
}
.jstree-default-small .jstree-wholerow {
  height: 18px;
}
.jstree-default-small .jstree-node,
.jstree-default-small .jstree-icon {
  background-image: url("32px.png");
}
.jstree-default-small .jstree-node {
  background-position: -295px -7px;
  background-repeat: repeat-y;
}
.jstree-default-small .jstree-last {
  background: transparent;
}
.jstree-default-small .jstree-open > .jstree-ocl {
  background-position: -135px -7px;
}
.jstree-default-small .jstree-closed > .jstree-ocl {
  background-position: -103px -7px;
}
.jstree-default-small .jstree-leaf > .jstree-ocl {
  background-position: -71px -7px;
}
.jstree-default-small .jstree-themeicon {
  background-position: -263px -7px;
}
.jstree-default-small > .jstree-no-dots .jstree-node,
.jstree-default-small > .jstree-no-dots .jstree-leaf > .jstree-ocl {
  background: transparent;
}
.jstree-default-small > .jstree-no-dots .jstree-open > .jstree-ocl {
  background-position: -39px -7px;
}
.jstree-default-small > .jstree-no-dots .jstree-closed > .jstree-ocl {
  background-position: -7px -7px;
}
.jstree-default-small .jstree-disabled {
  background: transparent;
}
.jstree-default-small .jstree-disabled.jstree-hovered {
  background: transparent;
}
.jstree-default-small .jstree-disabled.jstree-clicked {
  background: #efefef;
}
.jstree-default-small .jstree-checkbox {
  background-position: -167px -7px;
}
.jstree-default-small .jstree-checkbox:hover {
  background-position: -167px -39px;
}
.jstree-default-small.jstree-checkbox-selection .jstree-clicked > .jstree-checkbox,
.jstree-default-small .jstree-checked > .jstree-checkbox {
  background-position: -231px -7px;
}
.jstree-default-small.jstree-checkbox-selection .jstree-clicked > .jstree-checkbox:hover,
.jstree-default-small .jstree-checked > .jstree-checkbox:hover {
  background-position: -231px -39px;
}
.jstree-default-small .jstree-anchor > .jstree-undetermined {
  background-position: -199px -7px;
}
.jstree-default-small .jstree-anchor > .jstree-undetermined:hover {
  background-position: -199px -39px;
}
.jstree-default-small .jstree-checkbox-disabled {
  opacity: 0.8;
  filter: url("data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\'><filter id=\'jstree-grayscale\'><feColorMatrix type=\'matrix\' values=\'0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0 0 0 1 0\'/></filter></svg>#jstree-grayscale");
  /* Firefox 10+ */
  filter: gray;
  /* IE6-9 */
  -webkit-filter: grayscale(100%);
  /* Chrome 19+ & Safari 6+ */
}
.jstree-default-small > .jstree-striped {
  background-size: auto 36px;
}
.jstree-default-small.jstree-rtl .jstree-node {
  background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAACAQMAAAB49I5GAAAABlBMVEUAAAAdHRvEkCwcAAAAAXRSTlMAQObYZgAAAAxJREFUCNdjAAMOBgAAGAAJMwQHdQAAAABJRU5ErkJggg==");
  background-position: 100% 1px;
  background-repeat: repeat-y;
}
.jstree-default-small.jstree-rtl .jstree-last {
  background: transparent;
}
.jstree-default-small.jstree-rtl .jstree-open > .jstree-ocl {
  background-position: -135px -39px;
}
.jstree-default-small.jstree-rtl .jstree-closed > .jstree-ocl {
  background-position: -103px -39px;
}
.jstree-default-small.jstree-rtl .jstree-leaf > .jstree-ocl {
  background-position: -71px -39px;
}
.jstree-default-small.jstree-rtl > .jstree-no-dots .jstree-node,
.jstree-default-small.jstree-rtl > .jstree-no-dots .jstree-leaf > .jstree-ocl {
  background: transparent;
}
.jstree-default-small.jstree-rtl > .jstree-no-dots .jstree-open > .jstree-ocl {
  background-position: -39px -39px;
}
.jstree-default-small.jstree-rtl > .jstree-no-dots .jstree-closed > .jstree-ocl {
  background-position: -7px -39px;
}
.jstree-default-small .jstree-themeicon-custom {
  background-color: transparent;
  background-image: none;
  background-position: 0 0;
}
.jstree-default-small > .jstree-container-ul .jstree-loading > .jstree-ocl {
  background: url("throbber.gif") center center no-repeat;
}
.jstree-default-small .jstree-file {
  background: url("32px.png") -103px -71px no-repeat;
}
.jstree-default-small .jstree-folder {
  background: url("32px.png") -263px -7px no-repeat;
}
.jstree-default-small > .jstree-container-ul > .jstree-node {
  margin-left: 0;
  margin-right: 0;
}
#jstree-dnd.jstree-default-small {
  line-height: 18px;
  padding: 0 4px;
}
#jstree-dnd.jstree-default-small .jstree-ok,
#jstree-dnd.jstree-default-small .jstree-er {
  background-image: url("32px.png");
  background-repeat: no-repeat;
  background-color: transparent;
}
#jstree-dnd.jstree-default-small i {
  background: transparent;
  width: 18px;
  height: 18px;
  line-height: 18px;
}
#jstree-dnd.jstree-default-small .jstree-ok {
  background-position: -7px -71px;
}
#jstree-dnd.jstree-default-small .jstree-er {
  background-position: -39px -71px;
}
.jstree-default-small .jstree-ellipsis {
  overflow: hidden;
}
.jstree-default-small .jstree-ellipsis .jstree-anchor {
  width: calc(100% - 23px);
  text-overflow: ellipsis;
  overflow: hidden;
}
.jstree-default-small.jstree-rtl .jstree-node {
  background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAACAQMAAABv1h6PAAAABlBMVEUAAAAdHRvEkCwcAAAAAXRSTlMAQObYZgAAAAxJREFUCNdjAAMHBgAAiABBI4gz9AAAAABJRU5ErkJggg==");
}
.jstree-default-small.jstree-rtl .jstree-last {
  background: transparent;
}
.jstree-default-large .jstree-node {
  min-height: 32px;
  line-height: 32px;
  margin-left: 32px;
  min-width: 32px;
}
.jstree-default-large .jstree-anchor {
  line-height: 32px;
  height: 32px;
}
.jstree-default-large .jstree-icon {
  width: 32px;
  height: 32px;
  line-height: 32px;
}
.jstree-default-large .jstree-icon:empty {
  width: 32px;
  height: 32px;
  line-height: 32px;
}
.jstree-default-large.jstree-rtl .jstree-node {
  margin-right: 32px;
}
.jstree-default-large .jstree-wholerow {
  height: 32px;
}
.jstree-default-large .jstree-node,
.jstree-default-large .jstree-icon {
  background-image: url("32px.png");
}
.jstree-default-large .jstree-node {
  background-position: -288px 0px;
  background-repeat: repeat-y;
}
.jstree-default-large .jstree-last {
  background: transparent;
}
.jstree-default-large .jstree-open > .jstree-ocl {
  background-position: -128px 0px;
}
.jstree-default-large .jstree-closed > .jstree-ocl {
  background-position: -96px 0px;
}
.jstree-default-large .jstree-leaf > .jstree-ocl {
  background-position: -64px 0px;
}
.jstree-default-large .jstree-themeicon {
  background-position: -256px 0px;
}
.jstree-default-large > .jstree-no-dots .jstree-node,
.jstree-default-large > .jstree-no-dots .jstree-leaf > .jstree-ocl {
  background: transparent;
}
.jstree-default-large > .jstree-no-dots .jstree-open > .jstree-ocl {
  background-position: -32px 0px;
}
.jstree-default-large > .jstree-no-dots .jstree-closed > .jstree-ocl {
  background-position: 0px 0px;
}
.jstree-default-large .jstree-disabled {
  background: transparent;
}
.jstree-default-large .jstree-disabled.jstree-hovered {
  background: transparent;
}
.jstree-default-large .jstree-disabled.jstree-clicked {
  background: #efefef;
}
.jstree-default-large .jstree-checkbox {
  background-position: -160px 0px;
}
.jstree-default-large .jstree-checkbox:hover {
  background-position: -160px -32px;
}
.jstree-default-large.jstree-checkbox-selection .jstree-clicked > .jstree-checkbox,
.jstree-default-large .jstree-checked > .jstree-checkbox {
  background-position: -224px 0px;
}
.jstree-default-large.jstree-checkbox-selection .jstree-clicked > .jstree-checkbox:hover,
.jstree-default-large .jstree-checked > .jstree-checkbox:hover {
  background-position: -224px -32px;
}
.jstree-default-large .jstree-anchor > .jstree-undetermined {
  background-position: -192px 0px;
}
.jstree-default-large .jstree-anchor > .jstree-undetermined:hover {
  background-position: -192px -32px;
}
.jstree-default-large .jstree-checkbox-disabled {
  opacity: 0.8;
  filter: url("data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\'><filter id=\'jstree-grayscale\'><feColorMatrix type=\'matrix\' values=\'0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0 0 0 1 0\'/></filter></svg>#jstree-grayscale");
  /* Firefox 10+ */
  filter: gray;
  /* IE6-9 */
  -webkit-filter: grayscale(100%);
  /* Chrome 19+ & Safari 6+ */
}
.jstree-default-large > .jstree-striped {
  background-size: auto 64px;
}
.jstree-default-large.jstree-rtl .jstree-node {
  background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAACAQMAAAB49I5GAAAABlBMVEUAAAAdHRvEkCwcAAAAAXRSTlMAQObYZgAAAAxJREFUCNdjAAMOBgAAGAAJMwQHdQAAAABJRU5ErkJggg==");
  background-position: 100% 1px;
  background-repeat: repeat-y;
}
.jstree-default-large.jstree-rtl .jstree-last {
  background: transparent;
}
.jstree-default-large.jstree-rtl .jstree-open > .jstree-ocl {
  background-position: -128px -32px;
}
.jstree-default-large.jstree-rtl .jstree-closed > .jstree-ocl {
  background-position: -96px -32px;
}
.jstree-default-large.jstree-rtl .jstree-leaf > .jstree-ocl {
  background-position: -64px -32px;
}
.jstree-default-large.jstree-rtl > .jstree-no-dots .jstree-node,
.jstree-default-large.jstree-rtl > .jstree-no-dots .jstree-leaf > .jstree-ocl {
  background: transparent;
}
.jstree-default-large.jstree-rtl > .jstree-no-dots .jstree-open > .jstree-ocl {
  background-position: -32px -32px;
}
.jstree-default-large.jstree-rtl > .jstree-no-dots .jstree-closed > .jstree-ocl {
  background-position: 0px -32px;
}
.jstree-default-large .jstree-themeicon-custom {
  background-color: transparent;
  background-image: none;
  background-position: 0 0;
}
.jstree-default-large > .jstree-container-ul .jstree-loading > .jstree-ocl {
  background: url("throbber.gif") center center no-repeat;
}
.jstree-default-large .jstree-file {
  background: url("32px.png") -96px -64px no-repeat;
}
.jstree-default-large .jstree-folder {
  background: url("32px.png") -256px 0px no-repeat;
}
.jstree-default-large > .jstree-container-ul > .jstree-node {
  margin-left: 0;
  margin-right: 0;
}
#jstree-dnd.jstree-default-large {
  line-height: 32px;
  padding: 0 4px;
}
#jstree-dnd.jstree-default-large .jstree-ok,
#jstree-dnd.jstree-default-large .jstree-er {
  background-image: url("32px.png");
  background-repeat: no-repeat;
  background-color: transparent;
}
#jstree-dnd.jstree-default-large i {
  background: transparent;
  width: 32px;
  height: 32px;
  line-height: 32px;
}
#jstree-dnd.jstree-default-large .jstree-ok {
  background-position: 0px -64px;
}
#jstree-dnd.jstree-default-large .jstree-er {
  background-position: -32px -64px;
}
.jstree-default-large .jstree-ellipsis {
  overflow: hidden;
}
.jstree-default-large .jstree-ellipsis .jstree-anchor {
  width: calc(100% - 37px);
  text-overflow: ellipsis;
  overflow: hidden;
}
.jstree-default-large.jstree-rtl .jstree-node {
  background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAACAQMAAAAD0EyKAAAABlBMVEUAAAAdHRvEkCwcAAAAAXRSTlMAQObYZgAAAAxJREFUCNdjgIIGBgABCgCBvVLXcAAAAABJRU5ErkJggg==");
}
.jstree-default-large.jstree-rtl .jstree-last {
  background: transparent;
}
@media (max-width: 768px) {
  #jstree-dnd.jstree-dnd-responsive {
    line-height: 40px;
    font-weight: bold;
    font-size: 1.1em;
    text-shadow: 1px 1px white;
  }
  #jstree-dnd.jstree-dnd-responsive > i {
    background: transparent;
    width: 40px;
    height: 40px;
  }
  #jstree-dnd.jstree-dnd-responsive > .jstree-ok {
    background-image: url("40px.png");
    background-position: 0 -200px;
    background-size: 120px 240px;
  }
  #jstree-dnd.jstree-dnd-responsive > .jstree-er {
    background-image: url("40px.png");
    background-position: -40px -200px;
    background-size: 120px 240px;
  }
  #jstree-marker.jstree-dnd-responsive {
    border-left-width: 10px;
    border-top-width: 10px;
    border-bottom-width: 10px;
    margin-top: -10px;
  }
}
@media (max-width: 768px) {
  .jstree-default-responsive {
    /*
	.jstree-open > .jstree-ocl,
	.jstree-closed > .jstree-ocl { border-radius:20px; background-color:white; }
	*/
  }
  .jstree-default-responsive .jstree-icon {
    background-image: url("40px.png");
  }
  .jstree-default-responsive .jstree-node,
  .jstree-default-responsive .jstree-leaf > .jstree-ocl {
    background: transparent;
  }
  .jstree-default-responsive .jstree-node {
    min-height: 40px;
    line-height: 40px;
    margin-left: 40px;
    min-width: 40px;
    white-space: nowrap;
  }
  .jstree-default-responsive .jstree-anchor {
    line-height: 40px;
    height: 40px;
  }
  .jstree-default-responsive .jstree-icon,
  .jstree-default-responsive .jstree-icon:empty {
    width: 40px;
    height: 40px;
    line-height: 40px;
  }
  .jstree-default-responsive > .jstree-container-ul > .jstree-node {
    margin-left: 0;
  }
  .jstree-default-responsive.jstree-rtl .jstree-node {
    margin-left: 0;
    margin-right: 40px;
    background: transparent;
  }
  .jstree-default-responsive.jstree-rtl .jstree-container-ul > .jstree-node {
    margin-right: 0;
  }
  .jstree-default-responsive .jstree-ocl,
  .jstree-default-responsive .jstree-themeicon,
  .jstree-default-responsive .jstree-checkbox {
    background-size: 120px 240px;
  }
  .jstree-default-responsive .jstree-leaf > .jstree-ocl,
  .jstree-default-responsive.jstree-rtl .jstree-leaf > .jstree-ocl {
    background: transparent;
  }
  .jstree-default-responsive .jstree-open > .jstree-ocl {
    background-position: 0 0 !important;
  }
  .jstree-default-responsive .jstree-closed > .jstree-ocl {
    background-position: 0 -40px !important;
  }
  .jstree-default-responsive.jstree-rtl .jstree-closed > .jstree-ocl {
    background-position: -40px 0 !important;
  }
  .jstree-default-responsive .jstree-themeicon {
    background-position: -40px -40px;
  }
  .jstree-default-responsive .jstree-checkbox,
  .jstree-default-responsive .jstree-checkbox:hover {
    background-position: -40px -80px;
  }
  .jstree-default-responsive.jstree-checkbox-selection .jstree-clicked > .jstree-checkbox,
  .jstree-default-responsive.jstree-checkbox-selection .jstree-clicked > .jstree-checkbox:hover,
  .jstree-default-responsive .jstree-checked > .jstree-checkbox,
  .jstree-default-responsive .jstree-checked > .jstree-checkbox:hover {
    background-position: 0 -80px;
  }
  .jstree-default-responsive .jstree-anchor > .jstree-undetermined,
  .jstree-default-responsive .jstree-anchor > .jstree-undetermined:hover {
    background-position: 0 -120px;
  }
  .jstree-default-responsive .jstree-anchor {
    font-weight: bold;
    font-size: 1.1em;
    text-shadow: 1px 1px white;
  }
  .jstree-default-responsive > .jstree-striped {
    background: transparent;
  }
  .jstree-default-responsive .jstree-wholerow {
    border-top: 1px solid rgba(255, 255, 255, 0.7);
    border-bottom: 1px solid rgba(64, 64, 64, 0.2);
    background: #ebebeb;
    height: 40px;
  }
  .jstree-default-responsive .jstree-wholerow-hovered {
    background: #e7f4f9;
  }
  .jstree-default-responsive .jstree-wholerow-clicked {
    background: #beebff;
  }
  .jstree-default-responsive .jstree-children .jstree-last > .jstree-wholerow {
    box-shadow: inset 0 -6px 3px -5px #666666;
  }
  .jstree-default-responsive .jstree-children .jstree-open > .jstree-wholerow {
    box-shadow: inset 0 6px 3px -5px #666666;
    border-top: 0;
  }
  .jstree-default-responsive .jstree-children .jstree-open + .jstree-open {
    box-shadow: none;
  }
  .jstree-default-responsive .jstree-node,
  .jstree-default-responsive .jstree-icon,
  .jstree-default-responsive .jstree-node > .jstree-ocl,
  .jstree-default-responsive .jstree-themeicon,
  .jstree-default-responsive .jstree-checkbox {
    background-image: url("40px.png");
    background-size: 120px 240px;
  }
  .jstree-default-responsive .jstree-node {
    background-position: -80px 0;
    background-repeat: repeat-y;
  }
  .jstree-default-responsive .jstree-last {
    background: transparent;
  }
  .jstree-default-responsive .jstree-leaf > .jstree-ocl {
    background-position: -40px -120px;
  }
  .jstree-default-responsive .jstree-last > .jstree-ocl {
    background-position: -40px -160px;
  }
  .jstree-default-responsive .jstree-themeicon-custom {
    background-color: transparent;
    background-image: none;
    background-position: 0 0;
  }
  .jstree-default-responsive .jstree-file {
    background: url("40px.png") 0 -160px no-repeat;
    background-size: 120px 240px;
  }
  .jstree-default-responsive .jstree-folder {
    background: url("40px.png") -40px -40px no-repeat;
    background-size: 120px 240px;
  }
  .jstree-default-responsive > .jstree-container-ul > .jstree-node {
    margin-left: 0;
    margin-right: 0;
  }
}



======================================================================
FILE PATH: vendor\jstree\jstree.min.js
======================================================================
/*! jsTree - v3.3.7 - 2018-11-06 - (MIT) */
!function(a){"use strict";"function"==typeof define&&define.amd?define(["jquery"],a):"undefined"!=typeof module&&module.exports?module.exports=a(require("jquery")):a(jQuery)}(function(a,b){"use strict";if(!a.jstree){var c=0,d=!1,e=!1,f=!1,g=[],h=a("script:last").attr("src"),i=window.document;a.jstree={version:"3.3.7",defaults:{plugins:[]},plugins:{},path:h&&-1!==h.indexOf("/")?h.replace(/\/[^\/]+$/,""):"",idregex:/[\\:&!^|()\[\]<>@*'+~#";.,=\- \/${}%?`]/g,root:"#"},a.jstree.create=function(b,d){var e=new a.jstree.core(++c),f=d;return d=a.extend(!0,{},a.jstree.defaults,d),f&&f.plugins&&(d.plugins=f.plugins),a.each(d.plugins,function(a,b){"core"!==a&&(e=e.plugin(b,d[b]))}),a(b).data("jstree",e),e.init(b,d),e},a.jstree.destroy=function(){a(".jstree:jstree").jstree("destroy"),a(i).off(".jstree")},a.jstree.core=function(a){this._id=a,this._cnt=0,this._wrk=null,this._data={core:{themes:{name:!1,dots:!1,icons:!1,ellipsis:!1},selected:[],last_error:{},working:!1,worker_queue:[],focused:null}}},a.jstree.reference=function(b){var c=null,d=null;if(!b||!b.id||b.tagName&&b.nodeType||(b=b.id),!d||!d.length)try{d=a(b)}catch(e){}if(!d||!d.length)try{d=a("#"+b.replace(a.jstree.idregex,"\\$&"))}catch(e){}return d&&d.length&&(d=d.closest(".jstree")).length&&(d=d.data("jstree"))?c=d:a(".jstree").each(function(){var d=a(this).data("jstree");return d&&d._model.data[b]?(c=d,!1):void 0}),c},a.fn.jstree=function(c){var d="string"==typeof c,e=Array.prototype.slice.call(arguments,1),f=null;return c!==!0||this.length?(this.each(function(){var g=a.jstree.reference(this),h=d&&g?g[c]:null;return f=d&&h?h.apply(g,e):null,g||d||c!==b&&!a.isPlainObject(c)||a.jstree.create(this,c),(g&&!d||c===!0)&&(f=g||!1),null!==f&&f!==b?!1:void 0}),null!==f&&f!==b?f:this):!1},a.expr.pseudos.jstree=a.expr.createPseudo(function(c){return function(c){return a(c).hasClass("jstree")&&a(c).data("jstree")!==b}}),a.jstree.defaults.core={data:!1,strings:!1,check_callback:!1,error:a.noop,animation:200,multiple:!0,themes:{name:!1,url:!1,dir:!1,dots:!0,icons:!0,ellipsis:!1,stripes:!1,variant:!1,responsive:!1},expand_selected_onload:!0,worker:!0,force_text:!1,dblclick_toggle:!0,loaded_state:!1,restore_focus:!0,keyboard:{"ctrl-space":function(b){b.type="click",a(b.currentTarget).trigger(b)},enter:function(b){b.type="click",a(b.currentTarget).trigger(b)},left:function(b){if(b.preventDefault(),this.is_open(b.currentTarget))this.close_node(b.currentTarget);else{var c=this.get_parent(b.currentTarget);c&&c.id!==a.jstree.root&&this.get_node(c,!0).children(".jstree-anchor").focus()}},up:function(a){a.preventDefault();var b=this.get_prev_dom(a.currentTarget);b&&b.length&&b.children(".jstree-anchor").focus()},right:function(b){if(b.preventDefault(),this.is_closed(b.currentTarget))this.open_node(b.currentTarget,function(a){this.get_node(a,!0).children(".jstree-anchor").focus()});else if(this.is_open(b.currentTarget)){var c=this.get_node(b.currentTarget,!0).children(".jstree-children")[0];c&&a(this._firstChild(c)).children(".jstree-anchor").focus()}},down:function(a){a.preventDefault();var b=this.get_next_dom(a.currentTarget);b&&b.length&&b.children(".jstree-anchor").focus()},"*":function(a){this.open_all()},home:function(b){b.preventDefault();var c=this._firstChild(this.get_container_ul()[0]);c&&a(c).children(".jstree-anchor").filter(":visible").focus()},end:function(a){a.preventDefault(),this.element.find(".jstree-anchor").filter(":visible").last().focus()},f2:function(a){a.preventDefault(),this.edit(a.currentTarget)}}},a.jstree.core.prototype={plugin:function(b,c){var d=a.jstree.plugins[b];return d?(this._data[b]={},d.prototype=this,new d(c,this)):this},init:function(b,c){this._model={data:{},changed:[],force_full_redraw:!1,redraw_timeout:!1,default_state:{loaded:!0,opened:!1,selected:!1,disabled:!1}},this._model.data[a.jstree.root]={id:a.jstree.root,parent:null,parents:[],children:[],children_d:[],state:{loaded:!1}},this.element=a(b).addClass("jstree jstree-"+this._id),this.settings=c,this._data.core.ready=!1,this._data.core.loaded=!1,this._data.core.rtl="rtl"===this.element.css("direction"),this.element[this._data.core.rtl?"addClass":"removeClass"]("jstree-rtl"),this.element.attr("role","tree"),this.settings.core.multiple&&this.element.attr("aria-multiselectable",!0),this.element.attr("tabindex")||this.element.attr("tabindex","0"),this.bind(),this.trigger("init"),this._data.core.original_container_html=this.element.find(" > ul > li").clone(!0),this._data.core.original_container_html.find("li").addBack().contents().filter(function(){return 3===this.nodeType&&(!this.nodeValue||/^\s+$/.test(this.nodeValue))}).remove(),this.element.html("<ul class='jstree-container-ul jstree-children' role='group'><li id='j"+this._id+"_loading' class='jstree-initial-node jstree-loading jstree-leaf jstree-last' role='tree-item'><i class='jstree-icon jstree-ocl'></i><a class='jstree-anchor' href='#'><i class='jstree-icon jstree-themeicon-hidden'></i>"+this.get_string("Loading ...")+"</a></li></ul>"),this.element.attr("aria-activedescendant","j"+this._id+"_loading"),this._data.core.li_height=this.get_container_ul().children("li").first().outerHeight()||24,this._data.core.node=this._create_prototype_node(),this.trigger("loading"),this.load_node(a.jstree.root)},destroy:function(a){if(this.trigger("destroy"),this._wrk)try{window.URL.revokeObjectURL(this._wrk),this._wrk=null}catch(b){}a||this.element.empty(),this.teardown()},_create_prototype_node:function(){var a=i.createElement("LI"),b,c;return a.setAttribute("role","treeitem"),b=i.createElement("I"),b.className="jstree-icon jstree-ocl",b.setAttribute("role","presentation"),a.appendChild(b),b=i.createElement("A"),b.className="jstree-anchor",b.setAttribute("href","#"),b.setAttribute("tabindex","-1"),c=i.createElement("I"),c.className="jstree-icon jstree-themeicon",c.setAttribute("role","presentation"),b.appendChild(c),a.appendChild(b),b=c=null,a},_kbevent_to_func:function(a){var b={8:"Backspace",9:"Tab",13:"Return",19:"Pause",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",44:"Print",45:"Insert",46:"Delete",96:"Numpad0",97:"Numpad1",98:"Numpad2",99:"Numpad3",100:"Numpad4",101:"Numpad5",102:"Numpad6",103:"Numpad7",104:"Numpad8",105:"Numpad9","-13":"NumpadEnter",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"Numlock",145:"Scrolllock",16:"Shift",17:"Ctrl",18:"Alt",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",59:";",61:"=",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",107:"+",109:"-",110:".",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",111:"/",106:"*",173:"-"},c=[];a.ctrlKey&&c.push("ctrl"),a.altKey&&c.push("alt"),a.shiftKey&&c.push("shift"),c.push(b[a.which]||a.which),c=c.sort().join("-").toLowerCase();var d=this.settings.core.keyboard,e,f;for(e in d)if(d.hasOwnProperty(e)&&(f=e,"-"!==f&&"+"!==f&&(f=f.replace("--","-MINUS").replace("+-","-MINUS").replace("++","-PLUS").replace("-+","-PLUS"),f=f.split(/-|\+/).sort().join("-").replace("MINUS","-").replace("PLUS","+").toLowerCase()),f===c))return d[e];return null},teardown:function(){this.unbind(),this.element.removeClass("jstree").removeData("jstree").find("[class^='jstree']").addBack().attr("class",function(){return this.className.replace(/jstree[^ ]*|$/gi,"")}),this.element=null},bind:function(){var b="",c=null,d=0;this.element.on("dblclick.jstree",function(a){if(a.target.tagName&&"input"===a.target.tagName.toLowerCase())return!0;if(i.selection&&i.selection.empty)i.selection.empty();else if(window.getSelection){var b=window.getSelection();try{b.removeAllRanges(),b.collapse()}catch(c){}}}).on("mousedown.jstree",a.proxy(function(a){a.target===this.element[0]&&(a.preventDefault(),d=+new Date)},this)).on("mousedown.jstree",".jstree-ocl",function(a){a.preventDefault()}).on("click.jstree",".jstree-ocl",a.proxy(function(a){this.toggle_node(a.target)},this)).on("dblclick.jstree",".jstree-anchor",a.proxy(function(a){return a.target.tagName&&"input"===a.target.tagName.toLowerCase()?!0:void(this.settings.core.dblclick_toggle&&this.toggle_node(a.target))},this)).on("click.jstree",".jstree-anchor",a.proxy(function(b){b.preventDefault(),b.currentTarget!==i.activeElement&&a(b.currentTarget).focus(),this.activate_node(b.currentTarget,b)},this)).on("keydown.jstree",".jstree-anchor",a.proxy(function(a){if(a.target.tagName&&"input"===a.target.tagName.toLowerCase())return!0;this._data.core.rtl&&(37===a.which?a.which=39:39===a.which&&(a.which=37));var b=this._kbevent_to_func(a);if(b){var c=b.call(this,a);if(c===!1||c===!0)return c}},this)).on("load_node.jstree",a.proxy(function(b,c){c.status&&(c.node.id!==a.jstree.root||this._data.core.loaded||(this._data.core.loaded=!0,this._firstChild(this.get_container_ul()[0])&&this.element.attr("aria-activedescendant",this._firstChild(this.get_container_ul()[0]).id),this.trigger("loaded")),this._data.core.ready||setTimeout(a.proxy(function(){if(this.element&&!this.get_container_ul().find(".jstree-loading").length){if(this._data.core.ready=!0,this._data.core.selected.length){if(this.settings.core.expand_selected_onload){var b=[],c,d;for(c=0,d=this._data.core.selected.length;d>c;c++)b=b.concat(this._model.data[this._data.core.selected[c]].parents);for(b=a.vakata.array_unique(b),c=0,d=b.length;d>c;c++)this.open_node(b[c],!1,0)}this.trigger("changed",{action:"ready",selected:this._data.core.selected})}this.trigger("ready")}},this),0))},this)).on("keypress.jstree",a.proxy(function(d){if(d.target.tagName&&"input"===d.target.tagName.toLowerCase())return!0;c&&clearTimeout(c),c=setTimeout(function(){b=""},500);var e=String.fromCharCode(d.which).toLowerCase(),f=this.element.find(".jstree-anchor").filter(":visible"),g=f.index(i.activeElement)||0,h=!1;if(b+=e,b.length>1){if(f.slice(g).each(a.proxy(function(c,d){return 0===a(d).text().toLowerCase().indexOf(b)?(a(d).focus(),h=!0,!1):void 0},this)),h)return;if(f.slice(0,g).each(a.proxy(function(c,d){return 0===a(d).text().toLowerCase().indexOf(b)?(a(d).focus(),h=!0,!1):void 0},this)),h)return}if(new RegExp("^"+e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")+"+$").test(b)){if(f.slice(g+1).each(a.proxy(function(b,c){return a(c).text().toLowerCase().charAt(0)===e?(a(c).focus(),h=!0,!1):void 0},this)),h)return;if(f.slice(0,g+1).each(a.proxy(function(b,c){return a(c).text().toLowerCase().charAt(0)===e?(a(c).focus(),h=!0,!1):void 0},this)),h)return}},this)).on("init.jstree",a.proxy(function(){var a=this.settings.core.themes;this._data.core.themes.dots=a.dots,this._data.core.themes.stripes=a.stripes,this._data.core.themes.icons=a.icons,this._data.core.themes.ellipsis=a.ellipsis,this.set_theme(a.name||"default",a.url),this.set_theme_variant(a.variant)},this)).on("loading.jstree",a.proxy(function(){this[this._data.core.themes.dots?"show_dots":"hide_dots"](),this[this._data.core.themes.icons?"show_icons":"hide_icons"](),this[this._data.core.themes.stripes?"show_stripes":"hide_stripes"](),this[this._data.core.themes.ellipsis?"show_ellipsis":"hide_ellipsis"]()},this)).on("blur.jstree",".jstree-anchor",a.proxy(function(b){this._data.core.focused=null,a(b.currentTarget).filter(".jstree-hovered").mouseleave(),this.element.attr("tabindex","0")},this)).on("focus.jstree",".jstree-anchor",a.proxy(function(b){var c=this.get_node(b.currentTarget);c&&c.id&&(this._data.core.focused=c.id),this.element.find(".jstree-hovered").not(b.currentTarget).mouseleave(),a(b.currentTarget).mouseenter(),this.element.attr("tabindex","-1")},this)).on("focus.jstree",a.proxy(function(){if(+new Date-d>500&&!this._data.core.focused&&this.settings.core.restore_focus){d=0;var a=this.get_node(this.element.attr("aria-activedescendant"),!0);a&&a.find("> .jstree-anchor").focus()}},this)).on("mouseenter.jstree",".jstree-anchor",a.proxy(function(a){this.hover_node(a.currentTarget)},this)).on("mouseleave.jstree",".jstree-anchor",a.proxy(function(a){this.dehover_node(a.currentTarget)},this))},unbind:function(){this.element.off(".jstree"),a(i).off(".jstree-"+this._id)},trigger:function(a,b){b||(b={}),b.instance=this,this.element.triggerHandler(a.replace(".jstree","")+".jstree",b)},get_container:function(){return this.element},get_container_ul:function(){return this.element.children(".jstree-children").first()},get_string:function(b){var c=this.settings.core.strings;return a.isFunction(c)?c.call(this,b):c&&c[b]?c[b]:b},_firstChild:function(a){a=a?a.firstChild:null;while(null!==a&&1!==a.nodeType)a=a.nextSibling;return a},_nextSibling:function(a){a=a?a.nextSibling:null;while(null!==a&&1!==a.nodeType)a=a.nextSibling;return a},_previousSibling:function(a){a=a?a.previousSibling:null;while(null!==a&&1!==a.nodeType)a=a.previousSibling;return a},get_node:function(b,c){b&&b.id&&(b=b.id),b instanceof jQuery&&b.length&&b[0].id&&(b=b[0].id);var d;try{if(this._model.data[b])b=this._model.data[b];else if("string"==typeof b&&this._model.data[b.replace(/^#/,"")])b=this._model.data[b.replace(/^#/,"")];else if("string"==typeof b&&(d=a("#"+b.replace(a.jstree.idregex,"\\$&"),this.element)).length&&this._model.data[d.closest(".jstree-node").attr("id")])b=this._model.data[d.closest(".jstree-node").attr("id")];else if((d=this.element.find(b)).length&&this._model.data[d.closest(".jstree-node").attr("id")])b=this._model.data[d.closest(".jstree-node").attr("id")];else{if(!(d=this.element.find(b)).length||!d.hasClass("jstree"))return!1;b=this._model.data[a.jstree.root]}return c&&(b=b.id===a.jstree.root?this.element:a("#"+b.id.replace(a.jstree.idregex,"\\$&"),this.element)),b}catch(e){return!1}},get_path:function(b,c,d){if(b=b.parents?b:this.get_node(b),!b||b.id===a.jstree.root||!b.parents)return!1;var e,f,g=[];for(g.push(d?b.id:b.text),e=0,f=b.parents.length;f>e;e++)g.push(d?b.parents[e]:this.get_text(b.parents[e]));return g=g.reverse().slice(1),c?g.join(c):g},get_next_dom:function(b,c){var d;if(b=this.get_node(b,!0),b[0]===this.element[0]){d=this._firstChild(this.get_container_ul()[0]);while(d&&0===d.offsetHeight)d=this._nextSibling(d);return d?a(d):!1}if(!b||!b.length)return!1;if(c){d=b[0];do d=this._nextSibling(d);while(d&&0===d.offsetHeight);return d?a(d):!1}if(b.hasClass("jstree-open")){d=this._firstChild(b.children(".jstree-children")[0]);while(d&&0===d.offsetHeight)d=this._nextSibling(d);if(null!==d)return a(d)}d=b[0];do d=this._nextSibling(d);while(d&&0===d.offsetHeight);return null!==d?a(d):b.parentsUntil(".jstree",".jstree-node").nextAll(".jstree-node:visible").first()},get_prev_dom:function(b,c){var d;if(b=this.get_node(b,!0),b[0]===this.element[0]){d=this.get_container_ul()[0].lastChild;while(d&&0===d.offsetHeight)d=this._previousSibling(d);return d?a(d):!1}if(!b||!b.length)return!1;if(c){d=b[0];do d=this._previousSibling(d);while(d&&0===d.offsetHeight);return d?a(d):!1}d=b[0];do d=this._previousSibling(d);while(d&&0===d.offsetHeight);if(null!==d){b=a(d);while(b.hasClass("jstree-open"))b=b.children(".jstree-children").first().children(".jstree-node:visible:last");return b}return d=b[0].parentNode.parentNode,d&&d.className&&-1!==d.className.indexOf("jstree-node")?a(d):!1},get_parent:function(b){return b=this.get_node(b),b&&b.id!==a.jstree.root?b.parent:!1},get_children_dom:function(a){return a=this.get_node(a,!0),a[0]===this.element[0]?this.get_container_ul().children(".jstree-node"):a&&a.length?a.children(".jstree-children").children(".jstree-node"):!1},is_parent:function(a){return a=this.get_node(a),a&&(a.state.loaded===!1||a.children.length>0)},is_loaded:function(a){return a=this.get_node(a),a&&a.state.loaded},is_loading:function(a){return a=this.get_node(a),a&&a.state&&a.state.loading},is_open:function(a){return a=this.get_node(a),a&&a.state.opened},is_closed:function(a){return a=this.get_node(a),a&&this.is_parent(a)&&!a.state.opened},is_leaf:function(a){return!this.is_parent(a)},load_node:function(b,c){var d,e,f,g,h;if(a.isArray(b))return this._load_nodes(b.slice(),c),!0;if(b=this.get_node(b),!b)return c&&c.call(this,b,!1),!1;if(b.state.loaded){for(b.state.loaded=!1,f=0,g=b.parents.length;g>f;f++)this._model.data[b.parents[f]].children_d=a.vakata.array_filter(this._model.data[b.parents[f]].children_d,function(c){return-1===a.inArray(c,b.children_d)});for(d=0,e=b.children_d.length;e>d;d++)this._model.data[b.children_d[d]].state.selected&&(h=!0),delete this._model.data[b.children_d[d]];h&&(this._data.core.selected=a.vakata.array_filter(this._data.core.selected,function(c){return-1===a.inArray(c,b.children_d)})),b.children=[],b.children_d=[],h&&this.trigger("changed",{action:"load_node",node:b,selected:this._data.core.selected})}return b.state.failed=!1,b.state.loading=!0,this.get_node(b,!0).addClass("jstree-loading").attr("aria-busy",!0),this._load_node(b,a.proxy(function(a){b=this._model.data[b.id],b.state.loading=!1,b.state.loaded=a,b.state.failed=!b.state.loaded;var d=this.get_node(b,!0),e=0,f=0,g=this._model.data,h=!1;for(e=0,f=b.children.length;f>e;e++)if(g[b.children[e]]&&!g[b.children[e]].state.hidden){h=!0;break}b.state.loaded&&d&&d.length&&(d.removeClass("jstree-closed jstree-open jstree-leaf"),h?"#"!==b.id&&d.addClass(b.state.opened?"jstree-open":"jstree-closed"):d.addClass("jstree-leaf")),d.removeClass("jstree-loading").attr("aria-busy",!1),this.trigger("load_node",{node:b,status:a}),c&&c.call(this,b,a)},this)),!0},_load_nodes:function(a,b,c,d){var e=!0,f=function(){this._load_nodes(a,b,!0)},g=this._model.data,h,i,j=[];for(h=0,i=a.length;i>h;h++)g[a[h]]&&(!g[a[h]].state.loaded&&!g[a[h]].state.failed||!c&&d)&&(this.is_loading(a[h])||this.load_node(a[h],f),e=!1);if(e){for(h=0,i=a.length;i>h;h++)g[a[h]]&&g[a[h]].state.loaded&&j.push(a[h]);b&&!b.done&&(b.call(this,j),b.done=!0)}},load_all:function(b,c){if(b||(b=a.jstree.root),b=this.get_node(b),!b)return!1;var d=[],e=this._model.data,f=e[b.id].children_d,g,h;for(b.state&&!b.state.loaded&&d.push(b.id),g=0,h=f.length;h>g;g++)e[f[g]]&&e[f[g]].state&&!e[f[g]].state.loaded&&d.push(f[g]);d.length?this._load_nodes(d,function(){this.load_all(b,c)}):(c&&c.call(this,b),this.trigger("load_all",{node:b}))},_load_node:function(b,c){var d=this.settings.core.data,e,f=function g(){return 3!==this.nodeType&&8!==this.nodeType};return d?a.isFunction(d)?d.call(this,b,a.proxy(function(d){d===!1?c.call(this,!1):this["string"==typeof d?"_append_html_data":"_append_json_data"](b,"string"==typeof d?a(a.parseHTML(d)).filter(f):d,function(a){c.call(this,a)})},this)):"object"==typeof d?d.url?(d=a.extend(!0,{},d),a.isFunction(d.url)&&(d.url=d.url.call(this,b)),a.isFunction(d.data)&&(d.data=d.data.call(this,b)),a.ajax(d).done(a.proxy(function(d,e,g){var h=g.getResponseHeader("Content-Type");return h&&-1!==h.indexOf("json")||"object"==typeof d?this._append_json_data(b,d,function(a){c.call(this,a)}):h&&-1!==h.indexOf("html")||"string"==typeof d?this._append_html_data(b,a(a.parseHTML(d)).filter(f),function(a){c.call(this,a)}):(this._data.core.last_error={error:"ajax",plugin:"core",id:"core_04",reason:"Could not load node",data:JSON.stringify({id:b.id,xhr:g})},this.settings.core.error.call(this,this._data.core.last_error),c.call(this,!1))},this)).fail(a.proxy(function(a){this._data.core.last_error={error:"ajax",plugin:"core",id:"core_04",reason:"Could not load node",data:JSON.stringify({id:b.id,xhr:a})},c.call(this,!1),this.settings.core.error.call(this,this._data.core.last_error)},this))):(e=a.isArray(d)?a.extend(!0,[],d):a.isPlainObject(d)?a.extend(!0,{},d):d,b.id===a.jstree.root?this._append_json_data(b,e,function(a){c.call(this,a)}):(this._data.core.last_error={error:"nodata",plugin:"core",id:"core_05",reason:"Could not load node",data:JSON.stringify({id:b.id})},this.settings.core.error.call(this,this._data.core.last_error),c.call(this,!1))):"string"==typeof d?b.id===a.jstree.root?this._append_html_data(b,a(a.parseHTML(d)).filter(f),function(a){c.call(this,a)}):(this._data.core.last_error={error:"nodata",plugin:"core",id:"core_06",reason:"Could not load node",data:JSON.stringify({id:b.id})},this.settings.core.error.call(this,this._data.core.last_error),c.call(this,!1)):c.call(this,!1):b.id===a.jstree.root?this._append_html_data(b,this._data.core.original_container_html.clone(!0),function(a){c.call(this,a)}):c.call(this,!1)},_node_changed:function(b){b=this.get_node(b),b&&-1===a.inArray(b.id,this._model.changed)&&this._model.changed.push(b.id)},_append_html_data:function(b,c,d){b=this.get_node(b),b.children=[],b.children_d=[];var e=c.is("ul")?c.children():c,f=b.id,g=[],h=[],i=this._model.data,j=i[f],k=this._data.core.selected.length,l,m,n;for(e.each(a.proxy(function(b,c){l=this._parse_model_from_html(a(c),f,j.parents.concat()),l&&(g.push(l),h.push(l),i[l].children_d.length&&(h=h.concat(i[l].children_d)))},this)),j.children=g,j.children_d=h,m=0,n=j.parents.length;n>m;m++)i[j.parents[m]].children_d=i[j.parents[m]].children_d.concat(h);this.trigger("model",{nodes:h,parent:f}),f!==a.jstree.root?(this._node_changed(f),this.redraw()):(this.get_container_ul().children(".jstree-initial-node").remove(),this.redraw(!0)),this._data.core.selected.length!==k&&this.trigger("changed",{action:"model",selected:this._data.core.selected}),d.call(this,!0)},_append_json_data:function(b,c,d,e){if(null!==this.element){b=this.get_node(b),b.children=[],b.children_d=[],c.d&&(c=c.d,"string"==typeof c&&(c=JSON.parse(c))),a.isArray(c)||(c=[c]);var f=null,g={df:this._model.default_state,dat:c,par:b.id,m:this._model.data,t_id:this._id,t_cnt:this._cnt,sel:this._data.core.selected},h=function(a,b){a.data&&(a=a.data);var c=a.dat,d=a.par,e=[],f=[],g=[],h=a.df,i=a.t_id,j=a.t_cnt,k=a.m,l=k[d],m=a.sel,n,o,p,q,r=function(a,c,d){d=d?d.concat():[],c&&d.unshift(c);var e=a.id.toString(),f,i,j,l,m={id:e,text:a.text||"",icon:a.icon!==b?a.icon:!0,parent:c,parents:d,children:a.children||[],children_d:a.children_d||[],data:a.data,state:{},li_attr:{id:!1},a_attr:{href:"#"},original:!1};for(f in h)h.hasOwnProperty(f)&&(m.state[f]=h[f]);if(a&&a.data&&a.data.jstree&&a.data.jstree.icon&&(m.icon=a.data.jstree.icon),(m.icon===b||null===m.icon||""===m.icon)&&(m.icon=!0),a&&a.data&&(m.data=a.data,a.data.jstree))for(f in a.data.jstree)a.data.jstree.hasOwnProperty(f)&&(m.state[f]=a.data.jstree[f]);if(a&&"object"==typeof a.state)for(f in a.state)a.state.hasOwnProperty(f)&&(m.state[f]=a.state[f]);if(a&&"object"==typeof a.li_attr)for(f in a.li_attr)a.li_attr.hasOwnProperty(f)&&(m.li_attr[f]=a.li_attr[f]);if(m.li_attr.id||(m.li_attr.id=e),a&&"object"==typeof a.a_attr)for(f in a.a_attr)a.a_attr.hasOwnProperty(f)&&(m.a_attr[f]=a.a_attr[f]);for(a&&a.children&&a.children===!0&&(m.state.loaded=!1,m.children=[],m.children_d=[]),k[m.id]=m,f=0,i=m.children.length;i>f;f++)j=r(k[m.children[f]],m.id,d),l=k[j],m.children_d.push(j),l.children_d.length&&(m.children_d=m.children_d.concat(l.children_d));return delete a.data,delete a.children,k[m.id].original=a,m.state.selected&&g.push(m.id),m.id},s=function(a,c,d){d=d?d.concat():[],c&&d.unshift(c);var e=!1,f,l,m,n,o;do e="j"+i+"_"+ ++j;while(k[e]);o={id:!1,text:"string"==typeof a?a:"",icon:"object"==typeof a&&a.icon!==b?a.icon:!0,parent:c,parents:d,children:[],children_d:[],data:null,state:{},li_attr:{id:!1},a_attr:{href:"#"},original:!1};for(f in h)h.hasOwnProperty(f)&&(o.state[f]=h[f]);if(a&&a.id&&(o.id=a.id.toString()),a&&a.text&&(o.text=a.text),a&&a.data&&a.data.jstree&&a.data.jstree.icon&&(o.icon=a.data.jstree.icon),(o.icon===b||null===o.icon||""===o.icon)&&(o.icon=!0),a&&a.data&&(o.data=a.data,a.data.jstree))for(f in a.data.jstree)a.data.jstree.hasOwnProperty(f)&&(o.state[f]=a.data.jstree[f]);if(a&&"object"==typeof a.state)for(f in a.state)a.state.hasOwnProperty(f)&&(o.state[f]=a.state[f]);if(a&&"object"==typeof a.li_attr)for(f in a.li_attr)a.li_attr.hasOwnProperty(f)&&(o.li_attr[f]=a.li_attr[f]);if(o.li_attr.id&&!o.id&&(o.id=o.li_attr.id.toString()),o.id||(o.id=e),o.li_attr.id||(o.li_attr.id=o.id),a&&"object"==typeof a.a_attr)for(f in a.a_attr)a.a_attr.hasOwnProperty(f)&&(o.a_attr[f]=a.a_attr[f]);if(a&&a.children&&a.children.length){for(f=0,l=a.children.length;l>f;f++)m=s(a.children[f],o.id,d),n=k[m],o.children.push(m),n.children_d.length&&(o.children_d=o.children_d.concat(n.children_d));o.children_d=o.children_d.concat(o.children)}return a&&a.children&&a.children===!0&&(o.state.loaded=!1,o.children=[],o.children_d=[]),delete a.data,delete a.children,o.original=a,k[o.id]=o,o.state.selected&&g.push(o.id),o.id};if(c.length&&c[0].id!==b&&c[0].parent!==b){for(o=0,p=c.length;p>o;o++)c[o].children||(c[o].children=[]),c[o].state||(c[o].state={}),k[c[o].id.toString()]=c[o];for(o=0,p=c.length;p>o;o++)k[c[o].parent.toString()]?(k[c[o].parent.toString()].children.push(c[o].id.toString()),l.children_d.push(c[o].id.toString())):(this._data.core.last_error={error:"parse",plugin:"core",id:"core_07",reason:"Node with invalid parent",data:JSON.stringify({id:c[o].id.toString(),parent:c[o].parent.toString()})},this.settings.core.error.call(this,this._data.core.last_error));for(o=0,p=l.children.length;p>o;o++)n=r(k[l.children[o]],d,l.parents.concat()),f.push(n),k[n].children_d.length&&(f=f.concat(k[n].children_d));for(o=0,p=l.parents.length;p>o;o++)k[l.parents[o]].children_d=k[l.parents[o]].children_d.concat(f);q={cnt:j,mod:k,sel:m,par:d,dpc:f,add:g}}else{for(o=0,p=c.length;p>o;o++)n=s(c[o],d,l.parents.concat()),n&&(e.push(n),f.push(n),k[n].children_d.length&&(f=f.concat(k[n].children_d)));for(l.children=e,l.children_d=f,o=0,p=l.parents.length;p>o;o++)k[l.parents[o]].children_d=k[l.parents[o]].children_d.concat(f);q={cnt:j,mod:k,sel:m,par:d,dpc:f,add:g}}return"undefined"!=typeof window&&"undefined"!=typeof window.document?q:void postMessage(q)},i=function(b,c){if(null!==this.element){this._cnt=b.cnt;var e,f=this._model.data;for(e in f)f.hasOwnProperty(e)&&f[e].state&&f[e].state.loading&&b.mod[e]&&(b.mod[e].state.loading=!0);if(this._model.data=b.mod,c){var g,h=b.add,i=b.sel,j=this._data.core.selected.slice();if(f=this._model.data,i.length!==j.length||a.vakata.array_unique(i.concat(j)).length!==i.length){for(e=0,g=i.length;g>e;e++)-1===a.inArray(i[e],h)&&-1===a.inArray(i[e],j)&&(f[i[e]].state.selected=!1);for(e=0,g=j.length;g>e;e++)-1===a.inArray(j[e],i)&&(f[j[e]].state.selected=!0)}}b.add.length&&(this._data.core.selected=this._data.core.selected.concat(b.add)),this.trigger("model",{nodes:b.dpc,parent:b.par}),b.par!==a.jstree.root?(this._node_changed(b.par),this.redraw()):this.redraw(!0),b.add.length&&this.trigger("changed",{action:"model",selected:this._data.core.selected}),d.call(this,!0)}};if(this.settings.core.worker&&window.Blob&&window.URL&&window.Worker)try{null===this._wrk&&(this._wrk=window.URL.createObjectURL(new window.Blob(["self.onmessage = "+h.toString()],{type:"text/javascript"}))),!this._data.core.working||e?(this._data.core.working=!0,f=new window.Worker(this._wrk),f.onmessage=a.proxy(function(a){i.call(this,a.data,!0);try{f.terminate(),f=null}catch(b){}this._data.core.worker_queue.length?this._append_json_data.apply(this,this._data.core.worker_queue.shift()):this._data.core.working=!1},this),g.par?f.postMessage(g):this._data.core.worker_queue.length?this._append_json_data.apply(this,this._data.core.worker_queue.shift()):this._data.core.working=!1):this._data.core.worker_queue.push([b,c,d,!0])}catch(j){i.call(this,h(g),!1),this._data.core.worker_queue.length?this._append_json_data.apply(this,this._data.core.worker_queue.shift()):this._data.core.working=!1}else i.call(this,h(g),!1)}},_parse_model_from_html:function(c,d,e){e=e?[].concat(e):[],d&&e.unshift(d);var f,g,h=this._model.data,i={id:!1,text:!1,icon:!0,parent:d,parents:e,children:[],children_d:[],data:null,state:{},li_attr:{id:!1},a_attr:{href:"#"},original:!1},j,k,l;for(j in this._model.default_state)this._model.default_state.hasOwnProperty(j)&&(i.state[j]=this._model.default_state[j]);if(k=a.vakata.attributes(c,!0),a.each(k,function(b,c){return c=a.trim(c),c.length?(i.li_attr[b]=c,void("id"===b&&(i.id=c.toString()))):!0}),k=c.children("a").first(),k.length&&(k=a.vakata.attributes(k,!0),a.each(k,function(b,c){c=a.trim(c),c.length&&(i.a_attr[b]=c)})),k=c.children("a").first().length?c.children("a").first().clone():c.clone(),k.children("ins, i, ul").remove(),k=k.html(),k=a("<div />").html(k),i.text=this.settings.core.force_text?k.text():k.html(),k=c.data(),i.data=k?a.extend(!0,{},k):null,i.state.opened=c.hasClass("jstree-open"),i.state.selected=c.children("a").hasClass("jstree-clicked"),i.state.disabled=c.children("a").hasClass("jstree-disabled"),i.data&&i.data.jstree)for(j in i.data.jstree)i.data.jstree.hasOwnProperty(j)&&(i.state[j]=i.data.jstree[j]);k=c.children("a").children(".jstree-themeicon"),k.length&&(i.icon=k.hasClass("jstree-themeicon-hidden")?!1:k.attr("rel")),i.state.icon!==b&&(i.icon=i.state.icon),(i.icon===b||null===i.icon||""===i.icon)&&(i.icon=!0),k=c.children("ul").children("li");do l="j"+this._id+"_"+ ++this._cnt;while(h[l]);return i.id=i.li_attr.id?i.li_attr.id.toString():l,k.length?(k.each(a.proxy(function(b,c){f=this._parse_model_from_html(a(c),i.id,e),g=this._model.data[f],i.children.push(f),g.children_d.length&&(i.children_d=i.children_d.concat(g.children_d))},this)),i.children_d=i.children_d.concat(i.children)):c.hasClass("jstree-closed")&&(i.state.loaded=!1),i.li_attr["class"]&&(i.li_attr["class"]=i.li_attr["class"].replace("jstree-closed","").replace("jstree-open","")),i.a_attr["class"]&&(i.a_attr["class"]=i.a_attr["class"].replace("jstree-clicked","").replace("jstree-disabled","")),h[i.id]=i,i.state.selected&&this._data.core.selected.push(i.id),i.id},_parse_model_from_flat_json:function(a,c,d){d=d?d.concat():[],c&&d.unshift(c);var e=a.id.toString(),f=this._model.data,g=this._model.default_state,h,i,j,k,l={id:e,text:a.text||"",icon:a.icon!==b?a.icon:!0,parent:c,parents:d,children:a.children||[],children_d:a.children_d||[],data:a.data,state:{},li_attr:{id:!1},a_attr:{href:"#"},original:!1};for(h in g)g.hasOwnProperty(h)&&(l.state[h]=g[h]);if(a&&a.data&&a.data.jstree&&a.data.jstree.icon&&(l.icon=a.data.jstree.icon),(l.icon===b||null===l.icon||""===l.icon)&&(l.icon=!0),a&&a.data&&(l.data=a.data,a.data.jstree))for(h in a.data.jstree)a.data.jstree.hasOwnProperty(h)&&(l.state[h]=a.data.jstree[h]);if(a&&"object"==typeof a.state)for(h in a.state)a.state.hasOwnProperty(h)&&(l.state[h]=a.state[h]);if(a&&"object"==typeof a.li_attr)for(h in a.li_attr)a.li_attr.hasOwnProperty(h)&&(l.li_attr[h]=a.li_attr[h]);if(l.li_attr.id||(l.li_attr.id=e),a&&"object"==typeof a.a_attr)for(h in a.a_attr)a.a_attr.hasOwnProperty(h)&&(l.a_attr[h]=a.a_attr[h]);for(a&&a.children&&a.children===!0&&(l.state.loaded=!1,l.children=[],l.children_d=[]),f[l.id]=l,h=0,i=l.children.length;i>h;h++)j=this._parse_model_from_flat_json(f[l.children[h]],l.id,d),k=f[j],l.children_d.push(j),k.children_d.length&&(l.children_d=l.children_d.concat(k.children_d));return delete a.data,delete a.children,f[l.id].original=a,l.state.selected&&this._data.core.selected.push(l.id),l.id},_parse_model_from_json:function(a,c,d){d=d?d.concat():[],c&&d.unshift(c);var e=!1,f,g,h,i,j=this._model.data,k=this._model.default_state,l;do e="j"+this._id+"_"+ ++this._cnt;while(j[e]);l={id:!1,text:"string"==typeof a?a:"",icon:"object"==typeof a&&a.icon!==b?a.icon:!0,parent:c,parents:d,children:[],children_d:[],data:null,state:{},li_attr:{id:!1},a_attr:{href:"#"},original:!1};for(f in k)k.hasOwnProperty(f)&&(l.state[f]=k[f]);if(a&&a.id&&(l.id=a.id.toString()),a&&a.text&&(l.text=a.text),a&&a.data&&a.data.jstree&&a.data.jstree.icon&&(l.icon=a.data.jstree.icon),(l.icon===b||null===l.icon||""===l.icon)&&(l.icon=!0),a&&a.data&&(l.data=a.data,a.data.jstree))for(f in a.data.jstree)a.data.jstree.hasOwnProperty(f)&&(l.state[f]=a.data.jstree[f]);if(a&&"object"==typeof a.state)for(f in a.state)a.state.hasOwnProperty(f)&&(l.state[f]=a.state[f]);if(a&&"object"==typeof a.li_attr)for(f in a.li_attr)a.li_attr.hasOwnProperty(f)&&(l.li_attr[f]=a.li_attr[f]);if(l.li_attr.id&&!l.id&&(l.id=l.li_attr.id.toString()),
l.id||(l.id=e),l.li_attr.id||(l.li_attr.id=l.id),a&&"object"==typeof a.a_attr)for(f in a.a_attr)a.a_attr.hasOwnProperty(f)&&(l.a_attr[f]=a.a_attr[f]);if(a&&a.children&&a.children.length){for(f=0,g=a.children.length;g>f;f++)h=this._parse_model_from_json(a.children[f],l.id,d),i=j[h],l.children.push(h),i.children_d.length&&(l.children_d=l.children_d.concat(i.children_d));l.children_d=l.children_d.concat(l.children)}return a&&a.children&&a.children===!0&&(l.state.loaded=!1,l.children=[],l.children_d=[]),delete a.data,delete a.children,l.original=a,j[l.id]=l,l.state.selected&&this._data.core.selected.push(l.id),l.id},_redraw:function(){var b=this._model.force_full_redraw?this._model.data[a.jstree.root].children.concat([]):this._model.changed.concat([]),c=i.createElement("UL"),d,e,f,g=this._data.core.focused;for(e=0,f=b.length;f>e;e++)d=this.redraw_node(b[e],!0,this._model.force_full_redraw),d&&this._model.force_full_redraw&&c.appendChild(d);this._model.force_full_redraw&&(c.className=this.get_container_ul()[0].className,c.setAttribute("role","group"),this.element.empty().append(c)),null!==g&&this.settings.core.restore_focus&&(d=this.get_node(g,!0),d&&d.length&&d.children(".jstree-anchor")[0]!==i.activeElement?d.children(".jstree-anchor").focus():this._data.core.focused=null),this._model.force_full_redraw=!1,this._model.changed=[],this.trigger("redraw",{nodes:b})},redraw:function(a){a&&(this._model.force_full_redraw=!0),this._redraw()},draw_children:function(b){var c=this.get_node(b),d=!1,e=!1,f=!1,g=i;if(!c)return!1;if(c.id===a.jstree.root)return this.redraw(!0);if(b=this.get_node(b,!0),!b||!b.length)return!1;if(b.children(".jstree-children").remove(),b=b[0],c.children.length&&c.state.loaded){for(f=g.createElement("UL"),f.setAttribute("role","group"),f.className="jstree-children",d=0,e=c.children.length;e>d;d++)f.appendChild(this.redraw_node(c.children[d],!0,!0));b.appendChild(f)}},redraw_node:function(b,c,d,e){var f=this.get_node(b),g=!1,h=!1,j=!1,k=!1,l=!1,m=!1,n="",o=i,p=this._model.data,q=!1,r=!1,s=null,t=0,u=0,v=!1,w=!1;if(!f)return!1;if(f.id===a.jstree.root)return this.redraw(!0);if(c=c||0===f.children.length,b=i.querySelector?this.element[0].querySelector("#"+(-1!=="0123456789".indexOf(f.id[0])?"\\3"+f.id[0]+" "+f.id.substr(1).replace(a.jstree.idregex,"\\$&"):f.id.replace(a.jstree.idregex,"\\$&"))):i.getElementById(f.id))b=a(b),d||(g=b.parent().parent()[0],g===this.element[0]&&(g=null),h=b.index()),c||!f.children.length||b.children(".jstree-children").length||(c=!0),c||(j=b.children(".jstree-children")[0]),q=b.children(".jstree-anchor")[0]===i.activeElement,b.remove();else if(c=!0,!d){if(g=f.parent!==a.jstree.root?a("#"+f.parent.replace(a.jstree.idregex,"\\$&"),this.element)[0]:null,!(null===g||g&&p[f.parent].state.opened))return!1;h=a.inArray(f.id,null===g?p[a.jstree.root].children:p[f.parent].children)}b=this._data.core.node.cloneNode(!0),n="jstree-node ";for(k in f.li_attr)if(f.li_attr.hasOwnProperty(k)){if("id"===k)continue;"class"!==k?b.setAttribute(k,f.li_attr[k]):n+=f.li_attr[k]}for(f.a_attr.id||(f.a_attr.id=f.id+"_anchor"),b.setAttribute("aria-selected",!!f.state.selected),b.setAttribute("aria-level",f.parents.length),b.setAttribute("aria-labelledby",f.a_attr.id),f.state.disabled&&b.setAttribute("aria-disabled",!0),k=0,l=f.children.length;l>k;k++)if(!p[f.children[k]].state.hidden){v=!0;break}if(null!==f.parent&&p[f.parent]&&!f.state.hidden&&(k=a.inArray(f.id,p[f.parent].children),w=f.id,-1!==k))for(k++,l=p[f.parent].children.length;l>k;k++)if(p[p[f.parent].children[k]].state.hidden||(w=p[f.parent].children[k]),w!==f.id)break;f.state.hidden&&(n+=" jstree-hidden"),f.state.loading&&(n+=" jstree-loading"),f.state.loaded&&!v?n+=" jstree-leaf":(n+=f.state.opened&&f.state.loaded?" jstree-open":" jstree-closed",b.setAttribute("aria-expanded",f.state.opened&&f.state.loaded)),w===f.id&&(n+=" jstree-last"),b.id=f.id,b.className=n,n=(f.state.selected?" jstree-clicked":"")+(f.state.disabled?" jstree-disabled":"");for(l in f.a_attr)if(f.a_attr.hasOwnProperty(l)){if("href"===l&&"#"===f.a_attr[l])continue;"class"!==l?b.childNodes[1].setAttribute(l,f.a_attr[l]):n+=" "+f.a_attr[l]}if(n.length&&(b.childNodes[1].className="jstree-anchor "+n),(f.icon&&f.icon!==!0||f.icon===!1)&&(f.icon===!1?b.childNodes[1].childNodes[0].className+=" jstree-themeicon-hidden":-1===f.icon.indexOf("/")&&-1===f.icon.indexOf(".")?b.childNodes[1].childNodes[0].className+=" "+f.icon+" jstree-themeicon-custom":(b.childNodes[1].childNodes[0].style.backgroundImage='url("'+f.icon+'")',b.childNodes[1].childNodes[0].style.backgroundPosition="center center",b.childNodes[1].childNodes[0].style.backgroundSize="auto",b.childNodes[1].childNodes[0].className+=" jstree-themeicon-custom")),this.settings.core.force_text?b.childNodes[1].appendChild(o.createTextNode(f.text)):b.childNodes[1].innerHTML+=f.text,c&&f.children.length&&(f.state.opened||e)&&f.state.loaded){for(m=o.createElement("UL"),m.setAttribute("role","group"),m.className="jstree-children",k=0,l=f.children.length;l>k;k++)m.appendChild(this.redraw_node(f.children[k],c,!0));b.appendChild(m)}if(j&&b.appendChild(j),!d){for(g||(g=this.element[0]),k=0,l=g.childNodes.length;l>k;k++)if(g.childNodes[k]&&g.childNodes[k].className&&-1!==g.childNodes[k].className.indexOf("jstree-children")){s=g.childNodes[k];break}s||(s=o.createElement("UL"),s.setAttribute("role","group"),s.className="jstree-children",g.appendChild(s)),g=s,h<g.childNodes.length?g.insertBefore(b,g.childNodes[h]):g.appendChild(b),q&&(t=this.element[0].scrollTop,u=this.element[0].scrollLeft,b.childNodes[1].focus(),this.element[0].scrollTop=t,this.element[0].scrollLeft=u)}return f.state.opened&&!f.state.loaded&&(f.state.opened=!1,setTimeout(a.proxy(function(){this.open_node(f.id,!1,0)},this),0)),b},open_node:function(c,d,e){var f,g,h,i;if(a.isArray(c)){for(c=c.slice(),f=0,g=c.length;g>f;f++)this.open_node(c[f],d,e);return!0}return c=this.get_node(c),c&&c.id!==a.jstree.root?(e=e===b?this.settings.core.animation:e,this.is_closed(c)?this.is_loaded(c)?(h=this.get_node(c,!0),i=this,h.length&&(e&&h.children(".jstree-children").length&&h.children(".jstree-children").stop(!0,!0),c.children.length&&!this._firstChild(h.children(".jstree-children")[0])&&this.draw_children(c),e?(this.trigger("before_open",{node:c}),h.children(".jstree-children").css("display","none").end().removeClass("jstree-closed").addClass("jstree-open").attr("aria-expanded",!0).children(".jstree-children").stop(!0,!0).slideDown(e,function(){this.style.display="",i.element&&i.trigger("after_open",{node:c})})):(this.trigger("before_open",{node:c}),h[0].className=h[0].className.replace("jstree-closed","jstree-open"),h[0].setAttribute("aria-expanded",!0))),c.state.opened=!0,d&&d.call(this,c,!0),h.length||this.trigger("before_open",{node:c}),this.trigger("open_node",{node:c}),e&&h.length||this.trigger("after_open",{node:c}),!0):this.is_loading(c)?setTimeout(a.proxy(function(){this.open_node(c,d,e)},this),500):void this.load_node(c,function(a,b){return b?this.open_node(a,d,e):d?d.call(this,a,!1):!1}):(d&&d.call(this,c,!1),!1)):!1},_open_to:function(b){if(b=this.get_node(b),!b||b.id===a.jstree.root)return!1;var c,d,e=b.parents;for(c=0,d=e.length;d>c;c+=1)c!==a.jstree.root&&this.open_node(e[c],!1,0);return a("#"+b.id.replace(a.jstree.idregex,"\\$&"),this.element)},close_node:function(c,d){var e,f,g,h;if(a.isArray(c)){for(c=c.slice(),e=0,f=c.length;f>e;e++)this.close_node(c[e],d);return!0}return c=this.get_node(c),c&&c.id!==a.jstree.root?this.is_closed(c)?!1:(d=d===b?this.settings.core.animation:d,g=this,h=this.get_node(c,!0),c.state.opened=!1,this.trigger("close_node",{node:c}),void(h.length?d?h.children(".jstree-children").attr("style","display:block !important").end().removeClass("jstree-open").addClass("jstree-closed").attr("aria-expanded",!1).children(".jstree-children").stop(!0,!0).slideUp(d,function(){this.style.display="",h.children(".jstree-children").remove(),g.element&&g.trigger("after_close",{node:c})}):(h[0].className=h[0].className.replace("jstree-open","jstree-closed"),h.attr("aria-expanded",!1).children(".jstree-children").remove(),this.trigger("after_close",{node:c})):this.trigger("after_close",{node:c}))):!1},toggle_node:function(b){var c,d;if(a.isArray(b)){for(b=b.slice(),c=0,d=b.length;d>c;c++)this.toggle_node(b[c]);return!0}return this.is_closed(b)?this.open_node(b):this.is_open(b)?this.close_node(b):void 0},open_all:function(b,c,d){if(b||(b=a.jstree.root),b=this.get_node(b),!b)return!1;var e=b.id===a.jstree.root?this.get_container_ul():this.get_node(b,!0),f,g,h;if(!e.length){for(f=0,g=b.children_d.length;g>f;f++)this.is_closed(this._model.data[b.children_d[f]])&&(this._model.data[b.children_d[f]].state.opened=!0);return this.trigger("open_all",{node:b})}d=d||e,h=this,e=this.is_closed(b)?e.find(".jstree-closed").addBack():e.find(".jstree-closed"),e.each(function(){h.open_node(this,function(a,b){b&&this.is_parent(a)&&this.open_all(a,c,d)},c||0)}),0===d.find(".jstree-closed").length&&this.trigger("open_all",{node:this.get_node(d)})},close_all:function(b,c){if(b||(b=a.jstree.root),b=this.get_node(b),!b)return!1;var d=b.id===a.jstree.root?this.get_container_ul():this.get_node(b,!0),e=this,f,g;for(d.length&&(d=this.is_open(b)?d.find(".jstree-open").addBack():d.find(".jstree-open"),a(d.get().reverse()).each(function(){e.close_node(this,c||0)})),f=0,g=b.children_d.length;g>f;f++)this._model.data[b.children_d[f]].state.opened=!1;this.trigger("close_all",{node:b})},is_disabled:function(a){return a=this.get_node(a),a&&a.state&&a.state.disabled},enable_node:function(b){var c,d;if(a.isArray(b)){for(b=b.slice(),c=0,d=b.length;d>c;c++)this.enable_node(b[c]);return!0}return b=this.get_node(b),b&&b.id!==a.jstree.root?(b.state.disabled=!1,this.get_node(b,!0).children(".jstree-anchor").removeClass("jstree-disabled").attr("aria-disabled",!1),void this.trigger("enable_node",{node:b})):!1},disable_node:function(b){var c,d;if(a.isArray(b)){for(b=b.slice(),c=0,d=b.length;d>c;c++)this.disable_node(b[c]);return!0}return b=this.get_node(b),b&&b.id!==a.jstree.root?(b.state.disabled=!0,this.get_node(b,!0).children(".jstree-anchor").addClass("jstree-disabled").attr("aria-disabled",!0),void this.trigger("disable_node",{node:b})):!1},is_hidden:function(a){return a=this.get_node(a),a.state.hidden===!0},hide_node:function(b,c){var d,e;if(a.isArray(b)){for(b=b.slice(),d=0,e=b.length;e>d;d++)this.hide_node(b[d],!0);return c||this.redraw(),!0}return b=this.get_node(b),b&&b.id!==a.jstree.root?void(b.state.hidden||(b.state.hidden=!0,this._node_changed(b.parent),c||this.redraw(),this.trigger("hide_node",{node:b}))):!1},show_node:function(b,c){var d,e;if(a.isArray(b)){for(b=b.slice(),d=0,e=b.length;e>d;d++)this.show_node(b[d],!0);return c||this.redraw(),!0}return b=this.get_node(b),b&&b.id!==a.jstree.root?void(b.state.hidden&&(b.state.hidden=!1,this._node_changed(b.parent),c||this.redraw(),this.trigger("show_node",{node:b}))):!1},hide_all:function(b){var c,d=this._model.data,e=[];for(c in d)d.hasOwnProperty(c)&&c!==a.jstree.root&&!d[c].state.hidden&&(d[c].state.hidden=!0,e.push(c));return this._model.force_full_redraw=!0,b||this.redraw(),this.trigger("hide_all",{nodes:e}),e},show_all:function(b){var c,d=this._model.data,e=[];for(c in d)d.hasOwnProperty(c)&&c!==a.jstree.root&&d[c].state.hidden&&(d[c].state.hidden=!1,e.push(c));return this._model.force_full_redraw=!0,b||this.redraw(),this.trigger("show_all",{nodes:e}),e},activate_node:function(a,c){if(this.is_disabled(a))return!1;if(c&&"object"==typeof c||(c={}),this._data.core.last_clicked=this._data.core.last_clicked&&this._data.core.last_clicked.id!==b?this.get_node(this._data.core.last_clicked.id):null,this._data.core.last_clicked&&!this._data.core.last_clicked.state.selected&&(this._data.core.last_clicked=null),!this._data.core.last_clicked&&this._data.core.selected.length&&(this._data.core.last_clicked=this.get_node(this._data.core.selected[this._data.core.selected.length-1])),this.settings.core.multiple&&(c.metaKey||c.ctrlKey||c.shiftKey)&&(!c.shiftKey||this._data.core.last_clicked&&this.get_parent(a)&&this.get_parent(a)===this._data.core.last_clicked.parent))if(c.shiftKey){var d=this.get_node(a).id,e=this._data.core.last_clicked.id,f=this.get_node(this._data.core.last_clicked.parent).children,g=!1,h,i;for(h=0,i=f.length;i>h;h+=1)f[h]===d&&(g=!g),f[h]===e&&(g=!g),this.is_disabled(f[h])||!g&&f[h]!==d&&f[h]!==e?this.deselect_node(f[h],!0,c):this.is_hidden(f[h])||this.select_node(f[h],!0,!1,c);this.trigger("changed",{action:"select_node",node:this.get_node(a),selected:this._data.core.selected,event:c})}else this.is_selected(a)?this.deselect_node(a,!1,c):this.select_node(a,!1,!1,c);else!this.settings.core.multiple&&(c.metaKey||c.ctrlKey||c.shiftKey)&&this.is_selected(a)?this.deselect_node(a,!1,c):(this.deselect_all(!0),this.select_node(a,!1,!1,c),this._data.core.last_clicked=this.get_node(a));this.trigger("activate_node",{node:this.get_node(a),event:c})},hover_node:function(a){if(a=this.get_node(a,!0),!a||!a.length||a.children(".jstree-hovered").length)return!1;var b=this.element.find(".jstree-hovered"),c=this.element;b&&b.length&&this.dehover_node(b),a.children(".jstree-anchor").addClass("jstree-hovered"),this.trigger("hover_node",{node:this.get_node(a)}),setTimeout(function(){c.attr("aria-activedescendant",a[0].id)},0)},dehover_node:function(a){return a=this.get_node(a,!0),a&&a.length&&a.children(".jstree-hovered").length?(a.children(".jstree-anchor").removeClass("jstree-hovered"),void this.trigger("dehover_node",{node:this.get_node(a)})):!1},select_node:function(b,c,d,e){var f,g,h,i;if(a.isArray(b)){for(b=b.slice(),g=0,h=b.length;h>g;g++)this.select_node(b[g],c,d,e);return!0}return b=this.get_node(b),b&&b.id!==a.jstree.root?(f=this.get_node(b,!0),void(b.state.selected||(b.state.selected=!0,this._data.core.selected.push(b.id),d||(f=this._open_to(b)),f&&f.length&&f.attr("aria-selected",!0).children(".jstree-anchor").addClass("jstree-clicked"),this.trigger("select_node",{node:b,selected:this._data.core.selected,event:e}),c||this.trigger("changed",{action:"select_node",node:b,selected:this._data.core.selected,event:e})))):!1},deselect_node:function(b,c,d){var e,f,g;if(a.isArray(b)){for(b=b.slice(),e=0,f=b.length;f>e;e++)this.deselect_node(b[e],c,d);return!0}return b=this.get_node(b),b&&b.id!==a.jstree.root?(g=this.get_node(b,!0),void(b.state.selected&&(b.state.selected=!1,this._data.core.selected=a.vakata.array_remove_item(this._data.core.selected,b.id),g.length&&g.attr("aria-selected",!1).children(".jstree-anchor").removeClass("jstree-clicked"),this.trigger("deselect_node",{node:b,selected:this._data.core.selected,event:d}),c||this.trigger("changed",{action:"deselect_node",node:b,selected:this._data.core.selected,event:d})))):!1},select_all:function(b){var c=this._data.core.selected.concat([]),d,e;for(this._data.core.selected=this._model.data[a.jstree.root].children_d.concat(),d=0,e=this._data.core.selected.length;e>d;d++)this._model.data[this._data.core.selected[d]]&&(this._model.data[this._data.core.selected[d]].state.selected=!0);this.redraw(!0),this.trigger("select_all",{selected:this._data.core.selected}),b||this.trigger("changed",{action:"select_all",selected:this._data.core.selected,old_selection:c})},deselect_all:function(a){var b=this._data.core.selected.concat([]),c,d;for(c=0,d=this._data.core.selected.length;d>c;c++)this._model.data[this._data.core.selected[c]]&&(this._model.data[this._data.core.selected[c]].state.selected=!1);this._data.core.selected=[],this.element.find(".jstree-clicked").removeClass("jstree-clicked").parent().attr("aria-selected",!1),this.trigger("deselect_all",{selected:this._data.core.selected,node:b}),a||this.trigger("changed",{action:"deselect_all",selected:this._data.core.selected,old_selection:b})},is_selected:function(b){return b=this.get_node(b),b&&b.id!==a.jstree.root?b.state.selected:!1},get_selected:function(b){return b?a.map(this._data.core.selected,a.proxy(function(a){return this.get_node(a)},this)):this._data.core.selected.slice()},get_top_selected:function(b){var c=this.get_selected(!0),d={},e,f,g,h;for(e=0,f=c.length;f>e;e++)d[c[e].id]=c[e];for(e=0,f=c.length;f>e;e++)for(g=0,h=c[e].children_d.length;h>g;g++)d[c[e].children_d[g]]&&delete d[c[e].children_d[g]];c=[];for(e in d)d.hasOwnProperty(e)&&c.push(e);return b?a.map(c,a.proxy(function(a){return this.get_node(a)},this)):c},get_bottom_selected:function(b){var c=this.get_selected(!0),d=[],e,f;for(e=0,f=c.length;f>e;e++)c[e].children.length||d.push(c[e].id);return b?a.map(d,a.proxy(function(a){return this.get_node(a)},this)):d},get_state:function(){var b={core:{open:[],loaded:[],scroll:{left:this.element.scrollLeft(),top:this.element.scrollTop()},selected:[]}},c;for(c in this._model.data)this._model.data.hasOwnProperty(c)&&c!==a.jstree.root&&(this._model.data[c].state.loaded&&this.settings.core.loaded_state&&b.core.loaded.push(c),this._model.data[c].state.opened&&b.core.open.push(c),this._model.data[c].state.selected&&b.core.selected.push(c));return b},set_state:function(c,d){if(c){if(c.core&&c.core.selected&&c.core.initial_selection===b&&(c.core.initial_selection=this._data.core.selected.concat([]).sort().join(",")),c.core){var e,f,g,h,i;if(c.core.loaded)return this.settings.core.loaded_state&&a.isArray(c.core.loaded)&&c.core.loaded.length?this._load_nodes(c.core.loaded,function(a){delete c.core.loaded,this.set_state(c,d)}):(delete c.core.loaded,this.set_state(c,d)),!1;if(c.core.open)return a.isArray(c.core.open)&&c.core.open.length?this._load_nodes(c.core.open,function(a){this.open_node(a,!1,0),delete c.core.open,this.set_state(c,d)}):(delete c.core.open,this.set_state(c,d)),!1;if(c.core.scroll)return c.core.scroll&&c.core.scroll.left!==b&&this.element.scrollLeft(c.core.scroll.left),c.core.scroll&&c.core.scroll.top!==b&&this.element.scrollTop(c.core.scroll.top),delete c.core.scroll,this.set_state(c,d),!1;if(c.core.selected)return h=this,(c.core.initial_selection===b||c.core.initial_selection===this._data.core.selected.concat([]).sort().join(","))&&(this.deselect_all(),a.each(c.core.selected,function(a,b){h.select_node(b,!1,!0)})),delete c.core.initial_selection,delete c.core.selected,this.set_state(c,d),!1;for(i in c)c.hasOwnProperty(i)&&"core"!==i&&-1===a.inArray(i,this.settings.plugins)&&delete c[i];if(a.isEmptyObject(c.core))return delete c.core,this.set_state(c,d),!1}return a.isEmptyObject(c)?(c=null,d&&d.call(this),this.trigger("set_state"),!1):!0}return!1},refresh:function(b,c){this._data.core.state=c===!0?{}:this.get_state(),c&&a.isFunction(c)&&(this._data.core.state=c.call(this,this._data.core.state)),this._cnt=0,this._model.data={},this._model.data[a.jstree.root]={id:a.jstree.root,parent:null,parents:[],children:[],children_d:[],state:{loaded:!1}},this._data.core.selected=[],this._data.core.last_clicked=null,this._data.core.focused=null;var d=this.get_container_ul()[0].className;b||(this.element.html("<ul class='"+d+"' role='group'><li class='jstree-initial-node jstree-loading jstree-leaf jstree-last' role='treeitem' id='j"+this._id+"_loading'><i class='jstree-icon jstree-ocl'></i><a class='jstree-anchor' href='#'><i class='jstree-icon jstree-themeicon-hidden'></i>"+this.get_string("Loading ...")+"</a></li></ul>"),this.element.attr("aria-activedescendant","j"+this._id+"_loading")),this.load_node(a.jstree.root,function(b,c){c&&(this.get_container_ul()[0].className=d,this._firstChild(this.get_container_ul()[0])&&this.element.attr("aria-activedescendant",this._firstChild(this.get_container_ul()[0]).id),this.set_state(a.extend(!0,{},this._data.core.state),function(){this.trigger("refresh")})),this._data.core.state=null})},refresh_node:function(b){if(b=this.get_node(b),!b||b.id===a.jstree.root)return!1;var c=[],d=[],e=this._data.core.selected.concat([]);d.push(b.id),b.state.opened===!0&&c.push(b.id),this.get_node(b,!0).find(".jstree-open").each(function(){d.push(this.id),c.push(this.id)}),this._load_nodes(d,a.proxy(function(a){this.open_node(c,!1,0),this.select_node(e),this.trigger("refresh_node",{node:b,nodes:a})},this),!1,!0)},set_id:function(b,c){if(b=this.get_node(b),!b||b.id===a.jstree.root)return!1;var d,e,f=this._model.data,g=b.id;for(c=c.toString(),f[b.parent].children[a.inArray(b.id,f[b.parent].children)]=c,d=0,e=b.parents.length;e>d;d++)f[b.parents[d]].children_d[a.inArray(b.id,f[b.parents[d]].children_d)]=c;for(d=0,e=b.children.length;e>d;d++)f[b.children[d]].parent=c;for(d=0,e=b.children_d.length;e>d;d++)f[b.children_d[d]].parents[a.inArray(b.id,f[b.children_d[d]].parents)]=c;return d=a.inArray(b.id,this._data.core.selected),-1!==d&&(this._data.core.selected[d]=c),d=this.get_node(b.id,!0),d&&(d.attr("id",c),this.element.attr("aria-activedescendant")===b.id&&this.element.attr("aria-activedescendant",c)),delete f[b.id],b.id=c,b.li_attr.id=c,f[c]=b,this.trigger("set_id",{node:b,"new":b.id,old:g}),!0},get_text:function(b){return b=this.get_node(b),b&&b.id!==a.jstree.root?b.text:!1},set_text:function(b,c){var d,e;if(a.isArray(b)){for(b=b.slice(),d=0,e=b.length;e>d;d++)this.set_text(b[d],c);return!0}return b=this.get_node(b),b&&b.id!==a.jstree.root?(b.text=c,this.get_node(b,!0).length&&this.redraw_node(b.id),this.trigger("set_text",{obj:b,text:c}),!0):!1},get_json:function(b,c,d){if(b=this.get_node(b||a.jstree.root),!b)return!1;c&&c.flat&&!d&&(d=[]);var e={id:b.id,text:b.text,icon:this.get_icon(b),li_attr:a.extend(!0,{},b.li_attr),a_attr:a.extend(!0,{},b.a_attr),state:{},data:c&&c.no_data?!1:a.extend(!0,a.isArray(b.data)?[]:{},b.data)},f,g;if(c&&c.flat?e.parent=b.parent:e.children=[],c&&c.no_state)delete e.state;else for(f in b.state)b.state.hasOwnProperty(f)&&(e.state[f]=b.state[f]);if(c&&c.no_li_attr&&delete e.li_attr,c&&c.no_a_attr&&delete e.a_attr,c&&c.no_id&&(delete e.id,e.li_attr&&e.li_attr.id&&delete e.li_attr.id,e.a_attr&&e.a_attr.id&&delete e.a_attr.id),c&&c.flat&&b.id!==a.jstree.root&&d.push(e),!c||!c.no_children)for(f=0,g=b.children.length;g>f;f++)c&&c.flat?this.get_json(b.children[f],c,d):e.children.push(this.get_json(b.children[f],c));return c&&c.flat?d:b.id===a.jstree.root?e.children:e},create_node:function(c,d,e,f,g){if(null===c&&(c=a.jstree.root),c=this.get_node(c),!c)return!1;if(e=e===b?"last":e,!e.toString().match(/^(before|after)$/)&&!g&&!this.is_loaded(c))return this.load_node(c,function(){this.create_node(c,d,e,f,!0)});d||(d={text:this.get_string("New node")}),d="string"==typeof d?{text:d}:a.extend(!0,{},d),d.text===b&&(d.text=this.get_string("New node"));var h,i,j,k;switch(c.id===a.jstree.root&&("before"===e&&(e="first"),"after"===e&&(e="last")),e){case"before":h=this.get_node(c.parent),e=a.inArray(c.id,h.children),c=h;break;case"after":h=this.get_node(c.parent),e=a.inArray(c.id,h.children)+1,c=h;break;case"inside":case"first":e=0;break;case"last":e=c.children.length;break;default:e||(e=0)}if(e>c.children.length&&(e=c.children.length),d.id||(d.id=!0),!this.check("create_node",d,c,e))return this.settings.core.error.call(this,this._data.core.last_error),!1;if(d.id===!0&&delete d.id,d=this._parse_model_from_json(d,c.id,c.parents.concat()),!d)return!1;for(h=this.get_node(d),i=[],i.push(d),i=i.concat(h.children_d),this.trigger("model",{nodes:i,parent:c.id}),c.children_d=c.children_d.concat(i),j=0,k=c.parents.length;k>j;j++)this._model.data[c.parents[j]].children_d=this._model.data[c.parents[j]].children_d.concat(i);for(d=h,h=[],j=0,k=c.children.length;k>j;j++)h[j>=e?j+1:j]=c.children[j];return h[e]=d.id,c.children=h,this.redraw_node(c,!0),this.trigger("create_node",{node:this.get_node(d),parent:c.id,position:e}),f&&f.call(this,this.get_node(d)),d.id},rename_node:function(b,c){var d,e,f;if(a.isArray(b)){for(b=b.slice(),d=0,e=b.length;e>d;d++)this.rename_node(b[d],c);return!0}return b=this.get_node(b),b&&b.id!==a.jstree.root?(f=b.text,this.check("rename_node",b,this.get_parent(b),c)?(this.set_text(b,c),this.trigger("rename_node",{node:b,text:c,old:f}),!0):(this.settings.core.error.call(this,this._data.core.last_error),!1)):!1},delete_node:function(b){var c,d,e,f,g,h,i,j,k,l,m,n;if(a.isArray(b)){for(b=b.slice(),c=0,d=b.length;d>c;c++)this.delete_node(b[c]);return!0}if(b=this.get_node(b),!b||b.id===a.jstree.root)return!1;if(e=this.get_node(b.parent),f=a.inArray(b.id,e.children),l=!1,!this.check("delete_node",b,e,f))return this.settings.core.error.call(this,this._data.core.last_error),!1;for(-1!==f&&(e.children=a.vakata.array_remove(e.children,f)),g=b.children_d.concat([]),g.push(b.id),h=0,i=b.parents.length;i>h;h++)this._model.data[b.parents[h]].children_d=a.vakata.array_filter(this._model.data[b.parents[h]].children_d,function(b){return-1===a.inArray(b,g)});for(j=0,k=g.length;k>j;j++)if(this._model.data[g[j]].state.selected){l=!0;break}for(l&&(this._data.core.selected=a.vakata.array_filter(this._data.core.selected,function(b){return-1===a.inArray(b,g)})),this.trigger("delete_node",{node:b,parent:e.id}),l&&this.trigger("changed",{action:"delete_node",node:b,selected:this._data.core.selected,parent:e.id}),j=0,k=g.length;k>j;j++)delete this._model.data[g[j]];return-1!==a.inArray(this._data.core.focused,g)&&(this._data.core.focused=null,m=this.element[0].scrollTop,n=this.element[0].scrollLeft,e.id===a.jstree.root?this._model.data[a.jstree.root].children[0]&&this.get_node(this._model.data[a.jstree.root].children[0],!0).children(".jstree-anchor").focus():this.get_node(e,!0).children(".jstree-anchor").focus(),this.element[0].scrollTop=m,this.element[0].scrollLeft=n),this.redraw_node(e,!0),!0},check:function(b,c,d,e,f){c=c&&c.id?c:this.get_node(c),d=d&&d.id?d:this.get_node(d);var g=b.match(/^move_node|copy_node|create_node$/i)?d:c,h=this.settings.core.check_callback;return"move_node"!==b&&"copy_node"!==b||f&&f.is_multi||c.id!==d.id&&("move_node"!==b||a.inArray(c.id,d.children)!==e)&&-1===a.inArray(d.id,c.children_d)?(g&&g.data&&(g=g.data),g&&g.functions&&(g.functions[b]===!1||g.functions[b]===!0)?(g.functions[b]===!1&&(this._data.core.last_error={error:"check",plugin:"core",id:"core_02",reason:"Node data prevents function: "+b,data:JSON.stringify({chk:b,pos:e,obj:c&&c.id?c.id:!1,par:d&&d.id?d.id:!1})}),g.functions[b]):h===!1||a.isFunction(h)&&h.call(this,b,c,d,e,f)===!1||h&&h[b]===!1?(this._data.core.last_error={error:"check",plugin:"core",id:"core_03",reason:"User config for core.check_callback prevents function: "+b,data:JSON.stringify({chk:b,pos:e,obj:c&&c.id?c.id:!1,par:d&&d.id?d.id:!1})},!1):!0):(this._data.core.last_error={error:"check",plugin:"core",id:"core_01",reason:"Moving parent inside child",data:JSON.stringify({chk:b,pos:e,obj:c&&c.id?c.id:!1,par:d&&d.id?d.id:!1})},!1)},last_error:function(){return this._data.core.last_error},move_node:function(c,d,e,f,g,h,i){var j,k,l,m,n,o,p,q,r,s,t,u,v,w;if(d=this.get_node(d),e=e===b?0:e,!d)return!1;if(!e.toString().match(/^(before|after)$/)&&!g&&!this.is_loaded(d))return this.load_node(d,function(){this.move_node(c,d,e,f,!0,!1,i)});if(a.isArray(c)){if(1!==c.length){for(j=0,k=c.length;k>j;j++)(r=this.move_node(c[j],d,e,f,g,!1,i))&&(d=r,e="after");return this.redraw(),!0}c=c[0]}if(c=c&&c.id?c:this.get_node(c),!c||c.id===a.jstree.root)return!1;if(l=(c.parent||a.jstree.root).toString(),n=e.toString().match(/^(before|after)$/)&&d.id!==a.jstree.root?this.get_node(d.parent):d,o=i?i:this._model.data[c.id]?this:a.jstree.reference(c.id),p=!o||!o._id||this._id!==o._id,m=o&&o._id&&l&&o._model.data[l]&&o._model.data[l].children?a.inArray(c.id,o._model.data[l].children):-1,o&&o._id&&(c=o._model.data[c.id]),p)return(r=this.copy_node(c,d,e,f,g,!1,i))?(o&&o.delete_node(c),r):!1;switch(d.id===a.jstree.root&&("before"===e&&(e="first"),"after"===e&&(e="last")),e){case"before":e=a.inArray(d.id,n.children);break;case"after":e=a.inArray(d.id,n.children)+1;break;case"inside":case"first":e=0;break;case"last":e=n.children.length;break;default:e||(e=0)}if(e>n.children.length&&(e=n.children.length),!this.check("move_node",c,n,e,{core:!0,origin:i,is_multi:o&&o._id&&o._id!==this._id,is_foreign:!o||!o._id}))return this.settings.core.error.call(this,this._data.core.last_error),!1;if(c.parent===n.id){for(q=n.children.concat(),r=a.inArray(c.id,q),-1!==r&&(q=a.vakata.array_remove(q,r),e>r&&e--),r=[],s=0,t=q.length;t>s;s++)r[s>=e?s+1:s]=q[s];r[e]=c.id,n.children=r,this._node_changed(n.id),this.redraw(n.id===a.jstree.root)}else{for(r=c.children_d.concat(),r.push(c.id),s=0,t=c.parents.length;t>s;s++){for(q=[],w=o._model.data[c.parents[s]].children_d,u=0,v=w.length;v>u;u++)-1===a.inArray(w[u],r)&&q.push(w[u]);o._model.data[c.parents[s]].children_d=q}for(o._model.data[l].children=a.vakata.array_remove_item(o._model.data[l].children,c.id),s=0,t=n.parents.length;t>s;s++)this._model.data[n.parents[s]].children_d=this._model.data[n.parents[s]].children_d.concat(r);for(q=[],s=0,t=n.children.length;t>s;s++)q[s>=e?s+1:s]=n.children[s];for(q[e]=c.id,n.children=q,n.children_d.push(c.id),n.children_d=n.children_d.concat(c.children_d),c.parent=n.id,r=n.parents.concat(),r.unshift(n.id),w=c.parents.length,c.parents=r,r=r.concat(),s=0,t=c.children_d.length;t>s;s++)this._model.data[c.children_d[s]].parents=this._model.data[c.children_d[s]].parents.slice(0,-1*w),Array.prototype.push.apply(this._model.data[c.children_d[s]].parents,r);(l===a.jstree.root||n.id===a.jstree.root)&&(this._model.force_full_redraw=!0),this._model.force_full_redraw||(this._node_changed(l),this._node_changed(n.id)),h||this.redraw()}return f&&f.call(this,c,n,e),this.trigger("move_node",{node:c,parent:n.id,position:e,old_parent:l,old_position:m,is_multi:o&&o._id&&o._id!==this._id,is_foreign:!o||!o._id,old_instance:o,new_instance:this}),c.id},copy_node:function(c,d,e,f,g,h,i){var j,k,l,m,n,o,p,q,r,s,t;if(d=this.get_node(d),e=e===b?0:e,!d)return!1;if(!e.toString().match(/^(before|after)$/)&&!g&&!this.is_loaded(d))return this.load_node(d,function(){this.copy_node(c,d,e,f,!0,!1,i)});if(a.isArray(c)){if(1!==c.length){for(j=0,k=c.length;k>j;j++)(m=this.copy_node(c[j],d,e,f,g,!0,i))&&(d=m,e="after");return this.redraw(),!0}c=c[0]}if(c=c&&c.id?c:this.get_node(c),!c||c.id===a.jstree.root)return!1;switch(q=(c.parent||a.jstree.root).toString(),r=e.toString().match(/^(before|after)$/)&&d.id!==a.jstree.root?this.get_node(d.parent):d,s=i?i:this._model.data[c.id]?this:a.jstree.reference(c.id),t=!s||!s._id||this._id!==s._id,s&&s._id&&(c=s._model.data[c.id]),d.id===a.jstree.root&&("before"===e&&(e="first"),"after"===e&&(e="last")),e){case"before":e=a.inArray(d.id,r.children);break;case"after":e=a.inArray(d.id,r.children)+1;break;case"inside":case"first":e=0;break;case"last":e=r.children.length;break;default:e||(e=0)}if(e>r.children.length&&(e=r.children.length),!this.check("copy_node",c,r,e,{core:!0,origin:i,is_multi:s&&s._id&&s._id!==this._id,is_foreign:!s||!s._id}))return this.settings.core.error.call(this,this._data.core.last_error),!1;if(p=s?s.get_json(c,{no_id:!0,no_data:!0,no_state:!0}):c,!p)return!1;if(p.id===!0&&delete p.id,p=this._parse_model_from_json(p,r.id,r.parents.concat()),!p)return!1;for(m=this.get_node(p),c&&c.state&&c.state.loaded===!1&&(m.state.loaded=!1),l=[],l.push(p),l=l.concat(m.children_d),this.trigger("model",{nodes:l,parent:r.id}),n=0,o=r.parents.length;o>n;n++)this._model.data[r.parents[n]].children_d=this._model.data[r.parents[n]].children_d.concat(l);for(l=[],n=0,o=r.children.length;o>n;n++)l[n>=e?n+1:n]=r.children[n];return l[e]=m.id,r.children=l,r.children_d.push(m.id),r.children_d=r.children_d.concat(m.children_d),r.id===a.jstree.root&&(this._model.force_full_redraw=!0),this._model.force_full_redraw||this._node_changed(r.id),h||this.redraw(r.id===a.jstree.root),f&&f.call(this,m,r,e),this.trigger("copy_node",{node:m,original:c,parent:r.id,position:e,old_parent:q,old_position:s&&s._id&&q&&s._model.data[q]&&s._model.data[q].children?a.inArray(c.id,s._model.data[q].children):-1,is_multi:s&&s._id&&s._id!==this._id,is_foreign:!s||!s._id,old_instance:s,new_instance:this}),m.id},cut:function(b){if(b||(b=this._data.core.selected.concat()),a.isArray(b)||(b=[b]),!b.length)return!1;var c=[],g,h,i;for(h=0,i=b.length;i>h;h++)g=this.get_node(b[h]),g&&g.id&&g.id!==a.jstree.root&&c.push(g);
return c.length?(d=c,f=this,e="move_node",void this.trigger("cut",{node:b})):!1},copy:function(b){if(b||(b=this._data.core.selected.concat()),a.isArray(b)||(b=[b]),!b.length)return!1;var c=[],g,h,i;for(h=0,i=b.length;i>h;h++)g=this.get_node(b[h]),g&&g.id&&g.id!==a.jstree.root&&c.push(g);return c.length?(d=c,f=this,e="copy_node",void this.trigger("copy",{node:b})):!1},get_buffer:function(){return{mode:e,node:d,inst:f}},can_paste:function(){return e!==!1&&d!==!1},paste:function(a,b){return a=this.get_node(a),a&&e&&e.match(/^(copy_node|move_node)$/)&&d?(this[e](d,a,b,!1,!1,!1,f)&&this.trigger("paste",{parent:a.id,node:d,mode:e}),d=!1,e=!1,void(f=!1)):!1},clear_buffer:function(){d=!1,e=!1,f=!1,this.trigger("clear_buffer")},edit:function(b,c,d){var e,f,g,h,j,k,l,m,n,o=!1;return(b=this.get_node(b))?this.check("edit",b,this.get_parent(b))?(n=b,c="string"==typeof c?c:b.text,this.set_text(b,""),b=this._open_to(b),n.text=c,e=this._data.core.rtl,f=this.element.width(),this._data.core.focused=n.id,g=b.children(".jstree-anchor").focus(),h=a("<span>"),j=c,k=a("<div />",{css:{position:"absolute",top:"-200px",left:e?"0px":"-1000px",visibility:"hidden"}}).appendTo(i.body),l=a("<input />",{value:j,"class":"jstree-rename-input",css:{padding:"0",border:"1px solid silver","box-sizing":"border-box",display:"inline-block",height:this._data.core.li_height+"px",lineHeight:this._data.core.li_height+"px",width:"150px"},blur:a.proxy(function(c){c.stopImmediatePropagation(),c.preventDefault();var e=h.children(".jstree-rename-input"),f=e.val(),i=this.settings.core.force_text,m;""===f&&(f=j),k.remove(),h.replaceWith(g),h.remove(),j=i?j:a("<div></div>").append(a.parseHTML(j)).html(),b=this.get_node(b),this.set_text(b,j),m=!!this.rename_node(b,i?a("<div></div>").text(f).text():a("<div></div>").append(a.parseHTML(f)).html()),m||this.set_text(b,j),this._data.core.focused=n.id,setTimeout(a.proxy(function(){var a=this.get_node(n.id,!0);a.length&&(this._data.core.focused=n.id,a.children(".jstree-anchor").focus())},this),0),d&&d.call(this,n,m,o),l=null},this),keydown:function(a){var b=a.which;27===b&&(o=!0,this.value=j),(27===b||13===b||37===b||38===b||39===b||40===b||32===b)&&a.stopImmediatePropagation(),(27===b||13===b)&&(a.preventDefault(),this.blur())},click:function(a){a.stopImmediatePropagation()},mousedown:function(a){a.stopImmediatePropagation()},keyup:function(a){l.width(Math.min(k.text("pW"+this.value).width(),f))},keypress:function(a){return 13===a.which?!1:void 0}}),m={fontFamily:g.css("fontFamily")||"",fontSize:g.css("fontSize")||"",fontWeight:g.css("fontWeight")||"",fontStyle:g.css("fontStyle")||"",fontStretch:g.css("fontStretch")||"",fontVariant:g.css("fontVariant")||"",letterSpacing:g.css("letterSpacing")||"",wordSpacing:g.css("wordSpacing")||""},h.attr("class",g.attr("class")).append(g.contents().clone()).append(l),g.replaceWith(h),k.css(m),l.css(m).width(Math.min(k.text("pW"+l[0].value).width(),f))[0].select(),void a(i).one("mousedown.jstree touchstart.jstree dnd_start.vakata",function(b){l&&b.target!==l&&a(l).blur()})):(this.settings.core.error.call(this,this._data.core.last_error),!1):!1},set_theme:function(b,c){if(!b)return!1;if(c===!0){var d=this.settings.core.themes.dir;d||(d=a.jstree.path+"/themes"),c=d+"/"+b+"/style.css"}c&&-1===a.inArray(c,g)&&(a("head").append('<link rel="stylesheet" href="'+c+'" type="text/css" />'),g.push(c)),this._data.core.themes.name&&this.element.removeClass("jstree-"+this._data.core.themes.name),this._data.core.themes.name=b,this.element.addClass("jstree-"+b),this.element[this.settings.core.themes.responsive?"addClass":"removeClass"]("jstree-"+b+"-responsive"),this.trigger("set_theme",{theme:b})},get_theme:function(){return this._data.core.themes.name},set_theme_variant:function(a){this._data.core.themes.variant&&this.element.removeClass("jstree-"+this._data.core.themes.name+"-"+this._data.core.themes.variant),this._data.core.themes.variant=a,a&&this.element.addClass("jstree-"+this._data.core.themes.name+"-"+this._data.core.themes.variant)},get_theme_variant:function(){return this._data.core.themes.variant},show_stripes:function(){this._data.core.themes.stripes=!0,this.get_container_ul().addClass("jstree-striped"),this.trigger("show_stripes")},hide_stripes:function(){this._data.core.themes.stripes=!1,this.get_container_ul().removeClass("jstree-striped"),this.trigger("hide_stripes")},toggle_stripes:function(){this._data.core.themes.stripes?this.hide_stripes():this.show_stripes()},show_dots:function(){this._data.core.themes.dots=!0,this.get_container_ul().removeClass("jstree-no-dots"),this.trigger("show_dots")},hide_dots:function(){this._data.core.themes.dots=!1,this.get_container_ul().addClass("jstree-no-dots"),this.trigger("hide_dots")},toggle_dots:function(){this._data.core.themes.dots?this.hide_dots():this.show_dots()},show_icons:function(){this._data.core.themes.icons=!0,this.get_container_ul().removeClass("jstree-no-icons"),this.trigger("show_icons")},hide_icons:function(){this._data.core.themes.icons=!1,this.get_container_ul().addClass("jstree-no-icons"),this.trigger("hide_icons")},toggle_icons:function(){this._data.core.themes.icons?this.hide_icons():this.show_icons()},show_ellipsis:function(){this._data.core.themes.ellipsis=!0,this.get_container_ul().addClass("jstree-ellipsis"),this.trigger("show_ellipsis")},hide_ellipsis:function(){this._data.core.themes.ellipsis=!1,this.get_container_ul().removeClass("jstree-ellipsis"),this.trigger("hide_ellipsis")},toggle_ellipsis:function(){this._data.core.themes.ellipsis?this.hide_ellipsis():this.show_ellipsis()},set_icon:function(c,d){var e,f,g,h;if(a.isArray(c)){for(c=c.slice(),e=0,f=c.length;f>e;e++)this.set_icon(c[e],d);return!0}return c=this.get_node(c),c&&c.id!==a.jstree.root?(h=c.icon,c.icon=d===!0||null===d||d===b||""===d?!0:d,g=this.get_node(c,!0).children(".jstree-anchor").children(".jstree-themeicon"),d===!1?(g.removeClass("jstree-themeicon-custom "+h).css("background","").removeAttr("rel"),this.hide_icon(c)):d===!0||null===d||d===b||""===d?(g.removeClass("jstree-themeicon-custom "+h).css("background","").removeAttr("rel"),h===!1&&this.show_icon(c)):-1===d.indexOf("/")&&-1===d.indexOf(".")?(g.removeClass(h).css("background",""),g.addClass(d+" jstree-themeicon-custom").attr("rel",d),h===!1&&this.show_icon(c)):(g.removeClass(h).css("background",""),g.addClass("jstree-themeicon-custom").css("background","url('"+d+"') center center no-repeat").attr("rel",d),h===!1&&this.show_icon(c)),!0):!1},get_icon:function(b){return b=this.get_node(b),b&&b.id!==a.jstree.root?b.icon:!1},hide_icon:function(b){var c,d;if(a.isArray(b)){for(b=b.slice(),c=0,d=b.length;d>c;c++)this.hide_icon(b[c]);return!0}return b=this.get_node(b),b&&b!==a.jstree.root?(b.icon=!1,this.get_node(b,!0).children(".jstree-anchor").children(".jstree-themeicon").addClass("jstree-themeicon-hidden"),!0):!1},show_icon:function(b){var c,d,e;if(a.isArray(b)){for(b=b.slice(),c=0,d=b.length;d>c;c++)this.show_icon(b[c]);return!0}return b=this.get_node(b),b&&b!==a.jstree.root?(e=this.get_node(b,!0),b.icon=e.length?e.children(".jstree-anchor").children(".jstree-themeicon").attr("rel"):!0,b.icon||(b.icon=!0),e.children(".jstree-anchor").children(".jstree-themeicon").removeClass("jstree-themeicon-hidden"),!0):!1}},a.vakata={},a.vakata.attributes=function(b,c){b=a(b)[0];var d=c?{}:[];return b&&b.attributes&&a.each(b.attributes,function(b,e){-1===a.inArray(e.name.toLowerCase(),["style","contenteditable","hasfocus","tabindex"])&&null!==e.value&&""!==a.trim(e.value)&&(c?d[e.name]=e.value:d.push(e.name))}),d},a.vakata.array_unique=function(a){var c=[],d,e,f,g={};for(d=0,f=a.length;f>d;d++)g[a[d]]===b&&(c.push(a[d]),g[a[d]]=!0);return c},a.vakata.array_remove=function(a,b){return a.splice(b,1),a},a.vakata.array_remove_item=function(b,c){var d=a.inArray(c,b);return-1!==d?a.vakata.array_remove(b,d):b},a.vakata.array_filter=function(a,b,c,d,e){if(a.filter)return a.filter(b,c);d=[];for(e in a)~~e+""==e+""&&e>=0&&b.call(c,a[e],+e,a)&&d.push(a[e]);return d},a.jstree.plugins.changed=function(a,b){var c=[];this.trigger=function(a,d){var e,f;if(d||(d={}),"changed"===a.replace(".jstree","")){d.changed={selected:[],deselected:[]};var g={};for(e=0,f=c.length;f>e;e++)g[c[e]]=1;for(e=0,f=d.selected.length;f>e;e++)g[d.selected[e]]?g[d.selected[e]]=2:d.changed.selected.push(d.selected[e]);for(e=0,f=c.length;f>e;e++)1===g[c[e]]&&d.changed.deselected.push(c[e]);c=d.selected.slice()}b.trigger.call(this,a,d)},this.refresh=function(a,d){return c=[],b.refresh.apply(this,arguments)}};var j=i.createElement("I");j.className="jstree-icon jstree-checkbox",j.setAttribute("role","presentation"),a.jstree.defaults.checkbox={visible:!0,three_state:!0,whole_node:!0,keep_selected_style:!0,cascade:"",tie_selection:!0,cascade_to_disabled:!0,cascade_to_hidden:!0},a.jstree.plugins.checkbox=function(c,d){this.bind=function(){d.bind.call(this),this._data.checkbox.uto=!1,this._data.checkbox.selected=[],this.settings.checkbox.three_state&&(this.settings.checkbox.cascade="up+down+undetermined"),this.element.on("init.jstree",a.proxy(function(){this._data.checkbox.visible=this.settings.checkbox.visible,this.settings.checkbox.keep_selected_style||this.element.addClass("jstree-checkbox-no-clicked"),this.settings.checkbox.tie_selection&&this.element.addClass("jstree-checkbox-selection")},this)).on("loading.jstree",a.proxy(function(){this[this._data.checkbox.visible?"show_checkboxes":"hide_checkboxes"]()},this)),-1!==this.settings.checkbox.cascade.indexOf("undetermined")&&this.element.on("changed.jstree uncheck_node.jstree check_node.jstree uncheck_all.jstree check_all.jstree move_node.jstree copy_node.jstree redraw.jstree open_node.jstree",a.proxy(function(){this._data.checkbox.uto&&clearTimeout(this._data.checkbox.uto),this._data.checkbox.uto=setTimeout(a.proxy(this._undetermined,this),50)},this)),this.settings.checkbox.tie_selection||this.element.on("model.jstree",a.proxy(function(a,b){var c=this._model.data,d=c[b.parent],e=b.nodes,f,g;for(f=0,g=e.length;g>f;f++)c[e[f]].state.checked=c[e[f]].state.checked||c[e[f]].original&&c[e[f]].original.state&&c[e[f]].original.state.checked,c[e[f]].state.checked&&this._data.checkbox.selected.push(e[f])},this)),(-1!==this.settings.checkbox.cascade.indexOf("up")||-1!==this.settings.checkbox.cascade.indexOf("down"))&&this.element.on("model.jstree",a.proxy(function(b,c){var d=this._model.data,e=d[c.parent],f=c.nodes,g=[],h,i,j,k,l,m,n=this.settings.checkbox.cascade,o=this.settings.checkbox.tie_selection;if(-1!==n.indexOf("down"))if(e.state[o?"selected":"checked"]){for(i=0,j=f.length;j>i;i++)d[f[i]].state[o?"selected":"checked"]=!0;this._data[o?"core":"checkbox"].selected=this._data[o?"core":"checkbox"].selected.concat(f)}else for(i=0,j=f.length;j>i;i++)if(d[f[i]].state[o?"selected":"checked"]){for(k=0,l=d[f[i]].children_d.length;l>k;k++)d[d[f[i]].children_d[k]].state[o?"selected":"checked"]=!0;this._data[o?"core":"checkbox"].selected=this._data[o?"core":"checkbox"].selected.concat(d[f[i]].children_d)}if(-1!==n.indexOf("up")){for(i=0,j=e.children_d.length;j>i;i++)d[e.children_d[i]].children.length||g.push(d[e.children_d[i]].parent);for(g=a.vakata.array_unique(g),k=0,l=g.length;l>k;k++){e=d[g[k]];while(e&&e.id!==a.jstree.root){for(h=0,i=0,j=e.children.length;j>i;i++)h+=d[e.children[i]].state[o?"selected":"checked"];if(h!==j)break;e.state[o?"selected":"checked"]=!0,this._data[o?"core":"checkbox"].selected.push(e.id),m=this.get_node(e,!0),m&&m.length&&m.attr("aria-selected",!0).children(".jstree-anchor").addClass(o?"jstree-clicked":"jstree-checked"),e=this.get_node(e.parent)}}}this._data[o?"core":"checkbox"].selected=a.vakata.array_unique(this._data[o?"core":"checkbox"].selected)},this)).on(this.settings.checkbox.tie_selection?"select_node.jstree":"check_node.jstree",a.proxy(function(b,c){var d=this,e=c.node,f=this._model.data,g=this.get_node(e.parent),h,i,j,k,l=this.settings.checkbox.cascade,m=this.settings.checkbox.tie_selection,n={},o=this._data[m?"core":"checkbox"].selected;for(h=0,i=o.length;i>h;h++)n[o[h]]=!0;if(-1!==l.indexOf("down")){var p=this._cascade_new_checked_state(e.id,!0),q=e.children_d.concat(e.id);for(h=0,i=q.length;i>h;h++)p.indexOf(q[h])>-1?n[q[h]]=!0:delete n[q[h]]}if(-1!==l.indexOf("up"))while(g&&g.id!==a.jstree.root){for(j=0,h=0,i=g.children.length;i>h;h++)j+=f[g.children[h]].state[m?"selected":"checked"];if(j!==i)break;g.state[m?"selected":"checked"]=!0,n[g.id]=!0,k=this.get_node(g,!0),k&&k.length&&k.attr("aria-selected",!0).children(".jstree-anchor").addClass(m?"jstree-clicked":"jstree-checked"),g=this.get_node(g.parent)}o=[];for(h in n)n.hasOwnProperty(h)&&o.push(h);this._data[m?"core":"checkbox"].selected=o},this)).on(this.settings.checkbox.tie_selection?"deselect_all.jstree":"uncheck_all.jstree",a.proxy(function(b,c){var d=this.get_node(a.jstree.root),e=this._model.data,f,g,h;for(f=0,g=d.children_d.length;g>f;f++)h=e[d.children_d[f]],h&&h.original&&h.original.state&&h.original.state.undetermined&&(h.original.state.undetermined=!1)},this)).on(this.settings.checkbox.tie_selection?"deselect_node.jstree":"uncheck_node.jstree",a.proxy(function(a,b){var c=this,d=b.node,e=this.get_node(d,!0),f,g,h,i=this.settings.checkbox.cascade,j=this.settings.checkbox.tie_selection,k=this._data[j?"core":"checkbox"].selected,l={},m=[],n=d.children_d.concat(d.id);if(-1!==i.indexOf("down")){var o=this._cascade_new_checked_state(d.id,!1);k=k.filter(function(a){return-1===n.indexOf(a)||o.indexOf(a)>-1})}if(-1!==i.indexOf("up")&&-1===k.indexOf(d.id)){for(f=0,g=d.parents.length;g>f;f++)h=this._model.data[d.parents[f]],h.state[j?"selected":"checked"]=!1,h&&h.original&&h.original.state&&h.original.state.undetermined&&(h.original.state.undetermined=!1),h=this.get_node(d.parents[f],!0),h&&h.length&&h.attr("aria-selected",!1).children(".jstree-anchor").removeClass(j?"jstree-clicked":"jstree-checked");k=k.filter(function(a){return-1===d.parents.indexOf(a)})}this._data[j?"core":"checkbox"].selected=k},this)),-1!==this.settings.checkbox.cascade.indexOf("up")&&this.element.on("delete_node.jstree",a.proxy(function(b,c){var d=this.get_node(c.parent),e=this._model.data,f,g,h,i,j=this.settings.checkbox.tie_selection;while(d&&d.id!==a.jstree.root&&!d.state[j?"selected":"checked"]){for(h=0,f=0,g=d.children.length;g>f;f++)h+=e[d.children[f]].state[j?"selected":"checked"];if(!(g>0&&h===g))break;d.state[j?"selected":"checked"]=!0,this._data[j?"core":"checkbox"].selected.push(d.id),i=this.get_node(d,!0),i&&i.length&&i.attr("aria-selected",!0).children(".jstree-anchor").addClass(j?"jstree-clicked":"jstree-checked"),d=this.get_node(d.parent)}},this)).on("move_node.jstree",a.proxy(function(b,c){var d=c.is_multi,e=c.old_parent,f=this.get_node(c.parent),g=this._model.data,h,i,j,k,l,m=this.settings.checkbox.tie_selection;if(!d){h=this.get_node(e);while(h&&h.id!==a.jstree.root&&!h.state[m?"selected":"checked"]){for(i=0,j=0,k=h.children.length;k>j;j++)i+=g[h.children[j]].state[m?"selected":"checked"];if(!(k>0&&i===k))break;h.state[m?"selected":"checked"]=!0,this._data[m?"core":"checkbox"].selected.push(h.id),l=this.get_node(h,!0),l&&l.length&&l.attr("aria-selected",!0).children(".jstree-anchor").addClass(m?"jstree-clicked":"jstree-checked"),h=this.get_node(h.parent)}}h=f;while(h&&h.id!==a.jstree.root){for(i=0,j=0,k=h.children.length;k>j;j++)i+=g[h.children[j]].state[m?"selected":"checked"];if(i===k)h.state[m?"selected":"checked"]||(h.state[m?"selected":"checked"]=!0,this._data[m?"core":"checkbox"].selected.push(h.id),l=this.get_node(h,!0),l&&l.length&&l.attr("aria-selected",!0).children(".jstree-anchor").addClass(m?"jstree-clicked":"jstree-checked"));else{if(!h.state[m?"selected":"checked"])break;h.state[m?"selected":"checked"]=!1,this._data[m?"core":"checkbox"].selected=a.vakata.array_remove_item(this._data[m?"core":"checkbox"].selected,h.id),l=this.get_node(h,!0),l&&l.length&&l.attr("aria-selected",!1).children(".jstree-anchor").removeClass(m?"jstree-clicked":"jstree-checked")}h=this.get_node(h.parent)}},this))},this.get_undetermined=function(c){if(-1===this.settings.checkbox.cascade.indexOf("undetermined"))return[];var d,e,f,g,h={},i=this._model.data,j=this.settings.checkbox.tie_selection,k=this._data[j?"core":"checkbox"].selected,l=[],m=this,n=[];for(d=0,e=k.length;e>d;d++)if(i[k[d]]&&i[k[d]].parents)for(f=0,g=i[k[d]].parents.length;g>f;f++){if(h[i[k[d]].parents[f]]!==b)break;i[k[d]].parents[f]!==a.jstree.root&&(h[i[k[d]].parents[f]]=!0,l.push(i[k[d]].parents[f]))}for(this.element.find(".jstree-closed").not(":has(.jstree-children)").each(function(){var c=m.get_node(this),j;if(c)if(c.state.loaded){for(d=0,e=c.children_d.length;e>d;d++)if(j=i[c.children_d[d]],!j.state.loaded&&j.original&&j.original.state&&j.original.state.undetermined&&j.original.state.undetermined===!0)for(h[j.id]===b&&j.id!==a.jstree.root&&(h[j.id]=!0,l.push(j.id)),f=0,g=j.parents.length;g>f;f++)h[j.parents[f]]===b&&j.parents[f]!==a.jstree.root&&(h[j.parents[f]]=!0,l.push(j.parents[f]))}else if(c.original&&c.original.state&&c.original.state.undetermined&&c.original.state.undetermined===!0)for(h[c.id]===b&&c.id!==a.jstree.root&&(h[c.id]=!0,l.push(c.id)),f=0,g=c.parents.length;g>f;f++)h[c.parents[f]]===b&&c.parents[f]!==a.jstree.root&&(h[c.parents[f]]=!0,l.push(c.parents[f]))}),d=0,e=l.length;e>d;d++)i[l[d]].state[j?"selected":"checked"]||n.push(c?i[l[d]]:l[d]);return n},this._undetermined=function(){if(null!==this.element){var a=this.get_undetermined(!1),b,c,d;for(this.element.find(".jstree-undetermined").removeClass("jstree-undetermined"),b=0,c=a.length;c>b;b++)d=this.get_node(a[b],!0),d&&d.length&&d.children(".jstree-anchor").children(".jstree-checkbox").addClass("jstree-undetermined")}},this.redraw_node=function(b,c,e,f){if(b=d.redraw_node.apply(this,arguments)){var g,h,i=null,k=null;for(g=0,h=b.childNodes.length;h>g;g++)if(b.childNodes[g]&&b.childNodes[g].className&&-1!==b.childNodes[g].className.indexOf("jstree-anchor")){i=b.childNodes[g];break}i&&(!this.settings.checkbox.tie_selection&&this._model.data[b.id].state.checked&&(i.className+=" jstree-checked"),k=j.cloneNode(!1),this._model.data[b.id].state.checkbox_disabled&&(k.className+=" jstree-checkbox-disabled"),i.insertBefore(k,i.childNodes[0]))}return e||-1===this.settings.checkbox.cascade.indexOf("undetermined")||(this._data.checkbox.uto&&clearTimeout(this._data.checkbox.uto),this._data.checkbox.uto=setTimeout(a.proxy(this._undetermined,this),50)),b},this.show_checkboxes=function(){this._data.core.themes.checkboxes=!0,this.get_container_ul().removeClass("jstree-no-checkboxes")},this.hide_checkboxes=function(){this._data.core.themes.checkboxes=!1,this.get_container_ul().addClass("jstree-no-checkboxes")},this.toggle_checkboxes=function(){this._data.core.themes.checkboxes?this.hide_checkboxes():this.show_checkboxes()},this.is_undetermined=function(b){b=this.get_node(b);var c=this.settings.checkbox.cascade,d,e,f=this.settings.checkbox.tie_selection,g=this._data[f?"core":"checkbox"].selected,h=this._model.data;if(!b||b.state[f?"selected":"checked"]===!0||-1===c.indexOf("undetermined")||-1===c.indexOf("down")&&-1===c.indexOf("up"))return!1;if(!b.state.loaded&&b.original.state.undetermined===!0)return!0;for(d=0,e=b.children_d.length;e>d;d++)if(-1!==a.inArray(b.children_d[d],g)||!h[b.children_d[d]].state.loaded&&h[b.children_d[d]].original.state.undetermined)return!0;return!1},this.disable_checkbox=function(b){var c,d,e;if(a.isArray(b)){for(b=b.slice(),c=0,d=b.length;d>c;c++)this.disable_checkbox(b[c]);return!0}return b=this.get_node(b),b&&b.id!==a.jstree.root?(e=this.get_node(b,!0),void(b.state.checkbox_disabled||(b.state.checkbox_disabled=!0,e&&e.length&&e.children(".jstree-anchor").children(".jstree-checkbox").addClass("jstree-checkbox-disabled"),this.trigger("disable_checkbox",{node:b})))):!1},this.enable_checkbox=function(b){var c,d,e;if(a.isArray(b)){for(b=b.slice(),c=0,d=b.length;d>c;c++)this.enable_checkbox(b[c]);return!0}return b=this.get_node(b),b&&b.id!==a.jstree.root?(e=this.get_node(b,!0),void(b.state.checkbox_disabled&&(b.state.checkbox_disabled=!1,e&&e.length&&e.children(".jstree-anchor").children(".jstree-checkbox").removeClass("jstree-checkbox-disabled"),this.trigger("enable_checkbox",{node:b})))):!1},this.activate_node=function(b,c){return a(c.target).hasClass("jstree-checkbox-disabled")?!1:(this.settings.checkbox.tie_selection&&(this.settings.checkbox.whole_node||a(c.target).hasClass("jstree-checkbox"))&&(c.ctrlKey=!0),this.settings.checkbox.tie_selection||!this.settings.checkbox.whole_node&&!a(c.target).hasClass("jstree-checkbox")?d.activate_node.call(this,b,c):this.is_disabled(b)?!1:(this.is_checked(b)?this.uncheck_node(b,c):this.check_node(b,c),void this.trigger("activate_node",{node:this.get_node(b)})))},this._cascade_new_checked_state=function(a,b){var c=this,d=this.settings.checkbox.tie_selection,e=this._model.data[a],f=[],g=[],h,i,j;if(!this.settings.checkbox.cascade_to_disabled&&e.state.disabled||!this.settings.checkbox.cascade_to_hidden&&e.state.hidden)j=this.get_checked_descendants(a),e.state[d?"selected":"checked"]&&j.push(e.id),f=f.concat(j);else{if(e.children)for(h=0,i=e.children.length;i>h;h++){var k=e.children[h];j=c._cascade_new_checked_state(k,b),f=f.concat(j),j.indexOf(k)>-1&&g.push(k)}var l=c.get_node(e,!0),m=g.length>0&&g.length<e.children.length;e.original&&e.original.state&&e.original.state.undetermined&&(e.original.state.undetermined=m),m?(e.state[d?"selected":"checked"]=!1,l.attr("aria-selected",!1).children(".jstree-anchor").removeClass(d?"jstree-clicked":"jstree-checked")):b&&g.length===e.children.length?(e.state[d?"selected":"checked"]=b,f.push(e.id),l.attr("aria-selected",!0).children(".jstree-anchor").addClass(d?"jstree-clicked":"jstree-checked")):(e.state[d?"selected":"checked"]=!1,l.attr("aria-selected",!1).children(".jstree-anchor").removeClass(d?"jstree-clicked":"jstree-checked"))}return f},this.get_checked_descendants=function(a){var b=this,c=b.settings.checkbox.tie_selection,d=b._model.data[a];return d.children_d.filter(function(a){return b._model.data[a].state[c?"selected":"checked"]})},this.check_node=function(b,c){if(this.settings.checkbox.tie_selection)return this.select_node(b,!1,!0,c);var d,e,f,g;if(a.isArray(b)){for(b=b.slice(),e=0,f=b.length;f>e;e++)this.check_node(b[e],c);return!0}return b=this.get_node(b),b&&b.id!==a.jstree.root?(d=this.get_node(b,!0),void(b.state.checked||(b.state.checked=!0,this._data.checkbox.selected.push(b.id),d&&d.length&&d.children(".jstree-anchor").addClass("jstree-checked"),this.trigger("check_node",{node:b,selected:this._data.checkbox.selected,event:c})))):!1},this.uncheck_node=function(b,c){if(this.settings.checkbox.tie_selection)return this.deselect_node(b,!1,c);var d,e,f;if(a.isArray(b)){for(b=b.slice(),d=0,e=b.length;e>d;d++)this.uncheck_node(b[d],c);return!0}return b=this.get_node(b),b&&b.id!==a.jstree.root?(f=this.get_node(b,!0),void(b.state.checked&&(b.state.checked=!1,this._data.checkbox.selected=a.vakata.array_remove_item(this._data.checkbox.selected,b.id),f.length&&f.children(".jstree-anchor").removeClass("jstree-checked"),this.trigger("uncheck_node",{node:b,selected:this._data.checkbox.selected,event:c})))):!1},this.check_all=function(){if(this.settings.checkbox.tie_selection)return this.select_all();var b=this._data.checkbox.selected.concat([]),c,d;for(this._data.checkbox.selected=this._model.data[a.jstree.root].children_d.concat(),c=0,d=this._data.checkbox.selected.length;d>c;c++)this._model.data[this._data.checkbox.selected[c]]&&(this._model.data[this._data.checkbox.selected[c]].state.checked=!0);this.redraw(!0),this.trigger("check_all",{selected:this._data.checkbox.selected})},this.uncheck_all=function(){if(this.settings.checkbox.tie_selection)return this.deselect_all();var a=this._data.checkbox.selected.concat([]),b,c;for(b=0,c=this._data.checkbox.selected.length;c>b;b++)this._model.data[this._data.checkbox.selected[b]]&&(this._model.data[this._data.checkbox.selected[b]].state.checked=!1);this._data.checkbox.selected=[],this.element.find(".jstree-checked").removeClass("jstree-checked"),this.trigger("uncheck_all",{selected:this._data.checkbox.selected,node:a})},this.is_checked=function(b){return this.settings.checkbox.tie_selection?this.is_selected(b):(b=this.get_node(b),b&&b.id!==a.jstree.root?b.state.checked:!1)},this.get_checked=function(b){return this.settings.checkbox.tie_selection?this.get_selected(b):b?a.map(this._data.checkbox.selected,a.proxy(function(a){return this.get_node(a)},this)):this._data.checkbox.selected},this.get_top_checked=function(b){if(this.settings.checkbox.tie_selection)return this.get_top_selected(b);var c=this.get_checked(!0),d={},e,f,g,h;for(e=0,f=c.length;f>e;e++)d[c[e].id]=c[e];for(e=0,f=c.length;f>e;e++)for(g=0,h=c[e].children_d.length;h>g;g++)d[c[e].children_d[g]]&&delete d[c[e].children_d[g]];c=[];for(e in d)d.hasOwnProperty(e)&&c.push(e);return b?a.map(c,a.proxy(function(a){return this.get_node(a)},this)):c},this.get_bottom_checked=function(b){if(this.settings.checkbox.tie_selection)return this.get_bottom_selected(b);var c=this.get_checked(!0),d=[],e,f;for(e=0,f=c.length;f>e;e++)c[e].children.length||d.push(c[e].id);return b?a.map(d,a.proxy(function(a){return this.get_node(a)},this)):d},this.load_node=function(b,c){var e,f,g,h,i,j;if(!a.isArray(b)&&!this.settings.checkbox.tie_selection&&(j=this.get_node(b),j&&j.state.loaded))for(e=0,f=j.children_d.length;f>e;e++)this._model.data[j.children_d[e]].state.checked&&(i=!0,this._data.checkbox.selected=a.vakata.array_remove_item(this._data.checkbox.selected,j.children_d[e]));return d.load_node.apply(this,arguments)},this.get_state=function(){var a=d.get_state.apply(this,arguments);return this.settings.checkbox.tie_selection?a:(a.checkbox=this._data.checkbox.selected.slice(),a)},this.set_state=function(b,c){var e=d.set_state.apply(this,arguments);if(e&&b.checkbox){if(!this.settings.checkbox.tie_selection){this.uncheck_all();var f=this;a.each(b.checkbox,function(a,b){f.check_node(b)})}return delete b.checkbox,this.set_state(b,c),!1}return e},this.refresh=function(a,b){return this.settings.checkbox.tie_selection&&(this._data.checkbox.selected=[]),d.refresh.apply(this,arguments)}},a.jstree.defaults.conditionalselect=function(){return!0},a.jstree.plugins.conditionalselect=function(a,b){this.activate_node=function(a,c){return this.settings.conditionalselect.call(this,this.get_node(a),c)?b.activate_node.call(this,a,c):void 0}},a.jstree.defaults.contextmenu={select_node:!0,show_at_node:!0,items:function(b,c){return{create:{separator_before:!1,separator_after:!0,_disabled:!1,label:"Create",action:function(b){var c=a.jstree.reference(b.reference),d=c.get_node(b.reference);c.create_node(d,{},"last",function(a){try{c.edit(a)}catch(b){setTimeout(function(){c.edit(a)},0)}})}},rename:{separator_before:!1,separator_after:!1,_disabled:!1,label:"Rename",action:function(b){var c=a.jstree.reference(b.reference),d=c.get_node(b.reference);c.edit(d)}},remove:{separator_before:!1,icon:!1,separator_after:!1,_disabled:!1,label:"Delete",action:function(b){var c=a.jstree.reference(b.reference),d=c.get_node(b.reference);c.is_selected(d)?c.delete_node(c.get_selected()):c.delete_node(d)}},ccp:{separator_before:!0,icon:!1,separator_after:!1,label:"Edit",action:!1,submenu:{cut:{separator_before:!1,separator_after:!1,label:"Cut",action:function(b){var c=a.jstree.reference(b.reference),d=c.get_node(b.reference);c.is_selected(d)?c.cut(c.get_top_selected()):c.cut(d)}},copy:{separator_before:!1,icon:!1,separator_after:!1,label:"Copy",action:function(b){var c=a.jstree.reference(b.reference),d=c.get_node(b.reference);c.is_selected(d)?c.copy(c.get_top_selected()):c.copy(d)}},paste:{separator_before:!1,icon:!1,_disabled:function(b){return!a.jstree.reference(b.reference).can_paste()},separator_after:!1,label:"Paste",action:function(b){var c=a.jstree.reference(b.reference),d=c.get_node(b.reference);c.paste(d)}}}}}}},a.jstree.plugins.contextmenu=function(c,d){this.bind=function(){d.bind.call(this);var b=0,c=null,e,f;this.element.on("init.jstree loading.jstree ready.jstree",a.proxy(function(){this.get_container_ul().addClass("jstree-contextmenu")},this)).on("contextmenu.jstree",".jstree-anchor",a.proxy(function(a,d){"input"!==a.target.tagName.toLowerCase()&&(a.preventDefault(),b=a.ctrlKey?+new Date:0,(d||c)&&(b=+new Date+1e4),c&&clearTimeout(c),this.is_loading(a.currentTarget)||this.show_contextmenu(a.currentTarget,a.pageX,a.pageY,a))},this)).on("click.jstree",".jstree-anchor",a.proxy(function(c){this._data.contextmenu.visible&&(!b||+new Date-b>250)&&a.vakata.context.hide(),b=0},this)).on("touchstart.jstree",".jstree-anchor",function(b){b.originalEvent&&b.originalEvent.changedTouches&&b.originalEvent.changedTouches[0]&&(e=b.originalEvent.changedTouches[0].clientX,f=b.originalEvent.changedTouches[0].clientY,c=setTimeout(function(){a(b.currentTarget).trigger("contextmenu",!0)},750))}).on("touchmove.vakata.jstree",function(b){c&&b.originalEvent&&b.originalEvent.changedTouches&&b.originalEvent.changedTouches[0]&&(Math.abs(e-b.originalEvent.changedTouches[0].clientX)>10||Math.abs(f-b.originalEvent.changedTouches[0].clientY)>10)&&(clearTimeout(c),a.vakata.context.hide())}).on("touchend.vakata.jstree",function(a){c&&clearTimeout(c)}),a(i).on("context_hide.vakata.jstree",a.proxy(function(b,c){this._data.contextmenu.visible=!1,a(c.reference).removeClass("jstree-context")},this))},this.teardown=function(){this._data.contextmenu.visible&&a.vakata.context.hide(),d.teardown.call(this)},this.show_contextmenu=function(c,d,e,f){if(c=this.get_node(c),!c||c.id===a.jstree.root)return!1;var g=this.settings.contextmenu,h=this.get_node(c,!0),i=h.children(".jstree-anchor"),j=!1,k=!1;(g.show_at_node||d===b||e===b)&&(j=i.offset(),d=j.left,e=j.top+this._data.core.li_height),this.settings.contextmenu.select_node&&!this.is_selected(c)&&this.activate_node(c,f),k=g.items,a.isFunction(k)&&(k=k.call(this,c,a.proxy(function(a){this._show_contextmenu(c,d,e,a)},this))),a.isPlainObject(k)&&this._show_contextmenu(c,d,e,k)},this._show_contextmenu=function(b,c,d,e){var f=this.get_node(b,!0),g=f.children(".jstree-anchor");a(i).one("context_show.vakata.jstree",a.proxy(function(b,c){var d="jstree-contextmenu jstree-"+this.get_theme()+"-contextmenu";a(c.element).addClass(d),g.addClass("jstree-context")},this)),this._data.contextmenu.visible=!0,a.vakata.context.show(g,{x:c,y:d},e),this.trigger("show_contextmenu",{node:b,x:c,y:d})}},function(a){var b=!1,c={element:!1,reference:!1,position_x:0,position_y:0,items:[],html:"",is_visible:!1};a.vakata.context={settings:{hide_onmouseleave:0,icons:!0},_trigger:function(b){a(i).triggerHandler("context_"+b+".vakata",{reference:c.reference,element:c.element,position:{x:c.position_x,y:c.position_y}})},_execute:function(b){return b=c.items[b],b&&(!b._disabled||a.isFunction(b._disabled)&&!b._disabled({item:b,reference:c.reference,element:c.element}))&&b.action?b.action.call(null,{item:b,reference:c.reference,element:c.element,position:{x:c.position_x,y:c.position_y}}):!1},_parse:function(b,d){if(!b)return!1;d||(c.html="",c.items=[]);var e="",f=!1,g;return d&&(e+="<ul>"),a.each(b,function(b,d){return d?(c.items.push(d),!f&&d.separator_before&&(e+="<li class='vakata-context-separator'><a href='#' "+(a.vakata.context.settings.icons?"":'style="margin-left:0px;"')+">&#160;</a></li>"),f=!1,e+="<li class='"+(d._class||"")+(d._disabled===!0||a.isFunction(d._disabled)&&d._disabled({item:d,reference:c.reference,element:c.element})?" vakata-contextmenu-disabled ":"")+"' "+(d.shortcut?" data-shortcut='"+d.shortcut+"' ":"")+">",e+="<a href='#' rel='"+(c.items.length-1)+"' "+(d.title?"title='"+d.title+"'":"")+">",a.vakata.context.settings.icons&&(e+="<i ",d.icon&&(e+=-1!==d.icon.indexOf("/")||-1!==d.icon.indexOf(".")?" style='background:url(\""+d.icon+"\") center center no-repeat' ":" class='"+d.icon+"' "),e+="></i><span class='vakata-contextmenu-sep'>&#160;</span>"),e+=(a.isFunction(d.label)?d.label({item:b,reference:c.reference,element:c.element}):d.label)+(d.shortcut?' <span class="vakata-contextmenu-shortcut vakata-contextmenu-shortcut-'+d.shortcut+'">'+(d.shortcut_label||"")+"</span>":"")+"</a>",
d.submenu&&(g=a.vakata.context._parse(d.submenu,!0),g&&(e+=g)),e+="</li>",void(d.separator_after&&(e+="<li class='vakata-context-separator'><a href='#' "+(a.vakata.context.settings.icons?"":'style="margin-left:0px;"')+">&#160;</a></li>",f=!0))):!0}),e=e.replace(/<li class\='vakata-context-separator'\><\/li\>$/,""),d&&(e+="</ul>"),d||(c.html=e,a.vakata.context._trigger("parse")),e.length>10?e:!1},_show_submenu:function(c){if(c=a(c),c.length&&c.children("ul").length){var d=c.children("ul"),e=c.offset().left,f=e+c.outerWidth(),g=c.offset().top,h=d.width(),i=d.height(),j=a(window).width()+a(window).scrollLeft(),k=a(window).height()+a(window).scrollTop();b?c[f-(h+10+c.outerWidth())<0?"addClass":"removeClass"]("vakata-context-left"):c[f+h>j&&e>j-f?"addClass":"removeClass"]("vakata-context-right"),g+i+10>k&&d.css("bottom","-1px"),c.hasClass("vakata-context-right")?h>e&&d.css("margin-right",e-h):h>j-f&&d.css("margin-left",j-f-h),d.show()}},show:function(d,e,f){var g,h,j,k,l,m,n,o,p=!0;switch(c.element&&c.element.length&&c.element.width(""),p){case!e&&!d:return!1;case!!e&&!!d:c.reference=d,c.position_x=e.x,c.position_y=e.y;break;case!e&&!!d:c.reference=d,g=d.offset(),c.position_x=g.left+d.outerHeight(),c.position_y=g.top;break;case!!e&&!d:c.position_x=e.x,c.position_y=e.y}d&&!f&&a(d).data("vakata_contextmenu")&&(f=a(d).data("vakata_contextmenu")),a.vakata.context._parse(f)&&c.element.html(c.html),c.items.length&&(c.element.appendTo(i.body),h=c.element,j=c.position_x,k=c.position_y,l=h.width(),m=h.height(),n=a(window).width()+a(window).scrollLeft(),o=a(window).height()+a(window).scrollTop(),b&&(j-=h.outerWidth()-a(d).outerWidth(),j<a(window).scrollLeft()+20&&(j=a(window).scrollLeft()+20)),j+l+20>n&&(j=n-(l+20)),k+m+20>o&&(k=o-(m+20)),c.element.css({left:j,top:k}).show().find("a").first().focus().parent().addClass("vakata-context-hover"),c.is_visible=!0,a.vakata.context._trigger("show"))},hide:function(){c.is_visible&&(c.element.hide().find("ul").hide().end().find(":focus").blur().end().detach(),c.is_visible=!1,a.vakata.context._trigger("hide"))}},a(function(){b="rtl"===a(i.body).css("direction");var d=!1;c.element=a("<ul class='vakata-context'></ul>"),c.element.on("mouseenter","li",function(b){b.stopImmediatePropagation(),a.contains(this,b.relatedTarget)||(d&&clearTimeout(d),c.element.find(".vakata-context-hover").removeClass("vakata-context-hover").end(),a(this).siblings().find("ul").hide().end().end().parentsUntil(".vakata-context","li").addBack().addClass("vakata-context-hover"),a.vakata.context._show_submenu(this))}).on("mouseleave","li",function(b){a.contains(this,b.relatedTarget)||a(this).find(".vakata-context-hover").addBack().removeClass("vakata-context-hover")}).on("mouseleave",function(b){a(this).find(".vakata-context-hover").removeClass("vakata-context-hover"),a.vakata.context.settings.hide_onmouseleave&&(d=setTimeout(function(b){return function(){a.vakata.context.hide()}}(this),a.vakata.context.settings.hide_onmouseleave))}).on("click","a",function(b){b.preventDefault(),a(this).blur().parent().hasClass("vakata-context-disabled")||a.vakata.context._execute(a(this).attr("rel"))===!1||a.vakata.context.hide()}).on("keydown","a",function(b){var d=null;switch(b.which){case 13:case 32:b.type="click",b.preventDefault(),a(b.currentTarget).trigger(b);break;case 37:c.is_visible&&(c.element.find(".vakata-context-hover").last().closest("li").first().find("ul").hide().find(".vakata-context-hover").removeClass("vakata-context-hover").end().end().children("a").focus(),b.stopImmediatePropagation(),b.preventDefault());break;case 38:c.is_visible&&(d=c.element.find("ul:visible").addBack().last().children(".vakata-context-hover").removeClass("vakata-context-hover").prevAll("li:not(.vakata-context-separator)").first(),d.length||(d=c.element.find("ul:visible").addBack().last().children("li:not(.vakata-context-separator)").last()),d.addClass("vakata-context-hover").children("a").focus(),b.stopImmediatePropagation(),b.preventDefault());break;case 39:c.is_visible&&(c.element.find(".vakata-context-hover").last().children("ul").show().children("li:not(.vakata-context-separator)").removeClass("vakata-context-hover").first().addClass("vakata-context-hover").children("a").focus(),b.stopImmediatePropagation(),b.preventDefault());break;case 40:c.is_visible&&(d=c.element.find("ul:visible").addBack().last().children(".vakata-context-hover").removeClass("vakata-context-hover").nextAll("li:not(.vakata-context-separator)").first(),d.length||(d=c.element.find("ul:visible").addBack().last().children("li:not(.vakata-context-separator)").first()),d.addClass("vakata-context-hover").children("a").focus(),b.stopImmediatePropagation(),b.preventDefault());break;case 27:a.vakata.context.hide(),b.preventDefault()}}).on("keydown",function(a){a.preventDefault();var b=c.element.find(".vakata-contextmenu-shortcut-"+a.which).parent();b.parent().not(".vakata-context-disabled")&&b.click()}),a(i).on("mousedown.vakata.jstree",function(b){c.is_visible&&c.element[0]!==b.target&&!a.contains(c.element[0],b.target)&&a.vakata.context.hide()}).on("context_show.vakata.jstree",function(a,d){c.element.find("li:has(ul)").children("a").addClass("vakata-context-parent"),b&&c.element.addClass("vakata-context-rtl").css("direction","rtl"),c.element.find("ul").hide().end()})})}(a),a.jstree.defaults.dnd={copy:!0,open_timeout:500,is_draggable:!0,check_while_dragging:!0,always_copy:!1,inside_pos:0,drag_selection:!0,touch:!0,large_drop_target:!1,large_drag_target:!1,use_html5:!1};var k,l;a.jstree.plugins.dnd=function(b,c){this.init=function(a,b){c.init.call(this,a,b),this.settings.dnd.use_html5=this.settings.dnd.use_html5&&"draggable"in i.createElement("span")},this.bind=function(){c.bind.call(this),this.element.on(this.settings.dnd.use_html5?"dragstart.jstree":"mousedown.jstree touchstart.jstree",this.settings.dnd.large_drag_target?".jstree-node":".jstree-anchor",a.proxy(function(b){if(this.settings.dnd.large_drag_target&&a(b.target).closest(".jstree-node")[0]!==b.currentTarget)return!0;if("touchstart"===b.type&&(!this.settings.dnd.touch||"selected"===this.settings.dnd.touch&&!a(b.currentTarget).closest(".jstree-node").children(".jstree-anchor").hasClass("jstree-clicked")))return!0;var c=this.get_node(b.target),d=this.is_selected(c)&&this.settings.dnd.drag_selection?this.get_top_selected().length:1,e=d>1?d+" "+this.get_string("nodes"):this.get_text(b.currentTarget);if(this.settings.core.force_text&&(e=a.vakata.html.escape(e)),c&&c.id&&c.id!==a.jstree.root&&(1===b.which||"touchstart"===b.type||"dragstart"===b.type)&&(this.settings.dnd.is_draggable===!0||a.isFunction(this.settings.dnd.is_draggable)&&this.settings.dnd.is_draggable.call(this,d>1?this.get_top_selected(!0):[c],b))){if(k={jstree:!0,origin:this,obj:this.get_node(c,!0),nodes:d>1?this.get_top_selected():[c.id]},l=b.currentTarget,!this.settings.dnd.use_html5)return this.element.trigger("mousedown.jstree"),a.vakata.dnd.start(b,k,'<div id="jstree-dnd" class="jstree-'+this.get_theme()+" jstree-"+this.get_theme()+"-"+this.get_theme_variant()+" "+(this.settings.core.themes.responsive?" jstree-dnd-responsive":"")+'"><i class="jstree-icon jstree-er"></i>'+e+'<ins class="jstree-copy" style="display:none;">+</ins></div>');a.vakata.dnd._trigger("start",b,{helper:a(),element:l,data:k})}},this)),this.settings.dnd.use_html5&&this.element.on("dragover.jstree",function(b){return b.preventDefault(),a.vakata.dnd._trigger("move",b,{helper:a(),element:l,data:k}),!1}).on("drop.jstree",a.proxy(function(b){return b.preventDefault(),a.vakata.dnd._trigger("stop",b,{helper:a(),element:l,data:k}),!1},this))},this.redraw_node=function(a,b,d,e){if(a=c.redraw_node.apply(this,arguments),a&&this.settings.dnd.use_html5)if(this.settings.dnd.large_drag_target)a.setAttribute("draggable",!0);else{var f,g,h=null;for(f=0,g=a.childNodes.length;g>f;f++)if(a.childNodes[f]&&a.childNodes[f].className&&-1!==a.childNodes[f].className.indexOf("jstree-anchor")){h=a.childNodes[f];break}h&&h.setAttribute("draggable",!0)}return a}},a(function(){var c=!1,d=!1,e=!1,f=!1,g=a('<div id="jstree-marker">&#160;</div>').hide();a(i).on("dragover.vakata.jstree",function(b){l&&a.vakata.dnd._trigger("move",b,{helper:a(),element:l,data:k})}).on("drop.vakata.jstree",function(b){l&&(a.vakata.dnd._trigger("stop",b,{helper:a(),element:l,data:k}),l=null,k=null)}).on("dnd_start.vakata.jstree",function(a,b){c=!1,e=!1,b&&b.data&&b.data.jstree&&g.appendTo(i.body)}).on("dnd_move.vakata.jstree",function(h,i){var j=i.event.target!==e.target;if(f&&(!i.event||"dragover"!==i.event.type||j)&&clearTimeout(f),i&&i.data&&i.data.jstree&&(!i.event.target.id||"jstree-marker"!==i.event.target.id)){e=i.event;var k=a.jstree.reference(i.event.target),l=!1,m=!1,n=!1,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E;if(k&&k._data&&k._data.dnd)if(g.attr("class","jstree-"+k.get_theme()+(k.settings.core.themes.responsive?" jstree-dnd-responsive":"")),D=i.data.origin&&(i.data.origin.settings.dnd.always_copy||i.data.origin.settings.dnd.copy&&(i.event.metaKey||i.event.ctrlKey)),i.helper.children().attr("class","jstree-"+k.get_theme()+" jstree-"+k.get_theme()+"-"+k.get_theme_variant()+" "+(k.settings.core.themes.responsive?" jstree-dnd-responsive":"")).find(".jstree-copy").first()[D?"show":"hide"](),i.event.target!==k.element[0]&&i.event.target!==k.get_container_ul()[0]||0!==k.get_container_ul().children().length){if(l=k.settings.dnd.large_drop_target?a(i.event.target).closest(".jstree-node").children(".jstree-anchor"):a(i.event.target).closest(".jstree-anchor"),l&&l.length&&l.parent().is(".jstree-closed, .jstree-open, .jstree-leaf")&&(m=l.offset(),n=(i.event.pageY!==b?i.event.pageY:i.event.originalEvent.pageY)-m.top,r=l.outerHeight(),u=r/3>n?["b","i","a"]:n>r-r/3?["a","i","b"]:n>r/2?["i","a","b"]:["i","b","a"],a.each(u,function(b,e){switch(e){case"b":p=m.left-6,q=m.top,s=k.get_parent(l),t=l.parent().index();break;case"i":B=k.settings.dnd.inside_pos,C=k.get_node(l.parent()),p=m.left-2,q=m.top+r/2+1,s=C.id,t="first"===B?0:"last"===B?C.children.length:Math.min(B,C.children.length);break;case"a":p=m.left-6,q=m.top+r,s=k.get_parent(l),t=l.parent().index()+1}for(v=!0,w=0,x=i.data.nodes.length;x>w;w++)if(y=i.data.origin&&(i.data.origin.settings.dnd.always_copy||i.data.origin.settings.dnd.copy&&(i.event.metaKey||i.event.ctrlKey))?"copy_node":"move_node",z=t,"move_node"===y&&"a"===e&&i.data.origin&&i.data.origin===k&&s===k.get_parent(i.data.nodes[w])&&(A=k.get_node(s),z>a.inArray(i.data.nodes[w],A.children)&&(z-=1)),v=v&&(k&&k.settings&&k.settings.dnd&&k.settings.dnd.check_while_dragging===!1||k.check(y,i.data.origin&&i.data.origin!==k?i.data.origin.get_node(i.data.nodes[w]):i.data.nodes[w],s,z,{dnd:!0,ref:k.get_node(l.parent()),pos:e,origin:i.data.origin,is_multi:i.data.origin&&i.data.origin!==k,is_foreign:!i.data.origin})),!v){k&&k.last_error&&(d=k.last_error());break}return"i"===e&&l.parent().is(".jstree-closed")&&k.settings.dnd.open_timeout&&(!i.event||"dragover"!==i.event.type||j)&&(f&&clearTimeout(f),f=setTimeout(function(a,b){return function(){a.open_node(b)}}(k,l),k.settings.dnd.open_timeout)),v?(E=k.get_node(s,!0),E.hasClass(".jstree-dnd-parent")||(a(".jstree-dnd-parent").removeClass("jstree-dnd-parent"),E.addClass("jstree-dnd-parent")),c={ins:k,par:s,pos:"i"!==e||"last"!==B||0!==t||k.is_loaded(C)?t:"last"},g.css({left:p+"px",top:q+"px"}).show(),i.helper.find(".jstree-icon").first().removeClass("jstree-er").addClass("jstree-ok"),i.event.originalEvent&&i.event.originalEvent.dataTransfer&&(i.event.originalEvent.dataTransfer.dropEffect=D?"copy":"move"),d={},u=!0,!1):void 0}),u===!0))return}else{for(v=!0,w=0,x=i.data.nodes.length;x>w;w++)if(v=v&&k.check(i.data.origin&&(i.data.origin.settings.dnd.always_copy||i.data.origin.settings.dnd.copy&&(i.event.metaKey||i.event.ctrlKey))?"copy_node":"move_node",i.data.origin&&i.data.origin!==k?i.data.origin.get_node(i.data.nodes[w]):i.data.nodes[w],a.jstree.root,"last",{dnd:!0,ref:k.get_node(a.jstree.root),pos:"i",origin:i.data.origin,is_multi:i.data.origin&&i.data.origin!==k,is_foreign:!i.data.origin}),!v)break;if(v)return c={ins:k,par:a.jstree.root,pos:"last"},g.hide(),i.helper.find(".jstree-icon").first().removeClass("jstree-er").addClass("jstree-ok"),void(i.event.originalEvent&&i.event.originalEvent.dataTransfer&&(i.event.originalEvent.dataTransfer.dropEffect=D?"copy":"move"))}a(".jstree-dnd-parent").removeClass("jstree-dnd-parent"),c=!1,i.helper.find(".jstree-icon").removeClass("jstree-ok").addClass("jstree-er"),i.event.originalEvent&&i.event.originalEvent.dataTransfer,g.hide()}}).on("dnd_scroll.vakata.jstree",function(a,b){b&&b.data&&b.data.jstree&&(g.hide(),c=!1,e=!1,b.helper.find(".jstree-icon").first().removeClass("jstree-ok").addClass("jstree-er"))}).on("dnd_stop.vakata.jstree",function(b,h){if(a(".jstree-dnd-parent").removeClass("jstree-dnd-parent"),f&&clearTimeout(f),h&&h.data&&h.data.jstree){g.hide().detach();var i,j,k=[];if(c){for(i=0,j=h.data.nodes.length;j>i;i++)k[i]=h.data.origin?h.data.origin.get_node(h.data.nodes[i]):h.data.nodes[i];c.ins[h.data.origin&&(h.data.origin.settings.dnd.always_copy||h.data.origin.settings.dnd.copy&&(h.event.metaKey||h.event.ctrlKey))?"copy_node":"move_node"](k,c.par,c.pos,!1,!1,!1,h.data.origin)}else i=a(h.event.target).closest(".jstree"),i.length&&d&&d.error&&"check"===d.error&&(i=i.jstree(!0),i&&i.settings.core.error.call(this,d));e=!1,c=!1}}).on("keyup.jstree keydown.jstree",function(b,h){h=a.vakata.dnd._get(),h&&h.data&&h.data.jstree&&("keyup"===b.type&&27===b.which?(f&&clearTimeout(f),c=!1,d=!1,e=!1,f=!1,g.hide().detach(),a.vakata.dnd._clean()):(h.helper.find(".jstree-copy").first()[h.data.origin&&(h.data.origin.settings.dnd.always_copy||h.data.origin.settings.dnd.copy&&(b.metaKey||b.ctrlKey))?"show":"hide"](),e&&(e.metaKey=b.metaKey,e.ctrlKey=b.ctrlKey,a.vakata.dnd._trigger("move",e))))})}),function(a){a.vakata.html={div:a("<div />"),escape:function(b){return a.vakata.html.div.text(b).html()},strip:function(b){return a.vakata.html.div.empty().append(a.parseHTML(b)).text()}};var c={element:!1,target:!1,is_down:!1,is_drag:!1,helper:!1,helper_w:0,data:!1,init_x:0,init_y:0,scroll_l:0,scroll_t:0,scroll_e:!1,scroll_i:!1,is_touch:!1};a.vakata.dnd={settings:{scroll_speed:10,scroll_proximity:20,helper_left:5,helper_top:10,threshold:5,threshold_touch:10},_trigger:function(c,d,e){e===b&&(e=a.vakata.dnd._get()),e.event=d,a(i).triggerHandler("dnd_"+c+".vakata",e)},_get:function(){return{data:c.data,element:c.element,helper:c.helper}},_clean:function(){c.helper&&c.helper.remove(),c.scroll_i&&(clearInterval(c.scroll_i),c.scroll_i=!1),c={element:!1,target:!1,is_down:!1,is_drag:!1,helper:!1,helper_w:0,data:!1,init_x:0,init_y:0,scroll_l:0,scroll_t:0,scroll_e:!1,scroll_i:!1,is_touch:!1},a(i).off("mousemove.vakata.jstree touchmove.vakata.jstree",a.vakata.dnd.drag),a(i).off("mouseup.vakata.jstree touchend.vakata.jstree",a.vakata.dnd.stop)},_scroll:function(b){if(!c.scroll_e||!c.scroll_l&&!c.scroll_t)return c.scroll_i&&(clearInterval(c.scroll_i),c.scroll_i=!1),!1;if(!c.scroll_i)return c.scroll_i=setInterval(a.vakata.dnd._scroll,100),!1;if(b===!0)return!1;var d=c.scroll_e.scrollTop(),e=c.scroll_e.scrollLeft();c.scroll_e.scrollTop(d+c.scroll_t*a.vakata.dnd.settings.scroll_speed),c.scroll_e.scrollLeft(e+c.scroll_l*a.vakata.dnd.settings.scroll_speed),(d!==c.scroll_e.scrollTop()||e!==c.scroll_e.scrollLeft())&&a.vakata.dnd._trigger("scroll",c.scroll_e)},start:function(b,d,e){"touchstart"===b.type&&b.originalEvent&&b.originalEvent.changedTouches&&b.originalEvent.changedTouches[0]&&(b.pageX=b.originalEvent.changedTouches[0].pageX,b.pageY=b.originalEvent.changedTouches[0].pageY,b.target=i.elementFromPoint(b.originalEvent.changedTouches[0].pageX-window.pageXOffset,b.originalEvent.changedTouches[0].pageY-window.pageYOffset)),c.is_drag&&a.vakata.dnd.stop({});try{b.currentTarget.unselectable="on",b.currentTarget.onselectstart=function(){return!1},b.currentTarget.style&&(b.currentTarget.style.touchAction="none",b.currentTarget.style.msTouchAction="none",b.currentTarget.style.MozUserSelect="none")}catch(f){}return c.init_x=b.pageX,c.init_y=b.pageY,c.data=d,c.is_down=!0,c.element=b.currentTarget,c.target=b.target,c.is_touch="touchstart"===b.type,e!==!1&&(c.helper=a("<div id='vakata-dnd'></div>").html(e).css({display:"block",margin:"0",padding:"0",position:"absolute",top:"-2000px",lineHeight:"16px",zIndex:"10000"})),a(i).on("mousemove.vakata.jstree touchmove.vakata.jstree",a.vakata.dnd.drag),a(i).on("mouseup.vakata.jstree touchend.vakata.jstree",a.vakata.dnd.stop),!1},drag:function(b){if("touchmove"===b.type&&b.originalEvent&&b.originalEvent.changedTouches&&b.originalEvent.changedTouches[0]&&(b.pageX=b.originalEvent.changedTouches[0].pageX,b.pageY=b.originalEvent.changedTouches[0].pageY,b.target=i.elementFromPoint(b.originalEvent.changedTouches[0].pageX-window.pageXOffset,b.originalEvent.changedTouches[0].pageY-window.pageYOffset)),c.is_down){if(!c.is_drag){if(!(Math.abs(b.pageX-c.init_x)>(c.is_touch?a.vakata.dnd.settings.threshold_touch:a.vakata.dnd.settings.threshold)||Math.abs(b.pageY-c.init_y)>(c.is_touch?a.vakata.dnd.settings.threshold_touch:a.vakata.dnd.settings.threshold)))return;c.helper&&(c.helper.appendTo(i.body),c.helper_w=c.helper.outerWidth()),c.is_drag=!0,a(c.target).one("click.vakata",!1),a.vakata.dnd._trigger("start",b)}var d=!1,e=!1,f=!1,g=!1,h=!1,j=!1,k=!1,l=!1,m=!1,n=!1;return c.scroll_t=0,c.scroll_l=0,c.scroll_e=!1,a(a(b.target).parentsUntil("body").addBack().get().reverse()).filter(function(){return/^auto|scroll$/.test(a(this).css("overflow"))&&(this.scrollHeight>this.offsetHeight||this.scrollWidth>this.offsetWidth)}).each(function(){var d=a(this),e=d.offset();return this.scrollHeight>this.offsetHeight&&(e.top+d.height()-b.pageY<a.vakata.dnd.settings.scroll_proximity&&(c.scroll_t=1),b.pageY-e.top<a.vakata.dnd.settings.scroll_proximity&&(c.scroll_t=-1)),this.scrollWidth>this.offsetWidth&&(e.left+d.width()-b.pageX<a.vakata.dnd.settings.scroll_proximity&&(c.scroll_l=1),b.pageX-e.left<a.vakata.dnd.settings.scroll_proximity&&(c.scroll_l=-1)),c.scroll_t||c.scroll_l?(c.scroll_e=a(this),!1):void 0}),c.scroll_e||(d=a(i),e=a(window),f=d.height(),g=e.height(),h=d.width(),j=e.width(),k=d.scrollTop(),l=d.scrollLeft(),f>g&&b.pageY-k<a.vakata.dnd.settings.scroll_proximity&&(c.scroll_t=-1),f>g&&g-(b.pageY-k)<a.vakata.dnd.settings.scroll_proximity&&(c.scroll_t=1),h>j&&b.pageX-l<a.vakata.dnd.settings.scroll_proximity&&(c.scroll_l=-1),h>j&&j-(b.pageX-l)<a.vakata.dnd.settings.scroll_proximity&&(c.scroll_l=1),(c.scroll_t||c.scroll_l)&&(c.scroll_e=d)),c.scroll_e&&a.vakata.dnd._scroll(!0),c.helper&&(m=parseInt(b.pageY+a.vakata.dnd.settings.helper_top,10),n=parseInt(b.pageX+a.vakata.dnd.settings.helper_left,10),f&&m+25>f&&(m=f-50),h&&n+c.helper_w>h&&(n=h-(c.helper_w+2)),c.helper.css({left:n+"px",top:m+"px"})),a.vakata.dnd._trigger("move",b),!1}},stop:function(b){if("touchend"===b.type&&b.originalEvent&&b.originalEvent.changedTouches&&b.originalEvent.changedTouches[0]&&(b.pageX=b.originalEvent.changedTouches[0].pageX,b.pageY=b.originalEvent.changedTouches[0].pageY,b.target=i.elementFromPoint(b.originalEvent.changedTouches[0].pageX-window.pageXOffset,b.originalEvent.changedTouches[0].pageY-window.pageYOffset)),c.is_drag)b.target!==c.target&&a(c.target).off("click.vakata"),a.vakata.dnd._trigger("stop",b);else if("touchend"===b.type&&b.target===c.target){var d=setTimeout(function(){a(b.target).click()},100);a(b.target).one("click",function(){d&&clearTimeout(d)})}return a.vakata.dnd._clean(),!1}}}(a),a.jstree.defaults.massload=null,a.jstree.plugins.massload=function(b,c){this.init=function(a,b){this._data.massload={},c.init.call(this,a,b)},this._load_nodes=function(b,d,e,f){var g=this.settings.massload,h=JSON.stringify(b),i=[],j=this._model.data,k,l,m;if(!e){for(k=0,l=b.length;l>k;k++)(!j[b[k]]||!j[b[k]].state.loaded&&!j[b[k]].state.failed||f)&&(i.push(b[k]),m=this.get_node(b[k],!0),m&&m.length&&m.addClass("jstree-loading").attr("aria-busy",!0));if(this._data.massload={},i.length){if(a.isFunction(g))return g.call(this,i,a.proxy(function(a){var g,h;if(a)for(g in a)a.hasOwnProperty(g)&&(this._data.massload[g]=a[g]);for(g=0,h=b.length;h>g;g++)m=this.get_node(b[g],!0),m&&m.length&&m.removeClass("jstree-loading").attr("aria-busy",!1);c._load_nodes.call(this,b,d,e,f)},this));if("object"==typeof g&&g&&g.url)return g=a.extend(!0,{},g),a.isFunction(g.url)&&(g.url=g.url.call(this,i)),a.isFunction(g.data)&&(g.data=g.data.call(this,i)),a.ajax(g).done(a.proxy(function(a,g,h){var i,j;if(a)for(i in a)a.hasOwnProperty(i)&&(this._data.massload[i]=a[i]);for(i=0,j=b.length;j>i;i++)m=this.get_node(b[i],!0),m&&m.length&&m.removeClass("jstree-loading").attr("aria-busy",!1);c._load_nodes.call(this,b,d,e,f)},this)).fail(a.proxy(function(a){c._load_nodes.call(this,b,d,e,f)},this))}}return c._load_nodes.call(this,b,d,e,f)},this._load_node=function(b,d){var e=this._data.massload[b.id],f=null,g;return e?(f=this["string"==typeof e?"_append_html_data":"_append_json_data"](b,"string"==typeof e?a(a.parseHTML(e)).filter(function(){return 3!==this.nodeType}):e,function(a){d.call(this,a)}),g=this.get_node(b.id,!0),g&&g.length&&g.removeClass("jstree-loading").attr("aria-busy",!1),delete this._data.massload[b.id],f):c._load_node.call(this,b,d)}},a.jstree.defaults.search={ajax:!1,fuzzy:!1,case_sensitive:!1,show_only_matches:!1,show_only_matches_children:!1,close_opened_onclear:!0,search_leaves_only:!1,search_callback:!1},a.jstree.plugins.search=function(c,d){this.bind=function(){d.bind.call(this),this._data.search.str="",this._data.search.dom=a(),this._data.search.res=[],this._data.search.opn=[],this._data.search.som=!1,this._data.search.smc=!1,this._data.search.hdn=[],this.element.on("search.jstree",a.proxy(function(b,c){if(this._data.search.som&&c.res.length){var d=this._model.data,e,f,g=[],h,i;for(e=0,f=c.res.length;f>e;e++)if(d[c.res[e]]&&!d[c.res[e]].state.hidden&&(g.push(c.res[e]),g=g.concat(d[c.res[e]].parents),this._data.search.smc))for(h=0,i=d[c.res[e]].children_d.length;i>h;h++)d[d[c.res[e]].children_d[h]]&&!d[d[c.res[e]].children_d[h]].state.hidden&&g.push(d[c.res[e]].children_d[h]);g=a.vakata.array_remove_item(a.vakata.array_unique(g),a.jstree.root),this._data.search.hdn=this.hide_all(!0),this.show_node(g,!0),this.redraw(!0)}},this)).on("clear_search.jstree",a.proxy(function(a,b){this._data.search.som&&b.res.length&&(this.show_node(this._data.search.hdn,!0),this.redraw(!0))},this))},this.search=function(c,d,e,f,g,h){if(c===!1||""===a.trim(c.toString()))return this.clear_search();f=this.get_node(f),f=f&&f.id?f.id:null,c=c.toString();var i=this.settings.search,j=i.ajax?i.ajax:!1,k=this._model.data,l=null,m=[],n=[],o,p;if(this._data.search.res.length&&!g&&this.clear_search(),e===b&&(e=i.show_only_matches),h===b&&(h=i.show_only_matches_children),!d&&j!==!1)return a.isFunction(j)?j.call(this,c,a.proxy(function(b){b&&b.d&&(b=b.d),this._load_nodes(a.isArray(b)?a.vakata.array_unique(b):[],function(){this.search(c,!0,e,f,g,h)})},this),f):(j=a.extend({},j),j.data||(j.data={}),j.data.str=c,f&&(j.data.inside=f),this._data.search.lastRequest&&this._data.search.lastRequest.abort(),this._data.search.lastRequest=a.ajax(j).fail(a.proxy(function(){this._data.core.last_error={error:"ajax",plugin:"search",id:"search_01",reason:"Could not load search parents",data:JSON.stringify(j)},this.settings.core.error.call(this,this._data.core.last_error)},this)).done(a.proxy(function(b){b&&b.d&&(b=b.d),this._load_nodes(a.isArray(b)?a.vakata.array_unique(b):[],function(){this.search(c,!0,e,f,g,h)})},this)),this._data.search.lastRequest);if(g||(this._data.search.str=c,this._data.search.dom=a(),this._data.search.res=[],this._data.search.opn=[],this._data.search.som=e,this._data.search.smc=h),l=new a.vakata.search(c,!0,{caseSensitive:i.case_sensitive,fuzzy:i.fuzzy}),a.each(k[f?f:a.jstree.root].children_d,function(a,b){var d=k[b];d.text&&!d.state.hidden&&(!i.search_leaves_only||d.state.loaded&&0===d.children.length)&&(i.search_callback&&i.search_callback.call(this,c,d)||!i.search_callback&&l.search(d.text).isMatch)&&(m.push(b),n=n.concat(d.parents))}),m.length){for(n=a.vakata.array_unique(n),o=0,p=n.length;p>o;o++)n[o]!==a.jstree.root&&k[n[o]]&&this.open_node(n[o],null,0)===!0&&this._data.search.opn.push(n[o]);g?(this._data.search.dom=this._data.search.dom.add(a(this.element[0].querySelectorAll("#"+a.map(m,function(b){return-1!=="0123456789".indexOf(b[0])?"\\3"+b[0]+" "+b.substr(1).replace(a.jstree.idregex,"\\$&"):b.replace(a.jstree.idregex,"\\$&")}).join(", #")))),this._data.search.res=a.vakata.array_unique(this._data.search.res.concat(m))):(this._data.search.dom=a(this.element[0].querySelectorAll("#"+a.map(m,function(b){return-1!=="0123456789".indexOf(b[0])?"\\3"+b[0]+" "+b.substr(1).replace(a.jstree.idregex,"\\$&"):b.replace(a.jstree.idregex,"\\$&")}).join(", #"))),this._data.search.res=m),this._data.search.dom.children(".jstree-anchor").addClass("jstree-search")}this.trigger("search",{nodes:this._data.search.dom,str:c,res:this._data.search.res,show_only_matches:e})},this.clear_search=function(){this.settings.search.close_opened_onclear&&this.close_node(this._data.search.opn,0),this.trigger("clear_search",{nodes:this._data.search.dom,str:this._data.search.str,res:this._data.search.res}),this._data.search.res.length&&(this._data.search.dom=a(this.element[0].querySelectorAll("#"+a.map(this._data.search.res,function(b){return-1!=="0123456789".indexOf(b[0])?"\\3"+b[0]+" "+b.substr(1).replace(a.jstree.idregex,"\\$&"):b.replace(a.jstree.idregex,"\\$&")}).join(", #"))),this._data.search.dom.children(".jstree-anchor").removeClass("jstree-search")),this._data.search.str="",this._data.search.res=[],this._data.search.opn=[],this._data.search.dom=a()},this.redraw_node=function(b,c,e,f){if(b=d.redraw_node.apply(this,arguments),b&&-1!==a.inArray(b.id,this._data.search.res)){var g,h,i=null;for(g=0,h=b.childNodes.length;h>g;g++)if(b.childNodes[g]&&b.childNodes[g].className&&-1!==b.childNodes[g].className.indexOf("jstree-anchor")){i=b.childNodes[g];break}i&&(i.className+=" jstree-search")}return b}},function(a){a.vakata.search=function(b,c,d){d=d||{},d=a.extend({},a.vakata.search.defaults,d),d.fuzzy!==!1&&(d.fuzzy=!0),b=d.caseSensitive?b:b.toLowerCase();var e=d.location,f=d.distance,g=d.threshold,h=b.length,i,j,k,l;return h>32&&(d.fuzzy=!1),d.fuzzy&&(i=1<<h-1,j=function(){var a={},c=0;for(c=0;h>c;c++)a[b.charAt(c)]=0;for(c=0;h>c;c++)a[b.charAt(c)]|=1<<h-c-1;return a}(),k=function(a,b){var c=a/h,d=Math.abs(e-b);return f?c+d/f:d?1:c}),l=function(a){if(a=d.caseSensitive?a:a.toLowerCase(),b===a||-1!==a.indexOf(b))return{isMatch:!0,score:0};if(!d.fuzzy)return{isMatch:!1,score:1};var c,f,l=a.length,m=g,n=a.indexOf(b,e),o,p,q=h+l,r,s,t,u,v,w=1,x=[];for(-1!==n&&(m=Math.min(k(0,n),m),n=a.lastIndexOf(b,e+h),-1!==n&&(m=Math.min(k(0,n),m))),n=-1,c=0;h>c;c++){o=0,p=q;while(p>o)k(c,e+p)<=m?o=p:q=p,p=Math.floor((q-o)/2+o);for(q=p,s=Math.max(1,e-p+1),t=Math.min(e+p,l)+h,u=new Array(t+2),u[t+1]=(1<<c)-1,f=t;f>=s;f--)if(v=j[a.charAt(f-1)],0===c?u[f]=(u[f+1]<<1|1)&v:u[f]=(u[f+1]<<1|1)&v|((r[f+1]|r[f])<<1|1)|r[f+1],u[f]&i&&(w=k(c,f-1),m>=w)){if(m=w,n=f-1,x.push(n),!(n>e))break;s=Math.max(1,2*e-n)}if(k(c+1,e)>m)break;r=u}return{isMatch:n>=0,score:w}},c===!0?{search:l}:l(c)},a.vakata.search.defaults={location:0,distance:100,threshold:.6,fuzzy:!1,caseSensitive:!1}}(a),a.jstree.defaults.sort=function(a,b){return this.get_text(a)>this.get_text(b)?1:-1},a.jstree.plugins.sort=function(b,c){this.bind=function(){c.bind.call(this),this.element.on("model.jstree",a.proxy(function(a,b){this.sort(b.parent,!0)},this)).on("rename_node.jstree create_node.jstree",a.proxy(function(a,b){this.sort(b.parent||b.node.parent,!1),this.redraw_node(b.parent||b.node.parent,!0)},this)).on("move_node.jstree copy_node.jstree",a.proxy(function(a,b){this.sort(b.parent,!1),this.redraw_node(b.parent,!0)},this))},this.sort=function(b,c){var d,e;if(b=this.get_node(b),b&&b.children&&b.children.length&&(b.children.sort(a.proxy(this.settings.sort,this)),c))for(d=0,e=b.children_d.length;e>d;d++)this.sort(b.children_d[d],!1)}};var m=!1;a.jstree.defaults.state={key:"jstree",events:"changed.jstree open_node.jstree close_node.jstree check_node.jstree uncheck_node.jstree",ttl:!1,filter:!1,preserve_loaded:!1},a.jstree.plugins.state=function(b,c){this.bind=function(){c.bind.call(this);var b=a.proxy(function(){this.element.on(this.settings.state.events,a.proxy(function(){m&&clearTimeout(m),m=setTimeout(a.proxy(function(){this.save_state()},this),100)},this)),this.trigger("state_ready")},this);this.element.on("ready.jstree",a.proxy(function(a,c){this.element.one("restore_state.jstree",b),this.restore_state()||b()},this))},this.save_state=function(){var b=this.get_state();this.settings.state.preserve_loaded||delete b.core.loaded;var c={state:b,ttl:this.settings.state.ttl,sec:+new Date};a.vakata.storage.set(this.settings.state.key,JSON.stringify(c))},this.restore_state=function(){var b=a.vakata.storage.get(this.settings.state.key);if(b)try{b=JSON.parse(b)}catch(c){return!1}return b&&b.ttl&&b.sec&&+new Date-b.sec>b.ttl?!1:(b&&b.state&&(b=b.state),b&&a.isFunction(this.settings.state.filter)&&(b=this.settings.state.filter.call(this,b)),b?(this.settings.state.preserve_loaded||delete b.core.loaded,this.element.one("set_state.jstree",function(c,d){d.instance.trigger("restore_state",{state:a.extend(!0,{},b)})}),this.set_state(b),!0):!1)},this.clear_state=function(){return a.vakata.storage.del(this.settings.state.key)}},function(a,b){a.vakata.storage={set:function(a,b){return window.localStorage.setItem(a,b)},get:function(a){return window.localStorage.getItem(a)},del:function(a){return window.localStorage.removeItem(a)}}}(a),a.jstree.defaults.types={"default":{}},a.jstree.defaults.types[a.jstree.root]={},a.jstree.plugins.types=function(c,d){this.init=function(c,e){var f,g;if(e&&e.types&&e.types["default"])for(f in e.types)if("default"!==f&&f!==a.jstree.root&&e.types.hasOwnProperty(f))for(g in e.types["default"])e.types["default"].hasOwnProperty(g)&&e.types[f][g]===b&&(e.types[f][g]=e.types["default"][g]);d.init.call(this,c,e),this._model.data[a.jstree.root].type=a.jstree.root},this.refresh=function(b,c){d.refresh.call(this,b,c),this._model.data[a.jstree.root].type=a.jstree.root},this.bind=function(){this.element.on("model.jstree",a.proxy(function(c,d){var e=this._model.data,f=d.nodes,g=this.settings.types,h,i,j="default",k;for(h=0,i=f.length;i>h;h++){if(j="default",e[f[h]].original&&e[f[h]].original.type&&g[e[f[h]].original.type]&&(j=e[f[h]].original.type),e[f[h]].data&&e[f[h]].data.jstree&&e[f[h]].data.jstree.type&&g[e[f[h]].data.jstree.type]&&(j=e[f[h]].data.jstree.type),e[f[h]].type=j,e[f[h]].icon===!0&&g[j].icon!==b&&(e[f[h]].icon=g[j].icon),g[j].li_attr!==b&&"object"==typeof g[j].li_attr)for(k in g[j].li_attr)if(g[j].li_attr.hasOwnProperty(k)){if("id"===k)continue;e[f[h]].li_attr[k]===b?e[f[h]].li_attr[k]=g[j].li_attr[k]:"class"===k&&(e[f[h]].li_attr["class"]=g[j].li_attr["class"]+" "+e[f[h]].li_attr["class"])}if(g[j].a_attr!==b&&"object"==typeof g[j].a_attr)for(k in g[j].a_attr)if(g[j].a_attr.hasOwnProperty(k)){if("id"===k)continue;e[f[h]].a_attr[k]===b?e[f[h]].a_attr[k]=g[j].a_attr[k]:"href"===k&&"#"===e[f[h]].a_attr[k]?e[f[h]].a_attr.href=g[j].a_attr.href:"class"===k&&(e[f[h]].a_attr["class"]=g[j].a_attr["class"]+" "+e[f[h]].a_attr["class"])}}e[a.jstree.root].type=a.jstree.root},this)),d.bind.call(this)},this.get_json=function(b,c,e){var f,g,h=this._model.data,i=c?a.extend(!0,{},c,{no_id:!1}):{},j=d.get_json.call(this,b,i,e);if(j===!1)return!1;if(a.isArray(j))for(f=0,g=j.length;g>f;f++)j[f].type=j[f].id&&h[j[f].id]&&h[j[f].id].type?h[j[f].id].type:"default",c&&c.no_id&&(delete j[f].id,j[f].li_attr&&j[f].li_attr.id&&delete j[f].li_attr.id,j[f].a_attr&&j[f].a_attr.id&&delete j[f].a_attr.id);else j.type=j.id&&h[j.id]&&h[j.id].type?h[j.id].type:"default",c&&c.no_id&&(j=this._delete_ids(j));return j},this._delete_ids=function(b){if(a.isArray(b)){for(var c=0,d=b.length;d>c;c++)b[c]=this._delete_ids(b[c]);return b}return delete b.id,
b.li_attr&&b.li_attr.id&&delete b.li_attr.id,b.a_attr&&b.a_attr.id&&delete b.a_attr.id,b.children&&a.isArray(b.children)&&(b.children=this._delete_ids(b.children)),b},this.check=function(c,e,f,g,h){if(d.check.call(this,c,e,f,g,h)===!1)return!1;e=e&&e.id?e:this.get_node(e),f=f&&f.id?f:this.get_node(f);var i=e&&e.id?h&&h.origin?h.origin:a.jstree.reference(e.id):null,j,k,l,m;switch(i=i&&i._model&&i._model.data?i._model.data:null,c){case"create_node":case"move_node":case"copy_node":if("move_node"!==c||-1===a.inArray(e.id,f.children)){if(j=this.get_rules(f),j.max_children!==b&&-1!==j.max_children&&j.max_children===f.children.length)return this._data.core.last_error={error:"check",plugin:"types",id:"types_01",reason:"max_children prevents function: "+c,data:JSON.stringify({chk:c,pos:g,obj:e&&e.id?e.id:!1,par:f&&f.id?f.id:!1})},!1;if(j.valid_children!==b&&-1!==j.valid_children&&-1===a.inArray(e.type||"default",j.valid_children))return this._data.core.last_error={error:"check",plugin:"types",id:"types_02",reason:"valid_children prevents function: "+c,data:JSON.stringify({chk:c,pos:g,obj:e&&e.id?e.id:!1,par:f&&f.id?f.id:!1})},!1;if(i&&e.children_d&&e.parents){for(k=0,l=0,m=e.children_d.length;m>l;l++)k=Math.max(k,i[e.children_d[l]].parents.length);k=k-e.parents.length+1}(0>=k||k===b)&&(k=1);do{if(j.max_depth!==b&&-1!==j.max_depth&&j.max_depth<k)return this._data.core.last_error={error:"check",plugin:"types",id:"types_03",reason:"max_depth prevents function: "+c,data:JSON.stringify({chk:c,pos:g,obj:e&&e.id?e.id:!1,par:f&&f.id?f.id:!1})},!1;f=this.get_node(f.parent),j=this.get_rules(f),k++}while(f)}}return!0},this.get_rules=function(a){if(a=this.get_node(a),!a)return!1;var c=this.get_type(a,!0);return c.max_depth===b&&(c.max_depth=-1),c.max_children===b&&(c.max_children=-1),c.valid_children===b&&(c.valid_children=-1),c},this.get_type=function(b,c){return b=this.get_node(b),b?c?a.extend({type:b.type},this.settings.types[b.type]):b.type:!1},this.set_type=function(c,d){var e=this._model.data,f,g,h,i,j,k,l,m;if(a.isArray(c)){for(c=c.slice(),g=0,h=c.length;h>g;g++)this.set_type(c[g],d);return!0}if(f=this.settings.types,c=this.get_node(c),!f[d]||!c)return!1;if(l=this.get_node(c,!0),l&&l.length&&(m=l.children(".jstree-anchor")),i=c.type,j=this.get_icon(c),c.type=d,(j===!0||!f[i]||f[i].icon!==b&&j===f[i].icon)&&this.set_icon(c,f[d].icon!==b?f[d].icon:!0),f[i]&&f[i].li_attr!==b&&"object"==typeof f[i].li_attr)for(k in f[i].li_attr)if(f[i].li_attr.hasOwnProperty(k)){if("id"===k)continue;"class"===k?(e[c.id].li_attr["class"]=(e[c.id].li_attr["class"]||"").replace(f[i].li_attr[k],""),l&&l.removeClass(f[i].li_attr[k])):e[c.id].li_attr[k]===f[i].li_attr[k]&&(e[c.id].li_attr[k]=null,l&&l.removeAttr(k))}if(f[i]&&f[i].a_attr!==b&&"object"==typeof f[i].a_attr)for(k in f[i].a_attr)if(f[i].a_attr.hasOwnProperty(k)){if("id"===k)continue;"class"===k?(e[c.id].a_attr["class"]=(e[c.id].a_attr["class"]||"").replace(f[i].a_attr[k],""),m&&m.removeClass(f[i].a_attr[k])):e[c.id].a_attr[k]===f[i].a_attr[k]&&("href"===k?(e[c.id].a_attr[k]="#",m&&m.attr("href","#")):(delete e[c.id].a_attr[k],m&&m.removeAttr(k)))}if(f[d].li_attr!==b&&"object"==typeof f[d].li_attr)for(k in f[d].li_attr)if(f[d].li_attr.hasOwnProperty(k)){if("id"===k)continue;e[c.id].li_attr[k]===b?(e[c.id].li_attr[k]=f[d].li_attr[k],l&&("class"===k?l.addClass(f[d].li_attr[k]):l.attr(k,f[d].li_attr[k]))):"class"===k&&(e[c.id].li_attr["class"]=f[d].li_attr[k]+" "+e[c.id].li_attr["class"],l&&l.addClass(f[d].li_attr[k]))}if(f[d].a_attr!==b&&"object"==typeof f[d].a_attr)for(k in f[d].a_attr)if(f[d].a_attr.hasOwnProperty(k)){if("id"===k)continue;e[c.id].a_attr[k]===b?(e[c.id].a_attr[k]=f[d].a_attr[k],m&&("class"===k?m.addClass(f[d].a_attr[k]):m.attr(k,f[d].a_attr[k]))):"href"===k&&"#"===e[c.id].a_attr[k]?(e[c.id].a_attr.href=f[d].a_attr.href,m&&m.attr("href",f[d].a_attr.href)):"class"===k&&(e[c.id].a_attr["class"]=f[d].a_attr["class"]+" "+e[c.id].a_attr["class"],m&&m.addClass(f[d].a_attr[k]))}return!0}},a.jstree.defaults.unique={case_sensitive:!1,trim_whitespace:!1,duplicate:function(a,b){return a+" ("+b+")"}},a.jstree.plugins.unique=function(c,d){this.check=function(b,c,e,f,g){if(d.check.call(this,b,c,e,f,g)===!1)return!1;if(c=c&&c.id?c:this.get_node(c),e=e&&e.id?e:this.get_node(e),!e||!e.children)return!0;var h="rename_node"===b?f:c.text,i=[],j=this.settings.unique.case_sensitive,k=this.settings.unique.trim_whitespace,l=this._model.data,m,n,o;for(m=0,n=e.children.length;n>m;m++)o=l[e.children[m]].text,j||(o=o.toLowerCase()),k&&(o=o.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")),i.push(o);switch(j||(h=h.toLowerCase()),k&&(h=h.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")),b){case"delete_node":return!0;case"rename_node":return o=c.text||"",j||(o=o.toLowerCase()),k&&(o=o.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")),m=-1===a.inArray(h,i)||c.text&&o===h,m||(this._data.core.last_error={error:"check",plugin:"unique",id:"unique_01",reason:"Child with name "+h+" already exists. Preventing: "+b,data:JSON.stringify({chk:b,pos:f,obj:c&&c.id?c.id:!1,par:e&&e.id?e.id:!1})}),m;case"create_node":return m=-1===a.inArray(h,i),m||(this._data.core.last_error={error:"check",plugin:"unique",id:"unique_04",reason:"Child with name "+h+" already exists. Preventing: "+b,data:JSON.stringify({chk:b,pos:f,obj:c&&c.id?c.id:!1,par:e&&e.id?e.id:!1})}),m;case"copy_node":return m=-1===a.inArray(h,i),m||(this._data.core.last_error={error:"check",plugin:"unique",id:"unique_02",reason:"Child with name "+h+" already exists. Preventing: "+b,data:JSON.stringify({chk:b,pos:f,obj:c&&c.id?c.id:!1,par:e&&e.id?e.id:!1})}),m;case"move_node":return m=c.parent===e.id&&(!g||!g.is_multi)||-1===a.inArray(h,i),m||(this._data.core.last_error={error:"check",plugin:"unique",id:"unique_03",reason:"Child with name "+h+" already exists. Preventing: "+b,data:JSON.stringify({chk:b,pos:f,obj:c&&c.id?c.id:!1,par:e&&e.id?e.id:!1})}),m}return!0},this.create_node=function(c,e,f,g,h){if(!e||e.text===b){if(null===c&&(c=a.jstree.root),c=this.get_node(c),!c)return d.create_node.call(this,c,e,f,g,h);if(f=f===b?"last":f,!f.toString().match(/^(before|after)$/)&&!h&&!this.is_loaded(c))return d.create_node.call(this,c,e,f,g,h);e||(e={});var i,j,k,l,m,n=this._model.data,o=this.settings.unique.case_sensitive,p=this.settings.unique.trim_whitespace,q=this.settings.unique.duplicate,r;for(j=i=this.get_string("New node"),k=[],l=0,m=c.children.length;m>l;l++)r=n[c.children[l]].text,o||(r=r.toLowerCase()),p&&(r=r.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")),k.push(r);l=1,r=j,o||(r=r.toLowerCase()),p&&(r=r.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""));while(-1!==a.inArray(r,k))j=q.call(this,i,++l).toString(),r=j,o||(r=r.toLowerCase()),p&&(r=r.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""));e.text=j}return d.create_node.call(this,c,e,f,g,h)}};var n=i.createElement("DIV");if(n.setAttribute("unselectable","on"),n.setAttribute("role","presentation"),n.className="jstree-wholerow",n.innerHTML="&#160;",a.jstree.plugins.wholerow=function(b,c){this.bind=function(){c.bind.call(this),this.element.on("ready.jstree set_state.jstree",a.proxy(function(){this.hide_dots()},this)).on("init.jstree loading.jstree ready.jstree",a.proxy(function(){this.get_container_ul().addClass("jstree-wholerow-ul")},this)).on("deselect_all.jstree",a.proxy(function(a,b){this.element.find(".jstree-wholerow-clicked").removeClass("jstree-wholerow-clicked")},this)).on("changed.jstree",a.proxy(function(a,b){this.element.find(".jstree-wholerow-clicked").removeClass("jstree-wholerow-clicked");var c=!1,d,e;for(d=0,e=b.selected.length;e>d;d++)c=this.get_node(b.selected[d],!0),c&&c.length&&c.children(".jstree-wholerow").addClass("jstree-wholerow-clicked")},this)).on("open_node.jstree",a.proxy(function(a,b){this.get_node(b.node,!0).find(".jstree-clicked").parent().children(".jstree-wholerow").addClass("jstree-wholerow-clicked")},this)).on("hover_node.jstree dehover_node.jstree",a.proxy(function(a,b){"hover_node"===a.type&&this.is_disabled(b.node)||this.get_node(b.node,!0).children(".jstree-wholerow")["hover_node"===a.type?"addClass":"removeClass"]("jstree-wholerow-hovered")},this)).on("contextmenu.jstree",".jstree-wholerow",a.proxy(function(b){if(this._data.contextmenu){b.preventDefault();var c=a.Event("contextmenu",{metaKey:b.metaKey,ctrlKey:b.ctrlKey,altKey:b.altKey,shiftKey:b.shiftKey,pageX:b.pageX,pageY:b.pageY});a(b.currentTarget).closest(".jstree-node").children(".jstree-anchor").first().trigger(c)}},this)).on("click.jstree",".jstree-wholerow",function(b){b.stopImmediatePropagation();var c=a.Event("click",{metaKey:b.metaKey,ctrlKey:b.ctrlKey,altKey:b.altKey,shiftKey:b.shiftKey});a(b.currentTarget).closest(".jstree-node").children(".jstree-anchor").first().trigger(c).focus()}).on("dblclick.jstree",".jstree-wholerow",function(b){b.stopImmediatePropagation();var c=a.Event("dblclick",{metaKey:b.metaKey,ctrlKey:b.ctrlKey,altKey:b.altKey,shiftKey:b.shiftKey});a(b.currentTarget).closest(".jstree-node").children(".jstree-anchor").first().trigger(c).focus()}).on("click.jstree",".jstree-leaf > .jstree-ocl",a.proxy(function(b){b.stopImmediatePropagation();var c=a.Event("click",{metaKey:b.metaKey,ctrlKey:b.ctrlKey,altKey:b.altKey,shiftKey:b.shiftKey});a(b.currentTarget).closest(".jstree-node").children(".jstree-anchor").first().trigger(c).focus()},this)).on("mouseover.jstree",".jstree-wholerow, .jstree-icon",a.proxy(function(a){return a.stopImmediatePropagation(),this.is_disabled(a.currentTarget)||this.hover_node(a.currentTarget),!1},this)).on("mouseleave.jstree",".jstree-node",a.proxy(function(a){this.dehover_node(a.currentTarget)},this))},this.teardown=function(){this.settings.wholerow&&this.element.find(".jstree-wholerow").remove(),c.teardown.call(this)},this.redraw_node=function(b,d,e,f){if(b=c.redraw_node.apply(this,arguments)){var g=n.cloneNode(!0);-1!==a.inArray(b.id,this._data.core.selected)&&(g.className+=" jstree-wholerow-clicked"),this._data.core.focused&&this._data.core.focused===b.id&&(g.className+=" jstree-wholerow-hovered"),b.insertBefore(g,b.childNodes[0])}return b}},window.customElements&&Object&&Object.create){var o=Object.create(HTMLElement.prototype);o.createdCallback=function(){var b={core:{},plugins:[]},c;for(c in a.jstree.plugins)a.jstree.plugins.hasOwnProperty(c)&&this.attributes[c]&&(b.plugins.push(c),this.getAttribute(c)&&JSON.parse(this.getAttribute(c))&&(b[c]=JSON.parse(this.getAttribute(c))));for(c in a.jstree.defaults.core)a.jstree.defaults.core.hasOwnProperty(c)&&this.attributes[c]&&(b.core[c]=JSON.parse(this.getAttribute(c))||this.getAttribute(c));a(this).jstree(b)};try{window.customElements.define("vakata-jstree",function(){},{prototype:o})}catch(p){}}}});


======================================================================
FILE PATH: AsyncFileIO.js
======================================================================

/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/


// Provides access to files using Native Messaging Host technology


var afio = (function () {
    const fio_host = "com.ipswitch.imacros.fio";

    function NodeObject(transferrable_node) {
        if (!transferrable_node || !transferrable_node._path)
            throw new Error("NodeObject can not be constructed");
        this._path = transferrable_node._path;
        if (typeof(transferrable_node._is_dir_int) != "undefined")
            this._is_dir_int = transferrable_node._is_dir_int;
    };

    NodeObject.prototype.__defineGetter__("path", function() {
        return this._path;
    });

    NodeObject.prototype.__defineGetter__("leafName", function() {
        // special treatment of root dir or drive letters
        if (__is_windows()) {
            if (/^[a-z]:\\?$/i.test(this._path))
                return "";
        } else {
            if (this._path == "/")
                return "";
        }

        return this._path.split(__psep()).pop();
    });

    NodeObject.prototype.__defineGetter__("parent", function() {
        // special treatment of root dir or drive letters
        // return the node itself
        if (__is_windows()) {
            if (/^[a-z]:\\?$/i.test(this._path))
                return new NodeObject(this);
        } else {
            if (this._path == "/")
                return new NodeObject(this);
        }

        var a = this._path.split(__psep()); a.pop();
        if (!__is_windows() && a.length == 1 && a[0] == "")
            a[0] = "/";
        return new NodeObject({_path: a.join(__psep())});
    });

    NodeObject.prototype.__defineGetter__("isDirCached", function() {
        return typeof(this._is_dir_int) != "undefined";
    });

    NodeObject.prototype.__defineGetter__("is_dir", function() {
        return this._is_dir_int;
    });

    NodeObject.prototype.exists = function() {
        var self = this;
        return new Promise(function(resolve, reject) {
            var req = {method: "node_exists", node: self};
            chrome.runtime.sendNativeMessage(fio_host, req, function(result) {
                if (chrome.runtime.lastError)
                    reject(chrome.runtime.lastError);
                else
                    resolve(result.exists);
            });
        });
    };


    NodeObject.prototype.isDir = function() {
        var self = this;
        return new Promise(function(resolve, reject) {
            if (self.isDirCached) {
                resolve(self.is_dir);
                return;
            }
            var req = {method: "node_isDir", node: self};
            chrome.runtime.sendNativeMessage(fio_host, req, function(result) {
                if (chrome.runtime.lastError)
                    reject(chrome.runtime.lastError);
                else
                    resolve(result.isDir);
            });
        });
    };


    NodeObject.prototype.isWritable = function() {
        var self = this;
        return new Promise(function(resolve, reject) {
            var req = {method: "node_isWritable", node: self};
            chrome.runtime.sendNativeMessage(fio_host, req, function(result) {
                if (chrome.runtime.lastError)
                    reject(chrome.runtime.lastError);
                else
                    resolve(result.isWritable);
            });
        });
    };


    NodeObject.prototype.isReadable = function() {
        var self = this;
        return new Promise(function(resolve, reject) {
            var req = {method: "node_isReadable", node: self};
            chrome.runtime.sendNativeMessage(fio_host, req, function(result) {
                if (chrome.runtime.lastError)
                    reject(chrome.runtime.lastError);
                else
                    resolve(result.isReadable);
            });
        });
    };


    // append part of the name
    NodeObject.prototype.append = function(bit) {
        while (bit[0] == __psep())
            bit = bit.substring(1);
        this._path += this._path[this._path.legnth-1] == __psep() ?
            bit : __psep()+bit;
    };

    NodeObject.prototype.clone = function() {
        return new NodeObject(this);
    };

    // copyTo(NodeObject dest)
    NodeObject.prototype.copyTo = function(node) {
        var self = this;
        return new Promise(function(resolve, reject) {
            if (!node) {
                reject(new Error("NodeObject.copyTo() no dest node provided"));
                return;
            }
            var req = {method: "node_copyTo", src: self, dst: node};
            chrome.runtime.sendNativeMessage(fio_host, req, function(result) {
                if (chrome.runtime.lastError) {
                    reject(chrome.runtime.lastError);
                    return;
                }

                if (result.error) {
                    reject(new Error(result.error));
                    return;
                }

                resolve();
            });
        });
    };


    // moveTo(NodeObject dest)
    NodeObject.prototype.moveTo = function(node) {
        var self = this;
        return new Promise(function(resolve, reject) {
            if (!node) {
                reject(new Error("NodeObject.moveTo() no dest node provided"));
                return;
            }
            var req = {method: "node_moveTo", src: self, dst: node};
            chrome.runtime.sendNativeMessage(fio_host, req, function(result) {
                if (chrome.runtime.lastError) {
                    reject(chrome.runtime.lastError);
                    return;
                }

                if (result.error) {
                    reject(new Error(result.error));
                    return;
                }

                resolve();
            });
        });
    };


    // remove()
    NodeObject.prototype.remove = function() {
        var self = this;
        return new Promise(function(resolve, reject) {
            var req = {method: "node_remove", node: self};
            chrome.runtime.sendNativeMessage(fio_host, req, function(result) {
                if (chrome.runtime.lastError) {
                    reject(chrome.runtime.lastError);
                    return;
                }

                if (result.error) {
                    reject(undefined, new Error(result.error));
                    return;
                }

                resolve();
            });
        });
    };


    // afio implementation
    var obj = {};

    /* Quick test for the availability of the host */
    obj.isInstalled = function() {
        return new Promise(function(resolve, reject) {
            var req = {method: "isInstalled", version:Storage.getChar("version")};
            chrome.runtime.sendNativeMessage(fio_host, req, function(result) {
                resolve(!chrome.runtime.lastError);
            });
        });
    };

    /* Query limits */
    obj.queryLimits = function() {
        return new Promise(function(resolve, reject) {
            var req = {method: "queryLimits"};
            chrome.runtime.sendNativeMessage(fio_host, req, function(result) {
                if(chrome.runtime.lastError) {
                    reject(chrome.runtime.lastError)
                } else if (result.error) {
                    reject(result.error)
                } else {
                    resolve(result)
                }
            });
        });
    };


    /*
      openNode(String path)
    */
    obj.openNode = function(path) {
        if (!path) throw new Error("afio.openNode() no path provided");
        return new NodeObject({_path: path});
    };


    /*
      readTextFile(NodeObject node)
        returns the content of for the given node object or error in case file
        can not be read.
    */
    obj.readTextFile = function(node) {
        return new Promise(function(resolve, reject) {
            if (!node) {
                reject(new Error("afio.readTextFile() no file node provided"));
                return;
            }
            var req = {method: "readTextFile", node: node};
            chrome.runtime.sendNativeMessage(fio_host, req, function(result) {
                if (chrome.runtime.lastError) {
                    reject(chrome.runtime.lastError);
                    return;
                }

                if (result.error) {
                    reject(new Error(result.error));
                    return;
                }

                resolve(result.data);
            });
        });
    };


    /*
     writeTextFile(NodeObject node, String data)
       resolves with no arguments on success
    */

    obj.writeTextFile = function(node, data) {
        return new Promise(function(resolve, reject) {
            if (!node) {
                reject(new Error("afio.writeTextFile() no file node provided"));
                return;
            }
            var req = {method: "writeTextFile", node: node, data: (data || "")};
            chrome.runtime.sendNativeMessage(fio_host, req, function(result) {
                if (chrome.runtime.lastError) {
                    reject(chrome.runtime.lastError);
                    return;
                }

                if (result.error) {
                    reject(new Error(result.error));
                    return;
                }

                resolve();
            });
        });
    };

    /*
      appendTextFile(NodeObject node, String data)
        resolves with no arguments on success
    */

    obj.appendTextFile = function(node, data) {
        return new Promise(function(resolve, reject) {
            if (!node) {
                reject(new Error("afio.appendTextFile() no file provided"));
                return;
            }
            var req = {method: "appendTextFile",
                       node: node, data: (data || "")};
            chrome.runtime.sendNativeMessage(fio_host, req, function(result) {
                if (chrome.runtime.lastError) {
                    reject(chrome.runtime.lastError);
                    return;
                }
                if (result.error) {
                    reject(new Error(result.error));
                    return;
                }
                resolve();
            });
        });
    };


    /*
     getNodesIndir(NodeObject node, [optional] String filter)
        resolves with an array of nodes representing directory listing.
    */
    obj.getNodesInDir = function(node, filter) {
        return new Promise(function(resolve, reject) {
            if (!node) {
                reject(new Error("afio.getNodesInDir() no file node provided"));
                return;
            }
            node.isDir().then(function(is_dir) {
                if (!is_dir) {
                    reject(new Error(
                        "afio.getNodesInDir() node is not a directory"
                    ));
                    return;
                }
                var req = {method: "getNodesInDir", node: node};
                if (typeof filter == "string")
                    req.filter = filter;
                chrome.runtime.sendNativeMessage(
                    fio_host, req, function(result) {
                        if (chrome.runtime.lastError) {
                            reject(chrome.runtime.lastError);
                            return;
                        }

                        if (result.error) {
                            reject(new Error(result.error));
                            return;
                        }

                        if (typeof(filter) == "function")
                            resolve(result.nodes.map(function(x) {
                                return new NodeObject(x);
                            }).filter(filter));
                        else
                            resolve(result.nodes.map(function(x) {
                                return new NodeObject(x);
                            }));
                    }
                );
            }).catch(reject);
        });
    };

    /*
     getLogicalDrives()
        resolves with an array of nodes representing root logical drives on
        Windows or just an array containing single element "/" for *nix system.
    */
    obj.getLogicalDrives = function() {
        return new Promise(function(resolve, reject) {
            var req = {method: "getLogicalDrives"};
            chrome.runtime.sendNativeMessage(fio_host, req, function(result) {
                if (chrome.runtime.lastError) {
                    reject(chrome.runtime.lastError);
                    return;
                }

                if (result.error) {
                    reject(new Error(result.error));
                    return;
                }

                resolve(result.nodes.map(function(x) {
                    return new NodeObject(x);
                }));
            });
        });
    };


    /*
     getDefaultDir(String name)
        resolves with a node for the corresponding default dir or null if
        it hasn't been set yet.
    */
    obj.getDefaultDir = function(name) {
        var self = this;
        return new Promise(function(resolve, reject) {
            if (!/^(?:downpath|datapath|logpath|savepath)$/.test(name)) {
                reject(new Error("afio.getDefaultDir() wrong dir name "+name));
                return;
            }

            if (localStorage["def"+name]) {
                resolve(self.openNode(localStorage["def"+name]));
                return;
            }

            // not initialized yet, so we have to ask host to do that
            var req = {method: "getDefaultDir", name: name};
            chrome.runtime.sendNativeMessage(fio_host, req, function(result) {
                if (chrome.runtime.lastError) {
                    reject(chrome.runtime.lastError);
                    return;
                }
                if (result.error) {
                    reject(new Error(result.error));
                    return;
                }
                resolve(new NodeObject(result.node));
            });
        });
    };

    /*
     makeDirectory(NodeObject node)
        resolves with no arguments on success
    */
    obj.makeDirectory = function(node) {
        return new Promise(function(resolve, reject) {
            if (!node) {
                reject(new Error("afio.makeDirectory() node is not provided"));
                return;
            }

            var req = {method: "makeDirectory", node: node};
            chrome.runtime.sendNativeMessage(fio_host, req, function(result) {
                if (chrome.runtime.lastError) {
                    reject(chrome.runtime.lastError);
                    return;
                }

                if (result.error) {
                    reject(new Error(result.error));
                    return;
                }

                resolve();
            });
        });
    };

    /*
     writeImageToFile(NodeObject node, imageDataType imageData)
      imageDataType is
       {
        image: <base64 encoded string>,
        encoding: <encoding type, now only base64 supported>,
        mimeType: <image MIME type>
       };
      resolves with no arguments on success
    */
    obj.writeImageToFile = function(node, data) {
        return new Promise(function(resolve, reject) {
            if (!node) {
                reject(
                    new Error("afio.writeImageToFile() node is not provided")
                );
                return;
            }

            if (!data || !data.image || !data.encoding || !data.mimeType) {
                reject(
                    new Error("afio.writeImageToFile() imageData is "+
                              "not provided or has wrong type")
                );
                return;
            }

            var req = {method: "writeImageToFile", node: node, imageData: data};
            chrome.runtime.sendNativeMessage(fio_host, req, function(result) {
                if (chrome.runtime.lastError) {
                    reject(chrome.runtime.lastError);
                    return;
                }

                resolve();
            });
        });
    };


    return obj;
}) ();



======================================================================
FILE PATH: badge.js
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/

// Handy wrapper for browser action functions
// (badge is not really good naming for the object)
var badge = {
    // execute callback for all tabs in window
    // callback is function(tab) {...}
    forAllTabs: function(win_id, callback) {
        // for some stupid reason windows.get(win) does not
        // contain "tabs" property, so we have to get All windows
        chrome.windows.getAll({populate: true}, function(ws) {
            ws.forEach(function(win) {
                if (win.id == win_id) {
                    win.tabs.forEach(function(tab) {
                        callback(tab);
                    });
                    return;
                }
            });
        });
    },


    setBackgroundColor: function(win_id, color) {
        this.forAllTabs(win_id, function(tab) {
            chrome.browserAction.setBadgeBackgroundColor(
                {tabId: tab.id, color: color}
            );
        });
    },


    setText: function(win_id, text) {
        this.forAllTabs(win_id, function(tab) {
            chrome.browserAction.setBadgeText(
                {tabId: tab.id, text: text}
            );
        });
    },


    setIcon: function(win_id, icon) {
        this.forAllTabs(win_id, function(tab) {
                chrome.browserAction.setIcon(
                    {tabId: tab.id, path: icon}
                );
        });
    },


    set: function(win_id, details) {
        switch (details.status) {
        case "tag_wait":
            this.setBackgroundColor(win_id, [209, 211, 212,255]); // light gray
            break;

        case "loading":            
            this.setBackgroundColor(win_id, [250, 187, 24,255]); // yellow
            break;

        case "waiting":
            this.setBackgroundColor(win_id, [162, 208, 116,255]); // green
            break;

        case "playing":
            this.setBackgroundColor(win_id, [76, 196, 209,255]); // blue
            break;

        case "recording":
            this.setBackgroundColor(win_id, [241, 86, 76,255]); // red
            break;
        };

        this.setText(win_id, details.text.toString());
    },


    clearText: function(win_id) {
        this.setText(win_id,  "");
    }
};



======================================================================
FILE PATH: beforePlay.html
======================================================================
<html>
<head>
 <meta charset="UTF-8">
    <title>iMacros</title>
    <link rel="stylesheet" type="text/css"
          href="skin/common.css" />
    <link rel="stylesheet" type="text/css"
          href="skin/beforePlay.css" />
    <script src="beforePlay.js"></script>
    <script src="utils.js"></script>
  </head>
  <body>
    <div id="container">
      <div id="message-div">
        <span id="message">
          You are about to play macro "{{macroname}}".
          <!-- You can view or edit its code before playing. -->
        </span>
      </div>
      <div id="confirm-div">
        <div id="checkbox-div">
          <input id="checkbox" type="checkbox" checked="true"/>
          <span>Show this dialog next time</span>
        </div>
      </div>
      <div id="buttons">
        <div id="play-button" class="button icon-button">
          <span>Play</span>
        </div>
        <!-- <div id="edit-button" class="button icon-button">
          <span>Edit/View</span>
        </div> -->
        <div id="cancel-button" class="button icon-button">
          <span>Cancel</span>
        </div>
      </div>
    </div>
  </body>
</html>



======================================================================
FILE PATH: beforePlay.js
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/


function play() {
    var m = {
        source: args.source,
        name: args.name,
        bookmark_id: args.bookmark_id
    };
    var win_id = args.win_id;
    var showAgain = document.getElementById("checkbox").checked;
    opener.Storage.setBool("before-play-dialog", showAgain);
    window.opener.playMacro(m, win_id);
    window.close();
}

function cancel() {
    opener.Storage.setBool("before-play-dialog", document.getElementById("checkbox").checked);
    window.close();
}

function edit() {
    var m = {
        source: args.source,
        name: args.name,
        bookmark_id: args.bookmark_id
    };
    setTimeout(function () {window.opener.edit(m);}, 0);
    opener.Storage.setBool("before-play-dialog", document.getElementById("checkbox").checked);
    window.close();
}

window.addEventListener("load", function(evt) {
    if (args) {
        var x = document.getElementById("message").textContent;
        x = x.replace(/{{macroname}}/, args.name);
        document.getElementById("message").textContent = x;
    }
    document.getElementById("play-button").focus();
    document.getElementById("checkbox").checked = opener.Storage.getBool("before-play-dialog");
    
    // add DOM event handlers
    document.getElementById("play-button").addEventListener("click", play);
    // document.getElementById("edit-button").addEventListener("click", edit);
    document.getElementById("cancel-button").addEventListener("click", cancel);

    resizeToContent(window, document.getElementById('container'));
    // prevent right-click
    document.body.oncontextmenu = function(e) {
        e.preventDefault();
        return false;
    };
}, true);



======================================================================
FILE PATH: bg.html
======================================================================
<html>
    <script src="utils.js" > </script>
    <script src="nm_connector.js" > </script>
    <script src="communicator.js"> </script>
    <script src="context.js"> </script>
    <script src="badge.js"> </script>
    <script src="mplayer.js"> </script>
    <script src="mrecorder.js"> </script>
    <script src="rijndael.js"></script>
    <script src="AsyncFileIO.js"></script>
    <script src="bg.js"> </script>
</html>

<html>
  <body>
    </embed>
    <iframe id="sandbox" src="sandbox.html" hidden="true"></iframe>
  </body>
</html>



======================================================================
FILE PATH: bg.js
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/

"use strict";
// old bookmarklet pattern

// function makeBookmarklet(name, content) {
//     var pattern = "(function() {"+
//         "try{"+
//         "var m64 = \"{{macro}}\", n = \"{{name}}\";"+
//         "if(!/Chrome\\/\\d+\\.\\d+\\.\\d+\\.\\d+/.test(navigator.userAgent)){"+
//         "alert('iMacros: The embedded macros work with iMacros for Chrome. Support for IE/Firefox is planned.');"+
//         "return;"+
//         "}"+
//         "if(!/^(?:chrome|https?|file)/.test(location)){"+
//         "alert('iMacros: To run a macro, you need to open a website first.');"+
//         "return;"+
//         "}"+
//         "var div = document.getElementById(\"imacros-bookmark-div\");"+
//         "if (!div){"+
//         "alert(\"Can not run macro, no iMacros div found\");"+
//         "return;"+
//         "}"+
//         "var ta = document.getElementById(\"imacros-macro-container\");"+
//         "ta.value = decodeURIComponent(atob(m64));"+
//         "div.setAttribute(\"name\", n);"+
//         "var evt = document.createEvent(\"Event\");"+
//         "evt.initEvent(\"iMacrosRunMacro\", true, true);"+
//         "div.dispatchEvent(evt);"+
//         "}catch(e){alert('Bookmarklet error: '+e.toString());}"+
//         "}) ();";

//     var macro_name = name || "Unnamed Macro", source = content;
//     macro_name = imns.escapeLine(macro_name);
//     pattern = pattern.replace("{{name}}", macro_name);
//     source = btoa(encodeURIComponent(source));
//     source = imns.escapeLine(source);
//     pattern = pattern.replace("{{macro}}", source);

//     var url = "javascript:" + pattern;

//     return url;
// }


// create bookmarklet of new type
function makeBookmarklet(name, code) {
    var pattern = "(function() {"+
        "try{"+
        "var e_m64 = \"{{macro}}\", n64 = \"{{name}}\";"+
        "if(!/^(?:chrome|https?|file)/.test(location)){"+
        "alert('iMacros: Open webpage to run a macro.');"+
        "return;"+
        "}"+
        "var macro = {};"+
        "macro.source = decodeURIComponent(atob(e_m64));"+
        "macro.name = decodeURIComponent(atob(n64));"+
        "var evt = document.createEvent(\"CustomEvent\");"+
        "evt.initCustomEvent(\"iMacrosRunMacro\", true, true, macro);"+
        "window.dispatchEvent(evt);"+
        "}catch(e){alert('iMacros Bookmarklet error: '+e.toString());}"+
        "}) ();";

    var macro_name = name || "Unnamed Macro", source = code;
    macro_name = btoa(encodeURIComponent(name));
    macro_name = imns.escapeLine(macro_name);
    pattern = pattern.replace("{{name}}", macro_name);
    source = btoa(encodeURIComponent(source));
    source = imns.escapeLine(source);
    pattern = pattern.replace("{{macro}}", source);

    var url = "javascript:" + pattern;

    return url;
}


function ensureBookmarkFolderCreated(parent_id, name) {
    return new Promise(function(resolve, reject) {
        chrome.bookmarks.getChildren( parent_id, function (result) {
            // find a bookmark with matching name
            for(var r of result) {
                if (r.title == name)
                    return resolve(r);
            }
            // otherwise create one
            chrome.bookmarks.create(
                {parentId: parent_id, title: name}, resolve
            );
        });
    });
}

function createBookmark(folder_id, title, url, bookmark_id, overwrite) {
    return new Promise(function(resolve, reject) {
        if (bookmark_id) {
            chrome.bookmarks.update(
                bookmark_id,
                {url: url, title: title},
                resolve
            );
            return;
        }

        if (overwrite) {
            reject(new Error("bg.save() - trying to overwrite "+title+
                             " while bokmark_id is not set"));
            return;
        }

        // TODO: ask if user wants to overwrite the macro
        // if (confirm())...

        // look for a macro with the same name
        // append (\d) to title if macro with the title already exists
        chrome.bookmarks.getChildren(folder_id, function (children) {
            var found = false, count = 0, name = title;
            for(;;) {
                for(var x of children) {
                    if (x.title == name && x.url) {
                        found = true; count++; break;
                    }
                }
                if (found) {
                    found = false;
                    if (/\.iim$/.test(title)) {
                        name = title.replace(/\.iim$/, "$'("+count+").iim");
                    } else {
                        name = title+"("+count+")";
                    }
                    continue;
                } else {
                    break;
                }
            }
            chrome.bookmarks.create(
                {
                    parentId: folder_id,
                    title: name,
                    url: url
                }, resolve);
        });
    });
}


function save_file(save_data, overwrite, callback) {
    var node = afio.openNode(save_data.file_id);
    var update_tree = true;

    if (!isMacroFile(save_data.name))
        save_data.name += ".iim";

    if (node.leafName != save_data.name) {
        node = node.parent;
        node.append(save_data.name);
    }

    node.exists().then(function(exists) {
        if (exists && !overwrite) {
            var yes = confirm("Are you sure you want to overwrite "+
                              node.path+"?");
            if (!yes)
                return;
        }

        update_tree = !exists;

        return afio.writeTextFile(node, save_data.source).then(function() {
            typeof (callback) == "function" && callback(save_data);
            if (!update_tree)
                return;
            for (var x in context) { // update all panels
                var panel = context[x].panelWindow;
                if (panel && !panel.closed) {
                    var doc = panel.frames["tree-iframe"].contentDocument;
                    doc.defaultView.location.reload();
                }
            }
        });
    }).catch(console.error.bind(console));
}



function save(save_data, overwrite, callback) {
    // TODO: for file version when file_id is not set "saveAs"
    // saves into file or bookmark
    if (save_data.file_id) {
        save_file(save_data, overwrite, callback);
        return;
    }

    chrome.bookmarks.getTree( function (tree) {
        var p_id = tree[0].children[0].id;
        ensureBookmarkFolderCreated(p_id, "iMacros").then(function(node) {
            var url = makeBookmarklet(save_data.name, save_data.source);
            var iMacrosDirId = node.id;
            if (overwrite && !save_data.bookmark_id) {
                // we should check if "name" exists and if it does then
                // find its bookmark_id
                chrome.bookmarks.getChildren(iMacrosDirId, function(ar) {
                    for (var x of ar) {
                        if (x.title == save_data.name) {
                            save_data.bookmark_id = x.id;
                            createBookmark(
                                iMacrosDirId, save_data.name, url,
                                save_data.bookmark_id,
                                overwrite
                            ).then(function() {
                                typeof(callback) == "function" && callback(save_data);
                            });
                            return;
                        }
                    };
                    // no macro was found so create a new one
                    createBookmark(
                        iMacrosDirId, save_data.name, url,
                        save_data.bookmark_id,
                        false
                    ).then(function() {
                        typeof(callback) == "function" &&
                            callback(save_data);
                    });
                });
            } else {
                createBookmark(
                    iMacrosDirId, save_data.name, url,
                    save_data.bookmark_id,
                    overwrite
                ).then(function() {
                    typeof(callback) == "function" &&
                        callback(save_data);
                });
            }
        });
    });
}


function edit(macro, overwrite) {
    var features = "titlebar=no,menubar=no,location=no,"+
        "resizable=yes,scrollbars=yes,status=no,"+
        "width=640,height=480";
    // var win = window.open("editor/simple_editor.html",
    //     null, features);
    // console.info("Edit macro: %O", macro);
    var win = window.open("editor/editor.html",
        null, features);

    win.args = {macro: macro, overwrite: overwrite};
}


function playMacro(macro, win_id) {
    if (context[win_id]) {
        getLimits().then(
            limits => context[win_id].mplayer.play(macro, limits)
        )
    } else {
        console.error("No context for windowId="+win_id);
    }
}

function dockPanel(win_id) {
    var panel = context[win_id].panelWindow;
    if (!panel || panel.closed) {
        clearInterval(context[win_id].dockInterval);
        return;
    }
    if (!Storage.getBool("dock-panel"))
        return;

    chrome.windows.get(win_id, function(w) {
	var new_x = w.left - panel.outerWidth;
	if (new_x < 0)
            new_x = 0;

	var updateInfo = {
            height: w.height,
	         width: Math.round(panel.outerWidth),
            left: new_x,
            top: w.top
	};

	chrome.windows.update(context[win_id].panelId, updateInfo);
    });
}

function openPanel(win_id) {
	// Exit if panel is already open
	var panel = context[win_id].panelWindow;
	if (panel && !panel.closed) {
		return;
	}

    chrome.windows.get(win_id, function(win) {
        var panelBox = Storage.getObject("panel-box");
        if (!panelBox) {
            panelBox = new Object();
            panelBox.width = 210;
            if (Storage.getBool("dock-panel"))
                panelBox.height = win.height;
            else
                panelBox.height = 600;
            panelBox.top = win.top;
            panelBox.left = win.left-panelBox.width;
            if (panelBox.left < 0)
                panelBox.left = 0;
        }

        var createData = {
            url: "panel.html", type: "popup",
            top: panelBox.top, left: panelBox.left,
            width: panelBox.width, height: panelBox.height
        };

        chrome.windows.create(createData, function(w) {
            context[win_id].panelId = w.id;
            context[win_id].dockInterval = setInterval(function() {
                dockPanel(win.id);
            }, 500);
        });
    });
}

// called from panel
// we use it to find and set win_id for that panel
// NOTE: unfortnunately, it seems there is no more straightforward way
// because on Windows chrome.windows.onCreated is fired too early for
// panel's DOM window be fully constructed
function onPanelLoaded(panel) {
    for (var win_id in context) {
        win_id = parseInt(win_id);
        if (!isNaN(win_id)) {
            var v = chrome.extension.getViews(
                {windowId: context[win_id].panelId}
            )[0];
            if (v == panel) {
                context[win_id].panelWindow = panel;
                return win_id;
            }
        }
    }

    console.error("Can not find windowId for panel %O", panel);
    throw new Error("Can not find windowId for panel!");
}


// browser action button onclick handler
chrome.browserAction.onClicked.addListener(function(tab) {
    var win_id = tab.windowId;
    if (Storage.getBool("show-updated-badge")) {
        doAfterUpdateAction();
        return;
    }

    if (!context[win_id]) {
        console.warn("No context for window, rebuilding: "+win_id);
        context.init(win_id);
    }

    var mplayer = context[win_id].mplayer;
    var recorder = context[win_id].recorder;

    if (context[win_id].state == "idle") {
        var panel = context[win_id].panelWindow;
        if (!panel || panel.closed) {
            openPanel(win_id);
        } else {
            panel.close();
            delete context[win_id].panelId;
            delete context[win_id].panelWindow;
        }
    } else if (context[win_id].state == "paused") {
        if (mplayer.paused) {
            mplayer.unpause();
        }
    } else {
        if (mplayer.playing) {
            mplayer.stop();
        } else if (recorder.recording) {
            recorder.stop();
            var recorded_macro = recorder.actions.join("\n");
            var macro = {source: recorded_macro, win_id: win_id,
                         name: "#Current.iim"};

            if (Storage.getChar("tree-type") == "files") {
                afio.isInstalled().then(function(installed) {
                    if (installed) {
                        afio.getDefaultDir("savepath").then(function(node) {
                            node.append("#Current.iim");
                            macro.file_id = node.path;
                            edit(macro, /* overwrite */ true);
                        }).catch(console.error.bind(console));
                    } else {            // no file access
                        edit(macro, true);
                    }
                }).catch(console.error.bind(console));
            } else {
                edit(macro, true);
            }
        }
    }
});


function addSampleBookmarkletMacro(name, parentId, content) {
    return new Promise(function(resolve, reject) {
        chrome.bookmarks.getChildren(parentId, function(a) {
            // we should check if "name" exists
            var id = null;
            for (var x of a) {
                if (x.title == name) {
                    // TODO: maybe we should ask user if he or she
                    // wants to override that sample macro?
                    // Now just overwrite it silently
                    id = x.id;
                    break;
                }
            }
            // no macro was found, create a new one
            createBookmark(
                parentId, name,
                makeBookmarklet(name, content),
                id || null,
                !!id
            ).then(resolve, reject);
        });
    });
}

function xhr(path, mimeType) {
    return new Promise((resolve, reject) => {
        let url = chrome.extension.getURL(path)
        let req = new XMLHttpRequest()
        req.overrideMimeType(mimeType)
        req.onreadystatechange = function() {
            if (req.readyState == 4) {
                resolve(req.response)
            }
        }
        req.onerror = reject
        req.open("GET", url, true)
        req.send(null)
    })
}

function getSample(name) {
    return xhr("samples/"+name, "text/plain;charset=utf-8")
        .then(response => ({
            name: name,
            content: response
        }))
}

function ensureDirectoryExists(node) {
    // a workaround for afio.exe bug on Windows - paths which end with "\"
    // are erroneously reported as non-existsent
    if (__is_windows() && node._path.endsWith("\\"))
        node._path = node._path.slice(0, -1);
    return node.exists().then(function(exists) {
        return exists ? Promise.resolve() :
            node.parent.exists().then(function(parent_exists) {
                return  parent_exists ? afio.makeDirectory(node) :
                    ensureDirectoryExists(node.parent);
            });
    });
}


function installSampleMacroFiles() {
    var names = [
        "ArchivePage.iim",
        "Eval.iim",
        "Extract.iim",
        "ExtractAndFill.iim",
        "ExtractRelative.iim",
        "ExtractTable.iim",
        "ExtractURL.iim",
        "FillForm-Events.iim",
        "FillForm-CssSelectors.iim",
        "FillForm-XPath.iim",
        "FillForm.iim",
        "Frame.iim",
        "Loop-Csv-2-Web.iim",
        "Open6Tabs.iim",
        "SaveAs.iim",
        "SlideShow.iim",
        "Stopwatch.iim",
        "TagPosition.iim",
        "Upload.iim"
    ]

    return afio.isInstalled().then(function(installed) {
        if (!installed) {
            return Promise.reject("afio is not installed!")
        } else {
            return afio.getDefaultDir("savepath")
        }
    }).then(function(node) {
        node.append("Demo-Chrome")
        return ensureDirectoryExists(node).then(function() {
            return names.map(getSample).reduce(function(seq, p) {
                return seq.then(function() {
                    return p
                }).then(m => {
                    let file = node.clone()
                    file.append(m.name)
                    return afio.writeTextFile(file, m.content)
                })
            }, Promise.resolve())
        });
    });
}

function installProfilerXsl() {
    return afio.getDefaultDir("downpath").then(function(node) {
        return getSample("Profiler.xsl").then(function(file) {
            node.append("Profiler.xsl");
            return afio.writeTextFile(node, file.content);
        });
    });
}

function installAddressCsv() {
    return afio.getDefaultDir("datapath").then(function(node) {
        return getSample("Address.csv").then(function(file) {
            node.append("Address.csv");
            return afio.writeTextFile(node, file.content);
        });
    });
}

function installSampleBookmarkletMacros() {
    var names = [
        "ArchivePage.iim",
        "Eval.iim",
        "Extract.iim",
        "ExtractAndFill.iim",
        "ExtractRelative.iim",
        "ExtractTable.iim",
        "ExtractURL.iim",
        "FillForm-XPath.iim",
        "FillForm-Events.iim",
        "FillForm-CssSelectors.iim",
        "FillForm.iim",
        "Frame.iim",
        "Open6Tabs.iim",
        "SaveAs.iim",
        "SlideShow.iim",
        "Stopwatch.iim",
        "TagPosition.iim",
        "Upload.iim"
    ];

    return new Promise(function(resolve, reject) {
        chrome.bookmarks.getTree(function(tree) {
            var panelId = tree[0].children[0].id
            ensureBookmarkFolderCreated(
                panelId, "iMacros"
            ).then(function(im) {
                return ensureBookmarkFolderCreated(im.id, "Demo-Chrome")
            }).then(function(node) {
                return names.map(getSample).reduce(function(seq, p) {
                    return seq.then(function() {
                        return p
                    }).then(macro => addSampleBookmarkletMacro(
                        macro.name, node.id, macro.content
                    ))
                }, Promise.resolve())
            }).then(resolve, reject);
        })
    })
}



// regexp to update bookmarked macros to newer version (e_m64)
var strre = "(?:[^\"\\\\]|\\\\[0btnvfr\"\'\\\\])+";
var bm_update_re = new RegExp('^javascript\\:\\(function\\(\\) '+
                              '\\{try\\{var ((?:e_)?m(?:64)?) = "('+strre+')"'+
                              ', (n(?:64)?) = "('+strre+')";'+
                             '.+;evt\.initEvent');
// recursive function which walks through bookmarks tree
function updateBookmarksTree(tree) {
    if (!tree)
        return;

    tree.forEach(function(x) {
        if (x.url) {
            var match = bm_update_re.exec(x.url);
            if (match) {
                var source, name;
                switch(match[1]) {
                case "m":
                    source = decodeURIComponent(imns.unwrap(match[2]));
                    break;
                case "m64": case "e_m64":
                    source = decodeURIComponent(atob(match[2]));
                    break;
                }
                if (match[3] == "n") {
                    name = decodeURIComponent(match[4]);
                } else if (match[3] == "n64") {
                    name = decodeURIComponent(atob(match[4]));
                }
                chrome.bookmarks.update(
                    x.id, {url: makeBookmarklet(name, source)}
                );
            }
        } else {
            updateBookmarksTree(x.children);
        }
    });
}


function doAfterUpdateAction() {
    Storage.setBool("show-updated-badge", false);
    chrome.windows.getAll({populate: false}, function(ws) {
        ws.forEach(function(win) {
            badge.clearText(win.id);
        });
    });
    // open update page
    link(getRedirFromString("updated"));
    var yes = confirm("Do you want to install the latest versions of the demo macros (Old sample macros will be overwritten)?");
    if (!yes)
        return;
    // update bookmarked macros for newer version if any
    chrome.bookmarks.getTree( function (tree) {
        updateBookmarksTree(tree);
    });
    installSampleBookmarkletMacros().then(function() {
        return afio.isInstalled().then(function(installed) {
            return installed ?
                installSampleMacroFiles()
                .then(installAddressCsv)
                .then(installProfilerXsl)
                : Promise.resolve();
        });
    }).catch(console.error.bind(console));
}

function onUpdate() {
    setDefaults();
    Storage.setBool("show-updated-badge", true);
    chrome.windows.getAll({populate: false}, function(ws) {
        ws.forEach(function(win) {
            badge.setText(win.id, "New");
        });
    });
}

function setDefaults() {
    // set some default parameters
    let default_settings = {
        "record-mode": "conventional",
        "recording-prefer-id": true,
        "recording-prefer-css-selectors": false,
        "before-play-dialog": true,
        "dock-panel": false,
        "default-dirs-set": false,
        "profiler-enabled": false,
        "replaying-delay": 0
    };
    for (let pref in default_settings) {
        if (!Storage.isSet(pref))
            switch(typeof default_settings[pref]) {
            case "string":
                Storage.setChar(pref, default_settings[pref]);
                break;
            case "boolean":
                Storage.setBool(pref, default_settings[pref]);
                break;
            case "number":
                Storage.setNumber(pref, default_settings[pref]);
                break;
            }
    }
}

window.addEventListener("load", function (event) {
    // initialize context
    // chrome.windows.getLastFocused(function (w) {
    chrome.windows.getCurrent(function (w) {
        context.init(w.id);
    });

    // listen to run-macro command from content script
    communicator.registerHandler("run-macro", function (data, tab_id) {
        chrome.tabs.get(tab_id, function(t) {
            var w_id = t.windowId;
            if (!context[w_id]) {
                console.error("No context for window "+w_id);
                return;
            }
            if (Storage.getBool("before-play-dialog")) {
                var features = "titlebar=no,menubar=no,location=no,"+
                    "resizable=yes,scrollbars=yes,status=no,"+
                    "width=400, height=140";
                var win = window.open("beforePlay.html", null, features);
                win.args = data;
                win.args.win_id = w_id;
            } else {
                getLimits().then(
                    limits => asyncRun(function () {
                        context[w_id].mplayer.play(data, limits);
                    })
                )
            }
        });
    });

    // check if it is the first run
    if (!Storage.getBool("already-installed")) {
        Storage.setBool("already-installed", true);
        setDefaults();
        // get version number
        Storage.setChar("version", chrome.runtime.getManifest().version);
        installSampleBookmarkletMacros().catch(console.error.bind(console));
        this.setDefaults();
        // open welcome page
        chrome.tabs.create({
            url: getRedirFromString("welcome")
        }, function() {});
    } else {
        var version = chrome.runtime.getManifest().version;
        // check if macro was updated
        if (version != Storage.getChar("version")) {
            Storage.setChar("version", version);
            onUpdate();
        }
    }

    // set default directories
    if (!Storage.getBool("default-dirs-set")) {
        afio.isInstalled().then(function(installed) {
            if (!installed)
                return;
            var dirs = ["datapath", "savepath", "downpath"];
            return dirs.reduce(function(seq, d) {
                return seq.then(function() {
                    return afio.getDefaultDir(d).then(function(node) {
                        Storage.setChar("def"+d, node.path);
                        return ensureDirectoryExists(node);
                    });
                });
            }, Promise.resolve()).then(installSampleMacroFiles)
                .then(installAddressCsv)
                .then(installProfilerXsl)
                .then(function() {
                    Storage.setBool("default-dirs-set", true);
                });
        }).catch(console.error.bind(console));
    }

    // TODO: check somehow if we need to start SI server
    // if (start_SI_server)
    nm_connector.startServer();

    // Set afio-installed
    afio.isInstalled().then(function(installed) {
        Storage.setBool("afio-installed", installed);
    });

    // listen to restart-server command from content script
    // (fires after t.html?pipe=<pipe> page is loaded)
    chrome.extension.onRequest.addListener(
        function (req, sender, sendResponse) {
            // clean up request
            if (req.command == "restart-server") {
                // TODO: avoid possible double-restart somehow
                sendResponse({status: "OK"});
                if (nm_connector.currentPipe != req.pipe) {
                    nm_connector.stopServer();
                    if (Storage.getBool("debug"))
                        console.info("Restarting server, pipe="+req.pipe);
                    nm_connector.startServer(req.pipe);
                    nm_connector.currentPipe = req.pipe;
                }
            }
        }
    );

}, true);


function addTab(url, win_id) {
    var args = {url: url};
    if (win_id)
        args.windowId = parseInt(win_id);

    chrome.tabs.create(args, function (tab) {});
}


function showInfo(args) {
    var win_id = args.win_id;
    context[win_id].info_args = args;
    var panel = context[win_id].panelWindow;
    if (panel && !panel.closed) {
        panel.showInfo(args);
    } else {
        var opt = {
            type: "basic",
            title: (args.errorCode == 1 ? "iMacros" : "iMacros Error"),
            message: args.message,
            iconUrl: "skin/logo48.png",
            isClickable: true

            // NOTE: buttons looks really weird so they commented out
            // , buttons: [
            //     {title: "Edit", iconUrl: "skin/edit.png"},
            //     {title: "Help", iconUrl: "skin/help.png"}
            // ]
        };
        chrome.notifications.create(win_id.toString(), opt, function(n_id) {
            // not much to do here
        });

        chrome.notifications.onClicked.addListener(function(n_id) {
            var w_id = parseInt(n_id);
            if (isNaN(w_id) || !context[w_id] || !context[w_id].info_args)
                return;
            var info = context[w_id].info_args;
            if (info.errorCode == 1)
                return;    // we have plain Info message; nothing to do

            // for error messages since we have only one 'button'
            // we most probably want look at macro code,
            edit(info.macro, true);
        });
    }
}

//制限解除
function getLimits() {
    let defaultLimits = {
        maxVariables: 99999,
        maxCSVRows: 99999,
        maxCSVCols: 99999,
        maxMacroLen: 99999,
        maxIterations: 99999
    }

    return afio.isInstalled().then(
        installed => {
            if (installed) {
                return afio.queryLimits().catch(() => defaultLimits)
            } else {
                return defaultLimits
            }
        })
}

function isPersonalVersion() {
    return getLimits()
    //制限解除
        .then(limits =>
              Object.values(limits).every(x => x == "unlimited")
        //return Promise.resolve(true);
             )
}


window.addEventListener("unload", function(event) {
    nm_connector.stopServer();
});

// remove panel when its parent window is closed
chrome.windows.onRemoved.addListener(function(win_id) {
    if (!context[win_id])
        return;
    var panel = context[win_id].panelWindow;
    if (panel && !panel.closed) {
        panel.close();
    }
});



======================================================================
FILE PATH: browse.html
======================================================================
<html>
  <head>
    <title>iMacros</title>
    <link rel="stylesheet" type="text/css"
          href="skin/common.css" />
    <link rel="stylesheet" type="text/css"
          href="skin/browse.css" />
    <script src="browse.js"></script>
    <script src="utils.js"></script>

  </head>
  <body>
    <div id="container" class="vbox">
      <div id="tree-view" class="box">
        <iframe id="tree-iframe" src="folderView.html"></iframe>
      </div>
      <div id="button-container" class="hbox centered">
        <div id="button-ok" class="button">OK</div>
        <div id="button-cancel" class="button">Cancel</div>
      </div>
      <!-- <div class="hbox centered"> -->
      <!--   <div id="new-dir" class="button">Make new directory</div> -->
      <!-- </div> -->
    </div>
  </body>


</html>



======================================================================
FILE PATH: browse.js
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/

function cancel() {
    window.close();
}


function choose() {
    var doc = window.frames["tree-iframe"].contentDocument;
    var path = doc.getElementById("path").value;
    if (!path)
        return;
    opener.savePath(args.which, path);
    window.close();
}

window.addEventListener("load", function() {
    document.getElementById("button-ok").addEventListener("click", choose);
    document.getElementById("button-cancel").addEventListener("click", cancel);
    // prevent right-click
    document.body.oncontextmenu = function(e) {
        e.preventDefault();
        return false;
    };
    asyncRun(function() {
        // resizeToContent(window, document.getElementById("container"));
        window.resizeTo(260, window.outerHeight+60);
        window.moveTo(200, 200);
    });
});



======================================================================
FILE PATH: communicator.js
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/


// incapsulates all content scripts-extensions communications
function Communicator() {
    this.handlers = new Object();
    this.addListeners();
}

// add listener for extension events
Communicator.prototype.addListeners = function() {
    // listen to requests from content-scripts
    chrome.extension.onRequest.addListener(
        function(msg, sender, callback) {
            if (!sender.tab)
                return;
            communicator.handleMessage(msg, sender.tab.id, callback);
        }
    );
    
    chrome.windows.onRemoved.addListener(function(win_id) {
        // remove all handlers bind to the window
        for (var topic in communicator.handlers) {
            var len = communicator.handlers[topic].length, i;
            var junk = new Array();
            for (i = 0; i < len; i++) {
                if (communicator.handlers[topic][i].win_id == win_id) {
                    junk.push(communicator.handlers[topic][i].handler);
                }
            }
            for (i = 0; i < junk.length; i++) {
                communicator.unregisterHandler(topic, junk[i]);
            }
        }
    });
};



// register handlers for specific content script messages
Communicator.prototype.registerHandler = function(topic, handler, win_id) {
    if (!(topic in this.handlers))
        this.handlers[topic] = new Array();
    this.handlers[topic].push({handler: handler, win_id: win_id});
};

Communicator.prototype.unregisterHandler = function(topic, handler) {
    if (!(topic in this.handlers))
        return;
    for (var i = 0; i < this.handlers[topic].length; i++) {
        if (this.handlers[topic][i].handler == handler) {
            this.handlers[topic].splice(i, 1);
            break;
        }
    }
};

// handle message from script
Communicator.prototype.handleMessage = function(msg, tab_id, callback) {
    if (msg.topic in this.handlers) {
        chrome.tabs.get(tab_id, function(tab) {
            if (!tab)
                return;
            communicator.handlers[msg.topic].forEach( function(x) {
                if (x.win_id && x.win_id == tab.windowId) {
                    // if win_id is set then call callback only if
                    // it is set for the win_id the message came from
                    x.handler(msg.data, tab_id, callback);
                    // assume we have only one handler per window
                    // and callback is called inside the handler
                    return;
                } else {
                    // browser-wide message handler
                    // currently we have only run-macro topic for
                    // ookmarklet macros
                    x.handler(msg.data, tab_id);
                    if (callback)
                        callback();
                    return;
                }
            });
        });
    } else {
        console.warn("Communicator: unknown topic "+msg.topic);
    }
};


// send message to specific tab
Communicator.prototype.postMessage =
    function(topic, data, tab_id, callback, frame)
{
    chrome.tabs.sendRequest(
        tab_id,
        {topic: topic, data: data, _frame: frame},
        callback
    );
};

Communicator.prototype.sendMessage =
    function(topic, data, tab_id, frame)
{
    return new Promise(function(resolve, reject) {
        chrome.tabs.sendMessage(
            tab_id,
            {topic: topic, data: data, _frame: frame},
            resolve
        );
    });
};

// broadcast message
Communicator.prototype.broadcastMessage = function(topic, data, win_id) {
    if (win_id) {
        chrome.tabs.getAllInWindow(win_id, function(tabs) {
            if (!tabs)
                return;
            tabs.forEach( function(tab) {
                chrome.tabs.sendRequest(tab.id, {topic: topic, data: data},
                                        function () {});
            });
        });
    } else {
        chrome.windows.getLastFocused(function (win) {
            win.tabs.forEach( function(tab) {
                chrome.tabs.sendRequest(tab.id, {topic: topic, data: data},
                                        function () {});
            });
        });
    }
};


var communicator = new Communicator();



======================================================================
FILE PATH: context.js
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/

// Context to store browser window-specific information

var context = {
    init: function(win_id) {
        this.attachListeners();
        context[win_id] = new Object();
        context[win_id].mplayer = new MacroPlayer(win_id);
        context[win_id].recorder = new Recorder(win_id);
        context[win_id].state = "idle";
    },

    updateState: function(win_id, state) {
                // set browser action icon 
        switch(state) {
        case "playing": case "recording":
            badge.setIcon(win_id, "skin/stop.png");
            break;
        case "paused":
            // TODO: switch to tab where replaying was paused
            // after unpause
            badge.setIcon(win_id, "skin/play.png");
            break;
        case "idle":
            badge.setIcon(win_id, "skin/logo19.png");
            if (Storage.getBool("show-updated-badge")) {
                badge.setText(win_id, "New");
            } else {
                badge.clearText(win_id);
            } 
            break;
        }
        // update panel
        var panel = this[win_id].panelWindow;
        if (panel && !panel.closed)
            panel.updatePanel(state);
        this[win_id].state = state;
    },
    
    onCreated: function (w) {
        if (w.type != "normal")
            return;
        
        context[w.id] = new Object();
        context[w.id].mplayer = new MacroPlayer(w.id);
        context[w.id].recorder = new Recorder(w.id);
        this.updateState(w.id, "idle");
    },

    onRemoved: function (id) {
        if (context[id]) {
            var t;
            if (t = context[id].mplayer) {
                t.terminate();
                delete context[id].mplayer;
            }
            if (t = context[id].recorder) {
                if (t.recording)
                    t.stop();
                delete context[id].recorder;
            }
            if (context[id].dockInterval) {
                clearInterval(context[id].dockInterval);
                context[id].dockInterval = null;
            }
            delete context[id];
        }
    },

    onTabUpdated: function(tab_id, changeInfo, tab) {
        if (!context[tab.windowId])
            return;
        // set icon after tab is updated
        switch (context[tab.windowId].state) {
        case "playing": case "recording":
            badge.setIcon(tab.windowId, "skin/stop.png");
            break;
        case "paused":
            badge.setIcon(tab.windowId, "skin/play.png");
            break;
        case "idle":
            badge.setIcon(tab.windowId, "skin/logo19.png");
            if (Storage.getBool("show-updated-badge")) {
                badge.setText(tab.windowId, "New");
            } else {
                badge.clearText(tab.windowId);
            }
            break;
        }
    },
    
    attachListeners: function() {
        chrome.windows.onCreated.addListener(
            context.onCreated.bind(context)
        );
        chrome.windows.onRemoved.addListener(
            context.onRemoved.bind(context)
        );
        chrome.tabs.onUpdated.addListener(
            context.onTabUpdated.bind(context)
        );
    },

    registerDfHandler: function(win_id) {
        for (var i = 0; i < this.df_handlers.length; i++)
            if (this.df_handlers.indexOf(win_id) != -1)
                return;
        this.df_handlers.push(win_id);
    },

    unregisterDfHandler: function(win_id) {
        var idx = this.df_handlers.indexOf(win_id);
        if (idx != -1)
            this.df_handlers.splice(idx, 1);
    },
    
    on_df: function(dl, suggest) {
        for (var i = 0; i < this.df_handlers.length; i++) {
            var mplayer = context[this.df_handlers[i]].mplayer;
            if (mplayer && mplayer.onDeterminingFilename(dl, suggest))
                return;
        }
    }

};


// This event has a weird condition that an extension can register only
// one listener. So it's done here, at the moment of extension initialization
context.df_handlers = new Array();
chrome.downloads.onDeterminingFilename.addListener(
    context.on_df.bind(context)
);



======================================================================
FILE PATH: EULA.txt
======================================================================
End User License Agreement

READ THIS END USER LICENSE AGREEMENT ("EULA") BEFORE INSTALLING OR USING THE PRODUCT TO WHICH THIS EULA APPLIES. BY ACCEPTING THIS EULA, COMPLETING THE REGISTRATION PROCESS, AND/OR INSTALLING OR USING THE PRODUCT, YOU AGREE ON BEHALF OF YOURSELF AND YOUR COMPANY (IF APPLICABLE) TO THE TERMS BELOW. IF YOU DO NOT AGREE WITH THESE TERMS, OR DO NOT HAVE THE AUTHORITY TO BIND YOUR COMPANY, DO NOT INSTALL, REGISTER FOR OR USE THE PRODUCT, AND DESTROY OR RETURN ALL COPIES OF THE PRODUCT.  ONCE YOU HAVE DONE THIS, YOU MAY REQUEST FROM THE POINT OF PURCHASE A FULL REFUND OF THE LICENSE FEES, IF ANY, PAID FOR THE PRODUCT (OR, IF THE PRODUCT IS PROVIDED TO YOU AS A HOSTED SERVICE, A REFUND OF THE PREPAID SERVICE FEES FOR THE REMAINDER OF THE SUBSCRIPTION PERIOD OF THE PRODUCT). SUCH REQUEST MUST BE COMPLETED WITHIN THIRTY (30) DAYS OF DELIVERY OF THE PRODUCT TO YOU. UNLESS OTHERWISE SPECIFIED IN THIS EULA, PROGRESS SOFTWARE CORPORATION IS THE LICENSOR OF THE PRODUCT. THE LICENSOR MAY BE REFERRED TO HEREIN AS "Licensor", "we", "us", or "our". IF YOU ARE AGREEING TO THIS EULA ON BEHALF OF YOURSELF IN YOUR INDIVIDUAL CAPACITY, THEN YOU ARE THE LICENSEE AND YOU MAY BE REFERRED TO HEREIN AS "Licensee", "you", or "your". IF YOU ARE AGREEING TO THIS EULA ON BEHALF OF YOUR COMPANY, THEN YOUR COMPANY IS THE LICENSEE AND ANY REFERENCES TO "Licensee", "you", or "your" WILL MEAN YOUR COMPANY.

This EULA includes the following sections: 
1. GENERAL TERMS AND CONDITIONS - these terms apply to all Products;
2.A.	TERMS FOR ON-PREMISE PRODUCTS - these terms apply to Products that you or Permitted Third Parties install on computers;
2.B.	TERMS FOR HOSTED SERVICES - these terms apply to Products that we host;
3.	PRODUCT FAMILY SPECIFIC TERMS - these terms apply to all Products that are part of the family of Products referenced in this section; and  
4.	PRODUCT SPECIFIC TERMS - these terms apply to specific Products referenced in this section.

1. GENERAL TERMS AND CONDITIONS

1.1. Definitions.
1.1.1. "Affiliate" means any legal entity that directly or indirectly controls, is controlled by, or is under common control with you or us. For the purposes of this definition, "control" means ownership, directly or indirectly, of more than fifty percent (50%) of the voting shares or other equity interest in an entity.
1.1.2. "Applicable Laws" means national, federal, state, and local laws, rules, and regulations including, without limitation, those laws and regulations relating to data privacy and security in each applicable jurisdiction.
1.1.3. "Authorized Reseller" means a third party who is not our Affiliate and who is authorized by us or our Affiliate to resell the Product.
1.1.4. "Authorized User" means you, your employee or a third-party consultant or agent that you authorize to use the Product for your benefit in accordance with section 1.2.3 (Third Party Use).
1.1.5. "Documentation" means any technical instructions or materials describing the operation of the Product made available to you (electronically or otherwise) by us for use with the Product, expressly excluding any user blogs, reviews or forums.
1.1.6. "Hosted Services" means computer software program(s), content and related services provided by us on a software-as-a-service basis through computers we or our Affiliates or our respective contractors (including cloud infrastructure suppliers) control.
1.1.7. "Intellectual Property Rights" means any and all current and future 
		(a) rights associated with works of authorship, including copyrights, mask work rights, and moral rights; 
		(b) trademark or service mark rights; 
		(c) trade secret rights; 
		(d) patents, patent rights, and industrial property rights; 
		(e) layout design rights, design rights, and other proprietary rights of every kind and nature other than trademarks, service marks, trade dress, and similar rights; and (f) registrations, applications, renewals, extensions, or reissues of any of (a) to (e) , in each case, in any jurisdiction throughout the world. 
1.1.8. "On-Premise Product(s)" means computer software program(s) provided to you to download, install and use on computer(s) controlled directly or indirectly by you. 
1.1.9. "Order" means a written or electronic order document entered into between you and us (or our Affiliate or an Authorized Reseller) for the Product.  Unless an Order says something different, each Order will be governed by the terms of this EULA and include the name of the Product being licensed and any usage limitations, applicable fees, and any other details related to the transaction.
1.1.10. "Our Technology" means any software, code, tools, libraries, scripts, application programming interfaces, templates, algorithms, data science recipes (including any source code for data science recipes and any modifications to such source code), data science workflows, user interfaces, links, proprietary methods and systems, know-how, trade secrets, techniques, designs, inventions, and other tangible or intangible technical material, information and works of authorship underlying or otherwise used to make available the Product, including, without limitation, all Intellectual Property Rights therein and thereto. 
1.1.11. "Permitted Third Party" has the meaning given in section 1.2.3 (Third Party Use). 
1.1.12. "Product" means the On-Premise Product(s) or Hosted Services, as applicable, identified in an Order, and any Updates.
1.1.13. "Update" means any update, enhancement, error correction, modification or new release to the Product that we make available to you.

1.2. General License Terms, Restrictions and Order of Precedence.
1.2.1. General License Terms.  The Product is licensed, not sold, to you by us under the terms of this EULA and the Order. The scope of license granted by us to you for the Product is set out in section 3 (Product Family Specific Terms) and section 4 (Product Specific Terms).
1.2.2. Authorized Users.  Anything your Authorized Users do or fail to do will be considered your act or omission, and you accept full responsibility for any such act or omission to the extent you would be liable if it were your act or omission.
1.2.3. Third Party Use.  You may allow your agents, contractors and outsourcing service providers (each a "Permitted Third Party") to use the Product(s) licensed to you hereunder solely for your benefit in accordance with the terms of this EULA and you are responsible for any such Permitted Third Party's compliance with this EULA in such use. Any breach by any Permitted Third Party of the terms of this EULA will be considered your breach.  
1.2.4. Restrictions.  Except as otherwise expressly permitted in this EULA, you will not (and will not allow any of your Affiliates or any third party to): 
		(a) copy, modify, adapt, translate, or otherwise create derivative works of the Product, Documentation, or any software, services, or other technology of third party vendor(s) or hosting provider(s) that we or our Affiliate engage;
		(b) disassemble, decompile or "unlock", decode or otherwise reverse translate or engineer, or attempt in any manner to reconstruct or discover the source code or underlying structure, ideas, or algorithms of the Product except as expressly permitted by law in effect in the jurisdiction in which you are located; 
		(c) rent, lease, sell, distribute, pledge, assign, sublicense or otherwise transfer or encumber rights to the Product;   
		(d) make the Product available on a timesharing or service bureau basis or otherwise allow any third party to use or access the Product;
		(e) remove or modify any proprietary notices, legends, or labels on the Product or Documentation; 
		(f) use or access the Product in a manner that: (i) violates any Applicable Laws; (ii) violates the rights of any third party; (iii) purports to subject us or our Affiliates to any other obligations; (iv) could be fraudulent; or (v) is not permitted under this EULA; 
		(g) use the Product to develop, test, support or market products that are competitive with and/or provide similar functionality to the Product; or
		(h) permit your Affiliates to access or use the Product unless specifically authorized elsewhere in this EULA or the Order.
1.2.5. Limitations on Evaluation or Trial Licenses.  If the Product is licensed to you on an evaluation or trial basis, then you may use the Product only for such purposes until the earlier of: 
	(a) the end of the evaluation period, if any, specified in the Order, this EULA or otherwise communicated by us to you at the time of delivery; or 
	(b) the start date of a paid for license to the Product; or 
	(c) termination in accordance with the terms of this EULA. You may not extend the evaluation period by uninstalling and re-installing the Product(s) or by any other means other than our written consent. You must not use the Product in a production environment. You will be required to pay for a license for the Product at our then applicable license price if you continue to use the Product, whether in a production or non-production environment, after the evaluation license expires or terminates, and the terms and conditions of the EULA in effect at that time will apply to your continued use of the Product. A Product licensed to you on an evaluation or trial basis may be subject to one or more usage limits specified in section 3 (Product Family Specific Terms), section 4 (Product Specific Terms), the Order or otherwise communicated at the time of delivery (including posting of such limits at the location where you download the Product for evaluation). We may, at our sole discretion, decide whether to offer any maintenance and support for the Product during the evaluation period, and to include any conditions or limits on such maintenance and support. You may not circumvent any technical limitations included in the Product licensed to you on an evaluation or trial basis.
1.2.6. Redistribution.  If the Order or section 3 (Product Family Specific Terms) or section 4 (Product Specific Terms) grants you the express right to redistribute or offer access to all or a portion of the Product ("Redistributables"), then, in conjunction with any such grant, you must comply with any limitations or requirements specified in the Order, section 3 (Product Family Specific Terms) or section 4 (Product Specific Terms), as applicable, and you must distribute or offer access to the Redistributables subject to a license agreement or terms of use between you and each third party receiving or accessing the Redistributables ("your customer") that: 
		(a) protects our interests consistent with the terms contained in this EULA, 
		(b) prohibits your customer from any further distribution of the Redistributables (unless expressly permitted pursuant to section 3 (Product Family Specific Terms) or section 4 (Product Specific Terms)), 
		(c) includes a limitation of damages clause that, to the maximum extent permitted by applicable law, disclaims on behalf of us, our Affiliates or our or their respective licensors, suppliers or Authorized Resellers, liability for any and all damages, whether direct, special, incidental or consequential damages, 
		(d) contains terms substantially similar to those in subparts (a) through (g) of section 1.2.4 (Restrictions), section 1.5.1 (Export Compliance) and section 1.5.2 (U.S. Government Customers), and 
		(e) includes a notice substantially similar to section 1.2.7 (Third Party Notices).  
1.2.7. Third Party Notices.  The Product may contain or be accompanied by certain third-party components which are subject to additional restrictions.  These components, are identified in, and subject to, special license terms and conditions which, in the case of On-Premise Product(s), are set out in the "readme.txt" file, the "notices.txt" file, or the "Third Party Software" file accompanying the Product or portions thereof, and in the case of Hosted Services, are set out in the third-party license agreement or notices that comes with the third-party component or is otherwise provided on the web page on which such third-party component is made available ("Special Notices"). The Special Notices include important licensing and warranty information and disclaimers.  Unless otherwise expressly stated for a given third-party component, all such third-party components may be used solely in connection with the use of the Product subject to and in accordance with the terms and conditions of this EULA and the Special Notices. In the event of conflict between the Special Notices and the other portions of this EULA, the Special Notices will take precedence (but solely with respect to the third-party component(s) to which the Special Notice relates).
1.2.8. Order of Precedence between EULA and Order.  If there is any conflict between the terms and conditions in the Order and the terms and conditions of this EULA, or if the Order changes any of the terms of this EULA, the terms and conditions of the Order will apply, except if the Order is between you and an Authorized Reseller, or the Order is issued/generated by you. In the case where the Order is between you and an Authorized Reseller, the terms of the Order will apply subject to the following:  
		(a) any terms and conditions in the Order imposing obligations on the Authorized Reseller that are in addition to or different from the obligations we have to you pursuant to this EULA will be born solely by the Authorized Reseller and our obligations to you and limits on our liability will be governed solely by the terms and conditions of this EULA and 
		(b) any terms and conditions that conflict with or would otherwise alter any of the following under this EULA will have no effect unless expressly agreed to in a written instrument executed by us: our ownership rights, yours and our confidentiality obligations, your export compliance obligations, limitations on your rights as a U.S. Government customer (if applicable), our audit rights, restrictions on your right to assign, our publicity rights or governing law and jurisdiction. In cases where the Order is issued/generated by you, the terms and conditions of Section 1.19.2. of this EULA, governing a purchase order or other document you supply in connection with this EULA, shall apply to such Order.
1.2.9. Order of Precedence within EULA.  If there is any conflict among the terms and conditions of this EULA, or if a section changes the terms of another section within this EULA, the order of precedence will be as follows: first, section 4 (Product Specific Terms) (if any); second, section 3 (Product Family Specific Terms) (if any); third, section 2.A (Terms for On-Premise Products) and/or section 2.B (Terms for Hosted Services), as applicable; and fourth and finally, section 1 (General Terms and Conditions).

1.3. License Types.
1.3.1. Overview of License Types.  The license type for the Product will, unless otherwise specified in this EULA, be one of the following license types: perpetual, term or subscription.  This will be confirmed in the Order or will be the default license type listed in section 3 (Product Family Specific Terms) or section 4 (Product Specific Terms).
1.3.2. Perpetual License Type.  Your license to use the Product will continue in perpetuity unless earlier terminated in accordance with the terms of this EULA. 
1.3.3. Term License Type.  Your license to use the Product will continue until the expiration of the term identified in the Order unless earlier terminated in accordance with the terms of this EULA. If we continue to make the Product generally available to our customers, you may purchase a new term license for the Product from us or our Authorized Reseller. 
1.3.4. Subscription License Type. Your license to use the Product will continue until the expiration of the subscription period identified in the Order unless earlier terminated in accordance with the terms of this EULA. The procedure for renewing your license to the Product is set out in section 3 (Product Family Specific Terms) or section 4 (Product Specific Terms). If you upgrade your subscription to the Product, the upgrade will take effect immediately and you will be charged and must pay the applicable fee, and the term of your then-current subscription period may be extended, as described at the time you upgrade. You may not downgrade a subscription to the Product.

1.4. Our Business Principles.  We will apply the principles set out in our Code of Conduct and Business Ethics (published on our website at http://investors.progress.com/governance.cfm) in our performance under this EULA.

1.5. Export Compliance and U.S. Government Customers.  
1.5.1. Export Compliance.  Export laws and regulations of the United States and any other relevant local export laws and regulations apply to the Products. You agree that such export control laws, including, without limitation, the U.S. Export Administration Act and its associated regulations, govern your use of the Product (including technical data), and you agree to comply with all such export laws and regulations (including "deemed export" and "deemed re-export" regulations). You agree that no data, information and/or Product (or direct product thereof) will be exported, directly or indirectly, in violation of these laws, or will be used for any purpose prohibited by these laws including, without limitation, nuclear, chemical, or biological weapons proliferation, or development of missile technology. 
1.5.2. U.S. Government Customers.  If the Product is being acquired by or on behalf of the U.S. Government or by a U.S. Government prime contractor or subcontractor (at any tier), then the U.S. Government's rights in the Product will be only as set out herein. The Product and Documentation are "commercial items" as that term is defined at 48 C.F.R. 2.101, consisting of "commercial computer software" and "commercial software documentation" as such terms are used in 48 C.F.R. 12.212. Consistent with 48 C.F.R. 12.212 and 48 C.F.R. 227.7202-1 through 227.7202-4, all U.S. Government end users acquire the Product and such Documentation with only those rights set out herein. 

1.6. IP Ownership and Feedback.  
1.6.1. IP Ownership.  The Product, Our Technology, Documentation, and all other current or future intellectual property developed by us or our Affiliates, and all worldwide Intellectual Property Rights in each of the foregoing and all Updates, upgrades, enhancements, new versions, releases, corrections, and other modifications thereto and derivative works thereof, are the exclusive property of us or our Affiliates or our or their licensors or suppliers. Except for the rights and licenses expressly granted herein, all such rights are reserved by us and our Affiliates and our or their licensors and suppliers.  All title and Intellectual Property Rights in and to the content that may be accessed through use of the Product is the property of the respective content owner and may be protected by applicable copyright or other intellectual property laws and treaties. This EULA grants you no rights to use such content.
1.6.2. Feedback.  If you provide us any ideas, thoughts, criticisms, suggested improvements or other feedback related to Our Technology (collectively "Feedback") you own the Feedback and you grant to us a worldwide, royalty-free, fully paid, perpetual, irrevocable license to use, reproduce, modify, translate, distribute, perform, display, import, sell, license, offer for sale, make, have made and otherwise exploit the Feedback in any form, media, or technology, whether now known or hereafter developed, and to allow others to do the same without restriction or obligation of any kind, on account of confidential information, intellectual property rights or otherwise, and may incorporate into our products or services any service, product, technology, enhancement, documentation or other development ("Improvement") incorporating or derived from any Feedback with no obligation to license or to make available the Improvement to you or any other person or entity. This is true whether you provide the Feedback through use of the Product or through any other method of communication with us, unless we have entered into a separate agreement with you that provides otherwise. 

1.7. Maintenance.  
1.7.1. Our Maintenance and Support Policies.  If we offer and you purchase maintenance and support for the Product, then it will be provided in accordance with our then current maintenance and support policies for the applicable Product in effect at the time of purchase. You may access our maintenance and support policies by clicking on the applicable Product family link located at https://www.progress.com/support. 
1.7.2. Maintenance and Support for Perpetual or Term License Types.  For Perpetual and Term License Types, unless otherwise expressly stated by us in the Order, first year annual maintenance and support (if offered by us) is required for the Product and starts on the date the Product is delivered. Thereafter, you may choose to purchase annual maintenance and support (if offered by us). If you do not purchase renewal maintenance and support services for a Product, then you will not receive any maintenance and support services for that Product and will have no entitlement to any benefits of maintenance and support services including, bug fixes, patches, upgrades, enhancements, new releases or technical support. If you want to reinstate lapsed maintenance and support services on a Product, and we offer reinstatement to our customers, then you may re-instate maintenance and support services by paying the then-current fee, plus a reinstatement fee for the lapsed maintenance and support period in accordance with our maintenance and support reinstatement policies then in effect.
1.7.3. Maintenance and Support for Subscription License Type.  If the license type for the Product licensed to you is the subscription license type, then maintenance and support (if offered by us) is included in the subscription fees for each subscription period. 

1.8. Fees and Taxes.  
1.8.1. Payment Terms and Taxes.  All fees payable to us are payable in the currency specified in the Order, or if no currency is specified, in United States Dollars, are due within 30 days from the invoice date and, except as otherwise expressly specified herein, are non-cancellable and non-refundable. We may charge you interest at a rate of 1.5% per month (or the highest rate permitted by law, if less) on all overdue payments. You agree to pay any sales, value-added or other similar taxes imposed by applicable law that we must pay on such fees, except those based on our income. Invoices may be issued by our Affiliate. If you and we agree that you will pay by credit card, you will provide us with valid and updated credit card information and you authorize us to store such information and bill such credit card for all fees applicable: (a) at the time that you order the Product and (b) at the time of any renewal or upgrade. 
1.8.2. Fees for Renewal Subscription Licenses.  If the license type for the Product licensed to you is the Subscription License Type then each renewal subscription will be calculated at the then-current price offered for the Product at the time of renewal. 
1.8.3. Fees for Renewal Maintenance Terms.  If the license type for the Product licensed to you is a Perpetual license or Term license, then, unless otherwise specified in the Order or in section 3 (Product Family Specific Terms) or section 4 (Product-Specific Terms), the fee for an optional annual renewal maintenance and support term for the Product will be calculated based on the annual rate applicable for the initial maintenance and support term or immediately preceding renewal maintenance and support term, whichever is applicable, plus a rate increase, if applicable, calculated at the lesser of any standard price increase or CPI (or equivalent index) after applying any increases as a consequence of our Lifetime Support policy, if applicable.
1.8.4. Orders between You and Our Authorized Reseller.  Notwithstanding the above terms of this section 1.8 (Fees and Taxes), if you purchased your license to the Product and/or maintenance and support from an Authorized Reseller, then the fees will be set out in the Order between you and the Authorized Reseller. The Authorized Reseller may be responsible for billing and/or collecting payment from you and if so, the billing and collection terms agreed to between you and the Authorized Reseller may differ from the terms set out in this section 1.8 (Fees and Taxes). 
1.8.5. No Reliance on Future Availability of any Product or Update.  You agree that you have not relied on the future availability of any Product or Updates in your purchasing decision or in entering into the payment obligations in your Order.

1.9. Warranties.
1.9.1. Authority.  Each party represents and warrants that it has the legal power and authority to enter into this EULA.
1.9.2. Product Compliance with Documentation.  We warrant to you that, for six (6) months from delivery (in the case of an On-Premise Product) or for the duration of the license (in the case of a Hosted Service), the Product will comply with the applicable Documentation in all material respects. Your exclusive remedy, and our sole liability, with respect to any breach of this warranty will be for us to use commercially reasonable efforts to promptly correct the non-compliance (provided that you notify us in writing within the warranty period and allow us a reasonable cure period).  If we, at our discretion, reasonably determine that correction is not economically or technically feasible, we may terminate your license to the Product and provide you a full refund of the fees paid to us with respect to the Product (in the case of an On-Premise Product) or a refund of the prepaid fees for the unused portion of the license period (in the case of a Hosted Service). Delivery of additional copies of, or Updates to, the Product will not restart or otherwise affect the warranty period.
1.9.3. Warranty Exclusions.  The warranty specified in section 1.9.2 (Product Compliance with Documentation) does not cover any Product provided on an unpaid evaluation or trial basis, or defects to the Product due to accident, abuse, service, alteration, modification or improper installation or configuration by you, your Affiliates, your or their personnel or any third party not engaged by us. 
1.9.4. Warranty Disclaimers.  EXCEPT FOR THE WARRANTIES EXPRESSLY STATED IN THIS SECTION 1.9 OR THE ADDITIONAL WARRANTIES (IF ANY) EXPRESSLY STATED IN SECTION 3 (PRODUCT FAMILY SPECIFIC TERMS) OR SECTION 4 (PRODUCT SPECIFIC TERMS), THE PRODUCT, DOCUMENTATION AND OUR TECHNOLOGY  ARE PROVIDED "AS IS", WITH ALL FAULTS, AND WE DISCLAIM ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, TITLE, NONINFRINGEMENT, AVAILABILITY, ERROR-FREE OR UNINTERRUPTED OPERATION, AND ANY WARRANTIES ARISING FROM COURSE OF DEALING, COURSE OF PERFORMANCE, OR USAGE OF TRADE. TO THE EXTENT THAT WE MAY NOT AS A MATTER OF APPLICABLE LAW DISCLAIM ANY IMPLIED WARRANTY, THE SCOPE AND DURATION OF SUCH WARRANTY WILL BE THE MINIMUM PERMITTED UNDER APPLICABLE LAW.

1.10. Indemnification.
1.10.1. Our Indemnification Obligation.
1.10.1.1. Intellectual Property Infringement.  We will defend you, and your officers, directors, employees, and agents from and against any and all third party claims, lawsuits, and proceedings alleging that your use of the Product, in accordance with the terms and conditions of this EULA, constitutes a direct infringement or misappropriation of such third party's patent, copyright or trade secret rights (the "IP Claim"), and we will indemnify you for damages finally awarded against you by a court of competent jurisdiction with respect to the IP Claim. 
1.10.1.2. Exceptions.  We will not indemnify you to the extent that the alleged infringement or misappropriation results from (a) use of the Product in combination with any other software or item not supplied by us; (b) failure to promptly implement an Update provided by us pursuant to 1.10.1.3 (Our Options); (c) modification of the Product not made or provided by us; or (d) use of the Product in a manner not permitted by this EULA. We also will not indemnify you if we notify you of our decision to terminate this EULA, and the license to the Product granted hereunder, in accordance with section 1.10.1.3 (Our Options) and you have not ceased all use of the Product within thirty (30) days of such notification. 
1.10.1.3. Our Options.  If a final injunction is, or we reasonably believe that it could be, obtained against your use of the Product, or if in our opinion the Product is likely to become the subject of a successful claim of infringement, we may, at our option and expense, (a) replace or modify the Product so that it becomes non-infringing (provided that the functionality is substantially equivalent), (b) obtain for you a license to continue to use the Product, or (c) if neither (a) nor (b) are reasonably practicable, terminate this EULA on thirty (30) days' notice and, if the Product was licensed to you on a Perpetual License or Term License basis, refund to you the license fee paid to us for the Product less an amount for depreciation determined on a straight-line five year (or actual term if shorter) depreciation basis with a commencement date as of the date of delivery of the Product, or if the Product was licensed to you on a Subscription License basis, refund to you the unused portion of the fees paid in advance to us for the then-current subscription period for the Product. THE INDEMNIFICATION PROVISIONS SET OUT IN THIS SECTION 1.10.1 STATE OUR ENTIRE LIABILITY AND YOUR SOLE AND EXCLUSIVE REMEDY WITH RESPECT TO ANY INFRINGEMENT OR ALLEGED INFRINGEMENT BY US OF ANY INTELLECTUAL PROPERTY RIGHTS OR PROPRIETARY RIGHTS IN RESPECT OF THE PRODUCT OR ITS USE.
1.10.2. Your Indemnification Obligation.
1.10.2.1. Indemnification for Third Party-Claims.  To the extent permitted by applicable law, you will defend us and our Affiliates, and our and their respective officers, directors, employees, and agents from and against any and all third party claims, lawsuits, and proceedings that arise or result from (a) your breach of this EULA, (b) your use, distribution and/or licensing of the Redistributables, if applicable, except to the extent it arises from an IP Claim covered under section 1.10.1 above, or (c) your failure or alleged failure to comply with Applicable Laws or any violation of a third party's rights in connection with your use of the Product (each a "Third-Party Claim" and collectively "Third-Party Claims") and you will indemnify for damages finally awarded by a court of competent jurisdiction with respect to any Third-Party Claim. 
1.10.3. Control of the Defense or Settlement. For any indemnification obligation covered in section 1.10.1,"Indemnifying Party" means us, "Indemnified Party" means you, and "Claim" means an IP Claim. For any indemnification obligation covered in section 1.10.2, "Indemnifying Party" means you, "Indemnified Party" means us, and "Claim" means a Third-Party Claim. The Indemnified Party must provide the Indemnifying Party with prompt written notice of a Claim; however, the Indemnified Party's failure to provide or delay in providing such notice will not relieve the Indemnifying Party of its obligations under this section except to the extent the Indemnifying Party is prejudiced by the Indemnified Party's failure or delay. The Indemnified Party will give the Indemnifying Party full control of the defense and settlement of the Claim as long as such settlement does not include a financial obligation on or admission of liability by the Indemnified Party. If the Indemnified Party does not do so, then the Indemnified Party waives the Indemnifying Party's indemnification obligations under section 1.10.1 or 1.10.2, as applicable. The Indemnified Party will reasonably cooperate in the defense of the Claim and may appear, at its own expense, through counsel reasonably acceptable to the Indemnifying Party.

1.11. Confidentiality.  
1.11.1. Confidentiality Obligations.  Except as otherwise provided herein, each party agrees to retain in confidence all information and know-how transmitted or disclosed to the other that the disclosing party has identified as being proprietary and/or confidential or should reasonably  be  understood  to  be  confidential  given  the  nature  of  the  information  and  the  circumstances surrounding its disclosure, and agrees to make no use of such information and know-how except under the terms of this EULA. However, neither party will have an obligation to maintain the confidentiality of information that (a) it received rightfully from a third party without an obligation to maintain such information in confidence; (b) was known to the receiving party prior to its disclosure by the disclosing party; (c) is or becomes a matter of public knowledge through no fault of the receiving party; or (d) is independently developed by the receiving party without use of the confidential information of the disclosing party. Further, either party may disclose confidential information of the other party as required by governmental or judicial order, provided such party gives the other party prompt written notice prior to such disclosure (unless such prior notice is not permitted by applicable law) and complies with any protective order (or equivalent) imposed on such disclosure. You will treat any source code for the Product as our confidential information and will not disclose, disseminate or distribute such materials to any third party without our prior written permission. Each party's obligations under this section 1.11 will apply during the term of this EULA and for five (5) years following termination of this EULA, provided, however, that (i) obligations with respect to source code will survive forever and (ii) trade secrets will be maintained as such until they fall into the public domain.
1.11.2. Product Benchmark Results.  You acknowledge that any benchmark results pertaining to the Product are our confidential information and may not be disclosed or published without our prior written consent. This provision applies regardless of whether the benchmark tests are conducted by you or us.
1.11.3. Remedies for Breach of Confidentiality Obligations.  Each party acknowledges that in the event of a breach or threat of breach of this section 1.11, money damages will not be adequate.  Therefore, in addition to any other legal or equitable remedies, the non-breaching party will be entitled to seek injunctive or similar equitable relief against such breach or threat of breach without proof of actual injury and without posting of a bond.

1.12. Data Collection and Personal Data.
1.12.1. Data Collection through use of the Product.  THE PRODUCT MAY INCLUDE FEATURE(S) THAT (A) GATHER PRODUCT ACTIVATION, USAGE AND/OR ENVIRONMENT INFORMATION, (B) IDENTIFY TRENDS AND/OR BUGS, (C) COLLECT USAGE STATISTICS, AND/OR (D) TRACK OTHER DATA RELATED TO YOUR USE OF THE PRODUCT, AS FURTHER DESCRIBED IN THE CURRENT VERSION OF OUR PRIVACY POLICY AVAILABLE AT https://www.progress.com/legal/privacy-policy. BY YOUR ACCEPTANCE OF THE TERMS OF THIS EULA AND/OR USE OF THE PRODUCT, YOU AUTHORIZE THE COLLECTION, USE AND DISCLOSURE OF THIS DATA FOR THE PURPOSES PROVIDED FOR IN THIS EULA AND/OR THE PRIVACY POLICY. 
1.12.2. Additional Data Collection Terms.  Depending on the Product licensed to you, this EULA may contain additional data collection terms in section 3 (Product Family Specific Terms) or section 4 (Product Specific Terms) and/or, if we are hosting the Product, in section 2.B (Terms for Hosted Services). 
1.12.3.	Your Personal Data. If you determine that you will be supplying us with your Personal Data (as defined in the Data Processing Addendum referenced below) for us to process on your behalf, in the provision of maintenance and support services or hosting services (if the Product licensed to you is a Hosted Service) or during the course of any audits we conduct pursuant to section 1.14 (Audit), you may submit a written request at privacy@progress.com   for the mutual execution of a Data Processing Addendum substantially in the form we make available at https://www.progress.com/docs/default-source/progress-software/data-processing-addendum.pdf and we will enter into such Data Processing Addendum with you. To the extent there is any conflict between this EULA and such Data Processing Addendum, the Data Processing Addendum will prevail with respect to our handling and processing of your Personal Data. 
1.13. Limitation of Liability and Disclaimer of Certain Types of Damages.
1.13.1. Limitation of Liability.  EXCEPT FOR A PARTY'S INDEMNIFICATION OBLIGATIONS SET OUT IN THIS EULA OR A PARTY'S BREACH OF ITS CONFIDENTIALITY OBLIGATIONS PURSUANT TO SECTION 1.11 (CONFIDENTIALITY), OR YOUR MATERIAL VIOLATION OF OUR INTELLECTUAL PROPERTY RIGHTS OR OF THE LICENSE RESTRICTIONS SET OUT IN THIS EULA, TO THE EXTENT PERMITTED BY APPLICABLE LAW, IN NO EVENT WILL EITHER PARTY'S LIABILITY FOR ALL COSTS, DAMAGES, AND EXPENSES ARISING OUT OF OR RELATED TO THIS EULA WHETHER BASED UPON WARRANTY, CONTRACT, TORT (INCLUDING NEGLIGENCE), STRICT LIABILITY OR OTHERWISE AT LAW EXCEED, IN THE AGGREGATE, THE FEES PAID TO US FOR THE PRODUCT AND/OR SERVICE THAT IS THE SUBJECT OF THE CLAIM, PROVIDED, HOWEVER, THAT IF THE FEES PAID FOR SUCH PRODUCT AND/OR SERVICE ARE PAID ON A RECURRING BASIS, THEN THE NOT TO EXCEED LIMIT WILL BE THE FEES PAID TO US FOR THE PRODUCT AND/OR SERVICE DURING THE TWELVE (12) MONTH PERIOD IMMEDIATELY PRECEDING THE DATE THE CLAIM AROSE. OUR AFFILIATES AND LICENSORS, AND THE SUPPLIERS TO US, OUR AFFILIATES OR LICENSORS, WILL, TO THE EXTENT PERMITTED BY APPLICABLE LAW, HAVE NO LIABILITY TO YOU OR TO ANY OTHER PERSON OR ENTITY FOR DAMAGES, DIRECT OR OTHERWISE, ARISING OUT OF THIS EULA, INCLUDING, WITHOUT LIMITATION, DAMAGES IN CONNECTION WITH THE PERFORMANCE OR OPERATION OF OUR PRODUCTS OR OUR PERFORMANCE OF SERVICES. 
1.13.2	Disclaimer of Certain Types of Damages.  EXCEPT FOR A PARTY'S INDEMNIFICATION OBLIGATIONS SET OUT IN THIS EULA OR YOUR MATERIAL VIOLATION OF OUR INTELLECTUAL PROPERTY RIGHTS OR THE LICENSE RESTRICTIONS SET OUT IN THIS EULA, TO THE EXTENT PERMITTED BY APPLICABLE LAW, IN NO EVENT WILL EITHER PARTY, ITS AFFILIATES OR ITS LICENSORS OR THEIR RESPECTIVE SUPPLIERS BE LIABLE FOR ANY SPECIAL, INDIRECT, CONSEQUENTIAL, INCIDENTAL, PUNITIVE OR TORT DAMAGES ARISING IN CONNECTION WITH THIS EULA OR EITHER PARTY'S PERFORMANCE UNDER THIS EULA OR THE PERFORMANCE OF OUR PRODUCTS, OR FOR ANY DAMAGES RESULTING FROM LOSS OF USE, LOSS OF OPPORTUNITY, LOSS OF DATA, LOSS OF REVENUE, LOSS OF PROFITS, OR LOSS OF BUSINESS, EVEN IF THE PARTY, ITS AFFILIATES, ITS LICENSORS, OR ANY OF THEIR RESPECTIVE SUPPLIERS HAVE BEEN ADVISED OF THE POSSIBILITY OF THOSE DAMAGES.
1.14. Audit.  We may install and use automated license tracking, management and/or enforcement solutions with the Product, which you may not disrupt or alter.  You will maintain records in connection with this EULA and the use of the Product and any Updates and/or services provided hereunder.  Such records will include at a minimum the number of licenses purchased and being used by you.  At our expense and with reasonable written notice to you, we or a third party appointed by us may audit the records, and if necessary and as applicable, the systems on which the Product or any Update is installed for the sole purpose of ensuring compliance with the terms of this EULA.  We will have the right to conduct audits as necessary.  These audits may be conducted on site at a location where you have installed the Product, remotely from our offices, or a combination of both, if applicable to the Product. On-site audits will be conducted during regular business hours, and neither on-site nor remote audits will interfere unreasonably with your business operations. You agree to share with us copies of all records referenced herein, as well as Product log files and other information reasonably requested by us promptly following such request, but in no event more than five (5) business days following receipt of our written request (or such longer period, if applicable, that we specify in the written request). We will treat all such information obtained or accessed by us during the audit as confidential information pursuant to section 1.11 (Confidentiality) for use by us only as necessary to ensure compliance with and enforcement of the terms of this EULA. If any audit reveals that you have underpaid license, maintenance and support or subscription fees, you will be invoiced for all such underpaid fees based on our list price in effect at the time the audit is completed.  If the underpaid fees exceed five percent (5%) of the fees previously paid by you, then you will also pay our reasonable costs of conducting the audit and enforcement of this EULA.
1.15. Termination. 
1.15.1. Termination for Breach.  We may terminate this EULA by written notice at any time if you do not comply with any of your obligations under this EULA and fail to cure such failure to our satisfaction within thirty (30) days after such notice. This remedy will not be exclusive and will be in addition to any other remedies which we may have under this EULA or otherwise. 
1.15.2. Effect of Termination.  Upon expiration of your license term to the Product (if applicable) or earlier termination of this EULA, your license to access and/or use the Product and/or distribute the Redistributables (if applicable) will terminate. You must immediately cease use of the Product and destroy all copies of the Product in your possession (and required any Permitted Third Parties to do the same). Any licenses you have granted to the Redistributables in accordance with the terms and conditions of this EULA will, unless otherwise specified in section 3 (Product Family Specific Terms) or section 4 (Product Specific Terms), survive termination of this EULA.
1.15.3. Survival.  Any provisions of this EULA containing licensing restrictions, warranties and warranty disclaimers, confidentiality obligations, limitations of liability and/or indemnity terms, audits rights, and any term of this EULA which, by its nature, is intended to survive termination or expiration, will remain in effect following any termination or expiration if this EULA, as will your obligation to pay any fees accrued and owing to us as of termination or expiration.
1.16. Assignment.  You may not, without our prior written consent, assign or novate this EULA, any of your rights or obligations under this EULA, or the Products or any of our Confidential Information, in whole or in part, by operation of law, sale of assets, merger or otherwise, to any other party, including any parent, subsidiary or affiliated entity.  Your Change of Control will constitute an assignment for purposes of the preceding sentence.   A "Change of Control" will include, but not be limited to, any merger, consolidation, amalgamation, reorganization or sale, transfer or exchange of the capital stock or equity interests of you in a transaction or series of transactions which results in the holders of your capital stock or equity interests holding less than 50% of the outstanding capital stock or equity interests immediately following such transaction(s). 
1.17. Choice of Law.  This EULA is governed by the laws of the Commonwealth of Massachusetts, U.S.A., without regard to the conflict of laws principles thereof. If any dispute, controversy, or claim cannot be resolved by a good-faith discussion between the parties, then it will be submitted for resolution to a state or federal court in Boston, Massachusetts, USA, and the parties hereby irrevocably and unconditionally agree to submit to the exclusive jurisdiction and venue of such court. The Uniform Computer Information Transactions Act and the United Nations Convention on the International Sale of Goods will not apply to this EULA. 
1.18. Publicity.  You agree that we may, in our sole discretion, publicize your use of the Product, and you license to us (and our Affiliates and necessary sublicensees) any intellectual property rights required to allow us (and our Affiliates and necessary sublicensees) to use your name, trade name(s), trademark(s), service mark(s), logo(s) and domain name(s) in connection with such publicity.  
1.19. Miscellaneous.
1.19.1. Notices.  Notices of termination, material breach, your insolvency or an indemnifiable claim ("Legal Notices") must be clearly identified as Legal Notices and sent via overnight courier or certified mail with proof of delivery to the following addresses:  For us:  14 Oak Park Drive, Bedford, MA 01730, Attention: General Counsel. For you: your address set out in the Order. Legal Notices sent in accordance with the above will be effective upon the second business day after mailing.  Either party may change its address for receipt of notices upon written notice to the other party.
1.19.2. Entire Agreement.  This EULA, and any terms expressly incorporated herein by reference, will constitute the entire agreement between you and us with respect to the subject matter of this EULA and supersedes all prior and contemporaneous communications, oral or written, signed or unsigned, regarding such subject matter. Use of any purchase order or other document you supply in connection with this EULA will be for administrative convenience only and all terms and conditions stated therein will be void and of no effect. Except as otherwise expressly contemplated in this EULA, this EULA may not be modified or amended other than in writing signed by you and us.
1.19.3. Severability.  If any provision of this EULA is terminated or held by a court of competent jurisdiction to be invalid, illegal, or unenforceable, the remainder of this EULA will remain in full force and effect. 
1.19.4. Waiver.  Failure or delay in exercising any right, power, privilege or remedy hereunder will not constitute a waiver thereof.  A waiver of default will not operate as a waiver of any other default or of the same type of default on future occasions.
1.19.5. English Language.  This EULA has been drawn up in English at the express wish of the parties.  Le présent contrat a été rédigé en anglais à la demande expresse des parties.
1.19.6. Force Majeure.  Neither you nor we will be liable for any delay or failure to take any action required under this EULA (except for payment) due to any cause beyond the reasonable control of you or us, as the case may be, including, but not limited to unavailability or shortages of labour, materials, or equipment, failure or delay in the delivery of vendors and suppliers and delays in transportation.
1.19.7. Our Use of Our Affiliates.  We may, at our discretion, engage one or more of our Affiliates in the fulfilment of our obligations, including, our obligations for delivery of the Product to you and/or the provision of any maintenance and support services. 

2.A. TERMS FOR ON-PREMISE PRODUCTS	
2.A.1. Delivery.  Unless otherwise specified by us, On-Premise Product(s) will be provided to you via electronic delivery, and delivery is deemed complete when the On-Premise Product(s) is/are made available at the electronic software download site specified by us and you are e-mailed or otherwise provided with any necessary instructions, password and/or license keys required for you to be able to access, download and install the On-Premise Product(s). If we provide the On-Premise Product(s) on physical media, shipping terms will be FOB shipping point.
2.A.2. Updates.  Each Update to an On-Premise Product replaces part or all of the On-Premise Product (or earlier Update) previously licensed to you ("Replaced Product") and will terminate such previously licensed Replaced Product to the extent replaced by the Update; provided, however, that you may continue to operate the Replaced Product for up to ninety (90) days from delivery of the Update to allow you to complete your implementation of the Update. You must cease all use of the Replaced Product at the end of the ninety (90) day period. Each Update will be subject to the terms and conditions of the license agreement accompanying the Update which must be accepted by you at the time you download or install the Update. If you do not agree to the license agreement accompanying the Update, do not download or install the Update.
2.A.3. Cloud Environment.  You may upload the On-Premise Product(s) licensed to you pursuant to this EULA onto a cloud instance supplied by a third party, provided that the operation of the On-Premise Product(s) in the cloud instance complies with all license model restrictions and usage limitations applicable to the On-Premise Product(s).  You may also allow the third party to upload, install, operate and/or use the On-Premise Products on the cloud instance, provided that the third party's access to and use of the On-Premise Products is solely for your benefit in accordance with the terms of this EULA. The third party will be considered a Permitted Third Party, and you will be responsible for the Permitted Third Party's compliance with this EULA in accordance with section 1.2.3 (Third Party Use).

2.B. TERMS FOR HOSTED SERVICES	THIS SECTION IS NOT APPLICABLE 

3. PRODUCT FAMILY SPECIFIC TERMS 
This section specifies terms and conditions that are applicable to the following On-Premise Products, as made generally available by us to our customers: (1) all iMacros products; (2) all iMail products; and (3) all MessageWay products, but excluding any cloud versions and any software products available for download by selecting the "Free Tools" selection option from the Resources drop down menu on the Progress Ipswitch Resource Center website page located at https://www.ipswitch.com/resources#?language=en-US&page=1 and designated as a "Free Tool" or "Free Toolkit" (collectively, "Free Software"). Such Free Software will not be subject to the terms and conditions of this Agreement and any rights you may have to download, install, access and/or use such Free Software will be governed solely by a separate license agreement presented to you for acceptance at the time of download and/or installation of the Free Software.

Default License Type for each of the above-referenced On-Premise Products: Perpetual 

3.1. Product Family Definitions.
Any defined term used in this section 3 (Product Family Specific Terms) but not defined herein will have the meaning ascribed to it in section 1 (General Terms and Conditions) or section 2 (Terms for On-Premise Products). 
3.1.1. "Server" means one physical server that is not running virtualization software, or one virtual server instance.

3.2. License.
3.2.1. General License Terms.  
3.2.1.1. License Grant.  Subject to the terms and conditions contained in this EULA, we hereby grant you a non-exclusive, worldwide, royalty-free, non-transferable license, without the right to sublicense and solely for your internal business purposes to (i) install and use the Product, in its object code form only, on computing resources owned and/or operated by you or a Permitted Third Party (as defined in section 1.2.3 (Third Party Use)); and (ii) use the Documentation solely as reasonably necessary to access and use the Product and/or allow a Permitted Third Party to host the Product on your behalf. You may copy reasonable quantities of the Documentation for your internal use or use by a Permitted Third Party, and may make one copy of each Product solely for your archival, back-up, disaster recovery, or emergency restart purposes, or to replace copies made on defective media, if applicable. You will reproduce and include our proprietary rights and copyright notices on any copies of the Product you make pursuant to this section 3.2.1. The license includes the right to deploy and use any of our programs associated with the Product, such as tools or utilities, that are listed in the Documentation. Such programs will be considered "Our Technology" as defined in section 1.1.10 of this EULA and, except as otherwise expressly stated in this section 3.2.1.1, all terms and conditions in section 1 (General Terms and Conditions) pertaining to Our Technology will apply to such programs associated with the Product. For the avoidance of doubt, and except as expressly permitted hereunder, the Product is licensed on a per-Server basis. This means that you may only install and use the Product on the number of Servers, including both production, non-production and failover, disaster recovery or high availability Servers, equal to the number of licenses you purchase via the applicable Order. Notwithstanding the foregoing, certain Products may be licensed on a model other than on a per-Server basis and/or may be subject to additional usage restrictions as set forth in section 4 below.
3.2.1.2. License Type.  Unless otherwise stated in the Order, your license to the Product will be perpetual. If the Order specifies that your license is a term license or a subscription license, then, unless otherwise specified in the Order, your license will not automatically renew. Your license to the Product will terminate at the end of the then-current term or subscription period purchased by you unless we offer, and you purchase a term or subscription renewal, as applicable, prior to the expiration of such term or subscription period. All renewals will be charged at the rate then in effect at the time of purchase. If you purchase a renewal term or subscription license, then term or subscription license, as applicable, will be renewed at the level we, in our sole discretion, identify as being closest to your previous term or subscription license. If you do not purchase a renewal term or subscription license for the Product, then the terms of section 1.15.2 (Effect of Termination) will apply.
3.2.1.3. Optional Features and Functionality.  You may only use an optional feature or functionality with the Product if you have selected the feature or functionality in the Order and paid any additional fees for the feature or functionality. 
3.2.1.4. Non-Production Licenses, High Availability and/or Disaster Recovery Purpose License.  Non-production licenses may be used solely for testing, training, development or other non-production and non-failover, disaster recovery or high availability purposes. If you obtain a license for failover, disaster recovery or high availability purposes ("Redundant Software"): (i) you may not run such Redundant Software on a primary production Server, unless (a) the primary production Server related to the primary production version of the Product fails, (b) the Product or Server associated with the primary production license is being upgraded or replaced or (c) other temporary reasons disrupt all or a material part of your business operations and (ii) you will promptly get the primary production Server hosting the primary production license operating correctly in order to support your daily activities.
3.2.1.5. Product Restrictions. In addition to the restrictions set forth in section 1.2.4 (Restrictions), you will not: (i) isolate or extract any components embedded in the Product, nor otherwise utilize any components embedded in the Product for any purposes other than those supported by the core functions of the Product; (ii) unless otherwise expressly stated for a given third-party component, install or configure, administer, customize, or directly access any such third party component embedded in the Product independently of the APIs and functions of the Product; (iii) independently upgrade or change any third party components embedded in the Product in any way except through patches, updates or versions officially released by us; or (iv) publish a review of the Product, information regarding any bugs or defects in the Product, in each case, without our prior written consent. 
3.2.2. Beta Testing, Release Candidates or Evaluation Purposes.  With respect to beta versions or release candidates of any Product, or Products provided to you for evaluation purposes only, the following terms and conditions apply, but sections 1.9 (Warranties), 3.2.1.1 (General License Grant), and 3.2.5 (Database Schema) of this EULA do not. 
3.2.2.1. License Grant.  Notwithstanding section 3.2.1.1 (General License Grant), we hereby grant you a non-exclusive, worldwide, royalty-free, non-transferable, license, without the right to sublicense, to use the Product, in its object code form only, and any associated Documentation, solely for your internal beta testing, internal release candidate testing or internal evaluation purposes. Your license will be effective during the time specified by us, or until terminated by us in our sole discretion. If the license is for beta testing purposes, you may install the Product only on a non-production Server. If the license is for internal evaluation purposes, then, except as otherwise expressly provided in this section 3.2.4, the terms set forth in section 1.2.5 (Limitations on Evaluation or Trial Licenses) will apply to your use of the Product. 
3.2.2.2. Feedback and Improvements.  As consideration for the royalty-free license granted in section 3.2.4.1 (License Grant), you agree (i) to advise us in writing of any problems or bugs in connection with the operation of the Product, and (ii) if the license is for release candidate or evaluation purposes, either obtain a commercial license for the Product, or advise us, in reasonable detail, of the reasons you have decided not to obtain a commercial license. Any Improvements (as defined in section 1.6.2 (Feedback)) to the Product, including without limitation any suggested by you or any of your employees, agents or affiliates, or any based on your use and license of the Product, will be considered Feedback (as also defined in section 1.6.2) and subject to the terms and conditions of section 1.6.2.
3.2.2.3. Confidentiality.  The features and functions of the Product licensed for beta testing, release candidate or evaluation purposes are our Confidential Information and subject to the terms and conditions of section 1.11 (Confidentiality). 
3.2.3. Database Schema.  If we provide you with the data base schema ("Schema"), you agree that your use of the Schema will be subject to the same license and restrictions with respect to the Product under this EULA, including without limitation sections 1.2.1 (General License Terms), 1.2.4 (Restrictions), 1.6 (IP Ownership and Feedback), 1.15 (Termination), 3.2.1.5 (Product Restrictions), 3.3.3 (Credentials) and 3.6 (System Data). We may revise, modify or cease to provide the Schema or any part thereof at any time. You understand and agree that any change to the Schema or the database may adversely affect the Product and/or the operation or performance thereof, for which we will have no responsibility. Notwithstanding anything to the contrary in this EULA, including without limitation anything to the contrary in section 1.9 (Warranties), the Schema is provided solely on an "AS IS" basis without any warranty of any kind. We make no warranties with respect to the Schema, express, implied, or arising by custom or trade usage, and specifically make no warranty of merchantability or fitness for a particular purpose. Your use of the Schema will be at your own risk.  The Schema is our Confidential Information and subject to the terms and conditions of section 1.11 (Confidentiality).

3.3. Credentials.  You will be required to create a user name and password ("Credentials") that will be required to order Product(s) or Support (as defined in section 3.4 (Support)). You may only access Product(s) and Support using your Credentials, and may not access Product(s) or Support using Credentials of any other person. You may not make your Credentials available to others, nor allow use of the Product(s) or Support by others through your Credentials. You agree to accept sole responsibility and liability for maintaining the confidentiality of your Credentials, for restricting access to your Credentials and for all use, whether authorized or unauthorized, of the Product(s) or Support under your Credentials. 

3.4. Support.  If and for so long as you maintain an active support term, we will provide to you support and assistance in accordance with the level of support you purchase ("Support"). More information regarding our support policies can be found at https://www.progress.com/support. Annual or multi-year Support terms are paid in advance and are non-refundable. Unless otherwise specified in the Order or in a written instrument mutually executed between you and us, Support will not automatically renew. You may purchase renewal Support terms in accordance with section 1.7.2 (Maintenance and Support for Perpetual or Term License Types) and this section 3.4 (Support) at our then-current pricing for Support at the time of purchase.

3.5. Systems Data.  You acknowledge and agree that we and our affiliates will collect and use the following information about the use of the Product: install started; install finished (with error code if error); install type (evaluation, upgrade new perpetual); hashed serial number for a generic ID; and additional technical information about your computer, system and application software, and peripherals that is gathered periodically to facilitate the provision of software updates, product support and other services to you (if any), and to verify compliance with the terms of this EULA (any such data collected by us or our affiliates under this section 3.5, "System Data"). System Data will not include any personally identifiable information and will be used only on an anonymous, aggregated basis for our and/or our affiliates' internal business purposes. We will own any and all such System Data, and you hereby assign to us all right, title and interest in and to the System Data.

3.6. Third Party Beneficiaries. This EULA is intended for the sole and exclusive benefit of the parties and is not intended to benefit any third party.
 

4. PRODUCT SPECIFIC TERMS 

This section specifies specific terms and conditions that are applicable to one or more Products designated as Fee-Based Software, as defined in section 3 (Product Family Specific Terms).

4.1. Product Specific Definitions.  Any defined term used in this section 4 (Product-Specific Terms) but not defined herein will have the meaning ascribed to it in section 1 (General Terms and Conditions), section 2 (Terms for On-Premise Products) or section 3 (Product Family Specific Terms).

4.2. Additional Terms for Certain Fee-Based Software.  The following additional terms and conditions apply with respect to: iMail, iMacros and MessageWay. 
4.2.1. License Terms.  You may use the Product on the number of computing devices identified in the Order. If you use the Product on a virtual machine or in an environment where multiple users share computer resources, each instance of the Product in use at any time is considered one computing device. For Products in which more than one feature set (e.g., "standard", "premium") is available, you may solely use one specific feature set. If you desire a different feature set, you must purchase an upgrade. Feature sets are defined in the Documentation and identified at the time of purchase. For Products in which more than one level (e.g., "100 users", "300 devices") is available, you may solely use the specific level identified in the Order. If you desire a different level, you must purchase an upgrade. 
4.2.2. Network Environments.  For Products in which more than one network environment (e.g., "Internally owned and operated", "externally owned and operated") is available, you may solely use the Product in an internally or externally owned and operated network as specified in the Order. If you desire to monitor an internal or external network environment that you are not already authorized to operate the Product in accordance with the Order, then you must purchase a separate license. 
4.2.3. Dynamic Content.  For Products which include dynamic content (e.g., anti-virus and anti-spam definitions), said content is sold on a subscription basis and remains current as long as you maintain an active subscription with us. 
4.2.4. Software Development Kits.  For Products designated as a Software Development Kit (SDK), you may create, reproduce and distribute solutions, plug-ins or other derivative works solely to Authorized Users who have a valid and current license for the associated Product. Any such solutions, plug-ins or other derivative works referenced in the preceding sentence are considered "Redistributables" as defined in section 1.2.6 (Redistribution) and, except as otherwise expressly stated in this section 3.2.2.4, all  terms and conditions in section 1 (General Terms and Conditions) pertaining to Redistributables will apply to such solutions, plug-ins or other derivative works.  For SDK Products designated as "internal Use", you must further restrict distribution solely to Authorized Users in your organization. 

4.3. Product-Specific Systems Data.  Notwithstanding anything to the contrary in section 3.5, the following describes modifications to the scope of Systems Data collected and used by us in relation to the following specific Products:
iMacros Product. The iMacros product does not collect any of the following: install started, install finished (with error code if error). The remainder of the description of System Data in section 3.5 (System Data) applies to the iMacros product. The iMacros product does collect the mac address and hardware information for the sole purpose of iMacros license enforcement. When a user elects to press the iMacros "About Box", the iMacros product will send the version number to our iMacros server to check for available product updates. 

iMail Product.  The iMail product does not collect any of the following: install started, install finished (with error code if error). The remainder of the description of System Data in section 3.5 (System Data) applies to the iMail Product. The iMail product does collect the mac address and hardware information for the sole purpose of iMail license enforcement. The iMail product does not collect any other data, personal or otherwise.

MessageWay Product. The MessageWay product does not collect any of the following: install started, install finished (with error code if error). The remainder of the description of System Data in section 3.5 (System Data) applies to the MessageWay product.
 


Rev. TMPLT06JAN2020iMacros-iMail-MessageWay30JUN2020


======================================================================
FILE PATH: extractDialog.html
======================================================================
<html>
<head>
 <meta charset="UTF-8">
    <title>iMacros extract dialog</title>
    <link rel="stylesheet" type="text/css"
          href="skin/common.css" />
    <link rel="stylesheet" type="text/css"
          href="skin/extractDialog.css" />
    <script src="utils.js"></script>
    <script src="extractDialog.js"></script>
  </head>
  <body>
    <div id="container" class="vbox">
      <span id="caption">Extracted Data</span>
      <div class="hbox centered">
        <textarea class="hbox" id="data-field"></textarea>
      </div>

      <div id="note"><span>このポップアップはテスト用です。 IM がスクリプト インターフェイスによって制御されている場合は<b>表示されません</b>。 マクロを手動で実行する場合は、<code>SET&nbsp;!EXTRACT_TEST_POPUP&nbsp;NO</code> をマクロに追加することで、このポップアップを無効にできます</span>
      </div>
    </div>
    <div id="buttons" class="hbox centered">
      <div id="ok-button" class="button icon-button" role="button" tabindex="0">
        <span>OK</span>
      </div>
    </div>
    <div>

  </body>
</html>



======================================================================
FILE PATH: extractDialog.js
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/

function ok() {
    window.close();
}

window.addEventListener("beforeunload", function() {
    args.mplayer.waitingForExtract = false;
    args.mplayer.next("extractDialog");
    return null;
});

window.addEventListener("load", function(evt) {
    var field = document.getElementById("data-field");
    field.focus();
    if (args) {
        field.value = args.data;
        //field.select();
    }

    //document.getElementById("ok-button").addEventListener("click", ok);
    let okButton = document.getElementById("ok-button");
    okButton.addEventListener("click", ok);
    okButton.focus();
    okButton.addEventListener("keydown", function(e) {
        var type = e.type;
        if (type === "keydown"){
            if((e.keyCode === 13) || (e.keyCode === 32)){
                ok();
                e.preventDefault();
            }
        }
    });
    resizeToContent(window, document.getElementById('container'));
});



======================================================================
FILE PATH: fileView.html
======================================================================
<html>
<head>
 <meta charset="UTF-8">
    <title>iMacros</title>
    <link rel="stylesheet" type="text/css"
          href="skin/common.css" />
    <link rel="stylesheet" type="text/css"
          href="skin/treeView.css" />
    <link rel="stylesheet"
          href="vendor/jstree/themes/default/style.css" />
    <script src="vendor/jQuery/jquery-2.2.1.min.js"></script>
    <script src="vendor/jstree/jstree.min.js"></script>
    <script src="fileView.js"></script>
    <script src="utils.js"></script>
    <script src="AsyncFileIO.js"></script>

  </head>
  <body treetype="files">
	<div id="no-file-io-message" hidden="true">
      <p id="no-file-io-paragraph">        
		File access is not available in the freeware version.
		<br><br>
    See <span id="comparison" class="a-link no-bold-link">the feature comparison chart</span>.
    <br><br>
    <span id="customer" class="a-link no-bold-link">Already a customer?</span>
      </p>
    </div>
    <div id="loading_message" hidden="true">
      Scanning directory...
    </div>
    
    <ul id="jstree" class="tree-menu">
    </ul>

    <div id="imacros-bookmark-div" style="display:none">
      <textarea id="imacros-macro-container"></textarea>
    </div>
  </body>

</html>



======================================================================
FILE PATH: fileView.js
======================================================================
/*
  Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/

window.addEventListener("DOMContentLoaded", function (event) {
    let bg = chrome.extension.getBackgroundPage();

    document.getElementById('comparison').addEventListener("click", function() {
        bg.link(getRedirFromString("compare-versions"));
    });

    document.getElementById('customer').addEventListener("click", function() {
        bg.link(getRedirFromString("already-customer"));
    });
    
    afio.isInstalled().then(function(installed) {
        if (!installed) {
            document.getElementById('no-file-io-message').removeAttribute("hidden");
            return;
        }
        var msg = document.getElementById('loading_message');
        msg.removeAttribute('hidden');
        TreeView.build();
        msg.setAttribute('hidden', true);
        window.top.onSelectionChanged(TreeView.selectedItem != null);
    }).catch(console.error.bind(console));
    document.body.oncontextmenu = function(e) {
        e.preventDefault()
    }
}, true);


var TreeView = {
    
    // predicate for sorting nodes
    sortPredicate: function(a, b) {
        // string compare function to sort nodes
        var node_compare = function (a, b) {

            //directories go first
            if (a.is_dir && !b.is_dir) {
                return -1;
            } else if (b.is_dir && !a.is_dir) {
                return 1;
            }

            var la = a.leafName.toLowerCase(),
                lb = b.leafName.toLowerCase();
            var bound = Math.min(la.length, lb.length);
            for (var i = 0; i < bound; i++) {
                var l = la.charAt(i), r = lb.charAt(i), x;
                if (l == r)
                    continue;
                // '#'-symbol preceeds others
                if (l == "#")
                    return -1;
                else if (r == "#")
                    return 1;
                else if (x = l.localeCompare(r))
                    return x;
            }
            return la.length - lb.length; // longer string is greater
        };
        if (a.is_dir && !b.is_dir) {
	    return -1; 		// a dir always preceeds a file
        } else if (!a.is_dir && b.is_dir) {
	    return 1;
        } else {
	    return node_compare(a, b);
        }
    },

    // build tree from iMacros Macros folder
    build: function () {

        function selectMacroForPlayButton(id, name) {
            var div = document.getElementById("imacros-bookmark-div");
            if (div.hasAttribute("bookmark_id"))
                div.removeAttribute("bookmark_id");
            div.setAttribute("file_id", id);
            div.setAttribute("name", name);
        }

        let onEdit = function () { window.top.edit(); }
        let onConvert =  function () { window.top.convert(); }
        let onNewFolder = function () {
	    var item = TreeView.selectedItem;
	    var node = afio.openNode(item.id);
	    
	    if (item.type != "folder")
		node = node.parent;
	    
            var _makedir_checkname = function(count, node, name) {
                var dir = node.clone();
                dir.append(name+" ("+count+")");
                dir.exists().then(function(exists) {
                    if (exists) {
                        return _makedir_checkname(++count, node, name);
                    } else {
                        return afio.makeDirectory(dir).then(function() {
                            return jQuery('#jstree').jstree(true).refresh();
                        });
                    }
                }).catch(console.error.bind(console));
            };

            var new_name = prompt("Enter new folder name", "New folder");

            var dir = node.clone();
	    dir.append(new_name);
	    return dir.exists().then(function(exists) {
		if (exists) {
		    return _makedir_checkname(1, node, new_name);
		} else {
		    return afio.makeDirectory(dir).then(function(err) {
			return jQuery('#jstree').jstree(true).refresh();
		    });
		}
	    });
        }

        let onRename = function () {
            var item = TreeView.selectedItem;

            if (!item) {
                alert("Error: no item selected"); // should never happen
                return;
            }

            var old_name = item.text;
            var new_name = prompt("Enter new name", old_name);
            if (!new_name)
                return;
            if (item.type != "folder" && !isMacroFile(new_name))
                new_name += ".iim";
            var node = afio.openNode(item.id);
            var new_node = node.parent;
            new_node.append(new_name);
	    
            node.moveTo(new_node).then(function() {
                
                jQuery('#jstree').jstree(true).refresh();
		
                if (item.type == "macro") {
                    TreeView.selectedItem.id = new_node.path;
                    TreeView.selectedItem.text = new_name;
                    selectMacroForPlayButton(new_node.path, new_name);
                }
            }).catch(console.error.bind(console));
        }

        let onRemove = function () {
            var item = TreeView.selectedItem;
            if (!item) {
                alert("Error: no item selected");
                return;
            }
            if (!item.id) {
                alert("Can not delete " + item.type + " " + item.text);
                return;
            }
            var yes = confirm("Are you sure you want to remove " + item.type + " "+
                              item.text + "?");
            if (!yes)
                return;

            var node = afio.openNode(item.id);
            node.remove().then(function() {
                jQuery('#jstree').jstree(true).refresh();
                TreeView.selectedItem = null;
                selectMacroForPlayButton('', '');
            }).catch(console.error.bind(console));
        }
        let onRefreshTree = function () {
            jQuery('#jstree').jstree(true).refresh();
        }

        function customMenu(node) {
            TreeView.selectedItem = node.original;

            var items = {
                'Edit': {
                    'label': 'Edit',
                    'action': onEdit
                },
                'Convert': {
                    'label': 'Convert',
                    'action': onConvert
                },
                'New Folder': {
                    'label': 'New Folder',
                    'action': onNewFolder
                },
                'Rename': {
                    'label': 'Rename',
                    'action': onRename
                },
                'Remove': {
                    'label': 'Remove',
                    'action': onRemove
                },
                'Refresh Tree': {
                    'label': 'Refresh Tree',
                    'action': onRefreshTree
                }
            }

            if (node.type === 'folder') {
                delete items.Edit;
                delete items.Convert;
            }

            return items;
        };

        jQuery('#jstree').jstree({
            'core': {
                "check_callback": function (operation, node, parent, position, more) {
                    if (more.dnd && operation === "move_node") {
                        if(parent.id === "#") {
                            return false; // prevent moving a child above or below the root
                        }
                    }

                    return true; // allow everything else
                },

                'data': function(node, cb) { getNodes(node, cb); }
            },
            'types': {
                'folder': {
                    
                },
                "macro": {
                    'icon': 'X'//'/skin/imglog.png'
                }
            },
            'contextmenu': {
                'items': customMenu
            },
            'plugins': ['state', 'dnd', 'types', 'contextmenu', 'wholerow']
        });

        jQuery(document).on('dnd_stop.vakata', function (e, data) {
            var src = afio.openNode(data.element.parentElement.id);
            var dst = afio.openNode(data.event.target.parentElement.id);

            dst.isDir().then(function(is_dir) {
                dst = is_dir ? dst : dst.parent;
		dst.path = dst._path = dst._path + __psep() + src.leafName;
                return src.moveTo(dst);
            }).then(function() {
                return jQuery('#jstree').jstree(true).refresh();
            }).catch(function(e) {
                console.error.bind(console);

                if (e && e.message) {
                    alert(e.message);
                }
                
                return jQuery('#jstree').jstree(true).refresh();
            });

            return false;
        });

        jQuery('#jstree').on('select_node.jstree', function (e, data) {
            TreeView.selectedItem = data.node;
            if (data.node.type == 'macro') {
                TreeView.selectedItem.type = "macro";
                selectMacroForPlayButton(data.node.id, data.node.text);
                window.top.onSelectionChanged(true);
                e.preventDefault();
                e.stopPropagation();
            }
            //folder
            else {
                TreeView.selectedItem.type = "folder";
                window.top.onSelectionChanged(false);
            }
        });

        jQuery('#jstree').on('dblclick.jstree', function (e, data) {
            
            var target_node = jQuery('#jstree').jstree(true).get_node(e.target.parentElement.id);
            
            if (target_node.type == 'macro') {
                setTimeout(function () { window.top.play(); }, 200);
            }
        });

        jQuery('#jstree').on("loaded.jstree", function (event, data) {
            openFirstNode();
        })
	
	jQuery('#jstree').on("show_contextmenu.jstree", function (event, data) {
	    
	    var currentOffsetTop = $('.jstree-contextmenu').position().top - $(window).scrollTop();
	    var menuHeight = $('.jstree-contextmenu').height() + 10;
	    var tooLowBy = $(window.frameElement.parentElement).height() - (currentOffsetTop + menuHeight);
	    
	    if(tooLowBy < 0) {
		
		var newPosition = currentOffsetTop + tooLowBy + $(window).scrollTop();
		$('.jstree-contextmenu').offset( { top: newPosition })
	    }
        })

        jQuery('#jstree').on('refresh.jstree', function (e, data) {
            openFirstNode();
        });

        function openFirstNode() {
            jQuery('#jstree').jstree("open_node", "ul > li:first");
        }

        function getNodes(node, cb) {
	    
            var data_obj;
	    
            if(node.id === "#") {
		
                afio.getDefaultDir("savepath").then(function(savepath) {
                    var root_node = savepath;

                    data_obj = createNode(root_node.leafName, root_node.path, 'folder', true);
                    data_obj.children = getChildren(root_node, data_obj, cb);
                }).catch(console.error.bind(console));
            }
            else {
                getChildren(afio.openNode(node.id), data_obj, cb);
            }
        }

        function getChildren(root_node, data_obj, cb) {

            afio.getNodesInDir(root_node)
                .then(function(nodes) {
                    // We need to sort array
                    nodes.sort(TreeView.sortPredicate);

                    var children = new Array();
		    
                    for (var x of nodes) {
                        if (isMacroFile(x.path)) {
                            children.push(createNode(x.leafName, x.path, 'macro', false));
                        } else if (x.is_dir){
                            children.push(createNode(x.leafName, x.path, 'folder', true));
                        }
                    }
		    
                    if(data_obj && children.length) {
                        data_obj.children = children;
                        cb(data_obj);
                    } else if(children.length) {
                        cb(children);
                    } else if(data_obj) {
                        cb([data_obj]);
                    } else {
                        cb([]);
                    }
                }).catch(console.error.bind(console));
        }

        function createNode(text, id, type, hasChildren) {
            return {'text': text, 'id': id, 'type': type, 'children': hasChildren };
        }
    }
};



======================================================================
FILE PATH: folderView.html
======================================================================
<html>
  <head>
    <title>iMacros</title>
    <link rel="stylesheet"
          href="vendor/jstree/themes/default/style.css" />
    <link rel="stylesheet" type="text/css"
          href="skin/treeView.css" />
    <script src="vendor/jQuery/jquery-2.2.1.min.js"></script>
    <script src="vendor/jstree/jstree.min.js"></script>
    <script src="folderView.js"></script>
    <script src="utils.js"></script>
    <script src="AsyncFileIO.js"></script>

  </head>
  <body>

    <div id="jstree_container">
        <ul id="jstree" class="tree-menu">

        </ul>
    </div>

    <input id="path" type="hidden" class="display: none;"></input>
  </body>
</html>



======================================================================
FILE PATH: folderView.js
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/

window.addEventListener("load", function (event) {
    afio.isInstalled().then(function(installed) {
        if (!installed) {
            document.body.innerHTML = "<p style='color:red'>"+
                "Install file access support first"+
                "</p>";
        } else {
            TreeView.build(window.top.args ? window.top.args.path : null);
        }
    });
}, true);

var TreeView = {
    
    // predicate for sorting nodes
    sortPredicate: function(a, b) {
        // string compare function to sort nodes
        var node_compare = function (a, b) {
            var la = a.leafName.toLowerCase(),
                lb = b.leafName.toLowerCase();
            var bound = Math.min(la.length, lb.length);

            for (var i = 0; i < bound; i++) {
                var l = la.charAt(i), r = lb.charAt(i), x;
                if (l == r)
                    continue;
                if (x = l.localeCompare(r))
                    return x;
            }

            return la.length - lb.length; // longer string is greater
        };

        return node_compare(a, b);
    },

    // build tree from iMacros bookmarks folder
    build: function (root) {
        jQuery('#jstree').jstree({
            'core': {
                'data': function(node, cb) { getNodes(node, cb); }
            },
            'plugins': ['wholerow']
        });

        jQuery('#jstree').on("changed.jstree", function (e, data) {

            document.getElementById("path").value = data.selected;
        });
        
        jQuery('#jstree').on("loaded.jstree", function (event, data) {
            selectFirstNode();
        })

        jQuery('#jstree').on('dblclick.jstree', function (e, data) {
                
            var target_node = jQuery('#jstree').jstree(true).get_node(e.target.id);
                
            if (target_node.text == '..') {
                root = target_node.id;
                jQuery('#jstree').jstree(true).refresh();
            }
        });

        jQuery('#jstree').on('refresh.jstree', function (e, data) {
            selectFirstNode();
        });

        function selectFirstNode() {
            jQuery('#jstree').jstree("select_node", "ul > li:first");
            jQuery('#jstree').jstree("open_node", "ul > li:first");
        }

        function getNodes(node, cb) {
	
            var data_obj;
	
            if(node.id === "#") {
		
                if (root == "My Computer") {

                    data_obj = createNode('My Computer', '', 'computer');

                    afio.getLogicalDrives().then(function(drives) {
                        data_obj.children = new Array();
				
                        for (var i = 0; i < drives.length; i++) {

                            var drive_caption = drives[i].path+
                                                (drives[i].path[drives[i].path.length-1] == __psep() ?
                                                 "": __psep());
					
                            data_obj.children[i] = createNode(drive_caption, drives[i].path, 'drive');
                        }

                        cb([data_obj]);
                    }).catch(console.error.bind(console));
                } else {
                    afio.getDefaultDir("savepath").then(function(savepath) {
                        var root_node = root ? afio.openNode(root) : savepath;

                        // make "Up" element first
                        var parent_path = /^[A-Z]:\\?$/.test(root) ?
                            '' : root_node.parent.path; //using empty string for 'My Computer' so that its not seen as a selection by browse.js

                        data_obj = createNode('..', parent_path, 'folder');
                        data_obj.children = getSubDirs(root_node, data_obj, cb);
                    }).catch(console.error.bind(console));
                }
            }
            else {
                getSubDirs(afio.openNode(node.id), data_obj, cb);
            }
        }

        function getSubDirs(root_node, data_obj, cb) {

            afio.getNodesInDir(root_node, ":is_dir")
            .then(function(nodes) {
                // We need to sort array
                nodes.sort(TreeView.sortPredicate);

                var subDirs = new Array();
		
                for (var x of nodes) {
                    subDirs.push(createNode(x.leafName, x.path, 'folder'));
            }
		
                if(data_obj && subDirs.length) {
                    data_obj.children = subDirs;
                    cb(data_obj);
                } else if(subDirs.length) {
                    cb(subDirs);
                } else if(data_obj) {
                    cb([data_obj]);
                } else {
                    cb([]);
                }
            }).catch(console.error.bind(console));
        }

        function createNode(text, id, type) {
            return {'text': text, 'id': id, 'type': type, 'children': true };
        }
    }
};



======================================================================
FILE PATH: loginDialog.html
======================================================================
<html>
  <head>
    <title>iMacros Login Dialog</title>
    <link rel="stylesheet" type="text/css"
          href="skin/common.css" />
    <link rel="stylesheet" type="text/css"
          href="skin/loginDialog.css" />
    <script src="utils.js"></script>
    <script src="loginDialog.js"></script>
  </head>
  <body>
    <div id="container" class="dialogs-global-settings">
      <div class="box">
        <span id="message">Authentication required</span>
      </div>
      <table id="username-and-password">
        <tr>
          <td>User name:</td>
          <td>
            <input type="text" id="username"></input>
          </td>
        </tr>
        <tr>
          <td>Password:</td>
          <td>
            <input type="password" id="password"></input>
          </td>
        </tr>
      </table>

      <div id="buttons" class="hbox centered">
        <div id="ok-button" class="button icon-button">
          <span>OK</span>
        </div>
        <div id="cancel-button" class="button icon-button">
          <span>Cancel</span>
        </div>
      </div>
      <div>
        
      </div>
    </div>
</div>
</body>
</html>



======================================================================
FILE PATH: loginDialog.js
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/

function ok() {
    var bg = chrome.extension.getBackgroundPage();

    var user = document.getElementById("username").value;
    var pwd = document.getElementById("password").value;

    var response = {
        authCredentials: {
            username: document.getElementById("username").value,
            password: document.getElementById("password").value
        }
    };
    if (args.cypherData.encrypt) {
        pwd = bg.Rijndael.encryptString(pwd, args.cypherData.key);
    }

    var rec = "ONLOGIN USER="+user+" PASSWORD="+pwd;
    // remove previously recorded ONLOGIN command
    var l = args.recorder.actions.length;
    var match_part = "ONLOGIN USER=";
    if (l && args.recorder.actions[l-1].indexOf(match_part) == 0) {
        args.recorder.actions.pop();
        var panel = bg.context[args.recorder.win_id].panelWindow; 
        if (panel && !panel.closed) {
            panel.removeLastLine();
        }
    }
    args.recorder.recordAction(rec);
    args.callback(response);
    window.close();
}


function cancel() {
    args.callback({cancel: true})
    window.close();
}

window.addEventListener("load", function(evt) {
    var message = args.details.challenger.host+":"+
        args.details.challenger.port+" requires authentication.";
    if (args.details.realm)
        message += " Server message: "+args.details.realm;
    document.getElementById("message").innerText = message;
    // window.moveTo(window.opener.screenX+window.opener.outerWidth/2-170,
    //               window.opener.screenY+window.opener.outerHeight/2-100);
    document.getElementById("username").addEventListener("keypress", function(e) {
        if (e.which == 13) ok();
    });
    document.getElementById("password").addEventListener("keypress", function(e) {
        if (e.which == 13) ok();
    });
    document.getElementById("ok-button").addEventListener("click", ok);
    document.getElementById("cancel-button").addEventListener("click", cancel);
    resizeToContent(window, document.getElementById('container'));
});



======================================================================
FILE PATH: macroView.html
======================================================================
<html>
  <head>
    <title>iMacros Macro View</title>
    <link rel="stylesheet" type="text/css" href="skin/common.css" />
    <link rel="stylesheet" type="text/css" href="skin/macroView.css" />
    <script src="macroView.js"></script>
    <script src="utils.js"></script>
  </head>
  <body>
    <div id="status-div" type="idle">
      <span id="status"></span>
    </div>
    <table id="lines"></table>
  </body>
</html>



======================================================================
FILE PATH: macroView.js
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/

var mv = {
    lineCounter: 0,

    showLines: function(code) {
        var lines = code.split(/\r?\n/);
        this.clearAllLines();   // just to make sure it's empty
        lines.forEach(function(line) {
            mv.addLine(line, true)
        });
    },


    addLine: function(txt, no_scroll) {
        this.lineCounter++;
        var tr = document.createElement("tr");

        // line number
        var num = document.createElement("td");
        num.setAttribute("class", "line-number");
        num.textContent = this.lineCounter;

        // text
        var line = document.createElement("td");
        line.setAttribute("class", "macro-line");
        if (/^\s*'/.test(txt))
            line.setAttribute("commented", "true");
        line.textContent = txt;
        
        // put that all together
        tr.appendChild(num);
        tr.appendChild(line);
        document.getElementById("lines").appendChild(tr);

        if (!no_scroll) {
            this.ensureNodeIsVisible(tr);
        }
    },


    removeLastLine: function() {
        var lines = document.getElementById("lines");
        lines.removeChild(lines.lastChild);
    },


    highlightLine: function(linum) {
        // evaluate XPath to find all elements
        // with attribute selected="true"
        var xpath = "id('lines')/tr[@selected='true']";
        try {
            var result = document.evaluate(xpath, document, null,
                            XPathResult.ORDERED_NODE_ITERATOR_TYPE,
                            null);
            var node = null, nodes = new Array();
            while (node = result.iterateNext()) {
                nodes.push(node);
            }
            // remove selection
            nodes.forEach( function(x) {
                x.removeAttribute("selected");
            })
        } catch(e) {
            console.error(e);
        }
        // select the proper one
        xpath = "id('lines')//tr[position()="+parseInt(linum)+"]";
        try {
            result = document.evaluate(xpath, document, null,
                                       XPathResult.FIRST_ORDERED_NODE_TYPE,
                                       null);
            if (node = result.singleNodeValue) {
                this.ensureNodeIsVisible(node);F
                node.setAttribute("selected", "true");
            }
        } catch(e) {
            console.error(e);
        }
    },


    clearAllLines: function() {
        document.getElementById("lines").innerHTML = "";
        this.lineCounter = 0;
    },


    setStatLine: function(txt, type) {
        document.getElementById("status-div").setAttribute("type", type);
        document.getElementById("status").textContent = txt;
    },

    ensureNodeIsVisible: function(node) {
        var box = node.getBoundingClientRect();
        // console.log("ensureNodeIsVisible: box.top="+box.top+
        //             ", box.bottom="+box.bottom+
        //             ", window.pageYOffset="+window.pageYOffset+
        //             ", document.body.clientHeight="+document.body.clientHeight);
        if (box.bottom > document.body.clientHeight) {
            window.scrollTo(0, box.bottom+window.pageYOffset-
                            document.body.clientHeight+5);
        } else if (box.bottom < 0) {
            window.scrollTo(0, box.top+window.pageYOffset-5);
        }
    }
};



======================================================================
FILE PATH: manifest.json
======================================================================
{
    "update_url": "https://clients2.google.com/service/update2/crx",
    "manifest_version": 2,
    "content_scripts": [
        {
            "js": [
                "content_scripts/bookmarks_handler.js",
                "content_scripts/si_listener.js"
            ],
            "matches": ["http://*/*", "https://*/*", "file://*"],
            "run_at": "document_start",
            "all_frames": false
        },
        {
            "js": [
                "utils.js",
                "content_scripts/connector.js",
                "content_scripts/recorder.js",
                "content_scripts/player.js"
            ],
            "matches": ["http://*/*", "https://*/*", "file://*"],
            "run_at": "document_idle",
            "all_frames": true
        }
    ],
    "description": "Automate your web browser. Record and replay repetitious work",
    "name": "iMacros for Chrome",
    "version": "10.1.1",
    "minimum_chrome_version": "51",
    "homepage_url": "https://imacros.net",
    "browser_action": {
        "default_title": "iMacros for Chrome",
        "default_icon": {"19": "skin/logo19.png", "38": "skin/logo38.png"}
    },
    "background": {"page": "bg.html"},
    "options_page": "options.html",
    "permissions": [
        "tabs",
        "bookmarks",
        "proxy",
        "cookies",
        "pageCapture",
        "webNavigation",
        "notifications",
        "webRequest",
        "webRequestBlocking",
        "nativeMessaging",
        "downloads",
        "contextMenus",
        "debugger",
        "<all_urls>",
        "file:///*"
    ],
    "icons": { 
        "16": "skin/logo16.png",
        "48": "skin/logo48.png",
        "128": "skin/logo128.png"
    },
    "web_accessible_resources": [
        "skin/logo24.png"
    ],
    "sandbox": {
        "pages": ["sandbox.html"]
    },
    "commands": {
        "_execute_browser_action": {
            "suggested_key": {
                "default": "Ctrl+8",
                "mac": "Command+8"
            }
        }
    }
}


======================================================================
FILE PATH: mplayer.js
======================================================================

/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/


// An object to encapsulate all operations for parsing
// and playing macro commands

function MacroPlayer(win_id) {
    this.win_id = win_id;
    this.vars = new Array();
    this.userVars = new Map();
    this.ports = new Object();
    this._ActionTable = new Object();
    this.compileExpressions();

    this._onScriptError = this.onErrorOccurred.bind(this);
    // this._onBeforeNavigate = this.onBeforeNavigate.bind(this);
    // this._onCompleted = this.onNavigationCompleted.bind(this);
    this._onErrorOccured = this.onNavigationErrorOccured.bind(this);
    // this._onCommitted = this.onNavigationCommitted.bind(this);
    // this._onCreatedNavTarget = this.onCreatedNavigationTarget.bind(this);
    // this._onDOMLoaded = this.onDOMContentLoaded.bind(this);
    // this._onRefFragUpdated = this.onReferenceFragmentUpdated.bind(this);
    this._onTabUpdated = this.onTabUpdated.bind(this);
    this._onActivated = this.onTabActivated.bind(this);

    // bindings to monitor network activity
    this.onAuth = this.onAuthRequired.bind(this);
    // this.onRequest = this.onBeforeRequest.bind(this);
    // this.onRedirect = this.onBeforeRedirect.bind(this);
    this._onBeforeSendHeaders = this.onBeforeSendHeaders.bind(this);
    // this.onCompleted = this.onReqCompleted.bind(this);
    // this.onReqError = this.onErrorOccurred.bind(this);
    // this.onHeaders = this.onHeadersReceived.bind(this);
    // this.onResponse = this.onResponseStarted.bind(this);
    // this._onSendHeaders = this.onSendHeaders.bind(this);

    // handle sandbox messages
    window.addEventListener("message", this.onSandboxMessage.bind(this));

    // listeners for download events
    this._onDownloadCreated = this.onDownloadCreated.bind(this);
    this._onDownloadChanged = this.onDownloadChanged.bind(this);
}


// A table to hold the code for processing a command
MacroPlayer.prototype.ActionTable = new Object();
MacroPlayer.prototype.RegExpTable = new Object();



// compile actions regexps
MacroPlayer.prototype.compileExpressions = function () {
    if (!this.RegExpTable.compiled) {
        for (var x in this.RegExpTable) {
            try {
                this.RegExpTable[x] = new RegExp(this.RegExpTable[x], "i");
            } catch (e) {
                console.error(e);
                throw e;
            }
        }
        this.RegExpTable.compiled = true;
    }
    for (var x in MacroPlayer.prototype.ActionTable) {
        this._ActionTable[x] = MacroPlayer.prototype.ActionTable[x].bind(this);
    }
};



// add listener for various events
MacroPlayer.prototype.addListeners = function() {
    communicator.registerHandler("error-occurred",
                                 this._onScriptError, this.win_id);
    chrome.tabs.onUpdated.addListener(this._onTabUpdated);
    chrome.tabs.onActivated.addListener(this._onActivated);

    // use WebNavigation interface to trace download events

    // chrome.webNavigation.onBeforeNavigate.addListener(this._onBeforeNavigate);
    // chrome.webNavigation.onCompleted.addListener(this._onCompleted);
    chrome.webNavigation.onErrorOccurred.addListener(this._onErrorOccured);

    // chrome.webNavigation.onCommitted.addListener(this._onCommitted);
    // chrome.webNavigation.onCreatedNavigationTarget.addListener(
    //     this._onCreatedNavTarget
    // );
    // chrome.webNavigation.onDOMContentLoaded.addListener(
    //     this._onDOMLoaded
    // );
    // chrome.webNavigation.onReferenceFragmentUpdated.addListener(
    //     this._onRefFragUpdated
    // );

    // network events
    // chrome.webRequest.onBeforeRequest.addListener(
    //     this.onRequest,
    //     {
    //         windowId: this.win_id,
    //         urls: ["<all_urls>"]// ,
    //         // types: ["main_frame", "sub_frame"]
    //     }
    // );
    // chrome.webRequest.onBeforeRedirect.addListener(
    //     this.onRedirect,
    //     {windowId: this.win_id, urls: ["<all_urls>"]},
    //     ["responseHeaders"]
    // );
    // chrome.webRequest.onBeforeSendHeaders.addListener(
    //     this._onBeforeSendHeaders,
    //     {windowId: this.win_id, urls: ["<all_urls>"]},
    //     ["blocking", "requestHeaders"]
    // );
    // chrome.webRequest.onCompleted.addListener(
    //     this.onCompleted,
    //     {
    //         windowId: this.win_id,
    //         urls: ["<all_urls>"]
    //     }
    // );
    // chrome.webRequest.onErrorOccurred.addListener(
    //     this.onReqError,
    //     {
    //         windowId: this.win_id,
    //         urls: ["<all_urls>"]
    //     }
    // );
    // chrome.webRequest.onHeadersReceived.addListener(
    //     this.onHeaders,
    //     {windowId: this.win_id, urls: ["<all_urls>"]},
    //     ["responseHeaders"]
    // );
    // chrome.webRequest.onResponseStarted.addListener(
    //     this.onResponse,
    //     {windowId: this.win_id, urls: ["<all_urls>"]},
    //     ["responseHeaders"]
    // );
    // chrome.webRequest.onSendHeaders.addListener(
    //     this._onSendHeaders,
    //     {windowId: this.win_id, urls: ["<all_urls>"]},
    //     ["requestHeaders"]
    // );
};

MacroPlayer.prototype.removeListeners = function() {
    communicator.unregisterHandler("error-occurred", this._onScriptError);
    chrome.tabs.onUpdated.removeListener(this._onTabUpdated);
    chrome.tabs.onActivated.removeListener(this._onActivated);
    // chrome.webNavigation.onBeforeNavigate.removeListener(this._onBeforeNavigate);
    // chrome.webNavigation.onCompleted.removeListener(this._onCompleted);
    chrome.webNavigation.onErrorOccurred.removeListener(this._onErrorOccured);

    // chrome.webNavigation.onCommitted.removeListener(this._onCommitted);
    // chrome.webNavigation.onCreatedNavigationTarget.removeListener(
    //     this._onCreatedNavTarget
    // );
    // chrome.webNavigation.onDOMContentLoaded.removeListener(
    //     this._onDOMLoaded
    // );
    // chrome.webNavigation.onReferenceFragmentUpdated.removeListener(
    //     this._onRefFragUpdated
    // );

    // network events
    // chrome.webRequest.onBeforeRequest.removeListener(this.onRequest);
    // chrome.webRequest.onBeforeRedirect.removeListener(this.onRedirect);
    if (this.userAgent) {
        chrome.webRequest.onBeforeSendHeaders.removeListener(
            this._onBeforeSendHeaders
        );
    }
    // chrome.webRequest.onCompleted.removeListener(this.onCompleted);
    // chrome.webRequest.onErrorOccurred.removeListener(this.onReqError);
    // chrome.webRequest.onHeadersReceived.removeListener(this.onHeaders);
    // chrome.webRequest.onResponseStarted.removeListener(this.onResponse);
    // chrome.webRequest.onSendHeaders.removeListener(this._onSendHeaders);
};


// MacroPlayer.prototype.onBeforeNavigate = function(details) {
//     if (details.tabId != this.tab_id)
//         return;
//     console.log("onBeforeNavigate: %O", details);
// };


// MacroPlayer.prototype.reviseActiveNavigations = function() {
//     var count = this.activeNavigations.size;
//     if (count == 0) {
//         if (this.afterCompleteTimeout) {
//             // we're waiting for navigation completion after
//             // onTabUpdated with 'complete' fired
//             clearTimeout(this.afterCompleteTimeout);
//             this.afterCompleteTimeout = null;
//         }
//         this.activeNavigations.clear();
//         this.waitingForPageLoad = false;
//         this.stopTimer("loading");
//         if (!this.waitForDownloadCompleted && !this.waitForDownloadCreated)
//             this.next("Page load complete2, url="+this.currentURL);
//     }

//     return count;
// };

// MacroPlayer.prototype.onNavigationCompleted = function(details) {
//     if (details.tabId != this.tab_id)
//         return;
//     console.log("onNavigationCompleted: %O", details);

//     if (this.playing && /^(?:https?|file)/.test(details.url)) {
//         this.activeNavigations.delete(details.frameId+":"+details.processId);
//         this.reviseActiveNavigations();
//     }
// };


MacroPlayer.prototype.onNavigationErrorOccured = function(details) {
    if (details.tabId != this.tab_id)
        return;

    // console.error("onNavigationErrorOccured: %O", details);
    if (this.playing) {
        // workaround for #223, see crbug.com/117043
        if (/net::ERR_ABORTED/.test(details.error)) {
            // var navigation = details.frameId+":"+details.processId;
            // this.activeNavigations.delete(navigation);
            // this.reviseActiveNavigations();
            return;
        }

        this.handleError(new RuntimeError(
            "Navigation error occured while loading url "+
                details.url+", details: "+details.error, 733));
        this.stopTimer("loading");
        this.waitingForPageLoad = false;
        // this.activeNavigations.clear();
        return;
    }
};



// MacroPlayer.prototype.onNavigationCommitted = function(details) {
//     if (details.tabId != this.tab_id)
//         return;

//     console.log("onNavigationCommitted: %O", details);

//     if (this.playing && /^(?:https?|file)/.test(details.url)) {
//         this.waitingForPageLoad = true;
//         this.activeNavigations.add(details.frameId+":"+details.processId);
//         if (!this.timers.has("loading")) {
//             var mplayer = this;
//             this.startTimer("loading", this.timeout, "Loading ", function() {
//                 mplayer.waitingForPageLoad = false;
//                 mplayer.handleError(
//                     new RuntimeError("Page loading timeout"+
//                                      ", URL: "+mplayer.currentURL, 602));
//             });
//         }
//     }
// };


// MacroPlayer.prototype.onCreatedNavigationTarget = function(details) {
//     console.log("onCreatedNavigationTarget: %O", details);
// };


// MacroPlayer.prototype.onDOMContentLoaded = function(details) {
//     console.log("onDOMContentLoaded: %O", details);
// };

// MacroPlayer.prototype.onReferenceFragmentUpdated = function(details) {
//     console.log("onReferenceFragmentUpdated: %O", details);
// };




// network events
MacroPlayer.prototype.onAuthRequired = function(details, callback) {
    // console.log("onAuthRequired: %O", details);
    if (this.tab_id != details.tabId)
        return;
    if (this.lastAuthRequestId == details.requestId) {
        asyncRun(this.handleError.bind(this)(new RuntimeError(
            "Wrong credentials for HTTP authorization"
        ), 734));
        return {cancel: true};
    }
    this.lastAuthRequestId = details.requestId;
    if (!this.loginData || !this.waitForAuthDialog) {
        asyncRun(this.handleError.bind(this)(new RuntimeError(
            "No credentials supplied for HTTP authorization"
        ), 734));
        return {cancel: true};
    }
    var rv = {
        authCredentials: {
            username: this.loginData.username,
            password: this.loginData.password
        }
    };
    delete this.loginData;

    return rv;
};


// MacroPlayer.prototype.onBeforeRequest = function(details) {
//     console.log("onBeforeRequest: %O", details);
// };

// MacroPlayer.prototype.onBeforeRedirect = function(details) {
//     console.log("onBeforeRedirect: %O", details);
// };


MacroPlayer.prototype.onBeforeSendHeaders = function(details) {
    // console.log("onBeforeSendHeaders: %O", details);
    for (var i = 0; i < details.requestHeaders.length; i++)
        if (details.requestHeaders[i].name == 'User-Agent') {
            details.requestHeaders[i].value = this.userAgent;
            break;
        }
    return {requestHeaders: details.requestHeaders};
};

// MacroPlayer.prototype.onReqCompleted = function(details) {
//     console.log("onReqCompleted: %O", details);
// };


// MacroPlayer.prototype.onErrorOccurred = function(details) {
//     console.log("onErrorOccured: %O", details);
// };

// MacroPlayer.prototype.onHeadersReceived = function(details) {
//     console.log("onHeadersReceived: %O", details);
// };

// MacroPlayer.prototype.onResponseStarted = function(details) {
//     console.log("onResponseStarted: %O", details);
// };

// MacroPlayer.prototype.onSendHeaders = function(details) {
//     console.log("onSendHeaders: %O", details);
// };


MacroPlayer.prototype.onTabActivated = function(activeInfo) {
    if (activeInfo.windowId == this.win_id) {
        // console.log("onTabActivated, tabId="+activeInfo.tabId);
        (this.eventMode? attach_debugger(activeInfo.tabId) : Promise.resolve())
            .then(() => (this.tab_id = activeInfo.tabId))
    }
};


// listen to page load events
MacroPlayer.prototype.onTabUpdated = function(tab_id, obj, tab) {
    if (this.tab_id != tab_id)
        return;
    // console.log("onTabUpdated, changeInfo=%O, tab=%O", obj, tab);
    if (tab.url == "about:blank") // ignore about:blank urls
        return;
    this.currentURL = tab.url;
    if (obj.status == "loading" && !this.timers.has("loading")) {
        this.waitingForPageLoad = true;
        this.startTimer("loading", this.timeout, "Loading ", function() {
            mplayer.waitingForPageLoad = false;
            mplayer.handleError(
                new RuntimeError("Page loading timeout"+
                                 ", URL: "+mplayer.currentURL, 602));
        });
        // We need to catch "loading" event as early as possible
        // onTabUpdated may be fired too late in some cases.
        // For example, Amazon search box triggers page load event
        // where onTabUpdated reports 'complete' prematurely and
        // the next TAG commad may be executed before search results
        // appeared on the page
    } else if (obj.status == "complete") {
        if (this.waitForAuthDialog && this.lastAuthRequestId) {
            delete this.lastAuthRequestId;
            this.waitForAuthDialog = false;
            chrome.webRequest.onAuthRequired.removeListener(this.onAuth);
        }
        if (this.waitingForPageLoad) {
            this.waitingForPageLoad = false;
            this.stopTimer("loading");
            this.next("onTabUpdated, status = complete");
        }
        return;

        // if (this.waitingForPageLoad && this.activeNavigations.size != 0) {
        //     // there are some loadings in queue, start timeout
        //     // to let them finish (in 5s)
        //     var mplayer = this;
        //     this.afterCompleteTimeout = setTimeout(function() {
        //         mplayer.waitingForPageLoad = false;
        //         mplayer.stopTimer("loading");
        //         if (!mplayer.waitForDownloadCompleted &&
        //             !mplayer.waitForDownloadCreated)
        //             mplayer.next("Page load complete1, url="+
        //                          mplayer.currentURL);
        //     }, 5000);
        // }
    }
};


MacroPlayer.prototype.startTimer = function(type, timeout, msg, callback) {
    // only one timer of the type at a time is allowed
    console.assert(!this.timers.has(type));

    var mplayer = this;

    var timer = new Object();
    timer.start = performance.now();

    timer.timeout = setTimeout(function() {
        mplayer.stopTimer(type);
        typeof(callback) == "function" && callback();
    } , timeout*1000);

    timer.interval = setInterval(function() {
        var now = performance.now();
        var elapsedTime = (now - timer.start)/1000;
        if (elapsedTime > timeout) {
            mplayer.stopTimer(type);
            typeof(callback) == "function" && callback();
        }
        // change panel/badge text
        var panel = context[mplayer.win_id].panelWindow;
        if (panel && !panel.closed) {
            panel.setStatLine(msg+elapsedTime.toFixed(1)+
                              "("+Math.round(timeout)+")s",
                              "warning");
        }

        badge.set(mplayer.win_id, {
            status: "loading",
            text: Math.round(elapsedTime) // make sure it is integer
        });

    }, 200);

    this.timers.set(type, timer);
};

MacroPlayer.prototype.stopTimer = function(type) {
    if (!this.timers.has(type))
        return;
    var timer = this.timers.get(type);
    clearTimeout(timer.timeout);
    clearInterval(timer.interval);
    this.timers.delete(type);
    timer = null;
};


MacroPlayer.prototype.clearRetryInterval = function() {
    if (this.retryInterval) {
        clearInterval(this.retryInterval);
        delete this.retryInterval;
    }
}

MacroPlayer.prototype.retry = function(onerror, msg, caller_id, timeout) {
    if (!this.playing)
    return;

    if (timeout === undefined) {
        timeout = this.timeout/10;
    }
    var _timeout = timeout*1000; // ms
    if (!this.retryInterval) {
        var start_time = performance.now();
        this.retryInterval = setInterval(() => {
            if (!this.playing) {
                this.clearRetryInterval()
                return
            }
            var remains = start_time +
                _timeout - performance.now();
            if (remains <= 0) {
                this.clearRetryInterval();
                try {
                    typeof(onerror) == "function" && onerror();
                } catch(e) {
                    if (this.ignoreErrors) {
                        this.action_stack.pop();
                        this.next("skipped retry() - error ignored");
                    } else {
                        this.handleError(e);
                    }
        }
            } else {
                // set badge text
                let text = Math.round(remains/1000);
                while(text.length < 2)
                    text = "0"+text;
                text += "s";
                badge.set(this.win_id, {
                    status: "tag_wait",
                    text: text
                });

                // set panel text
                let panel = context[this.win_id].panelWindow;
                if (panel && !panel.closed) {
                    panel.setStatLine(msg+(remains/1000).toFixed(1)+
                                      "("+Math.round(_timeout/1000)+")s",
                                      "warning");
                }
            }
        }, 500);
    }
    this.action_stack.push(this.currentAction);
    setTimeout(() => {
        this.playNextAction("retry "+caller_id);
    }, 500);
};


// handle messages from content-scripts
MacroPlayer.prototype.onTagComplete = function(data) {
    if (!data.found) {
        this.retry(() => {
            if (data.extract) {
                this.showAndAddExtractData("#EANF#");
                this.action_stack.pop();
        this.next("onTagComplete");
            } else {
        throw data.error;
            }
        }, "Tag waiting... ", "onTagComplete", this.timeout_tag);

        return;
    }

    this.clearRetryInterval();

    if (data.error) {
        this.handleError(data.error);
    } else if (data.selector) {
        this.handleInputFileTag(data.selector, data.files)
            .then(() => this.next("onTagComplete"))
            .catch(e => this.handleError(e))
    } else if (data.decryptPassword) {
        this.shouldDecryptPassword = true
        this.action_stack.push(this.currentAction)
        this.next("Decrypt content string")
    } else {
        if (data.extract) {
            this.showAndAddExtractData(data.extract);
        } else if (data.targetURI) {
            this.saveTarget(data.targetURI);
        }
        // .next() will be called in onDownloadCreated otherwise
        if (!this.waitForDownloadCreated && !this.waitForAuthDialog)
            this.next("onTagComplete");
    }
};


// MacroPlayer.prototype.onContentChange = function(data, tab_id, callback) {
//     typeof (callback) == "function" &&   // release resources
//         callback();

//     if (this.tab_id != tab_id)
//         return;
//     var mplayer = this;
//     chrome.tabs.get(tab_id, function(tab) {
//         if (!tab) return;
//         if (Storage.getBool("debug"))
//             console.debug("content-change, url "+tab.url);

//         // This is for TAG commands acting on <a> elements
//         // because tab.onUpdated() is fired too late
//         if (mplayer.playing) {
//             mplayer.waitingForPageLoad = true;
//         }
//     });
// };


MacroPlayer.prototype.terminate = function() {
    if (Storage.getBool("debug"))
        console.info("terminating player for window "+this.win_id);
    // ensure that player is stopped
    if (this.playing)
        this.stop();
};


// a pattern to match a double quoted string or eval() command
// or a non-whitespace char sequence
var im_strre = "(?:\"(?:[^\"\\\\]|\\\\[0btnvfr\"\'\\\\])*\"|"+
    "eval\\s*\\(\"(?:[^\"\\\\]|\\\\[\\w\"\'\\\\])*\"\\)|"+
    "\\S*)";

// const im_strre = "(?:\"(?:[^\"\\\\]|\\\\[0btnvfr\"\'\\\\])*\"|\\S*)";


MacroPlayer.prototype.noContentPage = function(cmd_name) {
    if (!/^https?|file/i.test(this.currentURL))
        this.handleError(
            new RuntimeError(
                cmd_name+" command can not be executed because"+
                    " it requires a Web page loaded in active tab."+
                    " Current page is "+this.currentURL, 612
            )
        );
};


// ADD command http://wiki.imacros.net/ADD
// regexp for parsing ADD command
MacroPlayer.prototype.RegExpTable["add"] =
    "^(\\S+)\\s+("+im_strre+")\\s*$";

MacroPlayer.prototype.ActionTable["add"] = function (cmd) {
    var param = imns.unwrap(this.expandVariables(cmd[2], "add2"));
    var m = null;

    if ( m = cmd[1].match(this.limits.varsRe) ) {
        var num = imns.s2i(m[1]);
        var n1 = imns.s2i(this.getVar(num)), n2 = imns.s2i(param);
        if ( !isNaN(n1) && !isNaN(n2) ) {
            this.vars[num] = (n1 + n2).toString();
        } else {
            this.vars[num] = this.getVar(num) + param;
        }
    } else if ( arr = cmd[1].match(/^!extract$/i) ) {
        this.addExtractData(param);
    } else if (/^!\S+$/.test(cmd[1])) {
        throw new BadParameter("Unsupported variable "+cmd[1]+
                               " for ADD command");
    } else {
        var n1 = imns.s2i(this.getUserVar(cmd[1])), n2 = imns.s2i(param);
        if ( !isNaN(n1) && !isNaN(n2) ) {
            this.setUserVar(cmd[1], (n1 + n2).toString());
        } else {
            this.setUserVar(cmd[1], this.getUserVar(cmd[1])+param);
        }
    }

    this.next("ADD");
};


MacroPlayer.prototype.RegExpTable["back"] = "^\\s*$";

MacroPlayer.prototype.ActionTable["back"] = function (cmd) {
    if (this.noContentPage("BACK"))
        return;

    chrome.tabs.get(this.tab_id, function(tab) {
        if (/^(?:https?|file)/.test(tab.url))
            communicator.postMessage("back-command", {}, tab.id,
                                     function() {},
                                     {number: 0});
    });
    // mplayer.next() will be called on load-complete event
};


// CLEAR command http://wiki.imacros.net/CLEAR
// I added new optional parameter to the command which restricts
// cookies removal to specified domain/url
MacroPlayer.prototype.RegExpTable["clear"] = "^\\s*("+im_strre+")?\\s*$";

MacroPlayer.prototype.ActionTable["clear"] = function (cmd) {
    var specifier = cmd[1] ?
        imns.unwrap(this.expandVariables(cmd[1], "clear1")) : null;
    var details = {};
    if (specifier) {
        if (/^http/.test(specifier)) {
            details.url = specifier;
        } else if (/^[\w\.]+$/.test(specifier)) {
            details.domain = specifier;
        } else {
            throw new BadParameter("domain name or URL", 1);
        }
    }

    var mplayer = this;
    chrome.cookies.getAll(details, function(cookies) {
        cookies.forEach(function(cookie) {
            // TODO: check if we should omit storeId here.
            // As for now I think that only current execution context
            // store's cookies should be removed
            var url = (cookie.secure? "https" : "http")+"://"+
                cookie.domain+cookie.path;
            chrome.cookies.remove({url: url, name: cookie.name});
        });
        mplayer.next("CLEAR");
    });
};


// EVENT command
MacroPlayer.prototype.RegExpTable["event"] =
    "type\\s*=\\s*("+im_strre+")"+
    "(?:\\s+(selector|xpath)\\s*=\\s*("+im_strre+"))?"+
    "(?:\\s+(button|key|char|point)\\s*=\\s*("+im_strre+"))?"+
    "(?:\\s+modifiers\\s*=\\s*("+im_strre+"))?";

MacroPlayer.prototype.attachDebugger = function(version) {
    return this.debuggerAttached ?
        Promise.resolve() : attach_debugger(this.tab_id, version).then(() => {
            this.debuggerAttached = true
        })
}

MacroPlayer.prototype.detachDebugger = function() {
    return this.debuggerAttached ?
        detach_debugger(this.tab_id).then(() => {
            this.debuggerAttached = false
        }) : Promise.resolve()
}

function attach_debugger(tab_id, version = "1.2") {
    return new Promise(function(resolve, reject) {
        chrome.debugger.attach({tabId: tab_id}, version, function() {
            if (chrome.runtime.lastError)
                reject(chrome.runtime.lastError);
            else
                resolve();
        });
    });
}

function send_command(tab_id, method, params) {
    return new Promise(function(resolve, reject) {
        chrome.debugger.sendCommand(
            {tabId: tab_id}, method, params,
            function(response) {
                if (chrome.runtime.lastError)
                    reject(chrome.runtime.lastError);
                else
                    resolve(response);
            }
        );
    });
}

function detach_debugger(tab_id) {
    return new Promise(function(resolve, reject) {
        chrome.debugger.detach({tabId: tab_id}, function() {
            if (chrome.runtime.lastError)
                reject(chrome.runtime.lastError);
            else
                resolve();
        });
    });
}

function get_modifiers_bitmask(modifiers) {
    var altKey = /alt/i.test(modifiers) && 1 || 0;
    var ctrlKey = /ctrl/i.test(modifiers) && 2 || 0;
    var metaKey = /meta/i.test(modifiers) && 4 || 0;
    var shiftKey = /shift/i.test(modifiers) && 8 || 0;
    return altKey | ctrlKey | metaKey | shiftKey;
}

function get_key_identifier_from_char(c) {
    var keyCode = c.toUpperCase().charCodeAt(0);
    var s = keyCode.toString(16).toUpperCase();
    while (s.length <= 4)
        s = "0" + s;
    return "U+" + s;
}

function get_key_identifier_from_keycode(code) {
    // the table is build based on https://developer.mozilla.org/en-US/docs/Web/API/KeyboardEvent/key#Key_values_on_Windows_(and_char_values_of_IE)
    var ids = {
        0x08: "Backspace",
        0x09: "Tab",
        0x0C: "Clear",
        0x0D: "Enter",
        0x10: "Shift",
        0x11: "Control",
        0x12: "Alt",
        0x13: "Pause",
        0x14: "CapsLock",
        0x15: "KanaMode",
        0x17: "JunjaMode",
        0x18: "HanjaMode",
        0x19: "KanjiMode",
        0x1B: "Esc",
        0x1C: "Convert",
        0x1D: "Nonconvert",
        0x1E: "Accept",
        0x1F: "ModeChange",
        0x21: "PageUp",
        0x22: "PageDown",
        0x23: "End",
        0x24: "Home",
        0x25: "Left",
        0x26: "Up",
        0x27: "Right",
        0x28: "Down",
        0x29: "Select",
        0x2B: "Execute",
        0x2C: "PrintScreen",
        0x2D: "Insert",
        0x2E: "Del",
        0x2F: "Help",
        0x5B: "Win",
        0x5C: "Win",
        0x5D: "Apps",
        0x70: "F1",
        0x71: "F2",
        0x72: "F3",
        0x73: "F4",
        0x74: "F5",
        0x75: "F6",
        0x76: "F7",
        0x77: "F8",
        0x78: "F9",
        0x79: "F10",
        0x7A: "F11",
        0x7B: "F12"
    };

    if (typeof ids[code] != "undefined")
        return ids[code];
    // else return Unicode value
    var s = code.toString(16).toUpperCase();
    while (s.length <= 4)
        s = "0" + s;
    return "U+" + s;
}

function get_windows_virtual_keycode(c) {
    // NOTE: It looks like Chrome uses Unicode code point as keyCode
    // for non-ASCII characters as well
    var keyCode = c.charCodeAt(0);
    return keyCode;
}

MacroPlayer.prototype.dispatchCharKeydownEvent = function(details) {
    return Promise.resolve()
    // var vk = get_windows_virtual_keycode(details.char);
    // var keyid = get_key_identifier_from_char(details.char);
    // var modifiers = get_modifiers_bitmask(details.modifiers);
    // var mplayer = this;
    // return [
    //     {"type": "rawKeyDown",
    //      "windowsVirtualKeyCode": vk,
    //      "keyIdentifier": keyid,
    //      "modifiers": modifiers}
    // ].reduce(function(seq, opts) {
    //     return seq.then(function() {
    //         return send_command(mplayer.tab_id, "Input.dispatchKeyEvent", opts);
    //     });
    // }, Promise.resolve());
};

MacroPlayer.prototype.dispatchCharKeyupEvent = function(details) {
    return Promise.resolve()
    // var vk = get_windows_virtual_keycode(details.char);
    // var keyid = get_key_identifier_from_char(details.char);
    // var modifiers = get_modifiers_bitmask(details.modifiers);
    // var mplayer = this;
    // return send_command(mplayer.tab_id, "Input.dispatchKeyEvent", {
    //     "type": "keyUp",
    //     "windowsVirtualKeyCode": vk,
    //     "keyIdentifier": keyid,
    //     "modifiers": modifiers
    // });
};


MacroPlayer.prototype.dispatchControlKeydownEvent = function(details) {
    var vk = details.key;
    var keyid = get_key_identifier_from_keycode(details.key);
    var modifiers = get_modifiers_bitmask(details.modifiers);
    var mplayer = this;
    return send_command(mplayer.tab_id, "Input.dispatchKeyEvent", {
        "type": "rawKeyDown",
        "windowsVirtualKeyCode": vk,
        "keyIdentifier": keyid,
        "modifiers": modifiers
    });
};

MacroPlayer.prototype.dispatchControlKeyupEvent = function(details) {
    var vk = details.key;
    var keyid = get_key_identifier_from_keycode(details.key);
    var modifiers = get_modifiers_bitmask(details.modifiers);
    var mplayer = this;
    return send_command(mplayer.tab_id, "Input.dispatchKeyEvent", {
        "type": "keyUp",
        "windowsVirtualKeyCode": vk,
        "keyIdentifier": keyid,
        "modifiers": modifiers
    });
};

MacroPlayer.prototype.dispatchCharKeypressEvent = function(details) {
    var vk = get_windows_virtual_keycode(details.char);
    var keyid = get_key_identifier_from_char(details.char);
    var modifiers = get_modifiers_bitmask(details.modifiers);
    var mplayer = this;
    return [
        {"type": "char",
         "text": details.char,
         "modifiers": modifiers}
    ].reduce(function(seq, opts) {
        return seq.then(function() {
            return send_command(mplayer.tab_id, "Input.dispatchKeyEvent", opts);
        });
    }, Promise.resolve());
};

MacroPlayer.prototype.dispatchControlKeypressEvent = function(details) {
    var vk = details.key;
    var keyid = get_key_identifier_from_keycode(details.key);
    var modifiers = get_modifiers_bitmask(details.modifiers);
    var mplayer = this;
    return ["rawKeyDown", "keyUp"]
        .reduce(function(seq, type) {
            return seq.then(function() {
                return send_command(mplayer.tab_id, "Input.dispatchKeyEvent", {
                    "type": type,
                    "windowsVirtualKeyCode": vk,
                    "keyIdentifier": keyid,
                    "modifiers": modifiers
                });
            });
        }, Promise.resolve());
};

MacroPlayer.prototype.dispatchKeyboardEvent = function(details) {
    var char_funcs = {
        "keydown": this.dispatchCharKeydownEvent.bind(this),
        "keyup": this.dispatchCharKeyupEvent.bind(this),
        "keypress": this.dispatchCharKeypressEvent.bind(this)
    };
    var ctrl_funcs = {
        "keydown": this.dispatchControlKeydownEvent.bind(this),
        "keyup": this.dispatchControlKeyupEvent.bind(this),
        "keypress": this.dispatchControlKeypressEvent.bind(this)
    };
    return (details.char ? char_funcs : ctrl_funcs)[details.type](details);
};

function get_mouse_button_name(button) {
    if (button == -1)
        return "none";
    else if (button == 0)
        return "left";
    else if (button == 1)
        return "middle";
    else if (button == 2)
        return "right";
    else
        return "none"; // TODO: should we handle other buttons as well?
}

function get_mouse_event_name(type) {
    if (type == "mousedown")
        return "mousePressed";
    else if (type == "mouseup")
        return "mouseReleased";
    else
        return "mouseMoved";
}

function get_target_center_point(rect) {
    return {
        x: rect.left+rect.width/2,
        y: rect.top+rect.height/2,
    };
}

MacroPlayer.prototype.dispatchMouseEvent = function(details) {
    let point = {}
    if (details.point) {
        point.x = details.point.x-details.targetRect.pageXOffset+
            details.targetRect.xOffset
        point.y = details.point.y-details.targetRect.pageYOffset+
            details.targetRect.yOffset
    } else {
        point = get_target_center_point(details.targetRect)
        point.x += details.targetRect.xOffset
        point.y += details.targetRect.yOffset
    }
    point.x = Math.round(point.x)
    point.y = Math.round(point.y)
    var type = get_mouse_event_name(details.type);
    return send_command(this.tab_id, "Input.dispatchMouseEvent", {
        "type": type,
        "button": get_mouse_button_name(details.button),
        "clickCount": details.clickCount || 0,
        "modifiers": get_modifiers_bitmask(details.modifiers),
        "x": point.x,
        "y": point.y
    });
};


MacroPlayer.prototype.ActionTable["event"] = function (cmd) {
    var type = imns.unwrap(this.expandVariables(cmd[1], "event1")).toLowerCase();
    var selector_type = cmd[2] ? cmd[2].toLowerCase() : "";
    var selector = cmd[3] ? imns.unwrap(this.expandVariables(cmd[3], "event3")) : "";
    var value_type = (cmd[4] || "").toLowerCase();
    var value = cmd[5] ? imns.unwrap(this.expandVariables(cmd[5], "event5")) : 0;
    var modifiers = cmd[6] ?
        imns.unwrap(this.expandVariables(cmd[6], "event6")) : "";

    var data = {scroll: true};
    data[selector_type || "selector"] = selector || ":root";

    this.attachDebugger().then(
        () => communicator.sendMessage(
            "activate-element", data, this.tab_id, this.currentFrame
        )
    ).then(response => {
        if (!response) {
            throw new RuntimeError(chrome.runtime.lastError.message);
        }
        else if (response.error)
            throw new RuntimeError(
                response.error.message, response.error.errnum
            )
        else
            this.clearRetryInterval()
        return response.targetRect
    }).then(targetRect => {
        var button = 0;
        var key = 0;
        var char = "";
        var point = null;

        if (!value_type) {
            ; // do nothing
        } else if (value_type == "button") {
            button = imns.s2i(value);
            if (isNaN(button))
                throw new BadParameter("integer BUTTON value", 3);
        } else if (value_type.toLowerCase() == "key") {
            key = imns.s2i(value);
            if (isNaN(key))
                throw new BadParameter("integer KEY value", 3);
        } else if (value_type.toLowerCase() == "char") {
            char = value;
        } else if (value_type.toLowerCase() == "point") {
            const point_re =
                /^\(\s*(\d+(?:\.\d+)?)\s*\,\s*(\d+(?:\.\d+)?)\s*\)$/;
            var m = null;
            if ( !(m = point_re.exec(value.trim())) )
                throw new BadParameter("(x,y) POINT value", 3);
            point = {x: parseFloat(m[1]), y: parseFloat(m[2])};
        }
        return Promise.resolve().then(() => {
            if (/^mouse/.test(type)) {
                var details = {
                    type: type,
                    point: point,
                    button: button,
                    modifiers: modifiers,
                    targetRect: targetRect
                };
                return this.dispatchMouseEvent(details);
            } else if (/^key/.test(type)) {
                var details = {
                    type: type,
                    key: key,
                    char: char,
                    modifiers: modifiers
                };
                return this.dispatchKeyboardEvent(details);
            } else if (type == "click") {
                // click is a result of mousedown/up
                return [
                    {clickCount: 1, type: "mousedown"},
                    {clickCount: 1, type: "mouseup"}
                ].map(x => ({
                    type: x.type,
                    clickCount: x.clickCount,
                    point: point,
                    button: button,
                    modifiers: modifiers,
                    targetRect: targetRect
                })).reduce((seq, details) => seq.then(
                    () => this.dispatchMouseEvent(details)
                ) , Promise.resolve())
            } else if (type == "dblclick") {
                // dblclick is a result of two mousedown/up
                return [
                    {clickCount: 1, type: "mousedown"},
                    {clickCount: 1, type: "mouseup"},
                    {clickCount: 2, type: "mousedown"},
                    {clickCount: 2, type: "mouseup"}
                ].map(x => ({
                    type: x.type,
                    clickCount: x.clickCount,
                    point: point,
                    button: button,
                    modifiers: modifiers,
                    targetRect: targetRect
                })).reduce((seq, details) => seq.then(
                    () => this.dispatchMouseEvent(details)
                ) , Promise.resolve())
            }
        })
    }).then(() => this.next("EVENT")).catch(e => {
        if (e.errnum == 721)    // if element not found
            this.retry(
                () => {
                    throw e
                }, "Tag waiting... ", "onActivateElement", this.timeout_tag
            )
        else
            this.handleError(e)
    })
};


MacroPlayer.prototype.RegExpTable["events"] =
        "type\\s*=\\s*("+im_strre+")"+
        "(?:\\s+(selector|xpath)\\s*=\\s*("+im_strre+"))?"+
        "(?:\\s+(keys|chars|points)\\s*=\\s*("+im_strre+"))?"+
        "(?:\\s+modifiers\\s*=\\s*("+im_strre+"))?";

MacroPlayer.prototype.ActionTable["events"] = function (cmd) {
    var type = imns.unwrap(this.expandVariables(cmd[1], "events1")).toLowerCase();
    var selector_type = cmd[2] ? cmd[2].toLowerCase() : "";
    var selector = cmd[3] ? imns.unwrap(this.expandVariables(cmd[3], "events3")) : "";
    var value_type = (cmd[4] || "").toLowerCase();
    var value = cmd[5] ? imns.unwrap(this.expandVariables(cmd[5], "events5")) : 0;
    var modifiers = cmd[6] ?
        imns.unwrap(this.expandVariables(cmd[6], "events6")) : "";
    var data = {scroll: true};
    data[selector_type || "selector"] = selector || ":root";
    this.attachDebugger().then(
        () => communicator.sendMessage(
            "activate-element", data, this.tab_id, this.currentFrame
        )
    ).then(response => {
        if (response.error)
            throw new RuntimeError(
                response.error.message, response.error.errnum
            )
        else
            this.clearRetryInterval()

        return response
    }).then(resp => {
        // parse value
        if (value_type.toLowerCase() == "chars") {
            if (resp.isPasswordElement) {
                return this.decrypt(value).then(decryptedString => ({
                    chars: decryptedString.split("")
                }))
            } else {
                return {chars: value.split("")}
            }
        } else if (value_type.toLowerCase() == "keys") {
            let keys_re = /\[\d+(?:\s*,\s*\d+)*\]/
                if ( !keys_re.test(value.trim()) )
                    throw new BadParameter("[k1,..,kn] as KEYS value", 3);
            return {keys: JSON.parse(value)}
        } else if (value_type.toLowerCase() == "points") {
            let points_re = /^(?:\s*\(\d+(?:\.\d+)?\s*\,\s*\d+(?:\.\d+)?\s*\)(?:\s*,\s*)?)+$/
                if ( !points_re.test(value.trim()) )
                    throw new BadParameter("(x,y)[,(x,y)] as POINTS value", 3);
            let point_re = /\(\s*(\d+(?:\.\d+)?)\s*\,\s*(\d+(?:\.\d+)?)\s*\)/g
            let points = []
            while(m = point_re.exec(value)) {
                points.push({x: parseFloat(m[1]), y: parseFloat(m[2])});
            }
            return {points: points, targetRect: resp.targetRect}
        }
    }).then(value => {
        if (type == "mousemove") {
            return value.points.map(point => ({
                type: type,
                point: point,
                targetRect: value.targetRect,
                modifiers: modifiers
            })).reduce((seq, details) => seq.then(
                () => this.dispatchMouseEvent(details)
            ) , Promise.resolve())
        } else if (/^key/.test(type) && value.keys) {
            return value.keys.map(key => ({
                type: type,
                key: key,
                modifiers: modifiers
            })).reduce((seq, details) => seq.then(
                () => this.dispatchKeyboardEvent(details)
            ) , Promise.resolve())
        } else if (/^key/.test(type) && value.chars) {
            return value.chars.map(char => ({
                type: type,
                char: char,
                modifiers: modifiers
            })).reduce((seq, details) => seq.then(
                () => this.dispatchKeyboardEvent(details)
            ), Promise.resolve())
        } else {
            throw RuntimeError("Can not process event type "+type, 711)
        }
    }).then(
        () => this.next("EVENTS")
    ).catch(e => {
        if (e.errnum == 721)    // if element not found
            this.retry(
                () => {
                    throw e
                }, "Tag waiting... ", "onActivateElement", this.timeout_tag
            )
        else
            this.handleError(e)
    })
};


MacroPlayer.prototype.decrypt = function(str) {
    this.waitingForPassword = true
    return Promise.resolve().then(() => {
        if (this.encryptionType == "no") {
            return str
        } else if (this.encryptionType == "stored") {
            let pwd = Storage.getChar("stored-password")
            // stored password is base64 encoded
            pwd = decodeURIComponent(atob(pwd))
            // throws error if password does not match
            return Rijndael.decryptString(str, pwd)
        } else if (this.encryptionType == "tmpkey") {
            let p = Rijndael.tempPassword ? Promise.resolve({
                password: Rijndael.tempPassword
            }) : dialogUtils.openDialog("passwordDialog.html",
                                        "iMacros Password Dialog",
                                        {type: "askPassword"})
            return p.then(result => {
                if (result.canceled) {
                    this.waitingForPassword = false
                    throw new RuntimeError(
                        "Password input has been canceled", 743
                    )
                }
                try {
                    let rv = Rijndael.decryptString(str, result.password)
                    Rijndael.tempPassword = result.password
                    return rv
                } catch(e) {
                    // wrong password, try again
                    return this.decrypt(str)
                }
            })
        } else {
            throw new RuntimeError(
                "Unsupported encryption type: "+this.encryptionType, 711
            )
        }
    }).then(decryptedString => {
        this.waitingForPassword = false
        return decryptedString
    }).catch(e => {
        this.waitingForPassword = false
        throw e
    })
}

// FRAME command http://wiki.imacros.net/FRAME
MacroPlayer.prototype.RegExpTable["frame"] =
    "^(f|name)\\s*=\\s*("+im_strre+")\\s*$";

MacroPlayer.prototype.onFrameComplete = function(data) {
    if (!data.frame) {
        var self = this;
        this.retry(function() {
            self.currentFrame = {number: 0};
            throw new RuntimeError("frame "+param+" not found", 722);
        }, "Frame waiting... ", "onFrameComplete", this.timeout_tag);
    } else {
        this.clearRetryInterval();
        this.currentFrame = data.frame;
        this.next("onFrameComplete");
    }
};

MacroPlayer.prototype.ActionTable["frame"] = function (cmd) {
    var type = cmd[1].toLowerCase();
    var param = imns.unwrap(this.expandVariables(cmd[2], "frame2"));
    var frame_data = new Object();

    if (type == "f") {
        param = imns.s2i(param);
        if (isNaN(param))
            throw new BadParameter("F=<number>", 1);

        // shortcut for main frame
        if (param == 0) {
            this.currentFrame = {number: 0};
            this.next("FRAME");
            return;
        }
    }

    if (type == "f")
        frame_data.number = param;
    else if (type == "name")
        frame_data.name = param;

    var self = this;

    communicator.postMessage("frame-command", frame_data, this.tab_id,
                             this.onFrameComplete.bind(this),
                             {number: 0});
};



// IMAGESEARCH command http://wiki.imacros.net/IMAGESEARCH
MacroPlayer.prototype.RegExpTable["imagesearch"] =
    "^pos\\s*=\\s*("+im_strre+
    ")\\s+image\\s*=\\s*("+im_strre+")\\s+"+
    "confidence\\s*=\\s*("+im_strre+")";

MacroPlayer.prototype.ActionTable["imagesearch"] = function (cmd) {
    var pos = imns.s2i(imns.unwrap(
        this.expandVariables(cmd[1], "imagesearch1")
    ));
    var image = imns.unwrap(this.expandVariables(cmd[2], "imagesearch2"));
    var cl = imns.s2i(imns.unwrap(
        this.expandVariables(cmd[3], "imagesearch3")
    ));

    if (!__is_windows()) {
        throw new UnsupportedCommand("IMAGESEARCH");
    }

    if (!this.afioIsInstalled) {
        throw new RuntimeError(
            "IMAGESEARCH command requires File IO interface", 660
        );
    }

    if (!__is_full_path(image)) {
        // NOTE: we assume here that defdatapath is already set which
        // may not be true under some (rare) circumstances
        var default_dir = afio.openNode(localStorage["defdatapath"]);
    default_dir.append(image);
    image = default_dir.path;
    }

    var mplayer = this;
    communicator.postMessage("webpage-hide-scrollbars",{hide: true}, mplayer.tab_id,()=>{});
    this.captureWebPage(function(_) {
        communicator.postMessage("webpage-hide-scrollbars",{hide: false}, mplayer.tab_id,()=>{});
    // chrome.tabs.captureVisibleTab(this.win_id, {format: "png"}, function(_) {
        const host = "com.ipswitch.imacros.host";
        var msg_no_free_beer = "This feature requires"+
            " the iMacros image recognition library,"+
            " which is part of the commercial iMacros Standard"+
            " and Enterprise Editions";
        var re = /data\:([\w-]+\/[\w-]+)?(?:;(base64))?,(.+)/;
        var m = re.exec(_);
        if (!m) {
            mplayer.handleError(
                new RuntimeError("Can not parse image data"+_), 701
            );
            return;
        }
        console.assert(m[1] == "image/png");
        var request = {
            type: "do_image_search",
            image_data: m[3],
            sample_path: image,
            pos: pos-1,         // zero-based index expected
            cl: cl
        };
        chrome.runtime.sendNativeMessage(host, request, function(result) {
            if (chrome.runtime.lastError) {
                var nf = "Specified native messaging host not found";
                if (chrome.runtime.lastError.message.match(nf)) {
                    mplayer.handleError(
                        new RuntimeError(msg_no_free_beer), 702
                    );
                } else {
                    mplayer.handleError(chrome.runtime.lastError);
                }
                return;
            }

            if (result.type == "error") {
                mplayer.handleError(new RuntimeError(result.error), 703);
                return;
            }

            if(!result.found) {
                mplayer.retry(function() {
                    throw new RuntimeError(
                        "Image specified by "+image+
                            " does not match the web-page", 727);
                }, "Image waiting... ", "onImageSearch", mplayer.timeout_tag*4);
                return;
            }
            mplayer.clearRetryInterval();
            communicator.postMessage(
                "image-search-command",
                result, mplayer.tab_id,
                function() {
                    mplayer.imageX = result.x;
                    mplayer.imageY = result.y;
                    mplayer.next("IMAGESEARCH");
                },
                {number: 0}
            );
        });
    });
};



// ONDOWNLOAD command http://wiki.imacros.net/ONDOWNLOAD
MacroPlayer.prototype.RegExpTable["ondownload"] =
    "^folder\\s*=\\s*("+im_strre+")\\s+"+
    "file\\s*=\\s*("+im_strre+")"+
    "(?:\\s+wait\\s*=(yes|no|true|false))?"+
    "(?:\\s+checksum\\s*=(md5|sha1):(\\S+))?"+
    "\\s*$";

MacroPlayer.prototype.ActionTable["ondownload"] = function (cmd) {
    var obj = new Object();
    var wait = true;
    var folder = imns.unwrap(this.expandVariables(cmd[1], "ondownload1"));
    
    if (folder !== "*" && !this.afioIsInstalled) {
        throw new BadParameter("FOLDER requires File Access for iMacros Extensions. Specify FOLDER=* to save file to the browser's default download folder.");
    }
    
    var file = imns.unwrap(this.expandVariables(cmd[2], "ondownload2"));
    if (typeof cmd[3] != "undefined") {
        var param = imns.unwrap(this.expandVariables(cmd[3], "ondownload3"));
        wait = /^(?:yes|true)$/i.test(param);
    }
    if (typeof cmd[4] != "undefined") {
        // TODO: add checksum check support to afio.exe?
        throw new UnsupportedCommand("ONDOWNLOAD ... CHECKSUM=");
        // if (!wait) {
        //     throw new BadParameter("CHECKSUM requires WAIT=YES", 3);
        // }
        // this.downloadCheckAlg = imns.unwrap(
        //     this.expandVariables(cmd[4], "ondownload4")
        // );
        // this.downloadChecksum = imns.unwrap(
        //     this.expandVariables(cmd[5], "ondownload5")
        // ).toLowerCase();
    }

    // a sanity check to ensure that only one ONDOWNLOAD was set for an action
    if (this.waitForDownloadCreated) {
        throw new Error("only one ONDOWNLOAD command should be used for each download");
    }

    this.waitForDownloadCreated = true;
    this.waitForDownloadCompleted = wait;
    this.downloadFolder = folder;
    this.downloadFilename = file;
    this.shouldDownloadPDF = true;
    if (!this.downloadHooksRegistered) {
        this.downloadHooksRegistered = true
        chrome.downloads.onCreated.addListener(this._onDownloadCreated);
        chrome.downloads.onChanged.addListener(this._onDownloadChanged);
        context.registerDfHandler(this.win_id);
    }
    this.next("ONDOWNLOAD");
};

// a handler passed to a singleton onDeterminingFilename event listener
// stored in context object
MacroPlayer.prototype.onDeterminingFilename = function(dl, suggest) {
    if (!this.activeDownloads.has(dl.id))
        return false;

    //  Get file name and extension from the source uri.
    var filename = "", m = null, name = "", ext = "";
    if ( m = dl.url.match(/\/([^\/?]+)(?=\?.+|$)/) ) {
    name = m[1];
    if (m = name.match(/\.([^\.\s]+)$/)) {
        ext = m[1];
        name = name.replace(/\.[^\.\s]+$/, "");
    }
    }
    var dl_obj = this.activeDownloads.get(dl.id);
    if (dl_obj.downloadFilename == "*") {
        return false;
    } else if (/^\+/.test(dl_obj.downloadFilename)) {
    filename = name+dl_obj.downloadFilename.substring(1)+"."+ext;
    } else {
        // TODO: I'm not sure if we should replace the provided extension
    // if (/\.[^\.\s]+$/i.test(this.downloadFilename))
    //     filename = this.downloadFilename.replace(/\.[^\.\s]+$/, "."+ext);
    // else
    filename = dl_obj.downloadFilename;
    }
    // NOTE: I guess "overwrite" is the proper action here since user
    // should know best if any name conflicts are possible
    suggest({filename: filename, conflictAction: "overwrite"});

    return true;
};



MacroPlayer.prototype.onDownloadCompleted = function(id) {
    // console.log("onDownloadCompleted, id=%d", id);
    var dl_obj = this.activeDownloads.get(id);
    this.activeDownloads.delete(id);

    // do cleanup
    if (this.downloadHooksRegistered && this.activeDownloads.size == 0) {
        chrome.downloads.onCreated.removeListener(this._onDownloadCreated);
        chrome.downloads.onChanged.removeListener(this._onDownloadChanged);
        context.unregisterDfHandler(this.win_id);
        this.downloadHooksRegistered = false
    }

    if (!this.afioIsInstalled) {
        if (this.waitForDownloadCompleted) {
            this.next("onDownloadCompleted");
            this.stopTimer("download");
            this.waitForDownloadCompleted = false;
        }
        return;
    }
    var dest_dir = null;
    if (dl_obj.downloadFolder == "*") {
        dest_dir = this.defDownloadFolder.clone()
    } else {
        dest_dir = afio.openNode(dl_obj.downloadFolder);
    }
    var mplayer = this;
    dest_dir.exists().then(function(exists) {
        if (!exists)
            throw new RuntimeError("Path "+folder+" does not exist", 732);

        var file = afio.openNode(dl_obj.downloadFilename);
        dest_dir.append(file.leafName);
        // set !DOWNLOADED_FILE_NAME
        mplayer.downloadedFilename = dest_dir.path;
        // console.log("onDownloadCompleted, id=%d, file=%s, dest=%s", id,
        //             file.path, dest_dir.path);
        return dest_dir.exists().then(function(exists) {
            // a workaroud  for Windows - remove existing file before moving
            // the downloaded file
            return exists ?  dest_dir.remove() : Promise.resolve();
        }).then(function() {
            return file.moveTo(dest_dir).then(function() {
                if (mplayer.waitForDownloadCompleted) {
                    mplayer.stopTimer("download");
                    mplayer.waitForDownloadCompleted = false;
                    mplayer.next("onDownloadCompleted");
                }
            });
        });
    }).catch(function(err) {
        mplayer.handleError(err);
    });
};


MacroPlayer.prototype.onDownloadCreated = function(dl) {
    // console.log("onDownloadCreated %O", dl);
    if (dl.state != "in_progress")
        return;
    if (dl.referrer && dl.referrer != this.currentURL)
        return;
    console.assert(this.waitForDownloadCreated);
    // a scary warning to handle messed up cases where TAG command
    // that triggers a download precedes ONDOWNLOAD command (see #414)
    if (!this.waitForDownloadCreated) {
        this.handleError(new Error(
            "A download is started but no matching ONDOWNLOAD command was found"
        ));
        return;
    }
    this.waitForDownloadCreated = false;

    // NOTE: it is not guaranteed that this is 'our' download because other
    // tabs with the very same URL may initiate a download at the same time
    var dl_obj = {
        downloadFilename: this.downloadFilename,
        downloadFolder: this.downloadFolder
    };
    this.activeDownloads.set(dl.id, dl_obj);
    this.downloadedSize = dl.fileSize;
    if (this.waitForDownloadCompleted) {
        var mplayer = this;
        this.startTimer(
            "download",
            this.timeout_download,
            "Loading file ",
            function() {
                mplayer.waitForDownloadCompleted = false;
                mplayer.handleError(
                    new RuntimeError("Download timeout", 604));
            });
    } else {
        this.next("onDownloadCreated");
    }
};

MacroPlayer.prototype.onDownloadChanged = function(changeInfo) {
    // console.log("onDownloadChanged %O", changeInfo);
    if (!this.activeDownloads.has(changeInfo.id))
        return;

    if (changeInfo.filename) {
        this.activeDownloads.get(changeInfo.id).downloadFilename =
            changeInfo.filename.current;
        // set !DOWNLOADED_FILE_NAME
        this.downloadedFilename = changeInfo.filename.current;
    }
    if (changeInfo.state && changeInfo.state.current == "complete") {
        this.onDownloadCompleted(changeInfo.id);
    }
};

MacroPlayer.prototype.saveTarget = function(url) {
    var self = this;
    chrome.downloads.download({url: url}, function(dl_id) {
        // NOTE: The download object will be set inside
        // onDownloadCreated handler
        // console.log("download id=%d", dl_id);
        // var dl_obj = {
        //     downloadFilename: this.downloadFilename,
        //     downloadFolder: this.downloadFolder
        // };
        // self.activeDownloads.set(dl_id, dl_obj);
    });
};

// ONERRORDIALOG command http://wiki.imacros.net/ONERRORDIALOG

MacroPlayer.prototype.RegExpTable["onerrordialog"] =
    "^(?:button\\s*=\\s*(?:\\S*))?\\s*(?:\\bcontinue\\s*=\\s*(\\S*))?\\s*$"

MacroPlayer.prototype.ActionTable["onerrordialog"] = function (cmd) {
    var param = cmd[1] ? imns.unwrap(this.expandVariables(cmd[1], "onerrordialog1")) : "";
    if (/^no|false$/i.test(param)) {
        this.shouldStopOnError = true;
    }

    this.next("ONERRORDIALOG");
};


MacroPlayer.prototype.onErrorOccurred = function(data) {
    if (!this.playing || !this.shouldStopOnError)
        return;

    this.handleError(data);
};

// TODO: maybe onscripterror should have another syntax?
// now these are plain references
MacroPlayer.prototype.RegExpTable["onscripterror"] =
    MacroPlayer.prototype.RegExpTable["onerrordialog"];


MacroPlayer.prototype.ActionTable["onscripterror"] =
    MacroPlayer.prototype.ActionTable["onerrordialog"];



// ONLOGIN command http://wiki.imacros.net/ONLOGIN
MacroPlayer.prototype.RegExpTable["onlogin"] =
    "^user\\s*=\\s*("+im_strre+")\\s+"+
    "password\\s*=\\s*("+im_strre+")\\s*$";

MacroPlayer.prototype.ActionTable["onlogin"] = function (cmd) {
    var username = imns.unwrap(this.expandVariables(cmd[1], "onlogin1"));
    var password = imns.unwrap(this.expandVariables(cmd[2], "onlogin2"));
    this.loginData = {
        username: username
    }
    this.waitForAuthDialog = true;
    chrome.webRequest.onAuthRequired.addListener(
        this.onAuth,
        {windowId: this.win_id, urls: ["<all_urls>"]},
        ["blocking"]
    );
    this.decrypt(password).then(decryptedString => {
        this.loginData.password = decryptedString
    }).then(() => this.next("ONLOGIN")).catch(e => this.handleError(e))
};


// PAUSE command http://wiki.imacros.net/PAUSE
MacroPlayer.prototype.RegExpTable["pause"] = "^\\s*$";

MacroPlayer.prototype.ActionTable["pause"] = function (cmd) {
    this.pause();
    this.next("PAUSE");
};


// PROMPT command http://wiki.imacros.net/PROMPT
MacroPlayer.prototype.RegExpTable["prompt"] =
    "^("+im_strre+")"+
    "(?:\\s+("+im_strre+")"+
    "(?:\\s+("+im_strre+"))?)?\\s*$";

MacroPlayer.prototype.ActionTable["prompt"] = function (cmd) {
    if (this.noContentPage("PROMPT"))
        return;

    var x = {};
    x.text = imns.unwrap(this.expandVariables(cmd[1], "prompt1"));

    if (typeof(cmd[2]) != "undefined") {
        if (this.limits.varsRe.test(cmd[2])) {
            x.varnum = imns.s2i(RegExp.$1);
        } else if (/^[^!]\S*/.test(cmd[2])) {
            this.checkFreewareLimits("user_vars", null);
            x.varname = cmd[2];
        } else {
            throw new BadParameter("Unsupported variable "+cmd[2]);
        }
    }

    if (typeof(cmd[3]) != "undefined") {
        x.defval = imns.unwrap(this.expandVariables(cmd[3], "prompt3"));
    }

    try {
        if (typeof (x.varnum) != "undefined" ||
            typeof (x.varname) != "undefined") {
            var mplayer = this;
            let p = dialogUtils.openDialog("promptDialog.html",
                "iMacros Prompt Dialog",
                { type: "askInput", text: x.text, default: x.defval });
            return p.then(function (result) {
                var retobj = {varnum: x.varnum, varname: x.varname};
                retobj.value = "";
                if (!result.canceled) {
                    retobj.value = result.inputValue;
                }
                if (typeof (retobj.varname) != "undefined") {
                    mplayer.setUserVar(retobj.varname, retobj.value);
                } else if (typeof (retobj.varnum) != "undefined") {
                    mplayer.vars[imns.s2i(retobj.varnum)] = retobj.value;
                }
                mplayer.next("onPromptComplete");
                return
            })
        } else {
            var mplayer = this;
            let p = dialogUtils.openDialog("promptDialog.html",
                "iMacros Prompt Dialog",
                { type: "alert", text: x.text });
            return p.then(function (result) {
                mplayer.next("onPromptComplete");
                return
            })

        }

    } catch (e) {
        this.handleError(e);
    }
};

MacroPlayer.prototype.onPromptComplete = function(data) {
    if (typeof(data.varname) != "undefined") {
        this.setUserVar(data.varname, data.value);
    } else if (typeof(data.varnum) != "undefined") {
        this.vars[imns.s2i(data.varnum)] = data.value;
    }
    this.next("onPromptComplete");
};


// PROXY command http://wiki.imacros.net/PROXY
MacroPlayer.prototype.RegExpTable["proxy"] =
    "^address\\s*=\\s*("+im_strre+")"+
    "(?:\\s+bypass\\s*=\\s*("+im_strre+")\\s*)?$";


MacroPlayer.prototype.setProxySettings = function(config) {
    // set new proxy settings
    var mplayer = this;
    chrome.proxy.settings.set(
        {value: config},
        function() {
            mplayer.next("PROXY");
        }
    );
};

MacroPlayer.prototype.storeProxySettings = function(callback) {
    var mplayer = this;
    // first we should store old settings
    chrome.proxy.settings.get(
        {'incognito': false},
        function(config) {
            mplayer.proxySettings = config.value;
            typeof(callback) == "function" && callback();
        }
    );
};


MacroPlayer.prototype.restoreProxySettings = function() {
    if (!this.proxySettings)
        return;
    if (this.proxySettings.mode == "system") {
        chrome.proxy.settings.clear({});
    } else {
        chrome.proxy.settings.set(
            {value: this.proxySettings, 'incognito': false},
            function() {}
        );
    }
};


// for possible bypass values see
// http://code.google.com/chrome/extensions/experimental.proxy.html#bypass_list

MacroPlayer.prototype.ActionTable["proxy"] = function (cmd) {
    var address = imns.unwrap(this.expandVariables(cmd[1], "proxy1"));
    var bypass = cmd[2]? imns.unwrap(this.expandVariables(cmd[2], "proxy2")):
        null;

    if (!chrome.proxy) {
        throw new RuntimeError("PROXY command can not be executed because"+
                               " chrome.proxy module unavailable", 610);
    }

    var addr_re = /^(?:(https?)\s*=\s*)?([\d\w\.]+):(\d+)\s*$/;
    var m = addr_re.exec(address);
    if (!m) {
        throw new BadParameter("server name or IP address with port number", 1);
    }

    var https = (m[1] == "https");
    var server = m[2];
    var port = imns.s2i(m[3]);

    var config = {
        mode: "fixed_servers",
        rules: {
            singleProxy: {}
        }
    };

    config.rules.singleProxy["scheme"] = https ? "https" : "http";
    config.rules.singleProxy["host"] = server;
    config.rules.singleProxy["port"] = port;

    if (bypass) {
        if (!/^null$/i.test(bypass)) {
            config.rules.bypassList = bypass.split(",");
        }
    }
    var mplayer = this;
    if (!this.proxySettings)
        this.storeProxySettings(function() {
            mplayer.setProxySettings(config);
        });
    else
       this.setProxySettings(config);

};


// REFRESH command http://wiki.imacros.net/REFRESH
MacroPlayer.prototype.RegExpTable["refresh"] = "^\\s*$";

MacroPlayer.prototype.ActionTable["refresh"] = function (cmd) {
    if (this.noContentPage("REFRESH"))
        return;

    chrome.tabs.get(this.tab_id, function(tab) {
        if (/^(?:https?|file)/.test(tab.url))
            communicator.postMessage("refresh-command", {}, tab.id,
                                     function() {},
                                     {number: 0});
    });
    // mplayer.next() will be called on load-complete event
};


// utility functions for next two commands

// get file name of the page, e.g. index.html
var __doc_name = function(url) {
    // use the location file name if present
    var name = url;
    if (/\/([^\/?]*)(?:\?.*)?$/.test(url))
        name = RegExp.$1;
    // if name is empy use server name
    if (!name.length) {
        if (/^https?:\/\/(?:www\.)?([^\/]+)/.test(url))
            name = RegExp.$1;
    }

    return name;
};


// ensure that filename has an extension or add .ext
var __ensure_ext = function(filename, ext) {
    if (!(new RegExp("\\."+ext+"$")).test(filename)) {
        return filename+"."+ext;
    } else {
        return filename;
    }
};


// SAVEAS command http://wiki.imacros.net/SAVEAS
MacroPlayer.prototype.RegExpTable["saveas"] =
    "^type\\s*=\\s*(\\S+)\\s+"+
    "folder\\s*=\\s*("+im_strre+")\\s+"+
    "file\\s*=\\s*("+im_strre+")\\s*$";

function getSaveAsFile(mplayer, folder, filename, type) {
    if (!mplayer.afioIsInstalled)
        throw new RuntimeError(
            "SAVEAS requires File IO interface installed", 660
        );

    let f = folder == "*" ?
        mplayer.defDownloadFolder.clone() : afio.openNode(folder)

    return f.exists().then(function(exists) {
        if (!exists) {
            throw new RuntimeError("Path "+folder+" does not exist", 732);
        }
        let defaultName = (type == "extract") ? "extract" : __doc_name(mplayer.currentURL);
        if (filename == "*") {
            filename = defaultName;
        } else if (filename.match(/^\+(.+)$/)) {
            filename = defaultName + RegExp.$1;
        }
        // replace illegal file name characters < > : " / \ | ? * by underscores
        var re = new RegExp('\\s*[:*?|<>\\"/]+\\s*', "g");
        filename = filename.replace(re, "_");
        if (type == "extract") {
            f.append(__ensure_ext(filename, "csv"));
        } else if (type == "mht") {
            f.append(__ensure_ext(filename, "mht"));
        } else if (type == "txt" || type == "htm") {
            f.append(__ensure_ext(filename, type));
        } else if (/^png|jpeg$/.test(type)) {
            f.append(__ensure_ext(filename, type == "jpeg"? "jpg": "png"));
        } else {
            throw new BadParameter("iMacros for Chrome supports only "+
                                   "MHT|HTM|TXT|EXTRACT|PNG|JPEG SAVEAS types")
        }

        return f;
    });
}

MacroPlayer.prototype.ActionTable["saveas"] = function (cmd) {
    if (this.noContentPage("SAVEAS"))
        return;

    var folder = imns.unwrap(this.expandVariables(cmd[2], "saveas2"));
    var type = imns.unwrap(this.expandVariables(cmd[1], "saveas1")).
        toLowerCase();
    var filename = imns.unwrap(this.expandVariables(cmd[3], "saveas3"));

    let mplayer = this;
    getSaveAsFile(mplayer, folder, filename, type).then(f => {
        if (type == "extract") {
            let data = mplayer.getExtractData();
            mplayer.clearExtractData();
            data = data.replace(/\"/g, '""');
            data = '"'+data.replace(/\[EXTRACT\]/g, '"'+
                                    mplayer.dataSourceDelimiter+
                                    '"')+'"';
            afio.appendTextFile(f, data+(__is_windows() ? "\r\n" : "\n"))
                .then(() => mplayer.next("SAVEAS"))
                .catch(err => mplayer.handleError(err));
        } else if (type == "mht") {
            chrome.pageCapture.saveAsMHTML(
                {tabId: mplayer.tab_id},
                function(data) {
                    let reader = new FileReader();
                    reader.onload = function(event) {
                        afio.writeTextFile(f, event.target.result)
                            .then(() => mplayer.next("SAVEAS"))
                            .catch(e => mplayer.handleError(e));
                    };
                    reader.onerror = function(event) {
                        mplayer.handleError(event.target.error);
                    };
                    reader.readAsText(data);
                }
            )
        } else if (type == "txt" || type == "htm") {
            // NOTE: both txt and htm save only topmost frame data
            communicator.postMessage(
                "saveas-command", {type: type}, mplayer.tab_id,
                function(data) {
                    afio.writeTextFile(f, data)
                        .then(() => mplayer.next("SAVEAS"))
                        .catch(e => mplayer.handleError(e));
                },
                {number: 0}
            );
        } else if (/^png|jpeg$/.test(type)) {
            communicator.postMessage("webpage-hide-scrollbars",{hide: true}, mplayer.tab_id,()=>{});
            mplayer.captureWebPage(function(data) {
                communicator.postMessage("webpage-hide-scrollbars",{hide: false}, mplayer.tab_id,()=>{});
                var re = /data\:([\w-]+\/[\w-]+)?(?:;(base64))?,(.+)/;
                var m = re.exec(data);
                var imageData = {
                    image: m[3],
                    encoding: m[2],
                    mimeType: m[1]
                };
                afio.writeImageToFile(f, imageData)
                    .then(() => mplayer.next("SAVEAS"))
                    .catch(e => mplayer.handleError(e));
            }, type);
        }
    }).catch(e => mplayer.handleError(e))
};


// SCREENSHOT command
MacroPlayer.prototype.RegExpTable["screenshot"] =
    "^type\\s*=\\s*(browser|page)\\s+"+
    "folder\\s*=\\s*("+im_strre+")\\s+"+
    "file\\s*=\\s*("+im_strre+")\\s*$";

MacroPlayer.prototype.doSplitCycle = function(canvas, ctx, moves, type, callback) {
    if (moves.length == 0) {
        callback(canvas.toDataURL())
    } else {
        let mplayer = this
        let [move, ...rest] = moves
        communicator.postMessage(
            "webpage-scroll-to",
            {x: move.x_offset, y: move.y_offset},
            this.tab_id,
            () => {
                chrome.tabs.captureVisibleTab(
                    this.win_id, {format: type}, dataURL => {
                        let img = new Image(move.width, move.height)
                        img.src = dataURL
                        img.onload = () => {                            
                            ctx.drawImage(img, move.x_offset, move.y_offset);
                            this.doSplitCycle(canvas, ctx, rest, type, callback)
                        }
                    }
                )
            }, {number: 0}
        )
    }
};

MacroPlayer.prototype.splitPage = function(dmns, type, callback) {
    let overlap = 200; // minimum overlap, to avoid sticky headers.
    let split = function(w, x, xs) {
        if (w == 0) {
            return xs
        } else {
            if(w - x > 0) {
                let n = Math.ceil(w / (x-overlap));
                let delta = Math.ceil(w/n);
                xs = new Array(n).fill(delta);
            } else {
                xs.push(w)
            }            
            return xs
        }
    }
    // steps to perform in x-direction
    let xs = split(dmns.doc_w, dmns.win_w, [])
    // steps to perform in y-direction
    let ys = split(dmns.doc_h, dmns.win_h, [])
    // the two above combined and flattened
    let [moves, ] = ys.reduce(([y_acc, y_offset], y_step) => {
        let [x_moves, ] = xs.reduce(([x_acc, x_offset], x_step) => {
            let move = {
                // if this is the last piece, make the offset as large as its size, so that it sits at the end.
                x_offset: (x_offset + dmns.win_w) <=  dmns.doc_w ? x_offset : dmns.doc_w - dmns.win_w,
                y_offset: (y_offset + dmns.win_h) <=  dmns.doc_h ? y_offset : dmns.doc_h - dmns.win_h,
                width: dmns.win_w,
                height:  dmns.win_h
            }
            return [x_acc.concat(move), x_offset + x_step]
        }, [[], 0])
        return [y_acc.concat(x_moves), y_offset + y_step]
    }, [[], 0])
    let canvas = document.createElementNS("http://www.w3.org/1999/xhtml",
                      "canvas");
    canvas.style.width = dmns.doc_w+"px";
    canvas.style.height = dmns.doc_h+"px";
    canvas.width = dmns.doc_w;
    canvas.height = dmns.doc_h;
    let ctx = canvas.getContext("2d");
    // Start from the end. If starting from the beginning, sticky headers appear, avoiding sticky footers instead.
    moves.reverse();  
    this.doSplitCycle(canvas, ctx, moves, type, callback);
};

MacroPlayer.prototype.captureWebPage = function(callback, type) {
    var mplayer = this;
    communicator.postMessage(
        "query-page-dimensions",
        {}, this.tab_id,
        function(dmns) {
            mplayer.splitPage(dmns, type || "png",  callback);
        },
        {number: 0}
    );
};

MacroPlayer.prototype.ActionTable["screenshot"] = function (cmd) {
    if (this.noContentPage("SCREENSHOT"))
        return;
    if (!this.afioIsInstalled)
        throw new RuntimeError("SCREENSHOT requires File IO interface", 660);

    var folder = imns.unwrap(this.expandVariables(cmd[2], "screenshot2"));
    var type = imns.unwrap(this.expandVariables(cmd[1], "screenshot1")).
        toLowerCase();
    if (type != "page") {
        throw new BadParameter("SCREENSHOT TYPE="+type.toUpperCase()+
                             " is not supported");
    }

    var f = null;
    if (folder == "*") {
        f = this.defDownloadFolder.clone()
    } else {
        f = afio.openNode(folder);
    }

    var file = imns.unwrap(this.expandVariables(cmd[3], "saveas3")), t;

    var mplayer = this;
    f.exists().then(function(exists) {
        if (!exists) {
            throw new RuntimeError("Path "+folder+" does not exist", 732)
        }

        if (file == "*") {
            file = __doc_name(mplayer.currentURL);
        } else if (t = file.match(/^\+(.+)$/)) {
            file = __doc_name(mplayer.currentURL) + t[1];
        }

        // replace illegal file name characters < > : " / \ | ? * by underscores
        var re = new RegExp('\\s*[:*?|<>\\"/]+\\s*', "g");
        file = file.replace(re, "_");
        f.append(__ensure_ext(file, "png"));
        communicator.postMessage("webpage-hide-scrollbars",{hide: true}, mplayer.tab_id,()=>{});
        mplayer.captureWebPage(function(data) {
            communicator.postMessage("webpage-hide-scrollbars",{hide: false}, mplayer.tab_id,()=>{});
            var re = /data\:([\w-]+\/[\w-]+)?(?:;(base64))?,(.+)/;
            var m = re.exec(data);
            var imageData = {
                image: m[3],
                encoding: m[2],
                mimeType: m[1]
            };
            afio.writeImageToFile(f, imageData).then(function() {
                mplayer.next("SCREENSHOT");
            }).catch(function(e) {
                mplayer.handleError(e);
            });
        });
    }).catch(function(err) {
        mplayer.handleError(err);
    });
};


// SEARCH command
MacroPlayer.prototype.RegExpTable["search"] =
    "^source\\s*=\\s*(txt|regexp):("+im_strre+")"+
    "(?:\\s+ignore_case\\s*=\\s*(yes|no))?"+
    "(?:\\s+extract\\s*=\\s*("+im_strre+"))?\\s*$";

MacroPlayer.prototype.ActionTable["search"] = function (cmd) {
    var query = imns.unwrap(this.expandVariables(cmd[2]));
    var extract = cmd[4] ? imns.unwrap(this.expandVariables(cmd[4])) : "";
    var ignore_case = cmd[3] && /^yes$/i.test(cmd[3]) ? "i" : "";
    var search_re;

    // check if EXTRACT is present
    if (extract && !(cmd[1].toLowerCase() == "regexp"))
        throw new BadParameter("EXTRACT has sense only for REGEXP search");

    var data = {
        type: cmd[1].toLowerCase(),
        query: query,
        extract: extract,
        ignore_case: ignore_case
    };

    communicator.postMessage("search-command", data, this.tab_id,
                             this.onSearchComplete.bind(this),
                             this.currentFrame);
};


MacroPlayer.prototype.onSearchComplete = function(data) {
    if (data.error) {
        this.handleError(data.error);
    } else {
        if (data.extract)
            this.showAndAddExtractData(data.extract);
        this.next("onSearchComplete");
    }
};


// SET command http://wiki.imacros.net/SET
MacroPlayer.prototype.RegExpTable["set"] =
    "^(\\S+)\\s+("+im_strre+")\\s*$";


MacroPlayer.prototype.ActionTable["set"] = function (cmd) {
    var param = imns.unwrap(this.expandVariables(cmd[2], "set2"));
    var mplayer = this;
    switch(cmd[1].toLowerCase()) {
    case "!encryption":
        switch(param.toLowerCase()) {
        case "no":
            this.encryptionType = "no"; break;
        case "storedkey": case "yes":
            this.encryptionType = "stored"; break;
        case "tmpkey":
            this.encryptionType = "tmpkey"; break;
        default:
            throw new BadParameter("!ENCRYPTION can be only "+
                                   "YES|NO|STOREDKEY|TMPKEY");
        }

        break;
    case "!downloadpdf":
        // TODO: not very clear what to do with that command
        this.shouldDownloadPDF = /^yes$/i.test(param); break;
    case "!loop":
        if (this.firstLoop) {
            loop = imns.s2i(param)
            if (isNaN(loop))
                throw new BadParameter("!LOOP must be integer");
            this.currentLoop = this.checkFreewareLimits("loops", loop)
            var panel = context[this.win_id].panelWindow;
            if (panel && !panel.closed)
                panel.setLoopValue(this.currentLoop);
        }
        break;
    case "!extract":
        this.clearExtractData();
        if (!/^null$/i.test(param))
            this.addExtractData(param);
        break;
    case "!extractadd":
        this.addExtractData(param); break;
    case "!extract_test_popup":
        this.shouldPopupExtract = /^yes$/i.test(param); break;
    case "!errorignore":
        this.ignoreErrors = /^yes$/i.test(param); break;
    case "!datasource":
        if (!this.afioIsInstalled) {
            throw new RuntimeError(
                "!DATASOURCE requires File IO interface", 660
            );
        }
        this.loadDataSource(param)
            .then(() => this.next("SET"))
            .catch(e => this.handleError(e))
        return;
    case "!datasource_line":
        var x = imns.s2i(param);
        if (isNaN(x) || x <= 0)
            throw new BadParameter("!DATASOURCE_LINE must be positive integer");
        if (this.dataSource.length < x)
            throw new RuntimeError("Invalid DATASOURCE_LINE value: "+
                                   param, 751);
        this.dataSourceLine = x;
        break;
    case "!datasource_columns":
        if (isNaN(imns.s2i(param)))
                throw new BadParameter("!DATASOURCE_COLUMNS must be integer");
        this.dataSourceColumns = imns.s2i(param);
        break;
    case "!datasource_delimiter":
        if (param.length > 1)
            throw new BadParameter("!DATASOURCE_DELIMITER must be single character");
        this.dataSourceDelimiter = param;
        break;
    case "!folder_datasource":
        if (!this.afioIsInstalled) {
            throw new RuntimeError(
                "!FOLDER_DATASOURCE requires File IO interface", 660
            );
        }
        this.dataSourceFolder = afio.openNode(param);
        this.dataSourceFolder.exists().then(exists => {
            if (!exists) {
                this.handleError( new RuntimeError(
                    "can not write to FOLDER_DATASOURCE: "+
                        param+" does not exist or not accessible.", 732
                ));
            }
        }).then(() => {
            this.next("SET");
        }).catch(err => {
            this.handleError(new RuntimeError(
                "can not open FOLDER_DATASOURCE: "+
                    param+", error "+err.message, 732
            ));
        });
        return;
    case "!folder_download":
        if (!this.afioIsInstalled) {
            throw new RuntimeError(
                "!FOLDER_DOWNLOAD requires File IO interface", 660
            );
        }
        this.defDownloadFolder = afio.openNode(param);
        this.defDownloadFolder.exists().then(exists => {
            if (!exists) {
                this.handleError( new RuntimeError(
                    "can not write to FOLDER_DOWNLOAD: "+
                        param+" does not exist or not accessible.", 732
                ));
            }
        }).then(() => {
            this.next("SET");
        }).catch(err => {
            this.handleError(new RuntimeError(
                "can not open FOLDER_DOWNLOAD: "+
                    param+", error "+err.message, 732
            ));
        });
        return;
    case "!timeout": case "!timeout_page":
        var x = imns.s2i(param);
        if (isNaN(x) || x <= 0)
            throw new BadParameter("!TIMEOUT must be positive integer");
        this.timeout = x;
        this.timeout_tag = Math.round(this.timeout/10);
        break;
    case "!timeout_tag": case "!timeout_step":
        var x = imns.s2i(param);
        if (isNaN(x) || x < 0)
            throw new BadParameter("!TIMEOUT_TAG must be positive integer");
        this.timeout_tag = x;
        break;
    case "!timeout_download":
        var x = imns.s2i(param);
        if (isNaN(x) || x < 0)
            throw new BadParameter("!TIMEOUT_DOWNLOAD must be positive integer");
        this.timeout_download = x;
        break;
    case "!timeout_macro":
        var x = parseFloat(param);
        if (isNaN(x) || x <= 0)
            throw new BadParameter("!TIMEOUT_MACRO must be positive number");
        this.globalTimer.setMacroTimeout(x);
        break;
    case "!clipboard":
        imns.Clipboard.putString(param);
        break;
    case "!filestopwatch":
        if (!this.afioIsInstalled)
            throw new RuntimeError(
                "!FILESTOPWATCH requires File IO interface", 660
            );
        var filename = param, file;
        if (__is_full_path(filename) ) { // full path
            file = afio.openNode(filename);
        } else {
            file = this.defDownloadFolder.clone()
            file.append(filename);
        }
        var parent = file.parent;
        var mplayer = this;
        parent.exists().then(function(exists) {
            if (!exists)
                throw new RuntimeError("Path "+parent.path+
                                       " does not exists", 732);
        }).then(function() {
            return afio.appendTextFile(file, "").catch(function(e) {
                    var reason = "";
                    if (/ACCESS_DENIED/.test(e.toString()))
                        reason = ", access denied";
                   throw new RuntimeError(
                        "can not write to STOPWATCH file: "+
                            file.path+reason, 731);
            });
        }).then(function() {
            mplayer.stopwatchFile = file;
            mplayer.shouldWriteStopwatchFile = true;
            mplayer.next("SET");
        }).catch(function(err) {
            mplayer.handleError(err);
        });
        return;
    case "!folder_stopwatch":
        if (param.toLowerCase() == "no") {
            this.shouldWriteStopwatchFile = false;
        } else {
            this.stopwatchFolder = afio.openNode(param);
        // TODO: isWritable is buggy on Windows as it can only check files
        // if (!this.stopwatchFolder.isWritable) {
            //  throw new RuntimeError("can not write to STOPWATCH folder: "+
            //                            "access denied", 731);
            // }
            this.shouldWriteStopwatchFile = true;
    }
        break;
    case "!replayspeed":
        switch(param.toLowerCase()) {
            case "slow":
                this.delay = 2000; break;
            case "medium":
                this.delay = 1000; break;
            case "fast":
                this.delay = 0; break;
            default:
                throw new BadParameter("!REPLAYSPEED can be SLOW|MEDIUM|FAST");
            }
        break;
    case "!playbackdelay":
        let newDelay = parseFloat(param)
        if (isNaN(newDelay) || newDelay <= 0)
            throw new BadParameter("!PLAYBACKDELAY should be a"+
                                   " positive number of seconds");
        this.delay = Math.round(newDelay*1000);
        break;
    case "!file_profiler":
        if (param.toLowerCase() == "no") {
            this.writeProfiler = false;
            this.profiler.file = null;
        } else {
            if (!this.afioIsInstalled) {
                throw new RuntimeError(
                    "!FILE_PROFILER requires File IO interface", 660
                );
            }
            this.writeProfilerData = true;
            this.profiler.enabled = true;
            this.profiler.file = param;
        }
        break;

    case "!linenumber_delta":
        var x = imns.s2i(param);
        if (isNaN(x) || x > 0)
            throw new BadParameter("!LINENUMBER_DELTA must be negative integer or zero");
        this.linenumber_delta = x;
        break;
    case "!useragent":
        if (!this.userAgent) { // we don't want to register more than one handler
            chrome.webRequest.onBeforeSendHeaders.addListener(
                this._onBeforeSendHeaders,
                {windowId: this.win_id, urls: ["<all_urls>"]},
                ["blocking", "requestHeaders"]
            );
        }
        this.userAgent = param;
        break;
    default:
        if (this.limits.varsRe.test(cmd[1])) {
            this.vars[imns.s2i(RegExp.$1)] = param;
        } else if (/^!\S+$/.test(cmd[1])) {
            throw new BadParameter("Unsupported variable "+cmd[1]);
        } else {
            this.setUserVar(cmd[1], param);
        }
    }
    this.next("SET");
};


// SIZE command http://wiki.imacros.net/SIZE
MacroPlayer.prototype.RegExpTable["size"] =
    "^x\\s*=\\s*("+im_strre+")\\s+y=("+im_strre+")\\s*$";

MacroPlayer.prototype.ActionTable["size"] = function (cmd) {
    if (this.noContentPage("SIZE"))
        return;
    var x = imns.s2i(imns.unwrap(this.expandVariables(cmd[1], "size1")));
    var y = imns.s2i(imns.unwrap(this.expandVariables(cmd[2], "size2")));
    if (isNaN(x))
        throw new BadParameter("positive integer", 1)
    if (isNaN(y))
        throw new BadParameter("positive integer", 2)

    var mplayer = this;
    chrome.windows.get(this.win_id, {populate: false}, function(w) {
        communicator.postMessage(
            "query-page-dimensions",
            {}, mplayer.tab_id,
            function(dmns) {
                var delta_x = w.width - dmns.win_w;
                var delta_y = w.height - dmns.win_h;
                chrome.windows.update(
                    mplayer.win_id,
                    {width: x+delta_x, height: y+delta_y},
                    function() {
                        mplayer.next("SIZE");
                    }
                );
            },
            {number: 0}
        );
    });
};

// STOPWATCH command http://wiki.imacros.net/STOPWATCH
MacroPlayer.prototype.RegExpTable["stopwatch"] =
    "^((?:(start|stop)\\s+)?id|label)\\s*=\\s*("+im_strre+")\\s*$";

// add new time watch
MacroPlayer.prototype.addTimeWatch = function(name) {
    this.watchTable[name] = this.globalTimer.getElapsedSeconds();
};


MacroPlayer.prototype.stopTimeWatch = function(name) {
    if (typeof this.watchTable[name] == "undefined")
        throw new RuntimeError("Time watch "+name+" does not exist", 762);
    let elapsed = this.globalTimer.getElapsedSeconds() - this.watchTable[name];
    this.lastWatchValue = elapsed;
    let stamp = new Date(this.globalTimer.macro_start_time + this.watchTable[name]*1000); // time when this timewWatch started
    let x = {id: name, type: "id", elapsedTime: elapsed, timestamp: stamp};
    this.stopwatchResults.push(x);
};


MacroPlayer.prototype.addTimeWatchLabel = function(name) {
    let elapsed = this.globalTimer.getElapsedSeconds();
    this.lastWatchValue = elapsed;
    let stamp = new Date(this.globalTimer.macro_start_time);  // time when the macro started
    let x = {id: name, type: "label", elapsedTime: elapsed, timestamp: stamp};
    this.stopwatchResults.push(x);
};


// command handler
MacroPlayer.prototype.ActionTable["stopwatch"] = function (cmd) {
    var action = cmd[2] ? cmd[2].toLowerCase() : null;
    var use_label = /label$/i.test(cmd[1]);
    var param = imns.unwrap(this.expandVariables(cmd[3], "stopwatch3"));

    // make the watch name uppercase to be compatible with IE version
    param = param.toUpperCase();

    if (!use_label) { // Need a pair of STOPWATCH commands to start and stop the clock, respectively.
        var found = typeof this.watchTable[param] != "undefined";
        switch (action) {
        case "start":
            if (found)
                throw new RuntimeError("stopwatch id="+param+
                                       " already started", 761);
            this.addTimeWatch(param);
            break;
        case "stop":
            if (!found)
                throw new RuntimeError("stopwatch id="+param+
                                       " wasn't started", 762);
            this.stopTimeWatch(param);
            break;
        default:                // old syntax
            if (found)
                this.stopTimeWatch(param);
            else
                this.addTimeWatch(param);
            break;
        }
    } else { // only one STOPWATCH command to stop the clock. Start time is at macro start.
        // save time in sec since macro was started
        this.addTimeWatchLabel(param);
    }
    this.next("STOPWATCH");
};


MacroPlayer.prototype.globalTimer = {
    init: function(mplayer) {
        this.mplayer = mplayer;
        if (this.macroTimeout) {
            clearTimeout(this.macroTimeout);
            this.macroTimeout = null;
        }
    },

    start: function() {
        this.start_time = performance.now(); // attention: this property is in milliseconds!  Relative, since document start.      
        this.macro_start_time = Date.now();  // macro start time in milliseconds, absolute (epoch)
    },

    getElapsedSeconds: function() {
        if (!this.start_time)
            return 0;
        var now = performance.now();
        return (now - this.start_time)/1000;
    },

    setMacroTimeout: function(x) {
        var mplayer = this.mplayer;
        this.macroTimeout = setTimeout( function () {
            if (!mplayer.playing)
                return;
            mplayer.handleError(
                new RuntimeError("Macro replaying timeout of "+x+
                                 "s exceeded", 603)
            );
        }, Math.round(x*1000));
    },

    stop: function() {
        if (this.macroTimeout) {
            clearTimeout(this.macroTimeout);
            this.macroTimeout = null;
        }
    }
};



// TAG command http://wiki.imacros.net/TAG

// regexp for matching att1:"val1"&&att2:val2.. sequence
const im_atts_re = "(?:[-\\w]+:"+im_strre+"(?:&&[-\\w]+:"+im_strre+")*|\\*?)";

MacroPlayer.prototype.RegExpTable["tag"] =
    "^(?:pos\\s*=\\s*(\\S+)\\s+"+
    "type\\s*=\\s*(\\S+)"+
    "(?:\\s+form\\s*=\\s*("+im_atts_re+"))?\\s+"+
    "attr\\s*=\\s*("+im_atts_re+")"+
    "|(selector|xpath)\\s*=\\s*("+im_strre+"))"+
           //"|xpath \\s*=\\s*("+im_strre+"))"+
    "(?:\\s+(content|extract)\\s*=\\s*"+
    "([%$#]"+im_strre+"(?::[%$#]"+im_strre+")*|"+
    "event:"+im_strre+"|"+
    im_strre+"))?\\s*$";

MacroPlayer.prototype.ActionTable["tag"] = function (cmd) {
    if (this.noContentPage("TAG"))
        return;

    // form message to send to content-script
    var data = {
        pos: 0,
        relative: false,
        tagName: "",
        form: null,
        atts: null,
        xpath: null,
        selector: null,
        type: "",
        txt: null,
        cdata: null,
        scroll: true,
        download_pdf: this.shouldDownloadPDF,
        highlight: true
    };

    var isPasswordElement = false;
    // parse attr1:val1&&atr2:val2...&&attrN:valN string
    // into array of regexps corresponding to vals
    const parseAtts = str => {
        if (!str || str == "*")
            return null;
        var arr = str.split(new RegExp("&&(?=[-\\w]+:"+im_strre+")"));
        var parsed_atts = new Object(), at, val, m;
        const re = new RegExp("^([-\\w]+):("+im_strre+")$");
        for (var i = 0; i < arr.length; i++) {
            if (!(m = re.exec(arr[i])))
                throw new BadParameter("incorrect ATTR or FORM specifier: "
                                       +arr[i]);
            at = m[1].toLowerCase();

            if (at.length && at in parsed_atts) {
                throw new BadParameter("Duplicate ATTR specified: " + at.toUpperCase());
            }

            if (at.length) {
                val = imns.unwrap(this.expandVariables(m[2], "tag_attr"+i));
                // While replaying:
                // 1. remove all leading/trailing whitespaces
                // 2. remove all linebreaks in the target string
                val = imns.escapeTextContent(val);
                val = imns.escapeREChars(val);
                val = val.replace(/\*/g, '(?:\n|.)*');
                // 3. treat all <SP> as a one or more whitespaces
                val = val.replace(/ /g, "\\s+");
                parsed_atts[at] = "^\\s*"+val+"\\s*$";
            } else {
                parsed_atts[at] = "^$";
            }
        }

        return parsed_atts;
    };

    if (cmd[5]) {
        if (cmd[5].toLowerCase() == 'xpath') {
            data.xpath = imns.unwrap(this.expandVariables(cmd[6], "tag6"));
        }
        else {
            data.selector = imns.unwrap(this.expandVariables(cmd[6], "tag6"));
        }

    } else {
        data.pos = imns.unwrap(this.expandVariables(cmd[1], "tag1"));
        data.tagName = imns.unwrap(this.expandVariables(cmd[2], "tag2")).
               toLowerCase();
        data.form = parseAtts(cmd[3]);
        data.atts = parseAtts(cmd[4]);
        data.atts_str = cmd[4]; // for error message

        // get POS parameter
        if (/^r(-?\d+)$/i.test(data.pos)) {
            data.pos = imns.s2i(RegExp.$1);
            data.relative = true;
        } else if (/^(\d+)$/.test(data.pos)) {
            data.pos = imns.s2i(RegExp.$1);
            data.relative = false;
        } else {
            throw new BadParameter("POS=<number> or POS=R<number>"+
                                   "where <number> is a non-zero integer", 1);
        }
        // get rid of INPUT:* tag names
        if (/^(\S+):(\S+)$/i.test(data.tagName)) {
            if (!data.atts)
                data.atts = new Object();
            var val = RegExp.$2;
            data.tagName = RegExp.$1.toLowerCase();
            val = imns.escapeREChars(val);
            val = val.replace(/\*/g, '(?:\n|.)*');
            data.atts["type"] = "^"+val+"$";
        }

    }
    if (cmd[7]) {
        data.type = cmd[7].toLowerCase();
        data.rawdata = cmd[8];
        data.txt = imns.unwrap(this.expandVariables(cmd[8], "tag8"));
        if (data.type == "content")
            data.cdata = this.parseContentStr(cmd[8]);
    }

    let p = Promise.resolve(data)
    if (this.shouldDecryptPassword) {
        delete this.shouldDecryptPassword
        p = this.decrypt(data.txt).then(
            plaintext => Object.assign(
                {}, data, {txt: plaintext, passwordDecrypted: true}
            )
        )
    }

    p.then(data => communicator.postMessage(
        "tag-command", data, this.tab_id,
        this.onTagComplete.bind(this),
        this.currentFrame
    )).catch(e => this.handleError(e));
};


MacroPlayer.prototype.parseContentStr = function(cs) {
    var rv = new Object();
    if (/^event:(\S+)$/i.test(cs)) {
        rv.type = "event";
        var etype = RegExp.$1.toLowerCase();
        switch(etype) {
        case "saveitem": case "savepictureas":
        case "savetargetas": case "savetarget":
        case "mouseover": case "fail_if_found":
            rv.etype = etype;
            break;
        default:
            throw new RuntimeError("Unknown event type "+etype+
                                   " for tag command.", 711);
        }
    } else {
        rv.type = "select";
        // regexp for testing if content is $goo:$foo
        const val_re = new RegExp(
            "^(?:([%$#])"+im_strre+")(?::\\1"+im_strre+")*$"
        );
        const idx_re = new RegExp("^\\d+(?::\\d+)*$");

        var m, split_re = null;
        // build regexp for splitting content into values
        if(m = cs.match(val_re)) {
            var non_delimeter =
                "(?:\"(?:[^\"\\\\]|\\\\[0btnvfr\"\'\\\\])*\"|"+
                "eval\\s*\\(\"(?:[^\"\\\\]|\\\\[\\w\"\'\\\\])*\"\\)|"+
                "(?:[^:\\s]|:[^"+m[1]+"])+)";
            split_re = new RegExp("(\\"+m[1]+non_delimeter+")", "g");
        } else if (m = cs.match(idx_re)) {
            split_re = new RegExp("(\\d+)", "g");
        } else if (cs.toLowerCase() =="all") {
            rv.seltype = "all";
            return rv;
        } else {
            // could be some data for input elements
            rv.type = "unknown";
            return rv;
        }

        // split content into values
        var g, opts = new Array();
        while(g = split_re.exec(cs)) {
            opts.push(g[1]);
        }
        rv.seltype = opts.length > 1 ? "multiple" : "single";

        for (var i = 0; i < opts.length; i++) {
            if (/^([%$#])(.*)$/i.test(opts[i])) {
                var typ = RegExp.$1;
                var val = RegExp.$2;
                val = imns.unwrap(this.expandVariables(val, "opts"+i));
                if (typ == "$" || typ == "%") {
                    var re_str = "^\\s*"+imns.escapeREChars(val).
                        replace(/\*/g, '(?:[\r\n]|.)*')+"\\s*$";
                    opts[i] = {typ: typ, re_str: re_str, str: val};
                } else if (typ == "#") {
                    var idx = parseInt(val);
                    if (isNaN(idx))
                        throw new RuntimeError(
                            "Wrong CONTENT specifier "+cs, 711);
                    opts[i] = {typ: "#", idx: idx};
                }
            } else if (/^(\d+)$/i.test(opts[i])) { // indexes 1:2:...
                var idx = parseInt(RegExp.$1);
                if (isNaN(idx))
                    throw new RuntimeError("Wrong CONTENT specifier "+cs,
                                           711);
                opts[i] = {typ: "#", idx: idx};
            }
        }

        rv.opts = opts;
    }

    return rv;
};


MacroPlayer.prototype.handleInputFileTag = function(selector, files) {
    return this.attachDebugger("1.2")
        .then(() => send_command(this.tab_id, "DOM.getDocument"))
        .then(({root: {nodeId}}) => send_command(
            this.tab_id,
            "DOM.querySelector",
            {nodeId, selector}
        ))
        .then(({nodeId}) => send_command(
            this.tab_id,
            "DOM.setFileInputFiles",
            {files, nodeId}
        ))
        .then(() => this.detachDebugger())
        .catch(e => this.handleError(e))
}

// VERSION command http://wiki.imacros.net/VERSION
MacroPlayer.prototype.RegExpTable["version"] = "^(?:build\\s*=\\s*(\\S+))?"+
    "(?:\\s+recorder\\s*=\\s*(\\S+))?\\s*$";
MacroPlayer.prototype.ActionTable["version"] = function (cmd) {
    // do nothing
    this.next("VERSION");
};



// URL command http://wiki.imacros.net/URL
MacroPlayer.prototype.RegExpTable["url"] =
    "^goto\\s*=\\s*("+im_strre+")\\s*$";

MacroPlayer.prototype.ActionTable["url"] = function (cmd) {
    var param = imns.unwrap(this.expandVariables(cmd[1], "url1")),
        scheme = null;

    if (!/^([a-z]+):.*/i.test(param)) {
        param = "http://"+param;
    }
    // Test for javascript: URLs and execute it
    var jsRegex = RegExp("^javascript:\\(?(.+)\\)?$");
    if (jsRegex.test(param)) {
        let matches = jsRegex.exec(param);
        let scriptCode = matches[1];
        chrome.tabs.executeScript(this.tab_id, { code: scriptCode }, () => { this.next("URL"); });
    } else {
        chrome.tabs.update(
            this.tab_id, {url: param},
            () => {
                if (/^javascript:/.test(param)) {
                    // somewhat ugly hack for javascript: urls
                    this.next("URL");
                } else {
                    this.waitingForPageLoad = true;

                    if (!this.timers.has("loading"))
                        this.startTimer(
                            "loading", this.timeout, "Loading ", () => {
                                this.waitingForPageLoad = false;
                                this.handleError(new RuntimeError(
                                    "Page loading timeout"+
                                        ", URL: "+this.currentURL, 602
                                ));
                            }
                        )
                }
            }
        );
    }
};




// TAB command http://wiki.imacros.net/TAB
MacroPlayer.prototype.RegExpTable["tab"] = "^(t\\s*=\\s*(\\S+)|"+
    "close|closeallothers|open|open\\s+new|new\\s+open"+
    ")\\s*$";

MacroPlayer.prototype.ActionTable["tab"] = function (cmd) {
    communicator.postMessage("tab-command", {}, this.tab_id, () => {})
    if (/^close$/i.test(cmd[1])) { // close current tab
        this.detachDebugger().then(() => chrome.tabs.remove(
            this.tab_id, () => this.next("TAB CLOSE")
        ))
    } else if (/^closeallothers$/i.test(cmd[1])) {
        //close all tabs except current
        chrome.tabs.query(
            {windowId: this.win_id, active: false},
            tabs => {
                let ids = tabs.filter(tab => !tab.active).map(tab => tab.id)
                this.startTabIndex = 0
                chrome.tabs.remove(
                    ids, () => this.next("TAB CLOSEALLOTHERS")
                )
            })
    } else if (/open/i.test(cmd[1])) {
        this.detachDebugger().then(() => {
            chrome.tabs.get(this.tab_id, tab => {
                let args = {
                    url: "about:blank",
                    windowId: this.win_id,
                    index: tab.index+1,
                    active: false
                }
                chrome.tabs.create(args, t => this.next("TAB OPEN"))
            })
        })
    } else if (/^t\s*=/i.test(cmd[1])) {
        let n = imns.s2i(this.expandVariables(cmd[2], "tab2"))
        if (isNaN(n))
            throw new BadParameter("T=<number>", 1)
        let tab_num = n+this.startTabIndex-1
        chrome.tabs.query({windowId: this.win_id}, tabs => {
            if (tab_num < 0 || tab_num > tabs.length-1) {
                this.handleError(
                    new RuntimeError("Tab number "+n+" does not exist", 771)
                )
            } else {
                this.detachDebugger().then(() => chrome.tabs.update(
                    tabs[tab_num].id, {active: true},
                    t => this.next("TAB T=")
                ))
            }
        })
    }
};



// WAIT command http://wiki.imacros.net/WAIT
MacroPlayer.prototype.RegExpTable["wait"] = "^seconds\\s*=\\s*(\\S+)\\s*$";

MacroPlayer.prototype.ActionTable["wait"] = function (cmd) {
    var param = Number(imns.unwrap(this.expandVariables(cmd[1], "wait1")));

    if (isNaN(param))
        throw new BadParameter("SECONDS=<number>", 1);
    param = Math.round(param*10)*100; // get number of ms
    if (param == 0)
        param = 10;
    else if (param < 0)
        throw new BadParameter("positive number of seconds", 1);
    this.inWaitCommand = true;
    var mplayer = this;

    this.waitTimeout = setTimeout(function () {
        mplayer.inWaitCommand = false;
        delete mplayer.waitTimeout;
        clearInterval(mplayer.waitInterval);
        delete mplayer.waitInterval;
        mplayer.next("WAIT");
    }, param);

    // show timer
    var start_time = performance.now();
    var total = param/1000;
    mplayer.waitInterval = setInterval(function () {
        if (!mplayer.inWaitCommand) {
            clearInterval(mplayer.waitInterval);
            return;
        }
        let passed = (performance.now() - start_time)/1000
        var remains = total - passed
        if (remains > 0) {
            var text = passed.toFixed(0);
            while(text.length < 3)
                text = "0"+text;
            badge.set(mplayer.win_id, {
                status: "waiting",
                text: text
            });

            var panel = context[mplayer.win_id].panelWindow;
            if (panel && !panel.closed) {
                panel.setStatLine("Waiting "+passed.toFixed(1)+
                                  "("+total.toFixed(1)+")s", "info");
            }
        } else {
            clearInterval(mplayer.waitInterval);
            delete mplayer.waitInterval;
        }
    }, 1000);
};





MacroPlayer.prototype.beforeEachRun = function() {
    // stopwatch-related properties
    this.watchTable = new Object();
    this.stopwatchResults = new Array();
    this.shouldWriteStopwatchFile = true; // default is true
    // last stopwatch value for !STOPWATCHTIME
    this.lastWatchValue = 0;
    this.totalRuntime = 0;
    this.lastPerformance = new Array();
    this.stopwatchFile = null;  // FILESTOPWATCH
    this.stopwatchFolder = null; // FOLDER_STOPWATCH
    // init runtime and waiting timers
    this.timers = new Map();
    this.globalTimer.init(this);
    this.proxySettings = null;
    this.currentFrame = {number: 0};
    // clear waiting flags
    this.waitingForPageLoad = false;
    this.inWaitCommand = false;
    this.waitingForDelay = false;
    // Profiler Log feature
    this.writeProfilerData = Storage.getBool("profiler-enabled") && Storage.getBool("afio-installed");
    this.profiler.file = null;
    // reset profiler
    this.profiler.init();
    this.profiler.enabled = (this.profiler.si_enabled ||
        Storage.getBool("profiler-enabled")) && Storage.getBool("afio-installed");
    // eval expressions storage
    this.__eval_results = {};
    // script errors
    this.shouldStopOnError = false;
    // delta for line numbers in error reports and profiler data
    this.linenumber_delta = 0;
    // reset current line
    this.currentLine = 0;
    // rest navigation pool
    this.activeNavigations = new Set();
    // !DOWNLOADED_FILE_NAME and !DOWNLOADED_SIZE
    this.downloadedFilename = "";
    this.downloadedSize = 0;
    this.userAgent = null;
    // coordinates of the center of an image found by IMAGESEARCH command
    this.imageX = this.imageY = -1;
    // clear extract data
    this.clearExtractData();
};


MacroPlayer.prototype.afterEachRun = function() {
    // form lastPerformance and save STOPWATCH results
    this.saveStopwatchResults();

    // restore proxy settings
    if (this.proxySettings) {
        this.restoreProxySettings();
        this.proxySettings = null;
    }
};


// reset all defaults, should be called on every play
MacroPlayer.prototype.reset = function() {
    // this.vars = new Array();
    // this.userVars = new Map();

    // clear actions array
    this.actions = new Array();
    this.currentAction = null;

    // reset state variables
    this.ignoreErrors = false;
    this.playing = false;
    this.paused = false;
    this.pauseIsPending = false;

    // last error code and message
    this.errorCode = 1;
    this.errorMessage = "OK";
    this.firstLoop = true;

    // datasources
    this.dataSource = new Array();
    this.dataSourceColumns = 0;
    this.dataSourceLine = 0;
    this.dataSourceFile = "";
    this.dataSourceDelimiter = ",";

    // extraction
    this.extractData = "";
    // show extract popup by default only when not looping and not
    // playing from scripting interface
    this.shouldPopupExtract = !(this.cycledReplay || this.client_id);
    this.waitingForExtract = false;
    // replaying delay
    this.delay = Storage.getNumber("replaying-delay"); // milliseconds

    // default timeout tag wait time
    // TODO: maybe store it in localStorage
    this.timeout = 60;  // seconds
    this.timeout_tag = Math.round(this.timeout/10);
    this.timeout_download = this.timeout*5;

    // encryption type
    var typ = Storage.getChar("encryption-type");
    if (!typ.length)
        typ = "no";
    this.encryptionType = typ;

    this.waitingForPassword = false;

    // downloads state
    this.activeDownloads = new Map();
    this.waitForDownloadCompleted = false;
    this.waitForDownloadCreated = false;
    // HTTP authorization expected
    this.waitForAuthDialog = false;

    return new Promise((resolve, reject) => {
        chrome.tabs.query({active: true, windowId: this.win_id}, tabs => {
            this.startTabIndex = tabs[0].index;
            this.currentURL = tabs[0].url;
            this.tab_id = tabs[0].id;
            // test for afio
            afio.isInstalled().then(installed => {
                if ((this.afioIsInstalled = installed)) {
                    let nodes = ["datapath", "savepath", "downpath"].
                        map(what => afio.getDefaultDir(what))
                    Promise.all(nodes).then(([datanode, savenode, downnode]) => {
                        this.dataSourceFolder = datanode
                        this.macrosFolder = savenode
                        this.defDownloadFolder = downnode
                    })
                }
            }).then(resolve).catch(reject) // the only reason for that clumsy
                                           // statement is that
                                           // chrome.tabs.query expects a
                                           // callback
        })});
};


MacroPlayer.prototype.pause = function() {
    if (!this.pauseIsPending) {
        this.pauseIsPending = true
        context.updateState(this.win_id, "paused")
    }
};

MacroPlayer.prototype.unpause = function () {
    if (!this.pauseIsPending) {
        this.paused = false
        context.updateState(this.win_id, "playing")
        this.next("unpause")
    }
};



// Start macro replaying
// @macro is a macro name
// @loopnum - positive integer
// which should be used to specify cycled replaying
MacroPlayer.prototype.play = function(macro, limits, callback) {
    // console.info("Playing macro %O, limits %O", macro, limits);
    const comment = new RegExp("^\\s*(?:'.*)?$");
    this.source = macro.source;
    this.currentMacro = macro.name;

    // save macro id for "Edit" on error dialog
    this.file_id = macro.file_id;
    this.client_id = macro.client_id;
    this.bookmark_id = macro.bookmark_id;
    // save reference to callback
    this.callback = callback;
    this.limits = this.convertLimits(limits)
    // count lines
    var line_re = /\r?\n/g, count = 0;
    while (line_re.exec(this.source))
        count++;
    // TODO: check macro length

    // check number of loops
    this.times = macro.times || 1;
    this.currentLoop = macro.startLoop || 1;
    this.cycledReplay = this.times - this.currentLoop > 0;
    // debugger should be attached at least once for every page if there is an
    // event command
    this.debuggerAttached = false;

    this.reset().then(() => {
        this.checkFreewareLimits("loops", this.times)
        this.checkFreewareLimits("loops", this.currentLoop)
        this.beforeEachRun();
        this.addListeners();
        // we should set before parsing so parse errors can be reported
        this.playing = true;
        this.parseMacro();
    }).then(() => {
        // prepare stack of actions
        this.action_stack = this.actions.slice();
        this.action_stack.reverse();
        context.updateState(this.win_id,"playing");
        var panel = context[this.win_id].panelWindow;
        if (panel && !panel.closed) {
            panel.showLines(this.source);
            panel.setStatLine("Replaying "+self.currentMacro, "info");
        }
        // start replaying
        this.globalTimer.start();
        this.playNextAction("start");
    }).catch(e => this.handleError(e));

};



// parse macro
MacroPlayer.prototype.parseMacro = function() {
    const comment = new RegExp("^\\s*(?:'.*)?$");
    const linenumber_delta_re =
            new RegExp("^\\s*'\\s*!linenumber_delta\\s*:\\s*(-?\\d+)", "i");
    this.linenumber_delta = 0;  // workaround for #381
    // check macro syntax and form list of actions
    this.source = this.source.replace(/\r+/g, ""); // remove \r symbols if any
    var lines = this.source.split("\n");
    for (var i = 0; i < lines.length; i++) {
        // check for !linenubmer_delta
        var m = lines[i].match(linenumber_delta_re);
        if (m) {
            this.linenumber_delta = imns.s2i(m[1]);
            continue;
        }
        if (lines[i].match(comment)) { // skip comments and empty lines
            continue;
        }

        if (/^\s*(\w+)(?:\s+(.*))?$/.test(lines[i])) {
            var command = RegExp.$1.toLowerCase();
            var arguments = RegExp.$2 ? RegExp.$2 : "";
            // check if command is known
            if (!(command in this.RegExpTable))
                throw new SyntaxError("unknown command: "+
                                      command.toUpperCase()+
                                      " at line "+(i+1+this.linenumber_delta));
            // parse arguments
            var args = this.RegExpTable[command].exec(arguments);
            if ( !args )
                throw new SyntaxError("wrong format of "+
                                      command.toUpperCase()+" command"+
                                      " at line "+(i+1+this.linenumber_delta));
            // put parsed action into action list
            this.actions.push({name: command,
                               args: args, line: i+1});
            this.checkFreewareLimits("lines", this.actions.length)

        } else {
            throw new SyntaxError("can not parse macro line "+
                                  (i+1+this.linenumber_delta)
                                  +": "+lines[i]);
        }
    }
};



// exec current action
MacroPlayer.prototype.exec = function(action) {
    if (!this.retryInterval) {
        badge.set(this.win_id, {
            status: "playing",
            text: action.line.toString()
        });

        // highlight action
        var panel = context[this.win_id].panelWindow;
        if (panel && !panel.closed)
            panel.highlightLine(action.line);
    }

    this._ActionTable[action.name](action.args);
};

// delayed start of next action
MacroPlayer.prototype.next = function(caller_id) {
    var mplayer = this;
    if (this.delay) {
        this.waitingForDelay = true;
        if (!this.delayTimeout) {
            this.delayTimeout = setTimeout(function () {
                delete mplayer.delayTimeout;
                mplayer.waitingForDelay = false;
                mplayer.playNextAction(caller_id);
            }, this.delay);
        }
    } else {
        asyncRun(function() {mplayer.playNextAction(caller_id);});
    }
    // stop profile timer
    this.profiler.end("OK", 1, this);
};


MacroPlayer.prototype.playNextAction = function(caller_id) {
    if (!this.playing)
        return;

    var panel = context[this.win_id].panelWindow;
    if (panel && !panel.closed && !this.retryInterval) {
        panel.setStatLine("Replaying "+this.currentMacro, "info");
    }

    // call "each run" initialization routine
    if (caller_id == "new loop")
        this.beforeEachRun();

    if ( this.pauseIsPending ) { // check if player should be paused
        this.pauseIsPending = false;
        this.paused = true;
        return;
    } else if ( this.paused ||
                this.waitingForDelay ||    // replaying delay
                this.waitingForPageLoad || // a page is loading
                this.inWaitCommand ||     // we are in WAIT
                this.waitingForPassword || // asking for a password
                this.waitingForExtract     // extract dialog
              ) {
        if (Storage.getBool("debug"))
            console.debug("("+this.globalTimer.getElapsedSeconds().toFixed(3)+") "+
                          "playNextAction(caller='"+(caller_id || "")+"')"+
                          ", waiting for: "+
                          (this.waitingForDelay ? "delay, " : "")+
                          (this.waitingForPageLoad ? "page load, " : "")+
                          (this.waitingForPassword ? "password, " : "")+
                          (this.waitingForExtract ? "extract, " : "")+
                          (this.inWaitCommand ? "in wait, ": ""));
        // waiting for something
        return;
    }  else {
        // fetch next action
        if ( this.action_stack.length ) {
            this.currentAction = this.action_stack.pop();
            try {
                if (Storage.getBool("debug"))
                    console.debug(
                        "("+this.globalTimer.getElapsedSeconds().toFixed(3)+") "+
                            "playNextAction(caller='"+(caller_id || "")+
                            "')\n playing "+
                            this.currentAction.name.toUpperCase()+
                            " command"+
                            ", line: "+this.currentAction.line
                    );
                this.profiler.start(this.currentAction);
                this.exec(this.currentAction);
                // profiler.end() is called from next() method
            } catch (e) {
                if (e.name && e.name == "InterruptSignal") {
                    this.onInterrupt(e.id);
                } else {
                    this.handleError(e);
                }
            }
        } else {
            this.afterEachRun();
            if (this.currentLoop < this.times) {
                this.firstLoop = false;
                this.currentLoop++;
                var panel = context[this.win_id].panelWindow;
                if (panel && !panel.closed)
                    panel.setLoopValue(this.currentLoop);
                this.action_stack = this.actions.slice();
                this.action_stack.reverse();
                this.next("new loop");
            } else {
                // no more actions left
                this.stop();
            }
        }
    }
};



// handle error
MacroPlayer.prototype.handleError = function (e) {
    this.errorCode = e.errnum ? -1*Math.abs(e.errnum) : -1001;
    this.errorMessage = (e.name ? e.name : "Error")+": "+e.message;
    if (this.currentAction) {
        this.errorMessage += ", line: "+
            (this.currentAction.line+this.linenumber_delta).toString();
    }
    // save profiler data for the broken action
    this.profiler.end(this.errorMessage, this.errorCode, this);
    console.error(this.errorMessage);
    var args = {
        message: this.errorMessage,
        errorCode: this.errorCode,
        win_id: this.win_id,
        macro: {
            source: this.source,
            name: this.currentMacro,
            file_id: this.file_id,
            bookmark_id: this.bookmark_id
        }
    };
    showInfo(args);
    if (this.playing && !this.ignoreErrors) {
        this.stop();
    } else if(this.ignoreErrors) {
        this.next("error handler");
    }
};



// form lastPerformance and save STOPWATCH results
MacroPlayer.prototype.saveStopwatchResults = function() {
    // ensure that macro timeout is cleared
    this.globalTimer.stop();

    // save total run time
    this.totalRuntime = this.globalTimer.getElapsedSeconds();

    // make all values look like 00000.000
    var format = function(x) {
        var m = x.toFixed(3).match(/^(\d+)\.(\d{3})/);
        var s = m[1];
        while (s.length < 5)
            s = "0"+s;

        return s+"."+m[2];
    };

    this.lastPerformance.push(
        {
            name: "TotalRuntime",
            value: this.totalRuntime.toFixed(3).toString()
        }
    );

    if (!this.stopwatchResults.length)
        return;

    // "Date: 2009/11/12  Time: 15:32, Macro: test1.iim, Status: OK (1)"
    let now = new Date();
    let d = imns.formatDate("yyyy/dd/mm", now);
    let t = imns.formatDate("hh:nn", now);

    let newline = __is_windows() ? "\r\n" : "\n";
    let s = "\"Date: "+d+"  Time: "+t+
        ", Macro: "+this.currentMacro+
        ", Status: "+this.errorMessage+" ("+this.errorCode+")\",";
    s += newline;
    for (let r of this.stopwatchResults) {
        let timestamp = imns.formatDate("dd/mm/yyyy,hh:nn:ss", r.timestamp);
        s += timestamp+","+r.id+","+r.elapsedTime.toFixed(3).toString();
        s += newline;
        this.lastPerformance.push(
            {
                name: r.id,
                value: r.elapsedTime.toFixed(3)
            }
        );
    }

    if (!this.shouldWriteStopwatchFile)
        return;

    if (!this.afioIsInstalled) {
        console.error("Saving Stopwatch file requires File IO interface");
        return;
    }

    let file = this.stopwatchFile;
    if (!this.stopwatchFile) {
        if (this.stopwatchFolder)
            file = this.stopwatchFolder;
        else
            file = this.defDownloadFolder.clone()
        let filename = /^(.+)\.iim$/i.test(this.currentMacro) ?
            RegExp.$1 : this.currentMacro;
        file.append("performance_"+filename+".csv");
    }

    afio.appendTextFile(file, s).catch(console.error.bind(console));
};


MacroPlayer.prototype.profiler = {
    // make string representation of Date object
    make_str: function(x) {
        var prepend = function(str, num) {
            str = str.toString();
            var x = imns.s2i(str), y = imns.s2i(num);
            if (isNaN(x) || isNaN(y))
                return;
            while (str.length < num)
                str = '0'+str;
            return str;
        };
        var str = prepend(x.getHours(), 2)+":"+
            prepend(x.getMinutes(), 2)+":"+
            prepend(x.getSeconds(), 2)+"."+
            prepend(x.getMilliseconds(), 3);
        return str;
    },

    init: function() {
        this.profiler_data = new Array();
        this.macroStartTime = new Date();
        this.enabled = false;
    },


    start: function(action) {
        if (!this.enabled)
            return;
        this.currentAction = action;
        this.startTime = new Date();
    },


    end: function(err_text, err_code, mplayer) {
        if (!this.enabled || !this.startTime)
            return;
        var now = new Date();
        var elapsedTime = (now.getTime()-this.startTime.getTime())/1000;

        // form new profiler data object
        var data = {
            Line: this.currentAction.line+mplayer.linenumber_delta,
            StartTime: this.make_str(this.startTime),
            EndTime: this.make_str(now),
            ElapsedSeconds: elapsedTime.toFixed(3),
            StatusCode: err_code,
            StatusText: err_text,
            type: mplayer.ignoreErrors ? "errorignoreyes" : "errorignoreno"
        };

        // add timeout_threshold value if applicable
        if (this.currentAction.name == "tag") {
            var threshold = (mplayer.timeout_tag > 0) ?
                mplayer.timeout_tag : mplayer.timeout/10;
            // get threshold in percents of timeout_tag
            data.timeout_threshold =
                ((elapsedTime/threshold)*100).toFixed();
        } else if (this.currentAction.name == "url") {
            // get threshold in percents of timeout_page
            data.timeout_threshold =
                ((elapsedTime/mplayer.timeout)*100).toFixed();
        }
        // console.log("new profiler data, %O", data);
        this.profiler_data.push(data);

        // clear start data
        delete this.currentAction;
        delete this.startTime;
    },

    getResultingXMLFragment: function(mplayer) {
        if (!this.enabled)
            return "";
        var macroEndTime = new Date();
        var source = imns.trim(mplayer.source).split("\n");
        var doc = document.implementation.createDocument("", "Profile", null);
        var macro = doc.createElement("Macro");
        var name = doc.createElement("Name");
        name.textContent = mplayer.currentMacro;
        macro.appendChild(name);

        var lastStartTime = null; // this is for start/end time of comments

        // this is a counter for profiler_data[]
        var j = mplayer.linenumber_delta == 0 ? 0 : -mplayer.linenumber_delta;
        for (var i = 0; i < source.length; i++) {
            if (j < this.profiler_data.length &&
                this.profiler_data[j].Line == i+1+mplayer.linenumber_delta) {
                var command = doc.createElement("Command");
                var string = doc.createElement("String");
                // first set String node
                string.textContent = imns.trim(source[i]);
                command.appendChild(string);
                var x = this.profiler_data[j];
                for (var y in x) {
                    if (y != "type" && y != "timeout_threshold") {
                        var z = doc.createElement(y);
                        z.textContent = x[y];
                        command.appendChild(z);
                    }
                }
                // set 'type' attribute
                var type = doc.createAttribute("type");
                type.nodeValue = x.type;
                command.setAttributeNode(type);
                // set 'timeout_threshold' attribute
                if (x.timeout_threshold) {
                    var tt = doc.createAttribute("timeout_threshold");
                    tt.nodeValue = x.timeout_threshold;
                    command.setAttributeNode(tt);
                }
                lastStartTime = x.StartTime;
                j++;
                // now append the resulting node to "Macro"
                macro.appendChild(command);
            }
        }

        // add total nodes
        var start = doc.createElement("Start"); // macro start time
        start.textContent = this.make_str(this.macroStartTime);
        var end = doc.createElement("End"); // macro end time
        end.textContent = this.make_str(macroEndTime);
        var elapsed = doc.createElement("ElapsedSeconds"); // macro duration
        var duration = (macroEndTime.getTime()-
                        this.macroStartTime.getTime())/1000;
        elapsed.textContent = duration.toFixed(3);
        var status = doc.createElement("Status"); // error code and text
        var code = doc.createElement("Code");
        code.textContent = mplayer.errorCode;
        var text = doc.createElement("Text");
        text.textContent = mplayer.errorMessage;

        status.appendChild(code);
        status.appendChild(text);
        macro.appendChild(start);
        macro.appendChild(end);
        macro.appendChild(elapsed);
        macro.appendChild(status);

        doc.documentElement.appendChild(macro);
        var s = new XMLSerializer();
        var result = s.serializeToString(doc);

        return result.replace(/^[.\n\r]*<Profile>\s*/, "").
            replace(/\s*<\/Profile>/, "");
    }
};


MacroPlayer.prototype.saveProfilerData = function() {
    if(!this.defDownloadFolder)
        return;
    var xml_frag = this.profiler.getResultingXMLFragment(this);
    var file = null;
    if (this.profiler.file) { // file was set with !FILE_PROFILER
        if (__is_full_path(this.profiler.file)) {
            file = afio.openNode(this.profiler.file);
        } else {
            file = this.defDownloadFolder.clone()
            var leafname = /\.xml$/i.test(this.profiler.file)?
                this.profiler.file : this.profiler.file+".xml";
            file.append(leafname);
        }
    } else {
        file = this.defDownloadFolder.clone()
        file.append("Chrome_Profiler_"+imns.formatDate("yyyy-mm-dd")+".xml");
    }

    file.exists().then(function(exists) {
        if (exists) {
            return afio.readTextFile(file).then(function(x) {
                x = x.replace(/\s*<\/Profile>\s*$/, "\n"+xml_frag+"</Profile>");
                return afio.writeTextFile(file, x);
            });
        } else {
            var x = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n"+
                "<?xml-stylesheet type='text/xsl' href='Profiler.xsl'?>\n"+
                "<Profile>\n"+
                "<!--Profiled with iMacros for Chrome "+
                Storage.getChar("version")+" on "+(new Date())+"-->";
            x += xml_frag;
            x += "</Profile>";
            return afio.writeTextFile(file, x);
        }
    }).catch(console.error.bind(console));
};


MacroPlayer.prototype.stop = function() {    // Stop playing
    this.detachDebugger()
    this.playing = false
    this.pauseIsPending = false
    this.paused = false
    this.removeListeners();
    if (this.errorCode != 1) // save stopwatch result in case of error
        this.saveStopwatchResults();

    // clear wait and delay timeout if any
    if (this.delayTimeout) {
        clearTimeout(this.delayTimeout);
        delete this.delayTimeout;
    }
    if (this.waitTimeout) {
        clearTimeout(this.waitTimeout);
        delete this.waitTimeout;
    }
    if (this.waitInterval) {
        clearInterval(this.waitInterval);
        delete this.waitInterval;
    }
    for (var type of this.timers.keys())
        this.stopTimer(type);
    this.timers.clear();

    // stop profile timer
    // NOTE: handleError() saves data from broken action
    this.profiler.end("OK", 1, this);
    // write profiler data if any
    if (this.writeProfilerData) {
        this.saveProfilerData();
    }

    // tell content script do some clean-up
    communicator.postMessage("stop-replaying", {}, this.tab_id,
                             function() {});

    // clear user-set variables
    this.vars = new Array();
    this.userVars.clear();    
    context.updateState(this.win_id,"idle");

    // restore proxy settings
    if (this.proxySettings) {
        this.restoreProxySettings();
        this.proxySettings = null;
    }

    // remove badge text
    badge.clearText(this.win_id);

    // reset panel
    var panel = context[this.win_id].panelWindow;
    if (panel && !panel.closed)
        panel.setLoopValue(1);

    // show macro tree
    if (panel && !panel.closed)
        panel.showMacroTree();

    if (this.client_id) {
        var extra = {
            extractData: this.getExtractData(),
            lastPerformance: this.lastPerformance
        };
        if (this.profiler.si_enabled) {
            delete this.profiler.si_enabled;
            extra.profilerData =
                this.profiler.getResultingXMLFragment(this);
        }
        nm_connector.sendResponse(
            this.client_id,
            this.errorMessage,
            this.errorCode,
            extra
        );
    }

    if (typeof this.callback == "function") {
        var f = this.callback, self = this;
        delete this.callback;
        setTimeout(function() {f(self);}, 0);
    }
};


MacroPlayer.prototype.checkFreewareLimits = function(type, value) {
    let check = (max, msg) => {
        if (value <= max) {
            return value
        } else {
            throw new FreewareLimit(msg + " " + value + " exceeds max value " + max)
        }
    }
    if(!this.limits) 
        return value;
    switch(type) {
    case "lines":
        return check(this.limits.maxMacroLen, "macro length")
    case "loops":
        return check(this.limits.maxIterations, "number of iterations")
    case "csv_rows":
        return check(this.limits.maxCSVRows, "number of CSV rows")
    case "csv_cols":
        return check(this.limits.maxCSVCols, "number of CSV columns")
    case "user_vars":
        if (!this.limits.userVars) {
            throw new FreewareLimit("user defined variables not allowed."+
                                    " Maximum number of variables is " +
                                    this.limits.maxVariables)
        } else {
            return value
        }
    }
}

MacroPlayer.prototype.convertLimits = function(limits) {
    // { "maxVariables" : number|"unlimited",
    //   "maxCSVRows" : number|"unlimited",
    //   "maxCSVCols" : number|"unlimited",
    //   "maxMacroLen" : number|"unlimited",
    //   "maxIterations" : number|"unlimited" }

    let convert = x => x == "unlimited" ? Number.MAX_SAFE_INTEGER : x
    let obj = {}
    for (key in limits) {
        obj[key] = convert(limits[key])
    }
    obj.varsRe = limits.maxVariables == "unlimited" || limits.maxVariables >= 10 ?
        /^!var([0-9]+)$/i : new RegExp("^!var([1-"+limits.maxVariables+"])$", "i");
    obj.userVars = limits.maxVariables == "unlimited" || limits.maxVariables >= 10;

    return Object.freeze(obj)
}

// functions to manipulate extraction results
MacroPlayer.prototype.getExtractData = function () {
    return this.extractData;
};

MacroPlayer.prototype.addExtractData = function(str) {
    if ( this.extractData.length ) {
        this.extractData += "[EXTRACT]"+str;
    } else {
        this.extractData = str;
    }
};

MacroPlayer.prototype.clearExtractData = function() {
    this.extractData = "";
};


// Show Popup for extraction
MacroPlayer.prototype.showAndAddExtractData = function(str) {
    this.addExtractData(str);
    if (!this.shouldPopupExtract)
        return;
    this.waitingForExtract = true;
    var features = "titlebar=no,menubar=no,location=no,"+
        "resizable=yes,scrollbars=yes,status=no,"+
        "width=430,height=380";
    var win = window.open("extractDialog.html",
        null, features);
    win.args = {
        data: str,
        mplayer: this
    };
};



// Datasources
MacroPlayer.prototype.loadDataSource = function(filename) {
    var file;
    if (!__is_full_path(filename)) {
        if (this.dataSourceFolder)
            file = this.dataSourceFolder.clone();
        else
            throw new RuntimeError("Datasource folder is not set", 730)

        file.append(filename);
    } else {
        file = afio.openNode(filename);
    }
    var mplayer = this;
    return file.exists().then(function(exists) {
        if (!exists) {
            throw new RuntimeError("Data source file does not exist", 730)
        }
        mplayer.dataSourceFile = file.path;
        return afio.readTextFile(file).then(function(data) {
            if (!/\r?\n$/.test(data))
                data += "\n";     // add \n to make regexp not so complicated
            mplayer.dataSource = new Array();
            // regexp to match single data field
            // based on http://edoceo.com/utilitas/csv-file-format
            var ws = '[ \t\v]';   // non-crlf whitespace,
            // TODO: should we include all Unicode ws?
            var delim = mplayer.dataSourceDelimiter;
            var field = ws+'*("(?:[^\"]+|"")*"|[^'+delim+'\\n\\r]*)'+ws+
                '*('+delim+'|\\r?\\n|\\r)';
            var re = new RegExp(field, "g"), m, vals = new Array();
            while (m = re.exec(data)) {
                var value = m[1], t;
                if (t = value.match(/^\"((?:[\r\n]|.)*)\"$/))
                    value = t[1];   // unquote the line
                value = value.replace(/\"{2}/g, '"'); // normalize double quotes
                // HACK: every {{!COLn}} variable is "unwrap()-ped" in
                // command handlers so we have to do some trickery to
                // preserve double-quoted strings
                // see fx #362
                if (t = value.match(/^\"((?:[\r\n]|.)*)\"$/))
                    value = '"\\"'+t[1]+'\\""';
                vals.push(value);
                mplayer.checkFreewareLimits("csv_cols", vals.length)
                if (m[2] != delim) {
                    mplayer.dataSource.push(vals.slice(0));
                    let rowCount = mplayer.dataSource.length
                    mplayer.checkFreewareLimits("csv_rows", rowCount)
                    vals = new Array();
                }
            }

            if (!mplayer.dataSource.length) {
                    throw new RuntimeError("Can not parse datasource file "+
                                           filename, 752)
            }
        }).catch(function(err) {
            mplayer.handleError(err);
        });
    });
};


MacroPlayer.prototype.getColumnData = function (col) {
    var line =  this.dataSourceLine || this.currentLoop;

    if (!line)
        line = 1;

    var max_columns = this.dataSourceColumns || this.dataSource[line-1].length;
    if (col > max_columns)
        throw new RuntimeError("Column number "+col+
                               " greater than total number"+
                               " of columns "+max_columns, 753);

    return this.dataSource[line-1][col-1];
};


// functions to access built-in VARiables
MacroPlayer.prototype.getVar = function(idx) {
    var num = typeof idx === "string" ? imns.s2i(idx) : idx;
    return this.vars[num] || "";
};

// functions to access user defined variables
MacroPlayer.prototype.setUserVar = function(name, value) {
    this.checkFreewareLimits("user_vars", null);
    this.userVars.set(name.toLowerCase(), value);
};

MacroPlayer.prototype.getUserVar = function(name) {
    this.checkFreewareLimits("user_vars", null);
    var value = this.userVars.get(name.toLowerCase());
    return value === undefined ? "" : value;
};

MacroPlayer.prototype.hasUserVar = function(name) {
    this.checkFreewareLimits("user_vars", null);
    return this.userVars.has(name.toLowerCase());
};




function InterruptSignal(eval_id) {
    this.id = eval_id;
    this.name = "InterruptSignal";
    this.message = "Script interrupted";
}

MacroPlayer.prototype.do_eval = function (s, eval_id) {
    // check if we already eval-ed the expression
    if (this.__eval_results[eval_id]) {
        var result = this.__eval_results[eval_id].result;
        delete this.__eval_results[eval_id];
        return result.toString();
    } else {
        // there was no expression result so send it to sandbox
        var str = s ? imns.unwrap(s) : "";
        var eval_data = {
            type: "eval_in_sandbox",
            id: eval_id,
            expression: str
        };

        document.getElementById("sandbox").contentWindow.postMessage(eval_data, "*");
        // we should put previos action back to stack
        this.action_stack.push(this.currentAction);
        // interrupt macro execution to wait for sandbox answer
        throw new InterruptSignal(eval_id);
    }
};


MacroPlayer.prototype.onSandboxMessage = function(event) {
    var x = event.data;
    if (!x.type || x.type != "eval_in_sandbox_result")
        return;
    
    var r = x.result;
    // convert undefined or null result to a string value
    if (typeof(x.result) == "undefined") {
        r = "undefined";
    } else if (!r && typeof(r) == "object") {
        r = "null";
    }
    // store the result
    this.__eval_results[x.id] = {
        result: r
    };

    if (x.error) {
        this.handleError(x.error);
    } else {
        this.playNextAction("eval");
    }
};

MacroPlayer.prototype.onInterrupt = function(eval_id) {
    if (Storage.getBool("debug")) {
        console.debug("Caught interrupt exception, eval_id="+eval_id);
    }
};

// This function substitutes all occurrences of
// {{varname}} with the variable value
// Use '#NOVAR#{{' to insert '{{'
// (the function would fail if a variable contains '#novar#{' string)
MacroPlayer.prototype.expandVariables = function(param, eval_id) {
    // first replace all #NOVAR#{{ by #NOVAR#{
    param = param.replace(/#novar#\{\{/ig, "#NOVAR#{");
    // substitute {{vars}}
    var mplayer = this;
    var handleVariable = function (match_str, var_name) {
        var t = null;
        if ( t = var_name.match(mplayer.limits.varsRe) ) {
            return mplayer.getVar(t[1]);
        } else if ( t = var_name.match(/^!extract$/i) ) {
            return mplayer.getExtractData();
        } else if ( t = var_name.match(/^!urlcurrent$/i) ) {
            return mplayer.currentURL;
        } else if ( t = var_name.match(/^!col(\d+)$/i) ) {
            return mplayer.getColumnData(imns.s2i(t[1]));
        } else if ( t = var_name.match(/^!datasource_line$/i) ) {
            return mplayer.dataSourceLine || mplayer.currentLoop;
        } else if ( t = var_name.match(/^!datasource_columns$/i) ) {
            return mplayer.dataSourceColumns;
        } else if ( t = var_name.match(/^!datasource_delimiter$/i) ) {
            return mplayer.dataSourceDelimiter;
        } else if ( t = var_name.match(/^!datasource$/i) ) {
            return mplayer.dataSourceFile;
        } else if ( t = var_name.match(/^!folder_datasource$/i) ) {
            return mplayer.dataSourceFolder ?
                mplayer.dataSourceFolder.path : "__undefined__";
        } else if ( t = var_name.match(/^!folder_download$/i) ) {
            return mplayer.defDownloadFolder ?
                mplayer.defDownloadFolder.path : "__undefined__";
        } else if ( t = var_name.match(/^!folder_macros$/i) ) {
            return mplayer.macrosFolder ?
                mplayer.macrosFolder.path : "__undefined__";
        } else if ( t = var_name.match(/^!now:(\S+)$/i) ) {
            return imns.formatDate(t[1]);
        } else if ( t = var_name.match(/^!loop$/i) ) {
            return mplayer.currentLoop;
        } else if ( t = var_name.match(/^!clipboard$/i) ) {
            return imns.Clipboard.getString() || "";
        }  else if ( t = var_name.match(/^!timeout(?:_page)?$/i) ) {
            return mplayer.timeout.toString();
        } else if ( t = var_name.match(/^!timeout_(?:tag|step)$/i) ) {
            return mplayer.timeout_tag.toString();
        } else if ( t = var_name.match(/^!timeout_download$/i) ) {
            return mplayer.timeout_download.toString();
        } else if ( t = var_name.match(/^!downloaded_file_name$/i) ) {
            return mplayer.downloadedFilename;
        } else if ( t = var_name.match(/^!downloaded_size$/i) ) {
            return mplayer.downloadedSize;
        } else if ( t = var_name.match(/^!stopwatchtime$/i) ) {
            // convert to d+\.d{3} format
            var value = mplayer.lastWatchValue.toFixed(3);
            return value;
        } else if ( t = var_name.match(/^!imagex$/i) ) {
            return mplayer.imageX;
        } else if ( t = var_name.match(/^!imagey$/i) ) {
            return mplayer.imageY;
        } else if ( t = var_name.match(/^!\S+$/) ) {
            throw new BadParameter("Unsupported variable "+var_name);
        } else {                // a user-defined variable
            return mplayer.getUserVar(var_name);
        }
    };


    // check for "eval" command
    var eval_re = new RegExp("^eval\\s*\\((.*)\\)$", "i");
    var match = null;
    if (match = eval_re.exec(param)) {
        var escape = function (s) {
            var x = s.toString();
            return x.replace(/"/g, "\\\\\"").
                replace(/'/g, "\\\\\'").
                replace(/\n/g, "\\\\n").
                replace(/\r/g, "\\\\r");
        };
        var js_str = match[1].replace(/\{\{(\S+?)\}\}/g, function(m, s) {
            return escape(handleVariable(m, s))
        });
        // substitute all #novar#{ by {{
        js_str = js_str.replace(/#novar#\{(?=[^\{])/ig, "{{");
        param = this.do_eval(js_str, eval_id);
    } else {
        param = param.replace(/\{\{(\S+?)\}\}/g, handleVariable);
        // substitute all #novar#{ by {{
        param = param.replace(/#novar#\{(?=[^\{])/ig, "{{");
    }

    return param;
};



======================================================================
FILE PATH: mrecorder.js
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/

"use strict";

// An object to encapsulate all recording operations
// on extension side
function Recorder(win_id) {
    this.win_id = win_id;
    this.recording = false;
    communicator.registerHandler("record-action",
                                 this.onRecordAction.bind(this), win_id);
    communicator.registerHandler("password-element-focused",
                                 this.onPasswordElementFocused.bind(this),
                                 win_id)
    communicator.registerHandler("query-state",
                                 this.onQueryState.bind(this), win_id);
    // make bindings of event listeners
    this.onActivated = this.onTabActivated.bind(this);
    this.onCreated = this.onTabCreated.bind(this);
    // this.onUpdated = this.onTabUpdated.bind(this);
    this.onRemoved = this.onTabRemoved.bind(this);
    this.onMoved = this.onTabMoved.bind(this);
    this.onAttached = this.onTabAttached.bind(this);
    this.onDetached = this.onTabDetached.bind(this);

    // Debugger protocol
    // this.onEvent = this.onDebugProtoEvent.bind(this);
    // this.onDetach = this.onDebuggerDetached.bind(this);

    // bindings to monitor network activity
    this.onAuth = this.onAuthRequired.bind(this);
    // this.onRequest = this.onBeforeRequest.bind(this);
    // this.onRedirect = this.onBeforeRedirect.bind(this);
    // this.onSendHeaders = this.onBeforeSendHeaders.bind(this);
    // this.onCompleted = this.onReqCompleted.bind(this);
    // this.onReqError = this.onErrorOccurred.bind(this);
    // this.onHeaders = this.onHeadersReceived.bind(this);
    // this.onResponse = this.onResponseStarted.bind(this);
    // this.onSend = this.onSendHeaders.bind(this);

    this.onCommitted = this.onNavigation.bind(this);
    this._onDownloadCreated = this.onDownloadCreated.bind(this);
    this._onContextMenu = this.onContextMenu.bind(this);
};


Recorder.prototype.checkForFrameChange = function(frame) {
    if (frame.number != this.currentFrameNumber) {
        this.currentFrameNumber = frame.number;
        if (0 && frame.name) {
            this.recordAction("FRAME NAME=\""+frame.name+"\"");
        } else {
            this.recordAction("FRAME F="+frame.number.toString());
        }
    }
};


Recorder.prototype.start = function() {
    // console.info("start recording");
    this.writeEncryptionType = true;
    this.password = null;
    this.canEncrypt = true
    context.updateState(this.win_id,"recording");
    var panel = context[this.win_id].panelWindow;
    if (panel && !panel.closed) {
        panel.showLines();
        panel.setStatLine("Recording...", "info");
    }
    // create array to store recorded actions
    this.actions = new Array();
    var recorder = this;
    chrome.tabs.query({active: true, windowId: this.win_id}, function (tabs) {
        recorder.recording = true;
        // save starting tab index
        recorder.startTabIndex = tabs[0].index;
        // recorder.tab_id = tabs[0].id;
        // add browser events listeners
        recorder.addListeners();
        // reset frame number
        recorder.currentFrameNumber = 0;
        // notify content script that recording was started
        communicator.broadcastMessage("start-recording", {
            args: {favorId: Storage.getBool("recording-prefer-id"),
                   cssSelectors: Storage.getBool("recording-prefer-css-selectors"),
                   recordMode: Storage.getChar("record-mode")}
        }, recorder.win_id);
        // save intial commands
        recorder.recordAction("VERSION BUILD=" + Storage.getChar("version").replace(/\./g, "") + " RECORDER=CR");
        if (!/^chrome:\/\//.test(tabs[0].url)) {
            recorder.recordAction("URL GOTO="+tabs[0].url);
        }
    });
};


Recorder.prototype.stop = function() {
    // console.info("stop recording");
    // notify content script that recording was stopped
    communicator.broadcastMessage("stop-recording", {}, this.win_id);
    context.updateState(this.win_id, "idle");

    this.recording = false;
    this.removeListeners();
    // remove text from badge
    badge.clearText(this.win_id);
    var panel = context[this.win_id].panelWindow;
    if (panel && !panel.closed)
        panel.showMacroTree();
};


Recorder.prototype.beforeRecordAction = function(cmd) {
    // check for double-command
    var match_part = cmd;
    if (/^(tag .*\s+content\s*=)/i.test(cmd))
        match_part = RegExp.$1;
    if (!/^event/i.test(cmd) &&
        this.actions.length &&
        this.actions[this.actions.length-1].indexOf(match_part) == 0)
    {
        // remove previously recorded element if it matches
        // with the current one
        // useful for selectboxes and double clicking
        this.popLastAction()
    }
};

Recorder.prototype.recordAction = function (cmd) {
    this.beforeRecordAction(cmd);
    var panel = context[this.win_id].panelWindow;
    this.actions.push(cmd);
    if (panel && !panel.closed) {
        panel.addLine(cmd);
    }

    badge.set(this.win_id, {
        status: "recording",
        text:  this.actions.length.toString()
    });

    this.afterRecordAction(cmd);
    // console.info("recorded action: "+cmd);
}

Recorder.prototype.recordActions = function(...actions) {
    actions.forEach(this.recordAction.bind(this))
}


Recorder.prototype.afterRecordAction = function(rec) {
}

Recorder.prototype.recordEncryptionType = function() {
    let typ = Storage.getChar("encryption-type")
    if (!typ.length)
        typ = "no"
    let enc_types = {
        "no": "SET !ENCRYPTION NO",
        "stored": "SET !ENCRYPTION STOREDKEY",
        "tmpkey": "SET !ENCRYPTION TMPKEY"
    }
    let password_promise = null
    if (typ == "no") {
        password_promise = Promise.resolve({canceled: true});
    } else if (typ == "stored") {
        let pwd = Storage.getChar("stored-password")
        // stored password is base64 encoded
        pwd = decodeURIComponent(atob(pwd))
        password_promise = Promise.resolve({password: pwd})
    } else if (typ == "tmpkey") {
        password_promise =  Rijndael.tempPassword ?
            Promise.resolve({
                password: Rijndael.tempPassword
            }) : dialogUtils.openDialog("passwordDialog.html",
                                        "iMacros Password Dialog",
                                        {type: "askPassword"})
    }

    password_promise.then(response => {
        this.recordAction(
            enc_types[response.canceled ? "no" : typ]
        )
        if (!response.canceled) {
            this.password = response.password
            if (typ == "tmpkey")
                Rijndael.tempPassword = response.password
        } else {
            this.canEncrypt = false
        }
    })
}

Recorder.prototype.onPasswordElementFocused = function(data, tab_id, callback) {
    typeof (callback) == "function" &&
        callback()

    if (!this.writeEncryptionType)
        return

    this.writeEncryptionType = false

    // onPasswordElementFocused is called when a password element gets focus. To
    // not break the sequence of events we defer writing encryption time until
    // we get click or keyup events. In case the focus was gained by any other
    // means, e.g. throw changing tab we write the encryption type straight
    // away.
    let cur = this.peekLastAction()
    if (cur.indexOf("EVENT TYPE=KEYDOWN") == 0)
        this.pendingEncRecord = "keydown"
    else if (cur.indexOf("EVENT TYPE=MOUSEDOWN") == 0)
        this.pendingEncRecord = "mousedown"
    else
        this.recordEncryptionType()
}

Recorder.prototype.onRecordAction = function(data, tab_id, callback) {
    // console.log("onRecordAction, data="+JSON.stringify(data));
    typeof (callback) == "function" &&   // release resources
        callback();

    if (data._frame) {
        this.checkForFrameChange(data._frame);
    }

    let in_event_mode = Storage.getChar("record-mode") == "event"
    this.recordAction(data.action)
    // test action for password element
    if (!in_event_mode && data.extra && data.extra.encrypt) {
         // handle password
        this.encryptTagCommand()
    } else if (in_event_mode && data.extra) {
        this.packAction(data.extra)
    }
}


Recorder.prototype.removeLastLine = function(n) {
    var num = n || 1;
    var panel = context[this.win_id].panelWindow;
    if (panel && !panel.closed) {
        while (num--)
            panel.removeLastLine();
    }
};

Recorder.prototype.peekLastAction = function() {
    return this.actions.length? this.actions[this.actions.length-1] : ""
}

Recorder.prototype.popLastAction = function() {
    console.assert(this.actions.length > 0, "popLastAction is called"+
                   " but action list is empty")
    this.removeLastLine()
    return this.actions.pop()
}

Recorder.prototype.popLastActions = function(n) {
    console.assert(this.actions.length > n, "popLastActions is called"+
                   " but action list is empty")
    let arr = []
    while (n-- > 0) {
        this.removeLastLine()
        arr.push(this.actions.pop())
    }

    return arr
}

Recorder.prototype.packClickEvent = function(extra) {
    console.assert(this.actions.length >= 2, "click event should be "+
                   "preceeded by at least two actions");
    let mdown_action = "EVENT TYPE=MOUSEDOWN SELECTOR=\""+
        extra.selector+"\""
    let mup_action = "EVENT TYPE=MOUSEUP"
    let [cur, prv, pprv] = this.popLastActions(3)
    if (pprv.indexOf(mdown_action) == 0 &&
        prv.indexOf(mup_action) == 0) {
        this.recordAction(cur)
        if (this.pendingEncRecord == "mousedown") {
            this.recordEncryptionType()
            delete this.pendingEncRecord
        }
    } else {
        this.recordActions(pprv, prv, cur)
    }
}

Recorder.prototype.packDblClickEvent = function(extra) {
    console.assert(this.actions.length >= 2, "dblclick event should be "+
                   "preceeded by at least two actions")
    let click_action = "EVENT TYPE=CLICK SELECTOR=\""+extra.selector+"\""
    let [cur, prv, pprv] = this.popLastActions(3)
    if (prv.indexOf(click_action) == 0 &&
        pprv.indexOf(click_action) == 0) {
        this.recordAction(cur)
    } else {
        this.recordActions(pprv, prv, cur)
    }
}

Recorder.prototype.packMouseMoveEvent = function(extra) {
    const re = new RegExp('^events? type=mousemove\\b.+'+
                          '\\points?="(\\S+)"', "i")
    let [cur, prv] = this.popLastActions(2)
    if (this.actions.length && this.prevTarget == extra.selector) {
        let m = re.exec(prv)
        if ( m ) {
            // TODO: I'm not sure about modifiers.
            // It is possible that user depresses Shift key
            // in the middle of drag operation.
            // However, as only final modifier affects
            // the operation, I think writing last modifier
            // will work in most practical cases.
            this.recordAction(
                "EVENTS TYPE=MOUSEMOVE SELECTOR=\""+extra.selector+"\""+
                    " POINTS=\""+m[1].toString()+
                    ",("+extra.point.x+","+extra.point.y+")\""+
                    (extra.modifiers ?
                     " MODIFIERS=\""+extra.modifiers+"\"" : "")
            )
        }
    } else {
        this.prevTarget = extra.selector
        this.recordActions(prv, cur)
    }
};


Recorder.prototype.packKeyDownEvent = function(extra) {
    // basically it is only needed to save prevTarget as all the work is
    // done on keyup
    this.prevTarget = extra.selector
}

Recorder.prototype.packKeyboardEvents = function(extra) {
    // check if the just recorded keypress action can be merged with previous
    // EVENTS command (for sucessive input)
    const chars_re = new RegExp('^events? type=keypress selector=\"([^\"]+)\"'+
                                ' chars?=\"([^\"]+)\"', "i")
    const keys_re = new RegExp("^events? type=keypress selector=\"([^\"]+)\""+
                              " (keys?)=(?:(\\d+)|\"([^\"]+)\")"+
                              "(?: modifiers=\"([^\"]+)\")?", "i")
    const ch_re = new RegExp("^events? type=keypress selector=\"([^\"]+)\""+
                             " chars?=\"([^\"]+)\"", "i")
    const kd_re = new RegExp("^event type=keypress selector=\"([^\"]+)\""+
                             " key=(\\d+)(?: modifiers=\"([^\"]+)\")?", "i")

    let [cur, prv] = this.popLastActions(2)
    let cur_match = null
    let prv_match = null

    // first check if it is a char event and the previous EVENTS for the same
    // selectors are chars as well
    if ((cur_match = cur.match(ch_re)) &&
        (prv_match = prv.match(chars_re)) &&
        cur_match[1] == prv_match[1]) {
        let ch = imns.unwrap(cur_match[2])
        let chars = imns.unwrap(prv_match[2])
        if (this.encryptKeypressEvent && this.canEncrypt) {
            this.encryptKeypressEvent = false
            // decrypt chars from the previous event
            try {
                ch = Rijndael.decryptString(ch, this.password)
                chars = Rijndael.decryptString(chars, this.password)
            } catch (e) {
                // we can not continue if password is incorrect
                showInfo({
                    message: "Encryption type or stored password was changed"+
                        " while recording!",
                    win_id: this.win_id,
                })
                return
            }
            chars = Rijndael.encryptString(chars + ch, this.password)
        } else {
            chars += ch
        }

        this.recordAction(
            "EVENTS TYPE=KEYPRESS SELECTOR=\""+cur_match[1]+"\""+
                " CHARS=\""+imns.escapeLine(chars)+"\""
        )
    }
    // then check the same for control key sequence
    else if ((cur_match = cur.match(kd_re)) &&
             (prv_match = prv.match(keys_re)) &&
             cur_match[1] == prv_match[1] &&
             cur_match[5] == prv_match[5]) {
        let keys = prv_match[2] == "KEYS" ?
            JSON.parse(prv_match[4]) : [JSON.parse(prv_match[3])]
        keys.push(parseInt(cur_match[2]))
        this.recordAction(
            "EVENTS TYPE=KEYPRESS SELECTOR=\""+cur_match[1]+"\""+
                " KEYS="+"\""+JSON.stringify(keys)+"\""+
                (cur_match[3] && cur_match[3].length ?
                 " MODIFIERS=\""+cur_match[3]+"\"" : "")
        )
    }
    // and if all failed then just leave the commands intact
    else {
        this.recordActions(prv, cur)
    }

    if (this.pendingEncRecord == "keydown") {
        this.recordEncryptionType()
        delete this.pendingEncRecord
    }
}

Recorder.prototype.packSingleKeyPressEvent = function(extra, cur, prv, pprv) {
    // in fact, we need only one key event out of the trhee because on
    // replaying it unfolds into three commands
    this.recordAction(prv)
    this.packKeyboardEvents(extra)
}

Recorder.prototype.packKeyUpDownEvent = function(extra, cur, prv, pprv) {
    if (pprv)
        this.recordAction(pprv) // this should be left intact

    let cmd = "EVENT TYPE=KEYPRESS SELECTOR=\""+extra.selector+"\""+
        " KEY="+extra.key+(extra.modifiers.length ?
                           " MODIFIERS=\""+extra.modifiers+"\"" : "")
    this.recordAction(cmd)
    this.packKeyboardEvents(extra)
}

Recorder.prototype.packKeyUpEvent = function(extra) {
    console.assert(this.actions.length >= 3, "packKeyUpEvent require "+
                   "at least three recorded actions")
    if (this.prevTarget != extra.selector)
        return

    const keydown_str = "EVENT TYPE=KEYDOWN SELECTOR=\""+extra.selector+"\""
    const keypress_re = new RegExp("EVENTS? TYPE=KEYPRESS SELECTOR=\""+
                                   imns.escapeREChars(extra.selector)+"\"")

    let [cur, prv, pprv] = this.popLastActions(3)

    if (keypress_re.test(prv) && pprv.indexOf(keydown_str) == 0) {
        // it is a first key event in a sequence so just collapse three events
        // into one keypress
        this.packSingleKeyPressEvent(cur, extra, prv, pprv)
    } else if (prv.indexOf(keydown_str) == 0) {
        // this is most likely a control key
        this.packKeyUpDownEvent(extra, cur, prv, pprv)
    } else {
        // write events as is because it's not clear what to do
        this.recordActions(pprv, prv, cur)
    }
}

Recorder.prototype.packKeyPressEvent = function(extra) {
    if (!(this.encryptKeypressEvent = extra.encrypt))
        return  // do nothing

    const ch_re = new RegExp("^event type=keypress selector=\"([^\"]+)\""+
                             " char=\"([^\"]+)\"", "i")
    let cur = this.popLastAction()
    let match = cur.match(ch_re)

    if (match) {
        let ch = Rijndael.encryptString(imns.unwrap(match[2]), this.password)
        this.recordAction(
            "EVENTS TYPE=KEYPRESS SELECTOR=\""+match[1]+"\""+
                " CHARS=\""+imns.escapeLine(ch)+"\""
        )
    }
}

Recorder.prototype.packAction = function(extra) {
    // console.log("packAction rec=%s, extra=%O", rec, extra);
    if (extra.pack_type == "click") {
        this.packClickEvent(extra)
    } else if (extra.pack_type == "dblclick") {
        this.packDblClickEvent(extra)
    } else if (extra.pack_type == "mousemove") {
        this.packMouseMoveEvent(extra)
    } else if (extra.pack_type == "keydown") {
        this.packKeyDownEvent(extra)
    } else if (extra.pack_type == "keyup") {
        this.packKeyUpEvent(extra)
    } else if (extra.pack_type == "keypress") {
        this.packKeyPressEvent(extra)
    }
}

Recorder.prototype.encryptTagCommand = function() {
    let cmd = this.popLastAction()
    let m = cmd.match(/^tag\b.+\bcontent=(\S+)\s*$/i)
    if (!m) {
        console.error("encryptTagCommand called but last command"+
                      " has no CONTENT")
        return
    }
    let cyphertext = this.canEncrypt ?
        Rijndael.encryptString(m[1], this.password) : m[1]
    let updated_cmd = cmd.replace(/(content)=(\S+)\s*$/i, "$1="+cyphertext)
    this.recordAction(updated_cmd)
};

Recorder.prototype.saveAs = function() {
    var rec = "SAVEAS TYPE=MHT FOLDER=* FILE=*";
    this.recordAction(rec);
};

Recorder.prototype.capture = function() {
    var rec = "SAVEAS TYPE=PNG FOLDER=* FILE=*";
    this.recordAction(rec);
};



Recorder.prototype.onQueryState = function(data, tab_id, callback) {
    var recorder = this;
    chrome.tabs.get(tab_id, function (tab) {
        if (tab.windowId != recorder.win_id)
            return;
        if (tab.index < recorder.startTabIndex) {
            // don't touch tabs left of start tab
            callback({state: "idle"});
        } else {
            if (recorder.recording) {
                callback({
                    args: {favorId: Storage.getBool("recording-prefer-id"),
                           cssSelectors: Storage.getBool("recording-prefer-css-selectors"),
                           recordMode: Storage.getChar("record-mode")},
                    state: "recording",
                    frameNumber: recorder.currentFrameNumber
                });
            } else {
                callback({state: "idle"});
            }
        }
    });
};


// Add listeners for recording events
// tab selection
Recorder.prototype.onTabActivated = function(activeInfo) {
    if (this.win_id != activeInfo.windowId)
        return;
    var recorder = this;
    chrome.tabs.get(activeInfo.tabId, function (tab) {
        var cur = tab.index - recorder.startTabIndex;
        if (cur < 0) {
            // TODO: add real warning here
            console.warn("Note: Tabs LEFT "+
                         "of the start tab are not recorded.");
            return;
        }
        var cmd = "TAB T="+(cur+1);
        recorder.recordAction(cmd);
        // recorder.detachDebugger(recorder.tab_id)
        //     .then(function() {
        //         return recorder.attachDebugger(activeInfo.tabId);
        //     }).then(function() {
        //         recorder.tab_id = activeInfo.tabId;
        //     }).catch(console.error.bind(console));
    });
};

// tab creation
Recorder.prototype.onTabCreated = function(tab) {
    if (this.win_id != tab.windowId)
        return;
    // console.log("onTabCreated, %O", tab);

    if (!tab.url && !tab.title) // looks like this tab is opened by web page
        return;

    var cmd = "TAB OPEN";
    this.recordAction(cmd);
};

// // tab update
// Recorder.prototype.onTabUpdated = function(tab_id, obj, tab) {
//     if (this.win_id != tab.windowId)
//         return;
//     chrome.tabs.get(tab_id, function (tab) {
//         // TODO: wait for they added 'type' property
//         console.log("onTabUpdated, openerTabId %s", tab.openerTabId);
//         if (obj.status == "loading" && obj.url && !tab.openerTabId) {
//             var cmd = "URL GOTO="+obj.url;
//             recorder.recordAction(cmd);
//         }
//     });
// };


// tab closed
Recorder.prototype.onTabRemoved = function(tab_id) {
    var recorder = this;
    chrome.tabs.get(tab_id, function (tab) {
        if (!tab || recorder.win_id != tab.windowId)
            return;
        var cmd = "TAB CLOSE";
        recorder.recordAction(cmd);
    });
};


// tab move, give a warning
Recorder.prototype.onTabMoved = function(tab_id, obj) {
    if (this.win_id != obj.windowId)
        return;
    // TODO: add real warning
    console.warn("tab move not supported");
};

// tab attached, give a warning
Recorder.prototype.onTabAttached = function(tab_id, obj) {
    if (this.win_id != obj.newWindowId)
        return;
    // TODO: add real warning
    console.warn("tab attachment not supported");

};

// tab detached, give a warning
Recorder.prototype.onTabDetached = function(tab_id, obj) {
    if (this.win_id != obj.oldWindowId)
        return;

    // TODO: add real warning
    console.warn("tab detachment not supported");

};


Recorder.prototype.onDownloadCreated = function(dl) {
    var self = this;
    chrome.tabs.query({active: true, windowId: this.win_id}, function (tabs) {
        if (dl.referrer != tabs[0].url)
            return;
        var prev_rec = self.popLastAction()
        var rec = "ONDOWNLOAD FOLDER=*"+
            " FILE=+_{{!NOW:yyyymmdd_hhnnss}}"+
            " WAIT=YES";
        self.recordAction(rec);
        self.recordAction(prev_rec);
    });
};


Recorder.prototype.onContextMenu = function(info, tab) {
    if (!tab || this.win_id != tab.windowId)
        return;

    var self = this;
    communicator.postMessage(
        "on-rclick",
        { linkUrl: info.linkUrl, frameUrl: info.frameUrl },
        tab.id,
        function(data) {
            var fail_msg = "' Element corresponding to right click action"+
                " was not found.";
            if (!data.found) {
                self.recordAction(fail_msg);
                return;
            }
            self.checkForFrameChange(data._frame);
            var rec = "ONDOWNLOAD FOLDER=*"+
                " FILE=+_{{!NOW:yyyymmdd_hhnnss}}"+
                " WAIT=YES";
            self.recordAction(rec);
            self.recordAction(data.action);
        },
        {number: 0});
};

Recorder.prototype.onNavigation = function(details) {
    var recorder = this;
    chrome.tabs.get(details.tabId, function(tab) {
        if (!tab || tab.windowId != recorder.win_id)
            return;
        // console.log("onNavigation: %O", details);
        if (details.transitionQualifiers.length &&
            details.transitionQualifiers[0] == "forward_back") {
            // TODO: it appeared too complicated to find out
            // if it was Back or Forward button pressed,
            // so it simply records BACK command
            // anyways, there is no FORWARD command ;)
            recorder.recordAction("BACK");
        } else {
            switch(details.transitionType) {
            case "typed": case "auto_bookmark":
                recorder.recordAction("URL GOTO="+tab.url);
                break;
            case "link": case "generated":
                if (details.transitionQualifiers.length &&
                    details.transitionQualifiers[0] == "from_address_bar") {
                    recorder.recordAction("URL GOTO="+tab.url);
                }
                break;
            case "reload":
                recorder.recordAction("REFRESH");
                break;
            }
        }
    });
};


// Recorder.prototype.attachDebugger = function(tab_id) {
//     return new Promise(function(resolve, reject) {
//         chrome.debugger.attach({tabId: tab_id}, "1.1", function() {
//             if (chrome.runtime.lastError)
//                 reject(chrome.runtime.lastError);
//             else
//                 resolve();
//         });
//     });
// };

// Recorder.prototype.detachDebugger = function(tab_id) {
//     return new Promise(function(resolve, reject) {
//         chrome.debugger.detach({tabId: tab_id}, function() {
//             if (chrome.runtime.lastError)
//                 reject(chrome.runtime.lastError);
//             else
//                 resolve();
//         });
//     });
// };

// Recorder.prototype.onDebuggerDetached = function(source, reason) {
//     console.log("onDebuggerDetached, debugee %O, reason %O", source, reason);
// };

// Recorder.prototype.onDebugProtoEvent = function(source, message, params) {
//     console.log("onDebugProtoEvent, debugee %O, message %O, params %O",
//                 source, message, params);
// };

// network events
Recorder.prototype.onAuthRequired = function(details, callback) {
    // console.log("onAuthRequired: %O", details);

    // password encryption

    var enc = {};

    var typ = Storage.getChar("encryption-type");
    if (!typ.length)
        typ = "no";

    switch(typ) {
    case "no":
        enc.encrypt = false;
        if (this.writeEncryptionType) {
            this.writeEncryptionType = false;
            this.recordAction("SET !ENCRYPTION NO");
        }
        break;
    case "stored":      // get password from storage
        enc.encrypt = true;
        if (this.writeEncryptionType) {
            this.writeEncryptionType = false;
            this.recordAction("SET !ENCRYPTION STOREDKEY");
        }
        var pwd = Storage.getChar("stored-password");
        // stored password is base64 encoded
        pwd = decodeURIComponent(atob(pwd));
        enc.key = pwd;
        break;
    case "tmpkey":
        enc.encrypt = true;
        if (this.writeEncryptionType) {
            this.writeEncryptionType = false;
            this.recordAction("SET !ENCRYPTION TMPKEY");
        }

        if (!Rijndael.tempPassword) {    // ask password now
            var features = "titlebar=no,menubar=no,location=no,"+
                "resizable=yes,scrollbars=no,status=no,"+
                "width=350,height=170";
            var win = window.open("passwordDialog.html",
                                  "iMacros Password Dialog" , features);
            win.args = {
                shouldProceed: true,
                type: "loginDialog",
                // CHEAT: passwordDialog will call auth callback
                // with false user/pwd pair so next time onAuthRequired
                // will have temp password
                callback: callback
            };
            return;
        } else {
            enc.key = Rijndael.tempPassword;
        }
        break;
    }

    var features = "titlebar=no,menubar=no,location=no,"+
        "resizable=yes,scrollbars=no,status=no,"+
        "width=350,height=170";
    var win = window.open("loginDialog.html",
                          "iMacros Login Dialog" , features);
    win.args = {
        cypherData: enc,
        details: details,
        callback: callback,
        recorder: this
    };
};


// Recorder.prototype.onBeforeRequest = function(details) {
//     console.log("onBeforeReqeust: %O", details);
// };

// Recorder.prototype.onBeforeRedirect = function(details) {
//     console.log("onBeforeRedirect: %O", details);
// };


// Recorder.prototype.onBeforeSendHeaders = function(details) {
//     console.log("onBeforeSendHeaders: %O", details);
// };

// Recorder.prototype.onReqCompleted = function(details) {
//     console.log("onReqCompleted: %O", details);
// };

// Recorder.prototype.onErrorOccurred = function(details) {
//     console.log("onErrorOccured: %O", details);
// };

// Recorder.prototype.onHeadersReceived = function(details) {
//     console.log("onHeadersReceived: %O", details);
// };

// Recorder.prototype.onResponseStarted = function(details) {
//     console.log("onResponseStarted: O", details);
// };

Recorder.prototype.onSendHeaders = function(details) {
    // console.log("onSendHeaders: %O", details);
};



Recorder.prototype.addListeners = function() {
    // add listeners
    chrome.tabs.onActivated.addListener(this.onActivated);
    chrome.tabs.onCreated.addListener(this.onCreated);
    // chrome.tabs.onUpdated.addListener(this.onUpdated);
    chrome.tabs.onRemoved.addListener(this.onRemoved);
    chrome.tabs.onMoved.addListener(this.onMoved);
    chrome.tabs.onAttached.addListener(this.onAttached);
    chrome.tabs.onDetached.addListener(this.onDetached);
    chrome.downloads.onCreated.addListener(this._onDownloadCreated);
    chrome.contextMenus.onClicked.addListener(this._onContextMenu);
    const cm_title = "Automate Save As command";
    this.cm_id = chrome.contextMenus.create(
        {title: cm_title, contexts: ["link", "audio", "video", "image"]}
    );

    // network events
    chrome.webNavigation.onCommitted.addListener(this.onCommitted);
    chrome.webRequest.onAuthRequired.addListener(
        this.onAuth,
        {windowId: this.win_id, urls: ["<all_urls>"]},
        ["asyncBlocking"]
    );
    // chrome.webRequest.onBeforeRequest.addListener(
    //     this.onRequest,
    //     {windowId: this.win_id, urls: ["<all_urls>"]}
    // );
    // chrome.webRequest.onBeforeRedirect.addListener(
    //     this.onRedirect,
    //     {windowId: this.win_id, urls: ["<all_urls>"]},
    //     ["responseHeaders"]
    // );
    // chrome.webRequest.onBeforeSendHeaders.addListener(
    //     this.onSendHeaders,
    //     {windowId: this.win_id, urls: ["<all_urls>"]},
    //     ["requestHeaders"]
    // );
    // chrome.webRequest.onCompleted.addListener(
    //     this.onCompleted,
    //     {windowId: this.win_id, urls: ["<all_urls>"]},
    //     ["responseHeaders"]
    // );
    // chrome.webRequest.onErrorOccurred.addListener(
    //     this.onReqError,
    //     {windowId: this.win_id, urls: ["<all_urls>"]}
    // );
    // chrome.webRequest.onHeadersReceived.addListener(
    //     this.onHeaders,
    //     {windowId: this.win_id, urls: ["<all_urls>"]},
    //     ["responseHeaders"]
    // );
    // chrome.webRequest.onResponseStarted.addListener(
    //     this.onResponse,
    //     {windowId: this.win_id, urls: ["<all_urls>"]},
    //     ["responseHeaders"]
    // );
    // chrome.webRequest.onSendHeaders.addListener(
    //     this.onSend,
    //     {windowId: this.win_id, urls: ["<all_urls>"]},
    //     ["requestHeaders"]
    // );

    // Debugger protocol events
    // chrome.debugger.onEvent.addListener(this.onEvent);
    // chrome.debugger.onDetach.addListener(this.onDetach);
    // this.attachDebugger(this.tab_id).then(function() {
    //     console.log("debugger attached");
    // }).catch(console.error.bind(console));
};

// remove recording listeners
Recorder.prototype.removeListeners = function() {
    chrome.tabs.onActivated.removeListener(this.onActivated);
    chrome.tabs.onCreated.removeListener(this.onCreated);
    // chrome.tabs.onUpdated.removeListener(this.onUpdated);
    chrome.tabs.onRemoved.removeListener(this.onRemoved);
    chrome.tabs.onMoved.removeListener(this.onMoved);
    chrome.tabs.onAttached.removeListener(this.onAttached);
    chrome.tabs.onDetached.removeListener(this.onDetached);
    chrome.webNavigation.onCommitted.removeListener(this.onCommitted);
    chrome.downloads.onCreated.removeListener(this._onDownloadCreated);
    chrome.contextMenus.onClicked.removeListener(this._onContextMenu);
    chrome.contextMenus.remove(this.cm_id);
    // network events
    chrome.webRequest.onAuthRequired.removeListener(this.onAuth);
    // chrome.webRequest.onBeforeRequest.removeListener(this.onRequest);
    // chrome.webRequest.onBeforeRedirect.removeListener(this.onRedirect);
    // chrome.webRequest.onBeforeSendHeaders.removeListener(this.onSendHeaders);
    // chrome.webRequest.onCompleted.removeListener(this.onCompleted);
    // chrome.webRequest.onErrorOccurred.removeListener(this.onReqError);
    // chrome.webRequest.onHeadersReceived.removeListener(this.onHeaders);
    // chrome.webRequest.onResponseStarted.removeListener(this.onResponse);
    // chrome.webRequest.onSendHeaders.removeListener(this.onSend);

    // Debugger protocol events
    // chrome.debugger.onEvent.removeListener(this.onEvent);
    // chrome.debugger.onDetach.removeListener(this.onDetach);
    // this.detachDebugger(this.tab_id).catch(console.error.bind(console));
};



======================================================================
FILE PATH: nm_connector.js
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/


var nm_connector = {

    onInit: function(clientId, args) {
        if (clientId in this.clients) {
            this.sendResponse(clientId,
                              "Can not create new instance. Error: "+
                              "already inited (maybe two iimInit() calls?",
                              -20);
            return;
        }

		function attach(win) {
			cacheClient(win);
			// Open panel if necessary
			if (!args.options || !/-simpleui/i.test(args.options)) {
				openPanel(win.id);
			}
		}

		function cacheClient(win) {
			nm_connector.clients[clientId] = {win_id: win.id};
			nm_connector.sendResponse(clientId, "OK", 1);
		}

		function openNewBrowser() {
			chrome.windows.create({url: "about:blank"}, attach);
		}

		if (args.launched) {
			// reuse the current window
			chrome.windows.getCurrent(attach);
		}
		else if (args.openNewBrowser) {
				openNewBrowser();
        } else {            // reuse any of the "free" existing window
            chrome.windows.getAll({windowTypes: ['normal']}, function(windows) {
                var i, j, saved = false;
                for (i = 0; i < windows.length; i++) {
                    var win = windows[i], found = false;
                    for (j in nm_connector.clients) {
                        if (nm_connector.clients[j].win_id == win.id) {
                            found = true; break;
                        }
                    }
                    if (!found) { // if win.id is not among windows in use
                        attach(win);
                        saved = true; break;
                    }
                }
                if (!saved) {   // if all the windows are in use
                    // then create new window
					openNewBrowser();
                }
            });
        }
    },


    onCapture: function(clientId, args) {
        var win_id = nm_connector.clients[clientId].win_id;
        var type;
        if (/^.*\.(\w+)$/.test(args.path)) {
            if (RegExp.$1 == "jpg") {
                type = "jpeg";
            } else if (RegExp.$1 == "png") {
                type = "png";
            } else {
                nm_connector.sendResponse(clientId,
                                          "Unsupported type "+RegExp.$1, -1);
                return;
            }
        } else {
            // if no file extension is set than assume "png"
            type = "png";
            args.path += ".png";
        }

        afio.isInstalled().then(function(installed) {
            if (!installed) {
                nm_connector.sendResponse(
                    clientId,
                    "Can not instantiate file IO plugin", -1
                );
                return;
            }
            var f = null;
            if (__is_full_path(args.path)) {
                f = afio.openNode(args.path);
            } else {
                 // do not allow references to upper directories
                args.path = args.path.replace("..", "_");
                f = afio.openNode(localStorage["defdownpath"]);
                f.append(args.path);
            }
            chrome.tabs.captureVisibleTab(
                nm_connector.win_id, {format: type},
                function(data) {
                    var re = /data\:([\w-]+\/[\w-]+)?(?:;(base64))?,(.+)/;
                    var m = re.exec(data);
                    var imageData = {
                        image: m[3],
                        encoding: m[2],
                        mimeType: m[1]
                    };
                    afio.writeImageToFile(f, imageData).then(function() {
                        nm_connector.sendResponse(clientId, "OK", 1);
                    }, function(err) {
                        nm_connector.sendResponse(
                            clientId,
                            "Could not write to "+f.path, -2
                        );
                    });
                }
            );
        });

    },


    onPlay: function(clientId, args) {
        var x, win_id = this.clients[clientId].win_id;

        for (x in args.vars) { // save user vars if any
            context[win_id].mplayer.setUserVar(x, args.vars[x]);
        }

        if (args.use_profiler) {
            context[win_id].mplayer.profiler.si_enabled = true;
        }

        if (/^CODE:((?:\n|.)+)$/.test(args.source)) { // if macro is embedded
            var val = RegExp.$1;
            val = val.replace(/\[sp\]/ig, ' ');
            val = val.replace(/\[br\]/ig, '\n');
            val = val.replace(/\[lf\]/ig, '\r');
            //play macro
            getLimits().then(
                limits => context[win_id].mplayer.play(
                    {
                        name: "__noname__.iim",
                        file_id: "",
                        source: val,
                        client_id: clientId
                    },
                    limits
                )
            )
            return;
        }

        // try to load macro from file otherwise
        var name = args.source;
        if (!isMacroFile(name))
            name += ".iim";

        var file;
        if (__is_full_path(name)) {
            // full path is given
            file = afio.openNode(name);
        } else  {
            file = afio.openNode(localStorage["defsavepath"]);
            var nodes = name.split(__psep()).reverse();
            while (nodes.length)
                file.append(nodes.pop());
        }

        file.exists().then(function(exists) {
            if (!exists) {
                nm_connector.sendResponse(
                    clientId, "Can not open macro "+name, -931);
                return;
            }
            afio.readTextFile(file).then(function(val) {
                getLimits().then(
                    limits => context[win_id].mplayer.play(
                        {
                            name: file.leafName,
                            file_id: file.path,
                            source: val,
                            client_id: clientId
                        },
                        limits
                    )
                )
            }, function(e) {
                nm_connector.sendResponse(
                    clientId, "Can not read macro, error "+e.message, -931);
                return;
            });
        }, function(err) {
            nm_connector.sendResponse(
                clientId, "Can not open macro, error "+err.message, -931);
            return;
        });

    },


    handleCommand: function(clientId, cmd) {
        try {
            // console.debug("handleCommand %s for clientId %d", cmd, clientId);
            var request = JSON.parse(cmd);
        } catch(e) {
            console.error(e);
            // should never happen
            this.sendResponse(clientId,
                              "Can not parse request \""+cmd+"\"", -1);
            return;
        }

        switch (request.type) {
        case "init":
            this.onInit(clientId, request.args);
            break;

        case "play":
            this.onPlay(clientId, request.args);
            break;

		case "disconnect":
				delete this.clients[clientId];
				this.sendResponse(clientId, "OK", 1);
				break;

        case "exit":
            var win_id = this.clients[clientId].win_id;
            chrome.windows.getAll(null, function(windows) {
                if (windows.length == 1) {
                    // TODO: there should be a way to find out the pid
                    // There is chrome.procesess in the Chrome dev branch
                    // but it is not known when it moves to stable,
                    // so we try a workaround for now
                    var pid = -1;
                    nm_connector.sendResponse(clientId, "OK", 1,
                                             {waitForProcessId: pid});
                } else {
                    nm_connector.sendResponse(clientId, "OK", 1);
                }

                chrome.windows.remove(win_id, function() {
                    delete nm_connector.clients[clientId];
                });
            });

            break;

        case "show":
            var win_id = this.clients[clientId].win_id;
            var args = {
                message: request.args.message,
                errorCode: 1,
                win_id: win_id,
                macro: null
            };

            showInfo(args);
            this.sendResponse(clientId, "OK", 1);

            break;

        case "capture":
            this.onCapture(clientId, request.args);
            break;
        case "error":
            console.error("Got error from iMacros host: "+request.message);
            break;

        case "info":
            console.info("Got message from iMacros host: "+request.message);
            break;
        }
    },


    startServer: function(args) {
        const si_host = "com.ipswitch.imacros.host";
        this.clients = new Object();
        this.port = chrome.runtime.connectNative(si_host);
        this.port.onMessage.addListener(function(msg) {
            if (chrome.runtime.lastError) {
                console.error(chrome.runtime.lastError);
            } else {
                setTimeout(function() {
                    nm_connector.handleCommand(msg.clientId, msg.request);
                }, 0);
            }
        });
        var init_msg = {type: 'init'};
        if (args)
            init_msg.ac_pipe = args;
        this.port.postMessage(init_msg);
    },

    stopServer: function() {
        if (this.port)
            this.port.disconnect();
    },


    sendResponse: function(clientId, message, errorCode, extra) {
        if (errorCode < 0 && !/error/i.test(message)) {
            message = "Error: "+message;
        }
        message += " ("+errorCode+")";

        var result = {
            status: message,
            errorCode: errorCode
        };

        if (extra) {
            if (extra.extractData)
                result.extractData = extra.extractData.split("[EXTRACT]");
            if (extra.lastPerformance)
                result.lastPerformance = extra.lastPerformance;
            if (extra.waitForProcessId)
                result.waitForProcessId = extra.waitForProcessId;
            if (extra.profilerData)
                result.profilerData = extra.profilerData;
        }

        // console.debug("Sending response %s for clientId %d",
        //               JSON.stringify(result), clientId);
        this.port.postMessage({type: "command_result",
                               clientId: clientId,
                               result: JSON.stringify(result)});
    }
};



======================================================================
FILE PATH: options.html
======================================================================
<html>
<head>
 <meta charset="UTF-8">
<title>iMacros の設定</title></head>
  <script src="utils.js"> </script>
  <script src="vendor/jQuery/jquery-2.2.1.min.js"></script>
  <script src="vendor/jQueryUI/jquery-ui.min.js"></script>
  <script src="options.js"> </script>
  <link rel="stylesheet" type="text/css" href="skin/common.css" />
  <link rel="stylesheet" type="text/css" href="skin/options.css" />
  <link rel="stylesheet" type="text/css" href="vendor/jQueryUI/jquery-ui.min.css"/>
  <body>
    <span id="title">iMacros の設定</span>
    <div id="file-access-note">
        <p id="note-header"></p>
        <ul id="note-list"></ul>
    </div>
    <div id="common" class="settings-container">
      <span class="header">一般設定</span>
      <div id="dock-panel-box">
        <input id="dock-panel" type="checkbox"></input>
        <span>iMacros パネルをブラウザ ウィンドウにドッキングする</span>
      </div>
      <div id="before-play-box">
        <input id="show-before-play-dialog" type="checkbox"></input>
        <span> ブックマークの編集ダイアログを表示
          <span id="more-info-bp" class="a-link"> (More Info) </span>
        </span>
      </div>
      <div id="profiler-enabled-box">
        <input id="enable-profiler" type="checkbox"></input>
        <span>プロファイルマクロのパフォーマンス
          <span id="more-info-profiler" class="a-link"> (More Info) </span>
        </span>
      </div>
    </div>

    <div id="recorder" class="settings-container">
      <span class="header">レコーダーの設定</span>
      <div id="record-mode-box">
        <span>録画モード:</span>
        <div id="recording-modes">
          <input type="radio" name="recording-mode" id="record-mode-conventional">
          <label for-"record-mode-auto">従来の録画モード</label>
        </div>
        <div>
          <input type="radio" name="recording-mode" id="record-mode-event">
          <label for-"record-mode-event">イベント記録モード<span id="more-info-event" class="a-link"> (More Info) </span></label>
        </div>
      </div>
      <div id="favorid-panel-box">
        <p/>
        <div style="width: 70%;">一部の Web ページでは、動的に生成された ID を使用します。 記録に問題がある場合は、下のチェックボックスをオフにします。 従来の記録モードの場合、このボックスのチェックを外すと、完全な HTML タグの使用が強制されます。
        </div>
        <input id="favorid-panel" type="checkbox"></input>
        <label for="favorid-panel">可能な限り要素 ID を使用する</label>
      </div>
      <div id="css-selectors-box">
        <p/>
        <div style="width: 70%;">CSS セレクターを使用してタグを選択する
        </div>
        <input id="css-selectors" type="checkbox"></input>
        <label for="css-selectors">CSSセレクターを使用する</label>
      </div>
    </div>

    <div id="player" class="settings-container">
      <span class="header">プレーヤーの設定</span>
      <div id="replay-speed-box">
        <span>再生速度:</span>
        <div>
          <input type="radio" name="replay-speed" id="replay-speed-fast">
          <label for-"replay-speed-fast">Fast</label>
          <input type="radio" name="replay-speed" id="replay-speed-medium">
          <label for-"replay-speed-medium">Medium</label>
          <input type="radio" name="replay-speed" id="replay-speed-slow">
          <label for-"replay-speed-slow">Slow</label>
        </div>
      </div>
    </div>

    <div id="path-settings" class="settings-container">
      <span class="header">パスの設定</span>
      <div>
        <div class="vbox">
          <span> マクロのディレクトリパス: </span>
            <div class="hbox">
              <div>
                <input id="defsavepath" class="path-field" type="text"> </input>
              </div>
              <div id="defsavepath-browse" class="button browse-button"></div>
            </div>
        </div>
      </div>
      <div>
        <div class="vbox">
          <span> データソースのディレクトリパス: </span>
          <div class="hbox">
            <div>
              <input id="defdatapath" class="path-field" type="text"></input>
            </div>
            <div id="defdatapath-browse" class="button browse-button"></div>
          </div>
        </div>
      </div>
      <div>
        <div class="vbox">
          <span> ダウンロードディレクトリのパス: </span>
          <div class="hbox">
            <div>
              <input id="defdownpath" class="path-field" type="text"></input>
            </div>
            <div id="defdownpath-browse" class="button browse-button"></div>
          </div>
        </div>
      </div>
      <!-- TODO: logpath は、たとえば次のルート ディレクトリとして使用されます。 Profiler.xsl ファイル
            ストレージなので、そのディレクトリに何らかの名前を付ける必要があります -->
      <!-- <div> -->
      <!--   <div class="vbox"> -->
      <!--     <span> ログディレクトリのパス: </span> -->
      <!--     <div class="hbox"> -->
      <!--       <input id="deflogpath" class="path-field" type="text"></input> -->
      <!--       <div id="deflogpath-browse" class="button browse-button"></div> -->
      <!--     </div> -->
      <!--   </div> -->
      <!-- </div> -->
    </div>

    <div id="security" class="settings-container">
      <span class="header">Security settings</span>
      <div style="margin-top: 10px">
        &nbsp;マスターパスワードは、保存されているすべての暗号化と復号化に使用されます。
         ウェブサイトのパスワード。 ウェブサイトのパスワードは強力な暗号化方式を使用して暗号化されています
         暗号化され、マクロ テキスト ファイル内に保存されます。
      </div>
      <div id="type_no-box" class="radio-container">
        <input type="radio" id="type_no" name="encryption_type"></input>
        <label for="type_no">パスワードを暗号化しないでください</label>
        <div class="radio-description">
          パスワードはマクロにプレーンテキストとして保存されます。</div>
      </div>
      <div id="type_stored-box" class="radio-container">
        <input type="radio" id="type_stored" name="encryption_type"></input>
        <label for="type_stored">マスターパスワードをここに入力して保存します。</label>
      </div>
      <div id="stored-password-field">
        <label for="stored-password-box">保存されたマスターパスワード:</label>
        <input type="password" name="stored-password-box"
               id="stored-password-box"></input>
      </div>

      <div id="type_tmpkey-box" class="radio-container">
        <input type="radio" id="type_tmpkey" name="encryption_type">
        </input>
        <label for="type_tmpkey">
         一時的なマスターパスワードを保存したくない場合は、ここに入力します。
iMacros を起動して Web サイトのパスワードを初めて使用するときは、毎回再入力する必要があります。 安全性は向上しますが、利便性は低下します。
        </label>

        <div id="temp-password-field" style="margin-top:1em;">
          <label for="temp-password-box">一時的なマスターパスワード:</label>
          <input type="password" name="temp-password-box"
                 id="temp-password-box"/>
        </div>
      </div>

      <div style="margin-top:20px;">
          注: 暗号化は、SET を使用して各マクロで変更することもできます。 SET
	  !ENCRYPTION NO / STOREDKEY / TMPKEY
      </div>
      <div style="margin-top:10px;">
          パスワード文字列を手動で作成または復号化する:
          <span id="password-tool-page" class="a-link"> パスワードツールページ</span>
      </div>
      <div style="margin-top:12px;margin-left:60px;margin-bottom:7px">
	  <span id="more-info-encryption" class="a-link">暗号化に関する詳細情報</span>
      </div>
    </div>
    <span id="license-link" class="a-link">EULA</span>
    <span id="test"></span>
  </body>
</html>



======================================================================
FILE PATH: options.js
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/

"use strict";


function setSecurityLevel() {
    if (!Storage.isSet("encryption-type"))
        Storage.setChar("encryption-type", "no");
    let type = Storage.getChar("encryption-type");
    if (!/^(?:no|stored|tmpkey)$/.test(type))
        type = "no";
    let stored = Storage.getChar("stored-password");
    if (stored) {
        $("#stored-password-box").val(decodeURIComponent(atob(stored)));
    }

    switch(type) {
    case "no":
        $("#type_no").prop("checked", true);
        $("#stored-password-field").hide()
        $("#temp-password-field").hide()
        break;
    case "stored":
        $("#type_stored").prop("checked", true);
        $("#stored-password-field").show()
        $("#temp-password-field").hide()
        break;
    case "tmpkey":
        $("#type_tmpkey").prop("checked", true);
        $("#stored-password-field").hide()
        $("#temp-password-field").show()
        break;
    }
}

function onSecurityChage(e) {
    let type = e.target.id.substring(5)
    switch(type) {
    case "no":
        $("#stored-password-field").hide()
        $("#temp-password-field").hide()
        break;
    case "stored":
        $("#stored-password-field").show()
        $("#temp-password-field").hide()
        $("#stored-password-box").focus()
        $("#stored-password-box").select()
        break;
    case "tmpkey":
        $("#stored-password-field").hide()
        $("#temp-password-field").show()
        $("#temp-password-box").focus()
        $("#temp-password-box").select()
        break;
    }
    Storage.setChar("encryption-type", type)
}

function updatePanelViews() {
    let bg = chrome.extension.getBackgroundPage()
    for (let x in bg.context) { // update all panels
        var panel = bg.context[x].panelWindow;
        if (panel && !panel.closed) {
            let doc = panel.frames["tree-iframe"].contentDocument;
            doc.defaultView.location.reload();
        }
    }
}

function onPathChange(which) {
    Storage.setChar(which, $("#"+which).val());
    if (which == "defsavepath")
        updatePanelViews()

}


function choosePath(which) {
    var features = "titlebar=no,menubar=no,location=no,"+
        "resizable=yes,scrollbars=no,status=no,"+
        "width=200,height=300";
    var win = window.open("browse.html", "iMacros_browse_dialog", features);

    win.args = {path: Storage.getChar(which), which: which};
}

function savePath(which, path) {
    Storage.setChar(which, path);
    $("#"+which).val(path);
    if (which == "defsavepath")
        updatePanelViews()
}


window.addEventListener("load", function () {
    $("#show-before-play-dialog").prop(
        "checked", Storage.getBool("before-play-dialog")
    ).change(function(event) {
        let checked = event.target.checked
        Storage.setBool("before-play-dialog", checked)
    })

    $("#dock-panel").prop(
        "checked", Storage.getBool("dock-panel")
    ).change(function (event) {
        let checked = event.target.checked
        Storage.setBool("dock-panel", checked);
    })

    if (!Storage.getBool("afio-installed")) {
        $("#file-access-note").addClass("settings-container");
        $("<span class='header'>File Access Not Installed</span>").prependTo("#file-access-note");
        $("<span>The File Access for iMacros Extensions module is currently " +
            "not installed. It is not available in the freeware version. " +
            "The following functionality is not available unless you have an iMacros license and " +
            "<span id='customer' class='a-link no-bold-link'>install the File Access</span> module:</span > ").appendTo("#note-header");
        $("<li>Save or play macro (.iim) files (only macros stored as bookmarks can be saved/played) </li>" +
            "<li>Read input from CSV files (!DATASOURCE command)</li> " +
            "<li>Access the file system via the !FOLDER_XXX variables, e.g. !FOLDER_DATASOURCE, !FOLDER_DOWNLOAD etc.</li>" +
            "<li>Save extracted data (SAVEAS and SAVEITEM commands)</li> " +
            "<li>Save screenshots (using the SAVEAS or SCREENSHOT commands)</li> " +
            "<li>Save stopwatch data to a log file via the STOPWATCH command " +
            "(data can be referenced in macro via the !STOPWATCHTIME variable)</li>" +
            "<li>Profile macro performance</li>").appendTo("#note-list");
        $("<span>See </span><span id='features-comparison' class='a-link no-bold-link'>" +
            "the feature comparison chart</span ><span>.</span> ").appendTo("#file-access-note");
        $("#profiler-enabled-box").addClass("disabled");
        $("#enable-profiler").attr("disabled", "disabled");
        $("#path-settings").addClass("disabled");
        $("#defsavepath").prop('disabled', true)
        $("#defdatapath").prop('disabled', true);
        $("#defdownpath").prop('disabled', true); 
        $("#defsavepath-browse").hide();
        $("#defdatapath-browse").hide();
        $("#defdownpath-browse").hide();
    }

    $("#enable-profiler").prop(
        "checked", Storage.getBool("profiler-enabled")
    ).change(function (event) {
        let checked = event.target.checked
        Storage.setBool("profiler-enabled", checked);
    })

    // paths
    $("#defsavepath").val(Storage.getChar("defsavepath"))
        .on("input", onPathChange.bind(null, "defsavepath"))
    $("#defsavepath-browse").click(choosePath.bind(null, "defsavepath"))
    $("#defdatapath").val(Storage.getChar("defdatapath"))
        .on("input", onPathChange.bind(null, "defdatapath"))
    $("#defdatapath-browse").click(choosePath.bind(null, 'defdatapath'))
    $("#defdownpath").val(Storage.getChar("defdownpath"))
        .on("input", onPathChange.bind(null, 'defdownpath'))
    $("#defdownpath-browse").click(choosePath.bind(null, 'defdownpath'))

    // encryption
    setSecurityLevel()
    $("#type_no").change(onSecurityChage);
    $("#type_stored").change(onSecurityChage);
    $("#type_tmpkey").change(onSecurityChage);
    $("#stored-password-box").on("input", function() {
        let pwd = $("#stored-password-box").val();
        pwd = btoa(encodeURIComponent(pwd));
        Storage.setChar("stored-password", pwd);
    })
    $("#temp-password-box").on("input", function() {
        let bg = chrome.extension.getBackgroundPage()
        bg.Rijndael.tempPassword = $("#temp-password-box").val()
    })

    // links
    $("#more-info-bp").click(function() {
        link(getRedirFromString('bookmarklets'));
    });
    $("#more-info-profiler").click(function() {
        link(getRedirectURL('Performance_Profiler'));
    });
    $("#password-tool-page").click(function() {
        link(getRedirectURL(160));
    });
    $("#more-info-encryption").click(function() {
        link(getRedirectURL('!ENCRYPTION'));
    });
    if (!Storage.getBool("afio-installed")) {
        $("#customer").click(function () {
            link(getRedirFromString('install-afio'));
        });
        $("#features-comparison").click(function () {
            link(getRedirFromString('compare-versions'))
        });
    };

    // record modes
    var record_modes = ["conventional", "event"];
    var record_radio = $("#record-mode-"+Storage.getChar("record-mode"));
    if (!record_radio) {
        alert("Unknown record mode type: "+Storage.getChar("record-mode"))
    } else {
        record_radio.prop("checked", true)
        for (let r of record_modes) {
            $("#record-mode-"+r).change(function(e) {
                Storage.setChar("record-mode", e.target.id.substring(12))
            });
        }
    }

    // replay speed
    let delay = Storage.getNumber("replaying-delay")
    let delay_types = [
        ["fast", x => x <= 100 || isNaN(x), 0],
        ["medium", x => x <= 1000 && x > 100, 800],
        ["slow", x => x > 1000, 2000]
    ]
    for (let [n, p, x] of delay_types) {
        $("#replay-speed-"+n).prop("checked", p(delay))
        $("#replay-speed-"+n).change(
            e => Storage.setNumber("replaying-delay", x)
        )
    }

    $("#more-info-event").click(function() {
        link(getRedirectURL("EVENT"))
    })
    $("#license-link").click(function() {
        link(getRedirFromString("EULA_Freeware"))
    })
    $("#favorid-panel").prop(
        "checked", Storage.getBool("recording-prefer-id")
    ).change(function(e) {
        Storage.setBool("recording-prefer-id", e.target.checked)
    })

    $("#css-selectors").prop(
        "checked", Storage.getBool("recording-prefer-css-selectors")
    ).change(function(e) {
        Storage.setBool("recording-prefer-css-selectors", e.target.checked)
    })
});



======================================================================
FILE PATH: panel.html
======================================================================
<html>
  <head>
    <title>iMacros</title>
    <link rel="stylesheet" type="text/css" href="skin/common.css" />
    <link rel="stylesheet" type="text/css" href="skin/panel.css" />
    <link rel="stylesheet" type="text/css" href="skin/imicons/styles.css" />
    <script src="utils.js" > </script>
    <script src="panel.js"> </script>
    <script src="SOAPClient.js"> </script>
    <script src="AsyncFileIO.js"> </script>
  </head>
  <body>

    <div id="mole" class="vbox">

      <div id="view" class="vbox centered">
        <div id="tree-switcher-box" class="hbox">
          <!-- <span>Macro Storage:</span> -->
          <input id="radio-files-tree" class="tab"
                 checked="yes"
                 type="radio" name="tree-view"></input>
          <input id="radio-bookmarks-tree" class="tab"
                 type="radio" name="tree-view"></input>
          <label for="radio-files-tree"
                 id="radio-files-tree-label"
                 class="tab-label" >Files</label>
          <label for="radio-bookmarks-tree"
                 id="radio-bookmarks-tree-label"
                 class="tab-label">Bookmarks</label>
        </div>
        <div class="box" id="tree-view" >
          <iframe id="tree-iframe" src="fileView.html"></iframe>
        </div>
        <div class="box" id="macro-view" hidden="true">
          <iframe id="macro-iframe" src="macroView.html"></iframe>
        </div>
      </div>


      <div id="tabs-container" class="vbox">
        <input id="play-tab" class="tab" type="radio"
               name="main-tabs" checked="checked" />
	<input id="record-tab" class="tab" type="radio"
               name="main-tabs" />
	<input id="manage-tab" class="tab" type="radio"
	       name="main-tabs" />

        <div class="hbox">
          <label for="play-tab" id="play-tab-label"
                 class="tab-label">Play</label>
	  <label for="record-tab" id="record-tab-label"
                 class="tab-label">Record</label>
	  <label for="manage-tab" id="manage-tab-label"
                 class="tab-label">Manage</label>
        </div>

	<div id="tabs-content">
          <div id="play-tab-content" >
            <div class="vbox">

              <div id="play-button" class="button"
                   title="Play selected macro">
                <span>Play Macro</span>
              </div>
              <div id="pause-button" class="button" collapsed="true"
                   title="Pause replaying">
                <span>Pause</span>
              </div>
              <div id="stop-replaying-button" class="button" disabled="true"
                   title="Stop replaying">
                <span>Stop</span>
              </div>

              <div id="loop-box" class="vbox">
                <div class="hbox centered">
                  <span>Play macro repeatedly:</span>
                </div>
                <div class="hbox centered">
                  <div class="hbox" style="font-size:10px; padding: 5px;">
                    Current:
                    <input id="current-loop" class="loop-value"
                           type="number"
                           min="1"
                           value="1"/>
                    Max:
                    <input id="max-loop" class="loop-value"
                           type="number"
                           min="1"
                           value="3"/>
                  </div>
                </div>
              </div>
              <div id="loop-button" class="button"
                   title="Play macro repeatedly">
                <span>Play Loop</span>
              </div>

            </div>
          </div> <!-- play-tab-content -->

          <div id="record-tab-content">
            <div class="vbox">
              <div id="record-button" class="button"
                   title="Start macro recording">
                <span>Record Macro</span>
              </div>
              <div id="stop-recording-button" class="button" disabled="true"
                   title="Stop recording">
                <span>Stop</span>
              </div>
              <div id="saveas-button" class="button" disabled="true"
                   title="Make web-page archive">
                <span>Save Page</span>
              </div>
              <div id="capture-button" class="button" disabled="true"
                   title="Take screenshot of web-page">
                <span>Take Screenshot</span>
              </div>

            </div>
          </div>

          <div id="manage-tab-content">
            <div class="vbox">

              <div id="edit-button" class="button"
                   title="Edit selected macro">
                <span>Edit Macro</span>
              </div>

              <div id="settings-button" class="button"
                   title="Open settings page">
                <span>Settings</span>
              </div>
              <div id="help-button" class="button">
                <span>Help</span>
              </div>
            </div>
          </div>
        </div>

      </div> <!-- tabs-container -->

      <div id="logo-or-info" class="centered hbox">
        <div id="logo-and-links" class="centered box">
          <div>
            <div id="links" class="box centered">
                <a href="#" id="ad-link"></a>
              <!--
              <div class="panel-link-div">
                <span id="home-link" class="a-link panel-link"> Home </span>
              </div>
              <div class="panel-link-div">
                <span id="wiki-link" class="a-link panel-link"> Wiki </span>
              </div>
              <div class="panel-link-div">
                <span id="forum-link" class="a-link panel-link"> Forum </span>
              </div>
              -->
            </div>
            <div id="logo-image" class="box">
              <a href="#" id="ad-image-link">
                <img src="#" id="ad-image"/>
              </a>
              <!--<img src="skin/logo128.png" style="width:70px;height:70px;"/>-->
            </div>

          </div>
        </div> <!-- logo and links -->

        <div id="info-div" class="vbox" hidden="true">
          <textarea id="info-area" class="box"></textarea>
          <!-- <div id="info-area" class="box"></div> -->
          <div id="info-buttons-container" class="centered hbox">
            <div id="info-edit-button"
                 class="button info-buttons"
                 title="Edit macro"
                 ></div>
            <div id="info-help-button"
                 class="button info-buttons"
                 title="More info"
                 ></div>
            <div id="info-close-button"
                 class="button info-buttons"
                 title="Close"
                 ></div>
          </div>
        </div>
      </div> <!-- logo or info display -->

    </div> <!-- mole -->

  </body>
</html>



======================================================================
FILE PATH: panel.js
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/


function __play(callback) {
    var win_id = args.win_id;
    var bg = chrome.extension.getBackgroundPage();
    var mplayer = bg.context[win_id].mplayer;
    var doc = window.frames["tree-iframe"].contentDocument;
    var container = doc.getElementById("imacros-macro-container");
    var div = doc.getElementById("imacros-bookmark-div");
    var macro = {};
    if (mplayer.paused || mplayer.pauseIsPending) {
        mplayer.unpause();
        return;
    }

    if (div.hasAttribute("file_id")) {
        var node = afio.openNode(div.getAttribute("file_id"));
        macro.file_id = node.path;
        afio.readTextFile(node).then(function(source) {
            macro.source = source;
            macro.name = div.getAttribute("name");
            bg.getLimits().then(limits => mplayer.play(macro, limits, callback))
        }, function(err) {
            // TODO: it would be better to display the error
            // on the info area of the panel
            console.error(err);
            alert("Can not read macro file, error "+err);
        });
    } else if (div.hasAttribute("bookmark_id")) {
        macro.source = container.value;
        macro.bookmark_id = div.getAttribute("bookmark_id");
        macro.name = div.getAttribute("name");
        bg.getLimits().then(limits => mplayer.play(macro, limits, callback))
    }
}

// play-button click handler
function play() {
    if (document.getElementById("play-button").getAttribute("disabled") == "true")
        return;
    __play(false);
}

function playLoop() {
    if (document.getElementById("loop-button").getAttribute("disabled") == "true")
        return;
    var cur = parseInt(document.getElementById("current-loop").value);
    var max = parseInt(document.getElementById("max-loop").value);
    if (cur > max) {
        alert("Current loop value should be less or equivalent max loop value");
        return;
    }

    var win_id = args.win_id;
    var bg = chrome.extension.getBackgroundPage();
    var mplayer = bg.context[win_id].mplayer;
    var doc = window.frames["tree-iframe"].contentDocument;
    var container = doc.getElementById("imacros-macro-container");
    var div = doc.getElementById("imacros-bookmark-div");
    var macro = {
        name: div.getAttribute("name"),
        times: max,
        startLoop: cur
    };

    if (div.hasAttribute("file_id")) {
        var node = afio.openNode(div.getAttribute("file_id"));
        macro.file_id = div.getAttribute("file_id");
        afio.readTextFile(node).then(function(source, err) {
            macro.source = source;
            bg.getLimits().then(limits => mplayer.play(macro, limits))
        }, function(err) {
            console.error(err);
            alert("Can not open "+container.value+
                  ", reason: "+err);
        });
    } else if (div.hasAttribute("bookmark_id")) {
        macro.source = container.value;
        bg.getLimits().then(limits => mplayer.play(macro, limits))
    }
}

// Pause button handler
function pause() {
    if (document.getElementById("pause-button").getAttribute("disabled") == "true")
        return;
    try {
        var win_id = args.win_id;
        var bg = chrome.extension.getBackgroundPage();
        var mplayer = bg.context[win_id].mplayer;
        if (mplayer.playing) {
            mplayer.pause();
        }
    } catch (e) {
        console.error(e);
    }
}

// Edit button handler
function edit() {
    if (document.getElementById("edit-button").getAttribute("disabled") == "true")
        return;
    var bg = chrome.extension.getBackgroundPage();
    var doc = window.frames["tree-iframe"].contentDocument;
    var container = doc.getElementById("imacros-macro-container");
    var div = doc.getElementById("imacros-bookmark-div");
    var source = "", name = div.getAttribute("name");
    var macro = {name: name, win_id: args.win_id};

    if (div.hasAttribute("file_id")) {
        var file_id = div.getAttribute("file_id");
        var node = afio.openNode(file_id);
        afio.readTextFile(node).then(function(source) {
            macro.source = source;
            macro.file_id = file_id;
            bg.edit(macro, true);
        }, function(e) {
            console.error(e);
            alert("Can not open "+container.value+
                  ", reason: "+e);
        });
    } else if (div.hasAttribute("bookmark_id")) {
        source = container.value;
        var bookmark_id = div.getAttribute("bookmark_id");
        macro.source = source;
        macro.bookmark_id = bookmark_id;
        bg.edit(macro, true);
    }
}


// Record button handler
function record() {
    if (document.getElementById("record-button").getAttribute("disabled") == "true")
        return;
    var win_id = args.win_id;
    var bg = chrome.extension.getBackgroundPage();
    var recorder = bg.context[win_id].recorder;
    try {
        recorder.start();
    } catch (e) {
        console.error(e);
    }
}

// Stop button handler
function stop() {
    var win_id = args.win_id;
    var bg = chrome.extension.getBackgroundPage();

    var mplayer = bg.context[win_id].mplayer;
    var recorder = bg.context[win_id].recorder;

    if (mplayer.playing) {
        mplayer.stop();
    } else if (recorder.recording) {
        recorder.stop();
        var recorded_macro = recorder.actions.join("\n");

        var macro = {source: recorded_macro, win_id: win_id,
                     name: "#Current.iim"};

        if (Storage.getChar("tree-type") == "files") {
            afio.isInstalled().then(function(installed) {
                if (installed) {
                    var node = afio.openNode(localStorage["defsavepath"]);
                    node.append("#Current.iim");
                    macro.file_id = node.path;
                    bg.edit(macro, /* overwrite */ true);
                } else {            // no file access
                    bg.edit(macro, true);
                }
            }).catch(console.error.bind(console));
        } else {
            bg.edit(macro, true);
        }
    }
}


// called when a macro is selected in tree-view
function onSelectionChanged(selected) {
    var disable = function (btns) {
        for (var x = 0; x < arguments.length; x++) {
            var b = document.getElementById(arguments[x]+"-button");
            b.setAttribute("disabled", "true");
        }
    };
    var enable = function (btns) {
        for (var x = 0; x < arguments.length; x++) {
            var b = document.getElementById(arguments[x]+"-button");
            b.setAttribute("disabled", "false");
        }
    };

    // change 'disabled' status of buttons
    if (selected) {
        enable("play", "loop", "edit");
    } else {
        disable("play", "loop", "edit");
    }
}


function updatePanel(state) {
    var show = function (btns) {
        for (var x = 0; x < arguments.length; x++) {
            document.getElementById(arguments[x]+"-button").setAttribute("collapsed", "false");
        }
    };
    var hide = function (btns) {
        for (var x = 0; x < arguments.length; x++) {
            document.getElementById(arguments[x]+"-button").setAttribute("collapsed", "true");
        }
    };
    var hideInfo = function() {
        document.getElementById("info-div").setAttribute("hidden", "true");
        document.getElementById("logo-and-links").removeAttribute("hidden");
    };
    var disable = function (btns) {
        for (var x = 0; x < arguments.length; x++) {
            var b = document.getElementById(arguments[x]+"-button");
            b.setAttribute("disabled", "true");
        }
    };
    var enable = function (btns) {
        for (var x = 0; x < arguments.length; x++) {
            var b = document.getElementById(arguments[x]+"-button");
            b.setAttribute("disabled", "false");
        }
    };
    switch(state) {
    case "playing":
        show("pause");
        hide("play");
        enable("stop-replaying");
        disable("loop", "record", "stop-recording", "saveas", "capture", "edit");
        hideInfo();
        break;
    case "paused":
        show("play");
        hide("pause");
        break;
    case "recording":
        enable("stop-recording", "saveas", "capture");
        disable("play", "loop", "record", "edit");
        hideInfo();
        break;
    case "idle":
        show("play");
        hide("pause");
        enable("play", "loop", "record", "edit");
        disable("stop-recording", "stop-replaying", "saveas", "capture");
        break;
    }

}


function onTreeSelect(type) {
    Storage.setChar("tree-type", type);
    var tree_iframe = document.getElementById("tree-iframe");
    if (type == "files") {
        document.getElementById("radio-files-tree").checked="yes";
        tree_iframe.src = "fileView.html";
    } else if (type == "bookmarks") {
        tree_iframe.src = "treeView.html";
        document.getElementById("radio-bookmarks-tree").checked="yes";
    }
}


window.addEventListener("load", function() {
    var bg = chrome.extension.getBackgroundPage();
    args = {win_id: bg.onPanelLoaded(window)};
    var tree_type = Storage.isSet("tree-type") ?
        Storage.getChar("tree-type") : "files";
    afio.isInstalled().then(function(installed) {
        if (!/^(?:files|bookmarks)$/.test(tree_type)) {
            tree_type = installed ? "files" : "bookmarks"
        }
        if (tree_type == "files" && installed) {
            onTreeSelect("files");
        } else {
            onTreeSelect("bookmarks");
        }
    }).catch(console.error.bind(console));
    // attach various event handlers
    document.getElementById("play-button").addEventListener("click", play);
    document.getElementById("pause-button").addEventListener("click", pause);
    document.getElementById("record-button").addEventListener("click", record);
    document.getElementById("stop-replaying-button").addEventListener("click", stop);
    document.getElementById("stop-recording-button").addEventListener("click", stop);
    document.getElementById("saveas-button").addEventListener("click", onSaveAs);
    document.getElementById("capture-button").addEventListener("click", onCapture);
    document.getElementById("loop-button").addEventListener("click", playLoop);
    document.getElementById("edit-button").addEventListener("click", edit);
    document.getElementById("settings-button").addEventListener("click", function() {
        link("options.html")
    });
    document.getElementById("help-button").addEventListener("click", function() {
        link(getRedirectURL('iMacros_for_Chrome'))
    });
    document.getElementById("info-edit-button").addEventListener("click", onInfoEdit);
    document.getElementById("info-help-button").addEventListener("click", onInfoHelp);
    document.getElementById("info-close-button").addEventListener("click", onInfoClose);

    document.getElementById("radio-files-tree").addEventListener("change", function() {
        onTreeSelect('files');
    });
    document.getElementById("radio-bookmarks-tree").addEventListener("change", function() {
        onTreeSelect('bookmarks');
    });

    document.body.oncontextmenu = function(e) {
        e.preventDefault();
        return false;
    };

    setAdDetails();
});


window.addEventListener("beforeunload", function() {
    var bg = chrome.extension.getBackgroundPage();
    chrome.windows.get(bg.context[args.win_id].panelId, function(p) {
        var panelBox = {
            left: p.left, top: p.top,
            width: p.width, height: p.height
        };
        Storage.setObject("panel-box", panelBox);
    });
});


function setLoopValue(val) {
    document.getElementById("current-loop").value = val;
}


// convert bookmarklet-type macro to file or vice versa
function convert() {
    var win_id = args.win_id;
    var bg = chrome.extension.getBackgroundPage();
    var doc = window.frames["tree-iframe"].contentDocument;
    var container = doc.getElementById("imacros-macro-container");
    var div = doc.getElementById("imacros-bookmark-div");
    var macro = {};
    var type;

    if (div.hasAttribute("file_id")) {
        // convert file to bookmarklet
        type = "bookmark";
        var node = afio.openNode(div.getAttribute("file_id"));
        afio.readTextFile(node).then(function(source) {
            macro.source = source;
            macro.name = div.getAttribute("name");
            bg.save(macro, false, function(macro) {
                alert("Macro copied in "+type+" storage");
            });
        }, function(e) {
            console.error(e);
            alert("Can not open "+container.value+
                  ", reason: "+e.message());
        });
    } else if (div.hasAttribute("bookmark_id")) {
        type = "file";
        // convert bookmarklet to file
        macro.source = container.value;
        macro.name = div.getAttribute("name");
        if (!/\.iim$/.test(macro.name))  // append .iim extension
            macro.name += ".iim";
        var node = afio.openNode(localStorage["defsavepath"]);
        node.append(macro.name);
        macro.file_id = node.path;
        bg.save(macro, false, function(macro) {
            alert("Macro copied in "+type+" storage");
        });
    }
}




function showLines(code) {
    document.getElementById("tree-view").setAttribute("hidden", "true");
    document.getElementById("macro-view").removeAttribute("hidden");
    if (code && code.length) {
        document.getElementById("macro-iframe").contentWindow.mv.showLines(code);
    } else {
        document.getElementById("macro-iframe").contentWindow.mv.clearAllLines();
    }
}

function showMacroTree() {
    document.getElementById("tree-view").removeAttribute("hidden");
    document.getElementById("macro-view").setAttribute("hidden", "true");
}

function addLine(txt) {
    document.getElementById("macro-iframe").contentWindow.mv.addLine(txt);
}

function highlightLine(line) {
    document.getElementById("macro-iframe").contentWindow.mv.highlightLine(line);
}

function setStatLine(txt, type) {
    document.getElementById("macro-iframe").contentWindow.mv.setStatLine(txt, type);
}

function removeLastLine() {
    document.getElementById("macro-iframe").contentWindow.mv.removeLastLine();
}


var info_args = null;

function showInfo(args) {
    info_args = args;
    var info_div = document.getElementById("info-div");
    info_div.removeAttribute("hidden");
    document.getElementById("logo-and-links").setAttribute("hidden", "true");

    if (args.errorCode != 1) {
        document.getElementById("info-area").setAttribute("type", "error");
        document.getElementById("info-edit-button").removeAttribute("collapsed");
        document.getElementById("info-help-button").removeAttribute("collapsed");
    } else {
        document.getElementById("info-area").setAttribute("type", "message");
        document.getElementById("info-edit-button").setAttribute("collapsed", "true");
        document.getElementById("info-help-button").setAttribute("collapsed", "true");
    }

    document.getElementById("info-area").textContent = args.message;
}

function onInfoClose() {
    document.getElementById("info-div").setAttribute("hidden", "true");
    document.getElementById("logo-and-links").removeAttribute("hidden");
}


function onInfoHelp() {
    var url = getRedirFromString("error");
	//info_args.errorCode;
    var bg = chrome.extension.getBackgroundPage();
    bg.addTab(url, info_args.win_id);
}

function onInfoEdit() {
    // TODO: pass line number to editor
    // var line = 0;
    // if (/, line:\s*(\d+)(?:\s+\(.*\))?$/.test(info_args.message))
    //     line = parseInt(RegExp.$1);
    var bg = chrome.extension.getBackgroundPage();
    bg.edit(info_args.macro, true);
}

function onSaveAs() {
    if (document.getElementById("saveas-button").getAttribute("disabled") == "true")
        return;
    var win_id = args.win_id;
    var bg = chrome.extension.getBackgroundPage();
    bg.context[win_id].recorder.saveAs();
}

function onCapture() {
    if (document.getElementById("capture-button").getAttribute("disabled") == "true")
        return;
    var win_id = args.win_id;
    var bg = chrome.extension.getBackgroundPage();
    bg.context[win_id].recorder.capture();
}


function setAdDetails() {
    var ad_link = document.getElementById("ad-link");
    var ad_image = document.getElementById("ad-image");
    var ad_image_link = document.getElementById("ad-image-link");
    var bg = chrome.extension.getBackgroundPage();

    bg.isPersonalVersion().then(function(personal) {
        bg.xhr("skin/ads.json", "plain/text")
            .then(function(response) {
                let ads = JSON.parse(response);
                let ad_index = personal ? 0 : Math.floor(Math.random() * ads.length)

                ad_link.innerText = ads[ad_index].ad_text;
                var href = ads[ad_index].ad_link;
                ad_link.addEventListener("click", function() {
                    link(href);
                });
                ad_image_link.addEventListener("click", function() {
                    link(href);
                });
                ad_image.src = "../skin/ads/" + ads[ad_index].ad_img;
            })
    })
}



======================================================================
FILE PATH: passwordDialog.html
======================================================================
<html>
  <head>
    <title>iMacros password dialog</title>
    <link rel="stylesheet" type="text/css"
          href="skin/common.css" />
    <link rel="stylesheet" type="text/css"
          href="skin/passwordDialog.css" />
    <script src="utils.js"></script>
    <script src="passwordDialog.js"></script>
  </head>
  <body>
    <div id="container" class="vbox dialogs-global-settings">
      <div id="message-div" class="vbox">
        <div class="hbox">
          <div id="message-and-password-box" class="vbox">
            <div>
              <span id="message">
                Enter Master Password: <br> &emsp; &ensp; &ensp;
              </span>
              <span id="more-info-encryption" class="a-link"> (More Info)</span>
            </div>
            <div>
              <input type="password" id="password"></input>
            </div>
          </div>
        </div>
        <div id="note"><span >このパスワードはセキュリティのために<b>保存されない</b>ことに注意してください。 ただし、入力する必要があるのは、ブラウザの起動後の最初のマクロ実行時に 1 回だけです。</span>
        </div>
      </div>
      <div id="buttons" class="hbox centered">
        <div id="ok-button" class="button icon-button">
          <span>OK</span>
        </div>
        <div id="cancel-button" class="button icon-button">
          <span>Cancel</span>
        </div>
      </div>
      <div>
        
      </div>
    </div>
  </body>
</html>



======================================================================
FILE PATH: passwordDialog.js
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/

function sendResponse(response) {
    chrome.windows.getCurrent(null, function(w) {
        let bg = chrome.extension.getBackgroundPage()
        bg.dialogUtils.setDialogResult(w.id, response)
    })
}

function ok() {
    let pwd = document.getElementById("password")
    sendResponse({password: pwd.value});
    window.close()
}

function cancel() {
    sendResponse({canceled: true})
    window.close()
}

window.addEventListener("load", function(evt) {
    document.getElementById("password").focus()
    document.getElementById("more-info-encryption").addEventListener("click", function() {
        link(getRedirectURL('!ENCRYPTION'));
    });
    resizeToContent(window, document.getElementById('container'));
    document.getElementById("password").addEventListener("keypress", function(e) {
        if (e.which == 13) ok();
    });
    document.getElementById("ok-button").addEventListener("click", ok);
    document.getElementById("cancel-button").addEventListener("click", cancel);
    // prevent right-click
    document.body.oncontextmenu = function(e) {
        e.preventDefault();
        return false;
    };
}, true);



======================================================================
FILE PATH: promptDialog.html
======================================================================
<!DOCTYPE html>

﻿
<html>
<head>
    <title>iMacros for Chrome</title>
    <link rel="stylesheet" type="text/css"
          href="skin/common.css" />
    <link rel="stylesheet" type="text/css"
          href="skin/promptDialog.css" />
    <script src="utils.js"></script>
    <script src="promptDialog.js"> </script>

</head>
<body>
    <div id="container" class="vbox dialogs-global-settings">
        <div id="dialogboxhead">
            <div class="area textlines"></div> 
            <textarea id="data-field" class="hbox" readonly></textarea>
        </div>
        <div id="dialogboxbody">
            <input type="text" id="prompt-input-text"></input>
        </div>
        <div id="dialogboxfoot" class="vbox">
            <div id="buttons" class="hbox centered">
                <div id="ok-button" class="button icon-button" role="button" tabindex="0">
                    <span>OK</span>
                </div>                
            </div>
        </div>
    </div>
</body>
</html>



======================================================================
FILE PATH: promptDialog.js
======================================================================
﻿/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/
// Custom prompt function 
// as alternative for JavaScript prompt()

function sendResponse(response) {
    chrome.windows.getCurrent(null, function (w) {
        let bg = chrome.extension.getBackgroundPage();
        bg.dialogUtils.setDialogResult(w.id, response)
    })
}

function getArguments(windowId) {
    let bg = chrome.extension.getBackgroundPage()
    return bg.dialogUtils.getDialogArgs(windowId)
}

function ok() {
    let prompt_value = document.getElementById('prompt-input-text').value;
    sendResponse({ inputValue: prompt_value });
    window.close()
}

function cancel() {
    sendResponse({ canceled: true })
    window.close()
}

window.addEventListener("load", function (evt) {

    chrome.windows.getCurrent(null, function (w) {
        var myArgs = getArguments(w.id);
        document.getElementById("data-field").textContent = myArgs.text;
        var promptInput = document.getElementById("prompt-input-text");
        //document.getElementById("ok-button").addEventListener("click", ok);
        let okButton = document.getElementById("ok-button");
        okButton.addEventListener("click", ok);
        okButton.focus();
        okButton.addEventListener("keydown", function(e) {
            var type = e.type;
            if (type === "keydown"){
                if((e.keyCode === 13) || (e.keyCode === 32)){
                    ok();
                    e.preventDefault();
                }
            }
        });
        // prompt dialog: type = askInput
        if (myArgs.type == "askInput") {
            if (typeof(myArgs.default) != "undefined") {
               promptInput.defaultValue = myArgs.default;
            }
            promptInput.focus();
            promptInput.select();
            promptInput.addEventListener("keypress", function(e) {
                if (e.which == 13) ok();
            });
            var cancelButton = document.createElement("div");
            cancelButton.id = "cancel-button";
            cancelButton.className = "button icon-button";
            cancelButton.innerHTML = "<span>Cancel</span>";
            cancelButton.addEventListener("click", cancel);
            document.getElementById('buttons').appendChild(cancelButton);
            
            resizeToContent(window, document.getElementById('container'));
        }
        // alert dialog: type = alert
        else {
            promptInput.style.display = "none";            
            //document.getElementById("buttons").style.webkitBoxPack = "end"; // moves the button to right
            resizeToContent(window, document.getElementById('container'));
        }
    });
    // document.addeventlistener("keypress", function (e) {
    //    if (e.which == 13) ok();
    // });

    // prevent right-click
    document.body.oncontextmenu = function (e) {
        e.preventDefault();
        return false;
    };
}, true);



======================================================================
FILE PATH: rijndael.js
======================================================================
/*
 Crypto utilities


 Original copyright (c) 2001 Fritz Schneider
 
 This software is provided as-is, without express or implied warranty.  
 Permission to use, copy, modify, distribute or sell this software, with or
 without fee, for any purpose and by any individual or organization, is hereby
 granted, provided that the above copyright notice and this paragraph appear 
 in all copies. Distribution as a part of an application or binary must
 include the above copyright notice in the documentation and/or other materials
 provided with the application or distribution.


   As the above disclaimer notes, you are free to use this code however you
   want. However, I would request that you send me an email 
   (fritz /at/ cs /dot/ ucsd /dot/ edu) to say hi if you find this code useful
   or instructional. Seeing that people are using the code acts as 
   encouragement for me to continue development. If you *really* want to thank
   me you can buy the book I wrote with Thomas Powell, _JavaScript:
   _The_Complete_Reference_ :)

   This code is an UNOPTIMIZED REFERENCE implementation of Rijndael. 
   If there is sufficient interest I can write an optimized (word-based, 
   table-driven) version, although you might want to consider using a 
   compiled language if speed is critical to your application. As it stands,
   one run of the monte carlo test (10,000 encryptions) can take up to 
   several minutes, depending upon your processor. You shouldn't expect more
   than a few kilobytes per second in throughput.

   Also note that there is very little error checking in these functions. 
   Doing proper error checking is always a good idea, but the ideal 
   implementation (using the instanceof operator and exceptions) requires
   IE5+/NS6+, and I've chosen to implement this code so that it is compatible
   with IE4/NS4. 

   And finally, because JavaScript doesn't have an explicit byte/char data 
   type (although JavaScript 2.0 most likely will), when I refer to "byte" 
   in this code I generally mean "32 bit integer with value in the interval 
   [0,255]" which I treat as a byte.

   See http://www-cse.ucsd.edu/~fritz/rijndael.html for more documentation
   of the (very simple) API provided by this code.

                                               Fritz Schneider
                                               fritz at cs.ucsd.edu
 
*/


var Rijndael = (function () {
// Rijndael parameters --  Valid values are 128, 192, or 256

    var keySizeInBits = 256;
    var blockSizeInBits = 128;

    // Note: in the following code the two dimensional arrays are indexed as
    //       you would probably expect, as array[row][column]. The state arrays
    //       are 2d arrays of the form state[4][Nb].


    // The number of rounds for the cipher, indexed by [Nk][Nb]
    var roundsArray = [ ,,,,[,,,,10,, 12,, 14],, 
        [,,,,12,, 12,, 14],, 
        [,,,,14,, 14,, 14] ];

    // The number of bytes to shift by in shiftRow, indexed by [Nb][row]
    var shiftOffsets = [ ,,,,[,1, 2, 3],,[,1, 2, 3],,[,1, 3, 4] ];

    // The round constants used in subkey expansion
    var Rcon = [ 
        0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 
        0x40, 0x80, 0x1b, 0x36, 0x6c, 0xd8, 
        0xab, 0x4d, 0x9a, 0x2f, 0x5e, 0xbc, 
        0x63, 0xc6, 0x97, 0x35, 0x6a, 0xd4, 
        0xb3, 0x7d, 0xfa, 0xef, 0xc5, 0x91
    ];

// Precomputed lookup table for the SBox
    var SBox = [
        99, 124, 119, 123, 242, 107, 111, 197,  48,
        1, 103,  43, 254, 215, 171, 118, 202, 130,
        201, 125, 250,  89,  71, 240, 173, 212, 162,
        175, 156, 164, 114, 192, 183, 253, 147,  38,
        54,  63, 247, 204,  52, 165, 229, 241, 113,
        216,  49,  21,   4, 199,  35, 195,  24, 150,
        5, 154,   7,  18, 128, 226, 235,  39, 178,
        117,   9, 131,  44,  26,  27, 110,  90, 160,
        82,  59, 214, 179,  41, 227,  47, 132,  83,
        209,   0, 237,  32, 252, 177,  91, 106, 203,
        190,  57,  74,  76,  88, 207, 208, 239, 170,
        251,  67,  77,  51, 133,  69, 249,   2, 127,
        80,  60, 159, 168,  81, 163,  64, 143, 146,
        157,  56, 245, 188, 182, 218,  33,  16, 255,
        243, 210, 205,  12,  19, 236,  95, 151,  68,
        23,  196, 167, 126,  61, 100,  93,  25, 115,
        96, 129,  79, 220,  34,  42, 144, 136,  70,
        238, 184,  20, 222,  94,  11, 219, 224,  50,
        58,  10,  73, 6,  36,  92, 194, 211, 172,
        98, 145, 149, 228, 121, 231, 200,  55, 109,
        141, 213,  78, 169, 108,  86, 244, 234, 101,
        122, 174,   8, 186, 120,  37, 46,  28, 166,
        180, 198, 232, 221, 116,  31,  75, 189, 139,
        138, 112,  62, 181, 102,  72,   3, 246,  14,
        97,  53,  87, 185, 134, 193,  29, 158, 225,
        248, 152,  17, 105, 217, 142, 148, 155,  30,
        135, 233, 206,  85,  40, 223, 140, 161, 137,
        13, 191, 230,  66, 104,  65, 153,  45,  15,
        176,  84, 187, 22 ];

// Precomputed lookup table for the inverse SBox
    var SBoxInverse = [
        82,   9, 106, 213,  48,  54, 165,  56, 191,
        64, 163, 158, 129, 243, 215, 251, 124, 227,
        57, 130, 155,  47, 255, 135,  52, 142,  67,
        68, 196, 222, 233, 203,  84, 123, 148,  50,
        166, 194,  35,  61, 238,  76, 149,  11,  66,
        250, 195,  78,   8,  46, 161, 102,  40, 217,
        36, 178, 118,  91, 162,  73, 109, 139, 209,
        37, 114, 248, 246, 100, 134, 104, 152,  22,
        212, 164,  92, 204,  93, 101, 182, 146, 108,
        112,  72,  80, 253, 237, 185, 218,  94,  21,
        70,  87, 167, 141, 157, 132, 144, 216, 171,
        0, 140, 188, 211,  10, 247, 228,  88,   5,
        184, 179,  69,   6, 208,  44,  30, 143, 202,
        63,  15,   2, 193, 175, 189,   3,   1,  19,
        138, 107,  58, 145,  17,  65,  79, 103, 220,
        234, 151, 242, 207, 206, 240, 180, 230, 115,
        150, 172, 116,  34, 231, 173, 53, 133, 226,
        249,  55, 232,  28, 117, 223, 110,  71, 241,
        26, 113,  29, 41, 197, 137, 111, 183,  98,
        14, 170,  24, 190,  27, 252,  86,  62,  75,
        198, 210, 121,  32, 154, 219, 192, 254, 120,
        205,  90, 244,  31, 221, 168, 51, 136,   7,
        199,  49, 177,  18,  16,  89,  39, 128, 236,
        95,  96,  81, 127, 169,  25, 181,  74,  13,
        45, 229, 122, 159, 147, 201, 156, 239, 160,
        224,  59,  77, 174,  42, 245, 176, 200, 235,
        187,  60, 131,  83, 153,  97, 23,  43,   4,
        126, 186, 119, 214,  38, 225, 105,  20,  99,
        85,  33,  12, 125
    ];

    var SBoxInverse1 = [
        254,  58,  12, 203, 236,  12,   6, 145, 248,
        120, 116, 200, 233, 105,  92, 102,   5, 255,
        30, 243, 104,  63,  61, 137,  85,  39, 118,
        182, 179, 124, 27,  19,  19, 107,  28, 179,
        6,  54, 249, 102,  90,  73,  23, 221, 173,
        247, 249, 134,  51,  49,  65, 116,  79, 147,
        184, 207, 136, 164,  21, 213, 68, 217, 228,
        234, 195, 234,  24, 215, 245,  96, 187, 115,
        62, 128, 212, 236, 136,  55,  75, 208, 166,
        50,  11,   7,  47, 204, 207, 157, 218,  11,
        159,  42, 113, 245,  87, 217
    ];

// This method circularly shifts the array left by the number of elements
// given in its parameter. It returns the resulting array and is used for 
// the ShiftRow step. Note that shift() and push() could be used for a more 
// elegant solution, but they require IE5.5+, so I chose to do it manually. 

    function cyclicShiftLeft(theArray, positions) {
        var temp = theArray.slice(0, positions);
        theArray = theArray.slice(positions).concat(temp);
        return theArray;
    }

    // Cipher parameters ... do not change these
    var Nk = keySizeInBits / 32;                   
    var Nb = blockSizeInBits / 32;
    var Nr = roundsArray[Nk][Nb];

    // Multiplies the element "poly" of GF(2^8) by x. See the Rijndael spec.

    function xtime(poly) {
        poly <<= 1;
        return ((poly & 0x100) ? (poly ^ 0x11B) : (poly));
    }

// Multiplies the two elements of GF(2^8) together and returns the result.
// See the Rijndael spec, but should be straightforward: for each power of
// the indeterminant that has a 1 coefficient in x, add y times that power
// to the result. x and y should be bytes representing elements of GF(2^8)

    function mult_GF256(x, y) {
        var bit, result = 0;
        
        for (bit = 1; bit < 256; bit *= 2, y = xtime(y)) {
            if (x & bit) 
                result ^= y;
        }
        return result;
    }

// Performs the substitution step of the cipher. State is the 2d array of
// state information (see spec) and direction is string indicating whether
// we are performing the forward substitution ("encrypt") or inverse 
// substitution (anything else)

    function byteSub(state, direction) {
        var S;
        if (direction == "encrypt") // Point S to the SBox we're using
            S = SBox;
        else
            S = SBoxInverse;
        for (var i = 0; i < 4; i++) // Substitute for every byte in state
            for (var j = 0; j < Nb; j++)
                state[i][j] = S[state[i][j]];
    }

// Performs the row shifting step of the cipher.

    function shiftRow(state, direction) {
        for (var i=1; i<4; i++)               // Row 0 never shifts
            if (direction == "encrypt")
                state[i] = cyclicShiftLeft(state[i], shiftOffsets[Nb][i]);
        else
            state[i] = cyclicShiftLeft(state[i], Nb - shiftOffsets[Nb][i]);

    }

// Performs the column mixing step of the cipher. Most of these steps can
// be combined into table lookups on 32bit values (at least for encryption)
// to greatly increase the speed. 

    function mixColumn(state, direction) {
        var b = [];             // Result of matrix multiplications
        for (var j = 0; j < Nb; j++) { // Go through each column...
            for (var i = 0; i < 4; i++) { // and for each row in the column...
                if (direction == "encrypt")
                    b[i] = mult_GF256(state[i][j], 2) ^ // perform mixing
                mult_GF256(state[(i+1)%4][j], 3) ^ 
                    state[(i+2)%4][j] ^ 
                    state[(i+3)%4][j];
                else 
                    b[i] = mult_GF256(state[i][j], 0xE) ^ 
                    mult_GF256(state[(i+1)%4][j], 0xB) ^
                    mult_GF256(state[(i+2)%4][j], 0xD) ^
                    mult_GF256(state[(i+3)%4][j], 9);
            }
            for (var i = 0; i < 4; i++) // Place result back into column
                state[i][j] = b[i];
        }
    }

// Adds the current round key to the state information. Straightforward.

    function addRoundKey(state, roundKey) {
        for (var j = 0; j < Nb; j++) { // Step through columns...
            state[0][j] ^= (roundKey[j] & 0xFF); // and XOR
            state[1][j] ^= ((roundKey[j]>>8) & 0xFF);
            state[2][j] ^= ((roundKey[j]>>16) & 0xFF);
            state[3][j] ^= ((roundKey[j]>>24) & 0xFF);
        }
    }

// This function creates the expanded key from the input (128/192/256-bit)
// key. The parameter key is an array of bytes holding the value of the key.
// The returned value is an array whose elements are the 32-bit words that 
// make up the expanded key.

    function keyExpansion(key) {
        var expandedKey = new Array();
        var temp;

        // in case the key size or parameters were changed...
        Nk = keySizeInBits / 32;                   
        Nb = blockSizeInBits / 32;
        Nr = roundsArray[Nk][Nb];

        for (var j=0; j < Nk; j++)     // Fill in input key first
            expandedKey[j] = 
            (key[4*j]) | (key[4*j+1]<<8) | (key[4*j+2]<<16) | (key[4*j+3]<<24);

        // Now walk down the rest of the array filling in expanded key bytes as
        // per Rijndael's spec
        for (j = Nk; j < Nb * (Nr + 1); j++) { // For each word of expanded key
            temp = expandedKey[j - 1];
            if (j % Nk == 0) 
                temp = ( (SBox[(temp>>8) & 0xFF]) |
                         (SBox[(temp>>16) & 0xFF]<<8) |
                         (SBox[(temp>>24) & 0xFF]<<16) |
                         (SBox[temp & 0xFF]<<24) ) ^
                Rcon[Math.floor(j / Nk) - 1];
            else if (Nk > 6 && j % Nk == 4)
                temp = (SBox[(temp>>24) & 0xFF]<<24) |
                (SBox[(temp>>16) & 0xFF]<<16) |
                (SBox[(temp>>8) & 0xFF]<<8) |
                (SBox[temp & 0xFF]);
            expandedKey[j] = expandedKey[j-Nk] ^ temp;
        }
        return expandedKey;
    }

// Rijndael's round functions... 

    function Round(state, roundKey) {
        byteSub(state, "encrypt");
        shiftRow(state, "encrypt");
        mixColumn(state, "encrypt");
        addRoundKey(state, roundKey);
    }

    function InverseRound(state, roundKey) {
        addRoundKey(state, roundKey);
        mixColumn(state, "decrypt");
        shiftRow(state, "decrypt");
        byteSub(state, "decrypt");
    }

    function FinalRound(state, roundKey) {
        byteSub(state, "encrypt");
        shiftRow(state, "encrypt");
        addRoundKey(state, roundKey);
    }

    function InverseFinalRound(state, roundKey){
        addRoundKey(state, roundKey);
        shiftRow(state, "decrypt");
        byteSub(state, "decrypt");  
    }

// encrypt is the basic encryption function. It takes parameters
// block, an array of bytes representing a plaintext block, and expandedKey,
// an array of words representing the expanded key previously returned by
// keyExpansion(). The ciphertext block is returned as an array of bytes.

    function encrypt(block, expandedKey) {
        var i;  
        if (!block || block.length*8 != blockSizeInBits)
            return; 
        if (!expandedKey)
            return;

        block = packBytes(block);
        addRoundKey(block, expandedKey);
        for (i=1; i<Nr; i++) 
            Round(block, expandedKey.slice(Nb*i, Nb*(i+1)));
        FinalRound(block, expandedKey.slice(Nb*Nr)); 
        return unpackBytes(block);
    }

// decrypt is the basic decryption function. It takes parameters
// block, an array of bytes representing a ciphertext block, and expandedKey,
// an array of words representing the expanded key previously returned by
// keyExpansion(). The decrypted block is returned as an array of bytes.

    function decrypt(block, expandedKey) {
        var i;
        if (!block || block.length*8 != blockSizeInBits)
            return;
        if (!expandedKey)
            return;

        block = packBytes(block);
        InverseFinalRound(block, expandedKey.slice(Nb*Nr)); 
        for (i = Nr - 1; i>0; i--) 
            InverseRound(block, expandedKey.slice(Nb*i, Nb*(i+1)));
        addRoundKey(block, expandedKey);
        return unpackBytes(block);
    }
    
// This function packs an array of bytes into the four row form defined by
// Rijndael. It assumes the length of the array of bytes is divisible by
// four. Bytes are filled in according to the Rijndael spec (starting with
// column 0, row 0 to 3). This function returns a 2d array.

    function packBytes(octets) {
        var state = new Array();
        if (!octets || octets.length % 4)
            return;

        state[0] = new Array();  state[1] = new Array(); 
        state[2] = new Array();  state[3] = new Array();
        for (var j=0; j<octets.length; j+= 4) {
            state[0][j/4] = octets[j];
            state[1][j/4] = octets[j+1];
            state[2][j/4] = octets[j+2];
            state[3][j/4] = octets[j+3];
        }
        return state;  
    }

// This function unpacks an array of bytes from the four row format preferred
// by Rijndael into a single 1d array of bytes. It assumes the input "packed"
// is a packed array. Bytes are filled in according to the Rijndael spec. 
// This function returns a 1d array of bytes.

    function unpackBytes(packed) {
        var result = new Array();
        for (var j=0; j<packed[0].length; j++) {
            result[result.length] = packed[0][j];
            result[result.length] = packed[1][j];
            result[result.length] = packed[2][j];
            result[result.length] = packed[3][j];
        }
        return result;
    }

    // This function takes a prospective plaintext (string or array of bytes)
    // and pads it with zero bytes if its length is not a multiple of the block 
    // size. If plaintext is a string, it is converted to an array of bytes
    // in the process. The type checking can be made much nicer using the 
    // instanceof operator, but this operator is not available until IE5.0 so I 
    // chose to use the heuristic below. 

    function formatPlaintext(plaintext) {
        var bpb = blockSizeInBits / 8;               // bytes per block
        var i;

        // if primitive string or String instance
        if (typeof plaintext == "string" || plaintext.indexOf) {
            plaintext = plaintext.split("");
            // Unicode issues here (ignoring high byte)
            for (i=0; i<plaintext.length; i++)
                plaintext[i] = plaintext[i].charCodeAt(0) & 0xFF;
        } 

        for (i = bpb - (plaintext.length % bpb); i > 0 && i < bpb; i--) 
            plaintext[plaintext.length] = 0;
        
        return plaintext;
    }

    // Returns an array containing "howMany" random bytes. 

    function getRandomBytes(howMany) {
        var i;
        var bytes = new Array();
        for (i=0; i<howMany; i++)
            bytes[i] = Math.round(Math.random()*255);
        return bytes;
    }

    var retobj = {
// This function takes an array of bytes (byteArray) and converts them
// to a hexadecimal string. Array element 0 is found at the beginning of
// the resulting string, high nibble first. Consecutive elements follow
// similarly, for example [16, 255] --> "10ff". The function returns a 
// string.

        byteArrayToHex: function (byteArray) {
            var result = "";
            if (!byteArray)
                return;
            for (var i=0; i<byteArray.length; i++)
                result += ((byteArray[i]<16) ? "0" : "") +
                byteArray[i].toString(16);

            return result;
        },

// This function converts a string containing hexadecimal digits to an 
// array of bytes. The resulting byte array is filled in the order the
// values occur in the string, for example "10FF" --> [16, 255]. This
// function returns an array. 

        hexToByteArray: function (hexString) {
            var byteArray = [];
            if (hexString.length % 2)             // must have even length
                return;
            if (hexString.indexOf("0x") == 0 || hexString.indexOf("0X") == 0)
                hexString = hexString.substring(2);
            for (var i = 0; i<hexString.length; i += 2) 
                byteArray[Math.floor(i/2)] =
                parseInt(hexString.slice(i, i+2), 16);
            return byteArray;
        },

        byteArrayToString: function (byteArray) {
            var result = "";
            for(var i = 0; i < byteArray.length; i++)
                result += String.fromCharCode(byteArray[i]);
            return result;
        },

        stringToByteArray: function (s) {
            var result = new Array(s.length);
            for(var i = 0; i < s.length; i++)
                result[i] = s.charCodeAt(i);
            return result;
        },

// rijndaelEncrypt(plaintext, key, mode)
// Encrypts the plaintext using the given key and in the given mode. 
// The parameter "plaintext" can either be a string or an array of bytes. 
// The parameter "key" must be an array of key bytes. If you have a hex 
// string representing the key, invoke hexToByteArray() on it to convert it 
// to an array of bytes. The third parameter "mode" is a string indicating
// the encryption mode to use, either "ECB" or "CBC". If the parameter is
// omitted, ECB is assumed.
// 
// An array of bytes representing the cihpertext is returned. To convert 
// this array to hex, invoke byteArrayToHex() on it. If you are using this 
// "for real" it is a good idea to change the function getRandomBytes() to 
// something that returns truly random bits.

        
        rijndaelEncrypt: function (plaintext, key, mode, bsize) {
            var expandedKey, i, aBlock;
            
            blockSizeInBits = bsize;

            var bpb = blockSizeInBits / 8;          // bytes per block
            var ct;                                 // ciphertext

            if (!plaintext || !key)
                return;
            if (key.length*8 != keySizeInBits)
                return; 
            if (mode == "CBC")
                ct = getRandomBytes(bpb);             // get IV
            else {
                mode = "ECB";
                ct = new Array();
            }

            // convert plaintext to byte array and pad with zeros if necessary. 
            //  plaintext = formatPlaintext(plaintext);

            expandedKey = keyExpansion(key);
            
            for (var block=0; block<plaintext.length / bpb; block++) {
                aBlock = plaintext.slice(block*bpb, (block+1)*bpb);
                if (mode == "CBC")
                    for (var i=0; i<bpb; i++) 
                        aBlock[i] ^= ct[block*bpb + i];
                ct = ct.concat(encrypt(aBlock, expandedKey));
            }

            return ct;
        },

// rijndaelDecrypt(ciphertext, key, mode)
// Decrypts the using the given key and mode. The parameter "ciphertext" 
// must be an array of bytes. The parameter "key" must be an array of key 
// bytes. If you have a hex string representing the ciphertext or key, 
// invoke hexToByteArray() on it to convert it to an array of bytes. The
// parameter "mode" is a string, either "CBC" or "ECB".
// 
// An array of bytes representing the plaintext is returned. To convert 
// this array to a hex string, invoke byteArrayToHex() on it. To convert it 
// to a string of characters, you can use byteArrayToString().

        rijndaelDecrypt: function (ciphertext, key, mode, bsize) {
            var expandedKey;

            blockSizeInBits = bsize;

            var bpb = blockSizeInBits / 8;          // bytes per block
            var pt = new Array();                   // plaintext array
            var aBlock;                             // a decrypted block
            var block;                              // current block number

            if (!ciphertext || !key || typeof ciphertext == "string")
                return;
            if (key.length*8 != keySizeInBits)
                return; 
            if (!mode)
                mode = "ECB";   // assume ECB if mode omitted
            expandedKey = keyExpansion(key);
            
            // work backwards to accomodate CBC mode 
            for (block=(ciphertext.length / bpb)-1; block>0; block--) {
                aBlock = 
                    decrypt(ciphertext.slice(block*bpb,(block+1)*bpb),
                            expandedKey);
                if (mode == "CBC") 
                    for (var i=0; i<bpb; i++) 
                        pt[(block-1)*bpb + i] = aBlock[i] ^
                    ciphertext[(block-1)*bpb + i];
                else 
                    pt = aBlock.concat(pt);
            }

            // do last block if ECB (skips the IV in CBC)
            if (mode == "ECB")
                pt = decrypt(ciphertext.slice(0, bpb), expandedKey).concat(pt);

            return pt;
        },

/**
*
*  Secure Hash Algorithm (SHA256)
*  http://www.webtoolkit.info/
*
*  Original code by Angel Marin, Paul Johnston.
*
**/

        SHA256: function (s) {
            
            var chrsz   = 8;
            var hexcase = 0;
            
            function safe_add (x, y) {
	        var lsw = (x & 0xFFFF) + (y & 0xFFFF);
	        var msw = (x >> 16) + (y >> 16) + (lsw >> 16);
	        return (msw << 16) | (lsw & 0xFFFF);
            }
            
            function S (X, n) { return ( X >>> n ) | (X << (32 - n)); }
            function R (X, n) { return ( X >>> n ); }
            function Ch(x, y, z) { return ((x & y) ^ ((~x) & z)); }
            function Maj(x, y, z) { return ((x & y) ^ (x & z) ^ (y & z)); }
            function Sigma0256(x) { return (S(x, 2) ^ S(x, 13) ^ S(x, 22)); }
            function Sigma1256(x) { return (S(x, 6) ^ S(x, 11) ^ S(x, 25)); }
            function Gamma0256(x) { return (S(x, 7) ^ S(x, 18) ^ R(x, 3)); }
            function Gamma1256(x) { return (S(x, 17) ^ S(x, 19) ^ R(x, 10)); }
            
            function core_sha256 (m, l) {
	        var K = new Array(0x428A2F98, 0x71374491, 0xB5C0FBCF, 0xE9B5DBA5, 0x3956C25B, 0x59F111F1, 0x923F82A4, 0xAB1C5ED5, 0xD807AA98, 0x12835B01, 0x243185BE, 0x550C7DC3, 0x72BE5D74, 0x80DEB1FE, 0x9BDC06A7, 0xC19BF174, 0xE49B69C1, 0xEFBE4786, 0xFC19DC6, 0x240CA1CC, 0x2DE92C6F, 0x4A7484AA, 0x5CB0A9DC, 0x76F988DA, 0x983E5152, 0xA831C66D, 0xB00327C8, 0xBF597FC7, 0xC6E00BF3, 0xD5A79147, 0x6CA6351, 0x14292967, 0x27B70A85, 0x2E1B2138, 0x4D2C6DFC, 0x53380D13, 0x650A7354, 0x766A0ABB, 0x81C2C92E, 0x92722C85, 0xA2BFE8A1, 0xA81A664B, 0xC24B8B70, 0xC76C51A3, 0xD192E819, 0xD6990624, 0xF40E3585, 0x106AA070, 0x19A4C116, 0x1E376C08, 0x2748774C, 0x34B0BCB5, 0x391C0CB3, 0x4ED8AA4A, 0x5B9CCA4F, 0x682E6FF3, 0x748F82EE, 0x78A5636F, 0x84C87814, 0x8CC70208, 0x90BEFFFA, 0xA4506CEB, 0xBEF9A3F7, 0xC67178F2);
	        var HASH = new Array(0x6A09E667, 0xBB67AE85, 0x3C6EF372, 0xA54FF53A, 0x510E527F, 0x9B05688C, 0x1F83D9AB, 0x5BE0CD19);
	        var W = new Array(64);
	        var a, b, c, d, e, f, g, h, i, j;
	        var T1, T2;
                
	        m[l >> 5] |= 0x80 << (24 - l % 32);
	        m[((l + 64 >> 9) << 4) + 15] = l;
                
	        for ( var i = 0; i<m.length; i+=16 ) {
	            a = HASH[0];
	            b = HASH[1];
	            c = HASH[2];
	            d = HASH[3];
	            e = HASH[4];
	            f = HASH[5];
	            g = HASH[6];
	            h = HASH[7];
                    
	            for ( var j = 0; j<64; j++) {
		        if (j < 16) W[j] = m[j + i];
		        else W[j] = safe_add(safe_add(safe_add(Gamma1256(W[j - 2]), W[j - 7]), Gamma0256(W[j - 15])), W[j - 16]);
                        
		        T1 = safe_add(safe_add(safe_add(safe_add(h, Sigma1256(e)), Ch(e, f, g)), K[j]), W[j]);
		        T2 = safe_add(Sigma0256(a), Maj(a, b, c));
                        
		        h = g;
		        g = f;
		        f = e;
		        e = safe_add(d, T1);
		        d = c;
		        c = b;
		        b = a;
		        a = safe_add(T1, T2);
	            }
                    
	            HASH[0] = safe_add(a, HASH[0]);
	            HASH[1] = safe_add(b, HASH[1]);
	            HASH[2] = safe_add(c, HASH[2]);
	            HASH[3] = safe_add(d, HASH[3]);
	            HASH[4] = safe_add(e, HASH[4]);
	            HASH[5] = safe_add(f, HASH[5]);
	            HASH[6] = safe_add(g, HASH[6]);
	            HASH[7] = safe_add(h, HASH[7]);
	        }
	        return HASH;
            }
            
            function str2binb (str) {
	        var bin = Array();
	        var mask = (1 << chrsz) - 1;
	        for(var i = 0; i < str.length * chrsz; i += chrsz) {
	            bin[i>>5] |= (str.charCodeAt(i / chrsz) & mask) << (24 - i%32);
	        }
	        return bin;
            }
            
            
            function binb2hex (binarray) {
	        var hex_tab = hexcase ? "0123456789ABCDEF" : "0123456789abcdef";
	        var str = "";
	        for(var i = 0; i < binarray.length * 4; i++) {
	            str += hex_tab.charAt((binarray[i>>2] >> ((3 - i%4)*8+4)) & 0xF) +
		        hex_tab.charAt((binarray[i>>2] >> ((3 - i%4)*8  )) & 0xF);
	        }
	        return str;
            }
            
            s = this.Utf8Encode(s);
            return binb2hex(core_sha256(str2binb(s), s.length * chrsz));
            
        },

        Utf8Encode: function(string) {
            string = string.replace(/\r\n/g,"\n");
            var utftext = "";
            
            for (var n = 0; n < string.length; n++) {
                
	        var c = string.charCodeAt(n);
                
	        if (c < 128) {
	            utftext += String.fromCharCode(c);
	        }
	        else if((c > 127) && (c < 2048)) {
	            utftext += String.fromCharCode((c >> 6) | 192);
	            utftext += String.fromCharCode((c & 63) | 128);
	        }
	        else {
	            utftext += String.fromCharCode((c >> 12) | 224);
	            utftext += String.fromCharCode(((c >> 6) & 63) | 128);
	            utftext += String.fromCharCode((c & 63) | 128);
	        }
                
            }
            
            return utftext;
        },

        Utf8Decode: function (utftext) {
            var string = "";
            var i = 0;
            var c = c1 = c2 = 0;
            
            while ( i < utftext.length ) {
                
	        c = utftext.charCodeAt(i);
                
	        if (c < 128) {
	            string += String.fromCharCode(c);
	            i++;
	        }
	        else if((c > 191) && (c < 224)) {
	            c2 = utftext.charCodeAt(i+1);
	            string += String.fromCharCode(((c & 31) << 6) | (c2 & 63));
	            i += 2;
	        }
	        else {
	            c2 = utftext.charCodeAt(i+1);
	            c3 = utftext.charCodeAt(i+2);
	            string += String.fromCharCode(((c & 15) << 12) | ((c2 & 63) << 6) | (c3 & 63));
	            i += 3;
	        }
                
            }
            
            return string;
        },

        _keyStr: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",
        byteArrayToBase64: function (input) {
            var output = "";
            var chr1, chr2, chr3, enc1, enc2, enc3, enc4;
            var i = 0;
            
            while (i < input.length) {
	        chr1 = input[i++];
	        chr2 = input[i++];
	        chr3 = input[i++];
                
	        enc1 = chr1 >> 2;
	        enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);
	        enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);
	        enc4 = chr3 & 63;
                
	        if (isNaN(chr2)) {
	            enc3 = enc4 = 64;
	        } else if (isNaN(chr3)) {
	            enc4 = 64;
	        }
                
	        output = output +
	            this._keyStr.charAt(enc1) + this._keyStr.charAt(enc2) +
	            this._keyStr.charAt(enc3) + this._keyStr.charAt(enc4);
                
            }
            
            return output;
        },


        byteArrayFromBase64: function (input) {
            var output = new Array();
            var chr1, chr2, chr3;
            var enc1, enc2, enc3, enc4;
            var i = 0;
            
            input = input.replace(/[^A-Za-z0-9\+\/\=]/g, "");
            
            while (i < input.length) {
                
	        enc1 = this._keyStr.indexOf(input.charAt(i++));
	        enc2 = this._keyStr.indexOf(input.charAt(i++));
	        enc3 = this._keyStr.indexOf(input.charAt(i++));
	        enc4 = this._keyStr.indexOf(input.charAt(i++));
                
	        chr1 = (enc1 << 2) | (enc2 >> 4);
	        chr2 = ((enc2 & 15) << 4) | (enc3 >> 2);
	        chr3 = ((enc3 & 3) << 6) | enc4;
                
	        output.push(chr1);
                
	        if (enc3 != 64) {
	            output.push(chr2);
	        }
	        if (enc4 != 64) {
	            output.push(chr3);
	        }
                
            }
            return output;
        },
        
        encryptString: function (message, password) {
            // a sequence to test if text were decrypted properly
            const _magic = "length@:";
            message = _magic.replace("length", message.length)+message;
            var key = this.hexToByteArray(this.SHA256(password));
            var plaintext = this.stringToByteArray(this.Utf8Encode(message));
            // encrypt with block size = 128 => AES
            var cyphertext = this.rijndaelEncrypt(plaintext, key, "CBC", 256);

            return this.byteArrayToBase64(cyphertext);
        },

        testDecryptedString: function(plaintext) {            
             // remove trailing zero symbols
             plaintext = plaintext.replace(/\0+$/, '');
             // check if message is decrypted properly
             if (/\0/.test(plaintext)) // there should be no zeroes
                return { success: false, result: '' };
             plaintext = this.Utf8Decode(plaintext);
             // check for magic sequence
             if (!/^(\d+)@:/.test(plaintext)) // no magic sequence 
                 return { success: false, result: '' };
             var length = parseInt(RegExp.$1);
             plaintext = plaintext.replace(/^(\d+)@:/, '');
             if (length != plaintext.length) // original length differs
                return { success: false, result: '' };        
            
            return { success: true, result: plaintext };
        },

        decryptString: function (cyphertextBase64, password) {
            var key = this.hexToByteArray(this.SHA256(password));
            var cyphertext = this.byteArrayFromBase64(cyphertextBase64);
            // Try first with block size = 128 (AES)
            var plaintext = this.rijndaelDecrypt(cyphertext, key, "CBC", 128);
            plaintext = this.byteArrayToString(plaintext);
            // test decrypted string
            var test = this.testDecryptedString(plaintext);
            if (!test.success) {                
                // try again with block size = 256 (legacy)
                plaintext = this.rijndaelDecrypt(cyphertext, key, "CBC", 256);
                plaintext = this.byteArrayToString(plaintext);
                test = this.testDecryptedString(plaintext);
                if (!test.success)
                    throw new RuntimeError("Decryption failed, bad password", 942);
            }
            return test.result;
        }

    };

    return retobj;
})();



======================================================================
FILE PATH: sandbox.html
======================================================================
<html>
  <script src="sandbox.js"> </script>
  <body>
  </body>
</html>



======================================================================
FILE PATH: sandbox.js
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/

function EvalException(msg, num) {
    this.message = msg;
    if (typeof num != "undefined")
        this.errnum = num;
    this.name = "MacroError";
}

function MacroError(txt) {
    throw new EvalException(txt, -1340);
}

window.addEventListener("message", function(event) {
    if (!event.data.type || event.data.type != "eval_in_sandbox")
        return;
    var response = {
        type: "eval_in_sandbox_result",
        id: event.data.id
    };
    try {
        response.result = eval(event.data.expression);
    } catch(e) {
        console.error(e);
        response.error = {
            name: e.name,
            message: e.message,
            errnum: e.errnum
        };
    }
    
    event.source.postMessage(response, event.origin);
});



======================================================================
FILE PATH: SOAPClient.js
======================================================================
//*<JasobNoObfs>*/
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/
/*</JasobNoObfs>*/



var EXPORTED_SYMBOLS = ["SOAPClient"];

var SOAPClient = (function () {

    var WSDL_cache = new Object();

    var xmlns_schema="http://www.w3.org/2001/XMLSchema";
    var xmlns_wsdl="http://schemas.xmlsoap.org/wsdl/";

    
    function WSDLObject(url, xmlDoc) {
        this.url = url;
        this.doc = xmlDoc;
        // assume that all the namespace definitions are provided
        // in document element
        this.nsTable = new Object();
        this.reverseNsTable = new Object();
        var atts = this.doc.documentElement.attributes;
        for (var i = 0; i < atts.length; i++) {
            if (/^xmlns:(.*)$/.test(atts[i].name)) {
                this.nsTable[RegExp.$1] = atts[i].value;
                this.reverseNsTable[atts[i].value] = RegExp.$1;
            }
        }

        // query method names
        this.methods = new Object();
        
        var wsdl_prefix = this.reverseNsTable[xmlns_wsdl] ?
            this.reverseNsTable[xmlns_wsdl]+":" : "";
        var operations = this.doc.evaluate(
            "//"+wsdl_prefix+"portType/"+wsdl_prefix+"operation",
            this.doc, this.resolveNS.bind(this),
            // XPathResult.ORDERED_NODE_ITERATOR_TYPE
            5,
            null
        );

        var op = null;
        while (op = operations.iterateNext()) {
            if (!op.hasAttribute('name'))
                continue;       // unlikely but for peace of mind
            var op_name = op.getAttribute('name'); 
            this.methods[op_name] = {};
            // assume that the operation contains input/output specifiers which
            // is not always true as they can be specified in bindings 
            var input_tagName = wsdl_prefix+"input";
            var output_tagName = wsdl_prefix+"output";
            for(var i = 0; i < op.children.length; i++) {
                var tagName = op.children[i].tagName;
                if (tagName == input_tagName) {
                    if (op.children[i].hasAttribute('message')) {
                        var msg_name = op.children[i].getAttribute('message');
                        this.methods[op_name].input = {
                            typeObject: this.getType(msg_name)
                        };
                    }
                } else if (tagName == output_tagName) {
                    if (op.children[i].hasAttribute('message')) {
                        var msg_name = op.children[i].getAttribute('message');
                        this.methods[op_name].output = {
                            typeObject: this.getType(msg_name)
                        };
                    }
                }
            }
        }
        // __loginf("WSDLObject created, methods="+this.methods.toSource());
    };


    WSDLObject.prototype.getType = function(messageName) {
        var schema_prefix = this.reverseNsTable[xmlns_schema] ?
            this.reverseNsTable[xmlns_schema]+":" : "";
        var wsdl_prefix = this.reverseNsTable[xmlns_wsdl] ?
            this.reverseNsTable[xmlns_wsdl]+":" : "";
        
        // TODO: Here we assume that <wsdl:message>/<wsdl:part> refer to
        // Schema element containing type definition but the types can also
        // be defined using one or more <wsdl:part> elements with 'type'
        // attribute. We ignore such case.

        // NOTE: That part I don't really understand. operations in portType
        // refers to messages using prefixed names. In order to find
        // corresponding message I have to remove the prefix because
        // <wsdl:message> 'name' attributes do not use prefixes
        var msg_name = messageName.replace(/^\w+:/, "");
        var part_element = this.doc.evaluate(
            "//"+wsdl_prefix+"message[@name=\""+msg_name+"\"]/"+
                wsdl_prefix+"part",
            this.doc, this.resolveNS.bind(this),
            // XPathResult.FIRST_ORDERED_NODE_TYPE
            9, null
        ).singleNodeValue;
        
        if (!part_element) {
            throw new Error("No type definition for "+messageName);
        }
        // see above for that .replace
        var el_name = part_element.getAttribute("element").replace(/^\w+:/, "");
        var schema_element = this.doc.evaluate(
            "//"+schema_prefix+"element[@name=\""+el_name+"\"]",
            this.doc, this.resolveNS.bind(this),
            // XPathResult.FIRST_ORDERED_NODE_TYPE
            9, null
        ).singleNodeValue;

        if (!schema_element) {
            throw new Error("No type definition for "+messageName);
        }
        
        // NOTE: we use very simplistic approach here assuming that element is
        // of complex type consisting only of simple types and has no
        // additional complex members
        var typeObject = {};
        var nodes = this.doc.evaluate(
            "./"+schema_prefix+"complexType/"+schema_prefix+"sequence/"+
                schema_prefix+"element",
            schema_element, this.resolveNS.bind(this),
            /* XPathResult.ORDERED_NODE_ITERATOR_TYPE */ 5, null
        )
        var n = null;
        while(n = nodes.iterateNext()){
            // ignore Schema restriction and any other complexities here
            // just assume it is one of primitive types
            typeObject[n.getAttribute('name')] = {
                type: n.getAttribute('type').replace(
                    new RegExp("^"+schema_prefix), ""
                )
            };
        }

        return typeObject;
    };

    WSDLObject.prototype.resolveNS = function(ns) {
        var uri = this.nsTable[ns];
        if (!uri)
            throw Error("Unable to resolve namespace "+ns);
        return uri;
    };

    // assume that args is a plain JS object
    WSDLObject.prototype.argsToXML = function(method, args) {
        // __loginf("argsToXML, method="+method+", args="+args.toSource());
        var m = this.methods[method];
        if (!m || !m.input || !m.input.typeObject) {
            throw new Error("Input type not specified for method "+method);
        }
        var type_object = m.input.typeObject;
        var s = "";
        // TODO: from all the variety of XML Schema types
        // we use only three (which maybe too much of simplification)
        // __loginf("input type object="+type_object.toSource());
        var tns = this.doc.documentElement.getAttribute("targetNamespace");
        var prefix = this.reverseNsTable[tns] ?
            this.reverseNsTable[tns]+":" : "";
        
        for (var x in args) {
            if (type_object[x].type == "string" ) {
                s += "<"+prefix+x+">"+
                    args[x].replace(/&/g, "&amp;").
                    replace(/</g, "&lt;").
                    replace(/>/g, "&gt;")+
                    "</"+prefix+x+">";
            } else if (type_object[x].type == "boolean") {
                s += "<"+prefix+x+">"+
                    (args[x] ? "true" : "false")+
                    "</"+prefix+x+">";
            } else if (type_object[x].type == "integer") {
                s += "<"+prefix+x+">"+
                    args[x].toString()+
                    "</"+prefix+x+">";
            } else {
                throw new Error("Unsupported type "+type_object[x]);
            }
        }
        //__loginf("argsToXML result="+s);
        return s;
    };


    WSDLObject.prototype.makeSoapEnvelope = function(method, args) {
        var targetNamespace = this.doc.documentElement.
            getAttribute("targetNamespace");

        var env = "<?xml version=\"1.0\" encoding=\"utf-8\"?>"+
            "<soap-env:Envelope"+
            " xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\""+
            " xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\""+
            " xmlns:soap-env=\"http://www.w3.org/2003/05/soap-envelope\"";
        for (var x in this.nsTable) {
            env += " xmlns:"+x+"=\""+this.nsTable[x]+"\"";
        }
        env += ">";
        var prefix = this.reverseNsTable[targetNamespace] ?
            this.reverseNsTable[targetNamespace]+":" : "";
        var suffix = this.reverseNsTable[targetNamespace] ?
            ":"+this.reverseNsTable[targetNamespace] : "";
        env += "<soap-env:Body>"+
            "<"+prefix+method+" xmlns"+suffix+"=\""+targetNamespace+"\">"+
            this.argsToXML(method, args)+
            "</"+prefix+method+"></soap-env:Body>"+
            "</soap-env:Envelope>";

        return env;
    };
        
    WSDLObject.prototype.parseRetObject = function(method, xml) {
        var m = this.methods[method];
        if (!m || !m.output)
            return null;        // no response is assumed
        
        var type_object = m.output.typeObject;
        var rv = {};

        // var nsTable = new Object();
        // var reverseNsTable = new Object();
        // var atts = xml.documentElement.attributes;
        // for (var i = 0; i < atts.length; i++) {
        //     if (/^xmlns:(.*)$/.test(atts[i].name)) {
        //         nsTable[RegExp.$1] = atts[i].value;
        //         reverseNsTable[atts[i].value] = RegExp.$1;
        //     }
        // }
        
        // var resolveNS = function(prefix) {
        //     return nsTable[prefix];
        // };
        
        var tns = this.doc.documentElement.getAttribute("targetNamespace");
        for (var x in type_object) {
            var n = xml.getElementsByTagNameNS(tns, x);
            if (!n.length) {
                throw new Error("No value for parameter "+x+" in response");
            }
            var param = n[0];
            var value = param.textContent;
            if (type_object[x].type == "string") {
                rv[x] = value;
            } else if (type_object[x].type == "boolean") {
                rv[x] = /^\s*true\s*$/.test(value);
            } else if (type_object[x].type == "integer") {
                rv[x] = Number(value);
            } else {
                throw new Error("Data type "+type_object[x].type+
                                " is not supported");
            }
        }

        // __loginf("return value="+rv.toSource());
        return rv;
    };

    WSDLObject.prototype.invoke = function(method, args, callback) {
        // console.log("WSDLObject.invoke, method="+method+", args="+
        //             JSON.stringify(args));
        try {
            var m = this.methods[method];
            if (!m)
                throw Error("No "+method+" method found");

            var req = new XMLHttpRequest();
            req.open('POST', this.url, true);
            var self = this;
            req.onreadystatechange = function() {
                if (req.readyState == 4) {
                    if(req.status == 200) {
                        try {
                            // console.log("response="+req.responseText);
                            var rv = self.parseRetObject(
                                method, req.responseXML
                            );
                            callback(rv);
                        } catch(e) {
                            callback(null, e);
                        }
                    } else {
                        var err = new Error("Method "+method+" call failed"+
                                            ", status: "+req.statusText+
                                            " ("+req.status+")");
                        callback(null, err);
                    }
                }
            };
            var targetNamespace = this.doc.documentElement.
                getAttribute("targetNamespace");
            req.setRequestHeader("SOAPAction", targetNamespace+method);
            req.setRequestHeader("Content-Type", "text/xml; charset=utf-8");
            
            var env = this.makeSoapEnvelope(method, args);
            // __loginf("WSDLObject.invoke request="+env);
            req.send(env);
            
        } catch(e) {
            callback(null, e);
        }
    };
    

    function retrieveWSDL(ws_url, callback) {
        var url = ws_url;
        if (!/\?WSDL$/.test(url))
            url += "?WSDL";
        var req = new XMLHttpRequest();
        req.open('GET', url, true);
        req.onreadystatechange = function() {
            if (req.readyState == 4) {
                if(req.status == 200) {
                    try {
                        var wsdl = new WSDLObject(ws_url, req.responseXML);
                        WSDL_cache[ws_url] = wsdl;
                        callback(wsdl);
                    } catch(e) {
                        callback(null, e);
                    }
                } else {
                    var err = new Error("Request failed status: "+
                                        req.statusText+" ("+req.status+")");
                    callback(null, err);
                }
            }
        };

        req.send(null);
    }


    function SOAPClientImp(){}
    
    SOAPClientImp.prototype.invoke = function(ws_url, method, args, callback) {
        var wsdl = WSDL_cache[ws_url];
        if (!wsdl) {
            retrieveWSDL(ws_url, function(_wsdl, err) {
                if (!_wsdl && err) {
                    callback(null, err);
                } else {
                    _wsdl.invoke(method, args, callback);
                }
            });
        } else {
            wsdl.invoke(method, args, callback);
        }
    };

    return new SOAPClientImp();
}) ();



======================================================================
FILE PATH: treeView.html
======================================================================
<html>
  <head>
    <title>iMacros</title>
    <link rel="stylesheet"
          href="vendor/jstree/themes/default/style.css" />
    <link rel="stylesheet" type="text/css"
          href="skin/treeView.css" />
    <script src="vendor/jQuery/jquery-2.2.1.min.js"></script>
    <script src="vendor/jstree/jstree.min.js"></script>
    <script src="treeView.js"></script>
    <script src="utils.js"></script>

  </head>
  <body treetype="bookmarks">
    
    <div id="jstree_container">
        <ul id="jstree"></ul>
    </div>

    <div id="imacros-bookmark-div" style="display:none">
      <textarea id="imacros-macro-container"></textarea>
    </div>
  </body>
</html>



======================================================================
FILE PATH: treeView.js
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/

window.addEventListener("load", function (event) {
    TreeView.build();

    chrome.bookmarks.onChanged.addListener( function (id, x) {
        // TODO: listen to only iMacros descendants change
        window.location.reload();
    });
    chrome.bookmarks.onChildrenReordered.addListener( function (id, x) {
        // TODO: listen to only iMacros descendants change
        window.location.reload();
    });
    chrome.bookmarks.onCreated.addListener( function (id, x) {
        // TODO: listen to only iMacros descendants change
        window.location.reload();
    });
    chrome.bookmarks.onRemoved.addListener( function (id, x) {
        // TODO: listen to only iMacros descendants change
        window.location.reload();
    });

    window.top.onSelectionChanged(TreeView.selectedItem != null);
    document.body.oncontextmenu = function(e) {
        e.preventDefault()
    }

}, true);


window.addEventListener("iMacrosRunMacro", function(evt) {
    document.getElementById("imacros-bookmark-div").setAttribute("name", evt.detail.name);
    document.getElementById("imacros-macro-container").value = evt.detail.source;
});

function getiMacrosFolderId() {
    return new Promise((resolve, reject) => {
        chrome.bookmarks.getTree(tree => {
            // first find iMacros subtree or create if not found
            // (code duplicates one in addToBookmarks(),
            // TODO: do something with that)
            let iMacrosFolder = tree[0].children[0].children.find(
                child => child.title == "iMacros"
            )
            if (typeof iMacrosFolder == "undefined") {
                let bookmarksPanelId = tree[0].children[0].id
                chrome.bookmarks.create(
                    {parentId: bookmarksPanelId, title: "iMacros"},
                    folder => resolve(folder.id)
                )
            } else {
                resolve(iMacrosFolder.id)
            }
        })
    })
}

var TreeView = {
    // build tree from iMacros bookmarks folder
    build: function () {
        getiMacrosFolderId().then(id => TreeView.buildSubTree_jstree(id))
    },

    buildSubTree_jstree: function (id, parent) {
        if (!parent) {
            parent = document.getElementById("jstree");
        }

        chrome.bookmarks.getSubTree(id, function (treeNodes) {
            const createNode = function(text, id, type, hasChildren) {
                return {
                    'text': text,
                    'id': id,
                    'type': type,
                    'children': hasChildren
                }
            }

            const mapTree = function(nodes) {
                return nodes.filter(node => {
                    // skip non-macro bookmarks
                    if (node.url && !/iMacrosRunMacro/.test(node.url)) {
                        return false
                    } else {
                        return true
                    }
                }).map(node => {
                    let rv = {a_attr: {}}
                    if (node.url) {
                        rv.type = "macro"
                        rv.a_attr.bookmarklet = node.url
                    } else {
                        rv.type = "folder"
                        if (node.children)
                            rv.children = mapTree(node.children)
                    }
                    rv.title = node.title
                    rv.text = node.title
                    rv.id = node.id
                    rv.parentId = node.parentId
                    rv.a_attr.bookmark_id = node.id
                    node.type = rv.type
                    rv.a_attr.type = node.type
                    return rv
                })
            }

            let data = mapTree(treeNodes);
            if (!data[0].state) {
                data[0].state = {opened: true}
            }

            let onNewFolder = function () {
                var new_name = prompt("Enter new folder name", "New folder");
                var item = TreeView.selectedItem;
                var root_id;
                if (item.type == "folder") {
                    root_id = item.id;
                } else {
                    root_id = item.parentId;
                }

                chrome.bookmarks.getChildren(root_id, function (arr) {
                    // add ...(n) to the folder name if such name already present
                    var names = {}, count = 0, stop = false;
                    for (var i = 0; i < arr.length; i++) {
                        names[arr[i].title] = true;
                    }
                    while (!stop && count < arr.length + 1) {
                        if (names[new_name]) {
                            count++;
                            if (/\(\d+\)$/.test(new_name))
                                new_name = new_name.replace(/\(\d+\)$/,
                                                            "(" + count + ")");
                            else
                                new_name += " (" + count + ")";
                        } else {
                            stop = true;
                        }
                    }
                    chrome.bookmarks.create(
                        {
                            parentId: root_id,
                            title: new_name
                        },
                        function (folder) {
                            TreeView.buildSubTree(folder.id);
                        }
                    );
                });
            }

            let onRename = function () {
                var item = TreeView.selectedItem;
                if (!item) {
                    alert("Error: no item selected");
                    return;
                }
                var bookmark_id = item.id;
                var old_name = item.text;
                var new_name = prompt("Enter new name", old_name);
                if (!new_name)
                    return;
                if (item.type == "folder") {
                    chrome.bookmarks.update(bookmark_id, { title: new_name });
                } else if (item.type == "macro") {
                    chrome.bookmarks.get(bookmark_id, function (x) {
                        var url = x[0].url;
                        // change macro name in URL
                        try {
                            var m = url.match(/, n = \"([^\"]+)\";/);
                            url = url.replace(
                                    /, n = \"[^\"]+\";/,
                                ", n = \"" + encodeURIComponent(new_name) + "\";"
                            );
                        } catch (e) {
                            console.error(e);
                        }
                        chrome.bookmarks.update(
                            bookmark_id, { title: new_name, url: url }
                        );
                    });
                }
            }

            let onRemove = function () {
                var item = TreeView.selectedItem;
                if (!item) {
                    alert("Error: no item selected");
                    return;
                }
                var bookmark_id = item.id;
                if (!bookmark_id) {
                    alert("Can not delete " + item.type + " " + item.text);
                    return;
                }

                if (item.type == "macro") {
                    var yes = confirm("Are you sure you want to remove macro " +
                                      item.text +
                                      " ?");
                    if (yes) {
                        chrome.bookmarks.remove(bookmark_id, function () {
                            TreeView.selectedItem = null;
                        });
                    }
                } else if (item.type == "folder") {
                    var yes = confirm("Are you sure you want to remove folder " +
                                      item.text +
                                      " and all its contents?");
                    if (yes)
                        chrome.bookmarks.removeTree(bookmark_id, function () {
                            TreeView.selectedItem = null;
                        });
                }
            }

            const customMenu = function(node) {
                TreeView.selectedItem = node.original;

                var items = {
                    'Edit': {
                        'label': 'Edit',
                        'action': function () { window.top.edit(); }
                    },
                    'Convert': {
                        'label': 'Convert',
                        'action': function () { window.top.convert(); }
                    },
                    'New Folder': {
                        'label': 'New Folder',
                        'action': onNewFolder
                    },
                    'Rename': {
                        'label': 'Rename',
                        'action': onRename
                    },
                    'Remove': {
                        'label': 'Remove',
                        'action': onRemove
                    },
                    'Refresh Tree': {
                        'label': 'Refresh Tree',
                        'action': function () { window.location.reload(); }
                    }
                }

                if (node.type === 'folder') {
                    delete items.Edit;
                    delete items.Convert;
                }

                return items;
            };

            jQuery('#jstree_container').jstree({
                core: {
                    "check_callback": function (operation, node, parent, position, more) {
                        if (more.dnd && operation === "move_node") {
                            if(parent.id === "#") {
                                return false; // prevent moving a child above or below the root
                            }
                        }

                        return true; // allow everything else
                    },

                    data: data
                },
                types: {
                    "folder": {

                    },
                    "macro": {
                         icon: 'X'//'/skin/imglog.png'
                    }
                },
                contextmenu: {
                    items: customMenu
                },
                plugins: ['state', 'dnd', 'types', 'contextmenu', 'wholerow']
            });


            const getChildren = function(bookmarkId) {
                return new Promise((resolve, reject) => {
                    chrome.bookmarks.getChildren(bookmarkId, resolve)
                })
            }

            const namePrecedes = function(name, what) {
                if (name[0] == "#" && what[0] == "#")
                    return name.substring(1) < what.substring(1)
                else
                    return name < what
            }

            const findInsertionIndex = function(srcNode, subTree) {
                let place = subTree.find(node => {
                    if (srcNode.url && node.url) {
                        return namePrecedes(srcNode.title, node.title)
                    } else if (!srcNode.url && node.url) {
                        return true
                    } else if (srcNode.url && !node.url) {
                        return false
                    } else {
                        return srcNode.title < node.title
                    }
                })
                return place ? place.index : subTree.length
            }

            jQuery(document).on('dnd_stop.vakata', function (e, data) {
                let sourceId = data.element.getAttribute("bookmark_id")
                let targetId = data.event.target.getAttribute("bookmark_id")
                chrome.bookmarks.get([sourceId, targetId], ([src, tgt]) => {
                    let parentId = tgt.url? tgt.parentId : tgt.id
                    getChildren(parentId).then(children => {
                        let index = findInsertionIndex(src, children)
                        console.log("insertion index", index)
                        chrome.bookmarks.move(
                            src.id,
                            { parentId, index},
                            function () { window.location.reload()}
                        )
                    })
                })
            });

            jQuery('#jstree_container').on('select_node.jstree', function (e, data) {
                var element = e.target;
                TreeView.selectedItem = element;
                if (data.node.type == 'macro') {
                    TreeView.selectedItem.type = "macro";
                    var div = document.getElementById("imacros-bookmark-div");
                    if (div.hasAttribute("file_id"))
                        div.removeAttribute("file_id");
                    div.setAttribute("bookmark_id", data.node.id);
                    div.setAttribute("name", data.node.text);
                    var bookmarklet = data.node.a_attr.bookmarklet;
                    var m = /var e_m64 = "([^"]+)"/.exec(bookmarklet);
                    if (!m) {
                        console.error("Can not parse bookmarklet " + data.node.text);
                        return;
                    }
                    document.getElementById("imacros-macro-container").value = decodeURIComponent(atob(m[1]));
                    window.top.onSelectionChanged(true);

                    e.preventDefault();

                }
                //folder
                else {
                    TreeView.selectedItem.type = "folder";
                    window.top.onSelectionChanged(false);
                }
            });

            jQuery('#jstree_container').on('dblclick.jstree', function (e, data) {

                var target_node = jQuery('#jstree_container').jstree(true).get_node(e.target.getAttribute("bookmark_id"));

                if (target_node.type == 'macro') {
                    setTimeout(function () { window.top.play(); }, 200);
                }
            });
        });
    }
};



======================================================================
FILE PATH: utils.js
======================================================================
/*
Copyright © 1992-2021 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
*/

// Some utility functions
(function () {
    var timers = new Array();
    var onMessage = function(event) {
        if (event.source != window || 
            !event.data.type || 
            event.data.type != "asyncRun")
            return;
        
        var f = timers.shift();
        if (f) f();
    };

    window.asyncRun = function(f) {
        timers.push(f);
        window.postMessage({type: "asyncRun"}, "*");
    };

    window.addEventListener("message", onMessage);
}) ();


// Open URL in a new window
function link(url) {
    window.open(url);
}


function __is_windows() {
    return /^win(32)?/i.test(navigator.platform);
}

function __psep() {
    return __is_windows() ? "\\" : "/";
}

function __is_full_path(path) {
    if (__is_windows()) {
        return /^[a-z]:/i.test(path);
    } else {
        return /^\//.test(path);
    }
}

var imns = {

    // Returns number if and only if num is an integer or
    // a string representation of an integer,
    // otherwise returns NaN
    s2i: function(num) {
        var s = num.toString();
        s = this.trim(s);
        if (!s.length)
            return Number.NaN;
        var n = parseInt(s);
        if (n.toString().length != s.length)
            return Number.NaN;
        return n;
    },

    // escape \n, \t, etc. chars in line
    escapeLine: function(line) {
        var values_to_escape = {
                "\\u005C": "\\\\",
                "\\u0000": "\\0",
                "\\u0008": "\\b",
                "\\u0009": "\\t",
                "\\u000A": "\\n",
                "\\u000B": "\\v",
                "\\u000C": "\\f",
                "\\u000D": "\\r",
                "\\u0022": "\\\"",
                "\\u0027": "\\'"};

        // var values_to_escape = {
        //         "\\": "\\\\",
        //         "\0": "\\0",
        //         "\b": "\\b",
        //         "\t": "\\t",
        //         "\n": "\\n",
        //         "\v": "\\v",
        //         "\f": "\\f",
        //         "\r": "\\r",
        //         "\"": "\\\"",
        //         "'": "\\'"};
        
        for (var x in values_to_escape) {
            line = line.replace(new RegExp(x, "g"), values_to_escape[x]);
        }

        return line;
    },

    // replace all white-space symbols by <..>
    wrap: function (line) {
        const line_re = new RegExp("^\"((?:\n|.)*)\"$");

        var m = null;
        if (m = line.match(line_re)) { // it is a quoted string
            line = this.escapeLine(m[1]);
            
            // add quotes
            line = "\""+line+"\"";
        } else {
            line = line.replace(/\t/g, "<SP>");
            line = line.replace(/\n/g, "<BR>");
            line = line.replace(/\r/g, "<LF>");
            line = line.replace(/\s/g, "<SP>");
        }

        return line;
    },

    // Unwraps a line 
    // If the line is a quoted string then the following escape sequences
    // are translated:
    // \0 The NUL character (\u0000).
    // \b Backspace (\u0008).
    // \t Horizontal tab (\u0009).
    // \n Newline (\u000A).
    // \v Vertical tab (\u000B).
    // \f Form feed (\u000C).
    // \r Carriage return (\u000D).
    // \" Double quote (\u0022).
    // \' Apostrophe or single quote (\u0027).
    // \\ Backslash (\u005C).
    // \xXX The Latin-1 character specified by the two hexadecimal digits XX.
    // \uXXXX The Unicode character specified by four hexadecimal digits XXXX.
    // Otherwise <BR>, <LF>, <SP> are replaced by \n, \r, \x31 resp.

    unwrap: function(line) {
        const line_re = new RegExp("^\"((?:\n|.)*)\"$");
        var m = null;
        
        var handleSequence = function(s) {
            if (s == "\\\\") {
                return "\u005C";
            } else if (s == "\\0") {
                return "\u0000";
            } else if (s == "\\b") {
                return "\u0008";
            } else if (s == "\\t") {
                return "\u0009";
            } else if (s == "\\n") {
                return "\u000A";
            } else if (s == "\\v") {
                return "\u000B";
            } else if (s == "\\f") {
                return "\u000C";
            } else if (s == "\\r") {
                return "\u000D";
            } else if (s == "\\\"") {
                return "\u0022";
            } else if (s == "\\\'") {
                return "\u0027"
            } else {
                // function to replace \x|u sequence
                var replaceChar = function (match_str, char_code) {
                    return String.fromCharCode(parseInt("0x"+char_code));
                };
                if (/^\\x/.test(s))// replace \xXX by its value
                    return s.replace(/\\x([\da-fA-F]{2})/g, replaceChar);
                else if (/^\\u/.test(s)) // replace \uXXXX by its value
                    return s.replace(/\\u([\da-fA-F]{4})/g, replaceChar);
            }
        };

        var esc_re = new RegExp("\\\\(?:[0btnvfr\"\'\\\\]|x[\da-fA-F]{2}|u[\da-fA-F]{4})", "g");
        
        if (m = line.match(line_re)) {
            line = m[1];        // 'unquote' the line
            // replace escape sequences by their value
            line = line.replace(esc_re, handleSequence);
        } else {
            line = line.replace(/<br>/gi, '\n');
            line = line.replace(/<lf>/gi, '\r');
            line = line.replace(/<sp>/gi, ' ');
        }

        return line;
    },
    
    formatDate: function(str, date) {
        var  prependDate = function(str, num) {
            str = str.toString(); 
            var x = imns.s2i(str), y = imns.s2i(num);
            if (isNaN(x) || isNaN(y))
                return;
            while (str.length < num)
                str = '0'+str;
            return str;
        };
        var now = date ? date : new Date();
        str = str.replace(/yyyy/g, prependDate(now.getFullYear(), 4));
        str = str.replace(/yy/g, now.getFullYear().toString().substr(-2));
        str = str.replace(/mm/g, prependDate(now.getMonth()+1, 2));
        str = str.replace(/dd/g, prependDate(now.getDate(), 2));
        str = str.replace(/hh/g, prependDate(now.getHours(), 2));
        str = str.replace(/nn/g, prependDate(now.getMinutes(), 2));
        str = str.replace(/ss/g, prependDate(now.getSeconds(), 2));

        return str;
    },
    
    // escape chars which are of special meaning in regexp
    escapeREChars: function(str) {
        var chars = "^$.+?=!:|\\/()[]{}", res = "", i, j;

        for ( i = 0; i < str.length; i++) {
            for (j = 0; j < chars.length; j++) {
                if (str[i] == chars[j]) {
                    res += "\\";
                    break;
                }
            }
            res += str[i];
        }

        return res;
    },

    escapeTextContent: function(str) {
        // 1. remove all leading/trailing white spaces
        str = this.trim(str);
        // 2. remove all linebreaks
        str = str.replace(/[\r\n]+/g, "");
        // 3. all consequent white spaces inside text are replaced by one
        str = str.replace(/\s+/g, " ");

        return str;
    },


    trim: function(s) {
        return s.replace(/^\s+/, "").replace(/\s+$/, "");
    },

    Clipboard: {
        _check_area: function(str) {
            var x;
            if (!(x = document.getElementById("clipboard-area"))) {
                x = document.createElement("textarea");
                x.id = "clipboard-area";
                x.setAttribute("contentEditable", "true");
                document.body.appendChild(x);    
            }
            return x;
        },

        putString: function(str) {
            var x = this._check_area();
            x.value = str;
            x.focus();
            x.select();
            document.execCommand("Copy");
        },

        getString: function() {
            var x = this._check_area();
            x.focus();
            document.execCommand("Paste");
            
            return x.value;
        }
    }
};




// App exceptions

// Classes for reporting syntax and runtime errors

// Returns error with message=msg and optional position of
// bad parameter set by num
function BadParameter(msg, num) {
    this.message = typeof(num) != "undefined" ? "expected "+msg+
        " as parameter "+num : msg;
    this.name = "BadParameter";
    this.errnum = 711;
}

BadParameter.prototype = Error.prototype;


function UnsupportedCommand(msg) {
    this.message = "command "+msg+" is not supported in the current version";
    this.name = "UnsupportedCommand";
    this.errnum = 712;
}

UnsupportedCommand.prototype = Error.prototype;

// Returns error with message=msg, optional error number num
// sets mplayer.errorCode
function RuntimeError(msg, num) {
    this.message = msg;
    if (typeof num != "undefined")
        this.errnum = num;
    this.name = "RuntimeError";
}

RuntimeError.prototype = Error.prototype;

function FreewareLimit(msg) {
    this.message = "Freeware version limit exceeded: "+msg;
    this.errnum = 800;
    this.name = "FreewareLimit";
}

FreewareLimit.prototype = Error.prototype;

SyntaxError.prototype.
    __defineGetter__("errnum", function() { return 710; });


function normalize_error(e) {
    return {name: e.name, message: e.message, errnum: e.errnum};
}



// preference storage
var Storage = {
    isSet: function(key) {
        return typeof(localStorage[key]) != "undefined";
    },

    setBool: function(key, value) {
        localStorage[key] = Boolean(value);
    },

    getBool: function(key) {
        var value = localStorage[key];
        return value ? value.toString() != "false" : false;
    },

    setChar: function(key, value) {
        localStorage[key] = String(value);
    },

    getChar: function(key) {
        var value = localStorage[key];
        return value ? value.toString() : "";
    },

    setNumber: function(key, value) {
        var val = Number(value);
        if (!isNaN(val))
            localStorage[key] = val;
    },

    getNumber: function(key) {
        return localStorage[key];
    },

    setObject: function(key, value) {
        var s = JSON.stringify(value);
        localStorage[key] = s;
    },

    getObject: function(key) {
        var s = localStorage[key];
        if (typeof s != "string")
            return null;
        try {
            return JSON.parse(s);
        } catch(e) {
            return null;
        }
    }
};


// resize window to fit its content
function resizeToContent(win, container) {
    var rect = container.getBoundingClientRect();
    var width = (win.outerWidth-win.innerWidth)+rect.width;
    var height = (win.outerHeight-win.innerHeight)+rect.height;
    // that +30 is for window's titlebar which seems missing when
    // outerWidth-innerWidth is calculated
    win.resizeTo(width, height+30);
}


// open a dialog and return promise which resolves on a message from the
// known popup window
var dialogUtils = (function () {
    "use strict";

    let dialogResolvers = new Map()
    let dialogArgs = new Map()

    return {
        setArgs(win, args) {
			dialogArgs.set(win, args);
        },

        getArgs(win) {
            if (!dialogArgs.has(win))
                throw new Error("dialogUtils error: bad dialog win reference")
            return dialogArgs.get(win);
        },
		
        setDialogResult(win_id, response) {
            if (!dialogResolvers.has(win_id))
                throw new Error("dialogUtils error: bad dialog id")
            dialogResolvers.get(win_id)(response)
            dialogResolvers.delete(win_id)
            dialogArgs.delete(win_id)
        },

        getDialogArgs(win_id) {
            if (!dialogArgs.has(win_id))
                throw new Error("dialogUtils error: bad dialog id")
            return dialogArgs.get(win_id)
        },

        openDialog(url, name, args = {}, pos) {
            return new Promise(function(resolve, reject) {
                chrome.windows.create({
                    url: url,
                    type: "popup",
                    width: pos && pos.width || undefined,
                    height: pos && pos.height || undefined,
                    left: pos && pos.left || undefined,
                    top: pos && pos.top || undefined
                }, function(w) {
                    dialogArgs.set(w.id, args)
                    dialogResolvers.set(w.id, resolve)
                })
            })
        }
    }
})();

function getRedirectURL(id_or_kw) {
    const version = chrome.runtime.getManifest().version
    const prefix = `http://rd.imacros.net/redirect.aspx?type=CR&version=${version}`
    if (typeof id_or_kw == "number") {
        return `${prefix}&helpid=${id_or_kw}`
    } else if (typeof id_or_kw == "string") {
        return `${prefix}&helpid=102&kw=${id_or_kw}`
    }
}

function getRedirFromString(idString) {
	const version = chrome.runtime.getManifest().version
    const prefix = `http://rd.imacros.net/redirect.aspx?type=CR&version=${version}`
	return `${prefix}&helpid=${idString}`
}

// returns true if fileName's extension is of a macro file (e.g. .iim or .IIM)
function isMacroFile(fileName) {
    return /\.iim$/i.test(fileName);
}


