# Chrome 永続的権限機能 - クイックテストガイド

**所要時間**: 約 15-20 分

このガイドは、Chrome の新しい永続的権限機能を素早くテストするための簡易版です。

---

## 🚀 クイックスタート (5分)

### 1. 環境準備

```bash
# Chrome のバージョン確認
google-chrome --version
# または
chromium --version

# 120 以降であることを確認
```

**Chrome 120-121 の場合**: フラグを有効化

1. `chrome://flags/#file-system-access-persistent-permission` → **Enabled**
2. `chrome://flags/#one-time-permission` → **Enabled**
3. Chrome を再起動

**Chrome 122+ の場合**: フラグ設定不要

### 2. 拡張機能のロード

1. `chrome://extensions/`
2. デベロッパーモード ON
3. 「パッケージ化されていない拡張機能を読み込む」
4. このディレクトリを選択: `/home/user/iMacrosMV3`

---

## ✅ 基本テスト (10分)

### テスト A: 永続的権限の動作確認

#### ステップ 1: 初回選択

```text
1. iMacros 拡張機能を開く
2. Files タブをクリック
3. "Select Local Directory" をクリック
4. テスト用ディレクトリを選択 (例: ~/Documents/iMacros)
5. 権限プロンプトで "Persistent" を選択 ⭐
6. ファイル一覧が表示される → ✅
```

**確認ポイント**:
- [ ] 権限プロンプトに "Persistent" と "One-time" の選択肢がある
- [ ] ファイル一覧が正しく表示される

#### ステップ 2: 権限復元の確認

```text
1. Chrome を完全に終了 (すべてのウィンドウを閉じる)
2. Chrome を再起動
3. iMacros 拡張機能を開く
4. Files タブをクリック
5. プロンプトなしでファイル一覧が表示される → ✅
```

**確認ポイント**:
- [ ] ディレクトリ選択プロンプトが表示されない
- [ ] 以前のファイル一覧が自動的に表示される

**結果**:
- ステップ 1: [ ] 成功 / [ ] 失敗
- ステップ 2: [ ] 成功 / [ ] 失敗

---

### テスト B: 一時的権限の動作確認

#### ステップ 1: 権限のクリア

```text
1. chrome://settings/content/fileSystem を開く
2. iMacros の権限を削除
3. Chrome を再起動
```

#### ステップ 2: 一時的権限の選択

```text
1. iMacros 拡張機能を開く
2. Files タブをクリック
3. "Select Local Directory" をクリック
4. ディレクトリを選択
5. 権限プロンプトで "One-time" を選択 ⭐
6. ファイル一覧が表示される → ✅
```

#### ステップ 3: 権限失効の確認

```text
1. Chrome を完全に終了
2. Chrome を再起動
3. iMacros 拡張機能を開く
4. Files タブをクリック
5. "Click to restore access" メッセージが表示される → ✅
   または ディレクトリ選択プロンプトが表示される → ✅
```

**確認ポイント**:
- [ ] セッション終了後に権限が失効する
- [ ] 再度ディレクトリ選択が必要

**結果**:
- ステップ 2: [ ] 成功 / [ ] 失敗
- ステップ 3: [ ] 成功 / [ ] 失敗

---

## 🔍 詳細確認 (5分)

### コンソールログの確認

1. Chrome DevTools を開く (F12)
2. Console タブを選択
3. 以下のログを確認:

**永続的権限が復元される場合**:

```text
[FileSystemAccessService.init] Service initialized with saved handle
✅ 期待されるログ
```

**権限が失効している場合**:

```text
[FileSystemAccessService.init] Saved handle found but permission not granted
✅ 期待されるログ
```

**確認ポイント**:
- [ ] エラーログがない
- [ ] 期待されるログが出力されている

---

## 📊 結果サマリー

### テスト実施日時

- **日時**: _______________
- **Chrome バージョン**: _______________
- **OS**: _______________

### 結果

| テスト | 結果 | 備考 |
|--------|------|------|
| A: 永続的権限 - 初回選択 | [ ] ✅ / [ ] ❌ | |
| A: 永続的権限 - 復元 | [ ] ✅ / [ ] ❌ | |
| B: 一時的権限 - 選択 | [ ] ✅ / [ ] ❌ | |
| B: 一時的権限 - 失効 | [ ] ✅ / [ ] ❌ | |

**総合評価**: [ ] すべて成功 / [ ] 一部失敗 / [ ] 失敗

---

## ❗ 問題が発生した場合

### よくある問題

#### 1. 権限プロンプトに選択肢が表示されない

**原因**: Chrome のバージョンが古い、またはフラグが有効化されていない

**解決方法**:
```text
1. Chrome のバージョンを確認 (120 以降が必要)
2. chrome://flags で両方のフラグを Enabled に設定
3. Chrome を再起動
```

#### 2. ファイル一覧が表示されない

**原因**: 権限が正しく付与されていない

**解決方法**:
```text
1. Chrome DevTools Console を確認
2. エラーメッセージを確認
3. 権限を再度付与
```

#### 3. 永続的権限が復元されない

**原因**: ブラウザデータがクリアされた可能性

**解決方法**:
```text
1. chrome://settings/content/fileSystem で権限を確認
2. 必要に応じて再度権限を付与
```

---

## 🎯 成功基準

以下がすべて確認できれば、テスト成功:

- ✅ 永続的権限選択時、Chrome 再起動後も自動復元される
- ✅ 一時的権限選択時、Chrome 再起動後に権限が失効する
- ✅ 権限プロンプトに2つの選択肢が表示される
- ✅ ファイル操作 (読み込み/書き込み) が正常に動作する

---

## 📝 詳細テストが必要な場合

より詳細なテストが必要な場合は、以下のドキュメントを参照:

- `CHROME_PERSISTENT_PERMISSIONS_TEST_PLAN.md` - 包括的なテスト計画書
- `CHROME_PERSISTENT_PERMISSIONS.md` - 機能説明と技術詳細

---

## 📞 報告

テスト結果を報告する場合:

1. このドキュメントの結果サマリーを記入
2. スクリーンショットを添付 (権限プロンプトのUI)
3. コンソールログを添付 (エラーがある場合)

**報告先**: [GitHub Issue または担当者]

---

**テスト完了**: [ ] はい / [ ] いいえ
