# Chrome Extension Manifest V3移行における完全なシステム再構築とエラー排除に関する技術研究報告書

## 1. エグゼクティブサマリー
Manifest V2 (MV2) ベースのChrome拡張機能をManifest V3 (MV3)へ移行する際に発生する構造的なエラー、依存関係の欠落、レガシー"cp"マクロ互換性問題を解消するための包括的な技術戦略を提示する。MV3移行は、永続的なバックグラウンドページからイベント駆動のService Workerへの転換、CSP強化によるevalやリモートコード禁止など、実行モデル自体のパラダイムシフトを伴う。本報告書は以下の4本柱でシステムを完全に修正し、エラーを排除するアーキテクチャを示す。

1. **高度なコンパクション技術による依存関係の完全記憶**: Webpack 5/Rollupで依存関係グラフを静的解析し、ロックファイルと最適化バンドルで決定論的に固定。
2. **サンドボックスアーキテクチャによる"cp"マクロ互換性維持**: sandboxed iframeと緩和CSPで安全に動的コードを扱い、レガシー eval 依存を封じ込める。
3. **ステートマシンによる連鎖的エラー解消**: Service Workerの短命性を前提にストレージベースの状態管理とアラーム駆動のハートビートを導入。
4. **堅牢なメッセージングバス構築**: runtime.lastError を吸収する接続確認・自動再接続・非同期宣言を備えた通信レイヤーを実装。

## 2. コンパクション技術を用いた依存関係の完全記憶とグラフ解析
### 2.1 依存関係グラフの構築理論
MV2のbackground.scriptsによる暗黙連結は依存関係の「記憶」が不完全で、読み込み順序変更に脆弱である。MV3移行ではES Modules化とバンドラー利用により、依存を明示し静的解析可能な構造へ再設計する。依存タイプごとの戦略は次の通り。

| 依存関係のタイプ | MV2（従来）の特徴 | MV3（修正後）のコンパクション戦略 |
| --- | --- | --- |
| 直接依存 (Direct) | グローバル変数を介した暗黙的共有 | import/export文による明示的結合と静的解析 |
| 推移的依存 (Transitive) | 内部依存が不明瞭 | ロックファイルでバージョンを完全固定 |
| 循環依存 (Circular) | undefined などランタイムエラーの原因 | バンドラーの循環参照検知でビルド時に排除 |
| 動的依存 (Dynamic) | $.getScript など非同期ロード | import() とコード分割で管理 |

実装では、Service Worker / Content Script / Sandbox / Offscreen / Popupをエントリーポイントに設定し、各依存ツリーを生成して固定化する。生成されるロックファイルとバンドル済みアーティファクトが依存構造を完全に記憶し、開発環境とユーザー環境で同一のビット列を保証する。

### 2.2 ツリーシェイキングとスコープホイスティングによる最適化
* **ツリーシェイキング**: AST解析で使用関数のみを抽出し未使用コードを削除。Service Worker起動コストを抑え、初期化エラー要因を低減。
* **スコープホイスティング**: モジュールを可能な限り単一スコープに平坦化し関数呼び出しオーバーヘッドとメモリ使用を削減。メモリ制限の厳しい環境での実行速度を向上。

### 2.3 共有チャンクによる重複排除
複数コンテキスト間で共通利用するロジック（例: "cp"マクロパーサー、ロギング）をSplitChunksPlugin等で共有チャンク化し、コード重複とバージョンスキューを排除。キャッシュ効率も向上し、修正が単一点で完結する。

## 3. "cp"マクロ互換性とサンドボックスアーキテクチャ
MV3ではメインコンテキストでeval/new Functionが禁止されるため、レガシー"cp"マクロをsandboxed iframeで隔離実行する。

### 3.1 サンドボックス環境の構築とCSP設定
manifest.jsonにsandboxページを定義し、サンドボックス専用CSPで `unsafe-eval` を許可する。
```json
"sandbox": { "pages": ["sandbox.html"] },
"content_security_policy": { "sandbox": "sandbox allow-scripts; script-src 'self' 'unsafe-eval'" }
```
この隔離環境でのみマクロのevalを許可し、拡張機能の権限とは分離する。

### 3.2 メッセージングブリッジによる安全な実行フロー
1. Service Workerがストレージからマクロを読み出し、sandboxへ postMessage。
2. Sandboxはevalでパースし、DOM操作命令をオブジェクト化して返却。
3. Service Workerが命令をアクティブタブのContent Scriptへ転送。
4. Content ScriptがDOM操作を実行し結果をフィードバック。

これにより危険なコード実行と特権操作を分離し、CWSポリシー準拠で互換性を維持する。

### 3.3 "cp"マクロパーサーの移植と互換性維持
レガシーコードをサンドボックス用バンドルに組み込み、構文検証やドライランも同環境で実施。編集機能での新コマンド追加も、バンドル済み依存が即時利用できるため動的評価を回避する。

## 4. システム的なエラー排除と連鎖的エラーの解消
### 4.1 Service Workerの短命性と状態の永続化
Service Worker終了時に状態を失わないよう、全実行状態を `chrome.storage.session` または `chrome.storage.local` にコミット。再起動時はハイドレーションして中断位置から再開するステートレス設計を採用する。

### 4.2 アラームAPIを用いたハートビート機構
長時間待機を伴うマクロでは `setTimeout` の代わりに `chrome.alarms` を使用し、Service Worker終了中でもブラウザが再起動イベントを発火して処理継続を保証する。

### 4.3 メッセージングにおける runtime.lastError の完全排除
送信前の接続確認、指数バックオフ付き自動リトライ、受信側での明示的 `return true` を強制するラッパーを通信レイヤーに導入し、Unchecked runtime.lastError を構造的に防止する。

### 4.4 コンテキスト無効化 (Extension Context Invalidated) への対応
Content Scriptが孤立しないよう、生存確認とUI通知を行い、Service Worker起動時に `chrome.scripting.executeScript` で再注入するリカバリを組み込む。

## 5. 記録・再生・編集の完全セット実装
### 5.1 記録システム (Recorder)
* Content Scriptで主要DOMイベントを `capture: true` で傍受し、`isTrusted` でユーザー操作のみ記録。
* ID/クラス/属性/XPathなど複数セレクタを併用し、対象欠落時はフォールバックする自己修復型セレクタを保存。
* 記録状態UIはShadow DOMで隔離し、ページスタイルとの衝突を防ぐ。

### 5.2 再生システム (Player)
* 再生開始時に `chrome.scripting.executeScript` で最新の再生エンジンを注入し、必要時のみ実行。
* DOM依存処理やクリップボード操作などはオフスクリーンドキュメントに委譲し、Service WorkerのDOM非保持問題を解消する。

### 5.3 編集システム (Editor)
* ユーザー編集テキストをサンドボックスでリアルタイム構文チェックし、実行前にエラーを検出。
* 依存追加があってもコンパクション済みバンドルにより即時利用可能。

## 6. 実装ロードマップと結論
### 段階的ロードマップ
1. **Phase 1: 基盤構築とコンパクション** — Webpack 5/TSセットアップ、エントリーポイント定義、SplitChunks設定、ロックファイル生成。
2. **Phase 2: コアアーキテクチャ実装** — ストレージベースのステートマシン、`chrome.alarms` キープアライブ、リトライ付きメッセージングバス。
3. **Phase 3: "cp"互換レイヤー** — sandbox.html/CSP設定、SW⇔Sandboxブリッジ、レガシーコード評価と命令変換。
4. **Phase 4: 記録・再生エンジン移植** — イベントキャプチャとShadow DOM UI、再生ロジックのSandbox連携、オフスクリーンドキュメント移行。
5. **Phase 5: 統合テスト** — SW強制終了からの復帰、ネットワーク切断/タブクローズ時の処理、複雑マクロによるE2Eテスト。

### 結論
MV3のイベント駆動・セキュリティ分離に適合する形で、依存関係の掌握、レガシー互換性、安全な状態管理を組み合わせることで、エラー連鎖を断ち切り、安定稼働する自動化システムを構築できる。本アーキテクチャは拡張機能の品質と信頼性をエンタープライズ水準へ引き上げる決定的な道筋となる。
