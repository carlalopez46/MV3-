# Chrome 永続的権限機能 - テスト計画書

**作成日**: 2025年11月23日
**対象バージョン**: Chrome 120+ (フラグ有効), Chrome 122+ (デフォルト)
**テスト対象**: iMacros MV3 File System Access API 実装

---

## 📋 テスト目的

Chrome の新しい永続的ファイルアクセス権限機能が iMacros MV3 拡張機能と正しく動作することを確認する。

### 検証項目

1. ✅ 既存の実装が Chrome 122+ の新機能と互換性があるか
2. ✅ 永続的権限選択時に正しく動作するか
3. ✅ 一時的権限選択時に正しく動作するか
4. ✅ 権限復元ロジックが正しく機能するか
5. ✅ ユーザー体験が改善されているか

---

## 🔧 テスト環境セットアップ

### 必要な環境

- **ブラウザ**: Google Chrome 120 以降
- **拡張機能**: iMacros MV3 (本リポジトリ)
- **OS**: Windows, macOS, または Linux

### Chrome フラグ設定 (Chrome 120-121 の場合)

Chrome 122 未満でテストする場合、以下のフラグを有効化:

1. Chrome を開き、アドレスバーに `chrome://flags` を入力
2. 以下のフラグを検索して **Enabled** に設定:

```text
chrome://flags/#file-system-access-persistent-permission
chrome://flags/#one-time-permission
```

3. Chrome を再起動

### 拡張機能のロード

1. `chrome://extensions/` を開く
2. 「デベロッパーモード」を有効化
3. 「パッケージ化されていない拡張機能を読み込む」をクリック
4. `/home/user/iMacrosMV3` ディレクトリを選択

---

## 🧪 テストケース

### テストケース 1: 環境確認

**目的**: テスト環境が正しくセットアップされているか確認

**手順**:

1. Chrome のバージョンを確認
   - `chrome://version/` を開く
   - バージョンが 120 以降であることを確認

2. フラグの確認 (Chrome 120-121 の場合)
   - `chrome://flags/#file-system-access-persistent-permission` → **Enabled**
   - `chrome://flags/#one-time-permission` → **Enabled**

3. 拡張機能の確認
   - `chrome://extensions/` を開く
   - iMacros MV3 が読み込まれていることを確認
   - エラーがないことを確認

**期待される結果**:
- ✅ Chrome 120+ が動作している
- ✅ フラグが有効化されている (122 未満の場合)
- ✅ 拡張機能がエラーなく読み込まれている

**結果**: [ ] 合格 / [ ] 不合格

---

### テストケース 2: 初回ディレクトリ選択 - 永続的権限

**目的**: ユーザーが永続的権限を選択した場合の動作確認

**前提条件**:
- File System Access の権限がクリアされている状態
- `chrome://settings/content/fileSystem` で iMacros の権限を削除

**手順**:

1. iMacros MV3 拡張機能を開く
2. Files タブをクリック
3. 「Select Local Directory」ボタンをクリック
4. ディレクトリ選択ダイアログで任意のディレクトリを選択
5. **権限プロンプトで「Persistent」または「永続的」を選択**
6. ファイル一覧が表示されることを確認

**期待される結果**:
- ✅ ディレクトリ選択ダイアログが表示される
- ✅ 権限プロンプトに「Persistent」と「One-time」の選択肢がある
- ✅ 「Persistent」選択後、ファイル一覧が表示される
- ✅ エラーが発生しない

**確認ポイント**:
- 権限プロンプトのUI
- 選択肢の表示
- 選択後の動作

**結果**: [ ] 合格 / [ ] 不合格

**メモ**:
```text
[権限プロンプトのスクリーンショット]
- 表示されたオプション:
- 選択したオプション:
```

---

### テストケース 3: 永続的権限の復元

**目的**: 永続的権限が正しく復元されるか確認

**前提条件**:
- テストケース 2 で永続的権限を付与済み

**手順**:

1. iMacros MV3 拡張機能を一旦閉じる
2. Chrome を再起動する (重要!)
3. iMacros MV3 拡張機能を再度開く
4. Files タブをクリック

**期待される結果**:
- ✅ ディレクトリ選択プロンプトが表示されない
- ✅ 以前選択したディレクトリのファイル一覧が自動的に表示される
- ✅ エラーが発生しない
- ✅ コンソールに権限復元のログが出力される

**コンソール確認**:
```text
期待されるログ例:
[AsyncFileIO] Attempting to restore File System Access permission
[FileSystemAccessService.init] Service initialized with saved handle
```

**結果**: [ ] 合格 / [ ] 不合格

**メモ**:
```text
[コンソールログ]

[ファイル一覧のスクリーンショット]
```

---

### テストケース 4: 初回ディレクトリ選択 - 一時的権限

**目的**: ユーザーが一時的権限を選択した場合の動作確認

**前提条件**:
- File System Access の権限がクリアされている状態
- `chrome://settings/content/fileSystem` で iMacros の権限を削除

**手順**:

1. iMacros MV3 拡張機能を開く
2. Files タブをクリック
3. 「Select Local Directory」ボタンをクリック
4. ディレクトリ選択ダイアログで任意のディレクトリを選択
5. **権限プロンプトで「One-time」または「一時的」を選択**
6. ファイル一覧が表示されることを確認

**期待される結果**:
- ✅ ディレクトリ選択ダイアログが表示される
- ✅ 権限プロンプトに「Persistent」と「One-time」の選択肢がある
- ✅ 「One-time」選択後、ファイル一覧が表示される
- ✅ エラーが発生しない

**結果**: [ ] 合格 / [ ] 不合格

**メモ**:
```text
[権限プロンプトのスクリーンショット]
```

---

### テストケース 5: 一時的権限の失効確認

**目的**: 一時的権限が正しく失効するか確認

**前提条件**:
- テストケース 4 で一時的権限を付与済み

**手順**:

1. iMacros MV3 拡張機能を一旦閉じる
2. Chrome を再起動する (重要! セッション終了)
3. iMacros MV3 拡張機能を再度開く
4. Files タブをクリック

**期待される結果**:
- ✅ 「Click to restore access to your local filesystem」メッセージが表示される
- ✅ または自動的にディレクトリ選択プロンプトが表示される
- ✅ 権限が失効していることが確認できる

**コンソール確認**:
```text
期待されるログ例:
[FileSystemAccessService.init] Saved handle found but permission not granted
```

**結果**: [ ] 合格 / [ ] 不合格

**メモ**:
```text
[コンソールログ]

[UI の状態スクリーンショット]
```

---

### テストケース 6: 権限復元の再試行

**目的**: 権限が失効した状態から再度権限を付与できるか確認

**前提条件**:
- テストケース 5 で権限が失効している状態

**手順**:

1. 「Click to restore access」または「Select Local Directory」をクリック
2. ディレクトリ選択ダイアログで以前と同じディレクトリを選択
3. 今度は「Persistent」を選択
4. ファイル一覧が表示されることを確認

**期待される結果**:
- ✅ ディレクトリ選択が成功する
- ✅ ファイル一覧が表示される
- ✅ 次回起動時は自動復元される (永続的権限を選択したため)

**結果**: [ ] 合格 / [ ] 不合格

---

### テストケース 7: ファイル読み込み操作

**目的**: 永続的権限下でファイル操作が正しく動作するか確認

**前提条件**:
- 永続的権限が付与されている状態

**手順**:

1. Files タブでテキストファイル (`.iim` など) を選択
2. ファイルの内容がエディタに表示されることを確認
3. 別のファイルを選択
4. そのファイルの内容が表示されることを確認

**期待される結果**:
- ✅ ファイルの内容が正しく表示される
- ✅ エラーが発生しない
- ✅ 複数ファイルの読み込みが成功する

**結果**: [ ] 合格 / [ ] 不合格

---

### テストケース 8: ファイル書き込み操作

**目的**: 永続的権限下でファイル書き込みが正しく動作するか確認

**前提条件**:
- 永続的権限が付与されている状態

**手順**:

1. 新しいマクロを作成:
```imacros
VERSION BUILD=1.0.0
TAB T=1
URL GOTO=https://example.com
```

2. 「Save」ボタンをクリック
3. ファイル名を入力 (例: `test_macro.iim`)
4. 保存先ディレクトリを確認
5. Files タブでファイルが表示されることを確認

**期待される結果**:
- ✅ ファイルが正常に保存される
- ✅ Files タブに新しいファイルが表示される
- ✅ ファイルの内容が正しい
- ✅ エラーが発生しない

**結果**: [ ] 合格 / [ ] 不合格

---

### テストケース 9: 権限設定の確認

**目的**: Chrome の権限設定画面で状態を確認

**手順**:

1. `chrome://settings/content/fileSystem` を開く
2. iMacros MV3 のエントリを確認
3. 権限の種類を確認

**期待される結果** (永続的権限の場合):
- ✅ iMacros MV3 のエントリが表示される
- ✅ 選択したディレクトリパスが表示される
- ✅ 権限の状態が「許可」になっている

**結果**: [ ] 合格 / [ ] 不合格

**スクリーンショット**:
```text
[chrome://settings/content/fileSystem のスクリーンショット]
```

---

### テストケース 10: Windows パスマッピング (Windows のみ)

**目的**: Windows 絶対パスでの動作確認

**対象**: Windows OS のみ

**前提条件**:
- Windows 環境
- 永続的権限が付与されている状態

**手順**:

1. 以下のマクロを作成:
```imacros
VERSION BUILD=1.0.0
SAVEAS TYPE=EXTRACT FOLDER=C:\Users\Public\Documents FILE=test.txt
SET !EXTRACT Hello World
```

2. マクロを実行
3. Windows パスマッピングプロンプトが表示されるか確認
4. `C:\Users\Public\Documents` に対応するディレクトリを選択
5. 権限プロンプトで「Persistent」を選択
6. マクロの実行が成功することを確認

**期待される結果**:
- ✅ Windows パスマッピングプロンプトが表示される
- ✅ ディレクトリ選択が成功する
- ✅ 権限プロンプトが表示される
- ✅ マクロ実行が成功する
- ✅ ファイルが正しく保存される

**結果**: [ ] 合格 / [ ] 不合格 / [ ] N/A (Windows 以外)

---

## 📊 テスト結果サマリー

### テスト実施情報

- **実施日**: _______________
- **実施者**: _______________
- **Chrome バージョン**: _______________
- **OS**: _______________
- **iMacros MV3 バージョン/コミット**: _______________

### 結果集計

| テストケース | 合格/不合格 | 備考 |
|------------|-----------|------|
| TC1: 環境確認 | [ ] | |
| TC2: 初回選択 - 永続的 | [ ] | |
| TC3: 永続的権限の復元 | [ ] | |
| TC4: 初回選択 - 一時的 | [ ] | |
| TC5: 一時的権限の失効 | [ ] | |
| TC6: 権限復元の再試行 | [ ] | |
| TC7: ファイル読み込み | [ ] | |
| TC8: ファイル書き込み | [ ] | |
| TC9: 権限設定確認 | [ ] | |
| TC10: Windows パス | [ ] | |

**合格率**: _____ / 10 (または 9 if Windows 以外)

---

## 🐛 発見された問題

### 問題 1

- **テストケース**: _______________
- **重要度**: [ ] Critical [ ] High [ ] Medium [ ] Low
- **説明**:
- **再現手順**:
  1.
  2.
  3.
- **期待される動作**:
- **実際の動作**:
- **スクリーンショット/ログ**:
```text

```

### 問題 2

(必要に応じて追加)

---

## 📝 コンソールログ収集

テスト中に収集すべき重要なログ:

### 初期化時のログ

```javascript
// Chrome DevTools Console (F12) で確認
// フィルタ: "FileSystemAccess" または "AsyncFileIO"
```

**期待されるログパターン**:

```text
[FileSystemAccessService.init] Initializing FileSystemAccessService
[FileSystemAccessService.init] Service initialized with saved handle
[AsyncFileIO] File System Access API initialized successfully
```

### 権限確認時のログ

```text
[FileSystemAccessService._verifyPermission] Permission state: granted
```

### エラーログ

```text
[FileSystemAccessService.init] Saved handle found but permission not granted - user action required
```

---

## ✅ 検証チェックリスト

### 機能的検証

- [ ] 永続的権限選択時、次回起動で自動復元される
- [ ] 一時的権限選択時、セッション終了後に権限が失効する
- [ ] 権限プロンプトに2つの選択肢が表示される
- [ ] ファイル読み込みが正しく動作する
- [ ] ファイル書き込みが正しく動作する
- [ ] Windows パスマッピングが動作する (Windows のみ)

### 非機能的検証

- [ ] ユーザー体験が改善されている (再プロンプトの頻度)
- [ ] エラーメッセージが適切に表示される
- [ ] パフォーマンスに問題がない
- [ ] コンソールエラーが発生しない

### 互換性検証

- [ ] Chrome 120 (フラグ有効) で動作する
- [ ] Chrome 122+ (デフォルト) で動作する
- [ ] 既存の実装との互換性がある
- [ ] 以前のバージョンの Chrome でも動作する (フラグなし)

---

## 🎯 テスト完了基準

以下の条件をすべて満たした場合、テスト合格とする:

1. ✅ すべてのテストケースが合格 (または合格率 90% 以上)
2. ✅ Critical/High の問題が0件
3. ✅ 永続的権限が正しく動作することを確認
4. ✅ 一時的権限が正しく動作することを確認
5. ✅ 既存機能に問題がないことを確認

---

## 📎 添付資料

### スクリーンショット

1. 権限プロンプトのUI
2. 永続的権限選択時の動作
3. 一時的権限選択時の動作
4. Chrome 設定画面

### ログファイル

1. 初期化ログ
2. 権限復元ログ
3. エラーログ (存在する場合)

---

## 📞 問題報告

テスト中に問題を発見した場合:

1. このドキュメントの「発見された問題」セクションに記録
2. GitHub Issue を作成 (必要に応じて)
3. スクリーンショットとログを添付

**Issue テンプレート**:

```markdown
## 問題の概要
[簡潔な説明]

## 再現手順
1.
2.
3.

## 期待される動作
[説明]

## 実際の動作
[説明]

## 環境
- Chrome バージョン:
- OS:
- iMacros MV3 コミット:

## ログ/スクリーンショット
[添付]
```

---

**テスト実施者署名**: _______________
**日付**: _______________
