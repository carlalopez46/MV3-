# ネイティブモジュールのフォールバック動作

## 概要

iMacros MV3拡張機能は、ネイティブモジュールがインストールされていない場合でも正常に動作するように設計されています。このドキュメントでは、各コンポーネントのフォールバック動作について説明します。

## ネイティブモジュールの種類

iMacros MV3拡張機能は3つのネイティブメッセージングホストを使用します:

### 1. SI Host (`com.ipswitch.imacros.host`)
**用途**: 外部iMacrosアプリケーションとの統合
**管理**: `nm_connector.js`
**デフォルト動作**:
- ネイティブモジュールが利用できない場合、拡張機能は引き続き動作します
- 外部アプリケーションからの接続要求はログに記録されますが、送信されません
- ブラウザ内のマクロ実行機能は影響を受けません

### 2. FIO Host (`com.ipswitch.imacros.fio`)
**用途**: ファイルシステムアクセス
**管理**: `AsyncFileIO.js`
**フォールバック**: 仮想ファイルシステム (`VirtualFileService.js`)
- ネイティブモジュールが利用できない場合、自動的に仮想ファイルシステムに切り替わります
- 仮想ファイルシステムはChrome拡張機能のストレージAPIを使用します
- デフォルトディレクトリ:
  - `/VirtualMacros/`
  - `/VirtualMacros/Datasources/`
  - `/VirtualMacros/Downloads/`
  - `/VirtualMacros/Logs/`
- 制限事項:
  - 最大ストレージ: 8MB
  - 最大ファイルサイズ: 2MB
  - チャンクサイズ: 1MB

### 3. 画像検索ホスト (`com.ipswitch.imacros.host`)
**用途**: 画像認識機能
**管理**: `mplayer.js`
**デフォルト動作**:
- ネイティブモジュールが必要です
- 利用できない場合、適切なエラーメッセージが表示されます
- 商用版(iMacros Standard/Enterprise Edition)の機能です

## 実装の詳細

### nm_connector.js の改善点

**接続状態の追跡**:
```javascript
var nm_connector = {
    isConnected: false,  // 接続状態フラグ
    port: null,
    clients: null,
    // ...
}
```

**安全な起動処理**:
- `startServer()`: ネイティブホストへの接続を試みます
- 接続成功: `isConnected = true` を設定し、ログに記録
- 接続失敗: `isConnected = false` を設定し、警告を表示
- エラー時も拡張機能は継続動作

**安全な応答送信**:
- `sendResponse()`: ポートがnullの場合をチェック
- 未接続時は警告をログに記録し、クラッシュを防止
- try-catchブロックで予期しないエラーを捕捉

### AsyncFileIO.js のフォールバック

**自動検出とフォールバック**:
1. ネイティブホストの検出を試みます(タイムアウト付き)
2. 検出失敗時、自動的に仮想ファイルシステムに切り替え
3. ユーザーに一度だけ警告メッセージを表示
4. その後のすべてのファイル操作は透過的に仮想ファイルシステムを使用

**検出メカニズム**:
- 初回タイムアウト: 3秒
- 最大タイムアウト: 15秒
- 指数バックオフによる再試行

## ユーザーへの影響

### ネイティブモジュールがインストールされていない場合

**動作する機能**:
- ブラウザ内でのマクロ記録と再生
- 仮想ファイルシステムを使用したファイル操作
- すべてのDOM操作とブラウザ自動化機能
- データ抽出とCSV処理(仮想ファイル使用)

**動作しない機能**:
- 外部iMacrosアプリケーションとの統合
- ローカルファイルシステムへの直接アクセス
- 画像認識機能(商用版機能)

**エラーメッセージ**:
- コンソールに警告メッセージが表示されます:
  - "Failed to connect to native messaging host"
  - "External iMacros integration unavailable. Extension features will continue to work."
- これらは情報提供のためのメッセージであり、拡張機能の主要機能には影響しません

## 開発者向け情報

### ネイティブモジュールの状態確認

```javascript
// nm_connectorの接続状態を確認
if (nm_connector.isConnected) {
    // ネイティブモジュールが利用可能
} else {
    // ネイティブモジュールが利用不可
}

// AsyncFileIOのバックエンド確認
afio.isInstalled().then(function(installed) {
    if (installed) {
        // ネイティブまたは仮想ファイルシステムが利用可能
    }
});
```

### エラーハンドリング

すべてのネイティブモジュール呼び出しは以下のパターンに従うべきです:

1. 接続状態の確認
2. try-catchブロックでエラーを捕捉
3. タイムアウトの設定
4. 適切なフォールバック処理

### テスト

ネイティブモジュールなしでの動作をテストするには:

1. 拡張機能をロード
2. コンソールで警告メッセージを確認
3. マクロの記録と再生を試行
4. ファイル操作を実行(仮想ファイルシステムを使用)

## まとめ

iMacros MV3拡張機能は、ネイティブモジュールがなくても主要機能が動作するように設計されています。ファイルI/O機能は自動的に仮想ファイルシステムにフォールバックし、外部統合機能は安全に無効化されます。これにより、ユーザーはネイティブモジュールのインストール状況に関わらず、ブラウザ自動化機能を利用できます。
