<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>iMacros MV3 - ã‚¨ãƒ©ãƒ¼è¨ºæ–­</title>
    <style>
        body {
            font-family: 'Consolas', 'Monaco', monospace;
            margin: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        h1 { color: #f48771; }
        h2 { color: #569cd6; margin-top: 30px; }
        .diagnostic { background: #252526; padding: 15px; margin: 10px 0; border-left: 4px solid #f48771; }
        .success { border-left-color: #4ec9b0; }
        .error { color: #f48771; }
        .ok { color: #4ec9b0; }
        pre { background: #2d2d2d; padding: 10px; overflow-x: auto; }
        button { background: #0e639c; color: white; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; }
        button:hover { background: #1177bb; }
        .log { background: #1e1e1e; border: 1px solid #3c3c3c; padding: 15px; max-height: 400px; overflow-y: auto; }
        .log-error { color: #f48771; }
        .log-ok { color: #4ec9b0; }
    </style>
</head>
<body>
    <h1>ğŸ” iMacros MV3 ã‚¨ãƒ©ãƒ¼è¨ºæ–­ãƒ„ãƒ¼ãƒ«</h1>
    <p>ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€ç¾åœ¨ã®ç’°å¢ƒã§ä½•ãŒå£Šã‚Œã¦ã„ã‚‹ã‹ã‚’è‡ªå‹•çš„ã«è¨ºæ–­ã—ã¾ã™ã€‚</p>

    <button onclick="runDiagnostics()" style="font-size: 16px; padding: 15px 30px;">â–¶ï¸ è¨ºæ–­ã‚’å®Ÿè¡Œ</button>
    <button onclick="clearLog()">ğŸ—‘ï¸ ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢</button>

    <h2>ğŸ“‹ è¨ºæ–­çµæœ</h2>
    <div id="results"></div>

    <h2>ğŸ“ è©³ç´°ãƒ­ã‚°</h2>
    <div class="log" id="log"></div>

    <!-- Load all dependencies -->
    <script src="../utils.js"></script>
    <script src="../GlobalErrorLogger.js"></script>
    <script src="../VirtualFileService.js"></script>
    <script src="../WindowsPathMappingService.js"></script>
    <script src="../FileSystemAccessService.js"></script>
    <script src="../FileSyncBridge.js"></script>
    <script src="../AsyncFileIO.js"></script>

    <script>
        const results = [];
        const logContainer = document.getElementById('log');
        const resultsContainer = document.getElementById('results');

        function log(message, isError = false) {
            const timestamp = new Date().toLocaleTimeString();
            const className = isError ? 'log-error' : 'log-ok';
            const line = `<div class="${className}">[${timestamp}] ${message}</div>`;
            logContainer.innerHTML += line;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function addResult(title, status, details) {
            results.push({ title, status, details });
        }

        function displayResults() {
            let html = '';
            results.forEach(r => {
                const className = r.status === 'OK' ? 'diagnostic success' : 'diagnostic';
                const statusClass = r.status === 'OK' ? 'ok' : 'error';
                html += `
                    <div class="${className}">
                        <strong>${r.title}</strong>: <span class="${statusClass}">${r.status}</span>
                        ${r.details ? `<pre>${r.details}</pre>` : ''}
                    </div>
                `;
            });
            resultsContainer.innerHTML = html;
        }

        function clearLog() {
            logContainer.innerHTML = '';
            resultsContainer.innerHTML = '';
            results.length = 0;
        }

        async function runDiagnostics() {
            clearLog();
            log('è¨ºæ–­ã‚’é–‹å§‹ã—ã¾ã™...');

            // 1. Browserç’°å¢ƒãƒã‚§ãƒƒã‚¯
            log('=== 1. Browserç’°å¢ƒãƒã‚§ãƒƒã‚¯ ===');

            try {
                const chromeVersion = navigator.userAgent.match(/Chrome\/(\d+)/);
                if (chromeVersion) {
                    const version = parseInt(chromeVersion[1]);
                    log(`Chrome ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${version}`);
                    addResult('Chrome ãƒãƒ¼ã‚¸ãƒ§ãƒ³', version >= 86 ? 'OK' : `âš ï¸ ${version} (86ä»¥é™æ¨å¥¨)`, `ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${version}`);
                } else {
                    log('Chrome ã§ã¯ãªã„ãƒ–ãƒ©ã‚¦ã‚¶ã§ã™', true);
                    addResult('ãƒ–ãƒ©ã‚¦ã‚¶', 'ERROR', 'Chrome ãŒå¿…è¦ã§ã™');
                }
            } catch (err) {
                log(`ã‚¨ãƒ©ãƒ¼: ${err.message}`, true);
                addResult('Browserç’°å¢ƒ', 'ERROR', err.message);
            }

            // 2. File System Access API ã‚µãƒãƒ¼ãƒˆ
            log('=== 2. File System Access API ã‚µãƒãƒ¼ãƒˆ ===');

            try {
                const hasAPI = 'showDirectoryPicker' in window;
                log(`File System Access API: ${hasAPI ? 'âœ“ åˆ©ç”¨å¯èƒ½' : 'âœ— åˆ©ç”¨ä¸å¯'}`);
                addResult('File System Access API', hasAPI ? 'OK' : 'NOT SUPPORTED',
                    hasAPI ? 'API ãŒåˆ©ç”¨å¯èƒ½ã§ã™' : 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ File System Access API ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“');
            } catch (err) {
                log(`ã‚¨ãƒ©ãƒ¼: ${err.message}`, true);
                addResult('File System Access API', 'ERROR', err.message);
            }

            // 3. å¿…é ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ­ãƒ¼ãƒ‰ç¢ºèª
            log('=== 3. å¿…é ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ­ãƒ¼ãƒ‰ç¢ºèª ===');

            const requiredGlobals = [
                'VirtualFileService',
                'FileSystemAccessService',
                'WindowsPathMappingService',
                'FileSyncBridge',
                'afio',
                'GlobalErrorLogger'
            ];

            requiredGlobals.forEach(name => {
                const exists = typeof window[name] !== 'undefined';
                log(`${name}: ${exists ? 'âœ“' : 'âœ—'}`);
                if (!exists) {
                    log(`  ERROR: ${name} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“!`, true);
                    addResult(name, 'NOT LOADED', `${name} ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“`);
                } else {
                    addResult(name, 'OK', 'ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿');
                }
            });

            // 4. afio ã®åˆæœŸåŒ–çŠ¶æ…‹
            log('=== 4. AsyncFileIO (afio) ã®çŠ¶æ…‹ ===');

            try {
                if (typeof afio !== 'undefined') {
                    const backendType = afio.getBackendType();
                    const isInstalled = await afio.isInstalled();

                    log(`ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¿ã‚¤ãƒ—: ${backendType}`);
                    log(`ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«çŠ¶æ…‹: ${isInstalled}`);

                    addResult('afio ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰', backendType !== 'unknown' ? 'OK' : 'âš ï¸ UNKNOWN',
                        `ã‚¿ã‚¤ãƒ—: ${backendType}, ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«: ${isInstalled}`);

                    // File System Access ãŒåˆ©ç”¨å¯èƒ½ã‹
                    const fsaSupported = afio.isFileSystemAccessSupported();
                    log(`File System Access ã‚µãƒãƒ¼ãƒˆ: ${fsaSupported}`);
                    addResult('afio - FS Access ã‚µãƒãƒ¼ãƒˆ', fsaSupported ? 'OK' : 'NOT SUPPORTED',
                        `ã‚µãƒãƒ¼ãƒˆçŠ¶æ…‹: ${fsaSupported}`);

                } else {
                    log('afio ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“!', true);
                    addResult('afio', 'NOT DEFINED', 'afio ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            } catch (err) {
                log(`ã‚¨ãƒ©ãƒ¼: ${err.message}`, true);
                addResult('afio çŠ¶æ…‹', 'ERROR', err.message + '\n' + err.stack);
            }

            // 5. IndexedDB ç¢ºèª
            log('=== 5. IndexedDB ç¢ºèª ===');

            try {
                if ('indexedDB' in window) {
                    log('IndexedDB: âœ“ åˆ©ç”¨å¯èƒ½');
                    addResult('IndexedDB', 'OK', 'åˆ©ç”¨å¯èƒ½');

                    // æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ç¢ºèª
                    const databases = await indexedDB.databases();
                    log(`æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ•°: ${databases.length}`);
                    databases.forEach(db => {
                        log(`  - ${db.name} (version: ${db.version})`);
                    });

                    addResult('IndexedDB ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹', 'OK',
                        `ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ•°: ${databases.length}\n${databases.map(d => `- ${d.name}`).join('\n')}`);
                } else {
                    log('IndexedDB: âœ— åˆ©ç”¨ä¸å¯', true);
                    addResult('IndexedDB', 'NOT SUPPORTED', 'IndexedDB ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                }
            } catch (err) {
                log(`ã‚¨ãƒ©ãƒ¼: ${err.message}`, true);
                addResult('IndexedDB', 'ERROR', err.message);
            }

            // 6. FileSystemAccessService ã®çŠ¶æ…‹
            log('=== 6. FileSystemAccessService ã®çŠ¶æ…‹ ===');

            try {
                if (typeof FileSystemAccessService !== 'undefined') {
                    const supported = FileSystemAccessService.isSupported();
                    log(`FileSystemAccessService.isSupported(): ${supported}`);
                    addResult('FileSystemAccessService ã‚µãƒãƒ¼ãƒˆ', supported ? 'OK' : 'NOT SUPPORTED',
                        `ã‚µãƒãƒ¼ãƒˆçŠ¶æ…‹: ${supported}`);

                    // åˆæœŸåŒ–ã‚’è©¦ã¿ã‚‹
                    try {
                        const fsAccess = new FileSystemAccessService({ autoPrompt: false });
                        log('FileSystemAccessService ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ: âœ“');
                        addResult('FileSystemAccessService ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–', 'OK', 'æ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸ');
                    } catch (initErr) {
                        log(`åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${initErr.message}`, true);
                        addResult('FileSystemAccessService ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–', 'ERROR', initErr.message);
                    }
                } else {
                    log('FileSystemAccessService ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“!', true);
                    addResult('FileSystemAccessService', 'NOT DEFINED', 'ã‚¯ãƒ©ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            } catch (err) {
                log(`ã‚¨ãƒ©ãƒ¼: ${err.message}`, true);
                addResult('FileSystemAccessService', 'ERROR', err.message);
            }

            // 7. VirtualFileService ã®çŠ¶æ…‹
            log('=== 7. VirtualFileService ã®çŠ¶æ…‹ ===');

            try {
                if (typeof VirtualFileService !== 'undefined') {
                    const vfs = new VirtualFileService();
                    await vfs.init();
                    log(`VirtualFileService åˆæœŸåŒ–: âœ“`);

                    // Show diagnostic info
                    const totalSize = vfs.stats.totalSize;
                    const fileCount = Object.keys(vfs.tree).length;
                    const lastChange = vfs.stats.lastChange ? new Date(vfs.stats.lastChange).toLocaleString() : 'ãªã—';

                    log(`  ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡: ${(totalSize / 1024).toFixed(2)} KB`);
                    log(`  ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${fileCount}`);
                    log(`  æœ€çµ‚å¤‰æ›´: ${lastChange}`);

                    addResult('VirtualFileService', 'OK', `åˆæœŸåŒ–æˆåŠŸ (${fileCount} ãƒ•ã‚¡ã‚¤ãƒ«, ${(totalSize / 1024).toFixed(2)} KB)`);
                } else {
                    log('VirtualFileService ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“!', true);
                    addResult('VirtualFileService', 'NOT DEFINED', 'ã‚¯ãƒ©ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            } catch (err) {
                log(`ã‚¨ãƒ©ãƒ¼: ${err.message}`, true);
                addResult('VirtualFileService', 'ERROR', err.message);
            }

            // 8. GlobalErrorLogger ã®ç¢ºèª
            log('=== 8. GlobalErrorLogger ã®ç¢ºèª ===');

            try {
                if (typeof GlobalErrorLogger !== 'undefined') {
                    log('GlobalErrorLogger: âœ“ åˆ©ç”¨å¯èƒ½');

                    const errorCount = GlobalErrorLogger.errors.length;
                    const warningCount = GlobalErrorLogger.warnings.length;

                    log(`è¨˜éŒ²ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼æ•°: ${errorCount}`);
                    log(`è¨˜éŒ²ã•ã‚ŒãŸè­¦å‘Šæ•°: ${warningCount}`);

                    if (errorCount > 0) {
                        log('âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã™:', true);
                        GlobalErrorLogger.errors.slice(-5).forEach(err => {
                            log(`  - [${err.severity}] ${err.context}: ${err.message}`, true);
                            log(`    Location: ${err.file}:${err.line}`, true);
                        });
                        addResult('GlobalErrorLogger', `âš ï¸ ${errorCount} ERRORS`, `${errorCount} å€‹ã®ã‚¨ãƒ©ãƒ¼ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã™`);
                    } else {
                        log('ã‚¨ãƒ©ãƒ¼ãƒ­ã‚®ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™');
                        addResult('GlobalErrorLogger', 'OK', 'ã‚¨ãƒ©ãƒ¼ãªã—');
                    }
                } else {
                    log('GlobalErrorLogger ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“!', true);
                    addResult('GlobalErrorLogger', 'NOT DEFINED', 'ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            } catch (err) {
                log(`ã‚¨ãƒ©ãƒ¼: ${err.message}`, true);
                addResult('GlobalErrorLogger', 'ERROR', err.message);
            }

            // 9. ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ã®ã‚­ãƒ£ãƒ—ãƒãƒ£
            log('=== 9. ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ã®ã‚­ãƒ£ãƒ—ãƒãƒ£ ===');
            log('ãƒ–ãƒ©ã‚¦ã‚¶ã® Console ã‚¿ãƒ– (F12) ã§ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
            addResult('ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼', 'CHECK CONSOLE', 'F12 ã‚­ãƒ¼ã‚’æŠ¼ã—ã¦ Console ã‚¿ãƒ–ã‚’ç¢ºèªã—ã¦ãã ã•ã„');

            // çµæœã‚’è¡¨ç¤º
            displayResults();

            log('\n=== è¨ºæ–­å®Œäº† ===');
            log(`ç·ãƒã‚§ãƒƒã‚¯é …ç›®æ•°: ${results.length}`);
            const okCount = results.filter(r => r.status === 'OK').length;
            const errorCount = results.filter(r => r.status.includes('ERROR')).length;
            log(`OK: ${okCount}, ERROR: ${errorCount}`);

            // ã‚µãƒãƒªãƒ¼
            if (errorCount > 0) {
                log('\nâš ï¸ ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ä¸Šè¨˜ã®è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', true);
            } else {
                log('\nâœ“ é‡å¤§ãªã‚¨ãƒ©ãƒ¼ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚');
            }
        }

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
        window.addEventListener('error', (event) => {
            log(`ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼: ${event.message} at ${event.filename}:${event.lineno}`, true);
        });

        window.addEventListener('unhandledrejection', (event) => {
            log(`æœªå‡¦ç†ã® Promise ã‚¨ãƒ©ãƒ¼: ${event.reason}`, true);
        });

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        log('è¨ºæ–­ãƒ„ãƒ¼ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸã€‚ã€Œè¨ºæ–­ã‚’å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
    </script>
</body>
</html>
